var yi=Object.defineProperty;var Ni=(l,e,t)=>e in l?yi(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var u=(l,e)=>yi(l,"name",{value:e,configurable:!0});var F=(l,e,t)=>(Ni(l,typeof e!="symbol"?e+"":e,t),t),bi=(l,e,t)=>{if(!e.has(l))throw TypeError("Cannot "+t)};var ke=(l,e,t)=>(bi(l,e,"read from private field"),t?t.call(l):e.get(l)),Qt=(l,e,t)=>{if(e.has(l))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(l):e.set(l,t)},Zt=(l,e,t,a)=>(bi(l,e,"write to private field"),a?a.call(l,t):e.set(l,t),t);var A={};A.statusEffects=[{icon:"icons/svg/skull.svg",id:"dead",name:"CONDITION.defeated",label:"CONDITION.defeated",description:"CONDITIONDESCRIPTION.defeated",flags:{dsa5:{}}},{id:"inpain",name:"CONDITION.inpain",icon:"icons/svg/blood.svg",description:"CONDITIONDESCRIPTION.inpain",changes:[{key:"system.condition.inpain",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"prone",name:"CONDITION.prone",icon:"icons/svg/falling.svg",description:"CONDITIONDESCRIPTION.prone",flags:{dsa5:{}}},{id:"unconscious",name:"CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"CONDITIONDESCRIPTION.unconscious",flags:{dsa5:{}}},{id:"rooted",name:"CONDITION.rooted",icon:"icons/svg/net.svg",description:"CONDITIONDESCRIPTION.rooted",flags:{dsa5:{}}},{id:"fixated",name:"CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"CONDITIONDESCRIPTION.fixated",flags:{dsa5:{}}},{id:"surprised",name:"CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"CONDITIONDESCRIPTION.surprised",flags:{dsa5:{}}},{id:"blind",name:"CONDITION.blind",icon:"icons/svg/blind.svg",description:"CONDITIONDESCRIPTION.blind",flags:{dsa5:{}}},{id:"poisoned",name:"CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"CONDITIONDESCRIPTION.poisoned",flags:{dsa5:{}}},{id:"sick",name:"CONDITION.sick",icon:"icons/svg/biohazard.svg",description:"CONDITIONDESCRIPTION.sick",flags:{dsa5:{}}},{id:"deaf",name:"CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"CONDITIONDESCRIPTION.deaf",flags:{dsa5:{}}},{id:"burning",name:"CONDITION.burning",icon:"icons/svg/fire.svg",description:"CONDITIONDESCRIPTION.burning",flags:{dsa5:{value:1,max:3}}},{id:"invisible",name:"CONDITION.invisible",icon:"icons/svg/circle.svg",description:"CONDITIONDESCRIPTION.invisible",flags:{dsa5:{}}},{id:"constricted",name:"CONDITION.constricted",icon:"icons/svg/cave.svg",description:"CONDITIONDESCRIPTION.constricted",flags:{dsa5:{}}},{id:"bloodrush",name:"CONDITION.bloodrush",icon:"icons/svg/bones.svg",description:"CONDITIONDESCRIPTION.bloodrush",changes:[{key:"system.skillModifiers.step",mode:0,value:"Kraftakt 2;Feat of Strength 2"}],flags:{dsa5:{}}},{id:"mute",name:"CONDITION.mute",icon:"icons/svg/silenced.svg",description:"CONDITIONDESCRIPTION.mute",flags:{dsa5:{}}},{id:"incapacitated",name:"CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"CONDITIONDESCRIPTION.incapacitated",flags:{dsa5:{}}},{id:"encumbered",name:"CONDITION.encumbered",icon:"icons/svg/anchor.svg",changes:[{key:"system.condition.encumbered",mode:2,value:1}],description:"CONDITIONDESCRIPTION.encumbered",flags:{dsa5:{value:1,max:4}}},{id:"stunned",name:"CONDITION.stunned",icon:"icons/svg/daze.svg",changes:[{key:"system.condition.stunned",mode:2,value:1}],description:"CONDITIONDESCRIPTION.stunned",flags:{dsa5:{value:1,max:4}}},{id:"raptured",name:"CONDITION.raptured",icon:"icons/svg/ice-aura.svg",changes:[{key:"system.condition.raptured",mode:2,value:1}],description:"CONDITIONDESCRIPTION.raptured",flags:{dsa5:{value:1,max:4}}},{id:"feared",name:"CONDITION.feared",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.feared",changes:[{key:"system.condition.feared",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"paralysed",name:"CONDITION.paralysed",icon:"icons/svg/paralysis.svg",description:"CONDITIONDESCRIPTION.paralysed",changes:[{key:"system.condition.paralysed",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"confused",name:"CONDITION.confused",icon:"icons/svg/stoned.svg",description:"CONDITIONDESCRIPTION.confused",changes:[{key:"system.condition.confused",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"minorSpirits",name:"CONDITION.minorSpirits",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.minorSpirits",changes:[{key:"system.skillModifiers.global",mode:0,value:-1}],duration:{seconds:600},flags:{dsa5:{}}},{id:"services",name:"PLAYER.services",icon:"icons/svg/aura.svg",description:"CONDITIONDESCRIPTION.services",flags:{dsa5:{value:1,max:500,hideOnToken:!0}}}];A.armorSubcategories={0:4,1:5,2:6,3:8,4:9,5:13,6:12,7:11,8:10};A.weaponStabilities={Blowpipes:10,Bows:4,Brawling:12,"Chain Weapons":10,Crossbows:6,Daggers:14,Discuses:12,Fans:13,"Fencing Weapons":8,"Impact Weapons":12,Lances:6,Pikes:12,Polearms:12,Shields:10,Slingshots:4,Swords:13,"Throwing Weapons":10,"Two-Handed Impact Weapons":11,"Two-Handed Swords":12,Whips:4};A.journalFontSizes=[8,10,12,14,16,18,20,24,28,32];A.styles={"dsa5-immersive":"dsaStyle.immersive","dsa5-immersive dsa5-legacy":"dsaStyle.legacy","dsa5-naked":"dsaStyle.naked"};A.fallingConditions={normal:0,soft1:-1,soft2:-2,soft3:-3,soft4:-4,rough1:1,rough2:2,rough3:3,rough4:4},A.combatSkillSubCategories={0:"COMBATSKILLCATEGORY.0",1:"COMBATSKILLCATEGORY.1",2:"COMBATSKILLCATEGORY.2",3:"COMBATSKILLCATEGORY.3",4:"COMBATSKILLCATEGORY.4",5:"COMBATSKILLCATEGORY.5"};A.effectTextStyle=CONFIG.canvasTextStyle.clone();A.effectTextStyle.fontSize="30";A.effectTextStyle.fontFamily="GentiumBasic";A.knownShortcuts={};A.gearModifyableCalculatedAttributes=["fatePoints","initiative","speed","astralenergy","karmaenergy","wounds","dodge","soulpower","toughness"];A.defaultWeapon={name:"default",type:"meleeweapon",effects:[],system:{type:"meleeweapon",crit:1,botch:20,reach:{value:"short"},damage:{value:"1d6"},atmod:{value:0,offHandMod:0},pamod:{value:0,offHandMod:0},guidevalue:{value:"ge/kk"},damageThreshold:{value:"5000"},worn:{offhand:!1}}};A.asyncHooks={postProcessDSARoll:[]};A.characteristics={mu:"CHAR.MU",kl:"CHAR.KL",in:"CHAR.IN",ch:"CHAR.CH",ff:"CHAR.FF",ge:"CHAR.GE",ko:"CHAR.KO",kk:"CHAR.KK"};A.equipmentTypes={misc:"Equipment.misc",clothes:"Equipment.clothes",tools:"Equipment.tools",light:"Equipment.light",healing:"Equipment.healing",bags:"Equipment.bags",wealth:"Equipment.wealth",writing:"Equipment.writing",alchemy:"Equipment.alchemy",service:"Equipment.service",luxus:"Equipment.luxus",blessed:"Equipment.blessed",food:"Equipment.food"};A.equipmentCategories=new Set(["meleeweapon","rangeweapon","equipment","ammunition","armor","poison","consumable","plant"]);A.systemTables=[{name:"Defense",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"defenseBotchTableEnabled"}},{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"meleeBotchTableEnabled"}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"rangeBotchTableEnabled"}},{name:"Liturgy",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}},{name:"Spell",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}}];A.morePackages={packages:{},names:{de:[],en:[]}};A.narrowSpaceModifiers={weaponshort:{attack:0,parry:0,label:"NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:-4,parry:-4,label:"NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-8,parry:-8,label:"NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:-2,parry:-2,label:"NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:-4,parry:-3,label:"NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-6,parry:-4,label:"NarrowSpaceModifiers.shield.long"}};A.traditionArtifacts={Animistenwaffe:15,Bannschwert:15,Druidendolch:15,Druidensichel:12,Zauberkleidung:15,Magierkugel:12,Zauberinstrument:15,Narrenkappe:15,Hexenkessel:15,Krallenkette:12,Lebensring:12,Alchimistenschale:15,"Scharlatanische Zauberkugel":15,Sippenchronik:15,Schelmenspielzeug:12,Zauberstecken:0,Magierstab:18,Trinkhorn:12,Schuppenbeutel:18,"Kristallomantische Kristallkugel":15,Echsenhaube:12};A.moneyNames={D:"Money-D",S:"Money-S",H:"Money-H",K:"Money-K"};A.areaTargetTypes={cube:"rect",line:"ray",sphere:"circle",cone:"cone"};A.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}};A.regnerationCampLocations={0:"regnerationCampLocations.normal","-1":"regnerationCampLocations.bad",1:"regnerationCampLocations.good"};A.regenerationInterruptOptions={0:"regenerationInterruptOptions.none","-1":"regenerationInterruptOptions.small","-2":"regenerationInterruptOptions.big"};A.targetMomevementOptions={0:"rangeMovementOptions.SLOW","-2":"rangeMovementOptions.FAST",2:"rangeMovementOptions.STATIONARY"};A.allowedforeignfields=["system.details.notes.value"];A.shooterMovementOptions={0:"rangeMovementOptions.SHOOTERSTATIONARY","-2":"rangeMovementOptions.SHOOTERMOVING","-4":"rangeMovementOptions.SHOOTERRUNNING"};A.mountedRangeOptionsSpecAb={STATIONARY:"0",SCHRITT:"0",TROT:"-5000",GALOPP:"-4"};A.mountedRangeOptions={STATIONARY:"0",SCHRITT:"-4",TROT:"-5000",GALOPP:"-8"};A.drivingArcherOptions={STATIONARY:"0",SCHRITT:"-2",GALOPP:"-4"};A.aimOptions={0:"aimOptions.0",2:"aimOptions.1",4:"aimOptions.2"};A.traitCategories={meleeAttack:"closeCombatAttacks",rangeAttack:"rangeCombatAttacks",armor:"armor",general:"general",familiar:"familiar",trick:"trick",training:"training",entity:"entityAbility",summoning:"summoningPackage"};A.ritualLocationModifiers={0:"-",1:"RITUALMODIFIER.holysite","-3":"RITUALMODIFIER.wrongsite"};A.ritualTimeModifiers={0:"-",1:"RITUALMODIFIER.matchingConstellation","-1":"RITUALMODIFIER.wrongConstellation"};A.ceremonyLocationModifiers={0:"-",2:"CEREMONYMODIFIER.holysite",1:"CEREMONYMODIFIER.temple","-1":"CEREMONYMODIFIER.otherTemple","-2":"CEREMONYMODIFIER.enemyGod","-3":"CEREMONYMODIFIER.archDemon","-4":"CEREMONYMODIFIER.nameless","-5":"CEREMONYMODIFIER.nemesis"};A.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,30,45,60,75,90,105,120,135,150,165,180]};A.hooks={};A.startXP={900:"EXP.inexperienced",1e3:"EXP.average",1100:"EXP.experienced",1200:"EXP.competent",1400:"EXP.masterful",1700:"EXP.brillant",2100:"EXP.legendary"};A.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /sp [a-z]*, /li [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk bet\xF6ren"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq bet\xF6ren"},{name:"threeD20Check",command:"/ch",example:"/ch"},{name:"groupcheck",command:"/gc",example:"/gc"}];A.ceremonyTimeModifiers={0:"-",1:"CEREMONYMODIFIER.monthGod",2:"CEREMONYMODIFIER.celebration","-5":"CEREMONYMODIFIER.namelessDays"};A.mageLevels={mundane:"mundane",clerical:"clerical",magical:"magical"};A.specialAbilityCategories={Combat:"SpecCategory.Combat",command:"SpecCategory.command",general:"SpecCategory.general",generalStyle:"SpecCategory.generalStyle",extGeneral:"SpecCategory.extGeneral",animal:"SpecCategory.animal",fatePoints:"SpecCategory.fatePoints",vampire:"SpecCategory.vampire",lykanthrop:"SpecCategory.lykanthrop",language:"SpecCategory.language",secret:"SpecCategory.secret",clerical:"SpecCategory.clerical",clericalStyle:"SpecCategory.clericalStyle",extClericalStyle:"SpecCategory.extClericalStyle",ceremonial:"SpecCategory.ceremonial",vision:"SpecCategory.vision",prayer:"SpecCategory.prayer",magical:"SpecCategory.magical",magicalStyle:"SpecCategory.magicalStyle",extMagical:"SpecCategory.extMagical",staff:"SpecCategory.staff",pact:"SpecCategory.pact",homunculus:"SpecCategory.homunculus"};A.sortedSpecs={combat:new Set(["Combat","command"]),magical:new Set(["magical","magicalStyle","extMagical","pact","homunculus"]),clerical:new Set(["clerical","clericalStyle","extClericalStyle","ceremonial","vision","prayer"]),unUsed:new Set(["staff"])};A.sortedSpecs.general=new Set(Object.keys(A.specialAbilityCategories).filter(l=>!Object.keys(A.sortedSpecs).some(e=>A.sortedSpecs[e].has(l))));A.addvantageRules={};A.removevantageRules={};A.vantagesNeedingAdaption={};A.addAbilityRules={};A.removeAbilityRules={};A.AbilitiesNeedingAdaption={};A.addTraitRules={};A.rangeWeaponModifiers={short:"RangeMod.short",medium:"RangeMod.medium",long:"RangeMod.long",rangesense:"RangeMod.rangesense",extreme:"RangeMod.extreme"};A.meleeRangesArray=["short","medium","long"];A.meleeRanges={short:"Range-short",medium:"Range-medium",long:"Range-long"};A.weapontypes={melee:"meleeweapon",range:"rangeweapon"};A.ammunitiongroups={"-":"-",arrow:"arrow",bolt:"bolt",bullet:"bullet",stone:"stone",dart:"dart",mag:"mag",infinite:"infinite"};A.combatskillsGuidevalues={ff:"CHAR.FF",ge:"CHAR.GE",kk:"CHAR.KK","ge/kk":"CHAR.GEKK"};A.skillDifficultyModifiers={eeasy:5,veasy:3,easy:1,challenging:0,difficult:-1,hard:-3,vhard:-5};A.magicResistanceModifiers={"-":"-",SK:"soulpower",ZK:"toughness"};A.sizeCategories={tiny:"SIZE.tiny",small:"SIZE.small",average:"SIZE.average",big:"SIZE.big",giant:"SIZE.giant"};A.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4};A.rangeSizeCategories={tiny:"RANGESIZE.tiny",small:"RANGESIZE.small",average:"RANGESIZE.average",big:"RANGESIZE.big",giant:"RANGESIZE.giant"},A.meleeSizeCategories={tiny:"MELEESIZE.tiny",small:"MELEESIZE.small",average:"MELEESIZE.average",big:"MELEESIZE.big",giant:"MELEESIZE.giant"};A.shieldSizes={short:"SIZE.small",medium:"SIZE.average",long:"SIZE.big"};A.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8};A.meleeSizeModifier={tiny:-4,small:0,average:0,big:0,giant:0};A.rangeVision={0:"VisionDisruption.step0","-2":"VisionDisruption.step1","-4":"VisionDisruption.step2","-6":"VisionDisruption.step3","-5000":"VisionDisruption.step4"};A.meleeRangeVision=l=>({"+0":"meleeVisionDisruption.0","-1":"meleeVisionDisruption.1","-2":"meleeVisionDisruption.2","-3":"meleeVisionDisruption.3",[l=="attack"?"*0,5":"-5000"]:"meleeVisionDisruption.4"});A.attributeDifficultyModifiers={eeasy:6,veasy:4,easy:2,challenging:0,difficult:-2,hard:-4,vhard:-6};A.skillDifficultyLabels={eeasy:"Skill-eeasy",veasy:"Skill-veasy",easy:"Skill-easy",challenging:"Skill-challenging",difficult:"Skill-difficult",hard:"Skill-hard",vhard:"Skill-vhard"};A.attributeDifficultyLabels={eeasy:"Attribute-eeasy",veasy:"Attribute-veasy",easy:"Attribute-easy",challenging:"Attribute-challenging",difficult:"Attribute-difficult",hard:"Attribute-hard",vhard:"Attribute-vhard"};A.skillGroups={body:"SKILL.body",social:"SKILL.social",knowledge:"SKILL.knowledge",trade:"SKILL.trade",nature:"SKILL.nature"};A.features=["Object","Spheres","Influence","Clairvoyance","Healing","Transformation","Telekinesis","Elemental","Illusion","Anti-Magic","Demonic","Temporal"];A.skillBurdens={yes:"yes",no:"no",maybe:"maybe"};A.StFs={A:"A",B:"B",C:"C",D:"D"};A.noteIcons={"Griffin Shield":"systems/dsa5/icons/thirdparty/griffinshield.svg","At Sea":"systems/dsa5/icons/thirdparty/at-sea.svg","Medieval Gate":"systems/dsa5/icons/thirdparty/medieval-gate.svg","Position Marker":"systems/dsa5/icons/thirdparty/position-marker.svg",River:"systems/dsa5/icons/thirdparty/river.svg",Trail:"systems/dsa5/icons/thirdparty/trail.svg"};CONFIG.time.roundTime=5;CONFIG.time.turnTime=0;var b=A;function ki(l,e=320,t=40){l.attr({width:e*.8,viewBox:`0 0 ${e} ${t}`});let a=l.find("text"),s=a.get(0).getBBox(),i=e/s.width,n=t/s.height,r=i<n,o=r?i:n;isFinite(o)&&a.attr({transform:"matrix("+o+", 0, 0, "+o+", 0,0)",x:Math.max(0,(e-s.width)/2),y:t*.75/(r?1:o)})}u(ki,"svgAutoFit");function ta(l){return new Promise(e=>setTimeout(e,l))}u(ta,"delay");async function Fe(l,e,t=!0){let a,s;l.type=="Actor"?(a=await Actor.implementation.fromDropData(l),s=e===a.id):(a=await Item.implementation.fromDropData(l),s=e===a.parent?.uuid);let i=a?.type;return t&&(a=a.toObject()),l.amount&&(a.system.quantity.value=Number(l.amount)),{item:a,typeClass:i,selfTarget:s}}u(Fe,"itemFromDrop");function aa(l,e,t,a="div"){if(e=l.find(e)[0],!e)return;e.classList.add("slist");let s=e.querySelectorAll(a),i=null;for(let n of s)n.draggable=!0,n.addEventListener("dragstart",function(r){i=this}),n.addEventListener("dragover",function(r){r.preventDefault()}),n.addEventListener("drop",async function(r){if(r.preventDefault(),this!=i){let o=0,c=0;for(let m=0;m<s.length;m++)i==s[m]&&(o=m),this==s[m]&&(c=m);o<c?this.parentNode.insertBefore(i,this.nextSibling):this.parentNode.insertBefore(i,this),await t(e)}})}u(aa,"slist");function pe(l){let e=$(".tinyNotifications");e.length||($("body").append('<ul class="tinyNotifications"></ul>'),e=$(".tinyNotifications"));let t=$(`<li>${l}</li>`);e.prepend(t),setTimeout(function(){t.remove()},1500)}u(pe,"tinyNotification");function ea(l,e,t,a){let s=Math.ceil(e.scrollLeft),i=e.scrollWidth-e.clientWidth;t.style.display=s>0?"block":"none",a.style.display=i>s?"block":"none",Li(l)}u(ea,"IconVisibility");async function gt(l){let e=$(l.currentTarget).closest(".searchableAbility")[0].dataset.category.split(" "),t=l.currentTarget.text.replace(/\d+$/,"").trim();for(let a of e){let i=(await game.dsa5.itemLibrary.findCompendiumItem(t,a)).find(n=>n.name==t);if(i){i.sheet.render(!0);return}}if(/\(/.test(t)){t=t.split("(")[0].trim()+" ()";for(let a of e){let i=(await game.dsa5.itemLibrary.findCompendiumItem(t,a)).find(n=>n.name==t);if(i){i.sheet.render(!0);return}}}}u(gt,"clickableAbility");function Li(l){let e=l.width(),t=Number(getComputedStyle(document.body).getPropertyValue("--minColumnWidth").replace("px","")),a=Number(getComputedStyle(document.body).getPropertyValue("--minColumnWidth60").replace("px","")),s=6;e>=t*2+s?l.removeClass("singleColumnLayout"):l.addClass("singleColumnLayout"),e<=a?l.addClass("minimumColumnLayout"):l.removeClass("minimumColumnLayout")}u(Li,"columnLayout");function ne(l){let e=l.find(".navWrapper");for(let t of e){let a=t.querySelector(".left-btn"),s=t.querySelector(".right-btn"),i=t.querySelector(".sheet-tabs"),n=!1;s.addEventListener("click",()=>{i.scrollLeft+=150,setTimeout(()=>ea(l,i,a,s),500)}),a.addEventListener("click",()=>{i.scrollLeft-=150,setTimeout(()=>ea(l,i,a,s),500)}),new ResizeObserver(()=>ea(l,i,a,s)).observe(t),i.addEventListener("mousemove",r=>{!n||(i.scrollLeft-=r.movementX,setTimeout(()=>ea(l,i,a,s),500))}),i.addEventListener("mousedown",()=>{n=!0,i.classList.add("dragging"),document.addEventListener("mouseup",()=>{n=!1,i.classList.remove("dragging")},{once:!0})})}}u(ne,"tabSlider");var wi=u(()=>{document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)},"appHeight");window.addEventListener("resize",wi);wi();async function Ri(){if(!game.settings.get("dsa5","defaultConfigFinished")){console.log("Configuring default token settings");let l=game.settings.get("core","defaultToken");l.displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,l.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,l.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,l.bar1={attribute:"status.wounds"},await game.settings.set("core","defaultToken",l),await game.settings.set("core","leftClickRelease",!0),await game.settings.set("dsa5","defaultConfigFinished",!0)}}u(Ri,"setupDefaulTokenConfig");async function _i(l,e){await Ft(),l<24&&await Fi(),await game.settings.set("dsa5","migrationVersion",e)}u(_i,"migrateDSA");async function Fi(){for(let l of game.actors){let e=l.effects.filter(t=>["inpain","encumbered"].includes(t.getFlag("core","statusId")));e.length&&await l.deleteEmbeddedDocuments("ActiveEffect",e.map(t=>t.id))}}u(Fi,"migratTo24");async function Ft(){let e=await(await fetch("systems/dsa5/lazy/updatenotes.json")).json();new sa(e).render(!0)}u(Ft,"showPatchViewer");function Ys(){Hooks.once("ready",async function(){if(!game.user.isGM)return;await Ri();let l=await game.settings.get("dsa5","migrationVersion"),e=26;l<e&&_i(l,e)})}u(Ys,"migrateWorld");var sa=class extends Application{constructor(e,t){super(t),this.json=e,this.versionIndex=3}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsa5/templates/system/patchviewer.html",e.resizable=!0,e}activateListeners(e){super.activateListeners(e),ne(e),e.find(".showMore").click(t=>this.showMore(e))}async showMore(e){let t=[this.json.notes[this.json.notes.length-this.versionIndex]];if(t[0].version=="2.3.0"){e.find(".showMore").hide();return}let a=await this.fetchVersions(t);e.find(".changelogsection").append(a.changelog[0]),e.find(".newssection").append(a.news[0]),this.versionIndex+=1}async fetchVersions(e){let t=game.i18n.lang,a=await Promise.all(e.map(async i=>await renderTemplate(`systems/dsa5/lazy/patchhtml/changelog_${t}_${i.version}.html`))),s=await Promise.all(e.map(async i=>await renderTemplate(`systems/dsa5/lazy/patchhtml/news_${t}_${i.version}.html`)));return{changelog:a,news:s}}async getData(){let e=this.json.notes[this.json.notes.length-1],t=this.json.default.replace(/VERSION/g,e.version),a=`<h1>CHANGELOG</h1><p>${t}. </br><b>Important updates</b>: ${e.text}</p><p>For details or proposals visit our wiki page at <a href="https://github.com/Plushtoast/dsa5-foundryVTT/wiki" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>`;await ChatMessage.create(f.chatDataSetup(a,"roll"));let s=game.i18n.lang,i=await this.fetchVersions([e]),n=[this.json.notes[this.json.notes.length-2]],r=await this.fetchVersions(n),o=await renderTemplate(`systems/dsa5/lazy/patchhtml/modules_${s}.html`);return{patchName:t,changelog:i.changelog[0],news:i.news[0],prevVersions:n,prevChangeLogs:r.changelog,prevNews:r.news,modules:o}}};u(sa,"PatchViewer");var Js=class{static getTalentBonus(e,t,a){let s=[],i=game.settings.get("dsa5","talentModifierEnabled");for(let n of e.items.filter(r=>a.includes(r.type)&&r.system.effect.value.includes(t)))for(let r of n.system.effect.value.split(/;|,/))if(r.includes(t)){let o=f.parseAbilityString(r.trim());o.name==t&&s.push({name:n.name,value:o.step*(n.system.step?n.system.step.value:1),type:o.type,selected:i,source:n.name})}return s}static async stepXPCost(e,t){let a=e.system.APValue.value;return/;/.test(a)&&(a=a.split(";").map(i=>Number(i.trim()))[t]),Number(a)}static calcAPCostSum(e){let t=Number(e.system.APValue.value)*(Number(e.system.step.value)||1);if(/;/.test(e.system.APValue.value)){let a=e.system.APValue.value.split(";").map(s=>Number(s.trim()));t=0;for(let s=0;s<e.system.step.value;s++)t+=a[s]}return t}static simpleAdoption(e,t,a,s){if(s[a].effect&&(e.system.effect.value=`${t.name} ${s[a].effect}`),s[a].activeEffect){let i=duplicate(s[a].activeEffect);i.value=`${t.name} ${i.value}`;let n={changes:[i],duration:{},icon:"icons/svg/aura.svg",name:`${a} (${t.name})`,transfer:!0,flags:{dsa5:{description:`${a} (${t.name})`,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(n)}}static reverseAdoptionCalculation(e,t,a){let s=[b.vantagesNeedingAdaption,b.AbilitiesNeedingAdaption];for(let i of s)if(i[t.name]){let n=e.items.find(r=>i[t.name].items.includes(r.type)&&r.name==t.special);n&&(a.system.APValue.value=a.system.APValue.value?a.system.APValue.value.split("/")[n.system.StF.value.charCodeAt(0)-65]:0,Js.simpleAdoption(a,n,t.name,i));break}return a}static hasItem(e,t,a){return e.items.find(s=>a.includes(s.type)&&s.name==t)!=null}static itemStep(e,t,a){let s=e.items.find(i=>a.includes(i.type)&&i.name==t);return s?Number(s.system.step.value):0}static itemAsModifier(e,t,a,s,i=!1,n=!1){let r=[],o=i?new RegExp(`^${f.escapeRegex(`${t} (`)}`):new RegExp(`^${f.escapeRegex(t)}$`),c=e.items.find(m=>s.includes(m.type)&&o.test(m.name));return c&&r.push({name:c.name,value:Number(c.system.step.value)*a,selected:n,source:c.name}),r}},Z=Js;u(Z,"ItemRulesDSA5"),F(Z,"children",{});var He=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find(".select2").select2()}};u(He,"Select2Dialog");var L=class extends Z{static setupFunctions(){}static async abilityAdded(e,t){b.addAbilityRules[t.name]&&b.addAbilityRules[t.name](e,t)}static async abilityRemoved(e,t,a=!0){b.removeAbilityRules[t.name]&&b.removeAbilityRules[t.name](e,t);let s=L.calcAPCostSum(t);s=await L.refundFreelanguage(t,e,s,a),await e._updateAPs(-1*s,{},{render:a})}static async _specialabilityReturnFunction(e,t,a,s){if(t==null)return;if(t=duplicate(t),s!=null){if(/,/.test(t.system.APValue.value)){let n=`${t.name.replace(" ()","")} (${s.name}`;t.system.APValue.value=t.system.APValue.value.split(",")[e.items.filter(r=>r.type==t.type&&r.name.includes(n)).length].trim()}L.simpleAdoption(t,s,t.name,b.AbilitiesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${s.name}${s.customEntry?", "+s.customEntry:""})`,s.system&&s.system.StF?.value&&/\//.test(t.system.APValue.value)&&(t.system.APValue.value=t.system.APValue.value.split("/")[s.system.StF.value.charCodeAt(0)-65].trim())}let i=e.items.find(n=>n.type==a&&n.name==t.name);if(i){let n=duplicate(i),r=await L.isFreeLanguage(t,e,/;/.test(n.system.APValue.value)?n.system.APValue.value.split(";").map(o=>Number(o.trim()))[n.system.step.value]:n.system.APValue.value,!1);n.system.step.value+1<=n.system.maxRank.value&&await e.checkEnoughXP(r)&&(n.system.step.value+=1,await e._updateAPs(r,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[n]),await L.abilityAdded(e,n))}else{let n=await L.isFreeLanguage(t,e,t.system.APValue.value.split(";").map(r=>r.trim())[0],!1);await e.checkEnoughXP(n)&&(await L.abilityAdded(e,t),await e._updateAPs(n,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}}static async refundFreelanguage(e,t,a,s=!0){if(e.system.category.value=="language"&&t.system.freeLanguagePoints){let i=Number(t.system.freeLanguagePoints.value),n=t.items.filter(c=>c.type=="specialability"&&c.system.category.value=="language").reduce((c,m)=>c+Number(m.system.step.value)*Number(m.system.APValue.value),0),r=Math.min(i,n-Number(a)),o=Math.max(0,i-r);await t.update({"system.freeLanguagePoints.used":Math.min(i,Number(r))},{render:s}),a=Math.max(0,a-o)}return a}static async isFreeLanguage(e,t,a,s=!0){if(e.system.category.value=="language"&&t.system.freeLanguagePoints){let i=Number(t.system.freeLanguagePoints.value),n=t.items.filter(c=>c.type=="specialability"&&c.system.category.value=="language").reduce((c,m)=>c+Number(m.system.step.value)*Number(m.system.APValue.value),0),r=Math.min(i,n),o=Math.max(0,i-r);await t.update({"system.freeLanguagePoints.used":Math.min(i,Number(r)+Number(a))},{render:s}),a=Math.max(0,a-o)}return a}static async needsAdoption(e,t,a){let s=b.AbilitiesNeedingAdaption[t.name];if(s){let i,n;if(s.items=="text")i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:t}),n=u(function(r){let o={name:r.find('[name="entryselection"]').val()};L._specialabilityReturnFunction(e,t,a,o)},"callback");else if(s.items=="array"){let r=s.elems.map(o=>({name:o}));i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:r,original:t,area:s.area}),n=u(function(o){let c=r.find(m=>m.name==o.find('[name="entryselection"]').val());L._specialabilityReturnFunction(e,t,a,c)},"callback")}else{let r=e.items.filter(o=>s.items.includes(o.type)).sort((o,c)=>o.name.localeCompare(c.name));i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:r,original:t,area:s.area}),n=u(function(o){let c=r.find(m=>m.name==o.find('[name="entryselection"]').val());c.customEntry=o.find('[name="custom"]').val(),L._specialabilityReturnFunction(e,t,a,c)},"callback")}await new He({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:n},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else L._specialabilityReturnFunction(e,t,a,null)}static hasAbility(e,t){return super.hasItem(e,t,["specialability"])}static abilityStep(e,t){return super.itemStep(e,t,["specialability"])}static abilityAsModifier(e,t,a=1,s=!1){return super.itemAsModifier(e,t,a,["specialability"],s)}};u(L,"SpecialabilityRulesDSA5");Z.children.SpecialabilityRulesDSA5=L;var Ht=class{static multipleDefenseValue(e,t){let a=-3;return(t.type=="dodge"||getProperty(t,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle"))&&L.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulDodge"))?a=-2:L.hasAbility(e,game.i18n.localize("LocalizedIDs.mightyMasterfulParry"))?a=-1:L.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulParry"))&&(a=-2),L.hasAbility(e,game.i18n.localize("LocalizedIDs.vinsaltStyle"))&&(a-=1),Math.min(0,a)}static async bleedingMessage(e){await ChatMessage.create(f.chatDataSetup(game.i18n.format("CHATNOTIFICATION.applyBleeding",{actor:e.name,actorId:e.id,tokenId:e.token?e.token.id:""})))}static isShield(e){return game.i18n.localize("LocalizedIDs.Shields")==getProperty(e,"system.combatskill.value")}static _getFunctionData(e){return{data:e.currentTarget.dataset,actor:f.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}static quantityClick(e){let t=e.currentTarget.dataset.quantityfocus,a=$(e.currentTarget);if(t&&!a.is(":focus")){setTimeout(function(){a.select()});return}let s={val:Number(a.val())};Ht.increment(e,s,"val"),a.val(s.val)}static getGroupSchips(){let e=game.settings.get("dsa5","groupschips").split("/").map(a=>Number(a)),t=[];for(let a=1;a<=e[1];a++)t.push({value:a,cssClass:a<=e[0]?"fullSchip":"emptySchip"});return t}static ensureNumber(e){e.system.AsPCost.value=Number(e.system.AsPCost.value)||e.system.AsPCost.value}static isYieldedTwohanded(e){let t=this.regex2h.test(e.name),a=e.system.worn.wrongGrip;return t&&!a||!t&&a}static obfuscateDropData(e,t){if(t)for(let a of t)mergeObject(e,{system:{obfuscation:{[a]:!0}}})}static _buildDuration(e){let t={duration:{startTime:game.time.worldTime,rounds:e,seconds:e*5}};return game.combat&&mergeObject(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}static async calcBleeding(e){let{data:t,actor:a}=Ht._getFunctionData(e);if(!a)return;let s=a.items.find(i=>i.name==game.i18n.localize("LocalizedIDs.selfControl")&&i.type=="skill");a.setupSkill(s,{},t.token).then(async i=>{let n=await a.basicTest(i);if(n.result.successLevel<2){let r=n.result.qualityStep||0,o=7;n.result.successLevel==1?o-=Number(r):n.successLevel<1&&(o+=o);let c=a.hasCondition("bleeding"),m=Ht._buildDuration(o);if(c){let d=game.combat?(c.data.duration.startRound||1)+c.data.duration.rounds-game.combat.round:c.data.duration.rounds;o>d&&await c.update(m)}else{let d=duplicate(CONFIG.statusEffects.find(p=>p.id=="bleeding"));mergeObject(d,m),await E.addCondition(a,d,1,!1,!0),await ChatMessage.create(f.chatDataSetup(game.i18n.format("CHATNOTIFICATION.gotBleeding",{actor:a.name})))}}})}static increment(e,t,a,s=void 0){let i=e.ctrlKey?10:1,n=e.button==2?-1:1,r=getProperty(t,a)+i*n;return s!=null&&(r=Math.max(s,r)),setProperty(t,a,r),r}static magicalImprovement(e,t){for(let a of e.items)["ritual","spell"].includes(a.type)&&(a.system.talentValue.value+=4)}},_=Ht;u(_,"RuleChaos"),F(_,"regex2h",/\(2H/);function vi(){Hooks.on("getImagePopoutHeaderButtons",(l,e)=>{e.unshift({class:"posttochat",icon:"fas fa-comment",onclick:async()=>ji(l)})})}u(vi,"initImagePopoutTochat");async function ji(l){let e=l.object,t=await renderTemplate("systems/dsa5/templates/chat/imagetochat.html",{image:e});ChatMessage.create(f.chatDataSetup(t))}u(ji,"postImage");function Ti(l){let e=l.currentTarget.dataset;f.showArtwork(e,!1)}u(Ti,"showPopout");var ee=class{static chatListeners(e){e.on("click",".openJournalBrowser",()=>game.dsa5.apps.journalBrowser.render(!0));let t=$('<a class="button showHelp" data-tooltip="HELP.showHelp"><i class="fas fa-question"></i></a>');t.click(()=>{ee.getHelp()}),$(e.find(".control-buttons")).prepend(t),e.on("click",".showPatchViewer",()=>Ft()),e.on("click",".functionswitch",a=>_[a.currentTarget.dataset.function](a)),e.on("click",".panToToken",a=>ee.panToToken(a)),e.on("click",".popoutImage",a=>Ti(a))}static async panToToken(e){let t=await fromUuid(e.currentTarget.dataset.uuid);!t||(canvas.animatePan({x:t.x,y:t.y}),t.isOwner&&t.object.control({releaseOthers:!0}))}static postStatus(e){let t=CONFIG.statusEffects.find(s=>s.id==e),a=`<h2><a class="chat-condition chatButton" data-id="${e}"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="${t.icon}"/>${game.i18n.localize(t.name)}</h2></a><p>${game.i18n.localize(t.description)}</p>`;ChatMessage.create(f.chatDataSetup(a,"roll"))}static getHelp(){let e=b.helpContent.map(t=>`<h2>${game.i18n.localize(`HELP.${t.name}`)}</h2>
            <p><b>${game.i18n.localize("HELP.command")}</b>: ${t.command}</p>
            <p><b>${game.i18n.localize("HELP.example")}</b>: ${t.example}</p>
            <p><b>${game.i18n.localize("Description")}</b>: ${game.i18n.localize(`HELP.descr${t.name}`)}`).join("")+`<br>
            <p>${game.i18n.localize("HELP.default")}</p>`;ChatMessage.create(f.chatDataSetup(e,"roll"))}static showConditions(){let t=duplicate(CONFIG.statusEffects).map(a=>(a.name=game.i18n.localize(a.name),a)).sort((a,s)=>a.name.localeCompare(s.name)).map(a=>`<a class="chat-condition chatButton" data-id="${a.id}"><img src="${a.icon}"/>${a.name}</a>`).join(" ");ChatMessage.create(f.chatDataSetup(t,"roll"))}static async check3D20(e,t,a={}){let s=12;e?(e=e.get(0),t=await f.skillByName(e.textContent),e.dataset.attrs&&(s=e.dataset.attrs.split("|"))):t&&(t=await f.skillByName(t)),t&&(t=t.toObject()),t||(t={name:"3d20",type:"skill",system:{talentValue:{value:0},characteristic1:{value:"mu"},characteristic2:{value:"kl"},characteristic3:{value:"in"},RPr:{value:"no"},burden:{value:"no"}}});let i=await f.emptyActor(s);i.setupSkill(t,a,"emptyActor").then(n=>{i.basicTest(n)})}static async showTables(){let e=await renderTemplate("systems/dsa5/templates/tables/systemtables.html",{tables:b.systemTables});ChatMessage.create(f.chatDataSetup(e,"roll"))}};u(ee,"DSA5ChatListeners");Hooks.once("i18nInit",async()=>{if(!M.creatureData){let l=await fetch(`systems/dsa5/lazy/creaturetype/${game.i18n.lang}.json`);M.creatureData=await l.json(),M.magical=game.i18n.localize("WEAPON.magical"),M.clerical=game.i18n.localize("WEAPON.clerical"),M.silverPlated=game.i18n.localize("WEAPON.silverPlated"),game.dsa5.apps.CreatureType=M}});var Gi=u(l=>!(!l||l.length===0),"isNotEmpty"),le=class{constructor(e){this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}static detectCreatureType(e){let t=e.type=="creature"?e.system.creatureClass.value:e.system.details.species.value;return Object.keys(le.creatureData.types).filter(s=>t.indexOf(s)>=0).map(s=>this.getClass(le.creatureData.types[s],t))}static getClass(e,t){let a={DemonType:oa,ChimeraType:ia,DaimonidType:na,DragonType:ra,ElementalType:la,FairyType:ca,GhostType:da,GolemType:ma,HomunculiType:ua,IntelligentCreatureType:pa,PlantType:ga,AnimalType:fa,UndeadType:ha,SupernaturalType:ya,MagicalConstructType:ba,WerCreatureType:ka,VampireType:wa}[e];return new a(t)}getName(){return Object.keys(le.creatureData.types).find(e=>le.creatureData.types[e]==this.constructor.name)}static checkImmunity(e){let t=[];switch(e.preData.source.type){case"poison":case"disease":{let a=game.i18n.localize("LocalizedIDs.immuneTo")+" ("+e.preData.source.name+")";for(let s of game.user.targets){let i=s.actor,n=i.items.find(r=>r.name==a&&r.type=="advantage");if(n)t.push({name:n.name,uuid:n.uuid,target:i.name,condition:e.preData.source.name});else{let r=le.detectCreatureType(s.actor);for(let o of r)if(o[`${e.preData.source.type}Immunity`]){t.push({name:e.preData.source.name,target:`${i.name} (${o.getName()})`,condition:e.preData.source.name});break}}}break}case"spell":case"ritual":{for(let a of game.user.targets){let s=le.detectCreatureType(a.actor),i=e.preData.source.system.feature.split(",").map(r=>r.trim()),n=!1;for(let r of s){for(let o of i)if(r.spellImmunities.includes(o)){t.push({name:e.preData.source.name,target:`${a.actor.name} (${r.getName()})`,condition:`${game.i18n.localize("feature")} ${o}`}),n=!0;break}if(n)break}}break}}return t}static creatureTypeName(e){if(e.type=="creature"){let t=e.system.creatureClass.value;return Object.keys(le.creatureData.types).filter(a=>t.indexOf(a)>=0)[0]}else return e.system.details.species.value}static addCreatureTypeModifiers(e,t,a,s){let i=le.detectCreatureType(e),n=["spell","ceremony","liturgy","ritual"].includes(t.type);for(let r of i){let o=r.damageModifier(t);if(n)for(let c of o)c.armorPen=r.spellResistanceModifier(e);a.push(...o)}a.push(...this.creatureBonusDamage(e,s)),le.addVulnerabilitiesToSource(e,t,a)}static addVulnerabilitiesToSource(e,t,a){let s=getProperty(e,"system.vulnerabilities");s&&["meleeweapon","rangeweapon"].includes(t.type)&&getProperty(s,"combatskill").reduce((n,r)=>{if(r.target==t.system.combatskill.value){let c=(/\*/.test(r.value)?Number(r.value.replace("*",""))>1:Number(r.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";a.push(...le.buildDamageMod(`${game.i18n.format(c,{name:t.system.combatskill.value})} (${r.source})`,r.value))}},a)}ignoredCondition(e){return!1}damageModifier(e){return[]}static creatureBonusDamage(e,t){let a=[],s=e.type=="creature"?e.system.creatureClass.value:e.system.details.species.value,i=getProperty(t,"system.creatureBonus");for(let n of i)s.indexOf(n.target)>=0&&a.push(...this.buildDamageMod(n.source,n.value,!0));return a}spellImmunity(e){return this.spellImmunities.some(t=>e.includes(t))}spellArmorModifier(e){return 0}poisonImmunity(){return this.poisonImmunity}diseaseImmunity(){return this.diseaseImmunity}spellResistanceModifier(e){return 0}static buildDamageMod(e,t,a=!0){return[{name:e,value:t,selected:a,type:"dmg",source:game.i18n.localize("target")}]}weaponAttributes(e){return getProperty(e,"system.effect.attributes")||""}getTypeByClass(e){return Object.keys(le.creatureData.types).find(t=>le.creatureData.types[t]===e)}isAttackItem(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&Gi(this.weaponAttributes(e))}attributesRegex(e){let t=this.weaponAttributes(e);return new RegExp(`(${t.split(",").map(a=>f.escapeRegex(a.split("(")[0].trim())).join("|")})`,"i")}},M=le;u(M,"CreatureType"),F(M,"creatureData"),F(M,"magical"),F(M,"clerical");var ft=class extends M{damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfLife){let s=`${M.clerical} (${a})`;if(t.test(s))return M.buildDamageMod(s,"*2")}}return super.damageModifier(e)}};u(ft,"VulnerableToLifeGods");var ia=class extends ft{};u(ia,"ChimeraType");var na=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation"].map(t=>game.i18n.localize(`Features.${t}`))}damageModifier(e){return this.isAttackItem(e)&&this.attributesRegex(e).test(M.clerical)?M.buildDamageMod(M.clerical,"*2"):super.damageModifier(e)}};u(na,"DaimonidType");var ra=class extends M{};u(ra,"DragonType");var oa=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);if(t.test(M.clerical))return M.buildDamageMod(`${M.clerical} (${M.creatureData.opposingGod})`,"*2",!1);if(t.test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}spellArmorModifier(e){return Number(e.system.status.soulpower.max)}spellResistanceModifier(e){return Number(e.system.status.soulpower.max)}ignoredCondition(e){return!0}};u(oa,"DemonType");var la=class extends M{constructor(e){super(e),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}spellArmorModifier(e){return Number(e.system.status.soulpower.max)}spellResistanceModifier(e){return Number(e.system.status.soulpower.max)}ignoredCondition(e){return!0}};u(la,"ElementalType");var ca=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}};u(ca,"FairyType");var da=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfDeath){let s=`${M.clerical} (${a})`;if(t.test(s))return[]}if(t=this.attributesRegex(e),t.test(M.clerical))return M.buildDamageMod(M.clerical,"*0.5");if(t.test(M.magical))return M.buildDamageMod(M.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(M.magical,"*0.5");return M.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}ignoredCondition(e){return!["feared","inpain","confused"].includes(e)}};u(da,"GhostType");var ma=class extends ft{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["confused","paralysed"].includes(e)}};u(ma,"GolemType");var ua=class extends ft{constructor(e){super(e),this.spellImmunities=["Healing"].map(t=>game.i18n.localize(`Features.${t}`))}ignoredCondition(e){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(e)}};u(ua,"HomunculiType");var pa=class extends M{};u(pa,"IntelligentCreatureType");var ga=class extends M{};u(ga,"PlantType");var fa=class extends M{};u(fa,"AnimalType");var ha=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfDeath){let s=`${M.clerical} (${a})`;if(t.test(s))return M.buildDamageMod(s,"*2")}}return super.damageModifier(e)}ignoredCondition(e){return!["paralysed"].includes(e)}};u(ha,"UndeadType");var ya=class extends M{};u(ya,"SupernaturalType");var ba=class extends M{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["stunned","feared","paralysed","confused"].includes(e)}};u(ba,"MagicalConstructType");var ka=class extends M{damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.silverPlated))return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}};u(ka,"WerCreatureType");var wa=class extends M{damageModifier(e){return["spell","ceremony","liturgy","ritual"].includes(e.type)?super.damageModifier(e):M.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}};u(wa,"VampireType");var E=class{static bindButtons(e){e.find(".chat-condition").each(function(t,a){a.setAttribute("draggable",!0),a.addEventListener("dragstart",s=>{let i={data:{type:"condition",payload:{id:s.currentTarget.dataset.id}}};s.dataTransfer.setData("text/plain",JSON.stringify(i))})}),e.on("click",".chat-condition",t=>ee.postStatus(t.currentTarget.dataset.id))}static createCustomEffect(e,t="",a){a=a||game.i18n.localize("CONDITION.custom"),t==""&&(t=a),e.addCondition({name:a,icon:"icons/svg/aura.svg",origin:e.uuid,flags:{dsa5:{description:t}}})}static prepareActiveEffects(e,t){let a=duplicate(CONFIG.statusEffects),s=[];t.conditions=[],t.transferedConditions=[];let i;e.documentName=="Item"?i=e.effects:(i=Array.from(e.allApplicableEffects()),game.user.isGM||(i=i.filter(r=>!r.getFlag("dsa5","hidePlayers"))));for(let r of i){let o=r.toObject();o.boolean=r.getFlag("dsa5","value")==null;let c=[...r.statuses][0];c&&(o.value=r.getFlag("dsa5","value"),o.editable=r.getFlag("dsa5","max")&&!r.getFlag("dsa5","notEditable"),o.descriptor=c,o.manual=r.getFlag("dsa5","manual"),s.push(c)),e.documentName=="Item"||r.parent?.documentName!="Item"&&!r.notApplicable?t.conditions.push(o):r.notApplicable||(o.uuid=r.uuid,o.parent={uuid:r.parent?.uuid,name:r.parent?.name},t.transferedConditions.push(o))}t.manualConditions=a.filter(r=>!s.includes(r.id));let n=[];for(let r of Object.keys(e.system?.condition||{}))if(e.system.condition[r]){let o=b.statusEffects.find(c=>c.id==r);o&&n.push({icon:o.icon,id:r,name:game.i18n.localize(o.name),value:e.system.condition[r]})}t.cumulativeConditions=n}static async addCondition(e,t,a=1,s=!1,i=!0){if(!e.isOwner)return"Not owned";if(e.compendium)return"Can not add in compendium";if(s&&a<1)return this.removeCondition(e,t,a,i,s);if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(r=>r.id==t))),!t)return"No Effect Found";let n=this.hasCondition(e,t.id);return n&&n.flags.dsa5.value==null?n:n?await E.updateEffect(e,n,a,s,i,t):await E.createEffect(e,t,a,i)}static hasCondition(e,t){return e!=null&&t&&e.effects?e.effects.find(a=>a.statuses.has(t)):!1}static async removeCondition(e,t,a=1,s=!0,i=!1){if(!e.isOwner)return"Not owned";if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(r=>r.id==t))),!t)return"No Effect Found";let n=this.hasCondition(e,t.id);if(n&&n.flags.dsa5.value==null)return e.token&&(e=e.token.actor),await e.deleteEmbeddedDocuments("ActiveEffect",[n.id]);if(n)return await E.removeEffect(e,n,a,i,s)}static immuneToEffect(e,t,a=!0){if(!t.id||!hasProperty(t,"flags.dsa5.max"))return;let s=getProperty(e,"system.immunities")||[],i;if(s.includes(t.id)&&(i={name:e.name,condition:game.i18n.localize(`CONDITION.${t.id}`)}),!i&&e.documentName=="Actor"){let r=M.detectCreatureType(e);for(let o of r)if(o.ignoredCondition(t.id)){i={name:`${e.name} (${o.getName()})`,condition:game.i18n.localize(`CONDITION.${t.id}`)};break}}if(!i||!(ui.notifications&&!a))return;let n=game.i18n.format("DSAError.conditionInvalidToCreature",{name:i.name,condition:i.condition});ui.notifications.warn(n)}static resistantToEffect(e,t){let a=[...t.statuses][0];return a?(getProperty(e,"system.resistances.effects")||[]).reduce((i,n)=>(n.target==a&&(i+=Number(n.value)),i),0):0}static async createEffect(e,t,a,s){t.name=game.i18n.localize(t.name),this.immuneToEffect(e,t,!1),s?(t.flags.dsa5.auto=Math.min(t.flags.dsa5.max,a),t.flags.dsa5.manual=0):(t.flags.dsa5.manual=Math.min(t.flags.dsa5.max,a),t.flags.dsa5.auto=0),t.flags.dsa5.value=Math.min(4,t.flags.dsa5.manual+t.flags.dsa5.auto),t.id&&(t.statuses=[t.id]),t.id=="dead"&&(t["flags.core.overlay"]=!0);let i=duplicate(t);(game.dsa5.config.statusEffectClasses[t.id]||E).levelDependentEffects(t,i);let n=await e.createEmbeddedDocuments("ActiveEffect",[i]);return delete t.id,n}static async removeEffect(e,t,a,s,i){let n=i?s?a:Math.max(0,t.flags.dsa5.auto-a):t.flags.dsa5.auto,r=i?t.flags.dsa5.manual:s?a:t.flags.dsa5.manual-a,o={flags:{dsa5:{auto:n,manual:r,value:Math.max(0,Math.min(t.flags.dsa5.max,r+n))}}};return o.flags.dsa5.auto<1&&o.flags.dsa5.manual==0?await e.deleteEmbeddedDocuments("ActiveEffect",[t.id]):((game.dsa5.config.statusEffectClasses[[...t.statuses][0]]||E).levelDependentEffects(t,o),await t.update(o))}static async levelDependentEffects(e,t){}static async updateEffect(e,t,a,s,i,n=void 0){this.immuneToEffect(e,t,!0);let r,o,c;return i?(o=Math.min(t.flags.dsa5.max,s?a:t.flags.dsa5.auto+a),r=o-t.flags.dsa5.auto,c={flags:{dsa5:{auto:o,manual:t.flags.dsa5.manual}}}):(o=s?a:t.flags.dsa5.manual+a,r=o-t.flags.dsa5.manual,c={flags:{dsa5:{manual:o,auto:t.flags.dsa5.auto}}}),r==0||(c.flags.dsa5.value=Math.max(0,Math.min(t.flags.dsa5.max,c.flags.dsa5.manual+c.flags.dsa5.auto)),n.duration&&(c.duration=n.duration,c.duration.startTime=game.time.worldTime),(game.dsa5.config.statusEffectClasses[[...t.statuses][0]]||E).levelDependentEffects(t,c),await t.update(c)),t}static calculateRollModifier(e,t,a,s={}){return e.flags.dsa5.value==null||a.type=="regenerate"?0:E.clampedCondition(t,e)}static clampedCondition(e,t){let a=[...t.statuses][0];if(!a)return 0;let s=Number(t.flags.dsa5.max),i=Math.clamped(e.system.condition[a]||0,0,s)*-1,n=this.resistantToEffect(e,t);return Math.clamped(i+n,-1*s,0)}static ModifierIsSelected(e,t={},a){return t.mode!="damage"}static getDamageBonus(){return 0}static getRollModifiers(e,t,a={}){let s=game.i18n.localize("status")+"/"+game.i18n.localize("condition"),i=[],n=[];for(let c of e.effects){if(c.disabled)continue;let m=[...c.statuses][0],d=game.dsa5.config.statusEffectClasses[m]||E,p=d.calculateRollModifier(c,e,t,a);m&&n.push(m),p!=0&&i.push({name:c.name,value:p,selected:d.ModifierIsSelected(t,a,e),source:s})}for(let[c,m]of Object.entries(e.system.condition))if(m&&!n.includes(c)){let d=duplicate(b.statusEffects.find(h=>h.id==c));if(!d)continue;let p=game.dsa5.config.statusEffectClasses[c]||E;d.flags.dsa5.value=m,d.statuses=[c];let g=p.calculateRollModifier(d,e,t,a);g!=0&&i.push({name:d.name,value:g,selected:p.ModifierIsSelected(t,a,e),source:s})}let r=e.hasPlayerOwner,o=game.settings.get("dsa5","masterSettings").globalMods||{};for(let c of Object.keys(o)){let m=expandObject(o[c]);if(!(!m.enabled||!m.target||!m.target[t.type])){if(r){if(!m.victim?.player)continue}else if(!m.victim?.npc)continue;i.push({name:m.name,value:m.value,selected:!0,source:game.i18n.localize("MASTER.globalMods")})}}return i}};u(E,"DSA5StatusEffects");var va=class extends E{static ModifierIsSelected(e,t={},a){let s=e.type=="skill"&&e.system.burden.value=="yes",i=["rangeweapon"].includes(e.type)&&t.mode!="damage"&&game.settings.get("dsa5","encumbranceForRange"),n=!["skill","spell","ritual","ceremony","liturgy","rangeweapon"].includes(e.type)&&t.mode!="damage";return s||n||i}static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"||a.type=="skill"&&a.system.burden.value=="no"?0:super.calculateRollModifier(e,t,a,s)}};u(va,"EncumberedEffect");var Ta=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="dodge"?-2:s.mode?s.mode=="attack"?-4:-2:0}};u(Ta,"ProneEffect");var Sa=class extends E{static calculateRollModifier(e,t,a,s={}){let i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),n=t.system.happyTalents.value.split(/;|,/).map(r=>r.replace(i,"").trim());return n.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&n.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type)?this.clampedCondition(t,e)*-1-1:["ritual","spell","skill","combatskill"].includes(a.type)?this.clampedCondition(t,e):(a.type=="regenerate",0)}};u(Sa,"RaptureEffect");var Ca=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.perception")?-3:0}};u(Ca,"DeafEffect");var Aa=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"?a.name==game.i18n.localize("LocalizedIDs.featOfStrength")?2:0:s.mode=="attack"?4:0}};u(Aa,"BloodrushEffect");var Da=class extends E{static ModifierIsSelected(e,t={},a){return a.effects.find(s=>Array.from(s.statuses).includes("bloodrush"))==null}};u(Da,"PainEffect");var Ma=class extends E{static calculateRollModifier(e,t,a,s={}){if(a.type=="regenerate")return 0;switch(Number(this.clampedCondition(t,e))){case-2:let i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),n=t.system.happyTalents.value.split(/;|,/).map(r=>r.replace(i,"").trim());if(n.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&n.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type))return-2;case-3:return-3}return 0}};u(Ma,"TranceEffect");var Ia=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.gambling")?Math.clamped(this.clampedCondition(t,e),-3,0):0}};u(Ia,"DrunkenEffect");var Ea=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.bodyControl")?Math.clamped(this.clampedCondition(t,e)+1,-2,0):0}};u(Ea,"BurningEffect");var $a=class extends E{static calculateRollModifier(e,t,a,s={}){return 0}};u($a,"ArousalEffect");var Oa=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.willpower")?(this.clampedCondition(t,e)+1)*2:a.type=="regenerate"?this.clampedCondition(t,e):0}};u(Oa,"SikaryanlossEffect");var xa=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.willpower")?Math.clamped(this.clampedCondition(t,e),-3,0):0}};u(xa,"DesireEffect");var za=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?this.clampedCondition(t,e)*-1:0}};u(za,"TheriakEffect");var Pa=class extends E{static calculateRollModifier(e,t,a,s={}){return a.type=="skill"&&a.system.group.value=="body"?Math.clamped(this.clampedCondition(t,e)-1,3,0)*-1:0}};u(Pa,"SunkenEffect");var Na=class extends E{static calculateRollModifier(e,t,a,s={}){let i=Math.clamped(e.flags.dsa5.value,0,4);return a.type=="regenerate"?Math.pow(2,i-1)*-1:0}};u(Na,"HungerEffect");var La=class extends E{static calculateRollModifier(e,t,a,s={}){return 0}static levelDependentEffects(e,t){t.changes={1:[],2:[{key:"system.condition.stunned",mode:2,value:1/2}],3:[{key:"system.condition.stunned",mode:2,value:2/3}],4:[{key:"system.condition.stunned",mode:2,value:3/4}]}[t.flags.dsa5.value]}};u(La,"ThirstEffect");var Ra=class extends E{static levelDependentEffects(e,t){t.changes={1:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:1}],2:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:1/2}],3:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:2/3}],4:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:1/2}]}[t.flags.dsa5.value]}};u(Ra,"HeatEffect");var _a=class extends E{static levelDependentEffects(e,t){t.changes={1:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:1}],2:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:1/2}],3:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:2/3}],4:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:1/2}]}[t.flags.dsa5.value]}};u(_a,"ColdEffect");var Fa=class extends E{static calculateRollModifier(e,t,a,s={}){return 0}};u(Fa,"NoModifierEffect");b.statusEffectClasses={inpain:Da,heat:Ra,cold:_a,encumbered:va,stunned:E,raptured:Sa,feared:E,paralysed:E,confused:E,prone:Ta,deaf:Ca,bloodrush:Aa,trance:Ma,drunken:Ia,arousal:$a,burning:Ea,sikaryanloss:Oa,desire:xa,theriak:za,services:Fa,sunken:Pa,hunger:Na,thirst:La};var x=class extends Z{static setupFunctions(){}static async vantageAdded(e,t){game.dsa5.config.addvantageRules[t.name]&&game.dsa5.config.addvantageRules[t.name](e,t)}static async vantageRemoved(e,t,a=!0){game.dsa5.config.removevantageRules[t.name]&&game.dsa5.config.removevantageRules[t.name](e,t);let s=x.calcAPCostSum(t);s=await x.removeSingularVantages(e,t,s),await e._updateAPs(-1*s,{},{render:a})}static async _vantageReturnFunction(e,t,a,s){if(t==null)return;if(t=duplicate(t),/,/.test(t.system.APValue.value)){let r=t.name.replace(" ()","");t.system.APValue.value=t.system.APValue.value.split(",")[e.items.filter(o=>o.type==t.type&&o.name.includes(r)).length].trim()}s!=null&&(x.simpleAdoption(t,s,t.name,b.vantagesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${s.name})`,s.system&&(t.system.APValue.value=t.system.APValue.value.split("/")[s.system.StF.value.charCodeAt(0)-65].trim()));let i=e.items.find(r=>r.type==a&&r.name==t.name),n;if(i){let r=duplicate(i);n=Number(/;/.test(r.system.APValue.value)?r.system.APValue.value.split(";").map(o=>Number(o.trim()))[r.system.step.value]:r.system.APValue.value),r.system.step.value+1<=r.system.max.value&&await e.checkEnoughXP(n)&&(r.system.step.value+=1,n=this.addSingularVantages(e,r,n),await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[r]),await x.vantageAdded(e,r))}else await e.checkEnoughXP(n=Number(t.system.APValue.value.split(";").map(r=>r.trim())[0]))&&(await x.vantageAdded(e,t),n=this.addSingularVantages(e,t,n),await e._updateAPs(n,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}static async needsAdoption(e,t,a){if(b.vantagesNeedingAdaption[t.name]){let s,i;if(b.vantagesNeedingAdaption[t.name].items=="text")s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:t}),i=u(function(n){let r={name:n.find('[name="entryselection"]').val()};x._vantageReturnFunction(e,t,a,r)},"callback");else{let n=e.items.filter(r=>b.vantagesNeedingAdaption[t.name].items.includes(r.type));s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:n,original:t}),i=u(function(r){let o=n.find(c=>c.name==r.find('[name="entryselection"]').val());x._vantageReturnFunction(e,t,a,o)},"callback")}await new He({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:s,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:i},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else x._vantageReturnFunction(e,t,a,null)}static addSingularVantages(e,t,a){let s=u((i,n,r)=>i.type=="disadvantage"&&n.test(i.name),"filter");return x._calculateSingularVantages(t,e,a,s)}static removeSingularVantages(e,t,a){let s=u((i,n,r)=>i.type=="disadvantage"&&n.test(i.name)&&i.name!=r.name,"filter");return x._calculateSingularVantages(t,e,a,s)}static _calculateSingularVantages(e,t,a,s,i=(n,r)=>Math.min(0,n-r)){if(e.type!="disadvantage")return a;for(let n of["principles","obligations"]){let r=new RegExp(`^${game.i18n.localize("LocalizedIDs."+n)} \\(`);if(r.test(e.name)){let o=t.items.filter(d=>s(d,r,e)),c=Math.min(0,...o.map(d=>x.calcAPCostSum(d))),m=x.calcAPCostSum(e);a=i(m,c)}}return a}static reduceSingularVantages(e,t,a){let s=u((n,r,o)=>n.type=="disadvantage"&&r.test(n.name)&&n.name!=o.name,"filter"),i=u((n,r)=>n<r?a:0,"result");return x._calculateSingularVantages(t,e,a,s,i)}static hasVantage(e,t){return super.hasItem(e,t,["advantage","disadvantage"])}static vantageStep(e,t){return super.itemStep(e,t,["advantage","disadvantage"])}static getVantageAsModifier(e,t,a=1,s=!1,i=!1){return super.itemAsModifier(e,t,a,["advantage","disadvantage"],s,i)}};u(x,"AdvantageRulesDSA5");Z.children.AdvantageRulesDSA5=x;var Y=class{constructor(){F(this,"RECT_SPREAD",[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}])}static rangeFinder(e,t){let a=canvas.scene.grid.size,i=new Ray(e,t).distance/a,n=i*canvas.scene.grid.distance,r=Math.abs((getProperty(e,"system.elevation")||0)-(getProperty(t,"system.elevation")||0)),o=Math.hypot(n,r);return{elevation:r,distance:n,distanceSum:o,tileDistance:i,unit:canvas.scene.grid.units}}static inDistance(e){for(let t of canvas.scene.tokens)if(t.isOwner&&Y.rangeFinder(e,t.object).tileDistance<=2)return!0;return!1}static inLight(e){let t=!1,a=!1;if(game.settings.get("dsa5","lightSightCompensationEnabled"))for(let s of canvas.effects.lightSources){if(!s.active||!s.object)continue;if(s.object==e){if(t=t||s.data.bright>0,a=a||s.data.dim>0,t)break;continue}let i=Y.rangeFinder(e,s.object).distanceSum,n=s.object.document.config||s.object.document.light,r=n.bright>=i,o=n.dim>=i;if(!(!r&&!o)&&((s.data.walls===!1||s.shape.contains(e.center.x,e.center.y))&&(t=r||t,a=o||a),t))break}return{bright:t,dim:a}}static get isEnabled(){let e=canvas?.scene?.getFlag("dsa5","enableDPS");return e?e=="2":game.settings.get("dsa5","enableDPS")}static lightLevel(e,t){if(canvas.scene&&game.settings.get("dsa5","sightAutomationEnabled")){let a=0,s=canvas.scene?.darkness||0,i=game.settings.get("dsa5","sightOptions").split("|").map(r=>Number(r));for(;i[a]<=s;)a+=1;if(e){let r=x.vantageStep(e,game.i18n.localize("LocalizedIDs.darksight")),o=Number(getProperty(e,"system.sightModifier.value"))||0,c=Number(getProperty(e,"system.sightModifier.maxLevel"))||3,m=Array.from(game.user.targets);if(m.length){m=m[0];let d=Y.inLight(m),p=0;d.bright?p=-2:d.dim&&(p=-1),a=Math.max(a+p,0)}a<=c&&a>0&&(r>1?a=0:a=Math.clamped(a+o-r,0,4))}let n=t.find(`[name="vision"] option:nth-child(${a+1})`);n.length&&(n[0].selected=!0)}}static distanceModifier(e,t,a){if(!Y.isEnabled||!e)return 1;let s={};for(let i of game.user.targets){let n=Y.rangeFinder(e,i);(s.distanceSum||0)<n.distanceSum&&(s=n)}if(s.unit==game.i18n.localize("gridUnits")){let i=Number(getProperty(a,"system.rangeMultiplier"))||1,n=t.system.reach.value.split("/").map(o=>Number(o)*i),r=0;for(;r<2&&n[r]<s.distanceSum;)r++;return r}else return 1}static initDoorMinDistance(){let e=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(t){return!game.user.isGM&&Y.isEnabled&&!Y.inDistance(this)?ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot")):e.apply(this,arguments)}}};u(Y,"DPS");Hooks.on("renderSceneConfig",(l,e,t)=>{let a=getProperty(l.object,"flags.dsa5.enableDPS"),s=`<div class="form-group dpsSelector">
        <label data-tooltip="DSASETTINGS.enableDPSHint">${game.i18n.localize("DSASETTINGS.enableDPS")}</label>
        <select name="flags.dsa5.enableDPS">
            <option value="" ${a==""?"selected":""}>${game.i18n.localize("globalConfig")}</option>
            <option value="2" ${a=="2"?"selected":""}>${game.i18n.localize("yes")}</option>
            <option value="1" ${a=="1"?"selected":""}>${game.i18n.localize("no")}</option>
        </select>
    </div>`;e.find(".dpsSelector").remove(),e.find('.tab[data-tab="grid"]').append(s)});var it=class extends Dialog{static async getDialog(e){let t=Array.from(game.user.targets).map(i=>i.id),a=[],s=canvas.scene?canvas.scene.tokens.get(e.token)?.object:void 0;return game.combat&&game.combat.combatants.forEach(i=>{if(!!i.visible){if(i.isSelected=t.includes(i.token.id),s&&i.token){let n=canvas.scene.tokens.get(i.token.id).object;i.distance=Y.rangeFinder(s,n),i.distance.distanceSum=Number(i.distance.distanceSum.toFixed(1))}a.push(i)}}),new it({title:game.i18n.localize("DIALOG.addTarget"),content:await renderTemplate("systems/dsa5/templates/dialog/addTarget-dialog.html",{selectables:a}),default:"yes",buttons:{}})}activateListeners(e){super.activateListeners(e);let t=e.find(".combatant");t.click(a=>this.setTargets(a)),t.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),t.mousedown(a=>this._onRightClick(a))}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}_getCombatApp(){return game.combats.apps[0]}async setTargets(e){let t=e.originalEvent.shiftKey;t||$(e.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(e.currentTarget).addClass("selectedTarget");let a=e.currentTarget.dataset.combatantId;game.combat.combatants.get(a).token.object.setTarget(!0,{user:game.user,releaseOthers:!t,groupSelection:!0})}};u(it,"AddTargetDialog");var Se=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5Decent"])}),e}static async getDialog(){let e=game.users.filter(t=>t.active&&!t.isGM);return new Se({title:game.i18n.localize("DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsa5/templates/dialog/selectForUserDialog.html",{users:e}),default:"yes",buttons:{}})}static registerButtons(){Hooks.on("getSceneControlButtons",e=>{if(!game.user.isGM)return;let t={name:"targetUser",title:game.i18n.localize("CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:async()=>{(await Se.getDialog()).render(!0)}};e[0].tools.splice(2,0,t)})}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){let t=Array.from(game.user.targets).map(i=>i.id),a=e.currentTarget.dataset.userId;game.users.get(a).updateTokenTargets(t),game.socket.emit("userActivity",a,{targets:t}),this.close()}};u(Se,"SelectUserDialog");var nt=class extends Dialog{static async getDialog(e){let t=game.users.filter(a=>a.active&&!a.isGM);new nt({title:game.i18n.localize("SHEET.PostItem"),content:await renderTemplate("systems/dsa5/templates/dialog/usermultipickdialog.html",{users:t}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:a=>{this.postContent(a,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}static async postContent(e,t){let a=f.chatDataSetup(t);if(!e.find("#sel_all").is(":checked")){let s=[];e.find(".usersel:checked").each(function(){s.push($(this).val())}),a.whisper=s}ChatMessage.create(a)}activateListeners(e){super.activateListeners(e),e.find('[name="sel_all"]').change(t=>{e.find(".usersel").prop("disabled",t.currentTarget.checked).prop("checked",t.currentTarget.checked)})}};u(nt,"UserMultipickDialog");var Xs=class extends Dialog{recallSettings(e,t,a,s){return this.recallData=game.dsa5.memory.recall(e,t,a),this.dialogData={mode:a,speaker:e,source:t,renderData:s},this}async _render(e,t){await super._render(e,t),this.prepareFormRecall($(this._element))}setRollButtonWarning(){return this.dialogData.mode=="attack"?`<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("DIALOG.noTarget")}</span>`:""}setMultipleTargetsWarning(){return this.dialogData.mode=="attack"?`<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("DIALOG.multipleTarget")}</span>`:""}renderRollValueDie(){if(this.dialogData.rollValue&&this.dialogData.mode!="damage"){let e=this.dialogData.mode=="attack"||this.dialogData.counterAttack?"die-mu":"die-in",t=this.dialogData.modifier||0;return`<span class="rollValue ${e} d20">${Math.clamped(this.dialogData.rollValue+t,1,20)}</span>`}else return""}async updateRollButton(e){let t=this.renderRollValueDie()+game.i18n.localize("Roll");e.length>0?e.length>1&&(t+=this.setMultipleTargetsWarning()):t+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(t)}async updateTargets(e,t){let a=await renderTemplate("systems/dsa5/templates/dialog/parts/targets.html",{targets:t});e.find(".targets").html(a),this.updateRollButton(t)}removeTarget(e){let t=e.currentTarget.dataset.id;$(e.currentTarget).remove();let a=[];game.user.targets.forEach(s=>{t!=s.id&&a.push(s.id)}),game.user.updateTokenTargets(a)}readTargets(){let e=[];return game.user.targets.forEach(t=>{t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})}),e}compareTargets(e,t){let a=this.readTargets();return JSON.stringify(t)!=JSON.stringify(a)&&(t=a,this.updateTargets(e,t)),t}activateListeners(e){super.activateListeners(e),e.find(".quantity-click").mousedown(t=>_.quantityClick(t)),e.find(".modifiers option").mousedown(t=>(t.preventDefault(),$(t.currentTarget).prop("selected",!$(t.currentTarget).prop("selected")),!1)),e.on("click",".rollTarget",t=>this.removeTarget(t)),e.on("click",".addTarget",t=>this.addTarget(t))}async addTarget(e){(await it.getDialog(this.dialogData.speaker)).render(!0)}prepareFormRecall(e){if(this.recallData)for(let t in this.recallData)if(t=="specAbs")for(let a of this.recallData[t]){let s=e.find(`.specAbs[data-id="${a.id}"]`);s.addClass("active").attr("data-step",a.step),s.find(".step").text(Xs.roman[a.step])}else{let a=e.find(`[name="${t}"]`);if(Array.isArray(this.recallData[t])){let s=a.find("option");for(let i of s){let n=this.recallData[t].find(r=>r.name==$(i).text().trim());n&&(i.selected=n.selected)}}else a.attr("type")=="checkbox"?a[0].checked=this.recallData[t]:a.val(this.recallData[t])}}},ae=Xs;u(ae,"DialogShared"),F(ae,"roman",[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"]);var je=class extends ae{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}prepareFormRecall(e){super.prepareFormRecall(e),e.find(".spellModifier").trigger("change")}static getRollButtons(e,t,a,s){let i=Q.getRollButtons(e,t,a,s);if(["spell","liturgy"].includes(e.source.type)){let n=Number(e.source.system.castingTime.value),r=e.source.system.castingTime.progress,o=e.source.system.castingTime.modified;if(n&&e.extra.speaker.token!="emptyActor"){let c=o>0?` (${r}/${o})`:"";mergeObject(i,{reloadButton:{label:`${game.i18n.localize("SPELL.reload")}${c}`,callback:async m=>{let d=await f.getSpeaker(e.extra.speaker),p={_id:e.source._id,"system.castingTime.progress":r+1};o==0&&(o=Number(m.find(".castingTime").text())-1,p["system.castingTime.modified"]=o),await d.updateEmbeddedDocuments("Item",[p]);let g=game.i18n.format("SPELL.isReloading",{actor:d.token?.name||d.prototypeToken.name,item:e.source.name,status:`${r+1}/${o}`});await ChatMessage.create(f.chatDataSetup(g))}}})}}return i}async applyTransformations(e,t){let a=t.find('[name="situationalModifiers"]');a.find('option[data-extension="1"]').remove();let s=[],i=Object.keys(je.rollModifiers).map(r=>`${r}.mod`);this.dialogData.renderData.rollModifiersPrepared=duplicate(this.dialogData.renderData.rollModifiers);for(let r of t.find(".specAbs.active")){let o=fromUuidSync(r.dataset.uuid);if(!!o)for(let c of o.effects)for(let m of c.changes)if(je.rollChanges.includes(m.key)){let d=o.name.split(" - "),p=game.i18n.localize(`MODS.${m.key}`);d=`${d[1]||d[0]}`;let g=`${p}: ${m.value}<br/>${game.i18n.localize("spellextension")}: ${d}`;s.push(`<option data-extension="1" selected="" data-tooltip="${g}" data-type="${m.key}" value="${m.value}">${d} - ${p}</option>`)}else m.key=="macro.transform"?await f.callItemTransformationMacro(m.value,e,c):i.includes(m.key)?c.apply(this.dialogData.renderData.rollModifiersPrepared,m):c.apply(e,m)}let n=this.dialogData.renderData.rollModifiersPrepared.extensionModifier.mod;if(n){let r=game.i18n.localize("ABBR.modifiers"),o=game.i18n.localize("spellextension"),c=`${r}: ${n}<br/>${o}`;s.push(`<option data-extension="1" selected="" data-tooltip="${c}" data-type="" value="${n}">${o} - ${r}</option>`)}a.append(s.join(""))}static setData(e,t){let a=duplicate(je.rollModifiers),s=`${t}RollModifiers`;if(e.system[s])for(let i of Object.keys(e.system[s]))a[i].mod+=Number(e.system[s][i]?.mod??0);return a}async recalcSpellModifiers(e,t){let a=e,s=duplicate(this.dialogData.source);_.ensureNumber(s);let i=a.find(".castingTime"),n=a.find(".aspcost"),r=a.find(".reach"),o=a.find(".maintainCost"),c=a.find(".ritual").length>0;await this.applyTransformations(s,a);let m=a.find(".maxMods");if(a.find(".spellModifier:checked").length>Number(m.text())){t&&(t.currentTarget.checked=!1),m.addClass("emphasize"),setTimeout(function(){m.removeClass("emphasize")},600);return}for(let R of Object.keys(this.dialogData.renderData.rollModifiersPrepared)){let D=this.dialogData.renderData.rollModifiersPrepared[R].mod;e.find(`.${R}Label`).text(`(${D})`),e.find(`#${R}`).val(D)}let d=e.find(".canChangeCastingTime");s.system.canChangeCastingTime.value=="true"?d.is(":empty")&&(d.html(await renderTemplate("systems/dsa5/templates/dialog/parts/canChangeCastingTime.html",{rollModifiers:this.dialogData.renderData.rollModifiers})),this.setPosition({height:"auto"})):d.is(":empty")||(d.html(""),this.setPosition({height:"auto"}));let p=s.system.AsPCost.value,g=s.system.range.value,h=s.system.castingTime.value,y=p,v=s.system.maintainCost.value;a.find(".variableBaseCost")[s.system.variableBaseCost=="true"?"show":"hide"]();let P=0;a.find(".spellModifier[data-cost]:checked").each(function(R,D){if(y=y*(D.value<0?.5:2),v!=""&&v!=null){let z=String(v).split(" ");z[0]=Math.max(Number(z[0])*(D.value<0?.5:2)),v=z.join(" ")}P+=Number(D.value)}),y<1?t&&(t.currentTarget.checked=!1):(n.text(y),o.text(v),n.attr("data-mod",P)),P=0,y=h,a.find(".spellModifier[data-castingTime]:checked").each(function(R,D){if(c){let z=je.bigTimes.indexOf(Number(y));if(z!=null){let O=z+(D.value>0?1:-1);O<je.bigTimes.length&&O>=0?y=je.bigTimes[O]:ui.notifications.error(game.i18n.localize("DSAError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("DSAError.TimeCannotBeParsed"))}else y=y*(D.value>0?2:.5);P+=Number(D.value)}),y<1?t&&(t.currentTarget.checked=!1):(i.text(y),i.attr("data-mod",P)),P=0;let T=game.i18n.localize("ReverseSpellRanges."+g);r.text(g),a.find(".spellModifier[data-reach]:checked").each(function(R,D){if(T=="self")D.checked=!1;else if(T=="touch")r.text("4 "+game.i18n.localize("step")),P+=Number(D.value);else{let z=g.split(" ");T=Number(z[0]),isNaN(T)?(t&&(t.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("DSAError.RangeCannotBeParsed"))):(r.text(T*2+" "+game.i18n.localize("step")),P+=Number(D.value))}}),r.attr("data-mod",P),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}activateListeners(e){super.activateListeners(e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown(s=>{$(s.currentTarget).toggleClass("active"),this.recalcSpellModifiers(e)}),e.find(".variableBaseCost").change(s=>{let i=$(s.currentTarget).parents(".skill-test"),n=i.find(".aspcost").attr("data-base"),r=$(s.currentTarget).val();i.find(".aspcost").attr("data-base",r),i.find(".aspcost").text(Number(i.find(".aspcost").text())*r/n)}),e.on("change",".spellModifier",s=>this.recalcSpellModifiers(e,s));let t=this.readTargets();t.length==0&&this.setRollButtonWarning();let a=this;this.checkTargets=setInterval(function(){t=a.compareTargets(e,t)},500)}},re=je;u(re,"DSA5SpellDialog"),F(re,"rollChanges",["defenseMalus"]),F(re,"rollModifiers",{forceSpell:{mod:1},reduceCostSpell:{mod:-1},increaseRangeSpell:{mod:-1},increaseCastingTime:{mod:1},decreaseCastingTime:{mod:-1},removeGesture:{mod:-2},removeFormula:{mod:-2},extensionModifier:{mod:0}}),F(re,"bigTimes",[5,30,120,480,960,1920]);function Si(l,e={}){f.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}u(Si,"automatedAnimation");async function kr(l,e,t,a,s,i={}){let n={};if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else{let o=await game.packs.get(l).getDocuments({name:e});if(!o.length){for(let c of game.packs.filter(m=>m.documentName=="Macro"&&/\(internal\)/.test(m.metadata.label)))if(o=await c.getDocuments({name:e}),o.length)break}if(o.length){let c=Object.getPrototypeOf(async function(){}).constructor,m=new c("actor","item","qs","automatedAnimation","args",o[0].command);try{i.result=n;let d=mergeObject({automatedAnimation:Si},this);await m.call(d,t,a,s,Si,i)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),n.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:e}))}return n}u(kr,"callMacro");Hooks.once("i18nInit",()=>{_DSAActiveEffectConfig.effectDurationRegexes=[{regEx:new RegExp(game.i18n.localize("DSAREGEX.combatRounds"),"i"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEX.minutes"),"i"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEX.hours"),"i"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEX.days"),"i"),seconds:3600*24},{regEx:new RegExp(game.i18n.localize("DSAREGEX.weeks"),"i"),seconds:3600*24*7},{regEx:new RegExp(game.i18n.localize("DSAREGEX.months"),"i"),seconds:3600*24*30},{regEx:new RegExp(game.i18n.localize("DSAREGEX.years"),"i"),seconds:3600*24*350}]});var _DSAActiveEffectConfig=class extends ActiveEffectConfig{static get defaultOptions(){return mergeObject(super.defaultOptions,{resizable:!0})}static async onEffectRemove(l,e){let t=getProperty(e,"flags.dsa5.onRemove");if(t)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let a=Object.getPrototypeOf(async function(){}).constructor;await new a("effect","actor",t).call(this,e,l)}catch(a){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(a),console.warn(a.stack)}}async checkTimesUpInstalled(){let l=f.moduleEnabled("times-up");return!l&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("DSAError.shouldTimesUp")),l}async _render(l=!1,e={}){await super._render(l,e);let t=0,a=getProperty(this.object,"parent.type"),s=["meleeweapon","rangeweapon"].includes(a)||a=="trait"&&["meleeAttack","rangeAttack"].includes(getProperty(this.object,"parent.system.traitType.value")),i={hasSpellEffects:s||["spell","liturgy","ritual","skill","ceremony","consumable","poison","disease","ammunition"].includes(a)||["specialability"].includes(a)&&getProperty(this.object,"parent.system.category.value")=="Combat",hasDamageTransformation:["ammunition"].includes(a),hasTriggerEffects:["specialability"].includes(a)},n=[];if((i.hasSpellEffects||i.hasDamageTransformation||i.hasTriggerEffects)&&n.push({name:"ActiveEffects.advancedFunctions.none",index:0}),i.hasSpellEffects)for(let d of["systemEffect","macro","creature"])n.push({name:`ActiveEffects.advancedFunctions.${d}`,index:t+=1});i.hasDamageTransformation&&n.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5}),i.hasTriggerEffects&&n.push({name:"ActiveEffects.advancedFunctions.postRoll",index:6},{name:"ActiveEffects.advancedFunctions.postOpposed",index:7});let r={systemEffects:this.getStatusEffects(),canEditMacros:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")},o=[2,6,7],c=$(this._element);c.find(".tabs").append(`<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>${game.i18n.localize("advanced")}</a>`);let m=await renderTemplate("systems/dsa5/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:n,effectConfigs:i,macroIndexes:o,config:r,isWeapon:s});c.find('.tab[data-tab="effects"]').after($(m)),c.find(".advancedSelector").change(d=>{let p=this.object;p.flags.dsa5.advancedFunction=$(d.currentTarget).val(),renderTemplate("systems/dsa5/templates/status/advanced_functions.html",{effect:p,config:r,macroIndexes:o}).then(g=>{c.find(".advancedFunctions").html(g)})}),this.checkTimesUpInstalled()}getStatusEffects(){return duplicate(CONFIG.statusEffects).map(l=>({id:l.id,name:game.i18n.localize(l.name)})).sort((l,e)=>l.name.localeCompare(e.name))}static applyRollTransformation(actor,options,functionID){let msg="",source=options.origin;for(let ef of source.effects)try{Number(getProperty(ef,"flags.dsa5.advancedFunction"))==functionID&&eval(getProperty(ef,"flags.dsa5.args3"))}catch(l){console.warn("Unable to apply advanced effect",l,ef)}return options.origin=source,{msg,options}}static async applyAdvancedFunction(actor,effects,source,testData,sourceActor,skipResistRolls=!0){let msg="",resistRolls=[],effectApplied=!1,effectsWithChanges=[],effectNames=new Set;for(let ef of effects){ef.origin&&delete ef.origin;let specStep=Number(getProperty(ef,"flags.dsa5.specStep"))||0;try{let customEf=Number(getProperty(ef,"flags.dsa5.advancedFunction")),qs=Math.min(testData.qualityStep||0,6),resistRoll=getProperty(ef,"flags.dsa5.resistRoll");if(resistRoll&&!skipResistRolls){let l=resistRoll.split(" "),e=`${l.pop()}`;resistRolls.push({skill:l.join(" "),mod:Math.round(Roll.safeEval(`${e}`.replace(/q(l|s)/i,qs).replace("step",specStep)))||0,effect:ef,target:actor,token:actor.token?actor.token.id:void 0})}else if(effectApplied=!0,effectNames.has(ef.name)||effectNames.add(ef.name),ef.changes&&ef.changes.length>0&&effectsWithChanges.push(ef),customEf)switch(customEf){case 1:{let l=duplicate(CONFIG.statusEffects.find(t=>t.id==getProperty(ef,"flags.dsa5.args0"))),e=`${getProperty(ef,"flags.dsa5.args1")}`||"1";l.duration=ef.duration,/,/.test(e)?e=Number(e.split(",")[qs-1]):e=Number(e.replace(game.i18n.localize("CHARAbbrev.QS"),qs)),await actor.addCondition(l,e,!1,!1)}break;case 2:game.user.can("MACRO_SCRIPT")?await eval(`(async () => {${getProperty(ef,"flags.dsa5.args3")}})()`):ui.notifications.warn("You are not allowed to use JavaScript macros.");break;case 3:let creatures=(getProperty(ef,"flags.dsa5.args4")||"").split(",").map(l=>`@Compendium[${l.trim().replace(/(@Compendium\[|\])/)}]`).join(" ");msg+=`<p><b>${game.i18n.localize("ActiveEffects.advancedFunctions.creature")}</b>:</p><p>${creatures}</p>`;break}}catch(l){console.warn("Unable to apply advanced effect"),console.warn(l),console.warn(ef)}}return await actor.createEmbeddedDocuments("ActiveEffect",effectsWithChanges),{msg,resistRolls,effectApplied,effectNames:Array.from(effectNames)}}static async resistEffect(l){let e=l.currentTarget.dataset,t={token:e.token,actor:e.actor,scene:canvas.id},a=f.getSpeaker(t);if(a){let s=a.items.find(i=>i.type=="skill"&&i.name==e.skill);a.setupSkill(s,{modifier:e.mod},e.token).then(async i=>{i.testData.opposable=!1,((await a.basicTest(i)).result.qualityStep||0)<1&&await this.applyEffect(e.message,e.mode,[t],{effectIds:[e.effect],skipResistRolls:!0})})}else console.warn("Actor not found for resist roll.")}static async applyEffect(l,e,t,a={}){let s=game.messages.get(l),i=s.flags.data.preData.source,n=s.flags.data.postData,r=s.speaker;["poison","disease"].includes(i.type)&&(n.qualityStep=n.successLevel>0?2:1);let o=f.getSpeaker(r)||f.getSpeaker(getProperty(s.flags,"data.preData.extra.speaker"))||game.actors.get(getProperty(s.flags,"data.preData.extra.actor.id")),c=o,m=(await this._parseEffectDuration(i,n,s.flags.data.preData,o)).filter(p=>!getProperty(p,"flags.dsa5.applyToOwner"));a.effectIds&&(m=m.filter(p=>a.effectIds.includes(p._id)));let d=[];if(e=="self"?o&&d.push(o):t?d=t.map(p=>f.getSpeaker(p)):game.user.targets.size&&game.user.targets.forEach(p=>{p.actor&&d.push(p.actor)}),game.user.isGM)for(let p of d){let{msg:g,resistRolls:h,effectApplied:y,effectNames:v}=await _DSAActiveEffectConfig.applyAdvancedFunction(p,m,i,n,c,a.skipResistRolls||!1);if(y){let T=`${game.i18n.format("ActiveEffects.appliedEffect",{target:p.token?.name||p.name,source:v.join(", ")})}${g||""}`;await ChatMessage.create(f.chatDataSetup(T))}h.length&&await this.createResistRollMessage(h,l,e)}else game.socket.emit("system.dsa5",{type:"addEffect",payload:{mode:e,id:l,actors:d.map(p=>({token:p.token?p.token.id:void 0,actor:p.id,scene:canvas.scene.id}))}})}static async createResistRollMessage(l,e,t){for(let a of l){let s=await renderTemplate("systems/dsa5/templates/chat/roll/resist-roll.html",{resist:a,id:e,mode:t});await ChatMessage.create(f.chatDataSetup(s))}}static async _parseEffectDuration(l,e,t,a){let s={};for(let c of t.situationalModifiers.filter(m=>m.specAbId))s[c.specAbId]=c.step;let i=Object.keys(s),n=a?a.items.filter(c=>i.includes(c.id)):[],r=l.effects?duplicate(l.effects):[];for(let c of n){let m=duplicate(c).effects;for(let d of m)setProperty(d,"flags.dsa5.specStep",s[c.id]);r.push(...m)}let o=getProperty(l,"system.duration.value")||"";o=o.replace(/ x /g," * ").replace(game.i18n.localize("CHARAbbrev.QS"),e.qualityStep);try{for(let c of _DSAActiveEffectConfig.effectDurationRegexes)if(c.regEx.test(o)){let m=o.replace(c.regEx,"").trim(),d=await _DiceDSA5._stringToRoll(m);if(!isNaN(d))for(let p of r){let g=d*c.seconds,h=getProperty(p,"flags.dsa5.customDuration");if(h){let y=h.split(",")[e.qualityStep-1];y&&y!="-"&&(g=Number(y))}p.duration.seconds=g,p.duration.rounds=p.duration.seconds/5}break}}catch{console.error(`Could not parse duration '${o}' of '${l.name}'`)}return r}dropDownMenu(){let l=game.i18n.localize("MODS.FW"),e=game.i18n.localize("skill"),t=game.i18n.localize("regenerate"),a=game.i18n.localize("MODS.FP"),s=game.i18n.localize("stepValue"),i=game.i18n.localize("MODS.QS"),n=game.i18n.localize("MODS.partChecks"),r=`${game.i18n.localize("LocalizedIDs.perception")} 1`,o=`${game.i18n.localize("LocalizedIDs.wrestle")} 1`,c=game.i18n.localize("closeCombatAttacks"),m=game.i18n.localize("rangeCombatAttacks"),d=`${t} (${game.i18n.localize("CHARAbbrev.CR")})`,p=game.i18n.localize("AsPCost"),g=game.i18n.localize("KaPCost"),h=game.i18n.localize("permanentCost"),y=`${game.i18n.localize("Healing")} 1`,v=`${game.i18n.localize("Description")} 1`,P=`${game.i18n.localize("LocalizedIDs.miracle")}`,T=[{name:game.i18n.localize("protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:game.i18n.localize("liturgyArmor"),val:"system.liturgyArmor",mode:2,ph:"1"},{name:`${game.i18n.localize("resistanceModifier")} (${game.i18n.localize("condition")})`,val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("spellArmor"),val:"system.spellArmor",mode:2,ph:"1"},{name:game.i18n.localize("carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.meleeStats.attack",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.PA")}`,val:"system.meleeStats.parry",mode:2,ph:"1"},{name:`${P} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.miracle.attack",mode:2,ph:"1"},{name:`${P} - ${game.i18n.localize("CHARAbbrev.PA")}`,val:"system.miracle.parry",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:`${c} - ${game.i18n.localize("MODS.defenseMalus")}`,val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:`${game.i18n.localize("CONJURATION.elemental")} 1`},{name:`${m} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.rangeStats.attack",mode:2,ph:"1"},{name:`${m} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:`${m} - ${game.i18n.localize("MODS.defenseMalus")}`,val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:`${game.i18n.localize("spell")} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.spellStats.damage",mode:2,ph:"1"},{name:`${game.i18n.localize("liturgy")} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.liturgyStats.damage",mode:2,ph:"1"},{name:g,val:"system.kapModifier",mode:2,ph:"1"},{name:p,val:"system.aspModifier",mode:2,ph:"1"},{name:`${h} ${game.i18n.localize("CHARAbbrev.AsP")}`,val:"system.status.astralenergy.permanentGear",mode:2,ph:"1"},{name:`${h} ${game.i18n.localize("CHARAbbrev.KaP")}`,val:"system.status.astralenergy.permanentGear",mode:2,ph:"1"},{name:`${e} - ${l}`,val:"system.skillModifiers.FW",mode:0,ph:r},{name:`${e} - ${a}`,val:"system.skillModifiers.FP",mode:0,ph:r},{name:`${e} - ${s}`,val:"system.skillModifiers.step",mode:0,ph:r},{name:`${e} - ${i}`,val:"system.skillModifiers.QL",mode:0,ph:r},{name:`${e} - ${n}`,val:"system.skillModifiers.TPM",mode:0,ph:r},{name:`${game.i18n.localize("vulnerability")} - ${game.i18n.localize("combatskill")}`,val:"system.vulnerabilities.combatskill",mode:0,ph:o},{name:`${e} - ${game.i18n.localize("MODS.global")}`,val:"system.skillModifiers.global",mode:0,ph:"1"},{name:`${d} - ${game.i18n.localize("wounds")}`,val:"system.repeatingEffects.startOfRound.wounds",mode:0,ph:"1d6"},{name:`${d} - ${game.i18n.localize("astralenergy")}`,val:"system.repeatingEffects.startOfRound.astralenergy",mode:0,ph:"1d6"},{name:`${d} - ${game.i18n.localize("karmaenergy")}`,val:"system.repeatingEffects.startOfRound.karmaenergy",mode:0,ph:"1d6"},{name:`${t} - ${game.i18n.localize("wounds")}`,val:"system.status.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:`${t} - ${game.i18n.localize("astralenergy")}`,val:"system.status.regeneration.AsPgearmodifier",mode:2,ph:"1"},{name:`${t} - ${game.i18n.localize("karmaenergy")}`,val:"system.status.regeneration.KaPgearmodifier",mode:2,ph:"1"},{name:`${game.i18n.localize("feature")} - ${p}`,val:"system.skillModifiers.feature.AsPCost",mode:0,ph:y},{name:`${game.i18n.localize("advanced")} - ${p}`,val:"system.skillModifiers.conditional.AsPCost",mode:0,ph:v},{name:`${game.i18n.localize("feature")} - ${g}`,val:"system.skillModifiers.feature.KaPCost",mode:0,ph:y},{name:`${game.i18n.localize("advanced")} - ${g}`,val:"system.skillModifiers.conditional.KaPCost",mode:0,ph:v},{name:`${game.i18n.localize("MODS.sight")}`,val:"system.sightModifier.value",mode:2,ph:"-1"},{name:`${game.i18n.localize("MODS.sightMax")}`,val:"system.sightModifier.maxLevel",mode:5,ph:"4"},{name:`${game.i18n.localize("LocalizedIDs.immuneTo")} ${game.i18n.localize("condition")}`,val:"system.immunities",mode:2,ph:"feared"},{name:game.i18n.localize("temperature.heatProtection"),val:"system.temperature.heatProtection",mode:2,ph:"1"},{name:game.i18n.localize("temperature.coldProtection"),val:"system.temperature.coldProtection",mode:2,ph:"1"}],R=["liturgy","ceremony","spell","ritual","skill","feature"];for(let D of R){let z=D=="skill"?"skillglobal":D,O=game.i18n.localize(z);T.push({name:`${O} - ${l}`,val:`system.skillModifiers.${D}.FW`,mode:0,ph:r},{name:`${O} - ${a}`,val:`system.skillModifiers.${D}.FP`,mode:0,ph:r},{name:`${O} - ${s}`,val:`system.skillModifiers.${D}.step`,mode:0,ph:r},{name:`${O} - ${i}`,val:`system.skillModifiers.${D}.QL`,mode:0,ph:r},{name:`${O} - ${n}`,val:`system.skillModifiers.${D}.TPM`,mode:0,ph:r})}for(let D of CONFIG.statusEffects)getProperty(D,"flags.dsa5.max")&&T.push({name:game.i18n.localize(D.name),val:`system.condition.${D.id}`,mode:2,ph:1});for(let D of Object.keys(b.characteristics))T.push({name:game.i18n.localize(`CHAR.${D.toUpperCase()}`),val:`system.characteristics.${D}.gearmodifier`,mode:2,ph:"1"});for(let D of b.gearModifyableCalculatedAttributes)T.push({name:game.i18n.localize(D),val:`system.status.${D}.gearmodifier`,mode:2,ph:"1"});for(let D of["spell","liturgy","ceremony","ritual"]){let z=f.categoryLocalization(D);for(let O of["soulpower","toughness"])T.push({name:`${game.i18n.localize(O)} (${z})`,val:`system.status.${O}.${D}resist`,mode:2,ph:"1"});for(let O of Object.keys(re.rollModifiers))T.push({name:`${z} - ${game.i18n.localize(O.replace("Spell",""))}`,val:`system.${D}RollModifiers.${O}.mod`,mode:2,ph:"1"},{name:`${z} - ${game.i18n.localize(O.replace("Spell",""))} - ${game.i18n.localize("advanced")}`,val:`system.${D}RollModifiers.${O}.custom`,mode:0,ph:v})}T=T.sort((D,z)=>D.name.localeCompare(z.name));for(let D of T)(!D.ph||D.mode==null)&&console.warn(D);return T=T.map(D=>`<option value="${D.val}" data-mode="${D.mode}" data-ph="${D.ph}">${D.name}</option>`).join(`
`),`<select class="selMenu">${T}</select>`}activateListeners(l){super.activateListeners(l);let e=this.dropDownMenu();l.find(".changes-list .effect-change .key").append(e),l.find(".selMenu").select2({width:"element"}).change(t=>{let a=$(t.currentTarget);a.siblings("input").val(a.val());let s=a.closest(".effect-change"),i=a.find("option:selected");s.find(".mode select").val(i.attr("data-mode")),s.find(".value input").attr("placeholder",i.attr("data-ph")),a.blur()}),l.find(".select2").each((t,a)=>{$(a)[0].style.removeProperty("width")})}};u(_DSAActiveEffectConfig,"DSAActiveEffectConfig");var Ha=class{static async createTokenHook(e,t,a){if(!f.isActiveGM())return;let s=e.parent;if(this.isRiding(e.actor)&&s.active){let i=this.getHorse(e.actor);if(!i)return;let n=await i.getTokenDocument();n.updateSource({x:e.x,y:e.y,hidden:e.hidden});let r=(await s.createEmbeddedDocuments("Token",[n]))[0],o={"flags.dsa5.horseTokenId":r.id,elevation:(r.elevation??0)+1};mergeObject(o,this.adaptTokenSize(e,r)),await e.update(o),r.actorLink||await e.actor.update({"system.horse.actorLink":!1,"system.horse.token":{scene:s.id,token:r.id}})}}static isRiding(e){return getProperty(e,"system.horse.isRiding")}static updateTokenHook(e,t,a){if(!f.isActiveGM())return;let s=getProperty(e,"flags.dsa5.horseTokenId"),i=e.parent;s&&i.active&&(t.x||t.y)&&this.isRiding(e.actor)&&i.updateEmbeddedDocuments("Token",[{_id:s,x:e.x,y:e.y}])}static rollLoyalty(e,t={}){let a=this.getHorse(e);if(!a)return;let s=this.getLoyaltyFromHorse(a);if(!s)return ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:f.categoryLocalization("skill"),name:game.i18n.localize("LocalizedIDs.loyalty")}));a.setupSkill(s,t,a.token?.id).then(i=>{a.basicTest(i)})}static async updateRiderSpeed(e,t){if(!canvas?.tokens?.documentCollection)return;let a=e.getActiveTokens().map(s=>s.id);for(let s of Array.from(canvas.tokens.documentCollection))a.includes(s.getFlag("dsa5","horseTokenId"))&&t!=s.actor.system.status.speed.max&&(s.actor.prepareData(),s.actor.sheet.render())}static getLoyaltyFromHorse(e){return e.items.find(t=>t.type=="skill"&&t.name.startsWith(game.i18n.localize("LocalizedIDs.loyalty")))}static activateListeners(e,t){e.find(".riding-toggle").click(()=>this.toggleIsRiding(t)),e.find(".showHorse").click(()=>this.getHorse(t).sheet.render(!0)),e.find(".horse-delete").click(()=>this.clearMount(t)),e.find(".horse-loyalty").click(()=>this.rollLoyalty(t)),e.find('[name="horseSpeedSelector"]').change(async a=>{a.preventDefault();let s=Ha.getHorse(t);Ha.setSpeed(s,a.currentTarget.value)})}static async toggleIsRiding(e){await e.update({"system.horse.isRiding":!e.system.horse?.isRiding});let t=[];if(e.system.horse.isRiding){let a=this.getHorse(e),s;for(let i of a.getActiveTokens())t.push({_id:i.document.id,["flags.dsa5.-=horseTokenId"]:null}),s=i.document.id;for(let i of e.getActiveTokens())t.push({_id:i.document.id,elevation:Math.max(0,(i.elevation??0)+1),"flags.dsa5.horseTokenId":s});await this.addRidingCondition(e)}else{for(let a of e.getActiveTokens())t.push({_id:a.document.id,["flags.dsa5.-=horseTokenId"]:null,elevation:Math.max(0,(a.elevation??0)-1)});await this.removeRidingCondition(e)}await canvas.scene.updateEmbeddedDocuments("Token",t,{noHooks:!0})}static getRidingCondition(e){let t=game.i18n.localize("RIDING.riding");return e.effects.find(a=>a.name==t)}static async addRidingCondition(e){this.getRidingCondition(e)||await e.addCondition(this.ridingCondition())}static async removeRidingCondition(e){let t=this.getRidingCondition(e);t&&await e.deleteEmbeddedDocuments("ActiveEffect",[t.id])}static deleteTokenHook(){console.warn("delete riding token hook not implemented")}static getHorse(e,t=!1){let a;return e.system.horse&&(e.system.horse.token&&!e.system.horse.actorLink?a=f.getSpeaker(e.system.horse.token):a=game.actors.get(e.system.horse.actorId),!a&&t&&e.system.horse.isRiding&&(a={name:game.i18n.localize("unknown")})),a}static async unmountHorse(e,t){let a={["flags.dsa5.-=horseTokenId"]:null,elevation:Math.max(0,(t.elevation??0)-1)},s=t.getFlag("dsa5","horseResized");s&&mergeObject(a,{["flags.dsa5.-=horseResized"]:null,width:s.width,height:s.height}),await this.clearMount(e),await t.update(a)}static async clearMount(e){await e.update({system:{horse:{isRiding:!1,actorLink:!1,actorId:"","-=token":null}}}),await this.removeRidingCondition(e)}static ridingCondition(){return{name:game.i18n.localize("RIDING.riding"),icon:"systems/dsa5/icons/thirdparty/horse-head.svg",changes:[{key:"system.status.dodge.gearmodifier",mode:2,value:-2}],flags:{dsa5:{description:game.i18n.localize("RIDING.ridingDescription")}}}}static async setHorse(e,t){let a={system:{horse:{isRiding:!0,actorLink:t.prototypeToken.actorLink,actorId:t.id}}};!t.prototypeToken.actorLink&&t.token&&mergeObject(a,{system:{horse:{token:{scene:canvas.scene.id,token:t.token.id}}}}),await e.update(a),t.isToken&&await canvas.scene.updateEmbeddedDocuments("Token",e.getActiveTokens().map(s=>({_id:s.id,"flags.dsa5.horseTokenId":t.token.id,x:t.token.x,y:t.token.y})).concat({_id:t.token.id,["flags.dsa5.-=horseTokenId"]:null}),{noHooks:!0}),await this.addRidingCondition(e)}static adaptTokenSize(e,t){return e.width>=t.width?{width:.7*t.width,height:.7*t.height,"flags.dsa5.horseResized":{width:e.width,height:e.height}}:{}}static async mountHorse(e){let t=canvas.tokens.controlled.find(n=>n.document.id!=e.id),a=e.parent,s={system:{horse:{isRiding:!0,actorLink:t.actorLink,actorId:t.actor.id}}};t.actorLink||mergeObject(s,{system:{horse:{token:{scene:a.id,token:t.id}}}});let i={_id:e.id,"flags.dsa5.horseTokenId":t.id,x:t.x,y:t.y,elevation:(t.document.elevation??0)+1};mergeObject(i,this.adaptTokenSize(e.document,t.document)),await e.actor.update(s),await canvas.scene.updateEmbeddedDocuments("Token",[i,{_id:t.id,["flags.dsa5.-=horseTokenId"]:null}],{noHooks:!0}),await this.addRidingCondition(e.actor)}static getHorseSpeed(e){return e.effects.find(t=>getProperty(t,"flags.dsa5.horseSpeed"))?.flags.dsa5.horseSpeed||0}static horseSpeedModifier(e){let t=this.getHorseSpeed(e);return Object.keys(this.speedKeys).map(a=>Number(a)).indexOf(Number(t))}static increaseSpeed(e){let t=this.getHorseSpeed(e),a=Math.min(3,Object.keys(this.speedKeys).map(s=>Number(s)).indexOf(t)+1);this.setSpeed(e,Object.keys(this.speedKeys).map(s=>Number(s))[a])}static decreaseSpeed(e){let t=this.getHorseSpeed(e),a=Math.max(0,Object.keys(this.speedKeys).map(s=>Number(s)).indexOf(t)-1);this.setSpeed(e,Object.keys(this.speedKeys).map(s=>Number(s))[a])}static async setSpeed(e,t){await e.deleteEmbeddedDocuments("ActiveEffect",e.effects.filter(a=>hasProperty(a,"flags.dsa5.horseSpeed")).map(a=>a.id)),await e.addCondition({name:game.i18n.localize("speed")+": "+game.i18n.localize(`RIDING.speeds.${t}`),icon:"systems/dsa5/icons/thirdparty/horse-head.svg",changes:[this.speedKeys[t]],flags:{dsa5:{description:game.i18n.localize(`RIDING.speed.${t}`),horseSpeed:t}}})}static renderTokenHUD(e,t,a){let s=e.object.actor;if(canvas.tokens.controlled.length==2)t.find(".col.left").prepend(this.preRenderedMountHud),t.find('.control-icon[data-action="ride"]').click(()=>this.mountHorse(e.object));else if(this.isRiding(s)){t.find(".col.left").prepend(this.preRenderedUnmountHud);let i=t.find('.control-icon[data-action="ride"]');i.click(()=>{this.unmountHorse(s,e.object.document),i.remove()});let n=this.getHorse(s);t.find(".col.right").prepend(this.preRenderedSpeedHud),t.find('.control-icon[data-action="rideIncrease"]').click(()=>this.increaseSpeed(n)),t.find('.control-icon[data-action="rideDecrease"]').click(()=>this.decreaseSpeed(n))}}},j=Ha;u(j,"Riding"),F(j,"preRenderedUnmountHud",`
    <div class="control-icon" data-action="ride">
        <i class="fas fa-horse" style="transform: rotate(180deg)" data-tooltip="RIDING.unmount" width="36" height="36">
    </div>
    `),F(j,"preRenderedMountHud",'<div class="control-icon" data-action="ride"><i class="fas fa-horse" data-tooltip="RIDING.mount" width="36" height="36"></div>'),F(j,"preRenderedSpeedHud",`
    <div class="control-icon" data-action="rideIncrease"><i class="fas fa-caret-up" data-tooltip="RIDING.increase" width="36" height="36"></div>
    <div class="control-icon" data-action="rideDecrease"><i class="fas fa-caret-down" data-tooltip="RIDING.decrease" width="36" height="36"></div>
    `),F(j,"speedKeys",{0:{key:"system.status.speed.multiplier",mode:5,value:0},"-4":{key:"system.status.speed.initial",mode:5,value:4},"-5000":{key:"system.status.speed.multiplier",mode:5,value:.66},"-8":{key:"system.status.speed.multiplier",mode:5,value:1}});var ge=class extends Item{static defaultIcon(e){(!e.img||e.img=="")&&(e.type in this.defaultImages?e.img=this.defaultImages[e.type]:e.img="systems/dsa5/icons/blank.webp")}static async create(e,t){return this.defaultIcon(e),await super.create(e,t)}static getSpecAbModifiers(e,t){let a=[];for(let s of e.find(".specAbs")){let i=Number($(s).attr("data-step"));if(i>0){let n=t=="attack"?$(s).attr("data-atbonus"):$(s).attr("data-pabonus"),r=n.split(",").reduce((o,c)=>o+Number(c),0);a.push({name:$(s).find("a").text(),value:isNaN(r)?Number(n.replace("*","")):Number(r)*i,damageBonus:$(s).attr("data-tpbonus"),dmmalus:$(s).attr("data-dmmalus")*i,step:i,specAbId:$(s).attr("data-id"),type:/^\*/.test(n)?"*":void 0})}}return a}static setupSubClasses(){game.dsa5.config.ItemSubclasses={ritual:ss,spell:Ge,liturgy:Gt,ceremony:Ja,advantage:Bt,disadvantage:Bt,aggregatedTest:Wa,trait:ls,blessing:Ya,magictrick:jt,specialability:ns,disease:es,poison:as,armor:Ka,rangeweapon:yt,meleeweapon:ht,ammunition:Ua,equipment:ts,combatskill:Xa,skill:bt,application:is,consumable:Qa,spellextension:os,species:rs,effectwrapper:Va,plant:ja,magicalsign:Ga,patron:qa,demonmark:Ba,information:Za}}static buildSpeaker(e,t){return{token:t,actor:e?.id,scene:canvas.scene?.id}}static parseValueType(e,t){let a="";return/^\*/.test(t)&&(a="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:a}}async addCondition(e,t=1,a=!1,s=!0){return await E.addCondition(this,e,t,a,s)}async removeCondition(e,t=1,a=!0,s=!1){return E.removeCondition(this,e,t,a,s)}hasCondition(e){return E.hasCondition(this,e)}static getMiracleModifiers(e,t,a,s){let i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),n=(getProperty(e,"system.happyTalents.value")||"").split(/;|,/).map(o=>o.replace(i,"").trim()),r=[];if(n.includes(t.name)){let o=e.system.status.karmaenergy.value,c=getProperty(e,`system.miracle.${s}`)||0;if(o<4)return[];r.push({name:game.i18n.localize("LocalizedIDs.miracle"),value:2+c,type:a,selected:!1});let m=game.i18n.localize("LocalizedIDs.miracleMight");o>=6&&L.hasAbility(e,m)&&r.push({name:m,value:3+c,type:a,selected:!1})}return r}static getSkZkModifier(e,t){let a=[],s=[],i=["spell","liturgy","ceremony","ritual"].includes(t.type)&&t.system.effectFormula.value.trim()=="";game.user.targets.size&&game.user.targets.forEach(n=>{if(n.actor){let r=0;i&&(r=M.detectCreatureType(n.actor).reduce((d,p)=>d+p.spellResistanceModifier(n.actor),0));let o=getProperty(n.actor,`system.status.soulpower.${t.type}resist`)||0,c=getProperty(n.actor,`system.status.toughness.${t.type}resist`)||0;a.push((n.actor.system.status.soulpower.max+o)*-1-r),s.push((n.actor.system.status.toughness.max+c)*-1-r)}}),mergeObject(e,{SKModifier:a.length>0?Math.min(...a):0,ZKModifier:s.length>0?Math.min(...s):0})}static async _onCreateDocuments(e,t){for(let a of e)a.actor&&await S.postUpdateConditions(a.actor);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)a.actor&&await S.postUpdateConditions(a.actor);return super._onUpdateDocuments(e,t)}static async _onDeleteDocuments(e,t){for(let a of e)a.actor&&await S.postUpdateConditions(a.actor);return super._onDeleteDocuments(e,t)}static parseEffect(e,t){let a={},s=new RegExp(game.i18n.localize("CHARAbbrev.GS"),"gi");for(let i of e.split(/,|;/).map(n=>n.trim())){let n=i.replace(/(\s+)/g," ").trim().split(" ");n[0]=n[0].replace(s,t.system.status.speed.max),n.length==2&&(!isNaN(n[0])||/(=)?[+-]\d([+-]\d)?/.test(n[0])||/(=)?\d[dDwW]\d/.test(n[0])||/=\d+/.test(n[0])||/\*\d(\.\d)*/.test(n[0]))&&(a[n[1].toLowerCase()]==null?a[n[1].toLowerCase()]=[n[0]]:a[n[1].toLowerCase()].push(n[0]))}return a}static getDefenseMalus(e,t){let a=!1;if(t.flags.oppose){let s=game.messages.get(t.flags.oppose.messageId),i=s.flags.data.preData;a=!(getProperty(i,"source.type")=="meleeweapon"||getProperty(i,"source.system.traitType.value")=="meleeAttack");let n=/ \[(-)?\d{1,}\]/;for(let r of i.situationalModifiers)r.dmmalus!=null&&r.dmmalus!=0?e.push({name:`${game.i18n.localize("MODS.defenseMalus")} - ${r.name.replace(n,"")}`,value:r.dmmalus,selected:!0}):r.type=="defenseMalus"&&r.value!=0&&e.push({name:r.name.replace(n,""),value:r.value,selected:!0});s.flags.data.postData.halfDefense&&e.push({name:`${game.i18n.localize("MODS.defenseMalus")} - ${game.i18n.localize("halfDefenseShort")}`,value:.5,type:"*",selected:!0})}return a}static changeChars(e,t,a,s){e.system.characteristic1.value=t,e.system.characteristic2.value=a,e.system.characteristic3.value=s}static attackSpecAbs(e,t,a="effect.value"){let s=game.i18n.localize("LocalizedAbilityModifiers.at"),i=game.i18n.localize("LocalizedAbilityModifiers.tp"),n=game.i18n.localize("LocalizedAbilityModifiers.dm"),r=[];for(let o of e){let c=ge.parseEffect(getProperty(o.system,a),t),m=c[s]||0,d=c[i]||0,p=c[n]||0,g=["","2","3"].map(h=>getProperty(o,`system.effect.value${h}`)).filter(h=>h).length;if(m!=0||d!=0||p!=0||o.effects.size>0){let h=game.i18n.localize(b.combatSkillSubCategories[o.system.category.sub]);r.push({name:o.name,atbonus:m,tpbonus:d,dmmalus:p,label:`${s.toUpperCase()}: ${m}, ${i.toUpperCase()}: ${d}, ${n.toUpperCase()}: ${p}`,steps:o.system.step.value,category:{id:o.system.category.sub,css:`ab_${o.system.category.sub}`,name:h},id:o.id,actor:t.id,variantCount:g})}}return r}static defenseSpecAbs(e,t,a="effect.value"){let s=[],i=game.i18n.localize("LocalizedAbilityModifiers.pa");for(let n of e){let o=ge.parseEffect(getProperty(n.system,a),t)[i]||0;if(o!=0){let c=game.i18n.localize(b.combatSkillSubCategories[n.system.category.sub]),m=["","2","3"].map(d=>getProperty(n,`system.effect.value${d}`)).filter(d=>d).length;s.push({name:n.name,pabonus:o,tpbonus:0,dmmalus:0,label:`${i}: ${o}`,steps:n.system.step.value,category:{id:n.system.category.sub,css:`ab_${n.system.category.sub}`,name:c},id:n.id,actor:t.id,variantCount:m})}}return s}static buildCombatSpecAbs(e,t,a,s){let i;a?(a.push(game.i18n.localize("LocalizedIDs.all")),a=a.map(o=>o.toLowerCase()),i=u((o,c)=>o.system.list.value.split(/;|,/).map(m=>m.trim().toLowerCase()).filter(m=>c.includes(m.replace(/ \([a-zA-Z ]*\)/,""))).length>0,"searchFilter")):i=u(()=>!0,"searchFilter");let n=game.combat?.isBrawling?()=>!0:o=>Number(o.system.category.sub)!=5,r=e.items.filter(o=>o.type=="specialability"&&t.includes(o.system.category.value)&&o.system.effect.value!=""&&i(o,a)&&n(o));return s=="attack"?this.attackSpecAbs(r,e):this.defenseSpecAbs(r,e)}static getCombatSkillModifier(e,t,a){if(t.type=="trait")return;let s=e.items.find(i=>i.type=="combatskill"&&i.name==t.system.combatskill.value);for(let i of s.effects)for(let n of i.changes)switch(n.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":a.push({name:`${s.name} - ${game.i18n.localize("MODS.defenseMalus")}`,value:n.value*-1,type:"defenseMalus",selected:!0});break}}static attackStatEffect(e,t){t!=0&&(t=isNaN(t)?t:Number(t),e.push({name:game.i18n.localize("statuseffects"),value:t,selected:!0}))}static getTargetSizeAndModifier(e,t,a){let s="average";return game.user.targets.forEach(i=>{if(i.actor){let n=getProperty(i.actor,"system.status.size.value");n&&(s=n),M.addCreatureTypeModifiers(i.actor,t,a,e)}}),s}static prepareRangeAttack(e,t,a,s,i,n,r=void 0){e.push(...x.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.restrictedSenseSight"),-2)),this.getCombatSkillModifier(t,s,e);let o=this.getTargetSizeAndModifier(t,s,e),c=Number(t.system.rangeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("statuseffects")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0});let m={...b.rangeWeaponModifiers};delete m[x.hasVantage(t,game.i18n.localize("LocalizedIDs.senseOfRange"))?"long":"rangesense"],L.hasAbility(t,game.i18n.localize("LocalizedIDs.extremeShot"))||delete m.extreme;let d=L.hasAbility(t,game.i18n.localize("LocalizedIDs.drivingArcher")),p=L.hasAbility(t,game.i18n.localize("LocalizedIDs.mountedArcher")),g;p&&j.isRiding(t)?g=duplicate(b.mountedRangeOptionsSpecAb):d?g=duplicate(b.drivingArcherOptions):g=duplicate(b.mountedRangeOptions),this.swarmModifiers(t,"attack",e),mergeObject(a,{rangeOptions:m,rangeDistance:Object.keys(m)[Y.distanceModifier(game.canvas.tokens.get(i),s,r)],sizeOptions:b.rangeSizeCategories,visionOptions:b.rangeVision,mountedOptions:g,shooterMovementOptions:b.shooterMovementOptions,targetMovementOptions:b.targetMomevementOptions,targetSize:o,combatSpecAbs:n,aimOptions:b.aimOptions})}static swarmModifiers(e,t,a){e.system.swarm?.count>1&&(t=="attack"?a.push({name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:e.system.swarm.parry,type:"defenseMalus",selected:!0},{name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("CHARAbbrev.AT")}`,value:e.system.swarm.attack,selected:!0},{name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("CHARAbbrev.damage")}`,value:e.system.swarm.damage,type:"dmg",selected:!0}):a.push({name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("CHARAbbrev.PA")}`,value:e.system.swarm.parry,selected:!0}))}static prepareMeleeAttack(e,t,a,s,i,n){let r="short";game.user.targets.forEach(m=>{if(m.actor){for(let d of m.actor.items)if((d.type=="meleeweapon"&&d.system.worn.value||d.type=="trait"&&d.system.traitType.value=="meleeAttack"&&d.system.pa)&&(b.meleeRangesArray.indexOf(d.system.reach.value)>b.meleeRangesArray.indexOf(r)&&(r=d.system.reach.value),r=="long"))break}});let o=this.getTargetSizeAndModifier(t,s,e);this.getCombatSkillModifier(t,s,e);let c=Number(t.system.meleeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("statuseffects")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0}),this.swarmModifiers(t,"attack",e),mergeObject(a,{visionOptions:b.meleeRangeVision(a.mode),weaponSizes:b.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:r,combatSpecAbs:i,meleeSizeOptions:b.meleeSizeCategories,targetSize:o,constricted:t.hasCondition("constricted"),wrongHandDisabled:n,offHand:!n&&getProperty(s,"system.worn.offHand")})}static prepareMeleeParry(e,t,a,s,i,n){let r=ge.getDefenseMalus(e,t);this.swarmModifiers(t,"parry",e),mergeObject(a,{visionOptions:b.meleeRangeVision(a.mode),showDefense:!0,isRangeDefense:r,wrongHandDisabled:n&&getProperty(s,"system.worn.offHand"),offHand:!n&&getProperty(s,"system.worn.offHand")&&!_.isShield(s),melee:!0,combatSpecAbs:i,constricted:t.hasCondition("constricted")})}static _chatLineHelper(e,t){return`<b>${game.i18n.localize(e)}</b>: ${t||"-"}`}static setupDialog(e,t,a,s,i){return null}setupEffect(e,t={},a){return ge.getSubClass(this.type).setupDialog(e,t,this,a)}static checkEquality(e,t){return t.type==e.type&&e.name==t.name&&e.system.description?.value==t.system.description?.value}static async combineItem(e,t,a){return e=duplicate(e),e.system.quantity.value+=t.system.quantity.value,await a.updateEmbeddedDocuments("Item",[e])}static areEquals(e,t){return e.type!=t.type?!1:ge.getSubClass(e.type).checkEquality(e,t)}static async stackItems(e,t,a){return await ge.getSubClass(e.type).combineItem(e,t,a)}_setupCardOptions(e,t,a){let s=ChatMessage.getSpeaker();return{speaker:{alias:s.alias,scene:s.scene},flags:{img:s.token?canvas.tokens.get(s.token).document.img:this.img},title:t,template:e}}async itemTest({testData:e,cardOptions:t},a={}){e=await _DiceDSA5.rollDices(e,t);let s=await _DiceDSA5.rollTest(e);if(s.postFunction="itemTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}return a.suppressMessage||_DiceDSA5.renderRollCard(t,s,a.rerenderMessage),{result:s,cardOptions:t}}static chatData(e,t){return[]}static getSubClass(e){return game.dsa5.config.ItemSubclasses[e]||ge}async postItem(){ge.getSubClass(this.type)._postItem(this)}static async _postItem(e){let t=duplicate(e),a=getProperty(t,"system.obfuscation.details"),s=getProperty(t,"system.obfuscation.description");if(mergeObject(t,{properties:a?[]:ge.getSubClass(e.type).chatData(duplicate(t.system),e.name),descriptionObfuscated:s}),t.hasPrice="price"in t.system&&!a,t.hasPrice){let r=t.system.price.value;t.system.QL&&(r=ge.getSubClass(t.type).consumablePrice(t)),t.system.price.D=Math.floor(r/10),r-=t.system.price.D*10,t.system.price.S=Math.floor(r),r-=t.system.price.S,t.system.price.H=Math.floor(r/.1),r-=t.system.price.H*.1,t.system.price.K=Math.round(r/.01);let o=["D","S","H","K"].map(c=>`${t.system.price[c]} <div data-tooltip="${game.i18n.localize(`Money-${c}`)}" class="chatmoney money-${c}"></div>`).join(",");t.properties.push(`<b>${game.i18n.localize("price")}</b>: ${o}`)}e.pack&&(t.itemLink=e.link),t.img.includes("/blank.webp")&&(t.img=null);let i=await renderTemplate("systems/dsa5/templates/chat/post-item.html",t),n=f.chatDataSetup(i);ChatMessage.create(n)}},C=ge;u(C,"Itemdsa5"),F(C,"defaultImages",{advantage:"systems/dsa5/icons/categories/Vorteil.webp",disadvantage:"systems/dsa5/icons/categories/Nachteil.webp",armor:"systems/dsa5/icons/categories/Armor.webp",meleeweapon:"systems/dsa5/icons/categories/Meleeweapon.webp",rangeweapon:"systems/dsa5/icons/categories/Rangeweapon.webp",equipment:"systems/dsa5/icons/categories/Equipment.webp",consumable:"systems/dsa5/icons/categories/consumable.webp",liturgy:"systems/dsa5/icons/categories/Liturgy.webp",spell:"systems/dsa5/icons/categories/Spell.webp",ammunition:"systems/dsa5/icons/categories/Munition.webp",career:"systems/dsa5/icons/categories/Career.webp",magictrick:"systems/dsa5/icons/categories/Spelltrick.webp",blessing:"systems/dsa5/icons/categories/Blessing.webp",combatskill:"systems/dsa5/icons/categories/Combat_Skill.webp",skill:"systems/dsa5/icons/categories/Skill.webp",Geweihte:"systems/dsa5/icons/categories/Geweihte.webp",Weltliche:"systems/dsa5/icons/categories/Weltliche.webp",Zauberer:"systems/dsa5/icons/categories/Zauberer.webp",ritual:"systems/dsa5/icons/categories/ritual.webp",ceremony:"systems/dsa5/icons/categories/ceremony.webp",abilityclerical:"systems/dsa5/icons/categories/ability_clerical.webp",abilityCombat:"systems/dsa5/icons/categories/ability_combat.webp",abilityfatePoints:"systems/dsa5/icons/categories/ability_fate_points.webp",abilitygeneral:"systems/dsa5/icons/categories/ability_general.webp",specialability:"systems/dsa5/icons/categories/ability_general.webp",abilitymagical:"systems/dsa5/icons/categories/ability_magical.webp",abilitylanguage:"systems/dsa5/icons/categories/Ability_Language.webp",abilitystaff:"systems/dsa5/icons/categories/ability_staff.webp",abilityceremonial:"systems/dsa5/icons/categories/ability_ceremonial.webp",abilityanimal:"systems/dsa5/icons/categories/ability_animal.webp",trait:"systems/dsa5/icons/categories/trait.webp",Tiere:"systems/dsa5/icons/categories/Tiere.webp",aggregatedTest:"systems/dsa5/icons/categories/aggregated_test.webp",poison:"systems/dsa5/icons/categories/poison.webp",disease:"systems/dsa5/icons/categories/disease.webp",spellextension:"systems/dsa5/icons/categories/Spellextension.webp",species:"icons/environment/people/group.webp",application:"systems/dsa5/icons/categories/Skill.webp",trick:"systems/dsa5/icons/categories/Tiere.webp",disadvantageanimal:"systems/dsa5/icons/categories/NachteilAnimal.webp",advantageanimal:"systems/dsa5/icons/categories/VorteilAnimal.webp",diseaseanimal:"systems/dsa5/icons/categories/diseaseAnimal.webp",effectwrapper:"icons/svg/aura.svg",liturgyTalisman:"systems/dsa5/icons/categories/LiturgieTalisman.webp",plant:"systems/dsa5/icons/categories/plant.webp",magicalsign:"systems/dsa5/icons/categories/magicalsign.webp",abilitypact:"systems/dsa5/icons/categories/ability_pact.webp",demonmark:"systems/dsa5/icons/categories/ability_pact.webp",patron:"systems/dsa5/icons/categories/ability_pact.webp",information:"systems/dsa5/icons/categories/DSA-Auge.webp",essence:"systems/dsa5/icons/categories/wesenszug.webp",imprint:"systems/dsa5/icons/categories/praegung.webp"});var ja=class extends C{static chatData(e,t){return[this._chatLineHelper("effect",e.effect),this._chatLineHelper("PLANT.recipes",e.recipes),this._chatLineHelper("PLANT.usages",e.usages)]}};u(ja,"PlantItemDSA5");var Ga=class extends C{static chatData(e,t){let a=[this._chatLineHelper("AsPCost",e.asp)];return e.category==2&&a.push(this._chatLineHelper("feature",e.feature)),a}};u(Ga,"MagicalSignItemDSA5");var Ba=class extends C{static chatData(e,t){return[this._chatLineHelper("attributes",e.attribute),this._chatLineHelper("skills",e.skills),this._chatLineHelper("domains",e.domain)]}};u(Ba,"DemonmarkItemDSA5");var qa=class extends C{static chatData(e,t){return[this._chatLineHelper("skills",e.talents),this._chatLineHelper("culture",e.culture),this._chatLineHelper("Category",game.i18n.localize(`PATRON.${e.category}`))]}};u(qa,"PatronItemDSA5");var Wa=class extends C{static async _postItem(e){let t="",a=game.i18n.localize("Ongoing");e.system.cummulatedQS.value>=10?(a=game.i18n.localize("Success"),t=`${await TextEditor.enrichHTML(e.system.partsuccess,{secrets:this.isOwner,async:!0})}${await TextEditor.enrichHTML(e.system.success,{secrets:this.isOwner,async:!0})}`):e.system.cummulatedQS.value>=6?(a=game.i18n.localize("PartSuccess"),t=`${await TextEditor.enrichHTML(e.system.partsuccess,{secrets:this.isOwner,async:!0})}`):e.system.allowedTestCount.value-e.system.usedTestCount.value<=0&&(a=game.i18n.localize("Failure"));let s=[this._chatLineHelper("cummulatedQS",`${e.system.cummulatedQS.value} / 10`),this._chatLineHelper("interval",e.system.interval.value),this._chatLineHelper("probes",`${e.system.usedTestCount.value} / ${e.system.allowedTestCount.value}`),this._chatLineHelper("result",a),t],i=getProperty(e,"system.obfuscation.description"),n=await renderTemplate("systems/dsa5/templates/chat/aggregatedTestResult.html",{descriptionObfuscated:i,item:e,properties:s}),r=f.chatDataSetup(n);ChatMessage.create(r)}};u(Wa,"aggregatedTestItemDSA5");var Ua=class extends C{static chatData(e,t){return[this._chatLineHelper("ammunitiongroup",game.i18n.localize(e.ammunitiongroup.value))]}};u(Ua,"AmmunitionItemDSA5");var Va=class extends C{};u(Va,"EffectWrapperItemDSA5");var Ka=class extends C{static chatData(e,t){let a=[this._chatLineHelper("protection",e.protection.value),this._chatLineHelper("encumbrance",e.encumbrance.value)];return e.effect.value!=""&&a.push(this._chatLineHelper("effect",e.effect.value)),a}};u(Ka,"ArmorItemDSA5");var jt=class extends C{static chatData(e,t){return[this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("feature",e.feature.value)]}};u(jt,"CantripItemDSA5");var Ya=class extends jt{};u(Ya,"BlessingItemDSA5");var Ge=class extends C{static chatData(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",f.replaceConditions(f.replaceDies(e.effect.value)))]}static async getCallbackData(e,t,a){e.testDifficulty=0,e.situationalModifiers=S._parseModifiers(t);let s=new FormDataExtended(t.find("form")[0]).object;e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text(),maintainCost:t.find(".maintainCost").text()},e.situationalModifiers.push({name:game.i18n.localize("removeGesture"),value:Number(s.removeGesture)||0},{name:game.i18n.localize("removeFormula"),value:Number(s.removeFormula)||0},{name:game.i18n.localize("castingTime"),value:t.find(".castingTime").data("mod")},{name:game.i18n.localize("cost"),value:t.find(".aspcost").data("mod")},{name:game.i18n.localize("reach"),value:t.find(".reach").data("mod")},{name:game.i18n.localize("zkModifier"),value:s.zkModifier||0},{name:game.i18n.localize("skModifier"),value:s.skModifier||0},{name:game.i18n.localize("maintainedSpells"),value:s.maintainedSpells*-1}),e.extensions=Ge.getSpecAbModifiers(t),e.advancedModifiers={chars:[0,1,2].map(i=>s[`ch${i}`]),fws:s.fw,qls:s.qs},C.changeChars(e.source,...[0,1,2].map(i=>s[`characteristics${i}`])),await this.applyExtensions(e.source,e.extensions,a)}static async applyExtensions(e,t,a){_.ensureNumber(e);let s=Object.keys(re.rollModifiers).map(i=>`${i}.mod`);for(let i of t){let n=fromUuidSync(i.uuid);if(!!n)for(let r of n.effects)for(let o of r.changes)re.rollChanges.includes(o.key)||s.includes(o.key)||(o.key=="macro.transform"?await f.callItemTransformationMacro(o.value,e,r):r.apply(e,o))}}static getSpecAbModifiers(e){let t=[];for(let a of e.find(".specAbs.active"))t.push({name:a.dataset.name,title:a.getAttribute("title"),uuid:a.dataset.uuid});return t}static attackSpellMalus(e){let t=[];return e.system.effectFormula.value&&t.push({name:game.i18n.localize("MODS.defenseMalus"),value:-4,type:"defenseMalus",selected:!0,source:e.name}),t}static getPropertyModifiers(e,t){let a=["ceremony","liturgy"].includes(t.type),s=(getProperty(t,"system.feature")||"").replace(/\(a-z \-\)/gi,"").split(",").map(c=>c.trim()),i=[],n=a?"KaPCost":"AsPCost",r=["FP","step","QL","TPM","FW",n];for(let c of r){let m=c=="step"?"":c,d=getProperty(e.system.skillModifiers,`feature.${c}`);i.push(...d.filter(p=>s.includes(p.target)).map(p=>({name:p.source,value:p.value,type:m,source:p.source})))}let o=getProperty(e.system.skillModifiers,`conditional.${n}`);return i.push(...o.map(c=>({name:c.target,value:c.value,type:n}))),i}static foreignSpellModifier(e,t,a,s){if(game.settings.get("dsa5","enableForeignSpellModifer")&&["npc","character"].includes(e.type)&&["spell","ritual"].includes(t.type)){let i=t.system.distribution.value.split(",").map(o=>o.trim().toLowerCase()),n=new RegExp(`(${game.i18n.localize("tradition")}|\\)|\\()`,"g"),r=e.system.tradition.magical.replace(n,"").split(",").map(o=>o.trim().toLowerCase());r.push(game.i18n.localize("general").toLowerCase()),s.isForeign=!i.some(o=>r.includes(o)),s.isForeign&&a.push({name:game.i18n.localize("DSASETTINGS.enableForeignSpellModifer"),value:-2,selected:!0})}}static getSituationalModifiers(e,t,a,s){e.push(...Z.getTalentBonus(t,s.name,["advantage","disadvantage","specialability","equipment"]),...x.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalAttunement"),1,!0),...x.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalRestriction"),-1,!0),...x.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.boundToArtifact"),-1,!0),...this.getPropertyModifiers(t,s),...this.attackSpellMalus(s)),this.foreignSpellModifier(t,s,e,a),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&M.addCreatureTypeModifiers(i.actor,s,e,t)}),e.push(...t.getSkillModifier(s.name,s.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value});this.getSkZkModifier(a,s)}static setupDialog(e,t,a,s,i){let n="spell";(a.type=="ceremony"||a.type=="liturgy")&&(n="liturgy");let r=a.name+" "+game.i18n.localize(`${a.type}Test`)+(t.subtitle||""),o={opposable:a.system.effectFormula.value.length>0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)},advancedModifiers:{chars:[0,0,0],fws:0,qls:0},calculatedSpellModifiers:{castingTime:0,cost:0,reach:0,maintainCost:0}},c={rollMode:t.rollMode,spellCost:a.system.AsPCost.value,maintainCost:a.system.maintainCost.value,spellCastingTime:a.system.castingTime.value,spellReach:a.system.range.value,canChangeCost:a.system.canChangeCost.value=="true",canChangeRange:a.system.canChangeRange.value=="true",canChangeCastingTime:a.system.canChangeCastingTime.value=="true",hasSKModifier:a.system.resistanceModifier.value=="SK",hasZKModifier:a.system.resistanceModifier.value=="ZK",maxMods:Math.floor(Number(a.system.talentValue.value)/4),extensions:this.prepareExtensions(s,a),variableBaseCost:a.system.variableBaseCost=="true",characteristics:[1,2,3].map(g=>a.system[`characteristic${g}`].value)},m=s?E.getRollModifiers(s,a):[];this.getSituationalModifiers(m,s,c,a),c.situationalModifiers=m;let d={title:r,template:`/systems/dsa5/templates/dialog/${n}-enhanced-dialog.html`,data:c,callback:async(g,h={})=>(p.rollMode=g.find('[name="rollMode"]').val(),await this.getCallbackData(o,g,s),mergeObject(o.extra.options,h),{testData:o,cardOptions:p})},p=s._setupCardOptions("systems/dsa5/templates/chat/roll/spell-card.html",r,i);return _DiceDSA5.setupDialog({dialogOptions:d,testData:o,cardOptions:p})}static prepareExtensions(e,t){return e.items.filter(a=>a.type=="spellextension"&&a.system.source==t.name&&a.system.category==t.type).map(a=>(a.shortName=a.name.split(" - ").length>1?a.name.split(" - ")[1]:a.name,a.descr=$(a.system.description.value).text()||"",a))}};u(Ge,"SpellItemDSA5");var Gt=class extends Ge{static chatData(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("KaPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",f.replaceConditions(f.replaceDies(e.effect.value)))]}};u(Gt,"LiturgyItemDSA5");var Ja=class extends Gt{static getCallbackData(e,t,a){super.getCallbackData(e,t,a),e.situationalModifiers.push({name:game.i18n.localize("CEREMONYMODIFIER.artefact"),value:t.find('[name="artefactUsage"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}static getSituationalModifiers(e,t,a,s){super.getSituationalModifiers(e,t,a,s),mergeObject(a,{isCeremony:!0,locationModifiers:b.ceremonyLocationModifiers,timeModifiers:b.ceremonyTimeModifiers})}};u(Ja,"CeremonyItemDSA5");var Xa=class extends C{static chatData(e,t){return[this._chatLineHelper("Description",game.i18n.localize(`Combatskilldescr.${t}`))]}static setupDialog(e,t,a,s,i){let n=t.mode,r=a.name+" "+game.i18n.localize(n+"test"),o={opposable:!0,source:a,mode:n,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},c={title:r,template:"systems/dsa5/templates/dialog/combatskill-dialog.html",data:{rollMode:t.rollMode},callback:(d,p={})=>(m.rollMode=d.find('[name="rollMode"]').val(),o.situationalModifiers=S._parseModifiers(d),mergeObject(o.extra.options,p),{testData:o,cardOptions:m})},m=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSA5.setupDialog({dialogOptions:c,testData:o,cardOptions:m})}};u(Xa,"CombatskillDSA5");var Qa=class extends C{static chatData(e,t){return[this._chatLineHelper("qualityStep",e.QL),this._chatLineHelper("effect",f.replaceDies(e.QLList.split(`
`)[e.QL-1])),this._chatLineHelper("charges",e.charges)]}static consumablePrice(e){let t=e.system.price.value;if(isNaN(t)){let a=t.split(";");return t=Number(a[e.system.QL-1]),isNaN(t)&&(t=Number(a.pop())||0),t}else return Number(t)*e.system.QL||0}static checkEquality(e,t){return e.type==t.type&&e.name==t.name&&e.system.description.value==t.system.description.value&&e.system.QL==t.system.QL}static async setupDialog(e,t,a,s){let i=game.i18n.format("CHATNOTIFICATION.usesItem",{actor:a.actor.name,item:a.name});if(!a.isOwned)return;if((a.system.quantity.value-1)*a.system.maxCharges+a.system.charges<=0){ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));return}let r=a.system.charges<=1?a.system.maxCharges:a.system.charges-1,o=a.system.charges<=1?a.system.quantity.value-1:a.system.quantity.value,c=f.replaceDies(a.system.QLList.split(`
`)[a.system.QL-1],!1),m=`<div><b>${i}</b></div><div>${a.system.description.value}</div><div><b>${game.i18n.localize("effect")}</b>: ${c}</div>`;o==0?await a.actor.deleteEmbeddedDocuments("Item",[a.id]):await a.update({"system.quantity.value":o,"system.charges":r}),await ChatMessage.create(f.chatDataSetup(m)),await this._applyActiveEffect(a)}static async _applyActiveEffect(e){let t=e.effects.toObject();if(t.length>0){let{msg:a,resistRolls:s,effectNames:i}=await _DSAActiveEffectConfig.applyAdvancedFunction(e.actor,t,e,{qualityStep:e.system.QL},e.actor),n=`${game.i18n.format("ActiveEffects.appliedEffect",{target:e.actor.token?.name||e.actor.name,source:i.join(", ")})} ${a||""}`;ChatMessage.create(f.chatDataSetup(n))}}static async combineItem(e,t,a){e=duplicate(e);let s=(e.system.quantity.value-1)*e.system.maxCharges+e.system.charges,i=(t.system.quantity.value-1)*t.system.maxCharges+t.system.charges,n=Math.floor((s+i)/e.system.maxCharges)+1,r=(s+i)%e.system.maxCharges;return r==0&&(n-=1,r=e.system.maxCharges),e.system.quantity.value=n,e.system.charges=r,await a.updateEmbeddedDocuments("Item",[e])}};u(Qa,"ConsumableItemDSA");var Za=class extends C{static async _postItem(e){let t=await renderTemplate("systems/dsa5/templates/chat/informationRequestRoll.html",{item:e}),a=f.chatDataSetup(t);ChatMessage.create(a)}};u(Za,"InformationItemDSA5");var es=class extends C{static chatData(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("incubation",e.incubation.value),this._chatLineHelper("damage",f.replaceConditions(f.replaceDies(e.damage.value))),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("source",f.replaceDies(e.source.value)),this._chatLineHelper("treatment",e.treatment.value),this._chatLineHelper("antidot",e.antidot.value),this._chatLineHelper("resistanceModifier",e.resistance.value)]}static getSituationalModifiers(e,t,a,s){s=f.toObjectIfPossible(s),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...x.getVantageAsModifier(i.actor,game.i18n.localize("LocalizedIDs.ResistanttoDisease"),-1,!1,!0))}),this.getSkZkModifier(a,s),mergeObject(a,{hasSKModifier:s.system.resistance.value=="SK",hasZKModifier:s.system.resistance.value=="ZK"})}static setupDialog(e,t,a,s,i){let n=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),r={opposable:!1,source:a,extra:{options:t,speaker:C.buildSpeaker(s,i)}},o={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,s,o,a),o.situationalModifiers=c,t.manualResistance&&mergeObject(o,t.manualResistance);let m={title:n,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:o,callback:(p,g={})=>(d.rollMode=p.find('[name="rollMode"]').val(),r.situationalModifiers=S._parseModifiers(p),r.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:p.find('[name="zkModifier"]').val()||0},{name:game.i18n.localize("skModifier"),value:p.find('[name="skModifier"]').val()||0}),mergeObject(r.extra.options,g),{testData:r,cardOptions:d})},d=a._setupCardOptions(`systems/dsa5/templates/chat/roll/${a.type}-card.html`,n,i);return _DiceDSA5.setupDialog({dialogOptions:m,testData:r,cardOptions:d})}};u(es,"DiseaseItemDSA5");var ts=class extends C{static chatData(e,t){return[this._chatLineHelper("equipmentType",game.i18n.localize(`Equipment.${e.equipmentType.value}`))]}};u(ts,"EquipmentItemDSA5");var ht=class extends C{static chatData(e,t){let a=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("atmod",e.atmod.value),this._chatLineHelper("pamod",e.pamod.value),this._chatLineHelper("reach",game.i18n.localize(`Range-${e.reach.value}`)),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill.value)];return e.effect.value!=""&&a.push(this._chatLineHelper(f.replaceConditions("effect",e.effect.value))),a}static getSituationalModifiers(e,t,a,s){let i=x.hasVantage(t,game.i18n.localize("LocalizedIDs.ambidextrous"));s=f.toObjectIfPossible(s);let n=[s.system.combatskill.value],r=C.buildCombatSpecAbs(t,["Combat"],n,a.mode);a.mode=="attack"?this.prepareMeleeAttack(e,t,a,s,r,i):a.mode=="parry"&&this.prepareMeleeParry(e,t,a,s,r,i),this.attackStatEffect(e,t.system.meleeStats[a.mode]),["attack","parry"].includes(a.mode)&&e.push(...ht.getMiracleModifiers(t,{name:s.system.combatskill.value},"",a.mode))}static setupDialog(e,t,a,s,i){let n=t.mode,r=a.name+" "+game.i18n.localize(n+"test"),o={opposable:t.mode!="parry",source:a,mode:n,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},c=_.multipleDefenseValue(s,f.toObjectIfPossible(a)),m={rollMode:t.rollMode,mode:n,defenseCountString:game.i18n.format("defenseCount",{malus:c})},d=s?E.getRollModifiers(s,a,{mode:n}):[];this.getSituationalModifiers(d,s,m,a),m.situationalModifiers=d,t.situationalModifiers&&m.situationalModifiers.push(...t.situationalModifiers);let p={title:r,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:m,callback:(h,y={})=>(me.resolveMeleeDialog(o,g,h,s,y,c,n),Hooks.call("callbackDialogCombatDSA5",o,s,h,a,i),o.isRangeDefense=m.isRangeDefense,{testData:o,cardOptions:g})},g=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSA5.setupDialog({dialogOptions:p,testData:o,cardOptions:g})}};u(ht,"MeleeweaponDSA5");var as=class extends C{static chatData(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("poisonType",e.poisonType.value),this._chatLineHelper("start",e.start.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("resistanceModifier",e.resistance.value),this._chatLineHelper("effect",f.replaceConditions(f.replaceDies(e.effect.value)))]}static getSituationalModifiers(e,t,a,s){s=f.toObjectIfPossible(s),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...x.getVantageAsModifier(i.actor,game.i18n.localize("LocalizedIDs.poisonResistance"),-1,!1,!0))}),this.getSkZkModifier(a,s),mergeObject(a,{hasSKModifier:s.system.resistance.value=="SK",hasZKModifier:s.system.resistance.value=="ZK"})}static setupDialog(e,t,a,s,i){let n=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),r={opposable:!1,source:a,extra:{options:t,speaker:C.buildSpeaker(s,i)}},o={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,s,o,a),o.situationalModifiers=c;let m={title:n,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:o,callback:(p,g={})=>(d.rollMode=p.find('[name="rollMode"]').val(),r.situationalModifiers=S._parseModifiers(p),r.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:p.find('[name="zkModifier"]').val()||0}),r.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:p.find('[name="skModifier"]').val()||0}),mergeObject(r.extra.options,g),{testData:r,cardOptions:d})},d=a._setupCardOptions(`systems/dsa5/templates/chat/roll/${a.type}-card.html`,n,i);return _DiceDSA5.setupDialog({dialogOptions:m,testData:r,cardOptions:d})}};u(as,"PoisonItemDSA5");var yt=class extends C{static chatData(e,t){let a=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill.value),this._chatLineHelper("reach",e.reach.value)];return e.effect.value!=""&&a.push(this._chatLineHelper(f.replaceConditions("effect",e.effect.value))),a}static getSituationalModifiers(e,t,a,s,i){if(a.mode=="attack"){let n=f.toObjectIfPossible(s),r=[n.system.combatskill.value],o=C.buildCombatSpecAbs(t,["Combat"],r,a.mode),c=t.items.get(n.system.currentAmmo.value);if(c){c=c.toObject(!1),n.system.effect.attributes=(n.system.effect.attributes||"").split(",").concat((c.system.effect.attributes||"").split(",")).filter(d=>d!="").join(",");let m=getProperty(c.flags,"dsa5.poison");m&&mergeObject(s.flags,{dsa5:{poison:m}})}if(this.prepareRangeAttack(e,t,a,n,i,o,c),c){if(c.system.atmod&&e.push({name:`${c.name} - ${game.i18n.localize("atmod")}`,value:c.system.atmod,selected:!0,specAbId:n.system.currentAmmo.value}),c.system.damageMod||c.system.armorMod){let m={name:`${c.name} - ${game.i18n.localize("MODS.damage")}`,value:c.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:n.system.currentAmmo.value};c.system.armorMod&&(m.armorPen=c.system.armorMod),e.push(m)}c.effects.length&&e.push({name:`${c.name} - ${game.i18n.localize("TYPES.Item.ammunition")}`,value:1,type:"effect",selected:!0,specAbId:n.system.currentAmmo.value})}e.push(...yt.getMiracleModifiers(t,{name:n.system.combatskill.value},"",a.mode))}this.attackStatEffect(e,t.system.rangeStats[a.mode])}static async checkAmmunitionState(e,t,a,s){let i=!0;if(s!="damage"){let n=e.system;if(n.ammunitiongroup.value!="infinite")if(n.ammunitiongroup.value=="-")t.extra.ammo=duplicate(e),i=t.extra.ammo.system.quantity.value>0;else{let r=a.items.get(n.currentAmmo.value);r?(t.extra.ammo=r.toObject(),n.ammunitiongroup.value=="mag"?i=t.extra.ammo.system.quantity.value>1||t.extra.ammo.system.mag.value>0&&t.extra.ammo.system.quantity.value>0:i=t.extra.ammo.system.quantity.value>0):i=!1}!i&&a.type=="creature"&&(i=!0)}return i||ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),i}static async setupDialog(e,t,a,s,i){let n=t.mode,r=a.name+" "+game.i18n.localize(n+"test"),o={opposable:t.mode!="parry",source:a,mode:n,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}};if(!await this.checkAmmunitionState(a,o,s,n))return;let c={rollMode:t.rollMode,mode:n},m=s?E.getRollModifiers(s,a,{mode:n}):[];this.getSituationalModifiers(m,s,c,a,i),c.situationalModifiers=m,t.situationalModifiers&&c.situationalModifiers.push(...t.situationalModifiers);let d={title:r,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:c,callback:(g,h={})=>(me.resolveRangeDialog(o,p,g,s,h),Hooks.call("callbackDialogCombatDSA5",o,s,g,a,i),{testData:o,cardOptions:p})},p=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSA5.setupDialog({dialogOptions:d,testData:o,cardOptions:p})}};u(yt,"RangeweaponItemDSA5");var ss=class extends Ge{static getCallbackData(e,t,a){super.getCallbackData(e,t,a),e.situationalModifiers.push({name:game.i18n.localize("RITUALMODIFIER.rightClothes"),value:t.find('[name="rightClothes"]').is(":checked")?1:0},{name:game.i18n.localize("RITUALMODIFIER.rightEquipment"),value:t.find('[name="rightEquipment"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}static getSituationalModifiers(e,t,a,s){super.getSituationalModifiers(e,t,a,s),mergeObject(a,{isRitual:!0,locationModifiers:b.ritualLocationModifiers,timeModifiers:b.ritualTimeModifiers})}};u(ss,"RitualItemDSA5");var is=class extends C{static chatData(e,t){let s=game.i18n.has(`APPLICATION.${e.system.skill} - ${t}`)?game.i18n.has(`APPLICATION.${e.system.skill} - ${t}`):e.description.value;return[this._chatLineHelper("Description",s)]}};u(is,"ApplicationItemDSA5");var bt=class extends C{static chatData(e,t){let s=game.i18n.has(`SKILLdescr.${t}`)?game.i18n.localize(`SKILLdescr.${t}`):e.description.value;return[this._chatLineHelper("Description",s)]}static getSituationalModifiers(e,t,a,s){e.push(...Z.getTalentBonus(t,s.name,["advantage","disadvantage","specialability","equipment"]),...t.getSkillModifier(s.name,s.type),...bt.getMiracleModifiers(t,s,"FW","skill"));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value})}static setupDialog(e,t,a,s,i){let n=a.name+" "+game.i18n.localize("Test")+(t.subtitle||""),r={opposable:!0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},o={rollMode:t.rollMode,difficultyLabels:b.skillDifficultyLabels,modifier:t.modifier||0,characteristics:[1,2,3].map(d=>a.system[`characteristic${d}`].value),situationalModifiers:s?E.getRollModifiers(s,a):[]};t.situationalModifiers&&o.situationalModifiers.push(...t.situationalModifiers),this.getSituationalModifiers(o.situationalModifiers,s,o,a);let c={title:n,template:"/systems/dsa5/templates/dialog/skill-dialog.html",data:o,callback:(d,p={})=>(m.rollMode=d.find('[name="rollMode"]').val(),r.testDifficulty=b.skillDifficultyModifiers[d.find('[name="testDifficulty"]').val()],r.situationalModifiers=S._parseModifiers(d),r.advancedModifiers={chars:[0,1,2].map(g=>Number(d.find(`[name="ch${g}"]`).val())),fws:Number(d.find('[name="fw"]').val()),qls:Number(d.find('[name="qs"]').val())},C.changeChars(r.source,...[0,1,2].map(g=>d.find(`[name="characteristics${g}"]`).val())),mergeObject(r.extra.options,p),{testData:r,cardOptions:m})},m=s._setupCardOptions("systems/dsa5/templates/chat/roll/skill-card.html",n,i);return _DiceDSA5.setupDialog({dialogOptions:c,testData:r,cardOptions:m})}};u(bt,"SkillItemDSA5");var ns=class extends C{static chatData(e,t){return[this._chatLineHelper("rule",e.rule.value)]}};u(ns,"SpecialAbilityItemDSA5");var rs=class extends C{};u(rs,"SpeciesItemDSA5");var os=class extends C{static chatData(e,t){return[this._chatLineHelper("source",e.source),this._chatLineHelper("Category",game.i18n.localize(e.category))]}};u(os,"SpellextensionItemDSA5");var ls=class extends C{static chatData(e,t){let a=[];switch(e.traitType.value){case"meleeAttack":a=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value)];break;case"rangeAttack":a=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value),this._chatLineHelper("reloadTime",e.reloadTime.value)];break;case"armor":a=[this._chatLineHelper("protection",e.damage.value)];break;case"general":a=[];break;case"familiar":a=[this._chatLineHelper("APValue",e.APValue.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("aspect",e.aspect.value)];break;case"trick":a=[this._chatLineHelper("APValue",e.APValue.value)];break;case"entity":a=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("CHARAbbrev.QL",e.AsPCost.value)];break;case"summoning":a=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("conjuringDifficulty",e.at.value)];break}return e.effect.value!=""&&a.push(this._chatLineHelper("effect",e.effect.value)),a}static getSituationalModifiers(e,t,a,s,i){s=f.toObjectIfPossible(s);let n=s.system.traitType.value,r=C.buildCombatSpecAbs(t,["Combat","animal"],void 0,a.mode);a.mode=="attack"&&n=="meleeAttack"?this.prepareMeleeAttack(e,t,a,s,r,!1):a.mode=="attack"&&n=="rangeAttack"?this.prepareRangeAttack(e,t,a,s,i,r):a.mode=="parry"&&this.prepareMeleeParry(e,t,a,s,r,!1),this.attackStatEffect(e,t.system[n=="meleeAttack"?"meleeStats":"rangeStats"][a.mode])}static setupDialog(e,t,a,s,i){let n=t.mode,r=a.name+" "+game.i18n.localize(n+"test"),o={opposable:t.mode!="parry",source:a,mode:n,extra:{actor:s.toObject(!1),options:t,speaker:C.buildSpeaker(s,i)}},c=_.multipleDefenseValue(s,a.toObject()),m={rollMode:t.rollMode,mode:n,defenseCountString:game.i18n.format("defenseCount",{malus:c})},d=getProperty(a,"system.traitType.value"),p=s?E.getRollModifiers(s,a,{mode:n}):[];this.getSituationalModifiers(p,s,m,a,i),m.situationalModifiers=p;let g={title:r,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:m,callback:(y,v={})=>(d=="meleeAttack"?me.resolveMeleeDialog(o,h,y,s,v,c,n):me.resolveRangeDialog(o,h,y,s,v),o.isRangeDefense=m.isRangeDefense,Hooks.call("callbackDialogCombatDSA5",o,s,y,a,i),{testData:o,cardOptions:h})},h=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",r,i);return _DiceDSA5.setupDialog({dialogOptions:g,testData:o,cardOptions:h})}};u(ls,"TraitItemDSA5");var Bt=class extends C{static chatData(e,t){return[this._chatLineHelper("effect",e.effect.value)]}};u(Bt,"VantageItemDSA5");var kt=class extends ae{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}static setData(e,t,a){let s=duplicate(kt.rollModifiers);s.narrowSpace.mod=this.getNarrowSpaceModifier(a,a.mode);let i=`${t}RollModifiers`;if(e.system[i])for(let n of Object.keys(e.system[i]))s[n].mod+=Number(e.system[i][n]?.mod??0);return s}activateListeners(e){super.activateListeners(e);let t=e.find(".specAbs");t.mouseenter(i=>{if(i.currentTarget.getElementsByClassName("hovermenu").length==0){let n=document.createElement("div");n.classList.add("hovermenu");let r=document.createElement("i");r.classList.add("fas","fa-comment"),r.title=game.i18n.localize("SHEET.PostItem"),r.addEventListener("mousedown",this._postItem,!1),n.appendChild(r),i.currentTarget.appendChild(n)}}),t.mouseleave(i=>{let n=i.toElement||i.relatedTarget;n.parentNode==this||n==this||i.currentTarget.querySelectorAll(".hovermenu").forEach(r=>r.remove())}),e.find(".variantChange").mousedown(i=>this.changeSpecAbVariant(i)),e.on("mousedown",".specAbs",i=>{if(e.find(".opportunityAttack").is(":checked")){ui.notifications.error(game.i18n.localize("DSAError.opposedAttackNoSpecAbs"));return}let n=$(i.currentTarget),r=Number(n.attr("data-step")),o=Number(n.attr("data-maxStep")),c=Number(n.attr("data-category"));if(i.button==0){if(r=Math.min(o,r+1),[0,1].includes(c)&&game.settings.get("dsa5","limitCombatSpecAbs")){let m=n.siblings(`[data-category="${c}"]`);m.removeClass("active").attr("data-step",0),m.find(".step").text(ae.roman[0])}}else i.button==2&&(r=Math.clamped(o,0,r-1));n.attr("data-step",r),n.toggleClass("active",r>0),n.find(".step").text(ae.roman[r]),this.checkCounterAttack(i),this.calculateModifier()}),e.find(".opportunityAttack").change(i=>{if($(i.currentTarget).is(":checked"))for(let n of e.find(".specAbs"))$(n).removeClass("active").attr("data-step",0).find(".step").text("")}),e.on("change","input,select",i=>this.calculateModifier(i)),e.find(".modifiers option").mousedown(i=>{this.calculateModifier(i)}),e.find(".quantity-click").mousedown(i=>this.calculateModifier(i));let a=this.readTargets();this.calculateModifier();let s=this;this.checkTargets=setInterval(function(){a=s.compareTargets(e,a)},500)}checkCounterAttack(e){if(!this.dialogData.mode=="parry")return;let t=f.getSpeaker(this.dialogData.speaker);if(t&&t.items.get(e.currentTarget.dataset.id).name==game.i18n.localize("LocalizedIDs.counterAttack")){this.dialogData.counterAttack=e.button==0,this.prepareWeapon();let s=e.button==0?"attack":"parry",i=t.items.get(this.dialogData.source._id),n=E.getRollModifiers(t,i,{mode:s});C.getSubClass(i.type).getSituationalModifiers(n,t,{mode:s},i),s=="attack"&&(n=n.filter(o=>o.type!="defenseMalus"));let r=$(this._element).find("[name=situationalModifiers]");if(n.length>0){if(r.length==0){let c=`<div class="modifiers form-group custom-select">
                                            <label>${game.i18n.localize("DIALOG.SituationalModifiers")}</label>
                                            <select name="situationalModifiers" multiple data-tooltip="${game.i18n.localize("DIALOG.deselectWithStrg")}" />
                                        </div>`;$(this._element).find("[name=rollMode]").parent().after(c),this.position.height+=86,this.setPosition(this.position)}let o="";for(let c of n)o+=`<option value="${c.value}"
                                        data-tooltip="${Handlebars.helpers.situationalTooltip(c)}"
                                        ${c.type?" data-type="+c.type:""}
                                        ${c.specAbId?" data-specAbId="+c.specAbId:""}
                                        ${c.armorPen?" data-armorPen="+c.armorPen:""}
                                        ${c.selected?" selected":""}>
                                    ${c.name} [${c.value}]
                                </option>`;$(this._element).find(".modifiers select").html(o)}else r.length>0&&(r.parent().remove(),this.position.height-=86,this.setPosition(this.position))}}changeSpecAbVariant(e){e.stopPropagation(),e.preventDefault();let t=f.getSpeaker(this.dialogData.speaker);if(t){let s=Number(e.currentTarget.dataset.current)+1;s>=Number(e.currentTarget.dataset.variantcount)&&(s=0),e.currentTarget.dataset.current=s,$(e.currentTarget).text(["A","B","C"][s]);let i=$(e.currentTarget).closest(".specAbs")[0],n=t.items.get(i.dataset.id),r=`effect.value${["","2","3"][s]}`,o=(this.dialogData.mode=="attack"?C.attackSpecAbs([n],t,r):C.defenseSpecAbs([n],t,r))[0];i.dataset.dmmalus=o.dmmalus||0,i.dataset.atbonus=o.atbonus||0,i.dataset.tpbonus=o.tpbonus||0,i.dataset.pabonus=o.pabonus||0,i.dataset.tooltip=o.label,this.calculateModifier()}}async close(e={}){return clearInterval(this.checkTargets),await super.close(e)}_postItem(e){e.stopPropagation();let t=$(e.currentTarget).closest(".specAbs"),a=t.attr("data-actor"),s=t.attr("data-id");return game.actors.get(a).items.get(s).postItem(),!1}recallSettings(e,t,a,s){return super.recallSettings(e,t,a,s),this.prepareWeapon(),this}prepareWeapon(){let e,t=this.dialogData.source;if(["meleeweapon","rangeweapon"].includes(t.type)){let a=f.getSpeaker(this.dialogData.speaker);if(a){let s=t.system.combatskill.value,i=S._calculateCombatSkillValues(a.items.find(n=>n.type=="combatskill"&&n.name==s).toObject(),a.system);switch(t.type){case"meleeweapon":e=S._prepareMeleeWeapon(t,[i],a);break;case"rangeweapon":e=S._prepareRangeWeapon(t,[],[i],a);break}this.dialogData.mode=="attack"||this.dialogData.counterAttack?this.dialogData.rollValue=e.attack:this.dialogData.mode=="parry"&&(this.dialogData.rollValue=e.parry)}else t.type=="dodge"?this.dialogData.rollValue=t.system.value:this.dialogData.mode=="attack"||this.dialogData.counterAttack?this.dialogData.rollValue=Number(t.system.at.value):this.dialogData.mode=="parry"&&(this.dialogData.rollValue=Number(t.system.pa))}}prepareFormRecall(e){super.prepareFormRecall(e);let t=f.getSpeaker(this.dialogData.speaker);Y.lightLevel(t,e);let a=j.isRiding(t),s=e.find('[name="advantageousPosition"]')[0];if(this.dialogData.mode=="attack"){let i=Array.from(game.user.targets).some(r=>j.isRiding(r.actor));s&&(i||a)&&(s.checked=a&&!i);let n=e.find('[name="mountedOptions"]')[0];if(a&&n){let r=j.getHorse(t);r&&(n.selectedIndex=j.horseSpeedModifier(r))}}else if(this.dialogData.mode=="parry"&&t.flags.oppose){let i=f.getSpeaker(t.flags.oppose.speaker),n=j.isRiding(i);s&&(n||a)&&(s.checked=a&&!n)}this.calculateModifier()}static assassinationModifiers(e,t){let a=t.assassinate;if(!a||a=="-")return[];e.opposingWeaponSize=0;let s=t.advantageousPosition?2:0,i=b.meleeRangesArray.indexOf(t.weaponsize),n=game.i18n.localize(`DIALOG.${a}`),r=[{name:n,value:10-s-i}];if(a=="assassinate"){let o=b.meleeRangesArray.indexOf(e.source.system.reach.value);!_.isYieldedTwohanded(e.source)&&e.source.system.worn.wrongGrip&&(o=Math.min(o,1));let c=Math.max(1,new Roll(e.source.system.damage.value.replace(/[DWw]/g,"d")).terms.reduce((p,g)=>p+(g.faces?g.number:0),0))-1,m=[2,0,-2,-4][o]-c*2,d=Math.max(1,5-o-c);r.push({name:n+" ("+game.i18n.localize("CHARAbbrev.damage")+")",damageBonus:m,value:0,step:1},{name:n+" (*)",damageBonus:`*${d}`,value:0,step:1})}else e.source.effects||(e.source.effects=[]),e.source.effects.find(o=>o._id==n)||e.source.effects.push({_id:n,changes:[],disabled:!1,duration:{},icon:"icons/svg/aura.svg",name:n,transfer:!0,flags:{dsa5:{description:n,resistRoll:`${game.i18n.localize("LocalizedIDs.selfControl")} -3`,hideOnToken:!1,hidePlayers:!1,customDuration:"",advancedFunction:"1",args0:"unconscious",args1:""}}});return r}async calculateModifier(){if(this.dialogData.mode=="damage")return;let e=this.dialogData.source,t=e.type=="trait"&&getProperty(e,"system.traitType.value")=="meleeAttack"||e.type=="meleeweapon"||e.type=="dodge",a={source:this.dialogData.source,extra:{options:{}}},s=f.getSpeaker(this.dialogData.speaker);t?kt.resolveMeleeDialog(a,{},this.element,s,{},-3,this.dialogData.mode):kt.resolveRangeDialog(a,{},this.element,s,{},this.dialogData.mode),this.dialogData.modifier=await _DiceDSA5._situationalModifiers(a),this.updateRollButton(this.readTargets())}static getNarrowSpaceModifier(e,t){return t?_.isShield(e.source)?getProperty(b.narrowSpaceModifiers,`shield${e.source.system.reach.shieldSize}.${t}`)||0:getProperty(b.narrowSpaceModifiers,`weapon${e.source.system.reach.value}.${t}`)||0:0}static resolveMeleeDialog(e,t,a,s,i,n,r){this._resolveDefault(e,t,a,i);let o=new FormDataExtended(a.find("form")[0]).object,c=kt.targetIsSwarm(e),m=s.isSwarm();e.opposingWeaponSize=m?0:o.weaponsize,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,o),e.situationalModifiers.push(C.parseValueType(game.i18n.localize("sight"),o.vision||0),{name:game.i18n.localize("attackFromBehind"),value:Number(o.attackFromBehind)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:o.damageModifier,value:0,step:1},{name:game.i18n.format("defenseCount",{malus:n}),value:(Number(o.defenseCount)||0)*n},{name:game.i18n.localize("wrongHand"),value:Number(o.wrongHand)||0},{name:game.i18n.localize("advantageousPosition"),value:Number(o.advantageousPosition)||0},{name:game.i18n.localize("sizeCategory"),value:c?0:b.meleeSizeModifier[o.size]||0},...C.getSpecAbModifiers(a,r),...this.assassinationModifiers(e,o),{name:game.i18n.localize("narrowSpace"),value:Number(o.narrowSpace)||0},{name:game.i18n.localize("doubleAttack"),value:Number(o.doubleAttack)||0}),e.situationalModifiers.some(d=>d.name==game.i18n.localize("LocalizedIDs.counterAttack"))&&(e.mode="attack",e.extra.counterAttack=!0)}static resolveRangeDialog(e,t,a,s,i){this._resolveDefault(e,t,a,i);let n=new FormDataExtended(a.find("form")[0]).object,r=Number(n.quickChange)||0,o=b.rangeSizeModifier[n.size]||0,c=b.rangeMods[n.distance||"medium"].attack;e.situationalModifiers.push({name:game.i18n.localize("target")+" "+a.find('[name="targetMovement"] option:selected').text(),value:Number(n.targetMovement)||0},{name:game.i18n.localize("shooter")+" "+a.find('[name="shooterMovement"] option:selected').text(),value:Number(n.shooterMovement)||0},{name:game.i18n.localize("mount")+" "+a.find('[name="mountedOptions"] option:selected').text(),value:Number(n.mountedOptions)||0},{name:game.i18n.localize("rangeMovementOptions.QUICKCHANGE"),value:r},{name:game.i18n.localize("MODS.combatTurmoil"),value:Number(n.combatTurmoil)||0},{name:game.i18n.localize("aim"),value:Number(n.aim)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:n.damageModifier,value:0,step:1},{name:game.i18n.localize("sight"),value:Number(n.vision)||0},{name:game.i18n.localize("sizeCategory"),value:o},{name:game.i18n.localize("distance"),value:c,damageBonus:b.rangeMods[n.distance||"medium"].damage},...C.getSpecAbModifiers(a,"attack"));let m=s.items.find(d=>d.type=="specialability"&&d.name==game.i18n.localize("LocalizedIDs.sharpshooter"));if(m){let d=getProperty(e.source,"system.combatskill.value")?.toLowerCase();if(d&&m.system.list.value.split(/;|,/).map(p=>p.trim().toLowerCase()).includes(d)){let p=[n.targetMovement,n.shooterMovement,n.mountedOptions,r,o,c],g=Math.abs(p.reduce((y,v)=>(Number(v)<0&&(y+=Number(v)),y),0)),h=Math.min(Number(m.system.step.value)*2,g);h&&e.situationalModifiers.push({name:game.i18n.localize("LocalizedIDs.sharpshooter"),value:h})}}}static _resolveDefault(e,t,a,s){t.rollMode=a.find('[name="rollMode"]').val(),e.situationalModifiers=S._parseModifiers(a),mergeObject(e.extra.options,s)}static targetIsSwarm(){let e=!1;return game.user.targets.forEach(t=>{if(t.actor?.isSwarm()){e=!0;return}}),e}static attackOfOpportunity(e,t){let a=Number(t.opportunityAttack)||0;if(a){e.push({name:game.i18n.localize("opportunityAttack"),value:a});let s=game.i18n.localize("LocalizedIDs.enemySense"),i=game.i18n.localize("LocalizedIDs.winhallStyle");game.user.targets.forEach(n=>{for(let r of n.actor?.items||[])r.type=="specialability"&&(r.name==s?e.push({name:s,value:-4}):r.name==i&&e.push({name:i,value:-2}))})}return a!=0}static getRollButtons(e,t,a,s){let i=Q.getRollButtons(e,t,a,s);if(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType.value=="rangeAttack"){let n=e.source.type=="trait"?Number(e.source.system.reloadTime.value):S.calcLZ(e.source,e.extra.actor),r=e.source.system.reloadTime.progress;r<n&&mergeObject(i,{reloadButton:{label:`${game.i18n.localize("WEAPON.reload")} (${r}/${n})`,callback:async()=>{let o=await f.getSpeaker(e.extra.speaker);await o.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":r+1}]);let c=game.i18n.format("WEAPON.isReloading",{actor:o.token?.name||o.prototypeToken.name,item:e.source.name,status:`${r+1}/${n}`});await ChatMessage.create(f.chatDataSetup(c))}}})}return i}},me=kt;u(me,"DSA5CombatDialog"),F(me,"rollModifiers",{wrongHand:{mod:-4},advantageousPosition:{mod:2},attackFromBehindLabel:{mod:-4},opportunityAttack:{mod:-4},doubleAttack:{mod:-2},narrowSpace:{mod:0},combatTurmoil:{mod:-2},quickChange:{mod:-4},targetMovement:{mod:0}});var wt=class extends ae{static getRollButtons(e,t,a,s){let i=Q.getRollButtons(e,t,a,s);i.rollButton.label=game.i18n.localize("Opposed");let n={nonOpposedButton:{label:game.i18n.localize("Roll"),callback:r=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,r),e.opposable=!1,a(t.callback(r))}},routineRoll:{label:game.i18n.localize("ROLL.routine"),callback:r=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,r),e.routine=!0,mergeObject(e.extra.options,{cheat:!0,predefinedResult:[{val:2,index:0},{val:2,index:1},{val:2,index:2}]}),a(t.callback(r))}}};return mergeObject(n,i),n}activateListeners(e){super.activateListeners(e),e.on("change","input,select",s=>this.rememberFormData(s));let t=this.readTargets(),a=this;this.checkTargets=setInterval(function(){t=a.compareTargets(e,t)},500),this.rememberFormData(),e.on("mousedown",".quantity-click",s=>this.rememberFormData(s)),e.find(".modifiers option").mousedown(s=>{this.rememberFormData(s)})}rememberFormData(e){let t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=S._parseModifiers(this._element),this.calculateRoutine(t)}async calculateRoutine(e){let t=f.getSpeaker(this.dialogData.speaker),a=this.element.find(".routineRoll");if(!t)return a.prop("disabled",!0);let s=!0;for(let d=0;d<3;d++)if(t.system.characteristics[e[`characteristics${d}`]].max*e[`ch${d}`].max<13){s=!1;break}let i=this.dialogData.source.system.talentValue.value+e.fw+await _DiceDSA5._situationalModifiers(e,"FW"),n=b.skillDifficultyModifiers[e.testDifficulty]+await _DiceDSA5._situationalModifiers(e),r=Math.clamped(10-n*3,1,19),o=i>=r,c=s&&o,m=game.i18n.localize("ROLL.routine");a.prop("disabled",!c),a.html(c?`${m} (${game.i18n.localize("CHARAbbrev.FW")} ${Math.round(i/2)})`:m)}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}};u(wt,"DSA5SkillDialog");var Q=class extends ae{static getDialogForItem(e,t){let a=e.extra.actor,s=e.source.type;switch(s){case"rangeweapon":case"meleeweapon":case"dodge":case"trait":return t.rollModifiers=me.setData(a,s,e),me;case"spell":case"ritual":case"liturgy":case"ceremony":return t.rollModifiers=re.setData(a,s),re;case"skill":return wt}return Q}static getRollButtons(e,t,a,s){let i={rollButton:{label:game.i18n.localize("Roll"),callback:n=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),a(t.callback(n))}}};return game.user.isGM&&mergeObject(i,{cheat:{label:game.i18n.localize("DIALOG.cheat"),callback:n=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),a(t.callback(n,{cheat:!0}))}}}),i}activateListeners(e){super.activateListeners(e),e.find(".dieButton").click(t=>{let a=$(t.currentTarget);a.attr("data-single")=="true"&&a.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),a.toggleClass("dieSelected")})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};u(Q,"DSA5Dialog");var ce=class extends Z{static async traitAdded(e,t){b.addTraitRules[t.name]&&await b.addTraitRules[t.name](e,t)}static hasTrait(e,t){return super.hasItem(e,t,["trait"])}};u(ce,"TraitRulesDSA5");Hooks.on("setup",()=>{let l=game.i18n.localize("LocalizedIDs.familiar");b.addTraitRules[l]=async(e,t)=>{t.effects.length==0&&(t.effects=[{changes:[{key:"system.status.wounds.gearmodifier",mode:2,value:10},{key:"system.status.soulpower.gearmodifier",mode:2,value:1},{key:"system.status.toughness.gearmodifier",mode:2,value:1},{key:"system.status.astralenergy.gearmodifier",mode:2,value:15},{key:"system.characteristics.mu.gearmodifier",mode:2,value:1},{key:"system.characteristics.kl.gearmodifier",mode:2,value:1},{key:"system.characteristics.in.gearmodifier",mode:2,value:1},{key:"system.characteristics.ch.gearmodifier",mode:2,value:1},{key:"system.characteristics.ff.gearmodifier",mode:2,value:1},{key:"system.characteristics.ge.gearmodifier",mode:2,value:1},{key:"system.characteristics.ko.gearmodifier",mode:2,value:1},{key:"system.characteristics.kk.gearmodifier",mode:2,value:1},{key:"system.totalArmor",mode:2,value:1}],duration:{},icon:"icons/svg/aura.svg",name:l,transfer:!0,flags:{dsa5:{description:l,hideOnToken:!0,hidePlayers:!1}}}]);let a=game.i18n.localize("LocalizedIDs.witchSense");if(!Z.hasItem(e,a,["trait"])){let s=await f.findAnyItem([{name:a,type:"trait"}]);await e.createEmbeddedDocuments("Item",s)}}});var oe=class extends Dialog{static async showDialog(e){let t=this.callbackResult;new oe({title:game.i18n.localize("Unopposed"),content:await this.getTemplate(e),default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:a=>{t(a.find('[name="entryselection"]').val(),e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}activateListeners(e){super.activateListeners(e),e.find(".select2").select2()}static getTargetActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.targetSpeaker,a=f.getSpeaker(t);return a?{actor:a,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}static async getTemplate(e){return""}static callbackResult(e,t,a){}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};u(oe,"DialogReactDSA5");var rt=class extends oe{static async getTemplate(e){let s=game.messages.get(e.flags.unopposeData.attackMessageId).flags.data.preData.source.name,i=(await f.allSkillsList()).map(n=>({name:n,id:n}));return i.unshift({name:game.i18n.localize("doNothing"),id:"doNothing"}),renderTemplate("systems/dsa5/templates/dialog/dialog-act.html",{items:i,original:s,title:"DIALOG.selectReaction"})}static callbackResult(e,t){let{actor:a,tokenId:s}=oe.getTargetActor(t);if(e=="doNothing")H.resolveUndefended(t);else{let i=a.items.find(n=>n.name==e&&n.type=="skill");i&&a.setupSkill(i,{},s).then(n=>{a.basicTest(n)})}}};u(rt,"ReactToSkillDialog");var Ne=class extends Dialog{static async showDialog(e,t){let a=new Ne({title:game.i18n.localize("attacktest"),content:await this.getTemplate(e),buttons:{}});a.actor=e,a.tokenId=t,a.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.actor,this.tokenId),this.close()})}static async getTemplate(e){let t=e.items.filter(r=>r.type=="combatskill").map(r=>S._calculateCombatSkillValues(r.toObject(),e.system)),a=t.find(r=>r.name==game.i18n.localize("LocalizedIDs.wrestle")),s=[{name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:a.system.attack.value}],i=["meleeweapon","rangeweapon"],n=["meleeAttack","rangeAttack"];for(let r of e.items)if(i.includes(r.type)&&r.system.worn.value==!0){let o=r.type=="meleeweapon"?S._prepareMeleeWeapon(r.toObject(),t,e):S._prepareRangeWeapon(r.toObject(),[],t,e);s.push({name:r.name,id:r.name,img:r.img,value:o.attack,item:o})}else r.type=="trait"&&n.includes(r.system.traitType.value)&&s.push({name:r.name,id:r.name,img:r.img,value:r.system.at.value});return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:s,title:"DIALOG.selectAction"})}callbackResult(e,t,a){if(e=="attackWeaponless")t.setupWeaponless("attack",{},a).then(s=>{t.basicTest(s)});else{let s=["meleeweapon","trait","rangeweapon"],i=t.items.find(n=>s.includes(n.type)&&n.name==e);i&&t.setupWeapon(i,"attack",{},a).then(n=>{t.basicTest(n)})}}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:550}),e}};u(Ne,"ActAttackDialog");var Ce=class extends oe{static async showDialog(e){let t=new Ce({title:game.i18n.localize("Unopposed"),content:await this.getTemplate(e),buttons:{}});t.startMessage=e,t.render(!0)}static getAttackActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.attackMessageId,s=game.messages.get(t).flags.data.preData.extra.speaker,i=f.getSpeaker(s);return i?{actor:i,tokenId:s.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.startMessage),this.close()})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:550}),e}static async getTemplate(e){let{actor:t,tokenId:a}=oe.getTargetActor(e),s=Ce.getAttackActor(e),i=t.items.filter(m=>m.type=="combatskill").map(m=>S._calculateCombatSkillValues(m.toObject(),t.system)),n=i.find(m=>m.name==game.i18n.localize("LocalizedIDs.wrestle")),r=[{name:game.i18n.localize("doNothing"),id:"doNothing",img:"systems/dsa5/icons/categories/disease.webp"},{name:game.i18n.localize("dodge"),id:"dodge",img:"systems/dsa5/icons/categories/Dodge.webp",value:t.system.status.dodge.max},{name:game.i18n.localize("parryWeaponless"),id:"parryWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:n.system.parry.value}],o=0,c="";if(t){let m=["meleeweapon"];for(let d of t.items)if(m.includes(d.type)&&d.system.worn.value==!0){let p=S._prepareMeleeWeapon(d.toObject(),i,t);r.push({name:d.name,id:d.name,img:d.img,value:p.parry})}else d.type=="trait"&&Number(d.system.pa)>0&&r.push({name:d.name,id:d.name,img:d.img,value:d.system.pa});if(s){let d=getProperty(s.actor.system,"status.size.value");d=="big"?c="DIALOGDESCRIPTION.bigEnemy":d=="giant"&&(c="DIALOGDESCRIPTION.giantEnemy")}game.combat&&(o=await game.combat.getDefenseCount({actor:t.id,token:a,scene:canvas.scene?canvas.scene.id:null}))}return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-in",items:r,defenses:o,title:"DIALOG.selectReaction",sizeNotification:c})}callbackResult(e,t){let{actor:a,tokenId:s}=oe.getTargetActor(t);if(e=="doNothing")H.resolveUndefended(t);else if(e=="dodge")a.setupDodge({},s).then(i=>{a.basicTest(i)});else if(e=="parryWeaponless")a.setupWeaponless("parry",{},s).then(i=>{a.basicTest(i)});else{let i=["meleeweapon","trait"],n=a.items.find(r=>i.includes(r.type)&&r.name==e);n&&a.setupWeapon(n,"parry",{},s).then(r=>{a.basicTest(r)})}}};u(Ce,"ReactToAttackDialog");var W=class{static armorWearModifier(e,t){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(W.calculateWear(e)){case 1:case 2:t-=1;break;case 3:case 4:t=0}return Math.max(0,Number(t))}static armorGetsDamage(e,t){return(e>14||t.successLevel>2)&&game.settings.get("dsa5","armorAndWeaponDamage")}static armorEncumbranceModifier(e){return game.settings.get("dsa5","armorAndWeaponDamage")&&W.calculateWear(e)>1?1:0}static async showDamageToGear(e,t){if(game.settings.get("dsa5","armorAndWeaponDamage")){let a=f.getSpeaker(e.extra.speaker),s=0,i=getProperty(a,"flags.oppose.messageId");if(i){let r=game.messages.get(i);r&&(s=getProperty(r,"flags.data.postData.successLevel")||0)}let n=e.source;if(n._id&&n.system.structure&&(t.successLevel<-2||s>2)&&["meleeweapon","rangeweapon","armor"].includes(n.type))return a=await f.getSpeaker(t.speaker),a.items.get(n._id).uuid}}static breakingTest(e){if(!e)return ui.notifications.warn(game.i18n.format("DSAError.notfound",{category:"",name:game.i18n.localize("equipment")}));if(e.system.structure.max<=0)return ui.notifications.warn(game.i18n.format("DSAError.noBreakingStructure",{name:e.name}));let t=0,a;if(e.type=="armor"?(a=game.i18n.localize(`ARMORSUBCATEGORIES.${e.system.subcategory}`),t=getProperty(e,"system.structure.breakPointRating")||b.armorSubcategories[e.system.subcategory]):(a=e.system.combatskill.value,t=getProperty(e,"system.structure.breakPointRating")||b.weaponStabilities[game.i18n.localize(`LocalizedCTs.${a}`)]),!t){ui.notifications.error(game.i18n.format("DSAError.noBreakingResistance",{item:e.name}));return}let s="",i=getProperty(e,"effect.attributes")||"";new RegExp(`${M.magical}`,"i").test(i)?s=`${game.i18n.format("WEAPON.attributeWarning",{domain:M.clerical})}<br/>`:new RegExp(`${M.clerical}`,"i").test(i)&&(s=`${game.i18n.format("WEAPON.attributeWarning",{domain:M.magical})}<br/>`),new ae({title:game.i18n.localize("DSASETTINGS.armorAndWeaponDamage"),content:`${s}<label for="threshold">${game.i18n.format("WEAR.check",{category:a})}</label>: <input class="quantity-click" style="width:80px" dtype="number" name="threshold" type="number" value="${t}"/>`,buttons:{Yes:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:n=>{W.resolveBreakingTest(e,Number(n.find('[name="threshold"]').val()),a)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}static async applyDamageLevelToItem(e,t){let a=Math.ceil(e.system.structure.max*.25)*t;await e.update({"system.structure.value":Math.max(0,e.system.structure.value-a)})}static async absoluteDamageLevelToItem(e,t){let a=Math.ceil(e.system.structure.max*.25)*t;await e.update({"system.structure.value":Math.min(e.system.structure.value,Math.max(0,e.system.structure.max-a))})}static async resolveBreakingTest(e,t,a){let s=await _DiceDSA5.manualRolls(await new Roll("1d20").evaluate({async:!0}),game.i18n.format("WEAR.check",{category:a}));await _DiceDSA5.showDiceSoNice(s,await game.settings.get("core","rollMode"));let i=s.total>t?1:0;await this.applyDamageLevelToItem(e,i);let n=W.calculateWear(e.data),r=await renderTemplate("systems/dsa5/templates/system/breakingtest.html",{wear:n,item:e,threshold:t,category:a,roll:s,result:game.i18n.localize(`WEAR.${e.type}.${n}`)});ChatMessage.create(f.chatDataSetup(r))}static damageTooltip(e){if(game.settings.get("dsa5","armorAndWeaponDamage")){let t=this.calculateWear(e);return{msg:game.i18n.localize(`WEAR.${e.type}.${t}`),css:`gearD damaged${t}`}}return{msg:"",css:""}}static weaponWearModifier(e){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(W.calculateWear(e)){case 1:e.attack-=1,e.parry&&(e.parry-=1);break;case 2:e.attack-=2,e.parry&&(e.parry-=2);break;case 3:case 4:e.attack=0,e.parry&&(e.parry=0)}}static calculateWear(e){return!e.system.structure||Number(e.system.structure.max<=0)?0:Math.floor((1-e.system.structure.value/e.system.structure.max)*4)}};u(W,"EquipmentDamage");var ue=class{static prepareSoundEffects(){ue.soundPaths={money:[],armor:[],meleeweapon:[],rangeweapon:[],default:[]},game.modules.get("gAudioBundle-3")&&(ue.soundPaths.money.push("modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"),ue.soundPaths.meleeweapon.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg")),game.modules.get("gAudioBundle-2")&&(ue.soundPaths.meleeweapon.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),ue.soundPaths.armor.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg"),ue.soundPaths.default.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg")),game.modules.get("gAudioBundle-4")&&ue.soundPaths.rangeweapon.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg"),Hooks.call("setDefaultDSASounds",ue.soundPaths)}static async playEffect(e,t,a,s=void 0,i=!1){let n=await this.getSound(e,t,a);if(n)try{s?(game.socket.emit("system.dsa5",{type:"playWhisperSound",payload:{whisper:s,soundPath:n}}),i||AudioHelper.play({src:n,volume:.8,loop:!1},!1)):AudioHelper.play({src:n,volume:.8,loop:!1},!0)}catch{console.warn(`Could not play item sound effect ${n}`)}}static async loadSoundConfig(){let e=await game.settings.get("dsa5","soundConfig");if(e)try{let a=await(await fetch(e)).json();this.sounds=a,console.log("DSA5 | Sound Config Loaded")}catch(t){console.warn(t)}}static successLevelToString(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}static async getSound(e,t,a){if(!this.sounds&&!this.triedInit&&(await this.loadSoundConfig(),this.triedInit=!0),!this.sounds)return;let s=this.successLevelToString(a),i=[],n;switch(t.type){case"meleeweapon":case"rangeweapon":i=[...s.map(r=>`${t.type}.manual.${t.name}.${e}_${r}`),`${t.type}.manual.${t.name}.${e}`,`${t.type}.manual.${t.name}.default.${e}`,`${t.type}.manual.${t.name}.default`,...s.map(r=>`${t.type}.${t.system.combatskill.value}.${e}_${r}`),`${t.type}.${t.system.combatskill.value}.${e}`,...s.map(r=>`${t.type}.${t.system.combatskill.value}.default_${r}`),`${t.type}.${t.system.combatskill.value}.default`];break;case"skill":i=[...s.map(r=>`${t.type}.${t.name}.${e}_${r}`),`${t.type}.${t.name}.${e}`,...s.map(r=>`${t.type}.${t.name}.default_${r}`),`${t.type}.${t.name}.default`];break;case"liturgy":case"spell":case"ceremony":case"ritual":i=[...s.map(r=>`${t.type}.${t.name}.${e}_${r}`),`${t.type}.${t.name}.${e}`,...s.map(r=>`${t.type}.${t.name}.default_${r}`),`${t.type}.${t.name}.default`];break}i.push(...s.map(r=>`${t.type}.default_${r}`),`${t.type}.default`);for(let r of i)if(!!hasProperty(this.sounds,r)&&(n=getProperty(this.sounds,r),n&&(typeof n=="string"||n instanceof String)))break;return n}static async playMoneySound(e=!1){let t=ue.soundPaths.money,a=t[Math.floor(Math.random()*t.length)];await this.playSoundPath(a,e)}static async playEquipmentWearStatusChange(e,t=!1){let a=ue.soundPaths[e.type]||ue.soundPaths.default;if(a.length>0){let s=a[Math.floor(Math.random()*a.length)];await this.playSoundPath(s,t,.5)}}static async playSoundPath(e,t=!1,a=.8){if(!!game.settings.get("dsa5","inventorySound"))try{AudioHelper.play({src:e,volume:a,loop:!1},t)}catch{console.warn(`Could not play item sound effect ${e}`)}}},V=ue;u(V,"DSA5SoundEffect"),F(V,"sounds"),F(V,"triedInit",!1);var J=class{constructor(e){this.item=e}async callMacro(e,t,a={}){let i=await game.packs.get(e).getDocuments({name:t});if(!i.length){for(let r of game.packs.filter(o=>o.documentName=="Macro"&&/\(internal\)/.test(o.metadata.label)))if(i=await r.getDocuments({name:t}),i.length)break}let n={};if(i.length)try{a.result=n;let r=Object.getPrototypeOf(async function(){}).constructor,o=new r("args","actor","item",`
                const that = this;
                ${i[0].command.replace(/( |\(|{)this\./g," that.")}
                `);n.ret=await o.call(this,a,this.item.actor,this.item)}catch(r){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(r),n.error=!0}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:t}));return n}async executeOnUseEffect(){if(!game.user.can("MACRO_SCRIPT"))return ui.notifications.warn("You are not allowed to use JavaScript macros.");if(!this.item.actor)return;let e=J.getOnUseEffect(this.item);try{let t=Object.getPrototypeOf(async function(){}).constructor;await new t("item","actor",e).call(this,this.item,this.item.actor)}catch(t){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(t),console.warn(t.stack)}}static getOnUseEffect(e){return e.getFlag("dsa5","onUseEffect")}async automatedAnimation(e,t={}){f.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}effectDummy(e,t,a){return{name:e,icon:"icons/svg/aura.svg",changes:t,duration:a,flags:{dsa5:{value:null,editable:!0,description:e,custom:!0}}}}async socketedConditionAddActor(e,t){if(game.user.isGM){let a=typeof t=="string";a&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let s=[];for(let i of e)a?await i.addCondition(t,1,!1,!1):await i.addCondition(t),s.push(i.name);await this.createInfoMessage(t,s)}else{let a={id:this.item.uuid,data:t,actors:e.map(s=>s.id)};game.socket.emit("system.dsa5",{type:"socketedConditionAddActor",payload:a})}}async createInfoMessage(e,t,a=!0){if(t.length){let s=a?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",i=game.i18n.format(s,{source:e.name,target:t.join(", ")});await ChatMessage.create(f.chatDataSetup(i))}}async socketedRemoveCondition(e,t,a=1){if(game.user.isGM){let s=[];for(let n of e){let r=canvas.tokens.get(n);r.actor&&(await r.actor.removeCondition(t,a,!1),s.push(r.name))}let i=CONFIG.statusEffects.find(n=>n.id==t);i.name=game.i18n.localize(i.name),await this.createInfoMessage(i,s,!1)}else{let s={id:this.item.uuid,coreId:t,targets:e};game.socket.emit("system.dsa5",{type:"socketedRemoveCondition",payload:s})}}async socketedActorTransformation(e,t){if(game.user.isGM)for(let a of e){let s=canvas.tokens.get(a);s.actor&&await s.actor.update(t)}else{let a={id:this.item.uuid,targets:e,update:t};game.socket.emit("system.dsa5",{type:"socketedActorTransformation",payload:a})}}async socketedConditionAdd(e,t){if(game.user.isGM){let a=typeof t=="string";a&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let s=[];for(let i of e){let n=canvas.tokens.get(i);n.actor&&(a?await n.actor.addCondition(t,1,!1,!1):await n.actor.addCondition(t),s.push(n.name))}await this.createInfoMessage(t,s)}else{let a={id:this.item.uuid,data:t,targets:e};game.socket.emit("system.dsa5",{type:"socketedConditionAdd",payload:a})}}};u(J,"OnUseEffect");var Be=class{static async postOpposed(e){let t=f.getSpeaker(e.attacker.speaker);!t||await this.runMacro(t,e.attacker.testResult,7,e)}static async postRoll(e){let t=f.getSpeaker(e.testData.speaker);!t||await this.runMacro(t,e.testData,6,e)}static async callMacro(e,t,a,s={}){return await new J(e).callMacro(t,a,s)}static async runMacro(e,t,a,s){if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else for(let[i,n]of Object.entries(e.dsatriggers[a])){let r=e.items.get(i),o=r.effects.get(n),c=o.getFlag("dsa5","args3");try{let m=Object.getPrototypeOf(async function(){}).constructor;return await new m("actor","testData","type","data","source","ef",c).call(this,e,t,a,s,r,o)}catch(m){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(m)}}}};u(Be,"DSATriggers");var H=class{static async handleOpposedTarget(e){if(!e)return;let t=f.getSpeaker(e.speaker);if(!t)return;let a=e.flags.data.postData,s=e.flags.data.preData;t.flags.oppose?H.answerOpposedTest(t,e,a,s):game.user.targets.size&&e.flags.data.isOpposedTest&&!e.flags.data.defenderMessage&&!e.flags.data.attackerMessage?H.createOpposedTest(t,e,a,s):e.flags.data.defenderMessage||e.flags.data.attackerMessage?H.resolveFinalMessage(e):e.flags.data.unopposedStartMessage?H.redoUndefended(e):e.flags.data.startMessagesList?H.changeStartMessage(e):(await this.showDamage(e),await this.showSpellWithoutTarget(e))}static async redoUndefended(e){let t=game.messages.get(e.flags.data.unopposedStartMessage);startmessage.flags.unopposeData.attackMessageId=e.id,this.resolveUndefended(t)}static async answerOpposedTest(e,t,a,s){let i=game.messages.get(e.flags.oppose.messageId);if(!i)return ui.notifications.error(game.i18n.localize("DSAError.staleData")),await H.clearOpposed(e),H.createOpposedTest(e,t,a,s);let n={speaker:e.flags.oppose.speaker,testResult:i.flags.data.postData,messageId:i.id,img:f.getSpeaker(e.flags.oppose.speaker)?.img};n.testResult.source=i.flags.data.preData.source,n.testResult.ammo&&n.testResult.source.effects.push(...n.testResult.ammo.effects);let r={speaker:t.speaker,testResult:a,messageId:t.id,img:e.msg},o=i.flags.data.defenderMessage?Array.from(i.flags.data.defenderMessage):[];o.push(t.id),game.user.isGM&&await i.update({"flags.data.defenderMessage":o}),await t.update({"flags.data.attackerMessage":i.id}),await this.completeOpposedProcess(n,r,{target:!0,startMessageId:e.flags.oppose.startMessageId,whisper:t.whisper,blind:t.blind}),await H.clearOpposed(e)}static videoOrImgTag(e){return/\.webm$/.test(e)?`<video loop autoplay src="${e}" width="50" height="50"></video>`:`<img src="${e}" width="50" height="50"/>`}static async createOpposedTest(e,t,a,s){let i;t.speaker.token?i=canvas.tokens.get(t.speaker.token).document:i=e.prototypeToken;let n=a.options?.mode=="damage";if(a.successLevel>0||n){let r=t.flags.data.preData.attackOfOpportunity,o=r?"":`<div><button class="unopposed-button small-button chat-button-target" data-target="true">${game.i18n.localize("Unopposed")}</button></div>`,c=[];game.user.targets.forEach(async m=>{if(m.actor){let d=`${H.opposeMessage(i,m,!1)} ${o}`,p=await ChatMessage.create({user:game.user.id,content:d,speaker:t.speaker,["flags.unopposeData"]:{attackMessageId:t.id,targetSpeaker:{scene:m.scene.id,token:m.id,alias:m.document.name}}}),g={speaker:t.speaker,messageId:t.id,startMessageId:p.id};game.user.isGM?await m.actor.update({"flags.oppose":g}):game.socket.emit("system.dsa5",{type:"target",payload:{target:m.id,scene:m.scene?.id||canvas.scene?.id,opposeFlag:g}}),c.push(p.id),r?await H.resolveUndefended(p,game.i18n.localize("OPPOSED.attackOfOpportunity")):n&&await H.resolveUndefended(p),Hooks.call("DSAOpposedRollStart",m)}}),t.flags.data.startMessagesList=c}else game.user.targets.forEach(async r=>{r.actor&&await ChatMessage.create({user:game.user.id,content:H.opposeMessage(i,r,!0),speaker:t.speaker})})}static opposeMessage(e,t,a){return`<div class="opposed-message">
            <b>${e.name}</b> ${game.i18n.localize("ROLL.Targeting")} <b>${t.document.name}</b> ${a?game.i18n.localize("ROLL.failed"):""}
            </div>
            <div class="opposed-tokens row-section">
                <div class="col two attacker">${H.videoOrImgTag(e.texture.src)}</div>
                <div class="col two defender">${H.videoOrImgTag(t.document.texture.src)}</div>
            </div>
             `}static async changeStartMessage(e){for(let t of e.flags.data.startMessagesList){let a=game.messages.get(t),s=a.flags.unopposeData;game.socket.emit("system.dsa5",{type:"target",payload:{target:s.targetSpeaker.token,scene:canvas.scene.id,opposeFlag:{speaker:e.speaker,messageId:e.id,startMessageId:a.id}}}),await a.update({"flags.unopposeData.attackMessageId":e.id})}}static resolveFinalMessage(e){let t,a;if(e.flags.data.defenderMessage)for(let s of e.flags.data.defenderMessage){t=H.getMessageDude(e);let i=game.messages.get(s);a=H.getMessageDude(i),this.completeOpposedProcess(t,a,{blind:e.blind,whisper:e.whisper})}else{a=H.getMessageDude(e);let s=game.messages.get(e.flags.data.attackerMessage);t=H.getMessageDude(s),this.completeOpposedProcess(t,a,{blind:e.blind,whisper:e.whisper})}}static getMessageDude(e){let t={speaker:e.speaker,testResult:mergeObject(e.flags.data.postData,{source:e.flags.data.preData.source}),img:f.getSpeaker(e.speaker).img,messageId:e.id};return t.testResult.ammo&&t.testResult.source.effects.push(...t.testResult.ammo.effects),t}static async showDamage(e,t=!1){game.user.isGM?(!t||!e.flags.data.hideDamage)&&e.flags.data.postData.damageRoll&&(await e.update({content:e.content.replace(`data-hide-damage="${!t}"`,`data-hide-damage="${t}"`),"flags.data.hideDamage":t}),t||_DiceDSA5._addRollDiceSoNice(e.flags.data.preData,Roll.fromData(e.flags.data.postData.damageRoll),game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"))):game.socket.emit("system.dsa5",{type:"showDamage",payload:{id:e.id,hide:t}})}static async playAutomatedJBA2(e,t,a){if(f.moduleEnabled("autoanimations")){let s=f.getSpeaker(e.speaker).getActiveTokens()[0],i=f.getSpeaker(t.speaker).getActiveTokens()[0];if(!s||!s.actor||!i||!i.actor)return;let n=s.actor.items.get(e.testResult.source._id);if(n||(n=new C(e.testResult.source,{temporary:!0})),!n)return;n=n.toObject();let r=[i],o=a.winner=="attacker",c=o?r:[],m=e.testResult.successLevel>1&&o,d=e.testResult.successLevel<1&&!o,p=t.testResult.successLevel>1&&!o,g=t.testResult.successLevel<1&&o,h=[],y=[];m?y.push(game.i18n.localize("CriticalSuccess")):d?y.push(game.i18n.localize("CriticalFailure")):p?y.push(`${game.i18n.localize("CHAR.PARRY")} ${game.i18n.localize("CriticalSuccess")}`):g&&y.push(`${game.i18n.localize("CHAR.PARRY")} ${game.i18n.localize("CriticalFailure")}`),o||y.push(game.i18n.localize("CHAR.PARRY"));for(let v of y)h.push({name:`${n.name} (${v})`},{name:v});h.push(n);for(let v of h)if(await AutomatedAnimations.playAnimation(s,v,{targets:r,hitTargets:c,playOnMiss:!0}))break}}static async showSpellWithoutTarget(e){if(f.moduleEnabled("autoanimations")){let t=getProperty(e,"flags.data");if(!t||t.isOpposedTest)return;if((getProperty(t,"postData.result")||-1)>0){let s=f.getSpeaker(t.postData.speaker).getActiveTokens()[0];if(!s||!s.actor)return;let i=Array.from(game.user.targets),n=s.actor.items.get(t.preData.source._id);i.length||(i=[s]),AutomatedAnimations.playAnimation(s,n,{targets:i})}}}static async clearOpposed(e){game.user.isGM?await e.update({["flags.-=oppose"]:null}):game.socket.emit("system.dsa5",{type:"clearOpposed",payload:{actorId:e.id}})}static async _handleReaction(e){let t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(t);switch(game.messages.get(a.flags.unopposeData.attackMessageId).flags.data.preData.source.type){case"skill":rt.showDialog(a);break;default:Ce.showDialog(a)}}static async chatListeners(e){e.on("click",".unopposed-button",t=>{t.preventDefault(),this._handleReaction(t)})}static async hideReactionButton(e){if(e)if(game.user.isGM){let t=game.messages.get(e),a=$(t.content);a.find("button.unopposed-button").remove(),a=$("<div></div>").append(a),await t.update({content:a.html()})}else game.socket.emit("system.dsa5",{type:"hideQueryButton",payload:{id:e}})}static async completeOpposedProcess(e,t,a){await Be.postOpposed({attacker:e,defender:t,options:a});let s=await this.evaluateOpposedTest(e.testResult,t.testResult,a);return this.formatOpposedResult(s,e.speaker,t.speaker),this.rerenderMessagesWithModifiers(s,e,t),Hooks.call("finishOpposedTest",e,t,s,a),await this.finishOpposedTestHookAsync(e,t,s,a),this.playAutomatedJBA2(e,t,s),await this.renderOpposedResult(s,a),await this.hideReactionButton(a.startMessageId),s}static async finishOpposedTestHookAsync(e,t,a,s){}static async evaluateOpposedTest(e,t,a={}){let s={};if(s.other=[],a.additionalInfo&&s.other.push(a.additionalInfo),s.winner="attacker",["weapon","spell","liturgy","ceremony","ritual","combatskill"].includes(e.rollType)&&t.successLevel==null&&(t.successLevel=-5),e.rollType=="damage"&&(t.successLevel=-5,e.successLevel=1),t.successLevel!=null)switch(e.rollType){case"combatskill":case"talent":this._evaluateTalentOpposedRoll(e,t,s,a);break;case"ceremony":case"ritual":case"spell":case"liturgy":case"weapon":case"damage":this._evaluateWeaponOpposedRoll(e,t,s,a);break;default:ui.notifications.error("Can not oppose "+e.rollType),console.warn("Can not oppose "+e.rollType)}return s}static _evaluateWeaponOpposedRoll(e,t,a,s={}){if(e.successLevel>0&&t.successLevel<0){let i=this._calculateOpposedDamage(e,t,s);if(i.armorDamaged.damaged&&i.armorDamaged.ids.length){let c=i.armorDamaged.ids.join(";");a.other.push(`<div style="margin-top:10px" class="center"><button class="gearDamaged onlyTarget" data-uuid="${c}">${game.i18n.localize("WEAR.checkShort")}</button></div>`)}t.counterAttack&&(i.damage+=2,i.sum=i.damage-i.armor,i.tooltip=game.i18n.localize("LocalizedIDs.counterAttack")+" 2"),i.messages.length&&(i.tooltip||(i.tooltip=""),i.tooltip+=` ${i.messages.join("<br>")}`),a.winner="attacker";let n=[i.armorMod!=0?`${i.armorMod+" "+game.i18n.localize("Modifier")}`:"",i.armorMultiplier!=1?"*"+i.armorMultiplier+" "+game.i18n.localize("Modifier"):"",i.spellArmor!=0?`${i.spellArmor} ${game.i18n.localize("spellArmor")}`:"",i.liturgyArmor!=0?`${i.liturgyArmor} ${game.i18n.localize("liturgyArmor")}`:""].join(""),o=`<b>${game.combat?.isBrawling?game.i18n.localize("BRAWLING.temporary"):game.i18n.localize("damage")}</b>: <span${i.tooltip?` data-tooltip="${i.tooltip}"`:""}>${i.damage}</span><i class="lighticon fas fa-hand-fist" data-tooltip="Roll"></i> - <span data-tooltip="${n}">${i.armor}</span><i class="lighticon fa fa-shield-alt" data-tooltip="protection"></i> = ${i.sum}`;a.damage={description:o,value:i.sum,sp:i.damage}}else a.winner="defender"}static _calculateOpposedDamage(e,t,a={}){let s=f.getSpeaker(t.speaker),i=[],n=e.damage,r=game.i18n.localize("LocalizedIDs.immuneToCrit");e.doubleDamage&&s.items.find(R=>R.name==r&&R.type=="trait")&&(n=Math.floor(n/e.doubleDamage),i.push(r)),a.origin=e.source,a.damage=n;let o=_DSAActiveEffectConfig.applyRollTransformation(s,a,5).options.damage,{wornArmor:c,armor:m}=S.armorValue(s,a),d=[],p=0,g=e.armorPen||[];for(let R of g)/^\*/.test(R)?d.push(Number(R.replace("*",""))):p+=Number(R);let h=0,y=0;["spell","ritual"].includes(e.source.type)?h+=s.system.spellArmor||0:["liturgy","ceremony"].includes(e.source.type)&&(h+=s.system.liturgyArmor||0),m+=p;let v=d.reduce((R,D)=>R*D,1);m=Math.max(Math.round(m*v),0),m+=h+y;let P=W.armorGetsDamage(o,e),T=c.map(R=>R.uuid);return{damage:o,armor:m,armorDamaged:{damaged:P,ids:T},armorMod:p,spellArmor:h,liturgyArmor:y,armorMultiplier:v,messages:i,sum:o-m}}static _evaluateTalentOpposedRoll(e,t,a,s={}){e.successLevel>0&&e.successLevel>t.successLevel?a.winner="attacker":e.qualityStep>t.qualityStep||e.result>=0&&t.result<0?(a.winner="attacker",a.differenceSL=e.qualityStep-t.qualityStep):(a.winner="defender",a.differenceSL=t.qualityStep-e.qualityStep)}static formatOpposedResult(e,t,a){let s=e.differenceSL?"winsFP":"wins";return e.winner=="attacker"?(e.result=game.i18n.format("OPPOSED."+s,{winner:t.alias,loser:a.alias,SL:e.differenceSL}),e.img=t.img):e.winner=="defender"&&(e.result=game.i18n.format("OPPOSED."+s,{winner:a.alias,loser:t.alias,SL:e.differenceSL}),e.img=a.img),e.speakerAttack=t,e.speakerDefend=a,e}static rerenderMessagesWithModifiers(e,t,a){let s=game.messages.get(t.messageId);this.showDamage(s,e.winner!="attacker")}static async renderOpposedResult(e,t={}){e.hideData=game.settings.get("dsa5","hideOpposedDamage"),e.applyDamageInChat=game.settings.get("dsa5","applyDamageInChat"),e.isBrawling=game.combat?.isBrawling;let a=await renderTemplate("systems/dsa5/templates/chat/roll/opposed-result.html",e),s={user:game.user.id,content:a,"flags.opposeData":e,"flags.hideData":e.hideData,whisper:t.whisper,blind:t.blind};t.target&&(s["flags.startMessageId"]=t.startMessageId),await ChatMessage.create(s)}static async resolveUndefended(e,t=""){let a=e.flags.unopposeData,s=game.messages.get(a.attackMessageId),i={speaker:s.speaker,testResult:s.flags.data.postData,messageId:a.attackMessageId};i.testResult.source=s.flags.data.preData.source,i.testResult.ammo&&i.testResult.source.effects.push(...i.testResult.ammo.effects);let n=canvas.tokens.get(a.targetSpeaker.token),r={speaker:a.targetSpeaker,testResult:{actor:n.actor,speaker:{token:a.targetSpeaker.token}}};await this.clearOpposed(n.actor),await this.completeOpposedProcess(i,r,{target:!0,startMessageId:e.id,additionalInfo:t}),game.user.isGM?await s.update({"flags.data.unopposedStartMessage":e.id}):await game.socket.emit("system.dsa5",{type:"updateAttackMessage",payload:{messageId:s.id,startMessageId:e.id}})}};u(H,"OpposedDsa5");var qe=class extends Dialog{static async showDialog(e){let t=new qe({title:game.i18n.localize("WEAR.checkShort"),content:await this.getTemplate(e),buttons:{}});t.items=e,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t),this.close()})}static async getTemplate(e){let t=e.map(a=>({name:a.name,id:a.id,img:a.img}));return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{items:t,title:"WEAR.checkShort"})}callbackResult(e){W.breakingTest(this.items.find(t=>t.id==e.currentTarget.dataset.value))}};u(qe,"EquipmentDamageDialog");var U=class{static async showBotchCard(e,t={}){t.speaker={token:e.token,actor:e.actor,scene:e.scene},t.source=e.source;let a=b.systemTables.find(i=>i.name==e.table),s=await U.getRollTable(a.pack[game.i18n.lang],game.i18n.localize(`TABLENAMES.${e.table}`),e);for(let i of s){let n=t.speaker?await U.hasEffect(i):!1,r=f.replaceDies(f.replaceConditions(i.results[0].text)),o=`${game.i18n.localize("TABLENAMES."+e.table)}`,c=await renderTemplate("systems/dsa5/templates/tables/tableCard.html",{result:r,title:o,hasEffect:n}),m=await this.buildEffects(i,n);ChatMessage.create({user:game.user.id,content:c,whisper:t.whisper,blind:t.blind,flags:{data:{preData:{source:{effects:m},extra:{actor:{id:t.speaker.actor},speaker:t.speaker},situationalModifiers:[]},postData:{}},dsa5:{hasEffect:n,options:t}}})}}static async hasEffect(e){return getProperty(e.results[0],"flags.dsa5")||!1}static async buildEffects(e,t){let a=[];if(t&&t.resistEffect){let s=Array.isArray(t.resistEffect.fail)?t.resistEffect.fail:[t.resistEffect.fail];for(let i of s){let n=new J().effectDummy(i.description,t.resistEffect.changes||[],t.resistEffect.duration||{});i.systemEffect?mergeObject(n,{_id:"botchEffect",flags:{dsa5:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:`await actor.addCondition("${i.systemEffect}", ${i.level||1});`}}}):i.command&&mergeObject(n,{_id:"botchEffect",flags:{dsa5:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:i.command}}}),a.push(n)}}return a}static async getRollTable(e,t,a={}){let i=(await game.packs.get(e).getDocuments({name__in:[t]}))[0],n=await i.draw({displayChat:!1});return a.weaponless=="true"&&n.roll.total<7&&(n.roll.editRollAtIndex([{index:0,val:n.roll.total+5}]),n=await i.draw({displayChat:!1,roll:n.roll})),[n]}static async tableEnabledFor(e){let t=b.systemTables.find(a=>a.name==e);return t?game.settings.get(t.setting.module,t.setting.key):!1}static rollCritBotchButton(e,t,a){let s=game.i18n.localize(`TABLENAMES.${e}`),i=a.extra.speaker,n=a.source._id;return`, <a class="roll-button botch-roll" data-table="${e}" data-weaponless="${t}" data-source="${n}" data-token="${i.token}" data-actor="${i.actor}" data-scene="${i.scene}"><i class="fas fa-dice"></i>${s}</a>`}static async defaultBotch(){return", "+game.i18n.localize("selfDamage")+(await new Roll("1d6+2").evaluate({async:!0})).total}static defaultAttackCrit(e){let t=", "+game.i18n.localize("halfDefense");return e&&(t+=", "+game.i18n.format("doubleDamage",{x:2})),t}static defaultParryCrit(){return", "+game.i18n.localize("attackOfOpportunity")}};u(U,"DSATables");var G=class{static async payMoney(e,t,a=!1,s=!0){let i=G.canPay(e,t,a);return i.success&&await G._updateMoney(e,i.actorsMoney.money,i.actorsMoney.sum-i.money,s),!a&&i.msg!=""&&ChatMessage.create(f.chatDataSetup(`<p>${i.msg}</p>`,"roll")),i.success}static canPay(e,t,a){let s=this._getPaymoney(t),i={success:!1,msg:"",money:s};return s&&(i.actorsMoney=this._actorsMoney(e),i.actorsMoney.sum>=s?(i.msg=game.i18n.format("PAYMENT.pay",{actor:e.name,amount:G._moneyToString(s)}),i.success=!0):(i.msg=game.i18n.format("PAYMENT.cannotpay",{actor:e.name,amount:G._moneyToString(s)}),a&&ui.notifications.notify(i.msg))),i}static async getMoney(e,t,a=!1,s=!0){let i=this._getPaidmoney(t);if(i){let n=this._actorsMoney(e);await G._updateMoney(e,n.money,n.sum+i,s);let r=`<p>${game.i18n.format("PAYMENT.getPaid",{actor:e.name,amount:G._moneyToString(i)})}</p>`;return a||ChatMessage.create(f.chatDataSetup(r,"roll")),!0}}static async _updateMoney(e,t,a,s=!0){let i=G._moneyToCoins(a);for(let n of t)switch(n.name){case"Money-D":n.system.quantity.value=i.D;break;case"Money-S":n.system.quantity.value=i.S;break;case"Money-H":n.system.quantity.value=i.H;break;case"Money-K":n.system.quantity.value=i.K;break}await e.updateEmbeddedDocuments("Item",t,{render:s})}static createGetPaidChatMessage(e,t=void 0){let a=this._getPaidmoney(e);if(a){let s=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("PAYMENT.wage")}</b></p><p>${game.i18n.format("PAYMENT.getPaidSum",{amount:G._moneyToString(a)})}${s}</p><button class="payButton" data-pay="1" data-amount="${a}">${game.i18n.localize("PAYMENT.getPaidButton")}</button>`;ChatMessage.create(f.chatDataSetup(i,"roll"))}}static createPayChatMessage(e,t=void 0){let a=this._getPaymoney(e);if(a){let s=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("PAYMENT.bill")}</b></p>${game.i18n.format("PAYMENT.paySum",{amount:G._moneyToString(a)})}${s}</p><button class="payButton" data-pay="0" data-amount="${a}">${game.i18n.localize("PAYMENT.payButton")}</button>`;ChatMessage.create(f.chatDataSetup(i,"roll"))}}static _getPaidmoney(e){let t=this._parseMoneyString(e);if(!t){let a=`<p><b>${game.i18n.localize("PAYMENT.error")}</b></p><p><i>${game.i18n.localize("PAYMENT.getPaidexample")}</i></p>`;return ChatMessage.create(f.chatDataSetup(a,"roll")),!1}return t}static _getPaymoney(e){let t=this._parseMoneyString(e);if(!t){let a=`<p><b>${game.i18n.localize("PAYMENT.error")}</b></p><p><i>${game.i18n.localize("PAYMENT.payexample")}</i></p>`;return ChatMessage.create(f.chatDataSetup(a,"roll")),!1}return t}static _parseMoneyString(e){let t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return t?Number(t[0]):!1}static _actorsMoney(e){let t=duplicate(e.items.filter(a=>a.type=="money"));return{money:t,sum:t.reduce((a,s)=>a+Number(s.system.quantity.value)*Number(s.system.price.value),0)}}static async handlePayAction(e,t,a,s=void 0){if(game.user.isGM&&!s){ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors"));return}s?V.playMoneySound(!0):s=game.user.character;let i=!1;s&&t?i=await G.payMoney(s,a):s&&!t?i=await G.getMoney(s,a):ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors")),i&&e&&(e.fadeOut(),game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:{[`flags.dsa5.userHidden.${game.user.id}`]:!0}}}))}static _moneyToCoins(e){let t=Math.round(e*100),a=Math.floor(t/1e3),s=Math.floor((t-a*1e3)/100),i=Math.floor((t-a*1e3-s*100)/10);return{D:a,S:s,H:i,K:Math.round(t-a*1e3-s*100-i*10)}}static _moneyToString(e){let t=G._moneyToCoins(e),a=[];for(let[s,i]of Object.entries(t))i>0&&a.push(`<span class="nobr">${i} <span data-tooltip="Money-${s}" class="chatmoney money-${s}"></span></span>`);return a.join(", ")}static async chatListeners(e){e.on("click",".payButton",t=>{let a=$(t.currentTarget);G.handlePayAction(a,Number(a.attr("data-pay"))!=1,a.attr("data-amount")),V.playMoneySound()})}};u(G,"DSA5Payment");var we=class{constructor(){we.skills.length==0&&f.allSkills().then(e=>{we.skills=e.map(t=>({name:t.name,type:"skill"})).concat(Object.values(game.dsa5.config.characteristics).map(t=>({name:game.i18n.localize(t),type:"attribute"})).concat([{name:game.i18n.localize("regenerate"),type:"regeneration"},{name:game.i18n.localize("fallingDamage"),type:"fallingDamage"}]))}),this.filtering=!1,this.combatConstants={dodge:game.i18n.localize("dodge"),parryWeaponless:game.i18n.localize("parryWeaponless"),attackWeaponless:game.i18n.localize("attackWeaponless")}}get regex(){return new RegExp(`^/(${we.cmds.join(" |")})`)}async chatListeners(e){let t=this,a=e.find("#chat-message");e.on("keyup","#chat-message",async function(i){t._parseInput(i)}),e.on("click",".quick-item",async function(i){t._quickSelect($(i.currentTarget))}),a.on("keydown",function(i){t._navigateQuickFind(i)});let s=jQuery._data(a[0]).events.keydown;s.unshift(s.pop())}_parseInput(e){let t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(e.which==27)return this._closeQuickfind(e),!1;let a=this._getCmd(t),s=t.substring(1+a.length).toLowerCase().trim();this[`_filter${a}`](s,e),this.filtering=!0}else this._closeQuickfind(e)}_getCmd(e){return e.substring(1,3).toUpperCase().trim()}_completeCurrentEntry(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())+""}_closeQuickfind(e){this.filtering=!1,$(e.currentTarget).closest("#chat-form").find(".quickfind").remove()}_filterW(e,t){let a=game.users.contents.filter(s=>s.active&&s.name.toLowerCase().trim().indexOf(e)!=-1).map(s=>({name:s.name,type:"user"}));this._checkEmpty(a),this._setList(a,"W",t)}_filterAT(e,t){let{actor:a,tokenId:s}=we._getActor();if(a){let i=["meleeweapon","rangeweapon"],n=["meleeAttack","rangeAttack"],r=a.items.filter(o=>(i.includes(o.type)&&o.system.worn.value==!0||o.type=="trait"&&n.includes(o.system.traitType.value))&&o.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(o=>({name:o.name,type:"item"})).concat([{name:this.combatConstants.attackWeaponless,type:"item"}].filter(o=>o.name.toLowerCase().trim().indexOf(e)!=-1));this._checkEmpty(r),this._setList(r,"AT",t)}}_filterPA(e,t){let{actor:a,tokenId:s}=we._getActor();if(a){let i=["meleeweapon"],n=a.items.filter(r=>i.includes(r.type)&&r.name.toLowerCase().trim().indexOf(e)!=-1&&r.system.worn.value==!0).slice(0,5).map(r=>({name:r.name,type:"item"})).concat([{name:this.combatConstants.dodge,type:"item"},{name:this.combatConstants.parryWeaponless,type:"item"}].filter(r=>r.name.toLowerCase().trim().indexOf(e)!=-1));this._checkEmpty(n),this._setList(n,"PA",t)}}_filterSP(e,t){let{actor:a,tokenId:s}=we._getActor();if(a){let i=["spell","ritual"],n=a.items.filter(r=>i.includes(r.type)&&r.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(r=>({name:r.name,type:"item"}));this._checkEmpty(n),this._setList(n,"SP",t)}}_checkEmpty(e){e.length||e.push({name:game.i18n.localize("DSAError.noMatch"),type:"none"})}_filterLI(e,t){let{actor:a,tokenId:s}=we._getActor();if(a){let i=["liturgy","ceremony"],n=a.items.filter(r=>i.includes(r.type)&&r.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(r=>({name:r.name,type:"item"}));this._checkEmpty(n),this._setList(n,"LI",t)}}_getSkills(e,t=void 0){e=e.replace(/(-|\+)?\d+/g,"").trim();let a=we.skills.filter(s=>s.name.toLowerCase().trim().indexOf(e)!=-1&&(t==null||t==s.type)).slice(0,5);return this._checkEmpty(a),a}_filterCH(e,t){this._setList(this._getSkills(e),"CH",t)}_filterSK(e,t){this._setList(this._getSkills(e),"SK",t)}_filterRQ(e,t){this._setList(this._getSkills(e),"RQ",t)}_filterGC(e,t){this._setList(this._getSkills(e,"skill"),"GC",t)}_setList(e,t,a){let s=$(`<div class="quickfind dsalist"><ul>${e.map(r=>`<li data-type="${r.type}" data-category="${t}" class="quick-item">${r.name}</li>`).join("")}</ul></div>`);s.find(".quick-item:first").addClass("focus");let i=$(a.currentTarget).closest("#chat-form"),n=i.find(".quickfind");n.length?n.replaceWith(s):i.append(s)}_navigateQuickFind(e){if(this.filtering){let t=$(e.currentTarget).closest("#chat-form").find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if(t.attr("data-category")=="W")break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}return!0}static _getActor(){let e=ChatMessage.getSpeaker(),t;return e.token&&(t=game.actors.tokens[e.token]),t||(t=game.actors.get(e.actor)),t?{actor:t,tokenId:e.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}_quickSelect(e){let t=e.attr("data-category");switch(t){case"NM":case"GC":case"RQ":case"CH":this[`_quick${t}`](e);break;case"W":this._completeCurrentEntry(e);break;default:let{actor:a,tokenId:s}=we._getActor();a&&(this._resetChatAutoCompletion(e),this[`_quick${t}`](e,a,s))}}_quickW(e,t,a){}_quickCH(e){ee.check3D20(e),this._resetChatAutoCompletion(e)}_quickSK(e,t,a){switch(e.attr("data-type")){case"skill":let s=t.items.find(n=>n.name==e.text()&&n.type=="skill");s&&t.setupSkill(s,{},a).then(n=>{t.basicTest(n)});break;case"attribute":let i=Object.keys(game.dsa5.config.characteristics).find(n=>game.i18n.localize(game.dsa5.config.characteristics[n])==e.text());t.setupCharacteristic(i,{},a).then(n=>{t.basicTest(n)});break;case"regeneration":t.setupRegeneration("regenerate",{},a).then(n=>{t.basicTest(n)});break}}_resetChatAutoCompletion(e){let t=e.closest("#chat-form");t.find("#chat-message").val(""),t.find(".quickfind").remove()}_quickGC(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(e),B.showGCMessage(e.text(),t)}_quickRQ(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(e),B.showRQMessage(e.text(),t)}_quickPA(e,t,a){let s=e.text();if(this.combatConstants.dodge==s)t.setupDodge({},a).then(i=>{t.basicTest(i)});else if(this.combatConstants.parryWeaponless==s)t.setupWeaponless("parry",{},a).then(i=>{t.basicTest(i)});else{let i=["meleeweapon"],n=t.items.find(r=>i.includes(r.type)&&r.name==e.text());n&&t.setupWeapon(n,"parry",{},a).then(r=>{t.basicTest(r)})}}_quickAT(e,t,a){let s=e.text();if(this.combatConstants.attackWeaponless==s)t.setupWeaponless("attack",{},a).then(i=>{t.basicTest(i)});else{let i=["meleeweapon","rangeweapon"],n=["meleeAttack","rangeAttack"],r=t.items.find(o=>i.includes(o.type)&&o.name==e.text());r||(r=t.items.find(o=>o.type=="trait"&&o.name==e.text()&&n.includes(o.system.traitType.value))),r&&t.setupWeapon(r,"attack",{},a).then(o=>{t.basicTest(o)})}}_quickSP(e,t,a){let s=["ritual","spell"],i=t.items.find(n=>s.includes(n.type)&&n.name==e.text());i&&t.setupSpell(i,{},a).then(n=>{t.basicTest(n)})}_quickLI(e,t,a){let s=["liturgy","ceremony"],i=t.items.find(n=>s.includes(n.type)&&n.name==e.text());i&&t.setupSpell(i,{},a).then(n=>{t.basicTest(n)})}static async infoItemAsync(e){(await fromUuid(e)).postItem()}static bindRollCommands(e){e.on("click",".request-roll",s=>{let i=s.currentTarget.dataset;return B.showRQMessage(i.name,Number(i.modifier)||0,i.label),s.stopPropagation(),!1}),e.on("click",".postInfo",s=>{let i=fromUuidSync(s.currentTarget.dataset.uuid);return i&&(typeof i.postItem=="function"?i.postItem():this.infoItemAsync(s.currentTarget.dataset.uuid)),s.stopPropagation(),!1}),e.on("click",".postContentChat",async s=>{let i=$(s.currentTarget).closest(".postChatSection").find(".postChatContent").html();nt.getDialog(i)}),e.on("click",".request-GC",s=>(B.showGCMessage(s.currentTarget.dataset.name,Number(s.currentTarget.dataset.modifier)||0),s.stopPropagation(),!1)),e.on("click",".request-CH",s=>(ee.check3D20(void 0,s.currentTarget.dataset.name,{modifier:Number(s.currentTarget.dataset.modifier)||0}),s.stopPropagation(),!1)),e.on("click",".request-Pay",s=>{!game.user.isGM||G.createPayChatMessage(s.currentTarget.dataset.modifier)}),e.on("click",".request-GetPaid",s=>{!game.user.isGM||G.createGetPaidChatMessage(s.currentTarget.dataset.modifier)}),e.on("click",".request-AP",s=>{if(!game.user.isGM)return;let i=game.dsa5.apps.gameMasterMenu;i.getExp(i.selectedIDs(),s.currentTarget.dataset.modifier)});let t=u(s=>{s.stopPropagation();let i=s.currentTarget.dataset.type,n=s.currentTarget.dataset.uuid;!n||!i||s.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:i,uuid:n}))},"itemDragStart"),a=e.find(".show-item");a.click(async s=>{let i=s.currentTarget.dataset.uuid;(await fromUuid(i)).sheet.render(!0)}),a.attr("draggable",!0).on("dragstart",s=>t(s)),e.on("click",".actorEmbeddedAbility",async s=>{let n=(await fromUuid(s.currentTarget.dataset.actor)).items.get(s.currentTarget.dataset.id);n&&n.sheet.render(!0)})}},te=we;u(te,"DSA5ChatAutoCompletion"),F(te,"skills",[]),F(te,"cmds",["sk","at","pa","sp","li","rq","gc","w","ch"]);var B=class{static async requestGC(e,t,a,s=0){let{actor:i,tokenId:n}=te._getActor();if(!i)return;game.user.updateTokenTargets([]);let r={modifier:s,postFunction:{cummulative:a,functionName:"game.dsa5.apps.RequestRoll.autoEditGroupCheckRoll"}};switch(e){case"attribute":break;default:let o=i.items.find(c=>c.name==t&&c.type==e);i.setupSkill(o,r,n).then(async c=>{let m=await i.basicTest(c);await B.editGroupCheckRoll(a,m,t,e)})}}static async autoEditGroupCheckRoll(e,t,a){await B.editGroupCheckRoll(e.cummulative,t,a.name,a.type)}static async editGroupCheckRoll(e,t,a,s){let i=await game.messages.get(e),n=i.flags,o=t.result.successLevel>1?2:1;n.botched=n.botched||t.result.successLevel<-1;let c=f.getSpeaker(t.result.speaker),m={messageId:t.result.messageId,actor:c.name,qs:(t.result.qualityStep||0)*o,success:t.result.successLevel,target:a,type:s},d=n.results.findIndex(p=>p.messageId==m.messageId);d>=0?n.results[d]=m:n.results.push(m),B.rerenderGC(i,n)}static async requestRoll(e,t,a=0){let{actor:s,tokenId:i}=te._getActor();if(s){game.user.updateTokenTargets([]);let n={modifier:a};switch(e){case"attribute":let r=Object.keys(game.dsa5.config.characteristics).find(c=>game.i18n.localize(game.dsa5.config.characteristics[c])==t);s.setupCharacteristic(r,n,i).then(c=>{s.basicTest(c)});break;case"regeneration":s.setupRegeneration("regenerate",n,i).then(c=>{s.basicTest(c)});break;case"fallingDamage":s.setupFallingDamage(n,i);break;default:let o=s.items.find(c=>c.name==t&&c.type==e);s.setupSkill(o,n,i).then(c=>{s.basicTest(c)})}}}static async rerenderGC(e,t){if(game.user.isGM){let a=0;t.qs=t.results.reduce((i,n)=>(a+=n.success<0?1:0,n.success>1&&(a=0),i+n.qs),0),t.failed=a;for(let i of t.rollOptions)i.calculatedModifier=i.modifier-a;t.openRolls=t.maxRolls-t.results.length,t.doneRolls=t.results.length;let s=await renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",t);e.update({content:s,flags:t})}else game.socket.emit("system.dsa5",{type:"updateGroupCheck",payload:{messageId:e.id,data:t}});$("#chat-log").find(`[data-message-id="${e.id}"`).appendTo("#chat-log")}static showRQMessage(e,t=0,a=void 0){let s=t<0?` ${t}`:t>0?` +${t}`:"",i=te.skills.find(r=>r.name==e).type,n=game.i18n.format("CHATNOTIFICATION.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${i}" data-modifier="${t}" data-name="${e}"><i class="fas fa-dice"></i> ${a||e}${s}</a>`});ChatMessage.create(f.chatDataSetup(n))}static async showGCMessage(e,t=0,a={}){let s=te.skills.find(o=>o.name==e).type,i={results:[],qs:0,failed:0,modifier:t,name:game.user.name,maxRolls:7,openRolls:7,doneRolls:0,targetQs:10,rollOptions:[{type:s,modifier:t,calculatedModifier:t,target:e}]};mergeObject(i,a);let n=await renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",i),r=f.chatDataSetup(n);r.flags=i,ChatMessage.create(r)}static async addSkillToGC(e){let t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=await renderTemplate("systems/dsa5/templates/dialog/addgroupcheckskill.html",{skills:te.skills.filter(i=>i.type=="skill").sort((i,n)=>i.name.localeCompare(n.name))}),s={title:game.i18n.localize("HELP.groupcheck"),content:a,buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async i=>{let n=game.messages.get(t),r=n.flags;r.rollOptions.push({type:"skill",modifier:i.find('[name="modifier"]').val(),target:i.find('[name="skill"]').val()}),B.rerenderGC(n,r)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new Q(s).render(!0)}static async removeGCEntry(e){let t=$(e.currentTarget),a=Number(e.currentTarget.dataset.index),s=game.messages.get(t.parents(".message").attr("data-message-id")),i=s.flags;i.results.splice(a,1),B.rerenderGC(s,i)}static removeSkillFromGC(e){let t=$(e.currentTarget),a=game.messages.get(t.parents(".message").attr("data-message-id")),s=a.flags;s.rollOptions=s.rollOptions.filter(i=>!(i.type==e.currentTarget.dataset.type&&i.target==e.currentTarget.dataset.name)),s.results=s.results.filter(i=>!(i.type==e.currentTarget.dataset.type&&i.target==e.currentTarget.dataset.name)),B.rerenderGC(a,s)}static async editGC(e){let t=$(e.currentTarget),a=Number(e.currentTarget.dataset.index),s=game.messages.get(t.parents(".message").attr("data-message-id")),i=s.flags;if(a)i.results[a].qs=Number(t.val());else if(e.currentTarget.dataset.name){let n=i.rollOptions.find(r=>r.target==e.currentTarget.dataset.name&&e.currentTarget.dataset.type==r.type);n[e.currentTarget.dataset.field]=Number(t.val())}else i[e.currentTarget.dataset.field]=Number(t.val());B.rerenderGC(s,i)}static async updateInformationRoll(e,t,a){let s=[],i=await fromUuid(e.uuid),n=t.result.qualityStep||0;for(let r=1;r<=n;r++){let o=`qs${r}`;i.system[o]&&s.push(i.system[o])}if(t.result.successLevel>1&&i.system.crit?s.push(i.system.crit):t.result.successLevel<-1&&i.system.botch?s.push(i.system.botch):i.system.fail&&!n&&s.push(i.system.fail),s.length>0){await Promise.all(s.map(async o=>await TextEditor.enrichHTML(o,{async:!0}))),s.unshift(`<p><b>${i.name}</b></p>`);let r=f.chatDataSetup(s.join(""));e.recipients.length&&(r.whisper=e.recipients),ChatMessage.create(r)}}static async informationRequestRoll(e){let t=e.currentTarget.dataset.mod,a=e.currentTarget.dataset.uuid,{actor:s,tokenId:i}=te._getActor();if(!s)return;let n=game.settings.get("dsa5","informationDistribution"),r=[];n==1?(r=game.users.filter(m=>m.isGM).map(m=>m.id),r.push(game.user.id)):n==2&&(r=game.users.filter(m=>m.isGM).map(m=>m.id));let o={modifier:t,postFunction:{functionName:"game.dsa5.apps.RequestRoll.updateInformationRoll",uuid:a,recipients:r}},c=s.items.find(m=>m.name==e.currentTarget.dataset.skill&&m.type=="skill");s.setupSkill(c,o,i).then(async m=>{m.testData.opposable=!1;let d=await s.basicTest(m);this.updateInformationRoll(o.postFunction,d)})}static chatListeners(e){e.on("change",".editGC",t=>B.editGC(t)),e.on("click",".request-roll",t=>{let a=t.currentTarget.dataset;B.requestRoll(a.type,a.name,Number(a.modifier)||0)}),e.on("click",".request-gc",t=>{let a=t.currentTarget.dataset;B.requestGC(a.type,a.name,$(t.currentTarget).parents(".message").attr("data-message-id"),Number(a.modifier)||0)}),e.on("click",".removeGC",t=>B.removeGCEntry(t)),e.on("click",".removeSkillFromGC",t=>B.removeSkillFromGC(t)),e.on("click",".addSkillToGC",t=>B.addSkillToGC(t)),e.on("click",".informationRequestRoll",t=>B.informationRequestRoll(t))}};u(B,"RequestRoll");var qt,Wt,fe,ot=class extends MeasuredTemplate{constructor(){super(...arguments);Qt(this,qt,void 0);Qt(this,Wt,0);Qt(this,fe,void 0)}static async placeTemplateFromChat(t){let a=$(t.currentTarget).parents(".message").attr("data-message-id"),s=game.messages.get(a),i=s.flags.data.preData.source,n=s.flags.data.postData,r=this.fromItem(i,n.successLevel);r&&r.drawPreview()}static fromItem(t,a){let s=t.system.target||{},i=game.dsa5.config.areaTargetTypes[s.type];if(!i||!s.value)return null;let n=Number(Roll.safeEval(`${s.value}`.replace(/(qs|ql)/gi,a)))||1,r={t:i,user:game.user.id,distance:n,direction:0,x:0,y:0,fillColor:game.user.color,flags:{dsa5:{origin:t.uuid}}};switch(i){case"cone":r.angle=Number(s.angle)||CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":r.distance=Math.hypot(n,n),r.width=n,r.direction=45;break;case"ray":r.width=s.width&&Number(Roll.safeEval(`${s.width}`.replace(/(qs|ql)/gi,a)))||canvas.dimensions.distance;break}let o=CONFIG.MeasuredTemplate.documentClass,c=new o(r,{parent:canvas.scene}),m=new this(c);return m.item=t,m.actorSheet=t.actor?.sheet||null,m}drawPreview(){let t=canvas.activeLayer;return this.draw(),this.layer.activate(),this.layer.preview.addChild(this),this.activatePreviewListeners(t)}activatePreviewListeners(t){return new Promise((a,s)=>{Zt(this,qt,t),Zt(this,fe,{cancel:this._onCancelPlacement.bind(this),confirm:this._onConfirmPlacement.bind(this),move:this._onMovePlacement.bind(this),resolve:a,reject:s,rotate:this._onRotatePlacement.bind(this)}),canvas.stage.on("mousemove",ke(this,fe).move),canvas.stage.on("mousedown",ke(this,fe).confirm),canvas.app.view.oncontextmenu=ke(this,fe).cancel,canvas.app.view.onwheel=ke(this,fe).rotate})}async _finishPlacement(t){this.layer._onDragLeftCancel(t),canvas.stage.off("mousemove",ke(this,fe).move),canvas.stage.off("mousedown",ke(this,fe).confirm),canvas.app.view.oncontextmenu=null,canvas.app.view.onwheel=null,ke(this,qt).activate(),await this.actorSheet?.maximize()}_onMovePlacement(t){t.stopPropagation();let a=Date.now();if(a-ke(this,Wt)<=20)return;let s=t.data.getLocalPosition(this.layer),i=canvas.grid.getSnappedPosition(s.x,s.y,2);this.document.updateSource({x:i.x,y:i.y}),this.refresh(),Zt(this,Wt,a)}_onRotatePlacement(t){t.ctrlKey&&t.preventDefault(),t.stopPropagation();let a=canvas.grid.type>CONST.GRID_TYPES.SQUARE?30:15,s=t.shiftKey?a:5,i={direction:this.document.direction+s*Math.sign(t.deltaY)};this.document.updateSource(i),this.refresh()}async _onConfirmPlacement(t){await this._finishPlacement(t);let a=canvas.grid.getSnappedPosition(this.document.x,this.document.y,2);this.document.updateSource(a),ke(this,fe).resolve(canvas.scene.createEmbeddedDocuments("MeasuredTemplate",[this.document.toObject()]))}async _onCancelPlacement(t){await this._finishPlacement(t),ke(this,fe).reject()}};u(ot,"MeasuredTemplateDSA"),qt=new WeakMap,Wt=new WeakMap,fe=new WeakMap;var We=class{static async applyEffect(e,t){let a=game.messages.get(e),s=getProperty(a,"flags.dsa5.hasEffect"),i=getProperty(a,"flags.dsa5.options")||{};if(s){let n=["damageModifier","gearDamaged","gearLost","resistEffect","malus","selfDamage","nextAction"],r=[],o;if(t=="self"){let m=f.getSpeaker(i.speaker);r.push(m),o=i.source?m.items.get(i.source):void 0}else r=Array.from(game.user.targets).map(m=>m.actor);for(let m of n){let d=getProperty(s,m);d&&(await We[m](d,t,r,o,e,a)||console.warn(`Table effect for <${m} not working yet`,d,t,r,o))}let c=game.i18n.format("ActiveEffects.appliedEffect",{source:game.i18n.localize("table"),target:r.map(m=>m.name).join(", ")});await a.update({content:a.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${c}"></i>`)})}}static async damageModifier(e,t,a,s){}static async nextAction(e,t,a,s){}static async opportunityAttack(e,t,a,s){}static async gearDamaged(e,t,a,s){if(s&&["meleeweapon","rangeweapon"].includes(s.type)){let i=getProperty(s,"system.effect.attributes")||"";return new RegExp(`(${M.magical}|${M.clerical})`,"i").test(i)?await s.update({"system.worn.value":!1}):await W.absoluteDamageLevelToItem(s,e),!0}}static async gearLost(e,t,a,s){if(s&&["meleeweapon","rangeweapon"].includes(s.type)){if(await s.update({"system.worn.value":!1}),e.distance){let i=await new Roll(e.distance).evaluate({async:!0}),n=await i.render(),r=game.i18n.format("WEAPON.dropped",{distance:i.total});ChatMessage.create(f.chatDataSetup(`<p>${r}</p>${n}`))}return!0}}static async resistEffect(e,t,a,s,i){for(let n of a){let r=[{skill:e.roll,mod:e.modifier||0,effect:{_id:"botchEffect",name:e.fail.description},target:n,token:n.token?n.token.id:void 0}];_DSAActiveEffectConfig.createResistRollMessage(r,i,t)}return!0}static evaluateTargetArg(e,t){let a=t,s=!0;if(e.target=="victim"){let i=Array.from(game.user.targets).map(n=>n.actor);i.length?a=i:(s=!1,ui.notifications.warn("DSAError.noVictim"))}return{hasTargets:s,finalTargets:a}}static async malus(e,t,a,s){let{hasTargets:i,finalTargets:n}=this.evaluateTargetArg(e,a);for(let r of e){let o=!i&&r.noTarget,c=o?r.noTarget.systemEffect:r.systemEffect,m=o?r.noTarget.level:r.level||1,d=o?r.noTarget.changes:r.changes,p=o?r.noTarget.duration:r.duration;if(c){let g=CONFIG.statusEffects.find(y=>y.id==c);if(!d){d=duplicate(g.changes);let y=d.find(v=>v.key==`system.condition.${c}`);y&&(y.value=m)}let h;if(d){let y=game.i18n.localize(`CONDITION.${c}`)+" - "+game.i18n.localize("botchCritEffect");h=new J().effectDummy(y,d,p||{}),h.icon=g.icon}else h=c;for(let y of n)await y.addCondition(h);return!0}else if(d){let g=new J().effectDummy(game.i18n.localize("botchCritEffect"),d||[],p||{});mergeObject(g,{flags:{dsa5:{hideOnToken:!1,hidePlayers:!1}}});for(let h of n)await h.addCondition(g);return!0}}}static async selfAttack(e,t,a,s){let{hasTargets:i,finalTargets:n}=this.evaluateTargetArg(e,a)}static async selfDamage(e,t,a,s){let{hasTargets:i,finalTargets:n}=this.evaluateTargetArg(e,a);if(s){let r=f.toObjectIfPossible(s);for(let o of n){let c=o.items.filter(g=>g.type=="combatskill").map(g=>S._calculateCombatSkillValues(g.toObject(),o.system)),m;e.damage?m={damagedie:e.damage,damageAdd:""}:s.type=="rangeweapon"?m=S._prepareRangeWeapon(r,[],c,o):s.type=="meleeweapon"?m=S._prepareMeleeWeapon(r,c,o):m=s.system.traitType.value=="meleeAttack"?S._prepareRangeTrait(r):S._prepareMeleetrait(r);let d=(m.damagedie+m.damageAdd).replace(/wWD/g,"d"),p=await new Roll(`(${d})*${e.multiplier||1}${e.modifier||""}`).evaluate({async:!0});await o.applyDamage(Math.round(p.total)),ChatMessage.create(f.chatDataSetup(await p.render()))}return!0}else{for(let r of n){let o=await new Roll("1d6").evaluate({async:!0});await r.applyDamage(Math.round(o.total)),ChatMessage.create(f.chatDataSetup(await o.render()))}return!0}}};u(We,"TableEffects");var vt=u(async(l,e,t=1)=>{let a=game.messages.get(l.attr("data-message-id")),s=a.flags.opposeData,i=s?.speakerDefend,n=f.getSpeaker(i);if(!n.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));await n.applyDamage(s.damage[e]*t);let r={"flags.data.damageApplied":!0,content:a.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${game.i18n.localize("damageApplied")}"></i>`)};game.user.isGM?await a.update(r):game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:l.attr("data-message-id"),updateData:r}})},"applyDamage");function Ci(){let l=u((O,I)=>f.fateAvailable(O,I),"fateAvailable"),e=u(function(O,I="damage.value"){let k=game.messages.get(O.attr("data-message-id")).flags.opposeData,N=k?f.getSpeaker(k.speakerDefend)?.isOwner:!1;return((game.user.isGM||N)&&O.find(".opposed-card").length||O.find(".dice-roll").length)&&(getProperty(k,I)||0)>0},"canHurt"),t=u(function(O){return e(O,"damage.sp")},"canHurtSP"),a=u(function(O){let I=game.messages.get(O.attr("data-message-id"));return I.speaker.actor&&I.flags.data&&(game.actors.get(I.speaker.actor).isOwner||game.user.isGM)?["liturgy","ceremony","spell","ritual","magicalsign"].includes(I.flags.data.preData.source.type)||getProperty(I.flags.data.preData,"calculatedSpellModifiers.costsMana"):!1},"canCostMana"),s=u(function(O){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){let I=game.messages.get(O.attr("data-message-id"));return"hideData"in I.flags&&I.flags.hideData}return!1},"canUnhideData"),i=u(function(O){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){let I=game.messages.get(O.attr("data-message-id"));return"hideData"in I.flags&&!I.flags.hideData}return!1},"canHideData"),n=u(function(O,I=!1){let k=game.messages.get(O.attr("data-message-id"));if(k.speaker.actor&&k.flags.data&&k.flags.data.postData.successLevel>-2){let N=game.actors.get(k.speaker.actor);if(N.isOwner&&l(N,I)){let X=k.flags.data.preData.source.type,ye=k.flags.data.preData.mode||"";["skill","spell","liturgy","ritual","ceremony"].includes(X)&&(X="char");let be=game.i18n.localize(`SCHIPSKILLS.${X}${ye}`);return!k.flags.data.fateImproved&&N.items.getName(be)}}return!1},"canImproveRoll"),r=u(function(O){return n(O,!0)},"canImproveRollGroup"),o=u(function(O,I=!1){let k=game.messages.get(O.attr("data-message-id"));if(k.speaker.actor&&k.flags.data){let N=game.actors.get(k.speaker.actor);if(N.isOwner&&l(N,I)&&!k.flags.data.fatePointAddQSUsed)return k.flags.data.postData.successLevel>0&&k.flags.data.postData.qualityStep!=null}return!1},"canIncreaseQS"),c=u(function(O){return o(O,!0)},"canIncreaseQSGroup"),m=u(function(O){let I=game.messages.get(O.attr("data-message-id"));if(I.speaker.actor&&I.flags.data){let k=game.actors.get(I.speaker.actor);if(k.isOwner)return k.items.find(N=>N.name==`${game.i18n.localize("LocalizedIDs.aptitude")} (${I.flags.data.preData.source.name})`)!=null&&!I.flags.data.talentedRerollUsed}return!1},"isTalented"),d=u(function(O,I=!1){let k=game.messages.get(O.attr("data-message-id"));if(k.speaker.actor&&k.flags.data){let N=game.actors.get(k.speaker.actor);if(N.isOwner&&l(N,I))return k.flags.data.postData.damageRoll!=null&&!k.flags.data.fatePointDamageRerollUsed}return!1},"canRerollDamage"),p=u(function(O){return d(O,!0)},"canRerollDamageGroup"),g=u(function(O,I=!1){let k=game.messages.get(O.attr("data-message-id"));if(k.speaker.actor&&k.flags.data){let N=game.actors.get(k.speaker.actor);if(N.isOwner&&l(N,I))return!k.flags.data.fatePointRerollUsed&&k.flags.data.postData.rollType!="regenerate"}return!1},"canReroll"),h=u(function(O){return g(O,!0)},"canRerollGroup"),y=u(function(O){let I=game.messages.get(O.attr("data-message-id"));return I.speaker.actor&&I.flags.data&&game.actors.get(I.speaker.actor).isOwner&&["LeP","KaP","AsP"].some(N=>getProperty(I.flags,`data.postData.${N}`)!=null)?!I.flags.data.healApplied:!1},"canHeal"),v=u(function(O){if(game.user.isGM){let I=game.messages.get(O.attr("data-message-id"));if("hideData"in I.flags){let k=!I.flags.hideData,N=$(I.content);N.find(".hideAnchor")[k?"addClass":"removeClass"]("hideData"),N=$("<div></div>").append(N),I.update({content:N.html(),"flags.hideData":k})}}},"showHideData"),P=u(O=>{let I=game.messages.get(O.data("messageId"));return!I||!canvas.tokens?!1:I.isRoll&&I.isContentVisible&&canvas.tokens.controlled.length&&O.find(".dice-roll").length},"canApplyDefaultRolls"),T=u((O,I,k=0)=>{let N=game.messages.get(O.attr("data-message-id"));game.actors.get(N.speaker.actor).useFateOnRoll(N,I,k)},"useFate"),R=u((O,I,k=1)=>{let X=game.messages.get(O.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map(ye=>{let be=ye.actor,at=Math.round((I!="sp"?X.total-S.armorValue(be).armor:X.total)*k);return be.applyDamage(Math.max(0,at))}))},"applyChatCardDamage"),D=u(async O=>{let I=game.messages.get(O.attr("data-message-id")),k=I.flags.data,N=f.getSpeaker(I.speaker);if(!N.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));let X=k.preData.calculatedSpellModifiers.maintainCost.trim(),ye=["ritual","spell"].includes(k.preData.source.type)||getProperty(k.preData.calculatedSpellModifiers,"costsMana")?"AsP":"KaP",be=await N.applyMana(k.preData.calculatedSpellModifiers.finalcost,ye);if(X&&X!=0&&be&&k.postData.successLevel>0){let at=k.preData.source.name;try{let _t=X.match(/^\d{1,3}/)[0],pt=X.replace(/^\d{1,3}/,"").match(/\d{1,3}/);pt=pt&&Number(pt[0])||1;let st={name:`${at} (${game.i18n.localize("maintainCost")})`,icon:"icons/svg/daze.svg",flags:{dsa5:{description:X,maintain:_t,payType:ye}},changes:[],duration:{}},w=[{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.days"),"gi"),seconds:3600*24},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.seconds"),"gi"),seconds:1},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.weeks"),"gi"),seconds:3600*24*7},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.months"),"gi"),seconds:3600*24*30},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.years"),"gi"),seconds:3600*24*350}];for(let q of w)if(q.regEx.test(X)){let Pe=Number(pt)*q.seconds;st.duration.seconds=Pe,st.duration.rounds=st.duration.seconds/5;break}await N.addCondition(st)}catch{console.error(`Could not parse duration '${X}' of '${at}'`)}}await I.update({"flags.data.manaApplied":!0,content:I.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')})},"payMana"),z=u(()=>game.i18n.localize(game.combat?.isBrawling?"CHATCONTEXT.ApplyDamagePP":"CHATCONTEXT.ApplyDamage"),"applyDamageLabel");Hooks.on("getChatLogEntryContext",(O,I)=>{I.push({name:game.i18n.localize("CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:i,callback:k=>{v(k)}},{name:game.i18n.localize("CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:s,callback:k=>{v(k)}},{name:game.i18n.localize("regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:y,callback:async k=>{let N=await game.messages.get(k.attr("data-message-id")),X=f.getSpeaker(N.speaker);if(!X.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));await N.update({"flags.data.healApplied":!0,content:N.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')}),await X.applyRegeneration(N.flags.data.postData.LeP,N.flags.data.postData.AsP,N.flags.data.postData.KaP)}},{name:game.i18n.localize("CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:a,callback:async k=>{D(k)}},{name:z(),icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:k=>{vt(k,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:k=>{vt(k,"sp")}},{name:z(),icon:'<i class="fas fa-user-minus"></i>',condition:P,callback:k=>{R(k,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:P,callback:k=>{R(k,"sp")}},{name:game.i18n.localize("CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:g,callback:k=>{T(k,"reroll")}},{name:game.i18n.localize("CHATCONTEXT.RerollGroup"),icon:'<i class="fas fa-dice"></i>',condition:h,callback:k=>{T(k,"reroll",1)}},{name:game.i18n.localize("CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:m,callback:k=>{T(k,"isTalented")}},{name:game.i18n.localize("CHATCONTEXT.AddQS"),icon:'<i class="fas fa-plus-square"></i>',condition:o,callback:k=>{T(k,"addQS")}},{name:game.i18n.localize("CHATCONTEXT.AddQSGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:c,callback:k=>{T(k,"addQS",1)}},{name:game.i18n.localize("CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:d,callback:k=>{T(k,"rerollDamage")}},{name:game.i18n.localize("CHATCONTEXT.rerollDamageGroup"),icon:'<i class="fas fa-dice"></i>',condition:p,callback:k=>{T(k,"rerollDamage",1)}},{name:game.i18n.localize("CHATCONTEXT.improveFate"),icon:'<i class="fas fa-plus-square"></i>',condition:n,callback:k=>{T(k,"Improve")}},{name:game.i18n.localize("CHATCONTEXT.improveFateGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:r,callback:k=>{T(k,"Improve",1)}}),game.settings.get("dsa5","doubleDamageOptions")&&I.push({name:z()+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:k=>{vt(k,"value",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:k=>{vt(k,"sp",2)}},{name:z()+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:P,callback:k=>{R(k,"value",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:P,callback:k=>{R(k,"sp",2)}})})}u(Ci,"chatContext");var _DiceDSA5=class{static async rollTest(l){let e;switch(l.source.type){case"ceremony":case"ritual":case"liturgy":case"spell":e=await this.rollSpell(l);break;case"skill":e=await this.rollTalent(l);break;case"combatskill":e=await this.rollCombatskill(l);break;case"trait":l.mode=="parry"&&await this.updateDefenseCount(l),e=l.mode=="damage"?await this.rollDamage(l):await this.rollCombatTrait(l);break;case"regenerate":e=await this.rollRegeneration(l);break;case"meleeweapon":case"rangeweapon":l.mode=="parry"&&await this.updateDefenseCount(l),e=l.mode=="damage"?await this.rollDamage(l):await this.rollWeapon(l);break;case"dodge":await this.updateDefenseCount(l),e=await this.rollStatus(l);break;case"poison":case"disease":e=await this.rollItem(l);break;case"fallingDamage":e=await this.rollFallingDamage(l);break;default:e=await this.rollAttribute(l)}return mergeObject(e,deepClone(l.extra)),e}static async rollDices(l,e){if(!l.roll){let t=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration,a;switch(l.source.type){case"liturgy":case"spell":case"ceremony":case"ritual":case"skill":a=await new Roll("1d20+1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(l.source.system.characteristic1.value)),mergeObject(a.dice[1].options,t(l.source.system.characteristic2.value)),mergeObject(a.dice[2].options,t(l.source.system.characteristic3.value));break;case"regenerate":let s=[];l.regenerateLeP&&s.push([game.settings.get("dsa5","lessRegeneration")?"1d3":"1d6"]),l.extra.actor.isMage&&l.regenerateAsP&&s.push("1d6"),l.extra.actor.isPriest&&l.regenerateKaP&&s.push("1d6"),a=await new Roll(s.join("+")).evaluate({async:!0}),l.regenerateLeP&&mergeObject(a.dice[0].options,t("mu")),l.extra.actor.isMage&&l.regenerateAsP&&mergeObject(a.dice[s.length-1].options,t("ge")),l.extra.actor.isPriest&&l.regenerateKaP&&mergeObject(a.dice[s.length-1].options,t("in")),l.extra.actor.isMage&&l.regenerateAsP&&l.extra.actor.isPriest&&l.regenerateKaP&&mergeObject(a.dice[s.length-2].options,t("ge"));break;case"meleeweapon":case"rangeweapon":case"weaponless":case"combatskill":case"trait":if(l.mode=="damage"){let o=await this.damageFormula(l);a=await new Roll(o).evaluate({async:!0});for(let c=0;c<a.dice.length;c++)mergeObject(a.dice[c].options,t("damage"))}else a=await new Roll("1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(l.mode));break;case"dodge":a=await new Roll("1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t("dodge"));break;case"poison":case"disease":let i=t("in");a=await new Roll("1d20+1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,i),mergeObject(a.dice[1].options,i),mergeObject(a.dice[2].options,i);break;case"fallingDamage":let n=await this._situationalModifiers(l),r=`${l.fallingHeight}d6+${n}-${l.extra.options.availableQs||0}`;a=await new Roll(r).evaluate({async:!0});break;default:a=await new Roll("1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(l.source.system.attr))}a=await _DiceDSA5.manualRolls(a,l.source.type,l.extra.options),await this.showDiceSoNice(a,e.rollMode),l.roll=a,l.rollMode=e.rollMode}return l}static async setupDialog({dialogOptions:l,testData:e,cardOptions:t}){let a=await game.settings.get("core","rollMode"),s="challenging";typeof e.source.toObject=="function"&&(e.source=e.source.toObject(!1)),mergeObject(e,{testDifficulty:s}),mergeObject(l.data,{testDifficulty:s,testModifier:l.data.modifier||0});let i=l.data.situationalModifiers||(e.extra.actor?E.getRollModifiers(e.extra.actor,e.source):[]);e.extra.options.moreModifiers!=null&&i.push(...e.extra.options.moreModifiers);let n=[];if(game.user.targets.forEach(r=>{r.actor&&n.push({name:r.actor.name,id:r.id,img:r.actor.img})}),mergeObject(l.data,{hasSituationalModifiers:i.length>0,situationalModifiers:i,rollMode:l.data.rollMode||a,rollModes:CONFIG.Dice.rollModes,defenseCount:await this.getDefenseCount(e),targets:n}),mergeObject(t,{user:game.user.id}),e.extra.options.bypass)return t.rollMode=e.extra.options.rollMode||a,e.situationalModifiers||(e.situationalModifiers=[]),{testData:e,cardOptions:t};{let r=Q.getDialogForItem(e,l.data),o=await renderTemplate(l.template,l.data);return new Promise((c,m)=>{new r({title:l.title,content:o,buttons:r.getRollButtons(e,l,c,m),default:"rollButton"}).recallSettings(e.extra.speaker,e.source,e.mode,l.data).render(!0)})}}static async getDefenseCount(l){return game.combat?await game.combat.getDefenseCount(l.extra.speaker):0}static async _rollConfirm(){return await new Roll("1d20").evaluate({async:!0})}static async _rollSingleD20(l,e,t,a,s,i="",n=1){let r="",o=[];e+=a,e=Math.round(e*n);let c=e-l.terms[0].results[0].result,m=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration(t);o.push({char:t,res:l.terms[0].results[0].result,suc:c>=0,tar:e});let d=c>=0?1:-1,p=20,g=1;if(s.source.type=="meleeweapon"&&(p=Math.min(s.extra.actor.system.meleeStats.botch,s.source.system.botch),g=Math.max(s.extra.actor.system.meleeStats.crit,s.source.system.crit)),s.source.type=="rangeweapon"&&(p=Math.min(s.extra.actor.system.rangeStats.botch,s.source.system.botch),g=Math.max(s.extra.actor.system.rangeStats.crit,s.source.system.crit)),/(\(|,)( )?i\)$/.test(s.source.name)&&(L.hasAbility(s.extra.actor,game.i18n.localize("LocalizedIDs.improvisedWeaponMaster"))||(p=Math.min(19,p)),this._appendSituationalModifiers(s,`${game.i18n.localize("CHAR.ATTACK")} - ${game.i18n.localize("WEAPON.improvised")}`,2,"defenseMalus")),s.situationalModifiers.find(h=>h.name==game.i18n.localize("opportunityAttack")&&h.value!=0)&&(p=50,g=-50),l.terms[0].results.filter(h=>h.result<=g).length==1)if(r=game.i18n.localize("CriticalSuccess"),game.settings.get("dsa5","noConfirmationRoll"))d=3;else{let h=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"confirmationRoll",s.extra.options),y=e-h.terms[0].results[0].result;if(x.hasVantage(s.extra.actor,`${game.i18n.localize("LocalizedIDs.weaponAptitude")} (${i})`)&&!(y>=0)){let v=h.terms[0].results[0].result;h=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"LocalizedIDs.weaponAptitude",s.extra.options),y=e-h.terms[0].results[0].result,r+=", "+game.i18n.format("usedWeaponExpertise",{a:v,b:h.terms[0].results[0].result})}this._addRollDiceSoNice(s,h,m),o.push({char:t,res:h.terms[0].results[0].result,suc:y>=0,tar:e}),d=y>=0?3:2}else if(l.terms[0].results.filter(h=>h.result>=p).length==1)if(r=game.i18n.localize("CriticalFailure"),game.settings.get("dsa5","noConfirmationRoll"))d=-3;else{let h=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"confirmationRoll",s.extra.options),y=e-h.terms[0].results[0].result;if(x.hasVantage(s.extra.actor,`${game.i18n.localize("LocalizedIDs.weaponAptitude")} (${i})`)&&!(y>=0)){let v=h.terms[0].results[0].result;h=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"LocalizedIDs.weaponAptitude",s.extra.options),y=e-h.terms[0].results[0].result,r+=", "+game.i18n.format("usedWeaponExpertise",{a:v,b:h.terms[0].results[0].result})}this._addRollDiceSoNice(s,h,m),o.push({char:t,res:h.terms[0].results[0].result,suc:y>=0,tar:e}),d=y>=0?-2:-3}return r==""?r=game.i18n.localize(c>=0?"Success":"Failure"):game.settings.get("dsa5","noConfirmationRoll")||(Math.abs(d)==3?r=`${game.i18n.localize("confirmed")} ${r}`:Math.abs(d)==2&&(r=`${game.i18n.localize("unconfirmed")} ${r}`)),{successLevel:d,characteristics:o,description:r,preData:s,modifiers:a,extra:{}}}static async rollFallingDamage(l){let e=l.roll,t=[];for(let s of e.terms[0].results)t.push({char:"damage",res:s.result,suc:!1});return{rollType:"fallingDamage",preData:l,modifiers:await this._situationalModifiers(l),extra:{},damage:Math.max(0,e.total),formula:e.formula,characteristics:t}}static async rollRegeneration(l){let e=await this._situationalModifiers(l),t=l.roll,a=[],s={rollType:"regenerate",preData:l,modifiers:e,extra:{}},i=[];l.regenerateLeP&&i.push("LeP"),l.extra.actor.system.isMage&&l.regenerateAsP&&i.push("AsP"),l.extra.actor.system.isPriest&&l.regenerateKaP&&i.push("KaP");let n=0;if(l.extra.actor.effects.some(o=>o.statuses.includes("sick"))){this._appendSituationalModifiers(l,game.i18n.localize("CONDITION.sick"),"*0");for(let o of i)a.push({char:o,res:0,die:"d6"}),s[o]=0,n+=2}else for(let o of i)this._appendSituationalModifiers(l,game.i18n.localize(`LocalizedIDs.regeneration${o}`),x.vantageStep(l.extra.actor,game.i18n.localize(`LocalizedIDs.regeneration${o}`)),o),this._appendSituationalModifiers(l,game.i18n.localize(`LocalizedIDs.weakRegeneration${o}`),x.vantageStep(l.extra.actor,game.i18n.localize(`LocalizedIDs.weakRegeneration${o}`))*-1,o),this._appendSituationalModifiers(l,game.i18n.localize(`LocalizedIDs.advancedRegeneration${o}`),L.abilityStep(l.extra.actor,game.i18n.localize(`LocalizedIDs.advancedRegeneration${o}`)),o),this._appendSituationalModifiers(l,`${game.i18n.localize(`CHARAbbrev.${o}`)} ${game.i18n.localize("Modifier")}`,l[`${o}Modifier`],o),this._appendSituationalModifiers(l,`${game.i18n.localize(`CHARAbbrev.${o}`)} ${game.i18n.localize("regenerate")}`,l[`regeneration${o}`],o),a.push({char:o,res:t.terms[n].results[0].result,die:"d6"}),s[o]=Math.round(Math.max(0,Number(t.terms[n].results[0].result)+Number(e)+await this._situationalModifiers(l,o))*Number(l.regenerationFactor)),n+=2;return s.characteristics=a,s}static async rollStatus(l){let e=l.roll||await new Roll("1d20").evaluate({async:!0}),t=await this._rollSingleD20(e,l.source.system.max,l.extra.statusId,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l));t.rollType="dodge";let a=l.extra.statusId=="dodge";return a&&t.successLevel==3?await U.tableEnabledFor("criticalMeleeDefense")?t.description+=U.rollCritBotchButton("criticalMeleeDefense",!1,l,l):t.description+=U.defaultParryCrit():a&&t.successLevel==-3&&(await U.tableEnabledFor("Defense")?t.description+=U.rollCritBotchButton("Defense",!0,l,l):t.description+=await U.defaultBotch()),t}static async rollAttribute(l){let e=l.roll?l.roll:await new Roll("1d20").evaluate({async:!0});this._appendSituationalModifiers(l,game.i18n.localize("Difficulty"),l.testDifficulty);let t=await this._rollSingleD20(e,l.source.system.value,l.extra.characteristicId,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l));return t.rollType="attribute",t}static async damageFormula(l){let e;if(l.source.type=="meleeweapon"){let t=S._calculateCombatSkillValues(l.extra.actor.items.find(a=>a.type=="combatskill"&&a.name==l.source.system.combatskill.value),l.extra.actor.system);e=S._prepareMeleeWeapon(l.source,[t],l.extra.actor)}else if(l.source.type=="rangeweapon"){let t=S._calculateCombatSkillValues(l.extra.actor.items.find(a=>a.type=="combatskill"&&a.name==l.source.system.combatskill.value),l.extra.actor.system);e=S._prepareRangeWeapon(l.source,[],[t],l.extra.actor)}else e=l.source.system;return l.source.system.damage.value.replace(/[Ww]/g,"d")+`+${e.extraDamage||0}`}static async rollDamage(l){let e=await this._situationalModifiers(l),t=[],a=l.roll,s=a.total+e;for(let i of a.terms)if(i instanceof Die||i.class=="Die")for(let n of i.results)t.push({char:l.mode,res:n.result,die:"d"+i.faces});return{rollType:"damage",damage:s,characteristics:t,preData:l,modifiers:e,extra:{}}}static async _situationalModifiers(l,e=""){let t=0;for(let a of l.situationalModifiers){if(a.value==null)continue;let s=Number(a.value)||await this._stringToRoll(a.value);t+=a.type==e||e==""&&a.type==null?s:0}return t}static _situationalPartCheckModifiers(l){return l.situationalModifiers.reduce(function(e,t){if(t.type=="TPM"){let a=t.value.split("|");return a.length!=3||(e[0]=e[0]+Number(a[0]),e[1]=e[1]+Number(a[1]),e[2]=e[2]+Number(a[2])),e}else return e},[0,0,0])}static _situationalMultipliers(l){return l.situationalModifiers.reduce(function(e,t){return e*(t.type=="*"&&Number(`${t.value}`.replace(/,/,"."))||1)},1)}static _appendSituationalModifiers(l,e,t,a=""){let s=l.situationalModifiers.find(i=>i.name==e);s?s.value=t:l.situationalModifiers.push({name:e,value:t,type:a})}static async rollCombatTrait(l){let e=l.roll||await new Roll("1d20").evaluate({async:!0}),t=l.source,a=t.system.traitType.value=="meleeAttack",s=l.mode=="attack";if(a){let o={system:{combatskill:{value:"-"},reach:{value:t.system.reach.value}}};this._appendSituationalModifiers(l,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(o,l))}let i=await this._rollSingleD20(e,Number(s?t.system.at.value:t.system.pa),l.mode,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l)),n=i.successLevel>0;await this.detailedWeaponResult(i,l,t),s&&n&&await _DiceDSA5.evaluateDamage(l,i,t,!a,i.doubleDamage),i.rollType="weapon";let r=_DiceDSA5.parseEffect(t);return r&&(i.parsedEffect=r),i}static async _stringToRoll(l,e){let t=[],a=/\d{1}[dDwW]\d/g,s=`${l}`;s.replace(a,function(r){t.push(new Roll(r.replace(/[Ww]/,"d")).evaluate({async:!0}))});let i=await Promise.all(t),n=s.replace(a,()=>{let r=i.shift();return e&&_DiceDSA5._addRollDiceSoNice(e,r,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),r.total});return await Roll.safeEval(n)}static async evaluateDamage(l,e,t,a,s){let i=t.system.damage.value.replace(/[Ww]/g,"d"),n=[],r=t.dmgMultipliers||[],o=r.map(y=>`${y.name} *${y.val}`),c=[],m=0;for(let y of l.situationalModifiers){let v=0;if(y.armorPen&&c.push(y.armorPen),y.damageBonus){if(/^\*/.test(y.damageBonus)){r.push({name:y.name,val:Number(y.damageBonus.replace("*",""))});continue}let P=/^=/.test(y.damageBonus),T=`${y.damageBonus}`.replace(/^=/,""),R=await _DiceDSA5._stringToRoll(T,l);if(v=R*(y.step||1),P){i=T.replace(/[Ww]/,"d"),n.push({name:y.name,roll:R});continue}else y.damageBonus=R,m+=v}}let d=l.damageRoll?l.damageRoll:await _DiceDSA5.manualRolls(await new Roll(i).evaluate({async:!0}),"CHAR.DAMAGE",l.extra.options),p=d.total,g=0;for(let y of d.terms)if(y instanceof Die||y.class=="Die")for(let v of y.results)g+=Number(v.result),e.characteristics.push({char:"damage",res:v.result,die:"d"+y.faces});let h=p-g;if(n.length>0)o.push(n[0].name+" "+p);else{p+=m,o.push(game.i18n.localize("Roll")+" "+g),h!=0&&o.push(game.i18n.localize("weaponModifier")+" "+h),l.situationalModifiers.reduce((P,T)=>{if(T.damageBonus){let R=/^\*/.test(T.damageBonus)?T.damageBonus:Number(T.damageBonus)*(T.step||1);o.push(`${T.name} ${R}`)}},o),l.situationalModifiers.find(P=>P.name.indexOf(game.i18n.localize("CONDITION.bloodrush"))>-1)&&(p+=2,o.push(game.i18n.localize("CONDITION.bloodrush")+" "+2)),t.extraDamage&&(p=Number(t.extraDamage)+Number(p),o.push(game.i18n.localize("damageThreshold")+" "+t.extraDamage));let y=l.extra.actor.system[a?"rangeStats":"meleeStats"].damage,v=await _DiceDSA5._stringToRoll(y,l);v!=0&&(p+=v,o.push(game.i18n.localize("statuseffects")+" "+v))}s&&(p=p*s,o.push(game.i18n.format("doubleDamage",{x:s})));for(let y of r)p=p*y.val;e.armorPen=c,e.damagedescription=o.join(", "),e.damage=Math.round(p),e.damageRoll=duplicate(d)}static async rollWeapon(l){let e=l.roll||await new Roll("1d20").evaluate({async:!0}),t,a=l.source,s=a.system.combatskill.value,i=S._calculateCombatSkillValues(l.extra.actor.items.find(c=>c.type=="combatskill"&&c.name==s),l.extra.actor.system),n=a.type=="meleeweapon";n?(t=S._prepareMeleeWeapon(a,[i],l.extra.actor),l.mode=="attack"&&this._appendSituationalModifiers(l,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(t,l))):t=S._prepareRangeWeapon(a,[],[i],l.extra.actor);let r=await this._rollSingleD20(e,t[l.mode],l.mode,await this._situationalModifiers(l),l,s,this._situationalMultipliers(l));await this.detailedWeaponResult(r,l,a),l.mode=="attack"&&r.successLevel>0&&!l.extra.counterAttack&&await _DiceDSA5.evaluateDamage(l,r,t,!n,r.doubleDamage),l.extra.counterAttack&&(f.getSpeaker(l.extra.speaker).addCondition("stunned"),r.description+=", "+f.replaceConditions(game.i18n.localize("stunnedByCounterAttack"))),r.rollType="weapon";let o=_DiceDSA5.parseEffect(t);return o&&(r.parsedEffect=o),r}static async detailedWeaponResult(l,e,t){let a=e.mode=="attack"&&!e.extra.counterAttack,s=t.type=="meleeweapon"||getProperty(t,"system.traitType.value")=="meleeAttack";switch(l.successLevel){case 3:a?(await U.tableEnabledFor("criticalAttack")?l.description+=U.rollCritBotchButton("criticalAttack",!1,e):(l.description+=U.defaultAttackCrit(!0),l.doubleDamage=2),l.halfDefense=!0):e.isRangeDefense&&await U.tableEnabledFor("criticalRangeDefense")?l.description+=U.rollCritBotchButton("criticalRangeDefense",!1,e):await U.tableEnabledFor("criticalMeleeDefense")?l.description+=U.rollCritBotchButton("criticalMeleeDefense",!1,e):l.description+=U.defaultParryCrit();break;case-3:let i=getProperty(t,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle")||t.type=="trait";a&&s&&await U.tableEnabledFor("Melee")?l.description+=U.rollCritBotchButton("Melee",i,e):a&&await U.tableEnabledFor("Range")?l.description+=U.rollCritBotchButton("Range",!1,e):!a&&await U.tableEnabledFor("Defense")?l.description+=U.rollCritBotchButton("Defense",i,e):l.description+=await U.defaultBotch();break;case 2:a&&(l.description+=U.defaultAttackCrit(!1),l.halfDefense=!0);break;case-2:break}}static async _addRollDiceSoNice(l,e,t){if(l.rollMode){for(let a=0;a<e.dice.length;a++)mergeObject(e.dice[a].options,t);await this.showDiceSoNice(e,l.rollMode)}}static async rollCombatskill(l){let e=l.roll?l.roll:await new Roll("1d20").evaluate({async:!0}),t=S._calculateCombatSkillValues(l.source,l.extra.actor.system),a=await this._rollSingleD20(e,t.system[l.mode].value,l.mode,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l));return await this.detailedWeaponResult(a,l,t),a.rollType="combatskill",a}static async manualRolls(l,e="",t={}){if(t.cheat||game.settings.get("dsa5","allowPhysicalDice"))if(t.predefinedResult)l.editRollAtIndex(t.predefinedResult);else{let a=!1,s,i=[];for(let r of l.terms)if(r instanceof Die||r.class=="Die")for(let o of r.results)i.push({faces:r.faces,val:o.result});let n=await renderTemplate("systems/dsa5/templates/dialog/manualroll-dialog.html",{dice:i,description:e});if([a,s]=await new Promise((r,o)=>{new Q({title:game.i18n.localize(t.cheat?"DIALOG.cheat":"DSASETTINGS.allowPhysicalDice"),content:n,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:c=>{r([!0,c])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{r([!1,0])}}}}).render(!0)}),a){let r=[];s.find(".dieInput").each(function(o){let c=Number($(this).val());c>0&&r.push({val:c,index:o}),o++}),l.editRollAtIndex(r)}}return l}static parseEffect(l){let e=l.system.effect?l.system.effect.value:void 0,t=[];if(e){let s=/^[a-z]+\|[a-zA-z ]+$/;for(let i of e.split(";"))if(s.test(i.trim())){let n=i.split("|").map(r=>r.trim());if(n[0]=="condition"){let r=CONFIG.statusEffects.find(o=>o.id==n[1]);t.push(`<a class="chat-condition chatButton" data-id="${r.id}">
                            <img src="${r.icon}"/>${game.i18n.localize(r.name)}
                            </a>`)}else t.push(`<a class="roll-button roll-item" data-name="${n[1]}" data-type="${n[0]}"><i class="fas fa-dice"></i>${game.i18n.localize(n[0])}: ${n[1]}</a>`)}}let a=getProperty(l,"flags.dsa5.poison");return a&&t.push(`<a class="roll-button roll-item" data-removecharge="${!a.permanent}" data-name="${a.name}" data-type="poison"><i class="fas fa-dice"></i>${game.i18n.localize("poison")}: ${a.name}</a>`),t.join(", ")}static async calculateEnergyCost(l,e,t){let a=[],s,i,n,r;if(e.successLevel<0){let o=["traditionWitch","traditionFjarning","braniborian"].map(m=>game.i18n.localize(`LocalizedIDs.${m}`)),c=t.extra.actor.items.some(m=>m.type=="specialability"&&o.includes(m.name))?3:2;e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.finalcost/c)}if(l?(r="KaPCost",s=game.i18n.localize("LocalizedIDs.weakKarmicBody"),i=game.i18n.localize(`LocalizedIDs.${e.successLevel>0?"mightyKarmaControl":"karmaControl"}`),n={val:"kapModifier",name:"KaP"}):(r="AsPCost",s=game.i18n.localize("LocalizedIDs.weakAstralBody"),i=game.i18n.localize(`LocalizedIDs.${e.successLevel>0?"energyControl":"smallEnergyControl"}`),n={val:"aspModifier",name:"AsP"}),a.push({name:s,value:x.vantageStep(t.extra.actor,s)},{name:i,value:L.abilityStep(t.extra.actor,i)*-1},{name:`${game.i18n.localize("statuseffects")} (${game.i18n.localize("CHARAbbrev."+n.name)})`,value:t.extra.actor.system[n.val]+await this._situationalModifiers(t,r)}),a=a.filter(o=>o.value!=0),e.preData.calculatedSpellModifiers.description=a.map(o=>`${o.name} ${o.value}`).join(`
`),e.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(e.preData.calculatedSpellModifiers.finalcost)+a.reduce((o,c)=>o+c.value,0)),e.successLevel>0&&e.preData.calculatedSpellModifiers.maintainCost!=0){let o=e.preData.calculatedSpellModifiers.maintainCost.split(" ");o[0]=Math.round(Number(o[0])),e.preData.calculatedSpellModifiers.finalcost+=o[0],e.preData.calculatedSpellModifiers.maintainCost=o.join(" ")}}static async rollSpell(l){let e=await this._rollThreeD20(l),t=["ceremony","liturgy"].includes(l.source.type);if(e.rollType=l.source.type,e.preData.calculatedSpellModifiers.finalcost=e.preData.calculatedSpellModifiers.cost,e.successLevel>=2){let a=(await new Roll("1d6").evaluate({async:!0})).total;e.description=e.description+", "+game.i18n.localize("additionalFPs")+" "+a,e.result+=a,e.qualityStep=Math.min(game.settings.get("dsa5","capQSat"),Math.ceil(e.result/3)),e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.cost/2)}else e.successLevel<=-2&&(e.description+=U.rollCritBotchButton(t?"Liturgy":"Spell",!1,l));if(e.successLevel>0&&l.source.system.effectFormula.value!=""){let a=l.source.system.effectFormula.value.replace(game.i18n.localize("CHARAbbrev.QS"),e.qualityStep).replace(/[Ww]/g,"d"),s=[];for(let o of l.situationalModifiers)o.armorPen&&s.push(o.armorPen);/(,|;)/.test(a)&&(a=a.split(/[,;]/)[e.qualityStep-1]);let i=l.damageRoll?l.damageRoll:await _DiceDSA5.manualRolls(await new Roll(a).evaluate({async:!0}),"CHAR.DAMAGE",l.extra.options);this._addRollDiceSoNice(l,i,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),e.calculatedEffectFormula=a;for(let o of i.terms)if(o instanceof Die||o.class=="Die")for(let c of o.results)e.characteristics.push({char:"effect",res:c.result,die:"d"+o.faces});let n=[],r=await _DiceDSA5._stringToRoll(l.extra.actor.system[t?"liturgyStats":"spellStats"].damage,l);r!=0&&n.push(game.i18n.localize("statuseffects")+" "+r),e.armorPen=s,e.damageRoll=i,e.damage=i.total+r,e.damagedescription=n.join(`
`)}await this.calculateEnergyCost(t,e,l);for(let a of["minorFairies","minorSpirits"]){let s=game.i18n.localize("CONDITION."+a);x.hasVantage(l.extra.actor,s)&&!l.extra.actor.effects.find(i=>i.name==s)&&(await new Roll("1d20").evaluate({async:!0})).total<=e.preData.calculatedSpellModifiers.finalcost&&(e.description+=", "+game.i18n.format("minorghostsappear",{creature:s}),f.getSpeaker(l.extra.speaker).addCondition(a))}return e}static async _rollThreeD20(l){let e=l.roll?Roll.fromData(l.roll):await new Roll("1d20+1d20+1d20").evaluate({async:!0}),t=[],a=0;this._appendSituationalModifiers(l,game.i18n.localize("Difficulty"),l.testDifficulty);let s=await this._situationalModifiers(l),i=l.source.system.talentValue.value+l.advancedModifiers.fws+await this._situationalModifiers(l,"FW"),n=this._situationalPartCheckModifiers(l,"TPM"),r=[1,2,3].map(g=>l.extra.actor.system.characteristics[l.source.system[`characteristic${g}`].value].value+s+l.advancedModifiers.chars[g-1]+n[g-1]),o=[0,1,2].map(g=>e.terms[g*2].results[0].result-r[g]);if(l.routine)i=Math.round(i/2);else for(let g of o)g>0&&(i-=g);let c=l.extra.actor.system.skillModifiers.crit,m=l.extra.actor.system.skillModifiers.botch;if(["spell","ritual"].includes(l.source.type)&&x.hasVantage(l.extra.actor,game.i18n.localize("LocalizedIDs.wildMagic"))&&(m=19),l.source.type=="skill"&&x.hasVantage(l.extra.actor,`${game.i18n.localize("LocalizedIDs.incompetent")} (${l.source.name})`)){let g=await new Roll("1d20").evaluate({async:!0}),h=o.reduce((v,P,T,R)=>P<R[v]?T:v,0),y=e.terms[h*2].total;i+=Math.max(o[h],0),i-=Math.max(0,g.total-r[h]),e.editRollAtIndex([{index:h,val:g.total}]),this._addRollDiceSoNice(l,g,e.terms[h*2].options),t.push(game.i18n.format("CHATNOTIFICATION.unableReroll",{die:h+1,oldVal:y,newVal:g.total}))}let d=0;l.source.type=="skill"&&ce.hasTrait(l.extra.actor,`${game.i18n.localize("LocalizedIDs.automaticSuccess")} (${l.source.name})`)?(t.push(game.i18n.localize("LocalizedIDs.automaticSuccess")),a=1,d=1):l.source.type=="skill"&&ce.hasTrait(l.extra.actor,`${game.i18n.localize("LocalizedIDs.automaticFail")} (${l.source.name})`)?(t.push(game.i18n.localize("LocalizedIDs.automaticFail")),a=-1):(a=_DiceDSA5.get3D20SuccessLevel(e,i,m,c),l.routine&&(a=1),t.push(_DiceDSA5.getSuccessDescription(a))),t=t.join(", ");let p=0;return a>0&&(i+=await this._situationalModifiers(l,"FP"),p=Math.max(1,(i==0?1:i>0?Math.ceil(i/3):0)+(l.qualityStep!=null?Number(l.qualityStep):0))+(l.advancedModifiers.qls||0)+await this._situationalModifiers(l,"QL")),p=Math.min(game.settings.get("dsa5","capQSat"),p),p<d&&(p=d),{result:i,characteristics:[0,1,2].map(g=>({char:l.source.system[`characteristic${g+1}`].value,res:e.terms[g*2].results[0].result,suc:o[g]<=0,tar:r[g]})),qualityStep:p,description:t,preData:l,successLevel:a,modifiers:s,extra:{}}}static async rollTalent(l){let e=await this._rollThreeD20(l);return e.rollType="talent",e}static get3D20SuccessLevel(l,e,t=20,a=1){let s=l.terms.filter(n=>n.results&&n.results[0].result<=a).length,i=l.terms.filter(n=>n.results&&n.results[0].result>=t).length;return s>=2?s:i>=2?i*-1:e>=0?1:-1}static getSuccessDescription(l){return game.i18n.localize(["AstoundingFailure","CriticalFailure","Failure","","Success","CriticalSuccess","AstoundingSuccess"][l+3])}static async rollItem(l){let e=l.roll||await new Roll("1d20+1d20+1d20").evaluate({async:!0}),t=[],a=await this._situationalModifiers(l),s=Number(l.source.system.step.value),i=[1,2,3].map(m=>10+Number(l.source.system.step.value)+a),n=[0,1,2].map(m=>e.terms[m*2].results[0].result-i[m]);for(let m of n)m>0&&(s-=m);let r=20,o=_DiceDSA5.get3D20SuccessLevel(e,s,r);t.push(_DiceDSA5.getSuccessDescription(o)),t=t.join(", ");let c={result:s,characteristics:[0,1,2].map(m=>({char:l.source.type,res:e.terms[m*2].results[0].result,suc:n[m]<=0,tar:i[m]})),qualityStep:Math.min(game.settings.get("dsa5","capQSat"),(s==0?1:s>0?Math.ceil(s/3):0)+(l.qualityStep!=null?Number(l.qualityStep):0)),description:t,preData:l,successLevel:o,modifiers:a,extra:{}};switch(l.source.type){case"poison":let m=l.source.system.duration.value.split(" / ").map(h=>h.trim()),d=l.source.system.effect.value.split(" / ").map(h=>h.trim());c.duration=m.length>1?c.successLevel>0?m[0]:m[1]:m[0],c.effect=d.length>1?c.successLevel>0?d[0]:d[1]:d[0];break;case"disease":let p=l.source.system.damage.value.split(" / ").map(h=>h.trim()),g=l.source.system.duration.value.split(" / ").map(h=>h.trim());c.damageeffect=p.length>1?c.successLevel>0?p[0]:p[1]:p[0],c.duration=g.length>1?c.successLevel>0?g[0]:g[1]:g[0];break}return c}static async updateDefenseCount(l){game.combat&&await game.combat.updateDefenseCount(l.extra.speaker)}static _compareWeaponReach(l,e){let t=e.situationalModifiers.find(i=>i.name==game.i18n.localize("LocalizedIDs.circumvent")),a=b.meleeRangesArray.indexOf(l.system.reach.value),s=b.meleeRangesArray.indexOf(e.opposingWeaponSize);return t&&s>a&&(t.value=Math.min(t.step,s-a)*2),Math.min(0,a-s)*2}static async showDiceSoNice(l,e){if(f.moduleEnabled("dice-so-nice")&&game.dice3d){let t=null,a=!1;switch(e){case"blindroll":a=!0,t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"gmroll":t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"selfroll":t=[];break}let s=game.dice3d.showForRoll(l,game.user,!0,t,a);game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")||await s}}static addApplyEffectData(l){let e=l.preData.source;if(l.successLevel>0){if(["meleeweapon","rangeweapon"].includes(e.type)||e.type=="trait"&&["rangeAttack","meleeAttack"].includes(e.system.traitType.value)){if(e.effects.some(a=>!getProperty(a,"flags.dsa5.applyToOwner")))return!0}else if(["spell","liturgy","ritual","ceremony","trait","skill"].includes(e.type)&&e.effects.length>0)return!0}else if(["disease","poison"].includes(e.type))return e.effects.length>0;let t=l.preData.situationalModifiers.filter(a=>a.specAbId).map(a=>a.specAbId);if(t.length>0){let a=l.preData.extra.actor.items.filter(s=>t.includes(s._id));for(let s of a)if(s.effects.length>0)return!0}return!1}static async renderRollCard(chatOptions,testData,rerenderMessage){let applyEffect=this.addApplyEffectData(testData),immuneTo=M.checkImmunity(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:preData.mode=="attack";await Be.postRoll({testData,preData}),Hooks.call("postProcessDSARoll",chatOptions,testData,rerenderMessage,hideDamage),await f.callAsyncHooks("postProcessDSARoll",[testData]),delete preData.extra.actor,delete testData.actor,delete testData.preData;let hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsa5.config.areaTargetTypes,chatData={title:chatOptions.title,immuneTo,testData,hideData:game.user.isGM,preData,hideDamage,modifierList:preData.situationalModifiers.filter(l=>l.value!=0),applyEffect,hasAreaTemplate,showDamageToGear:await W.showDamageToGear(preData,testData)};if(preData.advancedModifiers&&(preData.advancedModifiers.chars.some(l=>l!=0)&&chatData.modifierList.push({name:game.i18n.localize("MODS.partChecks"),value:preData.advancedModifiers.chars}),preData.advancedModifiers.fws!=0&&chatData.modifierList.push({name:game.i18n.localize("MODS.FW"),value:preData.advancedModifiers.fws}),preData.advancedModifiers.qls!=0&&chatData.modifierList.push({name:game.i18n.localize("MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter(l=>l.isGM).map(l=>l.id)),chatOptions.rollMode==="blindroll"?chatOptions.blind=!0:chatOptions.rollMode==="selfroll"&&(chatOptions.whisper=[game.user.id]),V.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSARoll:!0},rerenderMessage){let postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction");postFunction&&(testData.messageId=rerenderMessage.id,await eval(postFunction.functionName)(postFunction,{result:testData,chatData},preData.source));let html=await renderTemplate(chatOptions.template,chatData),actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{},enriched=await TextEditor.enrichHTML(html,{rollData,async:!0});chatOptions.content=enriched;let newMsg=await rerenderMessage.update({content:chatOptions.content,["flags.data"]:chatOptions["flags.data"]});return ui.chat.updateMessage(newMsg),newMsg}else return chatOptions.content=await renderTemplate(chatOptions.template,chatData),await ChatMessage.create(chatOptions,!1)}static async _itemRoll(l){let e=$(l.currentTarget),t=e.parents(".message").attr("data-message-id"),a=game.messages.get(t),s=a.speaker,i=e.attr("data-type"),n=e.attr("data-name"),r=f.getSpeaker(s);if(r){let o=r.items.find(c=>c.name==n&&c.type==i);if(o){let c=new C(o.toObject(),{temporary:!0}),m=e.attr("data-removecharge")?e.attr("data-removecharge")=="true":!1;if(m&&c.system.quantity.value<1){ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));return}c.setupEffect().then(async d=>{await c.itemTest(d),m&&await o.update({"system.quantity.value":o.system.quantity.value-1})})}else ui.notifications.error(game.i18n.format("DSAError.notFound",{category:i,name:n}))}}static async _rollEdit(l){let e=$(l.currentTarget),t=e.parents(".message").attr("data-message-id"),a=game.messages.get(t),s=a.flags.data,i=s.preData;i.extra.actor=f.getSpeaker(i.extra.speaker).toObject(!1),i.extra.options.cheat&&delete i.extra.options.cheat;let n;switch(e.attr("data-edit-type")){case"roll":n=e.attr("data-edit-id");let o=Number(e.val());if(i.roll.terms.length>n*2){let m=Roll.fromData(i.roll);m.editRollAtIndex([{index:n,val:o}]),i.roll=m}else{let m=Roll.fromData(s.postData.damageRoll);n=n-i.roll.terms.filter(d=>d.results).length,m.editRollAtIndex([{index:n,val:o}]),i.damageRoll=m}break;case"mod":n=i.situationalModifiers.findIndex(m=>m.name==game.i18n.localize("chatEdit")),n>0&&i.situationalModifiers.splice(n,1);let c={name:game.i18n.localize("chatEdit"),value:Number(e.val())-await this._situationalModifiers(i)};i.situationalModifiers.push(c);break}let r={template:s.template,rollMode:s.rollMode,title:s.title,speaker:a.speaker,user:a.user.id};["gmroll","blindroll"].includes(r.rollMode)&&(r.whisper=game.users.filter(o=>o.isGM).map(o=>o.id)),r.rollMode==="blindroll"&&(r.blind=!0),["poison","disease"].includes(i.source.type)?new C(i.source,{temporary:!0})[`${s.postData.postFunction}`]({testData:i,cardOptions:r},{rerenderMessage:a}):f.getSpeaker(a.speaker)[`${s.postData.postFunction}`]({testData:i,cardOptions:r},{rerenderMessage:a})}static async gearDamaged(l){let e=l.currentTarget.dataset.uuid.split(";");if(e.length>1){let t=await Promise.all(e.map(a=>fromUuid(a)));qe.showDialog(t)}else W.breakingTest(await fromUuid(e[0]))}static async rollResistPain(l){let e=l.currentTarget.dataset,t={token:e.token,actor:e.actor,scene:canvas.id},a=f.getSpeaker(t);a&&a.finishResistPainRoll()}static async wrapLock(l,e){let t=$(l.currentTarget);t.hasClass("locked")||(t.addClass("locked"),t.prepend('<i class="fas fa-spinner fa-spin"></i>'),await e(l,t),setTimeout(()=>{t.removeClass("locked"),t.find("i").remove()},2e3))}static async chatListeners(l){l.on("click",".expand-mods",e=>{e.preventDefault();let t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()}),l.on("click",".edit-toggle",e=>{e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()}),l.on("click",".botch-roll",e=>U.showBotchCard(e.currentTarget.dataset)),l.on("click",".roll-item",e=>_DiceDSA5._itemRoll(e)),l.on("click",".gearDamaged",async e=>_DiceDSA5.gearDamaged(e)),l.on("click",".applyDamage",async e=>vt($(e.currentTarget).closest(".message"),e.currentTarget.dataset.mode)),l.on("change",".roll-edit",e=>_DiceDSA5._rollEdit(e)),l.on("click",".applyEffect",async e=>{_DiceDSA5.wrapLock(e,async(t,a)=>{let s=a.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await _DSAActiveEffectConfig.applyEffect(s,i)})}),l.on("click",".applyTableEffect",async e=>{_DiceDSA5.wrapLock(e,async(t,a)=>{let s=a.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await We.applyEffect(s,i)})}),l.on("click",".placeTemplate",async e=>ot.placeTemplateFromChat(e)),l.on("click",".message-delete",e=>{let t=game.messages.get($(e.currentTarget).parents(".message").attr("data-message-id"));if(!t.flags.unopposeData)return;let s=canvas.tokens.get(t.flags.unopposeData.targetSpeaker.token);H.clearOpposed(s.actor)}),l.on("click",".resistEffect",e=>_DSAActiveEffectConfig.resistEffect(e)),l.on("click",".resistPain",e=>_DiceDSA5.rollResistPain(e)),B.chatListeners(l)}};u(_DiceDSA5,"DiceDSA5");var S=class extends Actor{static async create(e,t){if(e instanceof Array||e.items)return await super.create(e,t);(!e.img||e.img=="icons/svg/mystery-man.svg")&&(e.img="icons/svg/mystery-man-black.svg");let a=await f.allSkills()||[],s=await f.allCombatSkills()||[],i=await f.allMoneyItems()||[];return e.items=[...a,...s,...i],e.type!="character"&&(e.system={status:{fatePoints:{current:0,value:0}}}),e.type!="creature"&&[void 0,0].includes(getProperty(e,"system.status.wounds.value"))&&mergeObject(e,{system:{status:{wounds:{value:16}}}}),await super.create(e,t)}_getArmorCompensation(e,t,a){let s=L.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance")),i=t.reduce((n,r)=>n+=Number(r.system.encumbrance.value),0);if(s>i){let n=[game.i18n.localize("CHARAbbrev.GS"),game.i18n.localize("CHARAbbrev.INI")];for(let r of n)!a[r]||(a[r]=a[r].filter(o=>o.type!="armor"))}}_getItemModifiers(){let e=[],t={};for(let a of this.items.filter(s=>["meleeweapon","rangeweapon","armor","equipment"].includes(s.type)&&getProperty(s,"system.worn.value")||["advantage","specialability","disadvantage"].includes(s.type)))this._buildGearAndAbilityModifiers(t,a),a.type=="armor"&&e.push(a);this._getArmorCompensation(this,e,t),this._applyModiferTransformations(t)}prepareDerivedData(){var t,a,s,i;let e=this.system;try{this._getItemModifiers();for(let y of Object.values(e.characteristics))y.value=y.initial+y.advances+(y.modifier||0)+y.gearmodifier;e.totalWeight=0;let n=[],r=game.i18n.localize("LocalizedIDs.familiar"),o=game.i18n.localize("LocalizedIDs.companion"),c=new Map,m=this.items.filter(y=>y.type=="equipment"&&y.system.equipmentType.value=="bags");for(let y of m)c.set(y.id,[]);for(let y of this.items)if(b.equipmentCategories.has(y.type)){let v=getProperty(y,"system.parent_id");if(v&&v!=y._id&&c.has(v)){c.get(v).push(y);continue}y.type=="armor"?(y.system.preparedWeight=parseFloat((y.system.weight.value*y.system.quantity.value).toFixed(3)),e.totalWeight+=parseFloat((y.system.weight.value*(y.system.worn.value?Math.max(0,y.system.quantity.value-1):y.system.quantity.value)).toFixed(3)),y.system.worn.value&&n.push(y)):(y.system.preparedWeight=parseFloat((y.system.weight.value*y.system.quantity.value).toFixed(3)),e.totalWeight+=Number(y.system.preparedWeight))}else switch(y.type){case"trait":y.name==r&&(e.isFamiliar=!0),y.name==o&&(e.isPet=!0);break;case"spell":case"ritual":case"magictrick":e.isMage=!0;break;case"liturgy":case"ceremony":case"blessing":e.isPriest=!0;break;case"specialability":b.sortedSpecs.magical.has(y.system.category.value)?e.isMage=!0:b.sortedSpecs.clerical.has(y.system.category.value)&&(e.isPriest=!0);break}e.isMage||(e.isMage=e.isFamiliar);for(let y of m){let v=getProperty(y,"system.parent_id");(!v||!c.has(v))&&(e.totalWeight+=this._calcBagweight(y,c,!0))}e.canAdvance=this.isOwner&&(this.type=="character"||e.isFamiliar||e.isPet),this.canAdvance=e.canAdvance,e.carrycapacity=e.characteristics.kk.value*2+e.carryModifier,e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent,e.details.experience.description=f.experienceDescription(e.details.experience.total)),(this.type=="character"||this.type=="npc")&&(e.status.wounds.current=e.status.wounds.initial+e.characteristics.ko.value*2,e.status.soulpower.value=(e.status.soulpower.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/6),e.status.toughness.value=(e.status.toughness.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/6),e.status.wounds.min=-1*e.characteristics.ko.value),e.status.fatePoints.max=Number(e.status.fatePoints.current)+Number(e.status.fatePoints.modifier)+e.status.fatePoints.gearmodifier,this.type=="creature"&&(e.status.wounds.current=e.status.wounds.initial,e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial),e.status.wounds.max=Math.round((e.status.wounds.current+e.status.wounds.modifier+e.status.wounds.advances)*e.status.wounds.multiplier+e.status.wounds.gearmodifier),e.status.regeneration.LePmax=e.status.regeneration.LePTemp+e.status.regeneration.LePMod+e.status.regeneration.LePgearmodifier,e.status.regeneration.KaPmax=e.status.regeneration.KaPTemp+e.status.regeneration.KaPMod+e.status.regeneration.KaPgearmodifier,e.status.regeneration.AsPmax=e.status.regeneration.AsPTemp+e.status.regeneration.AsPMod+e.status.regeneration.AsPgearmodifier;let d=e.guidevalue;(t=e.status.astralenergy).rebuy||(t.rebuy=0),(a=e.status.karmaenergy).rebuy||(a.rebuy=0),(s=e.status.astralenergy).permanentLoss||(s.permanentLoss=0),(i=e.status.karmaenergy).permanentLoss||(i.permanentLoss=0),e.status.astralenergy.permanentLossSum=e.status.astralenergy.permanentLoss-e.status.astralenergy.rebuy+e.status.astralenergy.permanentGear,e.status.karmaenergy.permanentLossSum=e.status.karmaenergy.permanentLoss-e.status.karmaenergy.rebuy+e.status.karmaenergy.permanentGear,(e.isFamiliar||d&&this.type!="creature")&&(e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial,e.characteristics[d.magical]&&(e.status.astralenergy.current+=Math.round(e.characteristics[d.magical].value*e.energyfactor.magical)),e.characteristics[d.clerical]&&(e.status.karmaenergy.current+=Math.round(e.characteristics[d.clerical].value*e.energyfactor.clerical))),e.status.astralenergy.max=e.status.astralenergy.current+e.status.astralenergy.modifier+e.status.astralenergy.advances+e.status.astralenergy.gearmodifier-e.status.astralenergy.permanentLossSum,e.status.karmaenergy.max=e.status.karmaenergy.current+e.status.karmaenergy.modifier+e.status.karmaenergy.advances+e.status.karmaenergy.gearmodifier-e.status.karmaenergy.permanentLossSum,e.status.soulpower.max=e.status.soulpower.value+e.status.soulpower.modifier+e.status.soulpower.gearmodifier,e.status.toughness.max=e.status.toughness.value+e.status.toughness.modifier+e.status.toughness.gearmodifier,e.status.dodge.value=Math.round(e.characteristics.ge.value/2)+e.status.dodge.gearmodifier;let p=this.calcEncumbrance(e),g=j.isRiding(this)?j.getHorse(this):void 0;this.calcInitiative(e,p,g),e.status.dodge.max=Number(e.status.dodge.value)+Number(e.status.dodge.modifier)+Number(game.settings.get("dsa5","higherDefense"))/2,e.armorEncumbrance=this.getArmorEncumbrance(this,n),this.prepareSwarm(e),this.effectivePain(e);let h=this.statuses.has("fixated");this.calcSpeed(e,h,g),h&&(e.status.dodge.max=Math.max(0,e.status.dodge.max-4))}catch(n){console.error(`Something went wrong with preparing actor data ${this.name}: `+n+n.stack),ui.notifications.error(game.i18n.format("DSAError.PreparationError",{name:this.name})+n+n.stack)}}static async deferredEffectAddition(e,t,a){let i=(t.effects.find(r=>r.statuses.has(e))?.flags.dsa5.auto||0)!=a,n=`changing${e}`;t[n]=i,i&&await t.addCondition(e,a,!0).then(()=>t[n]=void 0)}static async postUpdateConditions(e){if(f.isActiveGM()){let t=e.system,a=e.isMerchant();if(!ce.hasTrait(e,game.i18n.localize("LocalizedIDs.painImmunity"))){let n=e.woundPain(t);await this.deferredEffectAddition("inpain",e,n)}let s=t.armorEncumbrance;(e.type!="creature"||e.canAdvance)&&!a&&(s+=Math.max(0,Math.ceil((t.totalWeight-t.carrycapacity-4)/4))),await this.deferredEffectAddition("encumbered",e,s);let i=e.woundPain(t,"temporaryLeP");await this.deferredEffectAddition("stunned",e,i),x.hasVantage(e,game.i18n.localize("LocalizedIDs.blind"))&&await e.addCondition("blind"),x.hasVantage(e,game.i18n.localize("LocalizedIDs.mute"))&&await e.addCondition("mute"),x.hasVantage(e,game.i18n.localize("LocalizedIDs.deaf"))&&await e.addCondition("deaf"),a&&await e.prepareMerchant()}}static async _onCreateDocuments(e,t){for(let a of e)await S.postUpdateConditions(a);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)await S.postUpdateConditions(a);return super._onUpdateDocuments(e,t)}prepareSwarm(e){let t=Number(e.swarm.count)||1;if(t<2)return;e.swarm.maxwounds=e.status.wounds.max,e.status.wounds.max*=t;let a=Math.min(Math.ceil(e.status.wounds.value/e.swarm.maxwounds),t),s=Number(e.swarm.gg)||1;e.swarm.attack+=Math.min(10,Math.floor(a/s)),e.swarm.parry+=-1,e.swarm.effectiveCount=a,e.swarm.damage=Math.min(5,Math.floor(a/s))}effectivePain(e){let t=e.condition.inpain||0;t<4&&(t-=x.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedFighter"))+x.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedAnimal"))+(L.hasAbility(this,game.i18n.localize("LocalizedIDs.traditionKor"))?1:0)),t>0&&(t+=x.vantageStep(this,game.i18n.localize("LocalizedIDs.sensitiveToPain"))+x.vantageStep(this,game.i18n.localize("LocalizedIDs.fragileAnimal"))),t=Math.clamped(t,0,4),e.condition.inpain=t}woundPain(e,t="wounds"){let a=0;return e.status[t].max>0&&(this.type!="creature"||e.status[t].max>=20?(a=Math.floor((1-e.status[t].value/e.status[t].max)*4),e.status[t].value<=5&&(a=4)):a=Math.floor(5-5*e.status[t].value/e.status[t].max)),Math.clamped(a,0,4)}calcSpeed(e,t,a){if(a){if(e.status.speed.max=a.system.status.speed.max,!e.status.speed.max){let s=a.system;a.calcSpeed(s,a.hasCondition("fixated"))}e.status.speed.max=a.system.status.speed.max}else{e.status.speed.max=e.status.speed.initial+(e.status.speed.modifier||0)+(e.status.speed.gearmodifier||0),e.status.speed.max=Math.round(Math.max(0,e.status.speed.max-Math.min(4,this.calcEncumbrance(e)))*e.status.speed.multiplier),this.hasCondition("bloodrush")||(e.status.speed.max=Math.max(0,e.status.speed.max-(e.condition?.inpain||0)));let s=this.hasCondition("paralysed");s&&(e.status.speed.max=Math.round(e.status.speed.max*(1-s.flags.dsa5.value*.25))),t||this.hasCondition("rooted")||this.hasCondition("incapacitated")?e.status.speed.max=0:this.hasCondition("prone")&&(e.status.speed.max=Math.min(1,e.status.speed.max)),j.updateRiderSpeed(this,e.status.speed.max)}}calcEncumbrance(e){return Math.clamped(e.condition?.encumbered||0,0,4)}calcInitiative(e,t,a){if(this.type=="character"||this.type=="npc"?e.status.initiative.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.status.initiative.modifier||0):e.status.initiative.value=e.status.initiative.current+(e.status.initiative.modifier||0),a){if(e.status.initiative.value=a.system.status.initiative.value,!e.status.initiative.value){let s=a.system;a.calcInitiative(s,a.calcEncumbrance(s)),e.status.initiative.value=s.status.initiative.value}}else{e.status.initiative.value+=(e.status.initiative.gearmodifier||0)-Math.min(4,t);let s=Number((.01*e.status.initiative.value).toFixed(2));e.status.initiative.value*=e.status.initiative.multiplier||1,e.status.initiative.value=Math.round(e.status.initiative.value)+s}}get creatureType(){return M.creatureTypeName(this)}async prepareMerchant(){if(getProperty(this,"system.merchant.merchantType")=="loot"){if(getProperty(this,"system.merchant.locked")&&!this.hasCondition("locked"))await this.addCondition(S.lockedCondition());else if(!getProperty(this,"system.merchant.locked")){let e=this.effects.find(t=>t.statuses.has("locked"));e&&await this.deleteEmbeddedDocuments("ActiveEffect",[e.id])}}}static lockedCondition(){return{id:"locked",name:game.i18n.localize("MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{dsa5:{noEffect:!0,hidePlayers:!0,description:game.i18n.localize("MERCHANT.locked")}}}}applyActiveEffects(){let e={};this.statuses??(this.statuses=new Set);let t=new Map;for(let o of Object.values(CONFIG.specialStatusEffects))t.set(o,this.statuses.has(o));this.statuses.clear();let a=[],s=1;for(let o of this.effects){if(o.disabled)continue;s=1;let c=o.getFlag("dsa5","value");c&&(s=Number(c));for(let m=0;m<s;m++)a.push(...o.changes.map(d=>(d=foundry.utils.duplicate(d),d.effect=o,d.priority=d.priority?d.priority:d.mode*10,d)));for(let m of o.statuses)this.statuses.add(m)}let i=!0,n=this.items.filter(o=>["rangeweapon","meleeweapon","equipment","armor"].includes(o.type)&&o.system.isArtifact&&(o.system.worn.value||o.type=="equipment"&&!o.system.worn.wearable)).map(o=>o.system.artifact);this.dsatriggers={6:{},7:{}};for(let o of this.items)for(let c of o.effects)if(!c.disabled){switch(i=!0,o.type){case"meleeweapon":case"rangeweapon":i=o.system.worn.value&&c.getFlag("dsa5","applyToOwner");break;case"armor":i=o.system.worn.value;break;case"equipment":i=!o.system.worn.wearable||o.system.worn.wearable&&o.system.worn.value;break;case"trait":i=!["meleeAttack","rangeAttack"].includes(o.system.traitType.value)||c.getFlag("dsa5","applyToOwner"),s=Number(getProperty(o.system,"step.value"))||1;break;case"ammunition":case"plant":case"consumable":case"combatskill":case"magicsign":case"poison":case"spell":case"liturgy":case"ceremony":case"ritual":case"skill":case"spellextension":i=!1;break;case"specialability":switch(o.system.category.value){case"Combat":i=[2,3].includes(Number(o.system.category.sub));break;case"staff":i=o.system.permanentEffects||n.includes(o.system.artifact);break;default:i=!0}s=Number(o.system.step.value)||1;let m=getProperty(c,"flags.dsa5.advancedFunction");this.dsatriggers.hasOwnProperty(m)&&(this.dsatriggers[m][o.id]=c.id);break;case"advantage":case"disadvantage":s=Number(o.system.step.value)||1;break}if(c.notApplicable=!i,!!i){for(let m=0;m<s;m++)a.push(...c.changes.map(d=>(d=foundry.utils.duplicate(d),d.effect=c,d.priority=d.priority?d.priority:d.mode*10,d)));for(let m of c.statuses)this.statuses.add(m)}}a.sort((o,c)=>o.priority-c.priority);for(let o of a){if(!o.key)continue;let c=o.effect.apply(this,o);Object.assign(e,c)}this.overrides=foundry.utils.expandObject(e);let r;for(let[o,c]of t){let m=this.statuses.has(o);if(m!==c){r??(r=this.getActiveTokens());for(let d of r)d._onApplyStatusEffect(o,m)}}}_setOnUseEffect(e){getProperty(e,"flags.dsa5.onUseEffect")&&(e.OnUseEffect=!0)}_setAEPayments(e){if(e.OnUseEffect)return;Number(getProperty(e,"system.AsPCost"))&&(e.AEpayable=!0)}prepareBaseData(){let e=this.system;mergeObject(e,{itemModifiers:{},condition:{},swarm:{attack:0,parry:0,damage:0},creatureType:this.creatureType,skillModifiers:{FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AsPCost:[],KaPCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],KaPCost:[],AsPCost:[]},...["liturgy","ceremony","ritual","spell","skill"].reduce((t,a)=>(t[a]={FP:[],step:[],QL:[],TPM:[],FW:[]},t),{})},status:{initiative:{multiplier:1},astralenergy:{permanentGear:0},karmaenergy:{permanentGear:0},wounds:{multiplier:1},speed:{multiplier:1},regeneration:{LePgearmodifier:0,KaPgearmodifier:0,AsPgearmodifier:0}},repeatingEffects:{startOfRound:{wounds:[],karmaenergy:[],astralenergy:[]}},temperature:{heatProtection:0,coldProtection:0},totalArmor:0,spellArmor:0,liturgyArmor:0,carryModifier:0,aspModifier:0,kapModifier:0,immunities:[],creatureBonus:[],miracle:{attack:0,parry:0},spellStats:{damage:"0"},liturgyStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1}});for(let t of b.gearModifyableCalculatedAttributes)e.status[t]&&(e.status[t].gearmodifier=0);for(let t of Object.values(e.characteristics))t.gearmodifier=0}getSkillModifier(e,t){let a=[],s=["FP","step","QL","TPM","FW"];for(let i of s){let n=i=="step"?"":i;a.push(...this.system.skillModifiers[i].filter(r=>r.target==e).map(r=>({name:r.source,value:r.value,type:n}))),this.system.skillModifiers[t]&&a.push(...this.system.skillModifiers[t][i].map(r=>({name:r.source,value:r.value,type:n})))}return a}prepareSheet(e){let t={system:{characteristics:{}}};if(mergeObject(t,this.prepareItems(e)),t.canAdvance){let a=["wounds","astralenergy","karmaenergy"];for(let s of a)mergeObject(t.system,{status:{[s]:{cost:game.i18n.format("advancementCost",{cost:f._calculateAdvCost(this.system.status[s].advances,"D")}),refund:game.i18n.format("refundCost",{cost:f._calculateAdvCost(this.system.status[s].advances,"D",0)})}}});for(let[s,i]of Object.entries(this.system.characteristics))t.system.characteristics[s]={cost:game.i18n.format("advancementCost",{cost:f._calculateAdvCost(i.initial+i.advances,"E")}),refund:game.i18n.format("refundCost",{cost:f._calculateAdvCost(i.initial+i.advances,"E",0)})}}return t}static canAdvance(e){return e.canAdvance}static armorValue(e,t={}){let a=e.items.filter(n=>n.type=="armor"&&n.system.worn.value==!0);t.origin&&(a=a.map(n=>{let r=mergeObject(duplicate(t),{armor:n});return _DSAActiveEffectConfig.applyRollTransformation(e,r,4).options.armor}));let s=a.reduce((n,r)=>n+W.armorWearModifier(r,r.system.protection.value),0),i=e.items.filter(n=>n.type=="trait"&&n.system.traitType.value=="armor").reduce((n,r)=>n+Number(r.system.at.value),0);return{wornArmor:a,armor:s+i+(e.system.totalArmor||0)}}static _calculateCombatSkillValues(e,t){if(e.system.weapontype.value=="melee"){let a=e.system.guidevalue.value.split("/").map(n=>Number(t.characteristics[n].initial)+Number(t.characteristics[n].modifier)+Number(t.characteristics[n].advances)+Number(t.characteristics[n].gearmodifier)),s=Math.max(...a);e.system.parry.value=Math.ceil(e.system.talentValue.value/2)+Math.max(0,Math.floor((s-8)/3))+Number(game.settings.get("dsa5","higherDefense"));let i=t.characteristics.mu.initial+t.characteristics.mu.modifier+t.characteristics.mu.advances+t.characteristics.mu.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((i-8)/3))}else{e.system.parry.value=0;let a=t.characteristics.ff.initial+t.characteristics.ff.modifier+t.characteristics.ff.advances+t.characteristics.ff.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((a-8)/3))}return e.cost=game.i18n.format("advancementCost",{cost:f._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e}_perpareItemAdvancementCost(e){return e.cost=game.i18n.format("advancementCost",{cost:f._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e.refund=game.i18n.format("refundCost",{cost:f._calculateAdvCost(e.system.talentValue.value,e.system.StF.value,0)}),e}async modifyTokenAttribute(e,t,a=!1,s=!0){let i=foundry.utils.getProperty(this.system,e),n;return s?(a&&(t=Math.clamped(i.min||0,Number(i.value)+t,i.max)),n={[`system.${e}.value`]:t}):(a&&(t=Number(i)+t),n={[`system.${e}`]:t}),Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:a,isBar:s},n)!==!1?this.update(n):this}schipshtml(){let e=[];for(let t=1;t<=Number(this.system.status.fatePoints.max);t++)e.push({value:t,cssClass:t<=Number(this.system.status.fatePoints.value)?"fullSchip":"emptySchip"});return e}prepareItems(e){let t=this.toObject(!1),a=[],s=[],i=[],n=[],r=[],o=[],c=[],m=[],d=[],p=[],g=Object.fromEntries(Object.keys(b.specialAbilityCategories).map(w=>[w,[]])),h=Object.fromEntries(Object.keys(b.traitCategories).map(w=>[w,[]])),y=[],v=[],P=[],T=[],R={hasSpells:this.system.isMage,hasPrayers:this.system.isPriest,liturgy:[],spell:[],ritual:[],ceremony:[],blessing:[],magictrick:[],magicalsign:[]},D={spell:{},ritual:{},ceremony:{},liturgy:{}},z=this.hasPlayerOwner?_.getGroupSchips():[],O=this.schipshtml(),I={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},plant:{items:[],show:!1,dataType:"plant"},poison:{items:[],show:!1,dataType:"poison"}};for(let w in b.equipmentTypes)I[w]={items:[],show:!1,dataType:w};I.misc.show=!0;let k={coins:[],total:0,show:!0};t.items=t.items.sort((w,q)=>w.name.localeCompare(q.name));let N=t.system.totalArmor||0,X={body:[],social:[],knowledge:[],trade:[],nature:[]},ye=new Map;for(let w of t.items.filter(q=>q.type=="equipment"&&q.system.equipmentType.value=="bags"))ye.set(w._id,[]);let be=new Map,at=[],_t=!1,pt=j.getHorse(this,!0);for(let w of t.items)try{let q=getProperty(w,"system.parent_id");if(w.type=="ammunition"&&at.push(S._prepareitemStructure(w)),q&&q!=w._id&&ye.has(q)){ye.get(q).push(w);continue}switch(e.details&&e.details.includes(w._id)&&(w.detailed="shown"),w.system.isArtifact&&(w.volume=b.traditionArtifacts[w.system.artifact]||0,w.volumeFinal=0,T.push(w)),w.type){case"skill":X[w.system.group.value].push(this._perpareItemAdvancementCost(w));break;case"information":m.push(w);break;case"aggregatedTest":n.push(w);break;case"spellextension":D[w.system.category][w.system.source]?D[w.system.category][w.system.source].push(w.name):D[w.system.category][w.system.source]=[w.name];break;case"ritual":case"spell":case"liturgy":case"ceremony":R[w.type].push(S.buildSpellChargeProgress(this._perpareItemAdvancementCost(w)));break;case"magicalsign":case"magictrick":case"blessing":R[w.type].push(w);break;case"trait":switch(w.system.traitType.value){case"rangeAttack":w=S._prepareRangeTrait(w);break;case"meleeAttack":w=S._prepareMeleetrait(w);break;case"armor":N+=Number(w.system.at.value);break}h[w.system.traitType.value].push(w),_t=!0;break;case"combatskill":a.push(S._calculateCombatSkillValues(w,this.system));break;case"ammunition":I.ammunition.items.push(S.prepareMag(w)),I.ammunition.show=!0;break;case"meleeweapon":w.toggleValue=w.system.worn.value||!1,w.toggle=!0,this._setOnUseEffect(w),I.meleeweapons.items.push(S._prepareitemStructure(w)),I.meleeweapons.show=!0,w.toggleValue&&c.push(w);break;case"rangeweapon":w.toggleValue=w.system.worn.value||!1,w.toggle=!0,this._setOnUseEffect(w),I.rangeweapons.items.push(S._prepareitemStructure(w)),I.rangeweapons.show=!0;break;case"armor":w.toggleValue=w.system.worn.value||!1,I.armor.items.push(S._prepareitemStructure(w)),I.armor.show=!0,w.toggle=!0,this._setOnUseEffect(w),w.system.worn.value&&(w.system.protection.value=W.armorWearModifier(w,w.system.protection.value),N+=Number(w.system.protection.value),y.push(w));break;case"poison":case"plant":I[w.type].items.push(w),I[w.type].show=!0;break;case"consumable":I[w.system.equipmentType.value].items.push(S._prepareConsumable(w)),I[w.system.equipmentType.value].show=!0;break;case"equipment":w.toggle=getProperty(w,"system.worn.wearable")||!1,w.toggle&&(w.toggleValue=w.system.worn.value||!1),this._setOnUseEffect(w),I[w.system.equipmentType.value].items.push(S._prepareitemStructure(w)),I[w.system.equipmentType.value].show=!0;break;case"money":k.coins.push(w),k.total+=w.system.quantity.value*w.system.price.value;break;case"advantage":this._setOnUseEffect(w),s.push(w);break;case"disadvantage":this._setOnUseEffect(w),i.push(w);break;case"specialability":this._setOnUseEffect(w),this._setAEPayments(w),g[w.system.category.value].push(w);break;case"disease":r.push(w);break;case"patron":g.magical.push(w);break;case"demonmark":o.push(w);break;case"essence":d.push(w);break;case"imprint":p.push(w);break;case"application":be.has(w.system.skill)?be.get(w.system.skill).push(w):be.set(w.system.skill,[w]);break}}catch(q){this._itemPreparationError(w,q)}for(let w of I.bags.items)this._setBagContent(w,ye);for(let[w,q]of Object.entries(D))for(let[Pe,Xt]of Object.entries(q)){let hi=R[w].find(Pi=>Pi.name==Pe);hi?hi.extensions=Xt.join(", "):ui.notifications.warn(game.i18n.format("DSAError.noSpellForExtension",{name:Pe,category:f.categoryLocalization(w),extension:Xt.join(",")}))}for(let w of I.rangeweapons.items)try{w.system.worn.value&&v.push(S._prepareRangeWeapon(w,at,a,this))}catch(q){this._itemPreparationError(w,q)}for(let w of c)try{P.push(S._prepareMeleeWeapon(w,a,t,c.filter(q=>q._id!=w._id&&!_.isYieldedTwohanded(q))))}catch(q){this._itemPreparationError(w,q)}for(let w of Object.values(X))for(let q of w)q.applications=be.get(q.name)||[];k.coins=k.coins.sort((w,q)=>w.system.price.value>q.system.price.value?-1:1),g.magical.push(...g.pact),g.clerical.push(...g.ceremonial);for(let w of g.staff){let q=T.find(Pe=>Pe.system.artifact==w.system.artifact);if(q){q.abilities==null&&(q.abilities=[]),q.abilities.push(w);let Pe=Number(w.system.volume)||0,Xt=Pe>0?"volumeFinal":"volume";q[Xt]+=Math.abs(Pe)*Number(w.system.step.value)}else g.magical.push(w)}let st=duplicate(b.characteristics);return st["-"]="-",{totalWeight:parseFloat(this.system.totalWeight.toFixed(3)),traditionArtifacts:T,armorSum:N,sortedSpecs:b.sortedSpecs,spellArmor:t.system.spellArmor||0,liturgyArmor:t.system.liturgyArmor||0,money:k,encumbrance:this.system.condition?.encumbered||0,carrycapacity:this.system.carrycapacity,isSwarm:this.isSwarm(),canSwarm:!this.prototypeToken.actorLink,wornRangedWeapons:v,wornMeleeWeapons:P,horseActor:pt,advantages:s,disadvantages:i,specAbs:g,information:m,aggregatedtests:n,wornArmor:y,essence:d,imprint:p,inventory:I,hasTrait:_t,demonmarks:o,diseases:r,canBuild:game.dsa5.sheets.DSACharBuilder&&!t.system.details.species?.value,itemModifiers:this.system.itemModifiers,languagePoints:{used:t.system.freeLanguagePoints?.used||0,available:t.system.freeLanguagePoints?.value||0},schips:O,groupschips:z,guidevalues:st,magic:R,traits:h,combatskills:a,canAdvance:this.canAdvance,sheetLocked:t.system.sheetLocked.value,bodyAttrs:["ff","ge","ko","kk"],mentalAttrs:["mu","kl","in","ch"],allSkillsLeft:{body:X.body,social:X.social,nature:X.nature},allSkillsRight:{knowledge:X.knowledge,trade:X.trade}}}isSwarm(){return this.system.swarm.count>1&&!this.prototypeToken.actorLink}getArmorEncumbrance(e,t){let a=t.reduce((i,n)=>(n.system.calculatedEncumbrance=Number(n.system.encumbrance.value)+W.armorEncumbranceModifier(n),n.system.damageToolTip=W.damageTooltip(n),i+=n.system.calculatedEncumbrance),0),s=j.isRiding(this)?-1:0;return Math.max(0,a-L.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance"))+s)}_calcBagweight(e,t,a=!0){let s=0;if(t.has(e._id)){let i=0;!e.system.worn.value&&a&&(s-=e.system.preparedWeight);for(let n of t.get(e._id))n.system.preparedWeight=Number(parseFloat((n.system.weight.value*n.system.quantity.value).toFixed(3))),t.has(n._id)?i+=this._calcBagweight(n,t,!1):i+=n.system.preparedWeight;a?e.system.worn.value&&(s+=i):s+=i+e.system.preparedWeight,e.system.bagweight=`${i.toFixed(3)}/${e.system.capacity}`}return s}_setBagContent(e,t){if(t.has(e._id)){e.children=[];for(let a of t.get(e._id))e.children.push(S._prepareitemStructure(S._prepareConsumable(a))),t.has(a._id)&&this._setBagContent(a,t)}}isMerchant(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}_itemPreparationError(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}_applyModiferTransformations(e){this.system.itemModifiers={};for(let t of Object.keys(e)){let a=game.dsa5.config.knownShortcuts[t.toLowerCase()];if(a){let s=e[t].reduce((i,n)=>i=i+n.value,0);this.system[a[0]][a[1]][a[2]]+=s,this.system.itemModifiers[t]={value:s,sources:e[t].map(i=>i.source)}}}}_buildGearAndAbilityModifiers(e,t){let a=getProperty(t,"system.effect.value");if(!!a)for(let s of a.split(/,|;/).map(i=>i.trim())){let i=s.replace(/(\s+)/g," ").trim().split(" ");if(i.length==2&&!isNaN(i[0])){let n={value:Number(i[0])*(t.system.step&&Number(t.system.step.value)||1),source:t.name,type:t.type};e[i[1]]==null?e[i[1]]=[n]:e[i[1]].push(n)}}}async _updateAPs(e,t={},a={}){if(S.canAdvance(this))if(!isNaN(e)&&e!=null){let s=Number(e);t["system.details.experience.spent"]=Number(this.system.details.experience.spent)+s,await this.update(t,a);let i=game.i18n.format(s>0?"advancementCost":"refundCost",{cost:Math.abs(s)});pe(i)}else ui.notifications.error(game.i18n.localize("DSAError.APUpdateError"))}async checkEnoughXP(e){if(!S.canAdvance(this)||isNaN(e)||e==null||Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=e)return!0;if(Number(this.system.details.experience.total)==0){let t=await renderTemplate("systems/dsa5/templates/dialog/parts/expChoices.html",{entries:b.startXP}),a=0,s=!1;if([s,a]=await new Promise((i,n)=>{new Dialog({title:game.i18n.localize("DSAError.NotEnoughXP"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:r=>{i([!0,r.find(".APsel")[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{i([!1,0])}}}}).render(!0)}),s)return await this.update({"system.details.experience.total":Number(a)}),!0}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughXP")),!1}setupWeapon(e,t,a,s){return a.mode=t,C.getSubClass(e.type).setupDialog(null,a,e,this,s)}setupWeaponless(e,t={},a){let s=foundry.utils.duplicate(b.defaultWeapon);s.name=game.i18n.localize(`${e}Weaponless`),s.system.combatskill={value:game.i18n.localize("LocalizedIDs.wrestle")},s.system.damageThreshold.value=14;let i=[];return L.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyAstralBody"))&&i.push(game.i18n.localize("magical")),L.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyKarmalBody"))&&i.push(game.i18n.localize("blessed")),mergeObject(s,{system:{effect:{attributes:i.join(", ")}}}),t.mode=e,C.getSubClass(s.type).setupDialog(null,t,s,this,a)}setupSpell(e,t={},a){return C.getSubClass(e.type).setupDialog(null,t,e,this,a)}setupSkill(e,t={},a){return C.getSubClass(e.type).setupDialog(null,t,e,this,a)}tokenScrollingText(e){let t=this.isToken?[this.token?.object]:this.getActiveTokens(!0);for(let a of t){if(!a)continue;let s=0;for(let i of e)canvas.interface.createScrollingText(a.center,i.value,{anchor:s,direction:i.value>0?2:1,fontSize:game.settings.get("dsa5","scrollingFontsize"),stroke:i.stroke,strokeThickness:1,jitter:.25,duration:1e3}),s+=1}}async _preUpdate(e,t,a){await super._preUpdate(e,t,a);let s={wounds:9109504,astralenergy:723929,karmaenergy:303670};game.combat?.isBrawling&&(s.temporaryLeP=16525967);let i=[];for(let r of Object.keys(s)){let o=getProperty(e,`system.status.${r}.value`);o&&i.push({value:o-this.system.status[r].value,stroke:s[r]})}i.length&&this.tokenScrollingText(i);let n=getProperty(e,"system.swarm.count");if(n&&!t.skipSwarmUpdate){let r=getProperty(e,"system.status.wounds.value")||this.system.status.wounds.value,o=n-(this.system.swarm.count||1),c=this.system.swarm.maxwounds||this.system.status.wounds.max;setProperty(e,"system.status.wounds.value",Math.max(0,r+o*c))}}async applyDamage(e){if(game.combat?.isBrawling){let t=Math.min(this.system.status.temporaryLeP.max,this.system.status.temporaryLeP.value-e);await this.update({"system.status.temporaryLeP.value":t})}else{let t=Math.min(this.system.status.wounds.max,this.system.status.wounds.value-e);await this.update({"system.status.wounds.value":t})}}async applyRegeneration(e,t,a){let s={"system.status.wounds.value":Math.min(this.system.status.wounds.max,this.system.status.wounds.value+(e||0)),"system.status.karmaenergy.value":Math.min(this.system.status.karmaenergy.max,this.system.status.karmaenergy.value+(a||0)),"system.status.astralenergy.value":Math.min(this.system.status.astralenergy.max,this.system.status.astralenergy.value+(t||0))};await this.update(s)}async applyMana(e,t){let a=t=="AsP"?"astralenergy":"karmaenergy",s=Math.min(this.system.status[a].max,this.system.status[a].value-e);return s>=0?(await this.update({[`data.status.${a}.value`]:s}),!0):(ui.notifications.error(game.i18n.localize(`DSAError.NotEnough${t}`)),!1)}preparePostRollAction(e){let t=e.flags.data,a={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.user};return t.attackerMessage&&(a.attackerMessage=t.attackerMessage),t.defenderMessage&&(a.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(a.unopposedStartMessage=t.unopposedStartMessage),a}resetTargetAndMessage(e,t){e.originalTargets?.size&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}async fatererollDamage(e,t,a,s,i,n){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let r=i.postData.damageRoll,o=await _DiceDSA5.manualRolls(await new Roll(r.formula||r._formula).evaluate({async:!0}),"CHATCONTEXT.rerollDamage");for(let c=0;c<o.dice.length;c++)o.dice[c].options.colorset="black";await _DiceDSA5.showDiceSoNice(o,a.rollMode),ChatMessage.create(f.chatDataSetup(e)),a.damageRoll=duplicate(o),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointDamageRerollUsed":!0}),await this.reduceSchips(n)}async fateisTalented(e,t,a,s,i){t.talentedRerollUsed=!0,this.resetTargetAndMessage(i,t),e=`<h3 class="center"><b>${game.i18n.localize("CHATFATE.fatepointUsed")}</b></h3>
            ${game.i18n.format("CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"})}<br>`;let n=await renderTemplate("systems/dsa5/templates/dialog/isTalentedReroll-dialog.html",{testData:a,postData:i.postData});new Q({title:game.i18n.localize("CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async r=>{let o=r.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(o.length>0){let c=[];for(let p of o){let g=a.roll.terms[p*2];c.push(g.number+"d"+g.faces+"["+g.options.colorset+"]")}c=await _DiceDSA5.manualRolls(await new Roll(c.join("+")).evaluate({async:!0}),"CHATCONTEXT.talentedReroll"),await _DiceDSA5.showDiceSoNice(c,a.rollMode);let m=0,d=[];for(let p of o){let g=a.source.system[`characteristic${p+1}`],h=g?game.i18n.localize(`CHARAbbrev.${g.value.toUpperCase()}`)+" - ":"";d.push(`${h}${a.roll.terms[p*2].results[0].result}/${c.terms[m*2].results[0].result}`),a.roll.terms[p*2].results[0].result=Math.min(c.terms[m*2].results[0].result,a.roll.terms[p*2].results[0].result),m+=1}e+=`<b>${game.i18n.localize("Roll")}</b>: ${d.join(", ")}`,ChatMessage.create(f.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.talentedRerollUsed":!0})}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}async fatereroll(e,t,a,s,i,n){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let r=await renderTemplate("systems/dsa5/templates/dialog/fateReroll-dialog.html",{testData:a,postData:i.postData,singleDie:i.postData.characteristics.length==1});new Q({title:game.i18n.localize("CHATFATE.selectDice"),content:r,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async o=>{let c=o.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let m=[];for(let v of c){let P=a.roll.terms[v*2];m.push(P.number+"d"+P.faces+"["+P.options.colorset+"]")}m=await _DiceDSA5.manualRolls(await new Roll(m.join("+")).evaluate({async:!0}),"CHATCONTEXT.Reroll"),await _DiceDSA5.showDiceSoNice(m,a.rollMode);let d=0,p=[],g=f.getSpeaker(a.extra.speaker),h=game.i18n.localize("LocalizedIDs.traditionPhex"),y=g.items.some(v=>v.type=="specialability"&&v.name==h);for(let v of c){let P=a.source.system[`characteristic${v+1}`],T=P?`${game.i18n.localize(`CHARAbbrev.${P.value.toUpperCase()}`)} - `:"";p.push(`${T}${a.roll.terms[v*2].results[0].result}/${m.terms[d*2].results[0].result}`),y?a.roll.terms[v*2].results[0].result=Math.min(m.terms[d*2].results[0].result,a.roll.terms[v*2].results[0].result):a.roll.terms[v*2].results[0].result=m.terms[d*2].results[0].result,d+=1}e+=`<br><b>${game.i18n.localize("Roll")}</b>: ${p.join(", ")}`,ChatMessage.create(f.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointRerollUsed":!0}),await this.reduceSchips(n)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}async fateaddQS(e,t,a,s,i,n){ChatMessage.create(f.chatDataSetup(e)),game.user.targets.forEach(r=>r.setTarget(!1,{user:game.user,releaseOthers:!1,groupSelection:!0})),t.fatePointAddQSUsed=!0,a.qualityStep=1,this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointAddQSUsed":!0}),await this.reduceSchips(n)}async fateImprove(e,t,a,s,i,n){ChatMessage.create(f.chatDataSetup(e)),this.resetTargetAndMessage(i,t);let r=s.flags.data.preData.source.type;if(["spell","liturgy","ceremony","ritual","skill"].includes(r)){let o=await renderTemplate("systems/dsa5/templates/dialog/fateImprove-dialog.html",{testData:a,postData:i.postData});new Q({title:game.i18n.localize("CHATFATE.selectDice"),content:o,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async c=>{let m=[0,0,0],d=c.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(d.length==1){m[d]=2;let p={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:m.join("|"),type:"roll"};a.roll.terms[d*2].results[0].result=Math.max(1,a.roll.terms[d*2].results[0].result-2),a.situationalModifiers.push(p),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fateImproved":!0}),await this.reduceSchips(n)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else{let o={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:2,type:"roll"};a.situationalModifiers.push(o),a.roll.terms[0].results[0].result=Math.max(1,a.roll.terms[0].results[0].result-2),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fateImproved":!0}),await this.reduceSchips(n)}}async reduceSchips(e){e==0?await this.update({"system.status.fatePoints.value":this.system.status.fatePoints.value-1}):await S.reduceGroupSchip()}static async reduceGroupSchip(){if(game.user.isGM){let e=game.settings.get("dsa5","groupschips").split("/").map(t=>Number(t));e[0]=e[0]-1,await game.settings.set("dsa5","groupschips",e.join("/"))}else game.socket.emit("system.dsa5",{type:"reduceGroupSchip",payload:{}})}async useFateOnRoll(e,t,a){if(t=="isTalented"||f.fateAvailable(this,a==1)){let s=e.flags.data,i=this.preparePostRollAction(e),n,r;a==0?(n=this.system.status.fatePoints.value-1,r="PointsRemaining"):(n=game.settings.get("dsa5","groupschips").split("/")[0],r="GroupPointsRemaining");let o=`<h3 class="center"><b>${game.i18n.localize("CHATFATE.fatepointUsed")}</b></h3>
                ${game.i18n.format("CHATFATE."+t,{character:"<b>"+this.name+"</b>"})}<br>
                <b>${game.i18n.localize(`CHATFATE.${r}`)}</b>: ${n}`,c=s.preData;c.extra.actor=f.getSpeaker(c.extra.speaker).toObject(!1),this[`fate${t}`](o,i,c,e,s,a)}}get horseSpeed(){return j.getHorseSpeed(this)}setupFallingDamage(e,t){let a=game.i18n.localize("fallingDamage"),s=this.items.find(n=>n.type=="skill"&&n.name==game.i18n.localize("LocalizedIDs.bodyControl")).toObject(),i={subtitle:` (${a})`,postFunction:{functionName:"game.dsa5.entities.Actordsa5.updateFallingDamage",options:e,tokenId:t,speaker:C.buildSpeaker(this,t)}};this.setupSkill(s,i,t).then(async n=>{n.testData.opposable=!1;let r=await this.basicTest(n,{suppressMessage:!0});await S.updateFallingDamage(i.postFunction,r),await _DiceDSA5.renderRollCard(r.cardOptions,r.result,r.options.rerenderMessage)})}static async updateFallingDamage(e,t,a){let s=(t.result.qualityStep||0)*2;mergeObject(e.options,{availableQs:s});let i=f.getSpeaker(e.speaker),n=await i._setupFallingHeight(e.options,e.tokenId),r=await i.basicTest(n,{suppressMessage:!0}),o=await renderTemplate("systems/dsa5/templates/chat/roll/fallingdamage-card.html",r);t.result.other||(t.result.other=[]),t.result.other.push(o),t.chatData&&(t.chatData.other=[o])}_setupFallingHeight(e,t){let a=game.i18n.localize("fallingDamage"),s={source:{type:"fallingDamage"},opposable:!1,extra:{actor:this.toObject(!1),options:e,speaker:C.buildSpeaker(this,t)}},i=[],n={title:a,template:"/systems/dsa5/templates/dialog/fallingdamage-dialog.html",data:{rollMode:e.rollMode,situationalModifiers:i,fallingFloorOptions:b.fallingConditions,modifier:e.modifier||0},callback:(o,c={})=>(s.situationalModifiers=[],s.situationalModifiers.push({name:game.i18n.localize("fallingFloor"),value:o.find('[name="fallingFloor"]').val()}),r.rollMode=o.find('[name="rollMode"]').val(),s.fallingHeight=o.find('[name="testModifier"]').val(),mergeObject(s.extra.options,c),{testData:s,cardOptions:r})},r=this._setupCardOptions("systems/dsa5/templates/chat/roll/fallingdamage-card.html",a,t);return _DiceDSA5.setupDialog({dialogOptions:n,testData:s,cardOptions:r})}setupRegeneration(e,t={},a){let s=game.i18n.localize("regenerationTest"),i={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this,a)}};i.extra.actor.isMage=this.system.isMage,i.extra.actor.isPriest=this.system.isPriest;let n=E.getRollModifiers(i.extra.actor,i.source),r={title:s,template:"/systems/dsa5/templates/dialog/regeneration-dialog.html",data:{rollMode:t.rollMode,regenerationInterruptOptions:b.regenerationInterruptOptions,regnerationCampLocations:b.regnerationCampLocations,showAspModifier:this.system.isMage,showKapModifier:this.system.isPriest,situationalModifiers:n,modifier:t.modifier||0},callback:(c,m={})=>{i.situationalModifiers=S._parseModifiers(c),o.rollMode=c.find('[name="rollMode"]').val(),i.situationalModifiers.push({name:game.i18n.localize("camplocation")+" - "+c.find('[name="regnerationCampLocations"] option:selected').text(),value:c.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("interruption")+" - "+c.find('[name="regenerationInterruptOptions"] option:selected').text(),value:c.find('[name="regenerationInterruptOptions"]').val()}),i.regenerationFactor=c.find('[name="badEnvironment"]').is(":checked")?.5:1;let d=["LeP","KaP","AsP"],p={};for(let g of d){i[`${g}Modifier`]=Number(c.find(`[name="${g}Modifier"]`).val()||0),i[`regeneration${g}`]=Number(this.system.status.regeneration[`${g}max`]);let h=c.find(`[name="regenerate${g}"]`).is(":checked")?1:0;i[`regenerate${g}`]=h,h&&(p[`system.status.regeneration.${g}Temp`]=0)}return mergeObject(i.extra.options,m),this.update(p),{testData:i,cardOptions:o}}},o=this._setupCardOptions("systems/dsa5/templates/chat/roll/regeneration-card.html",s,a);return _DiceDSA5.setupDialog({dialogOptions:r,testData:i,cardOptions:o})}setupDodge(e={},t){let a="dodge",s=this.system.status[a],i=game.i18n.localize(a)+" "+game.i18n.localize("Test"),n={source:{system:s,type:a},opposable:!1,extra:{statusId:a,actor:this.toObject(!1),options:e,speaker:C.buildSpeaker(this,t)}},r=[game.i18n.localize(a),game.i18n.localize("LocalizedIDs.wrestle")],o=C.buildCombatSpecAbs(this,["Combat"],r,"parry"),c=E.getRollModifiers(n.extra.actor,n.source),m=C.getDefenseMalus(c,this),d=_.multipleDefenseValue(this,n.source),p={title:i,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:{rollMode:e.rollMode,combatSpecAbs:o,showDefense:!0,situationalModifiers:c,isRangeAttack:m,defenseCountString:game.i18n.format("defenseCount",{malus:d}),isDodge:!0},callback:(h,y={})=>(g.rollMode=h.find('[name="rollMode"]').val(),n.situationalModifiers=S._parseModifiers(h),n.situationalModifiers.push(...C.getSpecAbModifiers(h,"parry")),n.situationalModifiers.push({name:game.i18n.localize("attackFromBehind"),value:h.find('[name="attackFromBehind"]').is(":checked")?-4:0},{name:game.i18n.format("defenseCount",{malus:d}),value:(Number(h.find('[name="defenseCount"]').val())||0)*d},{name:game.i18n.localize("advantageousPosition"),value:h.find('[name="advantageousPosition"]').is(":checked")?2:0}),mergeObject(n.extra.options,y),{testData:n,cardOptions:g})},g=this._setupCardOptions("systems/dsa5/templates/chat/roll/status-card.html",i,t);return _DiceDSA5.setupDialog({dialogOptions:p,testData:n,cardOptions:g})}setupCharacteristic(e,t={},a){let s=duplicate(this.system.characteristics[e]),i=f.attributeLocalization(e)+" "+game.i18n.localize("Test");s.attr=e;let n={opposable:!1,source:{type:"char",system:s},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:C.buildSpeaker(this,a)}},r={title:i,template:"/systems/dsa5/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,difficultyLabels:b.attributeDifficultyLabels,modifier:t.modifier||0},callback:(c,m={})=>(o.rollMode=c.find('[name="rollMode"]').val(),n.testDifficulty=b.attributeDifficultyModifiers[c.find('[name="testDifficulty"]').val()],n.situationalModifiers=S._parseModifiers(c),mergeObject(n.extra.options,m),{testData:n,cardOptions:o})},o=this._setupCardOptions("systems/dsa5/templates/chat/roll/characteristic-card.html",i,a);return _DiceDSA5.setupDialog({dialogOptions:r,testData:n,cardOptions:o})}static _parseModifiers(e,t){let a=[];return e.find('[name="situationalModifiers"] option:selected').each(function(){let s=$(this).val(),i={name:$(this).text().trim().split("[")[0],value:isNaN(s)?s:Number(s),type:$(this).attr("data-type")};i.type=="dmg"&&(i.damageBonus=i.value,i.value=0),$(this).attr("data-specAbId")&&(i.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(i.armorPen=$(this).attr("data-armorPen")),a.push(i)}),a.push({name:game.i18n.localize("manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),a}static _prepareConsumable(e){return e.system.maxCharges&&(e.consumable=!0,e.structureMax=e.system.maxCharges,e.structureCurrent=e.system.charges),e}static prepareMag(e){return e.system.ammunitiongroup.value=="mag"&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}static _prepareitemStructure(e){e.system.structure&&e.system.structure.max!=0&&(e.structureMax=e.system.structure.max,e.structureCurrent=e.system.structure.value);let t=getProperty(e,"flags.dsa5.enchantments");if(t&&t.length>0)e.enchantClass="rar";else if(e.effects.length>0)e.enchantClass="common";else if(e.system.effect&&e.system.effect.value!="")if(e.type=="armor")for(let a of e.system.effect.value.split(/,|;/).map(s=>s.trim())){let s=a.replace(/(\s+)/g," ").trim().split(" ");if(!(s.length==2&&[game.i18n.localize("CHARAbbrev.INI").toLowerCase(),game.i18n.localize("CHARAbbrev.GS").toLowerCase()].includes(s[1].toLowerCase())&&!isNaN(s[0])&&s[0]==-1)){e.enchantClass="common";break}}else e.enchantClass="common";return e}static _prepareMeleetrait(e){return e.attack=Number(e.system.at.value),e.system.pa!=0&&(e.parry=e.system.pa),this._parseDmg(e)}static _prepareMeleeWeapon(e,t,a,s=null){let i=t.find(n=>n.name==e.system.combatskill.value);if(i){e.attack=Number(i.system.attack.value)+Number(e.system.atmod.value);let n=e.system.guidevalue.value.split("/").map(c=>a.system.characteristics[c]?Number(a.system.characteristics[c].initial)+Number(a.system.characteristics[c].modifier)+Number(a.system.characteristics[c].advances)+Number(a.system.characteristics[c].gearmodifier):0),r=Math.ceil(i.system.talentValue.value/2)+Math.max(0,Math.floor((Math.max(...n)-8)/3))+Number(game.settings.get("dsa5","higherDefense"));e.parry=r+Number(e.system.pamod.value)+(_.isShield(e)?Number(e.system.pamod.value):0),e.yieldedTwoHand=_.isYieldedTwohanded(e),e.yieldedTwoHand||(s||(s=duplicate(a.items).filter(c=>c.type=="meleeweapon"&&c.system.worn.value&&c._id!=e._id&&!_.isYieldedTwohanded(c))),s.length>0&&(e.parry+=Math.max(...s.map(c=>c.system.pamod.offhandMod)),e.attack+=Math.max(...s.map(c=>c.system.atmod.offhandMod))));let o=0;if(e.system.worn.wrongGrip)if(e.yieldedTwoHand)e.parry-=1,o=1;else switch(e.system.reach.value="medium",game.i18n.localize(`LocalizedCTs.${e.system.combatskill.value}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":if(e.parry-=3,new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")).test(e.name))o=-2;else{let d=game.i18n.localize("wrongGrip.oneHanded");e.gripDamageText=` (${d} * 0.5)`,e.dmgMultipliers=[{name:d,val:"0.5"}]}break;default:e.parry-=1,o=-1}if(e=this._parseDmg(e),e.system.guidevalue.value!="-"){let c=Math.max(...e.system.guidevalue.value.split("/").map(d=>Number(a.system.characteristics[d].value))),m=Math.max(c-Number(e.system.damageThreshold.value),0)+o;m>0&&(e.extraDamage=m,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(m)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}W.weaponWearModifier(e),e.system.damageToolTip=W.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return e}async actorEffects(){let e=["dead"];return game.user.isGM||this.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects")?this.effects.filter(a=>a.isVisibleEffect()):this.effects.filter(a=>e.some(s=>a.statuses.has(s)))}async _preCreate(e,t,a){await super._preCreate(e,t,a);let s={};e.img||(s.img="icons/svg/mystery-man-black.svg"),e.type=="character"&&mergeObject(s,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(s)}static _prepareRangeTrait(e){return e.attack=Number(e.system.at.value),e.LZ=Number(e.system.reloadTime.value),e.LZ>0&&S.buildReloadProgress(e),this._parseDmg(e)}static calcLZ(e,t){let a=1,s=0;e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Throwing Weapons")?s=L.abilityStep(t,game.i18n.localize("LocalizedIDs.quickdraw"))*-1:e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Crossbows")&&L.hasAbility(t,`${game.i18n.localize("LocalizedIDs.quickload")} (${game.i18n.localize("LocalizedIDs.Crossbows")})`)?a=.5:s=L.abilityStep(t,`${game.i18n.localize("LocalizedIDs.quickload")} (${game.i18n.localize(e.system.combatskill.value)})`)*-1;let i=`${e.system.reloadTime.value}`.split("/");if(e.system.ammunitiongroup.value=="mag"){let n=t.items.find(o=>o.id==e.system.currentAmmo.value||o._id==e.system.currentAmmo.value),r=0;n&&(n=f.toObjectIfPossible(n),n.system.mag.value<=0&&(r=1)),i=i[r]||i[0]}else i=i[0];return Math.max(0,Math.round(Number(i)*a)+s)}static _parseDmg(e,t=void 0){let a=new Roll(e.system.damage.value.replace(/[Ww]/g,"d"),{async:!1}),s="",i="",n="+";for(let r of a.terms)r.faces?s=r.number+"d"+r.faces:r.operator?n=r.operator:r.number&&(i+=Number(`${n}${r.number}`));if(t){let r=getProperty(t,"system.damageMod");Number(r)?i+=`+${Number(r)}`:r&&(e.damageBonusDescription=`, ${r} ${game.i18n.localize("CHARAbbrev.damage")} ${t.name}`)}return i&&(i=Roll.safeEval(i)),e.damagedie=s||"0d6",e.damageAdd=i!=""?(Number(i)>=0?"+":"")+i:"",e}static buildReloadProgress(e){let t=e.system.reloadTime.progress/e.LZ;e.title=game.i18n.format("WEAPON.loading",{status:`${e.system.reloadTime.progress}/${e.LZ}`}),e.progress=`${e.system.reloadTime.progress}/${e.LZ}`,t>=1&&(e.title=game.i18n.localize("WEAPON.loaded")),this.progressTransformation(e,t)}static progressTransformation(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft=`${Math.round(t*360-179)}deg`):(e.transformRight=`${Math.round(t*360+1)}deg`,e.transformLeft=0)}static buildSpellChargeProgress(e){if(e.LZ=Number(e.system.castingTime.modified)||0,e.LZ>1){let t=e.system.castingTime.progress/e.LZ;e.title=game.i18n.format("SPELL.loading",{status:`${e.system.castingTime.progress}/${e.LZ}`}),e.progress=`${e.system.castingTime.progress}/${e.LZ}`,this.progressTransformation(e,t)}return e}static _prepareRangeWeapon(e,t,a,s){let i=a.find(r=>r.name==e.system.combatskill.value);e.calculatedRange=e.system.reach.value;let n;if(i){if(e.attack=Number(i.system.attack.value),e.system.ammunitiongroup.value!="-"&&(e.ammo=t.filter(r=>r.system.ammunitiongroup.value==e.system.ammunitiongroup.value),n=t.find(r=>r._id==e.system.currentAmmo.value),n)){let r=Number(n.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map(o=>Math.round(Number(o)*r)).join("/"),e.attack+=Number(n.system.atmod)||0,n.system.ammunitiongroup.value=="mag"&&(e.ammoMax=n.system.mag.max,e.ammoCurrent=n.system.mag.value)}e.LZ=S.calcLZ(e,s),e.LZ>0&&S.buildReloadProgress(e),W.weaponWearModifier(e),e.system.damageToolTip=W.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return this._parseDmg(e,n)}_setupCardOptions(e,t,a){let s=game.canvas?.tokens?.get(a),i={speaker:{alias:s?s.name:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{let n=ChatMessage.getSpeaker();n.actor==this.id&&(i.speaker.alias=n.alias,i.speaker.token=n.token,i.speaker.scene=n.scene,i.flags.img=n.token?canvas.tokens.get(n.token).img:i.flags.img)}return i}async swapMag(e){let t=this.items.get(e),a=this.items.get(t.system.currentAmmo.value);if(a&&a.system.quantity.value>1)return await this.updateEmbeddedDocuments("Item",[{_id:a.id,"system.quantity.value":a.system.quantity.value-1,"system.mag.value":a.system.mag.max}]),V.playEquipmentWearStatusChange(a),a;ui.notifications.error(game.i18n.localize("DSAError.NoAmmo"))}async payMiracles(e){if(!e.extra.miraclePaid){e.extra.miraclePaid=!0;let t=e.situationalModifiers.some(i=>i.name.trim()==game.i18n.localize("LocalizedIDs.miracleMight")),a=e.situationalModifiers.some(i=>i.name.trim()==game.i18n.localize("LocalizedIDs.miracle")),s=t?6:a?4:0;s&&await this.update({"system.status.karmaenergy.value":this.system.status.karmaenergy.value-s})}}async consumeAmmunition(e){if(e.extra.ammo&&!e.extra.ammoDecreased){if(e.extra.ammoDecreased=!0,e.extra.ammo._id){let t={_id:e.extra.ammo._id};e.extra.ammo.system.ammunitiongroup.value=="mag"?e.extra.ammo.system.mag.value<=0?(e.extra.ammo.system.quantity.value--,t["system.quantity.value"]=e.extra.ammo.system.quantity.value,t["system.mag.value"]=e.extra.ammo.system.mag.max-1):t["system.mag.value"]=e.extra.ammo.system.mag.value-1:(e.extra.ammo.system.quantity.value--,t["system.quantity.value"]=e.extra.ammo.system.quantity.value),await this.updateEmbeddedDocuments("Item",[t,{_id:e.source._id,"system.reloadTime.progress":0}])}}else(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType.value=="rangeAttack")&&!e.extra.ammoDecreased?(e.extra.ammoDecreased=!0,await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":0}])):["spell","liturgy"].includes(e.source.type)&&e.extra.speaker.token!="emptyActor"&&await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}])}_checkMaximumItemAdvancement(e,t){let a=0;switch(e.type){case"combatskill":a=Math.max(...e.system.guidevalue.value.split("/").map(o=>this.system.characteristics[o].value))+2+x.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalCombatTechnique")} (${e.name})`);break;case"spell":case"ritual":let i=0;for(let o of e.system.feature.replace(/\(a-z \-\)/gi,"").split(",").map(c=>c.trim()))if(L.hasAbility(this,`${game.i18n.localize("LocalizedIDs.propertyKnowledge")} (${o})`)){i=this.maxByAttr(e);break}a=Math.max(14+x.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`),i);break;case"liturgy":case"ceremony":let n=new RegExp(`^${game.i18n.localize("LocalizedIDs.aspectKnowledge")}`),r=0;this.items.filter(o=>o.type=="specialability"&&n.test(o.name)).some(o=>e.system.distribution.value.includes(o.name.split("(")[1].split(")")[0]))&&(r=this.maxByAttr(e)),a=Math.max(14+x.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`),r);break;case"skill":a=this.maxByAttr(e);break}let s=t<=a;return s||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),{result:s,max:a}}maxByAttr(e){return Math.max(this.system.characteristics[e.system.characteristic1.value].value,this.system.characteristics[e.system.characteristic2.value].value,this.system.characteristics[e.system.characteristic3.value].value)+2+x.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`)}async basicTest({testData:e,cardOptions:t},a={}){e=await _DiceDSA5.rollDices(e,t);let s=await _DiceDSA5.rollTest(e);if(e.extra.options.other&&(s.other||(s.other=[]),s.other.push(...e.extra.options.other)),s.postFunction="basicTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}if(await this.consumeAmmunition(e),await this.payMiracles(e),!a.suppressMessage){let i=await _DiceDSA5.renderRollCard(t,s,a.rerenderMessage);await H.handleOpposedTarget(i),s.messageId=i.id}return{result:s,cardOptions:t,options:a}}async addCondition(e,t=1,a=!1,s=!0){if(e=="bleeding"||e.id=="bleeding")return await _.bleedingMessage(this);if(this.isToken&&!this.token?.object){console.warn("Actor token object is null for",this.name);return}return await E.addCondition(this,e,t,a,s)}async addTimedCondition(e,t=1,a=!1,s=!0,i={}){return e=="bleeding"||e.id=="bleeding"?await _.bleedingMessage(this):(typeof e=="string"&&i.duration&&(e=duplicate(CONFIG.statusEffects.find(n=>n.id==e)),e.flags.dsa5.description=game.i18n.localize(e.name),e.name=game.i18n.localize(e.name),delete e.description,delete e.flags.dsa5.value,delete e.flags.dsa5.max,delete e.id,mergeObject(e,i)),await E.addCondition(this,e,t,a,s))}async initResistPainRoll(e){let t=game.settings.get("dsa5","selfControlOnPain");if(this.hasCondition("incapacitated"))return;if(t==2||t==1&&!this.hasPlayerOwner){await this.addCondition("incapacitated");return}let a=await renderTemplate("systems/dsa5/templates/chat/roll/resist-pain.html",{actor:this});await ChatMessage.create(f.chatDataSetup(a))}async finishResistPainRoll(){let e=this.items.find(t=>t.name==game.i18n.localize("LocalizedIDs.selfControl")&&t.type=="skill");this.setupSkill(e,{subtitle:` (${game.i18n.localize("ActiveEffects.resistRoll")})`},this.token?.id).then(async t=>{((await this.basicTest(t)).result.successLevel||0)<1&&this.addCondition("incapacitated")})}async removeCondition(e,t=1,a=!0,s=!1){return await E.removeCondition(this,e,t,a,s)}hasCondition(e){return E.hasCondition(this,e)}async markDead(e){let t=this.getActiveTokens();for(let a of t)a.combatant&&await a.combatant.update({defeated:e})}};u(S,"Actordsa5");function Ai(){let l={Rq:"roll",Gc:"GC",Ch:"CH"},e={Rq:"dice",Gc:"dice",Ch:"user-shield",AP:"trophy",Pay:"coins",GetPaid:"piggy-bank"},t={Rq:"",Gc:`${game.i18n.localize("HELP.groupcheck")} `,Ch:"",AP:"",Pay:"",GetPaid:""},a=/(-|\+)?\d+/,s=/(-|\+)?\d+(\.\d+)?/,i=/\[[a-zA-Z&; -]+/,n=/[\[\]]/g,r={Pay:game.i18n.localize("PAYMENT.payButton"),GetPaid:game.i18n.localize("PAYMENT.getPaidButton"),AP:game.i18n.localize("MASTER.awardXP")};if(!b.statusRegex){let o=b.statusEffects.map(m=>game.i18n.localize(m.name).toLowerCase()),c=["status","condition","level","levels"].map(m=>game.i18n.localize(m)).join("|");b.statusRegex={effects:o,regex:new RegExp(`(${c}) (${o.join("|")})`,"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Gc|Ch)\[[a-zA-Z&; -]+ (-|\+)?\d+\]({[a-zA-Z\(\)&; -]+})?/g,enricher:(o,c)=>{let m=o[0],d=o[1],p=Number(m.match(a)[0]),g=m.replace(p,"").match(i)[0].replace(n,"").trim(),h=m.match(/\{.*\}/)?m.match(/\{.*\}/)[0].replace(/[\{\}]/g,""):g;return $(`<a class="roll-button request-${l[d]}" data-type="skill" data-modifier="${p}" data-name="${g}" data-label="${h}"><em class="fas fa-${e[d]}"></em>${t[d]}${h} ${p}</a>`)[0]}},{pattern:/@(Pay|GetPaid|AP)\[(-|\+)?\d+(\.\d+)?\]({[a-zA-Z\(\)&; -]+})?/g,enricher:(o,c)=>{let m=o[0],d=o[1],p=Number(m.match(s)[0]),g=m.match(/\{.*\}/)?m.match(/\{.*\}/)[0].replace(/[\{\}]/g,""):r[d];return $(`<a class="roll-button request-${d}" data-type="skill" data-modifier="${p}" data-label="${g}"><em class="fas fa-${e[d]}"></em>${t[d]}${g} (${p})</a>`)[0]}},{pattern:b.statusRegex.regex,enricher:(o,c)=>$(Qs(o))[0]},{pattern:/@Info\[[a-zA-Z&; -\.0-9]+\]/g,enricher:async(o,c)=>{let m=o[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),d=await fromUuid(m);if(!d||d.type!="information")return $('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0];if(!game.user.isGM)return $(`<a class="content-link"><i class="fas fa-mask"></i>${game.i18n.localize("GM notes")}</a>`)[0];let p={enrichedqs1:await TextEditor.enrichHTML(d.system.qs1,{async:!0}),enrichedqs2:await TextEditor.enrichHTML(d.system.qs2,{async:!0}),enrichedqs3:await TextEditor.enrichHTML(d.system.qs3,{async:!0}),enrichedqs4:await TextEditor.enrichHTML(d.system.qs4,{async:!0}),enrichedqs5:await TextEditor.enrichHTML(d.system.qs5,{async:!0}),enrichedqs6:await TextEditor.enrichHTML(d.system.qs6,{async:!0}),enrichedCrit:await TextEditor.enrichHTML(d.system.crit,{async:!0}),enrichedBotch:await TextEditor.enrichHTML(d.system.botch,{async:!0}),enrichedFail:await TextEditor.enrichHTML(d.system.fail,{async:!0})},g=await renderTemplate("systems/dsa5/templates/items/infopreview.html",{item:d,enriched:p});return $(g)[0]}},{pattern:/@EmbedItem\[[a-zA-Z&;, -\.0-9\/]+\]({[a-zA-Z=]+})?/g,enricher:async(o,c)=>{let m=o[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),d=await fromUuid(m);if(!d){let P=m.split("."),T=game.packs.get(P[0]+"."+P[1]);T&&(d=await T.getDocuments({name:P[2]}),d=d[0])}if(!d)return $('<a class="content-link broken"><i class="fas fa-unlink"></i></a>')[0];let p=o[0],g=p.match(/\{.*\}/)?p.match(/\{.*\}/)[0].replace(/[\{\}]/g,""):"",h={};if(g)for(let P of g.split(" ")){let T=P.split("=");T.length==2&&(h[T[0]]=T[1])}let y=`systems/dsa5/templates/items/browse/${d.type}.html`,v=await renderTemplate(y,{document:d,isGM:game.user.isGM,...await d.sheet.getData(),...h});return $(v)[0]}},{pattern:/@PostChat\[(.*?)\]/g,enricher:async(o,c)=>{let m=o[1];return $(`<div class="row-section wrap maskfield postChatSection"><div class="col ninety"></div><div class="col ten center postContentChat" data-tooltip="SHEET.PostItem"><em class="far fa-comment-dots"></em></div><div class="col postChatContent">${m}</div></div>`)[0]}})}u(Ai,"setEnrichers");function Qs(l){let t=l[0].split(" "),a=t.shift();t=t.join(" ");let s=b.statusEffects[b.statusRegex.effects.indexOf(t.toLowerCase())];return`<span>${a} <a class="chatButton chat-condition" data-id="${s.id}"><img src="${s.icon}"/>${t}</a></span>`}u(Qs,"conditionsMatcher");var f=class{static async skillByName(e){let t=game.packs.get(game.i18n.lang=="de"?"dsa5.skills":"dsa5.skillsen");await t.getIndex();let a=t.index.find(s=>s.name===e);return await t.getDocument(a._id)}static async allSkills(){let e=game.i18n.lang=="de"?"dsa5.skills":"dsa5.skillsen";return await this.getCompendiumEntries(e,"skill")}static moduleEnabled(e){return game.modules.get(e)&&game.modules.get(e).active}static async allCombatSkills(){let e=game.i18n.lang=="de"?"dsa5.skills":"dsa5.skillsen";return await this.getCompendiumEntries(e,"combatskill")}static async getCompendiumEntries(e,t){let a=await game.packs.get(e);if(!a)return ui.notifications.error("No content found");let s=Array.isArray(t)?t:[t];return(await a.getDocuments()).filter(n=>s.includes(n.type)).map(n=>n.toObject())}static renderToggle(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}static calcTokenSize(e,t){let a=game.dsa5.config.tokenSizeCategories[e.system.status.size.value];if(a)if(a<1)mergeObject(t,{texture:{scaleX:a,scaleY:a},width:1,height:1});else{let s=Math.floor(a),i=Math.max(a/s,.25);mergeObject(t,{width:s,height:s,texture:{scaleX:i,scaleY:i}})}}static async allMoneyItems(){return(await this.getCompendiumEntries("dsa5.money","money")).map(t=>(t.system.quantity.value=0,t)).filter(t=>Object.values(b.moneyNames).map(a=>a.toLowerCase()).includes(t.name.toLowerCase())).sort((t,a)=>t.system.price.value>a.system.price.value?-1:1)}static async allSkillsList(){return(await this.allSkills()||[]).map(e=>e.name).sort((e,t)=>e.localeCompare(t))}static async allCombatSkillsList(e){return((await this.allCombatSkills()).filter(t=>t.system.weapontype.value==e)||[]).map(t=>t.name).sort((t,a)=>t.localeCompare(a))}static async callItemTransformationMacro(e,t,a,s={}){let i=e.split("."),n=game.packs.get(`${i[0]}.${i[1]}`);if(!n)return console.warn(`Pack ${n} not found`),{};let r=await n.getDocuments({name:i[2]}),o={};if(r.length){let c=Object.getPrototypeOf(async function(){}).constructor,m=new c("args","source","effect",r[0].command);try{s.result=o,await m.call(this,s,t,a)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),o.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:e}));return o}static isActiveGM(){return game.users.activeGM?.isSelf}static parseAbilityString(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:e.match(/[-+]\d{1,2}$/)!=null}}static categoryLocalization(e){return game.i18n.localize(`TYPES.Item.${e}`)}static attributeLocalization(e){return game.i18n.localize(`CHAR.${e.toUpperCase()}`)}static attributeAbbrLocalization(e){return game.i18n.localize(`CHARAbbrev.${e.toUpperCase()}`)}static async callAsyncHooks(e,t){for(let a of b.asyncHooks[e])await a(...t)}static chatDataSetup(e,t,a,s){let i={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(i.rollMode)&&(i.whisper=ChatMessage.getWhisperRecipients("GM").map(n=>n.id)),i.rollMode==="blindroll"?i.blind=!0:i.rollMode==="selfroll"&&(i.whisper=[game.user]),a&&(i.speaker=ChatMessage.getSpeaker(),i.whisper=ChatMessage.getWhisperRecipients(a)),s&&(i.speaker=ChatMessage.getSpeaker(),i.whisper=s),i}static getSpeaker(e){let t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){let a=canvas.tokens.get(e.token);a&&(t=a.actor)}if(!t){let a=game.scenes.get(e.scene);try{a&&(t=new Token(a.getEmbeddedDocument("Token",e.token))?.actor)}catch{}}return t}static fateAvailable(e,t){return t?game.settings.get("dsa5","groupschips").split("/").map(a=>Number(a))[0]>0:e.system.status.fatePoints.value>0}static _calculateAdvCost(e,t,a=1){return b.advancementCosts[t][Number(e)+a]}static async getFolderForType(e,t=null,a=null,s=0,i="",n=void 0){let r=await game.folders.contents.find(o=>o.name==a&&o.type==e&&o.folder?.id==t);return r||(r=await Folder.create({name:a,type:e,sorting:n||(e=="JournalEntry"?"a":"m"),color:i,sort:s,parent:t})),r}static toObjectIfPossible(e){return typeof e.toObject=="function"?e.toObject(!1):duplicate(e)}static async showArtwork({img:e,name:t,uuid:a,isOwner:s},i=!1){return new ImagePopout(e,{title:i?s?t:"-":t,shareable:!0,uuid:a}).render(!0)}static async findAnyItem(e){let t=[],a=e.map(i=>i.name),s=e.map(i=>i.type);for(let i of game.items.contents){let n=a.indexOf(i.name);if(n>=0&&s[n]==i.type&&(a.splice(n,1),s.splice(n,1),t.push(i.toObject())),a.length<=0)break}if(a.length>0){let i=/^dsa5-core/,n=Array.from(game.packs.keys()).sort((r,o)=>(i.test(r)&&i.test(o)&&r.localeCompare(o),i.test(o)?-1:i.test(r)?1:r.localeCompare(o)));for(let r of n){let o=game.packs.get(r);if(o.documentName=="Item"&&(game.user.isGM||!o.private)&&(await o.getDocuments({name__in:a,type__in:s}).then(c=>{for(let m of c){let d=a.indexOf(m.name);d>=0&&s[d]==m.type&&(a.splice(d,1),s.splice(d,1),t.push(m.toObject()))}}),a.length<=0))break}}return t}static replaceDies(e,t=!1){let a=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,s=t?"":"/r ";return e.replace(a,function(i){return` [[${s}${i.replace(/[DwW]/,"d")}]]`})}static escapeRegex(e){return(typeof e=="string"||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static replaceConditions(e){return e&&e.replace(b.statusRegex.regex,t=>Qs([t]))}static experienceDescription(e){let t=[2100,1700,1400,1200,1100,1e3],a=["EXP.legendary","EXP.brillant","EXP.masterful","EXP.competent","EXP.experienced","EXP.average"],s=0;for(let i of t){if(Number(e)>=Number(i))return a[s];s++}return"EXP.inexperienced"}static async emptyActor(e=12,t="Alrik"){Array.isArray(e)||(e=[e,e,e,e,e,e,e,e]);let a=await S.create({name:t,type:"npc",items:[],system:{status:{wounds:{value:50},fatePoints:{}},characteristics:{mu:{initial:e[0]},kl:{initial:e[1]},in:{initial:e[2]},ch:{initial:e[3]},ff:{initial:e[4]},ge:{initial:e[5]},ko:{initial:e[6]},kk:{initial:e[7]}}}},{temporary:!0,noHook:!0});return a.prepareData(),a}};u(f,"DSA5_Utility");var Ae=class{static async showDialog(e,t=!1){let[a]=await new Promise((s,i)=>{let n={Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("update"),callback:()=>{s([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{s([!1])}}};t&&(n.migrateAll={icon:'<i class="fas fa-exclamation-triangle "></i>',label:game.i18n.localize("replace"),callback:()=>{s([2])}}),new Dialog({title:game.i18n.localize("Migrakel.Migration"),content:e,default:"yes",buttons:n,close:()=>{s([!1])}}).render(!0)});return a}static async refreshStatusEffects(e){let t=[];for(let a of e.effects)a.origin&&t.push(a.id);await e.deleteEmbeddedDocuments("ActiveEffect",t)}static async updateVals(e,t,a){let s=game.dsa5.itemLibrary,i=[],n=[],r=new Map;if(await this.refreshStatusEffects(e),t({type:"equipment"})){let o=[],c=[];for(let d of e.items.filter(p=>p.type=="equipment"&&p.system.equipmentType.value=="bags")){let p=await s.findCompendiumItem(d.name,d.type);if(p.length>0){if(p=p.find(h=>h.name==d.name&&h.type==d.type),!p)continue;console.log(`MIGRATION - Updated ${d.name}`);let g=mergeObject(d.toObject(),a(p));c.push(g),o.push(d.id)}}let m=await e.createEmbeddedDocuments("Item",c);for(let d=0;d<m.length;d++)r.set(o[d],m[d].id);await e.deleteEmbeddedDocuments("Item",o)}for(let o of e.items.filter(c=>t(c)&&!(c.type=="equipment"&&c.system.equipmentType.value=="bags"))){let c=await s.findCompendiumItem(o.name,o.type);if(c.length>0){if(c=c.find(d=>d.name==o.name&&d.type==o.type),!c)continue;console.log(`MIGRATION - Updated ${o.name}`);let m=mergeObject(o.toObject(),a(c));m.system.parent_id&&r.has(m.system.parent_id)&&(m.system.parent_id=r.get(m.system.parent_id)),n.push(m),i.push(o.id)}}await e.createEmbeddedDocuments("Item",n),await e.deleteEmbeddedDocuments("Item",i),Ae.silent||ui.notifications.notify(game.i18n.localize("Migrakel.migrationDone"))}static async updateSpellsAndLiturgies(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.spells"),!0),s=u(i=>["spell","liturgy","ritual","ceremony","spellextension"].includes(i.type),"condition");if(a==2){let i=u(n=>{let r=n.toObject();return delete r.system.talentValue,r},"updator");await this.updateVals(e,s,i)}else if(a){let i=u(n=>{let r={effects:n.effects.toObject()};return n.type!="spellextension"&&(r.system={effectFormula:{value:n.system.effectFormula.value}}),r},"updator");await this.updateVals(e,s,i)}return a}static async updateSpecialAbilities(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.abilities"));if(a){let s=u(n=>{let r={system:{effect:{value:n.system.effect.value}},effects:n.effects.toObject()};return n.type=="specialability"&&(mergeObject(r,{system:{category:{sub:n.system.category.sub||0},list:{value:n.system.list.value},effect:{value2:getProperty(n,"system.effect.value2")||"",value3:getProperty(n,"system.effect.value3")||""}}}),n.system.category.value=="staff"&&mergeObject(r,{system:{feature:getProperty(n,"system.feature")||"",AsPCost:getProperty(n,"system.AsPCost")||"",volume:Number(getProperty(n,"system.volume"))||0,artifact:getProperty(n,"system.artifact")||"",permanentEffects:getProperty(n,"system.permanentEffects")||!1}})),this.updateMacro(r,n),r},"updator"),i=u(n=>["specialability","advantage","disadvantage","trait"].includes(n.type),"condition");await this.updateVals(e,i,s)}return a}static async updateCombatskills(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.cskills"));if(a){let s=u(n=>({effects:n.effects.toObject()}),"updator"),i=u(n=>["combatskill"].includes(n.type),"condition");await this.updateVals(e,i,s)}return a}static async updateSkills(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.skills"));if(a){let s=u(n=>["skill"].includes(n.type),"condition"),i=u(n=>({img:n.img,effects:n.effects.toObject()}),"updator");await this.updateVals(e,s,i)}return a}static updateMacro(e,t){let a=t.getFlag("dsa5","onUseEffect");a&&mergeObject(e,{flags:{dsa5:{onUseEffect:a}}})}static async updateGear(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.gear"));if(a){let s=u(n=>["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(n.type),"condition"),i=u(n=>{let r={img:n.img,effects:n.effects.toObject()};return["poison","consumable"].includes(n.type)||mergeObject(r,{system:{effect:{value:n.system.effect.value}}}),["armor"].includes(n.type)&&mergeObject(r,{system:{subcategory:n.system.subcategory}}),["meleeweapon","rangeweapon","armor"].includes(n.type)&&mergeObject(r,{system:{structure:{max:n.system.structure.max,value:n.system.structure.value}}}),this.updateMacro(r,n),r},"updator");await this.updateVals(e,s,i)}return a}};u(Ae,"Migrakel");var Ue=class extends Dialog{constructor(e,t){super(t),this.actor=e,this.lock=!1}static async buildDialog(e){let t=await renderTemplate("systems/dsa5/templates/actors/parts/actorConfig.html",{actor:e});new Ue(e,{title:game.i18n.localize("SHEET.actorConfig"),content:t,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Save"),callback:a=>{e.update({"system.config.autoBar":a.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":a.find('[name="autoSize"]').is(":checked")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async updateWrapper(e,t){if(this.lock)return;u(async()=>{this.lock=!0,$(t.currentTarget).prepend('<i class="fas fa-spinner fa-spin"></i>'),await Ae[e](this.actor),$(t.currentTarget).find("i").remove(),this.lock=!1},"upd")()}activateListeners(e){super.activateListeners(e),e.find(".updateSpells").click(async t=>this.updateWrapper("updateSpellsAndLiturgies",t)),e.find(".updateAbilities").click(async t=>this.updateWrapper("updateSpecialAbilities",t)),e.find(".updatecSkills").click(async t=>this.updateWrapper("updateCombatskills",t)),e.find(".updateSkills").click(async t=>this.updateWrapper("updateSkills",t)),e.find(".updateGear").click(async t=>this.updateWrapper("updateGear",t))}};u(Ue,"DialogActorConfig");function lt(l,e="img"){!game.user.isGM||l.find(e).each(function(t,a){a.setAttribute("draggable",!0),a.addEventListener("dragstart",s=>Bi(s))})}u(lt,"bindImgToCanvasDragStart");var Bi=u(l=>{canvas.tiles.activate();let e=l.currentTarget.src,t=l.currentTarget,a=canvas.dimensions.sceneHeight/t.naturalHeight,s=canvas.dimensions.sceneWidth/t.naturalWidth,i=Math.min(1,s,a),n=Math.round(canvas.dimensions.size/i),r={type:"Tile",texture:{src:e},tileSize:n};l.dataTransfer.setData("text/plain",JSON.stringify(r));let o=t.naturalWidth*i*canvas.stage.scale.x,c=t.naturalHeight*i*canvas.stage.scale.y,m=DragDrop.createDragImage(t,o,c);l.dataTransfer.setDragImage(m,o/2,c/2)},"dragTileImg");var Tt=class extends FormApplication{constructor(e,t,a){super(),this.editfield=t,this.actorId=e,this.fieldname=a;let s=game.actors.get(this.actorId);this.object={fieldContent:getProperty(s,this.editfield)}}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0,width:600,height:600}),e}isEditable(){return!0}get title(){return`${game.actors.get(this.actorId).name} - ${game.i18n.localize(this.fieldname)}`}async _updateObject(e,t){game.socket.emit("system.dsa5",{type:"updateKeepField",payload:{actorId:this.actorId,field:this.editfield,updateData:t.fieldContent}})}async getData(e){let t=super.getData(e);return mergeObject(t,{fieldContent:this.object.fieldContent}),t}get template(){return"systems/dsa5/templates/dialog/foreignfieldeditor.html"}activateListeners(e){super.activateListeners(e)}};u(Tt,"ForeignFieldEditor");var de=class extends Application{static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsa5/templates/actors/merchant/merchant-trade.html",e.width=900,e.resizable=!0,e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],e.title=game.i18n.localize("MERCHANT.exchange"),e.classes.push("noscrollWizard"),e}constructor(e,t,a={}){super(),this.tradeData={offered:{},offer:{},id:a.id||randomID(),sourceId:e,targetId:t,offerAccepted:!1,offeredAccepted:!1}}async startTrade(){game.socket.emit("system.dsa5",{type:"startTrade",payload:{sourceId:this.tradeData.sourceId,targetId:this.tradeData.targetId,id:this.tradeData.id}}),this.render(!0)}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async getData(){let e=await super.getData(),t=f.getSpeaker(this.tradeData.sourceId),a=t.prepareItems({details:[]});a.inventory.money={items:a.money.coins.map(s=>(s.name=game.i18n.localize(s.name),s)),show:!0,dataType:"money"};for(let s of Object.values(a.inventory))for(let i of s.items)this.tradeData.offer[i._id]&&(i.system.quantity.value-=this.tradeData.offer[i._id].system.quantity.value);return mergeObject(e,{tradeData:this.tradeData,actor:f.getSpeaker(this.tradeData.targetId),tradeFriend:t,inventory:a}),e}static findTradeApp(e){for(let t of Object.values(ui.windows))if(t instanceof this&&t?.tradeData?.id===e)return t;return!1}async close(e={}){return e.skipSocket||game.socket.emit("system.dsa5",{type:"tradeCanceled",payload:{id:this.tradeData.id}}),super.close(e)}activateListeners(e){super.activateListeners(e),e.find(".trade").click(s=>this._offerItem(s));let t=u(s=>this._filterGear($(s.currentTarget)),"filterGear");e.find(".item-edit").click(s=>this._editItem(s,this.tradeData.sourceId)),e.find(".item-external-edit").click(s=>this._editItem(s,this.tradeData.targetId)),e.find(".acceptTrade").click(s=>this.acceptTrade(s));let a=e.find(".gearSearch");a.keyup(s=>t(s)),a[0]&&a[0].addEventListener("search",t,!1)}_editItem(e,t){f.getSpeaker(t).items.get(e.currentTarget.dataset.itemId).sheet.render(!0)}_offerItem(e){if(this.tradeData.offerAccepted)return;let t=e.currentTarget.dataset.itemId,s=f.getSpeaker(this.tradeData.sourceId).items.get(t),i=e.ctrlKey?10:1,n=e.currentTarget.dataset.stopTrade,r=n?this.tradeData.offer[t].system.quantity.value:s.system.quantity.value;s&&(n?(this.tradeData.offer[t].system.quantity.value-=Math.min(i,r),this.tradeData.offer[t].system.quantity.value<=0&&delete this.tradeData.offer[t],this.offerChanged(),this.render()):(this.tradeData.offer[t]?r-=this.tradeData.offer[t].system.quantity.value:(this.tradeData.offer[t]=s.toObject(),this.tradeData.offer[t].system.quantity.value=0),r>0&&(this.tradeData.offer[t].system.quantity.value+=Math.min(i,r),this.offerChanged(),this.render())),V.playMoneySound())}async offerChanged(){game.socket.emit("system.dsa5",{type:"receiveOfferedItems",payload:{id:this.tradeData.id,trader:this.tradeData.sourceId,offered:this.tradeData.offer}})}static receiveOfferedItems(e){let t=this.findTradeApp(e.payload.id);t&&(e.payload.trader==t.tradeData.sourceId?(t.tradeData.offer=e.payload.offered,t.tradeData.offerAccepted=!1):(t.tradeData.offered=e.payload.offered,t.tradeData.offeredAccepted=!1),t.render())}static isGMTrade(e){return game.user.isGM&&!e.hasPlayerOwner}static isPlayerTrade(e){return!game.user.isGM&&e.isOwner}static socketStartTrade(e){let t=f.getSpeaker(e.payload.targetId);(this.isGMTrade(t)||this.isPlayerTrade(t))&&new de(e.payload.targetId,e.payload.sourceId,{id:e.payload.id}).render(!0)}acceptTrade(){this.tradeData.offerAccepted=!this.tradeData.offerAccepted,this.render(!0),game.socket.emit("system.dsa5",{type:"acceptTrade",payload:{id:this.tradeData.id,accepted:this.tradeData.offerAccepted}})}static tradeWasAccepted(e){let t=this.findTradeApp(e.payload.id);t&&(t.tradeData.offeredAccepted=e.payload.accepted,t.tradeData.offerAccepted&&t.tradeData.offeredAccepted?(t.finishTrade(),V.playMoneySound()):t.render())}async finishTrade(){f.isActiveGM()&&await de.updateData(this.tradeData),game.socket.emit("system.dsa5",{type:"tradeFinished",payload:{id:this.tradeData.id,tradeData:this.tradeData}}),this.close({skipSocket:!0}),V.playMoneySound()}static async updateData(e){let t=f.getSpeaker(e.sourceId),a=f.getSpeaker(e.targetId);await this.modifyActor(t,e.offer,e.offered),await this.modifyActor(a,e.offered,e.offer)}static async modifyActor(e,t,a){let s=[],i=[];for(let n of Object.keys(t)){let r=e.items.get(n);r&&(r.system.quantity.value<=t[n].system.quantity.value&&r.type!="money"?s.push(n):i.push({_id:n,"system.quantity.value":r.system.quantity.value-t[n].system.quantity.value}))}await e.deleteEmbeddedDocuments("Item",s,{render:!1}),await e.updateEmbeddedDocuments("Item",i,{render:!1});for(let n of Object.values(a))await e.sheet._manageDragItems(n,n.type)}static tradeWasFinished(e){let t=this.findTradeApp(e.payload.id);f.isActiveGM()&&de.updateData(e.payload.tradeData),t&&t.close({skipSocket:!0})}static tradeWasCanceled(e){let t=this.findTradeApp(e.payload.id);t&&t.close({skipSocket:!0})}static socketListeners(e){switch(e.type){case"receiveOfferedItems":return this.receiveOfferedItems(e),!0;case"startTrade":return this.socketStartTrade(e),!0;case"acceptTrade":return this.tradeWasAccepted(e),!0;case"tradeCanceled":return this.tradeWasCanceled(e),!0;case"tradeFinished":return this.tradeWasFinished(e),!0}}};u(de,"Trade");var Ut=class extends Application{constructor(e,t){super(t),this.actorId=C.buildSpeaker(e,e.token?.id)}async getData(e){let t=await super.getData(e);return t.actors=game.actors.filter(a=>a.hasPlayerOwner&&a.id!=this.actorId.actor),t}static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsa5/templates/actors/merchant/merchant-tradeoptions.html",e.resizable=!0,e.title=game.i18n.localize("MERCHANT.exchange"),e}_startTrade(e){let t=game.actors.get(e.currentTarget.dataset.id);new de(this.actorId,C.buildSpeaker(t,t.token?.id)).startTrade(),this.close()}activateListeners(e){super.activateListeners(e),e.find(".startTrade").on("dblclick",t=>this._startTrade(t))}};u(Ut,"TradeOptions");var ie=class extends Application{static registerTokenHotbar(){game.dsa5.apps.tokenHotbar||(game.dsa5.apps.tokenHotbar=new ie,game.dsa5.apps.tokenHotbar.updateDSA5Hotbar(),game.dsa5.apps.tokenHotbar.render(!0),Hooks.call("dsa5TokenHotbarReady",game.dsa5.apps.tokenHotbar))}static unregisterTokenHotbar(){game.dsa5.apps.tokenHotbar&&(game.dsa5.apps.tokenHotbar.close(),game.dsa5.apps.tokenHotbar=void 0)}constructor(e){if(super(e),this.searching="",this.combatSkills=["selfControl","featOfStrength","bodyControl","perception","loyalty"].map(a=>game.i18n.localize(`LocalizedIDs.${a}`)),this.defaultSkills=[game.i18n.localize("LocalizedIDs.perception")],game.user.isGM){this.callbackFunctions={};let a=game.settings.get("dsa5","enableMasterTokenFunctions");this.gmItems=[{name:"gmMenu",disabled:a.masterMenu,icon:"systems/dsa5/icons/categories/DSA-Auge.webp",id:"masterMenu",cssClass:"gm",abbrev:"",subfunction:"gm"},{name:"MASTER.randomPlayer",disabled:a.randomVictim,iconClass:"fa fa-dice-six",id:"randomVictim",cssClass:"gm",abbrev:"",subfunction:"gm"},{name:"TT.tokenhotbarMoney",disabled:a.payMoney,icon:"systems/dsa5/icons/money-D.webp",id:"payMoney",cssClass:"gm",abbrev:"",subfunction:"gm"}]}let t=u(a=>{let s=a.parent?a.parent.id:void 0;s&&ie.hookUpdate(s)},"parentUpdate");Hooks.on("controlToken",(a,s)=>{game.dsa5.apps.tokenHotbar?.updateDSA5Hotbar()}),Hooks.on("updateActor",(a,s)=>{ie.hookUpdate(a.id)}),Hooks.on("updateToken",(a,s,i)=>{!game.dsa5.apps.tokenHotbar||s._id==getProperty(game.dsa5.apps.tokenHotbar,"actor.prototypeToken.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}),Hooks.on("updateOwnedItem",(a,s)=>{ie.hookUpdate(a.data.id)}),Hooks.on("createOwnedItem",(a,s)=>{ie.hookUpdate(a.data.id)}),Hooks.on("deleteOwnedItem",(a,s)=>{ie.hookUpdate(a.data.id)}),Hooks.on("updateItem",(a,s)=>{t(a)}),Hooks.on("createItem",(a,s)=>{t(a)}),Hooks.on("deleteItem",(a,s)=>{t(a)}),Hooks.on("canvasInit",()=>{!this.rendered||this.render()})}registerMasterFunction(e,t){let a=game.settings.get("dsa5","enableMasterTokenFunctions");e.disabled=a[e.id],this.gmItems.push(e),this.callbackFunctions[e.id]=t}async prepareSkills(){let e=await f.allSkills();return this.skills=e.map(t=>({name:t.name,icon:t.img,id:t.name,cssClass:"skillgm",addClass:t.system.group.value,abbrev:t.name[0],subfunction:"skillgm"})),this.skills=this.skills.sort((t,a)=>t.addClass.localeCompare(a.addClass)||t.name.localeCompare(a.name)),this.skills}static hookUpdate(e){game.dsa5.apps.tokenHotbar&&e==getProperty(game.dsa5.apps.tokenHotbar,"actor.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}resetPosition(){let e=$("#hotbar").first().position(),t=game.settings.get("dsa5","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}static get defaultOptions(){let e=super.defaultOptions,t=$("#hotbar").first().position(),a=game.settings.get("dsa5","tokenhotbarSize"),s=game.settings.get("dsa5","tokenhotbarPosition");return mergeObject(e,{classes:e.classes.concat(["dsa5","tokenQuickHot"]),itemWidth:a,resizable:!1,height:a+45,zIndex:61,left:t.left+8,top:t.top-a-25,template:"systems/dsa5/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(e,s),e}async _onWheelResize(e){let t=game.settings.get("dsa5","tokenhotbarSize");e.originalEvent.deltaY>0?t=Math.min(100,t+5):t=Math.max(15,t-5),await game.settings.set("dsa5","tokenhotbarSize",t),await this.render(!0)}async _cycleLayout(e){if(e.button==2){let t=game.settings.get("dsa5","tokenhotbarLayout")+1;t==4&&(t=0),await game.settings.set("dsa5","tokenhotbarLayout",t),await this.render(!0)}}changeDarkness(e){let t=Number(e.currentTarget.value);canvas.scene&&canvas.scene.update({darkness:t},{animateDarkness:3e3}),pe(t)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async i=>(i.stopPropagation(),i.preventDefault(),await this._onWheelResize(i),!1)),t.on("mousedown",async i=>{await this._cycleLayout(i)}),e.find(".itdarkness input").change(i=>this.changeDarkness(i));let a=this,s=u(function(i){return a.filterButtons(i),!1},"fn");e.find(".filterable").hover(function(){$(document).keydown(s)},function(){$(document).unbind("keydown",s)}),e.find(".quantity-click").mousedown(i=>_.quantityClick(i)),e.on("mousedown","li",async i=>(i.stopPropagation(),await this.executeQuickButton(i),!1)),e.on("mouseenter","li.primary",i=>{let n=i.currentTarget.dataset.category;this.category=n,setTimeout(()=>{e.find(".secondary").removeClass("shown"),n==this.category&&e.find(`.secondary[data-category="${n}"]`).addClass("shown")},700)}),e.on("mouseleave","li.primary",i=>{let n=i.currentTarget.dataset.category;this.category=void 0,setTimeout(()=>{n!=this.category&&(a.searching="",$(i.currentTarget).find(".secondary").removeClass("dsahidden"),e.find(`.secondary[data-category="${n}"]`).removeClass("shown"))},50)})}async handleEffect(e,t,a,s){let i=t.effects.get(a),n=[...i.statuses][0];e.button==0?n?await t.addCondition(n,1,!1,!1):i.sheet.render(!0):e.button==2&&(n?await t.removeCondition(n,1,!1):await t.sheet._deleteActiveEffect(a)),await this.render(!0)}async handleGMRoll(e){let t=e.currentTarget.dataset.id,a=Math.round($(e.currentTarget).closest(".tokenHotbarInner").find(".modifierVal").val());e.ctrlKey?game.dsa5.apps.DSA5ChatListeners.check3D20(void 0,t,{modifier:a}):e.button==2?game.dsa5.macro.requestGC(t,a,{maxRolls:7}):game.dsa5.macro.requestRoll(t,a)}async handleSkillRoll(e,t,a,s){let i={};if(e.button==2&&(i.rollMode="blindroll"),a=="rideLoyaltyID")j.rollLoyalty(t,i);else if(a=="attackWeaponless")t.setupWeaponless("attack",i,s).then(n=>{t.basicTest(n)});else{let n=t.items.get(a);if(n){if(e.originalEvent.ctrlKey)return n.sheet.render(!0);switch(n.type){case"meleeweapon":case"rangeweapon":case"trait":t.setupWeapon(n,"attack",i,s).then(r=>{t.basicTest(r)});break;case"liturgy":case"spell":t.setupSpell(n,i,s).then(r=>{t.basicTest(r)});break;case"skill":t.setupSkill(n,i,s).then(r=>{t.basicTest(r)});break;case"consumable":new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+n.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+n.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async()=>{await n.setupEffect(null,{},s),await this.updateDSA5Hotbar()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);break}}}}async handleTradeStart(e,t,a,s){for(let i of game.user.targets)i.actor&&new de(C.buildSpeaker(t,s),C.buildSpeaker(i.actor,i.id)).startTrade()}async handleOnUse(e,t,a,s){let i=t.items.get(a);await new J(i).executeOnUseEffect()}async handleGM(e,t,a,s){switch(a){case"masterMenu":f.renderToggle(game.dsa5.apps.gameMasterMenu);break;case"payMoney":this.payMoney(e);break;case"randomVictim":this.handleGMRandomVictim(e);break;default:a in this.callbackFunctions&&this.callbackFunctions[a](e,t,a,s)}}payMoney(e){let t=`${$(e.currentTarget).closest(".tokenHotbarInner").find(".modifierVal").val()}`;e.button==2?G.createGetPaidChatMessage(t):G.createPayChatMessage(t)}async handleGMRandomVictim(e){let t=await game.dsa5.apps.gameMasterMenu.rollRandomPlayer(e.button==2),a=game.actors.get(t);if(a){let s=await f.showArtwork(a);e.originalEvent.ctrlKey||setTimeout(()=>{s.close()},2e3)}}async handleSharedEffect(e){for(let t of canvas.tokens.controlled){let a=t.actor,s=t.id,i=a.effects.find(n=>n.name==e.currentTarget.dataset.name)?.id;await this.handleEffect(e,a,i,s)}}async executeQuickButton(e){let t=canvas.tokens.controlled[0]?.actor,a=canvas.tokens.controlled[0]?.id,s=e.currentTarget.dataset.id;switch(e.currentTarget.dataset.subfunction){case"trade":this.handleTradeStart(e,t,s,a);break;case"addEffect":De.showDialog();break;case"effect":this.handleEffect(e,t,s,a);break;case"sharedEffect":this.handleSharedEffect(e);break;case"onUse":this.handleOnUse(e,t,s,a);break;case"gm":this.handleGM(e,t,s,a);break;case"none":case"darkness":break;case"skillgm":this.handleGMRoll(e);break;default:this.handleSkillRoll(e,t,s,a)}}subWidth(e,t,a=7){return`style="width:${Math.ceil(e.length/a)*200}px"`}async getData(){let e=await super.getData(),t=this.actor,a={attacks:[],spells:[],default:[],skills:[],functions:[],gm:[]},s,i,n=[],r=[],o=[],c=game.settings.get("dsa5","tokenhotbarLayout"),m=c%2,d=ie.defaultOptions.itemWidth,p=["liturgy","spell"],g=!1;if(t){let y=[],v=[],P=j.isRiding(t),T=game.i18n.localize("LocalizedIDs.riding");if(o=(await t.actorEffects()).map(D=>({name:D.name,id:D.id,icon:D.icon,cssClass:"effect",abbrev:`${D.name[0]} ${D.getFlag("dsa5","value")||""}`,subfunction:"effect"})),game.combat){let D=t.items.filter(k=>k.type=="combatskill").map(k=>S._calculateCombatSkillValues(k.toObject(),t.system)),z=D.find(k=>k.name==game.i18n.localize("LocalizedIDs.wrestle"));z&&a.attacks.push({name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",icon:"systems/dsa5/icons/categories/attack_weaponless.webp",attack:z.system.attack.value,damage:"1d6"});let O=["meleeweapon","rangeweapon"],I=["meleeAttack","rangeAttack"];for(let k of t.items){if(["skill"].includes(k.type)&&(this.combatSkills.some(N=>k.name.startsWith(N))||P&&T==k.name)&&a.default.push({name:`${k.name} (${k.system.talentValue.value})`,id:k.id,icon:k.img,cssClass:"skill filterable",abbrev:k.name[0]}),k.type=="trait"&&I.includes(k.system.traitType.value)){let N=S._parseDmg(k.toObject());a.attacks.push({name:k.name,id:k.id,icon:k.img,cssClass:`weapon ${k.id}`,abbrev:k.name[0],attack:k.system.at.value,damage:N.damagedie,dadd:N.damageAdd})}else if(O.includes(k.type)&&k.system.worn.value==!0){let N=k.type=="meleeweapon"?S._prepareMeleeWeapon(k.toObject(),D,t):S._prepareRangeWeapon(k.toObject(),[],D,t);a.attacks.push({name:k.name,id:k.id,icon:k.img,cssClass:`weapon ${k.id}`,abbrev:k.name[0],attack:N.attack,damage:N.damagedie,dadd:N.damageAdd})}else if(p.includes(k.type))k.system.effectFormula.value?a.spells.push({name:k.name,id:k.id,icon:k.img,cssClass:"spell",abbrev:k.name[0]}):v.push({name:k.name,id:k.id,icon:k.img,cssClass:"spell",abbrev:k.name[0]});else if(["skill"].includes(k.type)){let N={name:`${k.name} (${k.system.talentValue.value})`,id:k.id,icon:k.img,cssClass:"skill",addClass:k.system.group.value,abbrev:k.name[0],tw:k.system.talentValue.value};y.push(N)}else k.type=="consumable"&&n.push({name:k.name,id:k.id,icon:k.img,cssClass:"consumable",abbrev:k.system.quantity.value});k.getFlag("dsa5","onUseEffect")&&r.push({name:k.name,id:k.id,icon:k.img,cssClass:"onUse",abbrev:k.name[0],subfunction:"onUse"})}if(s=n.pop(),P){let k=j.getHorse(t);if(k){let N=j.getLoyaltyFromHorse(k);N&&a.default.push({name:`${N.name} (${N.system.talentValue.value})`,id:"rideLoyaltyID",icon:N.img,cssClass:"skill",abbrev:N.name[0]})}}}else{let D=[];for(let z of t.items){if(["skill"].includes(z.type)&&(this.defaultSkills.includes(z.name)||P&&T==z.name)&&a.default.push({name:`${z.name} (${z.system.talentValue.value})`,id:z.id,icon:z.img,cssClass:"skill filterable",abbrev:z.name[0]}),["skill"].includes(z.type)){let O={name:`${z.name} (${z.system.talentValue.value})`,id:z.id,icon:z.img,cssClass:"skill",addClass:z.system.group.value,abbrev:z.name[0],tw:z.system.talentValue.value};z.system.talentValue.value>0&&(O.cssClass+=" filterable",D.push(O)),y.push(O)}else p.includes(z.type)&&(z.system.effectFormula.value?a.spells.push({name:z.name,id:z.id,icon:z.img,cssClass:"spell",abbrev:z.name[0]}):v.push({name:z.name,id:z.id,icon:z.img,cssClass:"spell",abbrev:z.name[0]}));z.getFlag("dsa5","onUseEffect")&&r.push({name:z.name,id:z.id,icon:z.img,cssClass:"onUse",abbrev:z.name[0],subfunction:"onUse"})}a.skills.push(...D.sort((z,O)=>O.tw-z.tw).slice(0,5))}i=r.pop();let R=game.i18n.localize("MERCHANT.exchange");a.functions.push({name:R,id:"trade",icon:"icons/svg/coins.svg",cssClass:"effect",abbrev:R[0],subfunction:"trade"}),a.spells.length==0&&v.length>0&&a.spells.push(v.pop()),a.spells.length>0&&v.length>0&&(a.spells[0].more=v.sort((D,z)=>D.name.localeCompare(z.name)),a.spells[0].subwidth=this.subWidth(v,d)),a.default.length>0&&y.length>0&&(a.default[0].more=y.sort((D,z)=>D.addClass.localeCompare(z.addClass)||D.name.localeCompare(z.name)),a.default[0].subwidth=this.subWidth(y,d,20)),s&&(n.length>0&&(s.more=n,s.subwidth=this.subWidth(n,d)),a.consumables=[s]),i&&(r.length>0&&(i.more=r,i.subwidth=this.subWidth(r,d)),a.onUsages=[i])}else if(game.user.isGM&&!game.settings.get("dsa5","disableTokenhotbarMaster")){g=!0;let y=this.skills||await this.prepareSkills();a.gm=this.gmItems.filter(v=>!v.disabled).concat([{name:"TT.tokenhotbarSkill",id:"skillgm",icon:"systems/dsa5/icons/categories/Skill.webp",cssClass:"skillgm filterable",abbrev:"",subfunction:"none",more:y,subwidth:this.subWidth(y,d,20)}])}if(this.showEffects){let y=game.i18n.localize("CONDITION.add"),v={name:"CONDITION.add",id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:y[0],subfunction:"addEffect"};if(o.length>0)v.more=o,v.subwidth=this.subWidth(o,d);else if(canvas.tokens.controlled.length>1){let P=(await canvas.tokens.controlled[0].actor.actorEffects()).map(T=>({name:T.name,id:T.id,icon:T.icon,cssClass:"effect",abbrev:`${T.name[0]} ${T.getFlag("dsa5","value")||""}`,subfunction:"sharedEffect"}));for(let T of canvas.tokens.controlled){let R=(await T.actor.actorEffects()).map(D=>D.name);P=P.filter(D=>R.includes(D.name))}v.more=P,v.subwidth=this.subWidth(P,d)}a.effects=[v]}let h=Object.keys(a).reduce((y,v)=>y+a[v].length,0)+(g?3:0);return m?(this.position.width=d,this.position.height=d*h+14):(this.position.width=d*h+14,this.position.height=d),mergeObject(e,{items:a,itemWidth:d,direction:c,count:h,gmMode:g,darkness:canvas.scene?.darkness||0,opacity:game.settings.get("dsa5","tokenhotbaropacity")}),e}filterButtons(e){switch(e.which){case 17:return;case 8:this.searching=this.searching.slice(0,-1);break;default:this.searching+=String.fromCharCode(e.which)}e.preventDefault(),e.stopPropagation();let t=this.searching.toLowerCase();pe(t);let a=$(e.currentTarget).find(".subbuttons li");a.find(".dsahidden").removeClass("dsahidden"),a.filter(function(){return $(this).find("label").text().toLowerCase().trim().indexOf(t)==-1}).addClass("dsahidden")}async render(e,t={}){let a=await super.render(e,t);return this._element&&this._element.css({zIndex:61}),a}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){let n=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),r=this.element[0];if(!r.style.width||a){let o=a||r.offsetWidth,c=r.style.maxWidth||window.innerWidth;n.width=a=Math.clamped(o,0,c),r.style.width=a+"px",a+n.left>window.innerWidth&&(e=n.left)}return game.settings.set("dsa5","tokenhotbarPosition",{left:n.left,top:n.top}),n}async updateDSA5Hotbar(){let e=canvas.tokens.controlled;if(this.actor=void 0,this.showEffects=!1,e.length===1){let t=e[0].actor;t&&t.isOwner&&(this.actor=t)}e.length>=1&&(this.showEffects=!0),await this.render(!0,{focus:!1})}};u(ie,"TokenHotbar2");var De=class extends Dialog{static async showDialog(){let e=duplicate(CONFIG.statusEffects).map(a=>({name:game.i18n.localize(a.name),icon:a.icon,description:game.i18n.localize(a.description),id:a.id})).sort((a,s)=>a.name.localeCompare(s.name)),t=new De({title:game.i18n.localize("CONDITION.add"),content:await renderTemplate("systems/dsa5/templates/dialog/addstatusdialog.html",{effects:e}),buttons:{}});t.position.height=Math.ceil(e.length/3)*36+170,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").mouseenter(s=>{if(s.currentTarget.getElementsByClassName("hovermenu").length==0){let i=document.createElement("div");i.classList.add("hovermenu"),i.style.cssText="font-size: var(--font-size-20);";let n=document.createElement("i");n.classList.add("fas","fa-cogs"),n.title=game.i18n.localize("ActiveEffects.custom"),n.addEventListener("click",async r=>this.configureEffect(r),!1),i.appendChild(n),s.currentTarget.appendChild(i)}}),e.find(".reactClick").mouseleave(s=>{let i=s.toElement||s.relatedTarget;i.parentNode==this||i==this||s.currentTarget.querySelectorAll(".hovermenu").forEach(n=>n.remove())}),e.find(".quantity-click").mousedown(s=>_.quantityClick(s)),e.find(".reactClick").click(s=>this.addEffect(s.currentTarget.dataset.value));let t=u(s=>this._filterConditions($(s.currentTarget),e),"filterConditions"),a=e.find(".conditionSearch");a.keyup(s=>this._filterConditions($(s.currentTarget),e)),a[0]&&a[0].addEventListener("search",t,!1)}_filterConditions(e,t){if(e.val()!=null){let a=e.val().toLowerCase().trim(),s=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),s.filter(function(){return $(this).find("span").text().toLowerCase().trim().indexOf(a)==-1}).addClass("filterHide")}}static async modifyEffectDialog(e,t){new De({title:game.i18n.localize("CONDITION."+e),content:await renderTemplate("systems/dsa5/templates/dialog/configurestatusdialog.html"),default:"add",buttons:{add:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("CONDITION.add"),callback:async a=>{let s={},i=a.find("[name=unit]:checked").val()=="seconds"?Math.round(a.find(".duration").val()/5):a.find(".duration").val(),n=a.find(".effectname").val();i>0&&mergeObject(s,_._buildDuration(i)),n&&(s.name=n),await t(e,s)}}}}).render(!0,{width:400,resizable:!1,classes:["dsa5","dialog"]})}async configureEffect(e){e.stopPropagation();let a=$(e.currentTarget).closest(".reactClick").attr("data-value");this.close(),De.modifyEffectDialog(a,async(s,i)=>this.addEffect(s,i))}async addEffect(e,t={}){for(let a of canvas.tokens.controlled)await a.actor.addTimedCondition(e,1,!1,!1,t);game.dsa5.apps.tokenHotbar?.render(!0),this.close()}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:["dsa5","tokenStatusEffects"],width:700,resizable:!0}),e}};u(De,"AddEffectDialog");var Zs=u(async(l,e,t,a)=>{if(game.user.isGM){let s=await game.dsa5.apps.DSA5_Utility.allMoneyItems(),i=await f.getFolderForType("Actor",null,"Dropped Items"),r=game.users.filter(p=>!p.isGM).map(p=>p.id).reduce((p,g)=>(p[g]=1,p),{default:0}),o=e.toObject();o.system.quantity.value=a,_.obfuscateDropData(o,t.tabsinvisible),getProperty(o,"system.worn.value")&&(o.system.worn.value=!1);let c={type:"npc",name:e.name,img:e.img,prototypeToken:{img:e.img,width:.4,height:.4},ownership:r,items:[...s,o],flags:{core:{sheetClass:"dsa5.MerchantSheetDSA5"}},folder:i,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},status:{wounds:{value:16}}}},d=await(await game.dsa5.entities.Actordsa5.create(c)).getTokenDocument({x:t.x,y:t.y,hidden:!1});if(!canvas.dimensions.rect.contains(d.x,d.y))return!1;if(l){await canvas.scene.createEmbeddedDocuments("Token",[d],{noHook:!0});let p=e.system.quantity.value-a;p<1?await l.deleteEmbeddedDocuments("Item",[e.id]):await l.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity.value":p}])}else await canvas.scene.createEmbeddedDocuments("Token",[d])}else{let s={itemId:e.uuid,sourceActorId:l?.id,data:t,amount:a};game.socket.emit("system.dsa5",{type:"itemDrop",payload:s})}},"dropToGround"),qi=u(async(l,e)=>{let t=await Item.implementation.fromDropData(e),a=t.parent;if(!b.equipmentCategories.has(t.type))return;let s=u(async i=>{Zs(a,t,e,i)},"callback");Ve.create(game.i18n.localize("DSASETTINGS.enableItemDropToCanvas"),game.i18n.format("MERCHANT.dropGround",{name:t.name}),t.system.quantity.value,s)},"handleItemDrop"),Wi=u(async(l,e)=>{let t=e.x,a=e.y,s=0,i=l.grid.size,n=Math.ceil(Math.sqrt(e.ids.length));for(let r of e.ids){let o=game.actors.get(r);if(!o)continue;let c=await o.getTokenDocument({x:t,y:a,hidden:!1});c.constructor.create(c,{parent:l.scene}),n%s==0&&s>0?(a+=i,t=e.x):t+=i,s++}},"handleGroupDrop"),Di=u(()=>{Hooks.on("dropCanvasData",async(l,e)=>{if(!!(game.settings.get("dsa5","enableItemDropToCanvas")||game.user.isGM||e.tokenId)){if(e.type=="Item")return qi(l,e),!1;if(e.type=="GroupDrop")return Wi(l,e),!1}})},"connectHook"),Ve=class extends Dialog{static async create(e,t,a,s,i=1,n=void 0){n=n||a;let r=await renderTemplate("systems/dsa5/templates/dialog/dropToGround.html",{name:t,min:i,max:n,count:a});new Ve({title:e,content:r,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async o=>s(Number(o.find('[name="count"]').val()))},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};u(Ve,"RangeSelectDialog");var Me=class extends ActorSheet{get actorType(){return this.actor.type}async _render(e=!1,t={}){this._saveSearchFields(),this._saveCollapsed(),await super._render(e,t),this._setCollapsed(),this._restoreSeachFields();let a=$(this._element),s={".close":"SHEET.Close",".configure-sheet":"SHEET.Configure",".configure-token":"SHEET.Token",".import":"SHEET.Import",".locksheet":"SHEET.Lock",".library":"SHEET.Library",".playerview":"SHEET.switchLimited",".actorConfig":"SHEET.actorConfig"};for(let i of Object.keys(s))a.find(i).attr("data-tooltip",s[i]);this.currentFocus&&(a.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null)}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(e,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),e}_saveSearchFields(){if(this.form===null)return;let e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}_restoreSeachFields(){if(this.searchFields!=null){let e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));let t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),this.searchFields.searchText!=""&&this._filterTalents(t);let a=$(e.find(".gearSearch"));a.val(this.searchFields.gearSearch),this.searchFields.searchText!=""&&this._filterGear(a)}}_saveCollapsed(){if(this.form===null)return;let e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];let t=e.find(".ch-collapse i");for(let a of t)this.collapsedBoxes.push($(a).attr("class"));for(let a of $(e.find(".expandDetails.shown")))this.openDetails.push($(a).closest(".item").attr("data-item-id"))}_setCollapsed(){let e=$(this.form).parent();if(this.collapsedBoxes){let t=e.find(".ch-collapse i");for(let a=0;a<t.length;a++)$(t[a]).attr("class",this.collapsedBoxes[a]),this.collapsedBoxes[a]&&this.collapsedBoxes[a].indexOf("fa-angle-down")!=-1&&$(t[a]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}}async getData(e){let t=await super.getData(e),a={actor:t.actor,editable:t.editable,limited:t.limited,owner:t.owner};return a.prepare=this.actor.prepareSheet({details:this.openDetails}),a.sizeCategories=b.sizeCategories,a.isGM=game.user.isGM,a.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},a.horseSpeeds=Object.keys(j.speedKeys),E.prepareActiveEffects(this.actor,a),a.enrichedOwnerdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.ownerdescription"),{secrets:this.object.isOwner,async:!0}),a.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.gmdescription"),{secrets:this.object.isOwner,async:!0}),a.enrichedNotes=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.value"),{secrets:this.object.isOwner,async:!0}),a.enrichedBiography=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.biography.value"),{secrets:this.object.isOwner,async:!0}),a}_onItemCreate(e){e.preventDefault();let t=e.currentTarget,a=duplicate(t.dataset);b.equipmentTypes[a.type]&&(a.type="equipment",a=mergeObject(a,{"system.equipmentType.value":e.currentTarget.attributes["item-section"].value,"system.effect.value":""})),["aggregatedTest","spell","liturgy","ritual","ceremony"].includes(a.type)||(a["system.weight.value"]=0,a["system.quantity.value"]=0),C.defaultIcon(a),a.name=f.categoryLocalization(a.type),this.actor.createEmbeddedDocuments("Item",[a])}_handleAggregatedProbe(e){let t=this._getItemId(e),a=this.actor.items.get(t).toObject(),s=a.system.talent[`value${e.currentTarget.dataset.which}`],i=this.actor.items.find(r=>r.name==s&&r.type=="skill"),n=`<h3 class="center"><b>${game.i18n.localize("TYPES.Item.aggregatedTest")}</b></h3>`;a.system.usedTestCount.value>=a.system.allowedTestCount.value?(n+=`${game.i18n.localize("Aggregated.noMoreAllowed")}`,ChatMessage.create(f.chatDataSetup(n))):this.actor.setupSkill(i,{moreModifiers:[{name:game.i18n.localize("failedTests"),value:-1*a.system.previousFailedTests.value,selected:!0},{name:game.i18n.localize("Modifier"),value:a.system.baseModifier,selected:!0}]},this.getTokenId()).then(r=>{this.actor.basicTest(r).then(o=>{o.result.successLevel>0?(a.system.cummulatedQS.value=o.result.qualityStep+a.system.cummulatedQS.value,a.system.cummulatedQS.value=Math.min(10,a.system.cummulatedQS.value)):a.system.previousFailedTests.value+=1,a.system.usedTestCount.value+=1,this.actor.updateEmbeddedDocuments("Item",[a]).then(()=>{let c=this.actor.items.get(t);c.postItem(),a.system.cummulatedQS.value>=10&&c.sheet.postFinishedItem()})})})}async consumeItem(e){new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+e.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+e.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{e.setupEffect(null,{},this.getTokenId())}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async _advanceAttribute(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial),a=f._calculateAdvCost(t,"E");await this._checkEnoughXP(a)&&await this._updateAPs(a,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)+1})}async _refundAttributeAdvance(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial);if(Number(this.actor.system.characteristics[e].advances)>0){let a=f._calculateAdvCost(t,"E",0)*-1;await this._updateAPs(a,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)-1})}}async _rebuyPC(e){this.actor.system.status[e].permanentLossSum>0&&await this._checkEnoughXP(2)&&await this._updateAPs(2,{[`system.status.${e}.rebuy`]:Number(this.actor.system.status[e].rebuy)+1})}async _refundPC(e){this.actor.system.status[e].rebuy>0&&await this._updateAPs(-2,{[`system.status.${e}.rebuy`]:Number(this.actor.system.status[e].rebuy)-1})}async _advancePoints(e){let t=Number(this.actor.system.status[e].advances),a=f._calculateAdvCost(t,"D");await this._checkEnoughXP(a)&&this._checkMaximumPointAdvancement(e,t+1)&&await this._updateAPs(a,{[`system.status.${e}.advances`]:Number(this.actor.system.status[e].advances)+1})}async _refundPointsAdvance(e){let t=Number(this.actor.system.status[e].advances);if(t>0){let a=f._calculateAdvCost(t,"D",0)*-1;await this._updateAPs(a,{[`system.status.${e}.advances`]:Number(this.actor.system.status[e].advances)-1})}}async _advanceItem(e){let t=this.actor.items.get(e).toObject(),a=f._calculateAdvCost(Number(t.system.talentValue.value),t.system.StF.value);await this._checkEnoughXP(a)&&this.actor._checkMaximumItemAdvancement(t,Number(t.system.talentValue.value)+1)?.result&&(await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.talentValue.value":t.system.talentValue.value+1}]),await this._updateAPs(a))}async _refundItemAdvance(e){let t=this.actor.items.get(e).toObject(),a=t.type=="combatskill"?6:0;if(t.system.talentValue.value>a){let s=f._calculateAdvCost(Number(t.system.talentValue.value),t.system.StF.value,0)*-1;await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.talentValue.value":t.system.talentValue.value-1}]),await this._updateAPs(s)}}_checkMaximumPointAdvancement(e,t){let a=!1;switch(e){case"wounds":a=t<=this.actor.system.characteristics.ko.value;break;case"astralenergy":a=t<=(this.actor.system.characteristics[this.actor.system.guidevalue.magical]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue.magical].value*this.actor.system.energyfactor.magical);break;case"karmaenergy":a=t<=(this.actor.system.characteristics[this.actor.system.guidevalue.clerical]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue.clerical].value*this.actor.system.energyfactor.clerical);break}return a||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),a}async _openLibrary(){game.dsa5.itemLibrary.render(!0)}async _configActor(){Ue.buildDialog(this.actor)}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"library",icon:"fas fa-university",onclick:async()=>this._openLibrary()}),this.actor.isOwner&&(e.unshift({class:"actorConfig",icon:"fas fa-link",onclick:async()=>this._configActor()}),e.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:async t=>this._togglePlayerview(t)})),this.actor.system.canAdvance&&e.unshift({class:"locksheet",icon:`fas fa-${this.actor.system.sheetLocked.value?"":"un"}lock`,onclick:async t=>this._changeAdvanceLock(t)}),e}async _changeAdvanceLock(e){await this.actor.update({"system.sheetLocked.value":!this.actor.system.sheetLocked.value}),$(e.currentTarget).find("i").toggleClass("fa-unlock fa-lock")}async _checkEnoughXP(e){return await this.actor.checkEnoughXP(e)}async advanceWrapper(e,t,a){let i=$(e.currentTarget).find("i");i.hasClass("fa-spin")||(i.addClass("fa-spin fa-spinner"),await this[t](a),i.removeClass("fa-spin fa-spinner"))}playerViewEnabled(){return getProperty(this.actor.system,"playerView")}_togglePlayerview(e){this.actor.update({"system.playerView":!getProperty(this.actor.system,"playerView")})}showLimited(){return!game.user.isGM&&this.actor.limited||this.playerViewEnabled()}getTokenId(){return this.token?.id}rollDisease(e){let t=this.actor.items.get(e),a=this.actor.system.status.soulpower.max*-1,s=this.actor.system.status.toughness.max*-1;t.setupEffect(void 0,{rollMode:"gmroll",manualResistance:{SKModifier:a,ZKModifier:s}}).then(async i=>{let n=await t.itemTest(i);await this.actor.updateEmbeddedDocuments("Item",[{_id:t.id,"system.duration.resolved":n.result.duration}])})}async swapWeaponHand(e){let t=this._getItemId(e),a=this.actor.items.get(t);["Daggers","Fencing Weapons"].includes(game.i18n.localize(`LocalizedCTs.${a.system.combatskill.value}`))||await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.wrongGrip":!a.system.worn.wrongGrip}])}activateListeners(e){super.activateListeners(e);let t=u(d=>{this.actor.items.get(this._getItemId(d)).postItem()},"posthand");e.find(".roll-disease").click(d=>this.rollDisease(this._getItemId(d))),ne(e),e.find(".condition-edit").click(async d=>{(d.currentTarget.dataset.uuid?await fromUuid(d.currentTarget.dataset.uuid):this.actor.effects.get(d.currentTarget.dataset.id)).sheet.render(!0)}),e.find(".ch-collapse").click(d=>{$(d.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(d.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()}),e.find(".status-create").click(d=>{let p=$(d.currentTarget).closest(".statusEffectMenu").find("ul");p.fadeIn("fast",()=>{p.find("input").focus()})}),e.find(".statusEffectMenu ul").mouseleave(d=>$(d.currentTarget).fadeOut()),e.find(".roll-aggregated").mousedown(d=>this._handleAggregatedProbe(d)),e.find(".skill-select").mousedown(d=>{let p=this._getItemId(d),g=this.actor.items.get(p);d.button==0?this.actor.setupSkill(g,{},this.getTokenId()).then(h=>{this.actor.basicTest(h)}):d.button==2&&g.sheet.render(!0)}),e.find(".spell-select").mousedown(d=>{let p=this._getItemId(d),g=this.actor.items.get(p);d.button==0?this.actor.setupSpell(g,{},this.getTokenId()).then(h=>this.actor.basicTest(h)):d.button==2&&g.sheet.render(!0)}),e.find(".item-post").click(d=>t(d)),e.find(".item-dropdown").click(d=>{d.preventDefault(),$(d.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")}),e.find(".condition-show").mousedown(d=>{d.preventDefault();let p=d.currentTarget.dataset.id,g=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");if(d.button==0){let h=$(d.currentTarget).parents(".statusEffect").attr("data-origin");if(h)fromUuid(h).then(y=>y.sheet.render(!0));else{let y,v;g?(y=CONFIG.statusEffects.find(T=>T.id==g),v=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${y.id}"><img src="${y.icon}"/>${game.i18n.localize(y.name)}</a></b>: ${game.i18n.localize(y.description)}</div>`)):(y=this.actor.effects.find(T=>T.id==p),y&&(v=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${y.id}"><img src="${y.icon}"/>${game.i18n.localize(y.name)}</a></b>: ${game.i18n.localize(y.flags.dsa5.description)}</div>`)));let P=$(d.currentTarget).closest(".groupbox").find(".effectDescription");P.fadeOut("fast",function(){P.html(v).fadeIn("fast")})}}else d.button==2&&!d.currentTarget.dataset.locked&&this._deleteActiveEffect(p)}),e.on("click",".chat-condition",d=>ee.postStatus(d.currentTarget.dataset.id)),e.find(".money-change, .skill-advances").focusin(d=>{this.currentFocus=$(d.currentTarget).closest("[data-item-id]").attr("data-item-id")}),e.find(".item-edit").click(d=>{d.preventDefault();let p=this._getItemId(d);this.actor.items.get(p).sheet.render(!0)}),e.find(".showApplication").mousedown(d=>{if(d.preventDefault(),d.button==2)this._deleteItem(d);else{let p=this._getItemId(d);this.actor.items.get(p).sheet.render(!0)}}),e.find(".ch-value").click(d=>{d.preventDefault();let p=d.currentTarget.attributes["data-char"].value;this.actor.setupCharacteristic(p,{},this.getTokenId()).then(g=>this.actor.basicTest(g))}),e.find(".ch-status").click(d=>{d.preventDefault(),this.actor.setupDodge({},this.getTokenId()).then(p=>{this.actor.basicTest(p)})}),e.find(".ch-regenerate").click(d=>{d.preventDefault(),this.actor.setupRegeneration("regenerate",{},this.getTokenId()).then(p=>this.actor.basicTest(p))}),e.find(".ch-weaponless").click(d=>{d.preventDefault();let p=d.currentTarget.attributes["data-char"].value;this.actor.setupWeaponless(p,{},this.getTokenId()).then(g=>this.actor.basicTest(g))}),e.find(".ch-fallingDamage").click(d=>{d.preventDefault(),this.actor.setupFallingDamage({},this.getTokenId())}),e.find(".ch-rollCombat").click(d=>{d.preventDefault();let p=this._getItemId(d),g=d.currentTarget.dataset.mode,h=this.actor.items.get(p);this.actor.setupWeapon(h,g,{},this.getTokenId()).then(y=>this.actor.basicTest(y))});let a=u(d=>this._deleteItem(d),"deletehand");e.find(".cards .item").mouseenter(d=>{if(d.currentTarget.getElementsByClassName("hovermenu").length==0){let p=document.createElement("div");p.classList.add("hovermenu");let g=document.createElement("i");g.classList.add("fas","fa-times"),g.title=game.i18n.localize("SHEET.DeleteItem"),g.addEventListener("click",a,!1);let h=document.createElement("i");h.classList.add("fas","fa-comment"),h.title=game.i18n.localize("SHEET.PostItem"),h.addEventListener("click",t,!1),p.appendChild(h),p.appendChild(g),d.currentTarget.appendChild(p)}}),e.find(".cards .item").mouseleave(d=>{let p=d.toElement||d.relatedTarget;!p||p.parentNode==this||p==this||d.currentTarget.querySelectorAll(".hovermenu").forEach(g=>g.remove())});let s=this.actor.uuid;e.find(".actorDrag").each(function(d,p){p.setAttribute("draggable",!0),p.addEventListener("dragstart",g=>{let h={type:"Actor",uuid:s};g.dataTransfer.setData("text/plain",JSON.stringify(h))})}),e.find(".filterTalents").click(d=>{$(d.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(d.currentTarget).toggleClass("filtered")}),e.find(".charimg").mousedown(d=>{d.button==2&&f.showArtwork(this.actor,!0)}),te.bindRollCommands(e);let i=u(d=>this._filterTalents($(d.currentTarget)),"filterTalents"),n=e.find(".talentSearch");n.keyup(d=>this._filterTalents($(d.currentTarget))),n[0]&&n[0].addEventListener("search",i,!1);let r=u(d=>this._filterConditions($(d.currentTarget)),"filterConditions"),o=e.find(".conditionSearch");o.keyup(d=>this._filterConditions($(d.currentTarget))),o[0]&&o[0].addEventListener("search",r,!1);let c=u(d=>this._filterGear($(d.currentTarget)),"filterGear"),m=e.find(".gearSearch");m.keyup(d=>this._filterGear($(d.currentTarget))),m[0]&&m[0].addEventListener("search",c,!1),lt(e,"img.charimg"),j.activateListeners(e,this.actor),this._bindKeepFieldsEnabled(e),this.isEditable&&(new ContextMenu(e,".item .withContext",[],{onOpen:this._onItemContext.bind(this)}),e.find(".startCharacterBuilder").click(()=>this.actor.setFlag("core","sheetClass","dsa5.DSACharBuilder")),e.find(".schipUpdate").click(d=>{d.preventDefault();let p=Number(d.currentTarget.getAttribute("data-val"));p==1&&$(this.form).find(".fullSchip").length==1&&(p=0),this.actor.update({"system.status.fatePoints.value":p})}),e.find(".swapWeaponHand").click(d=>this.swapWeaponHand(d)),e.find(".defenseToggle").click(()=>this.actor.update({"system.config.defense":!this.actor.system.config.defense})),e.find(".loadWeapon").mousedown(async d=>{let p=this._getItemId(d),g=this.actor.items.get(p).toObject();if(getProperty(g,"system.currentAmmo.value")==="")return;let h={_id:p};if(d.button==0){let y=g.type=="trait"?g.system.reloadTime.value:S.calcLZ(g,this.actor);h["system.reloadTime.progress"]=Math.min(g.system.reloadTime.progress+1,y)}else d.button==2&&(h["system.reloadTime.progress"]=0);await this.actor.updateEmbeddedDocuments("Item",[h])}),e.find(".chargeSpell").mousedown(async d=>{let p=this._getItemId(d),g=this.actor.items.get(p).toObject(),h=Number(g.system.castingTime.modified);d.button==0?g.system.castingTime.progress=Math.min(g.system.castingTime.progress+1,h):d.button==2&&(g.system.castingTime.progress=0,g.system.castingTime.modified=0),await this.actor.updateEmbeddedDocuments("Item",[g])}),e.find(".item-swapMag").click(async d=>{await this.actor.swapMag(this._getItemId(d))}),e.find(".ammo-selector").change(async d=>{d.preventDefault();let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.currentAmmo.value":$(d.currentTarget).val()}])}),e.find(".item-toggle").click(d=>{let p=this._getItemId(d),g=this.actor.items.get(p).toObject();switch(g.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.worn.value":!g.system.worn.value}]),V.playEquipmentWearStatusChange(g);break}}),e.find(".quantity-click").mousedown(d=>{let p=this._getItemId(d),g=this.actor.items.get(p).toObject();_.increment(d,g,"system.quantity.value",0),this.actor.updateEmbeddedDocuments("Item",[g])}),e.find(".status-add").mousedown(async d=>{let p=d.currentTarget.dataset.id;p=="custom"?E.createCustomEffect(this.actor):d.button==0?await this.actor.addCondition(p,1,!1,!1):d.button==2&&De.modifyEffectDialog(p,async(g,h)=>this.actor.addTimedCondition(g,1,!1,!1,h))}),e.find(".money-change").change(async d=>{let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.quantity.value":Number(d.target.value)}])}),e.find(".skill-advances").change(async d=>{let p=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:p,"system.talentValue.value":Number(d.target.value)}])}),e.find(".advance-attribute").mousedown(d=>this.advanceWrapper(d,"_advanceAttribute",d.currentTarget.dataset.attr)),e.find(".refund-attribute").mousedown(d=>this.advanceWrapper(d,"_refundAttributeAdvance",d.currentTarget.dataset.attr)),e.find(".advance-item").mousedown(d=>this.advanceWrapper(d,"_advanceItem",this._getItemId(d))),e.find(".refund-item").mousedown(d=>this.advanceWrapper(d,"_refundItemAdvance",this._getItemId(d))),e.find(".advance-points").mousedown(d=>this.advanceWrapper(d,"_advancePoints",d.currentTarget.dataset.attr)),e.find(".refund-points").mousedown(d=>this.advanceWrapper(d,"_refundPointsAdvance",d.currentTarget.dataset.attr)),e.find(".rebuy-pc").mousedown(d=>this.advanceWrapper(d,"_rebuyPC",d.currentTarget.dataset.attr)),e.find(".refund-pc").mousedown(d=>this.advanceWrapper(d,"_refundPC",d.currentTarget.dataset.attr)),e.find(".onUseItem").mousedown(d=>this._onMacroUseItem(d)),e.find(".traditionPayCost").mousedown(d=>this._payAeSpecialAbilityCost(d)),e.find(".item-create").click(d=>this._onItemCreate(d)),e.find(".condition-toggle").mousedown(async d=>{let p=$(d.currentTarget).parents(".statusEffect").attr("data-id"),g=this.actor.effects.get(p);await g.update({disabled:!g.disabled})}),e.find(".condition-value").mousedown(async d=>{let p=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");d.button==0?await this.actor.addCondition(p,1,!1,!1):d.button==2&&await this.actor.removeCondition(p,1,!1)}),e.find(".item-delete").click(d=>this._deleteItem(d)),e.find(".tradition-delete").click(d=>this._deleteTraditionArtifact(d)),e.find(".selectTraditionartifact").click(()=>this.selectTraditionartifact()),e.find(".disableRegeneration").click(d=>{let g=`system.repeatingEffects.disabled.${d.currentTarget.dataset.type}`;this.actor.update({[g]:!getProperty(this.actor,g)})}))}_onItemContext(e){let t=this.actor.items.get($(e).closest(".item").attr("data-item-id"));!t||(ui.context.menuItems=this._getItemContextOptions(t),Hooks.call("dsa5.getItemContextOptions",t,ui.context.menuItems))}_getItemContextOptions(e){let t=[{name:"SHEET.EditItem",icon:"<i class='fas fa-edit fa-fw'></i>",callback:()=>e.sheet.render(!0)},{name:"SHEET.PostItem",icon:"<i class='fas fa-comment fa-fw'></i>",callback:()=>e.postItem()},{name:"SHEET.DuplicateItem",icon:"<i class='fas fa-copy fa-fw'></i>",callback:()=>this.handleItemCopy(e.toObject(),e.type)},{name:"SHEET.ConsumeItem",icon:"<i class='fas fa-wine-bottle fa-fw'></i>",condition:()=>e.type=="consumable",callback:()=>this.consumeItem(e)},{name:"SHEET.onUseEffect",icon:"<i class='fas fa-dice-six fa-fw'></i>",condition:()=>getProperty(e,"flags.dsa5.onUseEffect"),callback:()=>new J(e).executeOnUseEffect()},{name:"SHEET.DeleteItem",icon:"<i class='fas fa-trash fa-fw'></i>",callback:()=>this._itemDeleteDialog(e)},{name:"MERCHANT.exchange",icon:"<i class='fas fa-coins'></i>",condition:()=>b.equipmentCategories.has(e.type),callback:()=>this._startTrade(e)}];return(hasProperty(e,"system.worn.wearable")||["meleeweapon","rangeweapon","armor"].includes(e.type))&&t.push({name:"SHEET.EquipItem",icon:"<i class='fas fa-shield-alt fa-fw'></i>",callback:()=>e.update({"system.worn.value":!e.system.worn.value})}),Number(getProperty(e,"system.quantity.value"))>1&&t.push({name:"SHEET.SplitItem",icon:"<i class='fas fa-arrows-split-up-and-left fa-fw'></i>",callback:()=>this._splitItem(e)}),t}async _startTrade(e){new Ut(this.actor).render(!0)}_splitItem(e){let t=u(async a=>{let s=e.toObject();s.system.quantity.value=a,await this.actor.createEmbeddedDocuments("Item",[s],{render:!1}),await this.actor.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity.value":e.system.quantity.value-a}])},"callback");Ve.create(game.i18n.localize("SHEET.SplitItem"),game.i18n.format("MERCHANT.splitItem",{name:e.name}),e.system.quantity.value-1,t,1,e.system.quantity.value-1)}_bindKeepFieldsEnabled(e){if(!this.isEditable){let t=e.find(".keepFieldsEnabled");for(let a of t){let s=a.dataset.attr,i=a.dataset.name;$(a).find(".editor").append(`<a data-attr="${s}" data-name="${i}" class="editor-edit"><i class="fas fa-edit"></i></a>`),$(a).find(".editor-edit").click(n=>this._openKeepFieldEditpage(n))}}}_openKeepFieldEditpage(e){let t=e.currentTarget.dataset.attr,a=e.currentTarget.dataset.name;new Tt(this.actor.id,t,a).render(!0)}async _onMacroUseItem(e){let t=this.actor.items.get(this._getItemId(e));await new J(t).executeOnUseEffect()}async _payAeSpecialAbilityCost(e){let t=this.actor.items.get(this._getItemId(e)),a=Number(getProperty(t,"system.AsPCost"));if(!this.actor.applyMana(a,"AsP"))return;let i=game.i18n.format("CHATNOTIFICATION.paysTraditionAbility",{name:this.actor.name,ability:t.name,cost:a});e.button==2?ChatMessage.create(f.chatDataSetup(i,"gmroll")):ChatMessage.create(f.chatDataSetup(i))}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async selectTraditionartifact(){!this.isEditable||new cs(this.actor).render(!0)}_deleteTraditionArtifact(e){if(!this.isEditable)return;this.actor.items.get(this._getItemId(e)).update({"system.isArtifact":!1})}_filterTalents(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.form).parent().find(".allTalents");a.find(".item, .table-header, .table-title").removeClass("filterHide"),a.addClass("showAll").find(".item").filter(function(){return $(this).find(".talentName").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide"),t.length>0?(a.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),a.addClass("filterfull")):a.removeClass("filterfull")}}_filterConditions(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.form).find(".statusEffectMenu li:not(.search)");a.removeClass("filterHide"),a.filter(function(){return game.i18n.localize($(this).find("a").attr("data-tooltip")).toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async _deleteActiveEffect(e){if(!this.isEditable)return;let t=this.actor.effects.find(a=>a.id==e);t&&(this.token?this.token.actor:this.actor)&&await this.actor.deleteEmbeddedDocuments("ActiveEffect",[t.id])}async _itemDeleteDialog(e){let t=game.i18n.format("DIALOG.DeleteItemDetail",{item:e.name}),a=await renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:t});await new Promise((s,i)=>{new Dialog({title:game.i18n.localize("DIALOG.deleteConfirmation"),content:a,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async()=>{await this._cleverDeleteItem(e.id),s(!0)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)})}async _deleteItem(e){if(!this.isEditable)return;let t=this._getItemId(e),a=this.actor.items.get(t);this._itemDeleteDialog(a)}async _cleverDeleteItem(e){let t=this.actor.items.get(e),a=[e];switch(t.type){case"advantage":case"disadvantage":await x.vantageRemoved(this.actor,t,!1);break;case"specialability":await L.abilityRemoved(this.actor,t,!1);break;case"blessing":case"magictrick":await this._updateAPs(-1,{},{render:!1});break;case"ritual":case"ceremony":case"liturgy":case"spell":{let s=0;for(let n=0;n<=t.system.talentValue.value;n++)s+=f._calculateAdvCost(n,t.system.StF.value,0);let i=this.actor.items.filter(n=>n.type=="spellextension"&&t.type==n.system.category&&t.name==n.system.source);i&&(s+=i.reduce((n,r)=>n+(Number(r.system.APValue.value)||0),0),a.push(...i.map(n=>n.id))),await this._updateAPs(s*-1,{},{render:!1})}break}await this.actor.deleteEmbeddedDocuments("Item",a)}_getItemId(e){return $(e.currentTarget).closest(".item").attr("data-item-id")}async _addMoney(e){let a=duplicate(this.actor.items.filter(s=>s.type=="money")).find(s=>s.name==e.name);a?(a.system.quantity.value+=e.system.quantity.value,await this.actor.updateEmbeddedDocuments("Item",[a])):await this.actor.createEmbeddedDocuments("Item",[e])}async _updateAPs(e,t={},a={}){await this.actor._updateAPs(e,t,a)}async _addVantage(e,t){x.needsAdoption(this.actor,e,t)}async _addSpecialAbility(e,t){L.needsAdoption(this.actor,e,t)}_onDragStart(e){let t=e.currentTarget;if(e.target.classList.contains("content-link"))return;let a;t.dataset.itemId&&(a=this.actor.items.get(t.dataset.itemId).toDragData(),t.dataset.mod&&(a.mod=t.dataset.mod)),t.dataset.id&&(a=this.actor.effects.get(t.dataset.id).toDragData()),a&&e.dataTransfer.setData("text/plain",JSON.stringify(a))}async _handleSpellExtension(e){if(!this.actor.items.find(a=>a.type==e.type&&a.name==e.name)){e=duplicate(e);let a=this.actor.items.find(s=>s.type==e.system.category&&s.name==e.system.source);if(!a)ui.notifications.error(game.i18n.format("DSAError.noSpellForExtension",{name:e.system.source,category:f.categoryLocalization(e.system.category),extension:e.name}));else{if(a.system.talentValue.value<e.system.talentValue){ui.notifications.error(game.i18n.localize("DSAError.talentValueTooLow"));return}let s=e.system.APValue.value;await this.actor.checkEnoughXP(s)&&(await this._updateAPs(s,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}}async _addSpellOrLiturgy(e){let t=this.actor.items.find(s=>s.type==e.type&&s.name==e.name),a;if(e=duplicate(e),!t){switch(e.type){case"spell":case"liturgy":case"ceremony":case"ritual":a=f._calculateAdvCost(0,e.system.StF.value,0);break;case"blessing":case"magictrick":a=1;break;case"magicalsign":a=e.system.APValue.value;break;default:return}await this.actor.checkEnoughXP(a)&&(await this._updateAPs(a,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}async _addLoot(e){e=duplicate(e);let t=this.actor.items.find(a=>C.areEquals(e,a));return t?(await C.stackItems(t,e,this.actor))[0]:(this._tabs[0].active=="combat"&&e.system.worn&&(e.system.worn.value=!0),(await this.actor.createEmbeddedDocuments("Item",[e]))[0])}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some(t=>C.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async _addDemonMarkOrPatron(e){return await this._addUniqueItem(e)}async _addDisease(e){return e.system.duration.resolved="?",await this._addUniqueItem(e)}async handleItemCopy(e,t){e.name+=" (Copy)",this._manageDragItems(e,t)}async _addFullPack(e){let a=(await game.packs.get(e.name).getDocuments()).filter(s=>!this.actor.items.find(i=>i.type==s.type&&i.name==s.name));e.onlyType&&(a=a.filter(s=>s.type==e.onlyType)),await this.actor.createEmbeddedDocuments("Item",a.map(s=>s.toObject()))}async creatureDrop(e){game.dsa5.config.hooks.shapeshift?new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption")+": "+e.name,content:game.i18n.localize("DIALOG.whichFunction")+": "+e.name,default:"horse",buttons:{shapeshift:{icon:'<i class="fas fa-paw"></i>',label:game.i18n.localize("CONDITION.shapeshift"),callback:()=>{let t=game.dsa5.config.hooks.shapeshift;t.setShapeshift(this.actor,e),t.render(!0)}},horse:{icon:'<i class="fas fa-horse"></i>',label:game.i18n.localize("RIDING.horse"),callback:()=>{j.setHorse(this.actor,e)}}}}).render(!0):j.setHorse(this.actor,e)}async _manageDragItems(e,t){switch(t){case"disease":await this._addDisease(e);break;case"meleeweapon":case"rangeweapon":case"equipment":case"ammunition":case"armor":case"poison":case"consumable":case"plant":return await this._addLoot(e);case"disadvantage":case"advantage":await this._addVantage(e,t);break;case"specialability":await this._addSpecialAbility(e,t);break;case"money":await this._addMoney(e);break;case"ritual":case"ceremony":case"blessing":case"magictrick":case"liturgy":case"spell":case"magicalsign":await this._addSpellOrLiturgy(e);break;case"effectwrapper":await this._handleEffectWrapper(e);break;case"application":await this._handleApplication(e);break;case"spellextension":await this._handleSpellExtension(e);break;case"creature":this.creatureDrop(e);break;case"skill":case"imprint":case"essence":case"information":await this._addUniqueItem(e);break;case"patron":case"demonmark":await this._addDemonMarkOrPatron(e);break;default:ui.notifications.error(game.i18n.format("DSAError.canNotBeAdded",{item:e.name,category:game.i18n.localize(e.type)}))}}async _handleEffectWrapper(e){this.actor.createEmbeddedDocuments("ActiveEffect",e.effects.map(t=>(t.origin=null,t)))}async _handleLookup(e){let t=await f.findAnyItem(e.items);if(t){for(let a of e.items)if(a.count){let s=t.find(i=>i.name==a.name&&i.type==a.type);s?(s.system.quantity.value=a.count,a.qs&&a.type=="consumable"&&(s.system.QL=a.qs)):ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:a.type,name:a.name}))}await this.actor.createEmbeddedDocuments("Item",t)}else ui.notifications.error(game.i18n.format("DSAError.notFound",{category:thing.type,name:thing.name}))}async _handleApplication(e){e=duplicate(e),this.actor.items.find(a=>a.type==e.type&&a.name==e.name)||await this.actor.createEmbeddedDocuments("Item",[e])}async _handleRemoveSourceOnDrop(e){let t=e.parent;t&&t.isOwner&&await t.deleteEmbeddedDocuments("Item",[e._id])}async _onDropItemCreate(e){return e instanceof Array?this.actor.createEmbeddedDocuments("Item",e):await this._manageDragItems(e,e.type)}async _onDropActor(e,t){if(!this.actor.isOwner)return!1;let{item:a,typeClass:s,selfTarget:i}=await Fe(t,this.id,!1);if(!i)return await this._manageDragItems(a,s)}async _onDropActiveEffect(e,t){let a=await ActiveEffect.implementation.fromDropData(t);if(!this.actor.isOwner||!a||this.actor.uuid===a.parent?.uuid)return!1;let s=a.toObject();return s.origin=null,ActiveEffect.create(s,{parent:this.actor})}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;let a=await Item.implementation.fromDropData(t),s=a.toObject();_.obfuscateDropData(s,t.tabsinvisible);let i,n=!1,r=$(e.target).parents(".item");if(r&&b.equipmentCategories.has(a.type)){let c=r.attr("data-item-id");r.attr("data-category")=="bags"?c!=a.id&&(i=c):(r=this.actor.items.get(c),n=r&&hasProperty(a,"system.quantity.value")&&hasProperty(r,"system.quantity.value")&&C.areEquals(a,r))}let o=this.actor.uuid===a.parent?.uuid;if(o)if(e.ctrlKey)await this.handleItemCopy(s,a.type);else if(n)await r.update({"system.quantity.value":r.system.quantity.value+a.system.quantity.value},{render:!1}),await this.actor.deleteEmbeddedDocuments("Item",[a.id]);else if(i){let c={_id:a.id,"system.parent_id":i};a.system.worn&&a.system.worn.value&&(c["system.worn.value"]=!1),await this.actor.updateEmbeddedDocuments("Item",[c])}else b.equipmentCategories.has(a.type)&&await this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,system:{parent_id:0}}]);else{if(this._itemHasPrice(t)){let m=`${a.type=="consumable"?C.getSubClass(s.type).consumablePrice(s):Number(s.system.price.value)}`;if(m&&!await G.payMoney(this.actor,m,!0,!1))return;pe(game.i18n.format("PAYMENT.pay",{actor:this.actor.name,amount:m})),V.playMoneySound()}await this._onDropItemCreate(s)}e.altKey&&!o&&b.equipmentCategories.has(a.type)&&await this._handleRemoveSourceOnDrop(a)}_itemHasPrice(e){return e.pay}};u(Me,"ActorSheetDsa5");var cs=class extends Application{constructor(e,t={}){super(t),this.actor=e}get template(){return"systems/dsa5/templates/actors/traditionPicker.html"}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:440,resizable:!0}),e}async getData(e){let t=await super.getData(e),a=this.actor.items.filter(s=>["equipment","armor","rangeweapon","meleeweapon"].includes(s.type));return mergeObject(t,{items:a}),t}activateListeners(e){super.activateListeners(e),e.find(".slot").click(async t=>{let a=this.actor.items.get(t.currentTarget.dataset.itemId);await a.update({"system.isArtifact":!a.system.isArtifact})})}};u(cs,"TraditionArtifactpicker");var se=class extends Application{constructor(e){super(e),this.actor=null,this.errors=[],this.attributes=[],this.updating=!1}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","generationWizard"]),width:770,height:740}),e.resizable=!0,e}async findCompendiumItem(e,t){for(let a of t){let s=await game.dsa5.itemLibrary.findCompendiumItem(e,a);if(s=s.find(i=>i.name==e&&i.type==a&&i.system),s)return s}}_parseAttributes(e,t=","){let a=[],s=game.i18n.localize("combatskillcountdivider")+":";for(let i of e.split(t))if(i.includes(s)){let n=i.split(":");a.push({choices:n[1].split("/").map(r=>r.trim()),allowedCount:Number(n[0].match(/\d/g))})}return a}async parseToItem(e,t){return e.trim()==""?[]:await Promise.all(e.split(", ").map(async a=>{let s=f.parseAbilityString(a.trim()),i=await this.findCompendiumItem(s.original,t);if(i||(i=await this.findCompendiumItem(s.name,t)),i){let r=i.uuid;i=duplicate(i),i.uuid=r,i.tooltip=game.i18n.localize("Details"),i=Z.reverseAdoptionCalculation(this.actor,s,i),i.system.APValue&&(i.APunparseable=isNaN(i.system.APValue.value),i.apCost=i.APunparseable?i.system.APValue.value:s.step*Number(i.system.APValue.value))}else if(this.attributes.includes(s.name)){let r=0;for(let o=this.actor.system.characteristics[game.dsa5.config.knownShortcuts[s.name.toLowerCase()][1]].value+1;o<s.step+1;o++)r+=b.advancementCosts.E[o];i={name:s.name,step:s.step,attributeRequirement:!0,system:{APValue:{value:r}}}}else{console.warn(`Not found <${a}>`);let r=t.map(o=>f.categoryLocalization(o)).join("/");this.errors.push(`${r}: ${a}`),i={name:a.trim(),notFound:!0,tooltip:game.i18n.localize("DSAError.itemNotFound"),apCost:"?"}}i.replaceName=s.original,i.step=s.step;let n=this.actor.items.find(r=>t.includes(r.type)&&r.name==s.original)!=null;return i.disabled=n||i.notFound||i.APunparseable,n&&(i.tooltip=game.i18n.localize("YouAlreadyHaveit")),i}))}mergeLevels(e,t,a){let s=!1,i=e.find(n=>n.name==t.name&&n.type==t.type);if(i){s=!0;let n=Number(getProperty(t,"system.step.value"));n&&(i.system.step.value=Math.min(i.system.step.value+=n,i.system[a].value))}else e.push(t);return s}async addSelections(e,t=!0){let a=[];for(let s of e){if($(s).val()=="")continue;let n=(await fromUuid($(s).val())).toObject(),r=f.parseAbilityString(n.name);switch(n.name=$(s).attr("name"),n.type){case"advantage":case"disadvantage":n.system.step.value=Number(s.dataset.step),n=Z.reverseAdoptionCalculation(this.actor,r,n),this.mergeLevels(a,n,"max")||x.vantageAdded(this.actor,n);break;case"specialability":n.system.step.value=Number(s.dataset.step),s.dataset.free=="true"&&(n.system.APValue.value=0),n=Z.reverseAdoptionCalculation(this.actor,r,n),this.mergeLevels(a,n,"maxRank")||L.abilityAdded(this.actor,n);break;case"magictrick":this.mergeLevels(a,n);break}}await this.actor.createEmbeddedDocuments("Item",a,{render:t})}async fixPreviousCosts(e,t){for(let a of t){let s=e.find(i=>i.type==a.type&&i.name==a.name);s&&(a.apCost-=s.apCost)}}async alreadyAdded(e,t){if(e=="")return!1;let a=!1;return a=await new Promise((s,i)=>{new Dialog({title:game.i18n.localize("DIALOG.warning"),content:game.i18n.format("DIALOG.alreadyAddedCharacterpart",{category:f.categoryLocalization(t)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Ok"),default:!0,callback:()=>{s(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("Cancel"),default:!0,callback:()=>{s(!0)}}}}).render(!0)}),a}async updateSkill(e,t,a=1,s=!0){let i=[];for(let n of e){let r=f.parseAbilityString(n.trim()),o=this.actor.items.find(c=>c.type==t&&c.name==r.name);o?i.push({_id:o.id,"system.talentValue.value":Math.max(0,a*r.step+(s?Number(o.system.talentValue.value):0))}):(console.warn(`Could not find ${t} ${n}`),this.errors.push(`${f.categoryLocalization(t)}: ${n}`))}await this.actor.updateEmbeddedDocuments("Item",i,{render:!1})}async getData(e){let t=await super.getData(e);return await game.dsa5.itemLibrary.buildEquipmentIndex(),t}_validateInput(e,t=this){let a=/^exclusive_/;for(let s of e.find(".tab")){let i=$(s),n=new Set;for(let r of i.find(".exclusive"))n.add(r.className.split(/\s+/).filter(o=>a.test(o))[0]);for(let r of n){let o=i.find(".allowedCount_"+r.split("_")[1]),c=Number(o.attr("data-count"));if(i.find(`.${r}:checked`).length!=c)return this._showInputValidation(o,i,t),!1}}return!0}_showInputValidation(e,t,a){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices"));let s=e.closest(".tab").attr("data-tab");a.activateTab(s),se.flashElem(t.find(`.tabs a[data-tab='${s}']`)),se.flashElem(e.closest("div"))}activateListeners(e){super.activateListeners(e),ne(e),e.find("button.ok").click(()=>{this.updating||(this.updating=!0,this.updateCharacter($(this._element)).then(()=>this.updating=!1))}),e.find("button.cancel").click(()=>{this.close()});let t=u(s=>{s.stopPropagation();let i=s.currentTarget.dataset.type,n=s.currentTarget.dataset.uuid;!n||!i||s.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:i,uuid:n}))},"itemDragStart"),a=e.find(".show-item");a.click(async s=>{let i=s.currentTarget.dataset.uuid;(await fromUuid(i)).sheet.render(!0)}),a.attr("draggable",!0).on("dragstart",s=>t(s)),e.on("click",".searchableAbility a",s=>gt(s)),e.find(".exclusive").change(s=>{let i=$(s.currentTarget).closest(".tab"),n=$(s.currentTarget).attr("data-sel"),r=i.find(`.allowedCount_${n}`),o=Number(r.attr("data-count"));if(i.find(`.exclusive_${n}:checked`).length>o){s.currentTarget.checked=!1,se.flashElem(r);return}})}static flashElem(e,t="emphasize"){e.addClass(t),setTimeout(function(){e.removeClass(t)},600)}finalizeUpdate(){this.errors.length==0?this.close():$(this._element).find(".dialog-buttons").html(`<div class="error"><p>${game.i18n.localize("DSAError.notUnderstood")}</p><ul><li>${this.errors.join("</li><li>")}</li></ul></div>`)}};u(se,"WizardDSA5");var Ke=class extends se{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")}`}),e.template="systems/dsa5/templates/wizard/add-culture-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content"),s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),se.flashElem(i,"emphasize2")})}async getData(e){let t=await super.getData(e),a=await this.parseToItem(this.culture.system.recommendedAdvantages.value,["advantage"]),s=await this.parseToItem(this.culture.system.recommendedDisadvantages.value,["disadvantage"]),i=this.culture.system.writing.value==""?[]:await this.parseToItem(this.culture.system.writing.value.split(",").map(o=>`${game.i18n.localize("LocalizedIDs.literacy")} (${o.trim()})`).join(", "),["specialability"]),n=this.culture.system.language.value==""?[]:await this.parseToItem(this.culture.system.language.value.split(",").map(o=>`${game.i18n.localize("LocalizedIDs.language")} (${o.trim()}) 3`).join(", "),["specialability"]),r=Number(this.culture.system.APValue.value);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")} ${this.culture.name}`}),culture:this.culture,description:game.i18n.format("WIZARD.culturedescr",{culture:this.culture.name,cost:r}),advantages:a,disadvantages:s,writings:i,languages:n,advantagesToChose:a.length>0,disadvantagesToChose:s.length>0,writingsToChose:i.length>0,languagesToChose:n.length>0,languagesToSelect:n.length>1,vantagesToChose:a.length>0||s.length>0,generalToChose:i.length>0||n.length>0,enrichedClothing:await TextEditor.enrichHTML(getProperty(this.culture.system,"clothing.value"),{secrets:!1,async:!0}),enrichedDescription:await TextEditor.enrichHTML(getProperty(this.culture.system,"description.value"),{secrets:!1,async:!0})}),t}async addCulture(e,t){this.actor=e,this.culture=duplicate(t)}_validateInput(e,t=this){let a=e.find(".localKnowledge");if(a.val()=="")return this._showInputValidation(a,e,t),!1;let s=e.find(".selectOnlyOne");return s.length&&s.find(".optional:checked").length!=1?(this._showInputValidation(s,e,t),!1):super._validateInput(e,t)}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.culture.value,"culture")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.culture.value":this.culture.name},i=await this.findCompendiumItem(`${game.i18n.localize("LocalizedIDs.localKnowledge")} ()`,["specialability"]);i&&(i=duplicate(i),i.name=`${game.i18n.localize("LocalizedIDs.localKnowledge")} (${e.find(".localKnowledge").val()})`,i.system.APValue.value=0,await this.actor.createEmbeddedDocuments("Item",[i],{render:!1})),await this.addSelections(e.find(".optional:checked"),!1),await this.actor._updateAPs(a,{},{render:!1}),await this.updateSkill(this.culture.system.skills.value.split(","),"skill"),await this.actor.update(s),this.finalizeUpdate()}};u(Ke,"CultureWizard");var Ye=class extends se{constructor(e){super(e),this.attributes=Object.keys(b.characteristics).map(t=>game.i18n.localize(`CHARAbbrev.${t.toUpperCase()}`))}static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.career")}`}),e.template="systems/dsa5/templates/wizard/add-career-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content");if($(t.currentTarget).hasClass("exclusiveTricks")){let n=Number(a.find(".maxTricks").attr("data-spelltricklimit"));if(a.find(".exclusiveTricks:checked").length>n){t.currentTarget.checked=!1,se.flashElem(a.find(".maxTricks"));return}}let s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))}),a.find(".attributes:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),se.flashElem(i,"emphasize2")})}_validateInput(e,t=this){let a=e.find(".maxTricks"),s=Number(a.attr("data-spelltricklimit"))||0;return e.find(".exclusiveTricks:checked").length!=s?(this._showInputValidation(a,e,t),!1):super._validateInput(e,t)}async getData(e){let t=await super.getData(e),a=await this.parseToItem(this.career.system.requirements.value,["disadvantage","advantage","specialability"]),s=a.filter(y=>["advantage","disadvantage"].includes(y.type)&&!y.disabled),i=await this.parseToItem(this.career.system.recommendedAdvantages.value,["advantage"]);this.fixPreviousCosts(a,i);let n=await this.parseToItem(this.career.system.recommendedDisadvantages.value,["disadvantage"]);this.fixPreviousCosts(a,n);let r=a.filter(y=>y.attributeRequirement),o=this._parseAttributes(this.career.system.combatSkills.value,/,|;/),c=this._parseAttributes(this.career.system.specialAbilities.value),m=this._parseAttributes(this.career.system.spells.value),d=this._parseAttributes(this.career.system.liturgies.value),p=Number(this.career.system.APValue.value),g=a.reduce(function(y,v){return y+(v.disabled?0:Number(v.system.APValue.value)||0)},0),h=a.filter(y=>y.type=="specialability"&&!y.disabled);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("career")} ${this.career.name}`}),career:this.career,description:game.i18n.format("WIZARD.careerdescr",{career:this.career.name,cost:p+g}),baseCost:p,advantages:i,disadvantages:n,missingVantages:s,specAbChoices:c,spellChoices:m,liturgyChoices:d,missingSpecialabilities:h,combatskillchoices:o,spelltricks:await this.parseToItem(this.career.system.spelltricks.value,["magictrick"]),attributeRequirements:r,advantagesToChose:i.length,disadvantagesToChose:n.length,vantagesToChose:i.length||n.length||s.length,missingVantagesToChose:s.length,missingSpecialabiltiesToChose:h.length,combatToChose:o.length,magicToChose:this.career.system.spelltrickCount.value||m.length,religionToChose:d.length,anyAttributeRequirements:r.length,generalToChose:h.length||r.length||c.length,enrichedClothing:await TextEditor.enrichHTML(getProperty(this.career.system,"clothing.value"),{secrets:!1,async:!0}),enrichedDescription:await TextEditor.enrichHTML(getProperty(this.career.system,"description.value"),{secrets:!1,async:!0})}),t}async addCareer(e,t){this.actor=e,this.career=duplicate(t)}async setAbility(e,t,a=[]){if(e.trim()=="")return;let s=[],i=[],n=game.i18n.localize("combatskillcountdivider")+":";for(let r of e.split(",").concat(a)){if(r.includes(n)||r=="")continue;let o=f.parseAbilityString(r.trim()),c=this.actor.items.find(m=>t.includes(m.type)&&m.name==o.original);if(c)c=duplicate(c),c.system.talentValue?c.system.talentValue.value=o.step:c.system.step&&(c.system.step.value=o.step),c=Z.reverseAdoptionCalculation(this.actor,o,c),i.push(c);else if(c=await this.findCompendiumItem(o.original,t),c||(c=await this.findCompendiumItem(o.name,t)),c)c=duplicate(c),c.name=o.original,c.system.talentValue?c.system.talentValue.value=o.step:c.system.step&&(c.system.step.value=o.step),c=Z.reverseAdoptionCalculation(this.actor,o,c),s.push(c);else{let m=t.map(d=>f.categoryLocalization(d)).join("/");this.errors.push(`${m}: ${r}`),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:m,name:r}))}}await this.actor.updateEmbeddedDocuments("Item",i,{render:!1}),await this.actor.createEmbeddedDocuments("Item",s,{render:!1})}async addBlessing(e,t){let a=[];for(let s of e){let i=s.trim();if(i=="")continue;let n=this.actor.items.find(r=>t==r.type&&r.name==i);n||(n=await this.findCompendiumItem(i,[t]),n?(n=duplicate(n),a.push(n)):(this.errors.push(`${f.categoryLocalization(t)}: ${s}`),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(t),name:i}))))}await this.actor.createEmbeddedDocuments("Item",a,{render:!1})}getExclusiveChoices(e,t){let a=[];for(let s of e.find(`${t}.exclusive:checked`))a.push($(s).val());return a}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.career.value,"career")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.career.value":this.career.name,"system.freeLanguagePoints.value":this.career.system.languagePoints.value};for(let n of e.find(".attributes")){let r=$(n).attr("data-attribute").toLowerCase();r=game.dsa5.config.knownShortcuts[r.toLowerCase()][1],Number(this.actor.system.characteristics[r].initial)+Number(this.actor.system.characteristics[r].advances)<Number($(n).val())&&(this.actor.canAdvance?s[`system.characteristics.${r}.advances`]=Number($(n).val())-Number(this.actor.system.characteristics[r].initial):s[`system.characteristics.${r}.initial`]=Number($(n).val()))}this.career.system.mageLevel.value!="mundane"&&(s[`system.guidevalue.${this.career.system.mageLevel.value}`]=this.career.system.guidevalue.value,s[`system.energyfactor.${this.career.system.mageLevel.value}`]=this.career.system.guidevalue.factor,s[`system.tradition.${this.career.system.mageLevel.value}`]=this.career.system.tradition.value,s[`system.feature.${this.career.system.mageLevel.value}`]=this.career.system.feature.value),this.career.system.mageLevel.value=="clerical"&&(s["system.happyTalents.value"]=this.career.system.happyTalents.value,await this.setAbility(this.career.system.liturgies.value,["liturgy","ceremony"],this.getExclusiveChoices(e,".liturgy")),await this.addBlessing(this.career.system.blessings.value.split(","),"blessing")),this.career.system.mageLevel.value=="magical"&&await this.setAbility(this.career.system.spells.value,["spell","ritual"],this.getExclusiveChoices(e,".spell")),await this.setAbility(this.career.system.specialAbilities.value,["specialability"],this.getExclusiveChoices(e,".specialability")),await this.actor._updateAPs(a,{},{render:!1}),await this.addSelections(e.find(".optional:checked"),!1),await this.updateSkill(this.career.system.skills.value.split(","),"skill");let i=this.career.system.combatSkills.value.split(",").concat(this.getExclusiveChoices(e,".combatskill")).filter(n=>!(n.includes(game.i18n.localize("combatskillcountdivider")+":")||n==""));await this.updateSkill(i,"combatskill",1,!1),await this.actor.update(s),this.finalizeUpdate()}};u(Ye,"CareerWizard");var Je=class extends se{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")}`}),e.template="systems/dsa5/templates/wizard/add-species-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content"),s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),se.flashElem(i,"emphasize2")})}async _toGroups(e,t,a){return await Promise.all(e.split(`
`).map(async i=>{let n=i.split(":"),r;return n.length>1?r={name:n[0].trim(),res:await this.parseToItem(n[1].trim(),t)}:r={name:"",res:await this.parseToItem(i,t)},this.fixPreviousCosts(a,r.res),r}))}async getData(e){let t=await super.getData(e),a=await this.parseToItem(this.species.system.requirements.value,["disadvantage","advantage"]),s=a.filter(m=>["advantage","disadvantage"].includes(m.type)&&!m.disabled),i=await this._toGroups(this.species.system.recommendedAdvantages.value,["advantage"],a),n=await this._toGroups(this.species.system.recommendedDisadvantages.value,["disadvantage"],a),r=this._parseAttributes(this.species.system.attributeChange.value),o=Number(this.species.system.APValue.value),c=a.reduce(function(m,d){return m+(d.disabled?0:Number(d.system.APValue.value)||0)},0);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")} ${this.species.name}`}),species:this.species,description:game.i18n.format("WIZARD.speciesdescr",{species:this.species.name,cost:o+c}),advantagegroups:i,baseCost:o,disadvantagegroups:n,missingVantages:s,attributeRequirements:r,hasLocalization:game.i18n.has(`Racedescr.${this.species.name}`),anyAttributeRequirements:r.length>0,advantagesToChose:i.length>0,missingVantagesToChose:s.length>0,disadvantagesToChose:n.length>0,vantagesToChose:i.length>0||n.length>0||s.length>0,generalToChose:r.length>0}),t}async addSpecies(e,t){this.actor=e,this.species=duplicate(t)}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.species.value,"species")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.species.value":this.species.name,"system.status.speed.initial":this.species.system.baseValues.speed.value,"system.status.soulpower.initial":this.species.system.baseValues.soulpower.value,"system.status.toughness.initial":this.species.system.baseValues.toughness.value,"system.status.wounds.initial":this.species.system.baseValues.wounds.value,"system.status.wounds.value":this.species.system.baseValues.wounds.value+this.actor.system.characteristics.ko.value*2},i=[];for(let n of e.find(".exclusive:checked"))i.push($(n).val());Object.keys(b.characteristics).forEach(n=>{s[`system.characteristics.${n}.species`]=0});for(let n of this.species.system.attributeChange.value.split(",").concat(i)){if(n.includes(game.i18n.localize("combatskillcountdivider")+":")||n=="")continue;let r=n.trim().split(" "),o=game.dsa5.config.knownShortcuts[r[0].toLowerCase().trim()].slice(0);o[o.length-1]="species",s[`system.${o.join(".")}`]=Number(r[1])}await this.actor._updateAPs(a,{},{render:!1}),await this.addSelections(e.find(".optional:checked"),!1),await this.actor.update(s),await this.actor.removeCondition("incapacitated"),this.finalizeUpdate()}};u(Je,"SpeciesWizard");var he=class extends Me{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","character-sheet"]),width:784}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/actor-sheet.html"}async _manageDragItems(e,t){switch(t){case"aggregatedTest":await this.actor.createEmbeddedDocuments("Item",[e]);break;case"species":let a=new Je;await a.addSpecies(this.actor,e),a.render(!0);break;case"culture":let s=new Ke;await s.addCulture(this.actor,e),s.render(!0);break;case"career":let i=new Ye;await i.addCareer(this.actor,e),i.render(!0);break;default:return super._manageDragItems(e,t)}}};u(he,"ActorSheetdsa5Character");var Ie=class extends Me{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","creature-sheet"])}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/creature-limited.html":"systems/dsa5/templates/actors/creature-sheet.html"}async getData(e){let t=await super.getData(e);return t.enrichedDescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"description.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedBehaviour=await TextEditor.enrichHTML(getProperty(this.actor.system,"behaviour.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedFlight=await TextEditor.enrichHTML(getProperty(this.actor.system,"flight.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedSpecialrules=await TextEditor.enrichHTML(getProperty(this.actor.system,"specialRules.value"),{secrets:this.object.isOwner,async:!0}),t}async _cleverDeleteItem(e){let t=this.actor.items.find(a=>a.id==e);switch(t.type){case"trait":await this._updateAPs(t.system.APValue.value*-1,{},{render:!1});break}await super._cleverDeleteItem(e)}async _addTrait(e){this.actor.items.find(a=>a.type=="trait"&&a.name==e.name)||(await this._updateAPs(e.system.APValue.value,{},{render:!1}),await ce.traitAdded(this.actor,e),await this.actor.createEmbeddedDocuments("Item",[e]))}async _onDropItemCreate(e){return e.type=="trait"?this._addTrait(e):super._onDropItemCreate(e)}};u(Ie,"ActorSheetdsa5Creature");var Ee=class extends he{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","npc-sheet"])}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/npc-sheet.html"}};u(Ee,"ActorSheetdsa5NPC");var Xe=u(l=>class extends l{async obfuscateItem(e){e.stopPropagation(),e.preventDefault();let t=e.currentTarget.dataset.obfuscate;await this.item.update({[`system.obfuscation.${t}`]:!this.isObfuscated(t)})}isObfuscated(e){return getProperty(this.item,`system.obfuscation.${e}`)}activateListeners(e){super.activateListeners(e),e.on("click",".obfuscateSection",t=>this.obfuscateItem(t))}obfuscationCss(e){return this.isObfuscated(e)?"":" pale"}async _render(e=!1,t={}){await super._render(e,t);let a=["details","effects","description","enchantment"],s=!1;for(let i of a){let n=$(this._element).find(`nav [data-tab="${i}"]`);if(!n.length)continue;let r=t.tabsinvisible||this.isObfuscated(i),o=game.i18n.localize(`SHEET.${r?"deobfuscateItem":"obfuscateItem"}`);if(game.user.isGM){let c=`obfuscateSection${this.obfuscationCss(i)}`,m=n.find(`.${c}`),d=`<a data-tooltip="${o}" class="obfuscationBtn ${c}" data-obfuscate="${i}"><i class="fas fa-mask"></i></a>`;m.length?m.replaceWith(d):n.append(` ${d}`)}else r&&(n.hasClass("active")&&(s=!0),n.remove(),i=="details"&&$(this._element).find('[name="system.price.value"],[name="system.price.raw"]').replaceWith("<label>?</label>"))}if(s){let i=$(this._element).find("nav .item:first-child");if(i.length)this.activateTab(i.attr("data-tab"));else{let n=await renderTemplate("systems/dsa5/templates/items/obfuscatedItem.html",{item:this.item});$(this._element).find(".content").html(n)}}}},"ItemSheetObfuscation");var K=class extends ItemSheet{_getSubmitData(e={}){let t=super._getSubmitData(e),a=foundry.utils.flattenObject(this.item.overrides||{});return Object.keys(a).forEach(s=>delete t[s]),t}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{tabs:[{navSelector:".tabs",contentSelector:".content"}],classes:e.classes.concat(["dsa5","item"]),width:471,height:500}),e}static setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsa5",K,{makeDefault:!0}),Items.registerSheet("dsa5",Is,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsa5",ws,{makeDefault:!0,types:["career"]}),Items.registerSheet("dsa5",Ts,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsa5",Os,{makeDefault:!0,types:["advantage","disadvantage"]}),Items.registerSheet("dsa5",Es,{makeDefault:!0,types:["ritual","ceremony","liturgy","spell"]}),Items.registerSheet("dsa5",Ms,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsa5",As,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsa5",Ds,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsa5",Ss,{makeDefault:!0,types:["disease"]}),Items.registerSheet("dsa5",vs,{makeDefault:!0,types:["consumable"]}),Items.registerSheet("dsa5",$s,{makeDefault:!0,types:["spellextension"]}),Items.registerSheet("dsa5",Cs,{makeDefault:!0,types:["magictrick"]}),Items.registerSheet("dsa5",ks,{makeDefault:!0,types:["blessing"]}),Items.registerSheet("dsa5",bs,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsa5",ps,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsa5",gs,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsa5",us,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsa5",fs,{makeDefault:!0,types:["plant"]}),Items.registerSheet("dsa5",ys,{makeDefault:!0,types:["magicalsign"]}),Items.registerSheet("dsa5",hs,{makeDefault:!0,types:["patron"]}),Items.registerSheet("dsa5",ms,{makeDefault:!0,types:["information"]}),Items.registerSheet("dsa5",ds,{makeDefault:!0,types:["aggregatedTest"]}),Items.unregisterSheet("dsa5",K,{types:["armor","equipment","rangeweapon","blessing","magictrick","spellextension","consumable","aggregatedTest","species","career","culture","advantage","specialability","disadvantage","ritual","information","ceremony","liturgy","spell","disease","poison","meleeweapon","ammunition","plant","magicalsign","patron"]})}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".close").attr("data-tooltip","SHEET.Close"),$(this._element).find(".configure-sheet").attr("data-tooltip","SHEET.Configure"),$(this._element).find(".import").attr("data-tooltip","SHEET.Import"),$(this._element).find(".rolleffect").attr("data-tooltip","SHEET.RollEffect"),$(this._element).find(".showItemHead").attr("data-tooltip","SHEET.PostItem"),$(this._element).find(".consumeItem").attr("data-tooltip","SHEET.ConsumeItem"),$(this._element).find(".rollDamaged").attr("data-tooltip","DSASETTINGS.armorAndWeaponDamage"),$(this._element).find(".onUseEffect").attr("data-tooltip","SHEET.onUseEffect"),$(this._element).find(".postAsGroupCheck").attr("data-tooltip","SHEET.postAsGroupCheck")}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:async()=>this.item.postItem()}),this.item.actor&&J.getOnUseEffect(this.item)&&e.unshift({class:"onUseEffect",icon:"fas fa-dice-six",onclick:async()=>{new J(this.item).executeOnUseEffect()}}),e}setupEffect(e){this.item.setupEffect().then(t=>this.item.itemTest(t))}get template(){return`systems/dsa5/templates/items/item-${this.item.type}-sheet.html`}_getItemId(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}_advanceStep(){}_refundStep(){}async advanceWrapper(e,t){let s=$(e.currentTarget).find("i");s.hasClass("fa-spin")||(s.addClass("fa-spin fa-spinner"),await this[t](),s.removeClass("fa-spin fa-spinner"))}activateListeners(e){super.activateListeners(e),ne(e),e.find(".advance-step").mousedown(a=>this.advanceWrapper(a,"_advanceStep")),e.find(".refund-step").mousedown(a=>this.advanceWrapper(a,"_refundStep")),e.find(".domainsPretty").click(a=>{$(a.currentTarget).hide(),$(a.currentTarget).next(".domainToggle").show()}),e.find('[data-edit="img"]').mousedown(a=>{a.button==2&&f.showArtwork(this.item)}),e.find(".status-add").click(()=>{E.createCustomEffect(this.item,"",this.item.name)}),e.find(".condition-show").mousedown(a=>{a.preventDefault();let s=a.currentTarget.dataset.id;a.button==0?this.item.effects.get(s).sheet.render(!0):a.button==2&&this.item.deleteEmbeddedDocuments("ActiveEffect",[s])}),e.find(".select2").select2(),e.find(".condition-toggle").mousedown(a=>{let s=$(a.currentTarget).parents(".statusEffect").attr("data-id"),i=this.item.effects.get(s);i.update({disabled:!i.disabled})}),e.find(".condition-edit").click(a=>{this.item.effects.get(a.currentTarget.dataset.id).sheet.render(!0)}),te.bindRollCommands(e),E.bindButtons(e);let t=e.find(".item-header");if(t.length){let a=t.find("svg");if(a){new ResizeObserver(function(n){let r=n[0];ki(a,r.contentRect.width)}).observe(t.get(0));let i=t.find("input");i.get(0).disabled||(a.click(()=>{a.hide(),i.show(),i.focus()}),i.blur(function(){a.show(),i.hide()}))}}}async getData(e){let t=super.getData(e).data;switch(this.item.type){case"skill":t.characteristics=b.characteristics,t.skillGroups=b.skillGroups,t.skillBurdens=b.skillBurdens,t.hasLocalization=game.i18n.has(`SKILLdescr.${this.item.name}`),t.StFs=b.StFs;break;case"application":t.hasLocalization=game.i18n.has(`APPLICATION.${this.item.system.skill} - ${this.item.name}`),t.localization=game.i18n.localize(`APPLICATION.${this.item.system.skill} - ${this.item.name}`),t.allSkills=await f.allSkillsList();break;case"combatskill":t.weapontypes=b.weapontypes,t.guidevalues=b.combatskillsGuidevalues,t.hasLocalization=game.i18n.has(`Combatskilldescr.${this.item.name}`),t.StFs=b.StFs;break;case"trait":t.traitCategories=b.traitCategories,t.ranges=b.meleeRanges;break}if(t.isOwned=this.item.actor,t.editable=this.isEditable,t.isOwned){t.canAdvance=this.item.actor.canAdvance&&this._advancable();let a=getProperty(this.item,"flags.dsa5.customPriceTag");!this.isEditable&&a&&(t.customPrice=a)}return E.prepareActiveEffects(this.item,t),t.item=this.item,t.armorAndWeaponDamage=game.settings.get("dsa5","armorAndWeaponDamage"),t.isGM=game.user.isGM,t.enrichedDescription=await TextEditor.enrichHTML(getProperty(this.item.system,"description.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.item.system,"gmdescription.value"),{secrets:this.object.isOwner,async:!0}),t}_advancable(){return!1}};u(K,"ItemSheetdsa5");var ds=class extends K{async getData(e){let t=await super.getData(e),a=this.item.getFlag("dsa5","embeddedItem"),s;return a&&(s=await renderTemplate(`systems/dsa5/templates/items/browse/${a.type}.html`,{document:a})),mergeObject(t,{allSkills:await f.allSkillsList(),embeddedItem:a,renderedItem:s,enrichedsuccess:await TextEditor.enrichHTML(this.item.system.success,{secrets:this.item.isOwner,async:!0}),enrichedpartsuccess:await TextEditor.enrichHTML(this.item.system.partsuccess,{secrets:this.item.isOwner,async:!0})}),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned||e.unshift({class:"postAsGroupCheck",icon:"fas fa-dice-d20",onclick:async()=>this.postAsGroupCheck()}),e}async postAsGroupCheck(){let e=["value","value2","value3"].filter(a=>this.item.system.talent[a]).map(a=>({type:"skill",modifier:this.item.system.baseModifier,calculatedModifier:this.item.system.baseModifier,target:this.item.system.talent[a]}));if(!e.length)return;let t={modifier:this.item.system.baseModifier,maxRolls:this.item.system.allowedTestCount.value,enrichedsuccess:await TextEditor.enrichHTML(this.item.system.success,{secrets:this.item.isOwner,async:!0}),enrichedpartsuccess:await TextEditor.enrichHTML(this.item.system.partsuccess,{secrets:this.item.isOwner,async:!0}),rollOptions:e};B.showGCMessage(e[0].target,0,t)}activateListeners(e){super.activateListeners(e),e.find(".buildItem").click(async()=>this.postFinishedItem())}async postFinishedItem(){if(!this.item.actor)return;let e=this.item.getFlag("dsa5","embeddedItem");if(!e)return;let t=await renderTemplate("systems/dsa5/templates/chat/production-result.html",{actor:this.item.actor,item:e,actorImg:H.videoOrImgTag(this.item.actor.img)}),a=f.chatDataSetup(t);a.flags={dsa5:{embeddedItem:e}},await ChatMessage.create(a)}};u(ds,"AggregatedTestSheet");var Qe=class extends K{async _onDrop(e){await this.enchant(e),this.isPoisonable&&await this.poison(e)}async enchant(e){let t=JSON.parse(e.dataTransfer.getData("text/plain"));await this._enchant([t])}async _enchant(e){let t=this.item.getFlag("dsa5","enchantments")||[];if(t.length+e.length>7)return ui.notifications.error(game.i18n.localize("DSAError.tooManyEnchants"));for(let a of e){let{item:s,typeClass:i,selfTarget:n}=await Fe(a,void 0,!1);if(["spell","liturgy","ceremony","ritual"].includes(i)){if(!s.pack)return ui.notifications.error(game.i18n.localize("DSAError.onlyCompendiumSpells"));let r={name:s.name,pack:s.pack,id:t.length,itemId:s.id,permanent:["liturgy","ceremony"].includes(i)||a.permanent,actorId:a.actorId,charged:!0,talisman:["liturgy","ceremony"].includes(i),fw:["liturgy","ceremony"].includes(i)?18:a.fw||0};t.push(r)}}if(t.length){let a={flags:{dsa5:{enchantments:t}}};await this.item.update(a)}}async poison(e){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:a,typeClass:s,selfTarget:i}=await Fe(t,void 0,!1);if(s=="poison"){let r={flags:{dsa5:{poison:{name:a.name,pack:a.pack,itemId:a._id,permanent:!1,actorId:t.actorId}}}};await this.item.update(r)}}toggleChargedState(e,t){for(let a of t)if(a.id==e){a.charged=a.talisman&&a.permanent?!0:!a.charged;break}this.item.update({flags:{dsa5:{enchantments:t}}})}activateListeners(e){super.activateListeners(e),e.find(".ench-toggle-permanent").click(t=>{let{id:a,enchantments:s}=this.enchantMentId(t);for(let i of s)if(i.id==a){i.permanent=!i.permanent;break}this.item.update({flags:{dsa5:{enchantments:s}}})}),e.find(".ench-toggle-charge").click(t=>{let{id:a,enchantments:s}=this.enchantMentId(t);this.toggleChargedState(a,s)}),e.find(".ench-roll").click(async t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=s.find(r=>r.id==a);if(!i.charged)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));let n=await this.getSpell(i);if(n){n=n.toObject(),n.system.talentValue.value=i.fw;let r=await f.emptyActor(14,this.item.name);r.setupSpell(n,{},"emptyActor").then(async o=>{let c=game.i18n.format("CHATNOTIFICATION.enchantmentUsed",{item:this.item.name,spell:n.name});await ChatMessage.create(f.chatDataSetup(c)),await r.basicTest(o),i.permanent?this.toggleChargedState(a,s):this.deleteEnchantment(a,s)})}}),e.find(".ench-fw").change(t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=Number($(t.currentTarget).val());if(!!i){for(let n of s)if(n.id==a){n.fw=i;break}this.item.update({flags:{dsa5:{enchantments:s}}})}}),e.find(".ench-delete").click(t=>{let{id:a,enchantments:s}=this.enchantMentId(t);this.deleteEnchantment(a,s)}),e.find(".ench-show").click(async t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=s.find(r=>r.id==a),n=await this.getSpell(i);n&&n.sheet.render(!0)}),e.find(".poison-toggle-permanent").click(t=>{this.item.update({flags:{dsa5:{poison:{permanent:!this.item.flags.dsa5.poison.permanent}}}})}),e.find(".poison-delete").click(t=>{this.deletePoison()}),e.find(".poison-show").click(async()=>{let t;this.item.actor&&(t=this.item.actor.items.find(a=>a.type=="poison"&&a.name==this.item.flags.dsa5.poison.name)),t||(t=await this.getSpell(this.item.flags.dsa5.poison)),t&&t.sheet.render(!0)})}deletePoison(){this.item.update({["flags.dsa5.-=poison"]:null})}deleteEnchantment(e,t){let a=t.findIndex(s=>s.id==e);t.splice(a,1),this.item.update({flags:{dsa5:{enchantments:t}}})}async getSpell(e){let t=await game.packs.get(e.pack);if(!t){ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound"));return}let a=await t.getDocument(e.itemId);if(!a){let s=await t.index.getName(e.name);s&&(a=await t.getDocument(s._id))}return a||ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),a}enchantMentId(e){return{id:$(e.currentTarget).parents(".statusEffect").attr("data-id"),enchantments:this.item.getFlag("dsa5","enchantments")}}prepareDomains(){let e=getProperty(this.item.system,"effect.attributes");if(e){let t=new RegExp(game.i18n.localize("WEAPON.magical"),"i"),a=new RegExp(game.i18n.localize("WEAPON.clerical"),"i");e=e.split(",").map(s=>{let i="";return t.test(s)?i="magical":a.test(s)&&(i="blessed"),`<li class="${i}">${s}</li>`}).join("")}return e}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{dragDrop:[{dragSelector:".item-list .item",dropSelector:".content"}]}),e}_canDragDrop(e){return this.isEditable}async getData(e){let t=await super.getData(e);t.enchantments=this.item.getFlag("dsa5","enchantments");let a=[];return t.poison=this.item.getFlag("dsa5","poison"),t.poison&&a.push("poison"),t.enchantments&&t.enchantments.some(s=>!s.talisman)&&a.push("enchantment"),t.enchantments&&t.enchantments.some(s=>s.talisman)&&a.push("talisman"),t.enchantmentLabel=a.map(s=>game.i18n.localize(s)).join("/"),t.traditionArtifacts=b.traditionArtifacts,t.hasEnchantments=t.poison||t.enchantments&&t.enchantments.length>0,t}};u(Qe,"Enchantable");var ms=class extends K{async getData(e){let t=await super.getData(e);return mergeObject(t,{allSkills:await f.allSkillsList(),enrichedqs1:await TextEditor.enrichHTML(this.item.system.qs1,{async:!0}),enrichedqs2:await TextEditor.enrichHTML(this.item.system.qs2,{async:!0}),enrichedqs3:await TextEditor.enrichHTML(this.item.system.qs3,{async:!0}),enrichedqs4:await TextEditor.enrichHTML(this.item.system.qs4,{async:!0}),enrichedqs5:await TextEditor.enrichHTML(this.item.system.qs5,{async:!0}),enrichedqs6:await TextEditor.enrichHTML(this.item.system.qs6,{async:!0}),enrichedCrit:await TextEditor.enrichHTML(this.item.system.crit,{async:!0}),enrichedBotch:await TextEditor.enrichHTML(this.item.system.botch,{async:!0}),enrichedFail:await TextEditor.enrichHTML(this.item.system.fail,{async:!0})}),t}};u(ms,"InformationSheet");var us=class extends Qe{constructor(e,t){super(e,t),this.isPoisonable=!0}async getData(e){let t=await super.getData(e);return t.ammunitiongroups=b.ammunitiongroups,t.domains=this.prepareDomains(),t}};u(us,"AmmunitionSheet");var ps=class extends Xe(Qe){async getData(e){let t=await super.getData(e);if(mergeObject(t,{equipmentTypes:b.equipmentTypes,domains:this.prepareDomains(),canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")}),this.isBagWithContents()){let a=0;mergeObject(t,{containerContent:this.item.actor.items.filter(s=>b.equipmentCategories.has(s.type)&&s.system.parent_id==this.item.id).map(s=>{s.system.preparedWeight=parseFloat((s.system.weight.value*s.system.quantity.value).toFixed(3)),a+=Number(s.system.preparedWeight);let i=getProperty(s,"flags.dsa5.enchantments");return i&&i.length>0?s.enchantClass="rar":(s.system.effect&&s.system.effect.value!=""||s.effects.length>0)&&(s.enchantClass="common"),s}),weightSum:parseFloat(a.toFixed(3)),weightWidth:`style="width: ${Math.min(this.item.system.capacity?a/this.item.system.capacity*100:0,100)}%"`,weightExceeded:a>Number(this.item.system.capacity)?"exceeded":""})}return t}async breakOverflow(e,t){let a=$(await renderTemplate("systems/dsa5/templates/items/baghover.html",e)),s=t.offset().top+52,i=t.offset().left-75;return a.appendTo($("body")),a.css({position:"absolute",left:i+"px",top:s+"px",bottom:"auto",right:"auto","z-index":1e4}),a}activateListeners(e){super.activateListeners(e);let t=e.find(".slot");t.mouseenter(async a=>{let s=$(a.currentTarget),i=await this.breakOverflow({name:s.attr("data-name"),weight:s.attr("data-weight"),quantity:s.attr("data-quantity")},s);i.fadeIn(),s.mouseleave(()=>{i.remove(),s.off("mouseleave")})}),t.mousedown(async a=>{let s=a.currentTarget.dataset.itemId,i=this.actor.items.get(s);a.button==0?i.sheet.render(!0):a.button==2&&($(".itemInfo").remove(),await i.update({"system.parent_id":0}),this.render(!0))})}isBagWithContents(){return this.item.actor&&getProperty(this.item,"system.equipmentType.value")=="bags"}async _onDrop(e){if(this.isBagWithContents()){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:a,typeClass:s,selfTarget:i}=await Fe(t,void 0),n=this.item.id==a.id,r=this.item.parent.id==t.actorId;if(b.equipmentCategories.has(s)&&!n){a.system.parent_id=this.item.id,a.system.worn&&a.system.worn.value&&(a.system.worn.value=!1),r?await this.item.actor.updateEmbeddedDocuments("Item",[a]):await this.item.actor.sheet._addLoot(a),this.render(!0);return}}await super._onDrop(e)}};u(ps,"EquipmentSheet");var gs=class extends Xe(Qe){async getData(e){let t=await super.getData(e);return mergeObject(t,{domains:this.prepareDomains(),armorSubcategories:Object.keys(b.armorSubcategories),breakPointRating:b.armorSubcategories[this.item.system.subcategory]}),t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>W.breakingTest(this.item)}),e}};u(gs,"ArmorSheet");var fs=class extends Xe(K){async getData(e){let t=await super.getData(e);return t.attributes=Object.keys(t.system.planttype).map(a=>({name:a,checked:t.system.planttype[a]})),t.enrichedEffect=await TextEditor.enrichHTML(getProperty(this.item.system,"effect"),{secrets:this.object.isOwner,async:!0}),t.enrichedRecipes=await TextEditor.enrichHTML(getProperty(this.item.system,"recipes"),{secrets:this.object.isOwner,async:!0}),t.enrichedInformation=await TextEditor.enrichHTML(getProperty(this.item.system,"infos"),{secrets:this.object.isOwner,async:!0}),t}};u(fs,"PlantSheet");var hs=class extends K{async getData(e){let t=await super.getData(e);return t.patronCategories=[0,1,2,3].map(a=>({name:game.i18n.localize(`PATRON.${a}`),val:a})),t.priorities={0:game.i18n.localize("PATRON.primary"),1:game.i18n.localize("PATRON.secondary")},t}};u(hs,"PatronSheet");var ys=class extends K{async getData(e){let t=await super.getData(e);return t.categories={1:game.i18n.localize("TYPES.Item.magicalsign"),2:game.i18n.localize("additionalsign")},t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async setupEffect(e){let t=Number(this.item.system.asp)||0;if(this.item.actor.system.status.astralenergy.value<t)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP"));let a=this.item.actor,s=game.dsa5.config.ItemSubclasses.magicalsign,i=a.items.find(r=>r.type=="skill"&&r.name==game.i18n.localize("LocalizedIDs.artisticAbility")),n=`<hr/><p><b>${this.item.name}</b></p><p>${this.item.system.description.value}</p><p>${s.chatData(this.item.system,"").join("</br>")} <span class="costCheck"></span></p>`;a.setupSkill(i,{other:[n],subtitle:` (${game.i18n.localize("TYPES.Item.magicalsign")})`},void 0).then(async r=>{let o=await a.basicTest(r,{suppressMessage:!0});o.result.preData.calculatedSpellModifiers={finalcost:t,costsMana:!0},await _DiceDSA5.renderRollCard(o.cardOptions,o.result,o.options.rerenderMessage)})}};u(ys,"MagicalSignSheet");var bs=class extends Xe(Qe){_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>W.breakingTest(this.item)}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),ammunitiongroups:b.ammunitiongroups,combatskills:await f.allCombatSkillsList("range"),domains:this.prepareDomains(),breakPointRating:b.weaponStabilities[game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)]}),t}};u(bs,"RangeweaponSheet");var ks=class extends K{_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async setupEffect(e){if(this.item.actor.system.status.karmaenergy.value<1)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughKaP"));let t=game.dsa5.config.ItemSubclasses.magictrick;await this.item.actor.update({"system.status.karmaenergy.value":this.item.actor.system.status.karmaenergy.value-=1});let a=`<p><b>${this.item.name} - ${game.i18n.localize("blessing")} ${game.i18n.localize("probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(f.chatDataSetup(a))}};u(ks,"BlessingSheetDSA5");var ws=class extends K{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e),a=duplicate(b.characteristics);return a["-"]="-",t.mageLevels=b.mageLevels,t.guidevalues=a,t.enrichedClothing=await TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:this.object.isOwner,async:!0}),t}};u(ws,"ItemCareerDSA5");var vs=class extends Xe(K){static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:480}),e}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"consumeItem",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.calculatedPrice=C.getSubClass(this.item.type).consumablePrice(this.item),t.availableSteps=t.system.QLList.split(`
`).map((a,s)=>s+1),t.equipmentTypes=b.equipmentTypes,t.enrichedIngredients=await TextEditor.enrichHTML(getProperty(this.item.system,"ingredients"),{secrets:this.object.isOwner,async:!0}),t}setupEffect(e){this.item.setupEffect()}};u(vs,"ConsumableSheetDSA5");var Ts=class extends K{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e);return t.enrichedClothing=await TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:this.object.isOwner,async:!0}),t}};u(Ts,"ItemCultureDSA5");var Ss=class extends K{_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.resistances=b.magicResistanceModifiers,t}};u(Ss,"DiseaseSheetDSA5");var Cs=class extends K{_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async setupEffect(e){if(this.item.actor.system.status.astralenergy.value<1)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP"));let t=game.dsa5.config.ItemSubclasses.magictrick;await this.item.actor.update({"system.status.astralenergy.value":this.item.actor.system.status.astralenergy.value-=1});let a=`<p><b>${this.item.name} - ${game.i18n.localize("magictrick")} ${game.i18n.localize("probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(f.chatDataSetup(a))}};u(Cs,"MagictrickSheetDSA5");var As=class extends Xe(Qe){constructor(e,t){super(e,t),this.isPoisonable=!0}async getData(e){let t=await super.getData(e),a=mergeObject(duplicate(b.characteristics),{"ge/kk":game.i18n.localize("CHAR.GEKK"),["-"]:"-"}),s=_.regex2h.test(this.item.name),i="";if(!s)i="wrongGrip.yieldTwo";else switch(game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")).test(this.item.name)?i="wrongGrip.yieldOneBastard":i="wrongGrip.yieldOneSwordBlunt";break;default:i="wrongGrip.yieldOnePolearms"}if(mergeObject(t,{characteristics:a,twoHanded:s,wrongGripLabel:s?"wrongGrip.oneHanded":"wrongGrip.twoHanded",wrongGripHint:i,combatskills:await f.allCombatSkillsList("melee"),ranges:b.meleeRanges,shieldSizes:b.shieldSizes,isShield:_.isShield(this.item),domains:this.prepareDomains(),breakPointRating:b.weaponStabilities[game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)]}),this.item.actor){let n=this.item.actor.items.find(r=>r.type=="combatskill"&&r.name==this.item.system.combatskill.value);t.canBeOffHand=n&&!n.system.weapontype.twoHanded&&this.item.system.worn.value,t.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`))}return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>W.breakingTest(this.item)}),e}};u(As,"MeleeweaponSheetDSA5");var Ds=class extends Xe(K){_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.resistances=b.magicResistanceModifiers,t}};u(Ds,"PoisonSheetDSA5");var Ms=class extends K{async _refundStep(){if(this.item.system.step.value>1){let e=await L.stepXPCost(this.item,this.item.system.step.value-1);e=await L.refundFreelanguage(this.item,this.item.actor,e,!1),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value-1})}}async _advanceStep(){if(this.item.system.step.value<this.item.system.maxRank.value){let e=await L.stepXPCost(this.item,this.item.system.step.value);e=await L.isFreeLanguage(this.item,this.item.actor,e,!1),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value+1}))}}_advancable(){return this.item.system.maxRank.value>0}async getData(e){let t=await super.getData(e);return mergeObject(t,{categories:b.specialAbilityCategories,subCategories:b.combatSkillSubCategories,traditionArtifacts:b.traditionArtifacts,canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")}),t}};u(Ms,"SpecialAbilitySheetDSA5");var Is=class extends K{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:530,height:570}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{hasLocalization:game.i18n.has(`Racedescr.${this.item.name}`)}),t}};u(Is,"ItemSpeciesDSA5");var Es=class extends K{async getData(e){let t=await super.getData(e);return t.characteristics=b.characteristics,t.StFs=b.StFs,t.resistances=b.magicResistanceModifiers,t.targetTypes=b.areaTargetTypes,t.isOwned&&(t.extensions=this.item.actor.items.filter(a=>a.type=="spellextension"&&a.system.source==this.item.name&&this.item.type==a.system.category)),t}activateListeners(e){super.activateListeners(e),e.find(".item-edit").click(t=>{t.preventDefault();let a=this._getItemId(t);this.item.actor.items.get(a).sheet.render(!0)}),e.find(".item-delete").click(t=>{this._deleteItem(t)})}_deleteItem(e){let t=this._getItemId(e),a=this.actor.items.find(i=>i.id==t),s=game.i18n.format("DIALOG.DeleteItemDetail",{item:a.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:s}).then(i=>{new Dialog({title:game.i18n.localize("DIALOG.deleteConfirmation"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{this._cleverDeleteItem(t),$(e.currentTarget).closest(".item").remove()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)})}async _cleverDeleteItem(e){let t=this.item.actor.items.find(a=>a.id==e);await this.item.actor._updateAPs(-1*t.system.APValue.value,{},{render:!1}),await this.item.actor.deleteEmbeddedDocuments("Item",[e])}};u(Es,"SpellSheetDSA5");var $s=class extends K{async getData(e){let t=await super.getData(e);return mergeObject(t,{categories:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}),t}};u($s,"SpellExtensionSheetDSA5");var Os=class extends K{_advancable(){return this.item.system.max.value>0}async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async _refundStep(){if(this.item.system.step.value>1){let e=await x.stepXPCost(this.item,this.item.system.step.value-1);e=await x.reduceSingularVantages(this.item.actor,this.item,e),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value-1})}}async _advanceStep(){if(this.item.system.step.value<this.item.system.max.value){let e=await x.stepXPCost(this.item,this.item.system.step.value),t=duplicate(this.item);t.system.step.value+=1,e=await x.addSingularVantages(this.item.actor,t,e),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value+1}))}}};u(Os,"VantageSheetDSA5");var Ui={"":"Modifier",defenseMalus:"MODS.defenseMalus",FW:"MODS.FW",KaPCost:"CHAR.KaPCost",AsPCost:"CHAR.AsPCost",FP:"MODS.FP",QL:"MODS.QS",dmg:"MODS.damage",damageBonus:"MODS.damage",armorPen:"MODS.armorPen",TPM:"MODS.partChecks"};function Vi(l,e){return`<span class="searchableAbility" data-category="${e}">`+l.split(",").map(t=>`<a>${t}</a>`).join(", ")+"<span>"}u(Vi,"clickableAbilities");function Mi(l,e,t,a){if(a)return e.map(s=>`<span class="actorEmbeddedAbility" data-actor="${l.uuid}" data-id="${s._id}"><a>${s.name}${Ii(getProperty(s.system,t),getProperty(s.system,a))}</a></span>`).join(", ");if(t){let s=[];for(let i of e){let n=getProperty(i.system,t);if(n){s.push(`<span class="actorEmbeddedAbility" data-actor="${l.uuid}" data-id="${i._id}"><a>${i.name} ${n}</a></span>`);continue}}return s.join(", ")}else return e.map(s=>`<span class="actorEmbeddedAbility" data-actor="${l.uuid}" data-id="${s._id}"><a>${s.name}</a></span>`).join(", ")}u(Mi,"clickableActorItems");function Ki(l,e,t,a){let s=[];for(let i of Object.values(e)){if(i.length==0)continue;let n=Mi(l,i,t,a);n&&s.push(n)}return s.join(", ")}u(Ki,"clickableSection");function Ii(l,e){return e!=null&&Number(e)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][l-1]}u(Ii,"roman");function ei(){Handlebars.registerHelper({concatUp:(l,e)=>l+e.toUpperCase(),mod:(l,e)=>l%e,roman:(l,e)=>Ii(l,e),isWEBM:l=>/.webm$/.test(l),itemCategory:l=>f.categoryLocalization(l),joinStr:(l,e)=>e.join(l),attrName:l=>f.attributeLocalization(l),attrAbbr:l=>f.attributeAbbrLocalization(l),diceThingsUp:(l,e)=>f.replaceDies(l,!1),clickableAbilities:(l,e)=>Vi(l,e),clickableActorItems:(l,e,t,a)=>Mi(l,e,t,a),clickableSection:(l,e,t,a)=>Ki(l,e,t,a),hasLocalization:(l,e)=>{let t=l.string||l;return game.i18n.has(t)?game.i18n.localize(t):e||""},replaceConditions:f.replaceConditions,floor:l=>Math.floor(Number(l)),sum:(l,e)=>l+e,br:l=>l.replace(/\n/g,"<br/>"),getAttr:(l,e,t)=>l.system.characteristics[e][t],hasElem:(l,e)=>l.some(t=>e==t),situationalTooltip:l=>{let e=game.i18n.localize(Ui[l.type]||"Modifier"),t=`${l.name}<br/>${e}: ${l.value}`;return l.source&&(t+=`<br/>${game.i18n.localize("source")}: ${l.source}`),t},grouped_each:(l,e,t)=>{let a="",s=[],i;if(e&&e.length>0){for(i=0;i<e.length;i++)i>0&&i%l===0&&(a+=t.fn(s),s=[]),s.push(e[i]);a+=t.fn(s)}return a},plantify:l=>game.i18n.localize(`PLANT.avLevels.${l||0}`),oddLength:l=>l.length%2==1})}u(ei,"default");function ti(){Hooks.once("init",()=>{game.dsa5.apps.DiceSoNiceCustomization=new Le}),Hooks.once("diceSoNiceReady",(l,e,t,a)=>{l.addColorset({name:"mu",description:"DSA5.mu",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"kl",description:"DSA5.kl",category:"DSA5.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"in",description:"DSA5.in",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ch",description:"DSA5.ch",category:"DSA5.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ff",description:"DSA5.ff",category:"DSA5.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ge",description:"DSA5.ge",category:"DSA5.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ko",description:"DSA5.ko",category:"DSA5.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"kk",description:"DSA5.kk",category:"DSA5.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"attack",description:"DSA5.attack",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),l.addColorset({name:"dodge",description:"DSA5.dodge",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"parry",description:"DSA5.parry",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),game.dsa5.apps.DiceSoNiceCustomization.initConfigs(),Le.onConnect()})}u(ti,"default");var Ze=class extends Application{initConfigs(){let e=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(let[a,s]of Object.entries(e))mergeObject(this.choices,s);let t={damage:"black"};delete this.choices.custom,game.settings.registerMenu("dsa5","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("DSASETTINGS.dicesonicesettings"),type:xs,restricted:!1});for(let a of Ze.attrs)game.settings.register("dsa5",`dice3d_${a}`,{name:`CHAR.${a.toUpperCase()}`,scope:"client",config:!1,default:t[a]||a,type:String}),game.settings.register("dsa5",`dice3d_system_${a}`,{name:`CHAR.${a.toUpperCase()}`,scope:"client",config:!1,default:"standard",type:String})}getAttributeConfiguration(e){return f.moduleEnabled("dice-so-nice")&&game.dice3d?{colorset:game.settings.get("dsa5",`dice3d_${e}`),appearance:{colorset:game.settings.get("dsa5",`dice3d_${e}`),system:game.settings.get("dsa5",`dice3d_system_${e}`)}}:{colorset:e}}activateListeners(e){super.activateListeners(),e.find('[name="entryselection"]').change(async t=>{await game.settings.set("dsa5",`dice3d_${t.currentTarget.dataset.attr}`,t.currentTarget.value)}),e.find('[name="systemselection"]').change(async t=>{await game.settings.set("dsa5",`dice3d_system_${t.currentTarget.dataset.attr}`,t.currentTarget.value),Ze.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}})})}static onConnect(){game.socket.on("system.dsa5",e=>{switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSA dice assets"),Ze.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":Ze.requestDicePreloads();break}}),this.collectPreloads(),game.socket.emit("system.dsa5",{type:"getPreloadDice3d"})}static collectPreloads(e=!0){let t=new Set;for(let a of Ze.attrs)t.add(game.settings.get("dsa5",`dice3d_system_${a}`));t=Array.from(t),e&&this.preloadDiceAssets(t),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:t})}static requestDicePreloads(){this.collectPreloads(!1)}static async preloadDiceAssets(e,t=[]){console.warn("loading",e);for(let a of e){let s=game.dice3d.DiceFactory.systems[a];if(!s){this.unloadedModels.push(a);continue}let i=s.dice.filter(n=>t.length==0||t.includes(n.type));for(let n of i)try{n.modelFile?await n.loadModel(game.dice3d.DiceFactory.loaderGLTF):await n.loadTextures()}catch{console.warn("Unable to load dice model",a,n)}}this.unloadedModels.length&&this.retries<6&&!this.retrying&&(this.retrying=!0,setTimeout(()=>{this.retries+=1;let a=new Set(this.unloadedModels);this.unloadedModels=[],this.retrying=!1,this.preloadDiceAssets(a)},1e4))}async getData(e){let t=await super.getData(e);t.choices=this.choices,t.systems=game.dice3d.DiceFactory.systems,t.selections={};for(let a of Ze.attrs)t.selections[a]={color:game.settings.get("dsa5",`dice3d_${a}`),system:game.settings.get("dsa5",`dice3d_system_${a}`)};return t}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{template:"systems/dsa5/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("DSASETTINGS.dicesonicesettings"),width:600}),e}},Le=Ze;u(Le,"DiceSoNiceCustomization"),F(Le,"unloadedModels",[]),F(Le,"retries",0),F(Le,"retrying",!1),F(Le,"attrs",["mu","kl","in","ch","ff","ge","ko","kk","attack","dodge","parry","damage"]);var xs=class extends FormApplication{render(){game.dsa5.apps.DiceSoNiceCustomization.render(!0)}};u(xs,"DiceSoNiceForm");function ai(){Hooks.on("preDeleteActiveEffect",(n,r,o)=>{if(r.noHook)return;let c=n.parent;if(c&&c.documentName=="Actor"&&getProperty(n,"flags.dsa5.maintain")){let m=[n._id],d=n.name.replace("("+game.i18n.localize("maintainCost")+")","").trim(),p=c.effects.filter(h=>h.name.startsWith(d)&&!h.origin&&h.id!=n._id),g=game.i18n.format("DIALOG.updateMaintainSpell",{actor:c.name});return p&&(g+=`<p>${game.i18n.localize("DIALOG.dependentMaintainEffects")}</p>`,g+=p.map(h=>`<p><label for="rel${h.id}">${h.name}</label><input class="effectRemoveSelector" checked type="checkbox" value="${h.id}" name="rel${h.id}"/></p>`).join("")),new Dialog({title:n.name,content:g,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("HELP.pay"),callback:async()=>{if(await c.applyMana(Number(getProperty(n,"flags.dsa5.maintain")),getProperty(n,"flags.dsa5.payType"))){let y={startTime:game.time.worldTime};game.combat&&(y.startRound=game.combat.round,y.startTurn=game.combat.turn),c.updateEmbeddedDocuments("ActiveEffect",[{_id:n._id,duration:y}])}}},delete:{icon:'<i class="fas fa-trash"></i>',label:game.i18n.localize("delete"),callback:h=>{for(let y of h.find(".effectRemoveSelector:checked"))m.push($(y).val());c.deleteEmbeddedDocuments("ActiveEffect",m,{noHook:!0})}}}}).render(!0),!1}}),Hooks.on("updateActor",(n,r)=>{!game.user.isGM&&n.limited&&hasProperty(r,"system.merchant.hidePlayer")&&ui.sidebar.render(!0)}),Hooks.on("deleteActiveEffect",(n,r)=>{if(!f.isActiveGM()||r.noHook)return;let o=n.parent;if(o&&o.documentName=="Actor"){let c=[...n.statuses][0];if(c=="bloodrush")return o.addCondition("stunned",2,!1,!1),!1;if(c=="dead"&&game.combat)return o.markDead(!1),!1;if(_DSAActiveEffectConfig.onEffectRemove(o,n),Hooks.call("deleteActorActiveEffect",o,n)===!1)return!1}}),Hooks.on("dropActorSheetData",(n,r,o)=>{switch(o.data?.type){case"condition":return n.addCondition(o.data.payload.id,1,!1,!1),!1;case"lookup":return r._handleLookup(o.data),!1;case"fullpack":return r._addFullPack(o.data),!1}}),Hooks.on("createActiveEffect",(n,r,o)=>{!f.isActiveGM()||(l(n),e(n))}),Hooks.on("deleteActiveEffect",(n,r,o)=>{!f.isActiveGM()||l(n)}),Hooks.on("updateActiveEffect",(n,r,o)=>{!f.isActiveGM()||(l(n),t(n))});function l(n){if(game.combat&&n.changes.some(r=>/(system\.status\.initiative|system\.characteristics.mu|system\.characteristics\.ge)/.test(r.key))){let r=n.parent.id,o=game.combat.combatants.find(c=>c.actor.id==r);o&&o.recalcInitiative()}}u(l,"checkIniChange");let e=u(async n=>{let r=n.parent;if(!r)return;await t(n,{},r);let o=[...n.statuses][0];o=="dead"&&game.combat?await r.markDead(!0):o=="unconscious"&&await r.addCondition("prone")},"createEffects"),t=u(async(n,r={},o)=>{if(o||(o=n.parent),!o||o.documentName!="Actor")return;let c=/^system\.condition\./;for(let m of n.changes||[])c.test(m.key)&&m.mode==2&&(r[m.key.split(".")[2]]=Number(m.value));for(let m of Object.keys(r))if(o.system.condition[m]>=4&&(m=="inpain"?await o.initResistPainRoll(n):["encumbered","stunned","feared","confused","trance"].includes(m)?await o.addCondition("incapacitated"):m=="paralysed"?await o.addCondition("rooted"):["drunken","exhaustion"].includes(m)&&(await o.addCondition("stunned"),await o.removeCondition(m))),(Number(r.inpain)||0)>0&&!o.hasCondition("bloodrush")&&o.system.condition.inpain>0&&x.hasVantage(o,game.i18n.localize("LocalizedIDs.frenzy"))){await o.addCondition("bloodrush");let d=f.replaceConditions(`${game.i18n.format("CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+o.name+"</b>"})}`);ChatMessage.create(f.chatDataSetup(d))}},"countableDependentEffects"),a=u(async(n,r)=>{(game.dsa5.apps.AskForNameDialog||zs).getDialog(n,r)},"askForName"),s=u(async n=>{if(!!f.isActiveGM()&&game.settings.get("dsa5","randomWeaponSelection")&&n.actor.type!="character"){let r=[],o=[],c=[];for(let d of n.actor.items)d.type=="meleeweapon"&&d.system.worn.value?_.isShield(d)?o.push(d):r.push(d):d.type=="rangeweapon"&&d.system.worn.value&&c.push(d);let m=[];if(r.length){let d=r[Math.floor(Math.random()*r.length)],p=d._id,g;!_.regex2h.test(d.name)&&o.length&&(g=o[Math.floor(Math.random()*o.length)]._id);for(let h of r)h._id!=p&&m.push({_id:h._id,system:{worn:{value:!1}}});for(let h of o)h._id!=g&&m.push({_id:h._id,system:{worn:{value:!1}}})}if(c.length){let d=c[Math.floor(Math.random()*c.length)]._id;for(let p of c)p._id!=d&&m.push({_id:p._id,system:{worn:{value:!1}}})}m.length&&n.actor.updateEmbeddedDocuments("Item",m)}},"randomWeaponSelection"),i=u(async(n,r)=>{if(!f.isActiveGM())return;let o=n.actor;if(o.hasPlayerOwner)return;let c=Number(game.settings.get("dsa5","obfuscateTokenNames"));if(c==0||getProperty(o,"merchant.merchantType")=="loot")return;let m=canvas.scene.tokens.filter(p=>p.actor&&p.actor.id===o.id),d=game.i18n.localize("unknown");if([2,4].includes(c)){if(!(n.id||n._id))return;a(n,c);return}if(m.length>0&&c<3){let p=m.length;for(let g of m){let h=g.name.match(/\d+$/);h&&Number(h[0])>p&&(p=Number(h[0]))}d=`${m[0].name.replace(/ \d{1,}$/,"")} ${p+1}`}r.name=d},"obfuscateName");Hooks.on("updateToken",(n,r,o)=>{j.updateTokenHook(n,r,o)}),Hooks.on("deleteToken",n=>{j.deleteTokenHook(n),et.hide(n)}),Hooks.on("preCreateToken",(n,r,o,c)=>{let m=n.actor;if(!m)return;let d={};getProperty(m,"system.merchant.merchantType")=="loot"?mergeObject(d,{displayBars:0}):getProperty(m,"system.config.autoBar")&&(mergeObject(d,{bar1:{attribute:"status.wounds"}}),m.system.isMage?mergeObject(d,{bar2:{attribute:"status.astralenergy"}}):m.system.isPriest?mergeObject(d,{bar2:{attribute:"status.karmaenergy"}}):mergeObject(d,{bar2:{attribute:"tbd"}})),getProperty(m,"system.config.autoSize")&&f.calcTokenSize(m,d),i(n,d),n.updateSource(d)}),Hooks.on("createToken",(n,r,o)=>{r.noHook||(i(n,{}),s(n),j.createTokenHook(n,r,o))}),Hooks.on("hoverToken",(n,r)=>{!game.settings.get("dsa5","showWeaponsOnHover")||(r?et.show(n):et.hide(n))})}u(ai,"default");var et=class{static show(e){if(!game.combat||canvas.hud?.token?.rendered)return;let t=e.actor.items.filter(a=>a.type=="meleeweapon"||a.type=="rangeweapon"?a.system.worn.value:!1);if(t.length){let a=t.map(i=>`<img src="${i.img}" class="tinyHudIcons" title="${i.name}"/>`).join(" "),s=$(`<div id="hoverhud_${e.id}" style="position:absolute;">${a}</div>`);$("#hud").append(s),this.position(s,e,t.length)}}static position(e,t,a){let s=t.document,i=canvas.dimensions.size/100,n=a*43,r={width:n,height:42,left:t.center.x-n/2*i,top:t.y+s.height*canvas.dimensions.size+32};i!==1&&(r.transform=`scale(${i})`),e.css(r)}static hide(e){$(`#hoverhud_${e.id}`).remove()}};u(et,"TokenHoverHud");var zs=class extends Dialog{static async getDialog(e,t){new Dialog({title:game.i18n.localize("DSASETTINGS.obfuscateTokenNames"),content:`<label for="name">${game.i18n.localize("DSASETTINGS.rename")}</label> <input dtype="string" name="name" type="text" value="${e.actor.name}"/>`,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async a=>{let s=e.id||e._id,i=a.find('[name="name"]').val();if(t==2){let r=canvas.scene.tokens.filter(o=>o.name===i);if(r.length>0){let o=r.length;for(let c of r){let m=c.name.match(/\d+$/);m&&Number(m[0])>o&&(o=Number(m[0]))}i=`${r[0].name.replace(/ \d{1,}$/,"")} ${o+1}`}}await canvas.scene.tokens.get(s).update({name:i})}},unknown:{icon:'<i class="fa fa-question"></i>',label:game.i18n.localize("unknown"),callback:async()=>{let a=e.id||e._id;await canvas.scene.tokens.get(a).update({name:game.i18n.localize("unknown")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}};u(zs,"AskForNameDialog");function si(){Hooks.on("hotbarDrop",(l,e,t)=>{if(e.mod=="dodge"){let a={name:game.i18n.localize(e.mod),img:"systems/dsa5/icons/categories/Dodge.webp"},s;return game.user.isGM||e.actorId==null?s=`game.dsa5.macro.charMacro("${e.mod}")`:s=`game.dsa5.macro.charMacroById("${e.mod}", "${e.actorId}")`,Ps(s,a.name,a.img,t)}else if(e.mod=="attackWeaponless"||e.mod=="parryWeaponless"){let a={name:game.i18n.localize(e.mod),img:"systems/dsa5/icons/categories/attack_weaponless.webp"},s;return game.user.isGM||e.actorId==null?s=`game.dsa5.macro.weaponLessMacro("${e.mod}")`:s=`game.dsa5.macro.weaponLessMacroId("${e.mod}", "${e.actorId}")`,Ps(s,a.name,a.img,t)}else if(e.type=="Item"){let a=fromUuidSync(e.uuid);if(!["ritual","ceremony","meleeweapon","rangeweapon","skill","combatskill","spell","liturgy","char","trait"].includes(a.type)||(a.type=="meleeweapon"||a.type=="combatskill")&&!["attack","parry"].includes(e.mod))return;if((a.type=="rangeweapon"||a.type=="trait")&&!["attack"].includes(e.mod))return;let i=`{mod: "${e.mod}"}`,n;game.user.isGM||e.actorId==null?n=`game.dsa5.macro.itemMacro("${a.name}", "${a.type}", ${i});`:n=`game.dsa5.macro.itemMacroById("${e.actorId}", "${a.name}", "${a.type}", ${i})`;let r=e.mod==null?a.name:`${a.name} - ${game.i18n.localize("CHAR."+e.mod.toUpperCase())}`;return Ps(n,r,a.img,t)}else if(e.type=="Actor"||e.type=="JournalEntry"){let a=fromUuidSync(e.uuid),s=`(await fromUuid('${e.uuid}')).sheet.render(true)`;return Ps(s,a.name,a.img,t)}})}u(si,"default");function Ps(l,e,t,a){let s=game.macros.contents.find(i=>i.name===e&&i.command===l);return s?game.user.assignHotbarMacro(s,a):Macro.create({name:e,type:"script",img:t,command:l},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,a)),!1}u(Ps,"createHotBarMacro");function ii(){Hooks.on("renderChatLog",(l,e,t)=>{H.chatListeners(e),_DiceDSA5.chatListeners(e),G.chatListeners(e);let a=new te;Hooks.call("startDSA5ChatAutoCompletion",a),a.chatListeners(e),ee.chatListeners(e)}),Hooks.on("renderChatMessage",(l,e,t)=>{if(game.user.isGM)e.find(".chat-button-player").remove();else{e.find(".chat-button-gm").remove();let a,s=e.find(".chat-button-target");s.length&&(a=oe.getTargetActor(t.message),a&&a.actor&&!a.actor.isOwner&&s.remove());let i=f.getSpeaker(t.message.speaker);i&&!i.isOwner&&(e.find(".selfButton").remove(),e.find(".d20").attr("data-tooltip",""));let n=e.find(".onlyTarget");n.length&&(a=f.getSpeaker({token:n.attr("data-token"),actor:n.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}),a&&!a.isOwner&&n.remove()),e.find(".hideData").remove(),getProperty(t.message,`flags.dsa5.userHidden.${game.user.id}`)&&e.find(".payButton").remove()}game.settings.get("dsa5","expandChatModifierlist")&&(e.find(".expand-mods i").toggleClass("fa-minus fa-plus"),e.find(".expand-mods + ul").css({display:"block"})),E.bindButtons(e),e.find(".embeddedItemDrag").each(function(a,s){s.setAttribute("draggable",!0),s.addEventListener("dragstart",i=>Zi(i))})}),Hooks.on("chatMessage",(l,e,t)=>{let a=e.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(a=a?a[0]:"",a){case"/pay":return game.user.isGM?G.createPayChatMessage(e):G.payMoney(f.getSpeaker(t.speaker),e),!1;case"/getPaid":return game.user.isGM?G.createGetPaidChatMessage(e):G.getMoney(f.getSpeaker(t.speaker),e),!1;case"/help":return ee.getHelp(),!1;case"/conditions":return ee.showConditions(),!1;case"/tables":return ee.showTables(),!1}}),Hooks.on("preCreateChatMessage",(l,e,t,a)=>{if(getProperty(l,"flags.core.initiativeRoll")){let s=l.rolls[0].terms,i=`${s[0].number}`.split(".")[0],n=`${game.i18n.localize("baseValue")}: ${i}, ${game.i18n.localize("randomValue")}: ${s.at(-3).values[0]}")}`,r=[];for(let m of s)if(m.faces&&m.faces==6)for(let d=0;d<m.number;d++)r.push(`<span class="die-damage d${m.faces}">${m.results[d].result}</span>`);let c={content:`<div>
                <div class="card-content hide-option roll-result">
                    <b>${game.i18n.localize("Roll")}</b>: ${r.join("")}
                </div>
                <div class="card-content" data-tooltip="${n}">
                    <b>${game.i18n.localize("initiative")}</b>: ${Math.floor(l.rolls[0]._total*100)/100}
                </div>
            </div>`,flavor:void 0};l.updateSource(c)}})}u(ii,"default");function Zi(l){let e=$(l.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(e).getFlag("dsa5","embeddedItem"),s={type:"Item",data:a};l.dataTransfer.setData("text/plain",JSON.stringify(s))}u(Zi,"embeddedDragStart");var $e=class{static async firstTimeMessage(){if(!await game.settings.get("dsa5","firstTimeStart")){await $e.setupDefaultOptions();let e=game.i18n.localize("WELCOME");ChatMessage.create(f.chatDataSetup(e)),$e.firstTimeLanguage(),await game.settings.set("dsa5","firstTimeStart",!0)}}static firstTimeLanguage(){let e=["de","en"],t={title:game.i18n.localize("DIALOG.firstTime"),content:game.i18n.localize("DIALOG.firstTimeWarning"),default:"de",buttons:{}};for(let a of e)t.buttons[a]={label:game.i18n.localize(a),callback:()=>$e.setLanguage(a)};new Dialog(t).render(!0)}static async setLanguage(e){await game.settings.set("dsa5","firstTimeStart",!0),await game.settings.set("dsa5","forceLanguage",e),await game.settings.set("core","language",e),foundry.utils.debouncedReload()}static async setupDefaultOptions(){let e=game.settings.get("core",Combat.CONFIG_SETTING);e.skipDefeated=!0,await game.settings.set("core",Combat.CONFIG_SETTING,e),await game.settings.set("core","leftClickRelease",!0)}};u($e,"DSA5Tutorial");var St=class{static async stopFade(e){e.stopPropagation(),e.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(e.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click(()=>$(".didYouKnow").remove())):fetch(`systems/dsa5/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:a,fadeOut:St.fadeOut});$("body").find(".didYouKnow").replaceWith(s),St.activateListeners()})}static activateListeners(){$(".didYouKnow .stopFade").click(async e=>await this.stopFade(e)),$(".didYouKnow").click(()=>$(".didYouKnow").remove()),$(".didYouKnow").fadeIn()}static async showOneMessage(e=8e3){game.settings.get("dsa5","disableDidYouKnow")||fetch(`systems/dsa5/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:a,fadeOut:St.fadeOut});$("body").append(s),this.activateListeners(),setTimeout(function(){St.fadeOut&&$(".didYouKnow").fadeOut(1e3,()=>$(".didYouKnow").remove())},e)})}},Re=St;u(Re,"DidYouKnow"),F(Re,"fadeOut",!0);var ve=class extends CombatTracker{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"/systems/dsa5/templates/system/combattracker.html"})}activateListeners(e){super.activateListeners(e),e.find(".combatant.actor .aggroButton").click(t=>{t.preventDefault(),t.stopPropagation(),ve.runActAttackDialog()}),e.find("#combat-tracker").on("scroll.combattracker",debounce(function(t){let a=$(t.target),s=e.find(".combatant.active")[0].offsetTop;e.find(".aggroButton").animate({top:s-a.scrollTop()},50)},50)),e.find(".convertToBrawl").click(()=>game.combat.convertToBrawl())}static runActAttackDialog(){if(!game.combat)return;let e=game.combat.combatant;(game.user.isGM||e.isOwner)&&Ne.showDialog(e.actor,e.tokenId)}async getData(e){let t=await super.getData(e);for(let a of t.turns){let s=t.combat.turns.find(r=>r.id==a.id),i=game.user.isGM||s.actor&&s.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects");a.defenseCount=s.getFlag("dsa5","defenseCount")||0,a.actionCount=Number(getProperty(s,"actor.system.actionCount.value"))||0,a.actionCounts=`${a.actionCount} ${game.i18n.localize("actionCount")}`;let n=[];if(s.actor){for(let r of s.actor.items)if(r.type=="rangeweapon"&&r.system.worn.value&&r.system.reloadTime.progress>0){let o={name:r.name,remaining:S.calcLZ(r,s.actor)-r.system.reloadTime.progress};o.remaining>0&&n.push(o)}else if(["spell","liturgy"].includes(r.type)&&r.system.castingTime.modified>0){let o={name:r.name,remaining:r.system.castingTime.modified-r.system.castingTime.progress};o.remaining>0&&n.push(o)}}n=n.sort((r,o)=>r.remaining-o.remaining),n.length>0&&(a.ongoings=`${game.i18n.localize("COMBATTRACKER.ongoing")}<br>${n.map(r=>`${r.name} - ${r.remaining}`).join("<br>")}`,a.ongoing=n[0].remaining),a.effects=new Set,s.token&&(s.token.effects.forEach(r=>a.effects.add(r)),s.token.overlayEffect&&a.effects.add(s.token.overlayEffect)),s.actor&&s.actor.temporaryEffects.forEach(r=>{r.statuses.has(CONFIG.Combat.defeatedStatusId)?a.defeated=!0:r.icon&&i&&!r.notApplicable&&(game.user.isGM||!r.getFlag("dsa5","hidePlayers"))&&!r.getFlag("dsa5","hideOnToken")&&a.effects.add(r.icon)})}return t.isBrawling=game.combat?.isBrawling,t}};u(ve,"DSA5CombatTracker");var ct=class extends Combat{constructor(e,t){super(e,t)}async refreshTokenbars(){game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}get isBrawling(){return this.getFlag("dsa5","isBrawling")}_onCreate(e,t,a){super._onCreate(e,t,a),this.refreshTokenbars()}_onDelete(e,t){super._onDelete(e,t),this.refreshTokenbars()}async convertToBrawl(e=void 0){let t=e??!this.isBrawling,a=[],s=[],i=[];if(t)for(let n of this.combatants){if(!n.actor)return{};let r=await n.brawlingChange();n.actor.isToken?await n.actor.update(r.actorChange):a.push(r.actorChange),s.push(...r.tokenChange),ct.brawlStart()}else for(let n of this.combatants){if(!n.actor)return{};let r=await n.undoBrawlingChange();n.actor.isToken?await n.actor.update(r.actorChange):a.push(r.actorChange),s.push(...r.tokenChange),r.damage.brawlDamage>0&&i.push({name:n.token.name,id:n.token.id,data:r.damage})}await S.updateDocuments(a),await game.canvas.scene.updateEmbeddedDocuments("Token",s),await this.setFlag("dsa5","isBrawling",t),i.length&&await this.showBrawlingDamage(i)}async showBrawlingDamage(e){let t=await renderTemplate("systems/dsa5/templates/chat/brawling-damage.html",{messages:e});ChatMessage.create(f.chatDataSetup(t))}static async brawlStart(e=2e3){$(".bumFight").remove();let t=await renderTemplate("systems/dsa5/templates/system/bumFight/animation.html",{});$("body").append(t);let a=$(".bumFight");a.click(()=>a.remove()),a.addClass("fight"),setTimeout(function(){a.fadeOut(1e3,()=>a.remove())},e)}async nextRound(){if(game.user.isGM)for(let e of this.turns)await e.setFlag("dsa5","defenseCount",0);else await game.socket.emit("system.dsa5",{type:"clearCombat",payload:{}});return await super.nextRound()}async getDefenseCount(e){let t=this.getCombatantFromActor(e);return t&&t.getFlag("dsa5","defenseCount")||0}getCombatantFromActor(e){let t;return e.token?t=Array.from(this.combatants).find(a=>a.tokenId==e.token):t=Array.from(this.combatants).find(a=>a.actorId==e.actor),t?this.combatants.get(t.id):void 0}async updateDefenseCount(e){if(game.user.isGM){let t=this.getCombatantFromActor(e);t&&!getProperty(t.actor,"system.config.defense")&&await t.setFlag("dsa5","defenseCount",(t.getFlag("dsa5","defenseCount")||0)+1)}else await game.socket.emit("system.dsa5",{type:"updateDefenseCount",payload:{speaker:e}})}};u(ct,"DSA5Combat");var Vt=class extends Combatant{constructor(e,t){e.flags==null&&(e.flags={}),mergeObject(e.flags,{dsa5:{defenseCount:0}}),super(e,t)}brawlingChange(){let e=f.getSpeaker({actor:this.actor.id,scene:this.sceneId,token:this.token.id}),t=getProperty(e,"system.config.autoBar")?e.getActiveTokens().map(s=>({_id:s.id,bar1:{attribute:"status.temporaryLeP"}})):[],a={_id:e.id,system:{status:{temporaryLeP:{value:e.system.status.wounds.value,max:e.system.status.wounds.value}}}};return{tokenChange:t,actorChange:a}}async getBrawlingTable(){if(!this.brawlingTable){let t=(await game.packs.get(game.i18n.lang=="de"?"dsa5.patzer":"dsa5.botch").getDocuments({name__in:[game.i18n.lang=="de"?"Pr\xFCgelei - Verletzungen":"Brawling - Injuries"]}))[0];this.brawlingTable=t}return this.brawlingTable}async undoBrawlingChange(){let e=f.getSpeaker({actor:this.actor.id,scene:this.sceneId,token:this.token.id}),t=getProperty(e,"system.config.autoBar")?e.getActiveTokens().map(r=>({_id:r.id,bar1:{attribute:"status.wounds"}})):[],a=Math.max(0,e.system.status.temporaryLeP.max-e.system.status.temporaryLeP.value),s=0,i;if(a>0){i=await(await this.getBrawlingTable()).draw({displayChat:!1}),i=i.results[0];let r=i.getFlag("dsa5","brawlDamage");s=Math.round(a*r)}let n={_id:e.id,system:{status:{temporaryLeP:{value:0,max:0},wounds:{value:e.system.status.wounds.value-s}}}};return{tokenChange:t,actorChange:n,damage:{brawlDamage:s,result:i}}}async recalcInitiative(){if(this.initiative){let t={initiative:(await this.getFlag("dsa5","baseRoll")||0)+this.actor.system.status.initiative.value};await this.update(t)}}};u(Vt,"DSA5Combatant");Hooks.on("preCreateCombatant",(l,e,t)=>{let a=f.getSpeaker({actor:l.actorId,scene:l.sceneId,token:l.tokenId});if(getProperty(a.system,"merchant.merchantType")=="loot")return!1;if(l.combat.isBrawling){let s=l.brawlingChange();delete s.actorChange._id,a.update(s.actorChange).then(()=>{game.canvas.scene.updateEmbeddedDocuments("Token",s.tokenChange)})}});Hooks.on("deleteCombatant",(l,e,t)=>{let a=f.getSpeaker({actor:l.actorId,scene:l.sceneId,token:l.tokenId});if(getProperty(a.system,"merchant.merchantType")=="loot")return!1;l.combat.isBrawling&&l.undoBrawlingChange().then(async s=>{!l.token||(delete s.actorChange._id,await a.update(s.actorChange),await game.canvas.scene.updateEmbeddedDocuments("Token",s.tokenChange),s.damage.brawlDamage>0&&l.combat.showBrawlingDamage([{name:l.token.name,id:l.token.id,data:s.damage}]))})});Hooks.on("preDeleteCombat",(l,e,t)=>{if(!e.noHook&&l.isBrawling)return l.convertToBrawl(!1).then(()=>{l.delete({noHook:!0})}),!1});Hooks.on("updateCombatant",(l,e,t)=>{if(!!game.user.isGM)if(e.initiative){if(!l.getFlag("dsa5","baseRoll")){let s=`${e.initiative}`.split("."),i=Number(s[0])-Math.round(l.actor.system.status.initiative.value);l.setFlag("dsa5","baseRoll",i)}}else"initiative"in e&&e.initiative==null&&l.update({["flags.dsa5.-=baseRoll"]:null})});var Ct=class{static async updateCombatHook(e,t,a,s){!t.round&&!t.turn||e.round!=0&&e.turns&&e.active&&e.previous.round<e.current.round&&await Ct.startOfRound(e)}static async startOfRound(e){let t=game.users.find(a=>a.active&&a.isGM);if(!!(t&&game.user.id==t.id)){for(let a of e.turns)if(!a.defeated){for(let s of a.actor.effects){if(s.disabled)continue;let i=[...s.statuses][0];i=="bleeding"?await this.applyBleeding(a,e):i=="burning"&&await this.applyBurning(a,s,e)}await this.startOfRoundEffects(a,e)}}}static async startOfRoundEffects(e,t){let a=["wounds","astralenergy","karmaenergy"];for(let s of a){if(getProperty(e.actor.system.repeatingEffects,`disabled.${s}`))continue;let i=e.actor.system.repeatingEffects.startOfRound[s].map(m=>m.value).join("+");if(!i)continue;let n=await new Roll(i).evaluate({async:!0}),r=await n.render(),o=game.i18n.localize(n.total>0?"CHATNOTIFICATION.regenerates":"CHATNOTIFICATION.getsHurt"),c=`${this.buildActorName(e)} ${o} ${game.i18n.localize(s)} ${r}`;await this.sendEventMessage(c,t,e),s=="wounds"?await e.actor.applyDamage(n.total*-1):await e.actor.applyMana(n.total*-1,s=="astralenergy"?"AsP":"KaP")}}static async applyBleeding(e,t){if(e.actor.system.status.wounds.value<1)return;let a=game.i18n.format("CHATNOTIFICATION.bleeding",{actor:this.buildActorName(e)});await this.sendEventMessage(a,t,e),await e.actor.applyDamage(1)}static async applyBurning(e,t,a){if(e.actor.system.status.wounds.value<1)return;let s=Number(t.getFlag("dsa5","value")),i=E.resistantToEffect(e.actor,t),n={0:"1",1:"1d3",2:"1d6",3:"2d6"}[s-i]||"1",r=await new Roll(n).evaluate({async:!0}),o=await r.render(),c=game.i18n.format(`CHATNOTIFICATION.burning.${s}`,{actor:this.buildActorName(e),damage:o});await this.sendEventMessage(c,a,e),await e.actor.applyDamage(r.total)}static buildActorName(e){let t=e.token.name;return game.settings.get("dsa5","hideRegenerationToOwner")&&e.token.name!=e.token.actor.name&&(t+=` (${e.token.actor.name})`),e.token.actor.toAnchor({name:t}).outerHTML}static async sendEventMessage(e,t,a){if(game.settings.get("dsa5","hideRegenerationToOwner")){let s=t.combatants.get(a.id).players;s.push(...game.users.filter(n=>n.isGM).map(n=>n.id));let i=f.chatDataSetup(e,void 0,void 0,s);delete i.speaker,await ChatMessage.create(i)}else await ChatMessage.create(f.chatDataSetup(e))}};u(Ct,"RepeatingEffectsHelper");Hooks.on("updateCombat",Ct.updateCombatHook);var Oe=class extends Application{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","initTracker"]),template:"systems/dsa5/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"DSAIniTracker",itemWidth:game.settings.get("dsa5","iniTrackerSize"),actorCount:game.settings.get("dsa5","iniTrackerCount"),position:game.settings.get("dsa5","iniTrackerPosition")}),e}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){let n=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),r=this.element[0];if(!r.style.width||a){let o=a||r.offsetWidth,c=r.style.maxWidth||window.innerWidth;n.width=a=Math.clamped(o,0,c),r.style.width=a+"px",a+n.left>window.innerWidth&&(e=n.left)}return game.settings.set("dsa5","iniTrackerPosition",{left:n.left,top:n.top}),n}static connectHooks(){Hooks.on("renderDSA5CombatTracker",(e,t,a)=>{!game.settings.get("dsa5","enableCombatFlow")||(game.combat?(game.dsa5.apps.initTracker||(game.dsa5.apps.initTracker=new Oe),game.dsa5.apps.initTracker.updateTracker(a)):game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0))})}updateTracker(e){this.combatData=e,this.render(!0,{focus:!1})}async getData(e){let t=this.combatData,a=Oe.defaultOptions.itemWidth,s=Oe.defaultOptions.actorCount,i=t.round,n=t.turns,r=[],o=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,c=n.some(d=>d.active),m=t.turns.some(d=>d.owner&&!d.hasRolled&&(!game.user.isGM||t.combat.combatants.get(d.id).isNPC));if(n.length){let d=[],p=s,g=!1,h=-1,y=0,v=0,P;for(;!(p==0||v==s);){let T=duplicate(n[y]),R=t.combat.combatants.get(T.id);g&&y==h&&(T.css=T.css.replace("active","")),!i||T.active&&!g||!c&&!g?(g=!0,h=y):R.getFlag("dsa5","waitInit")==t.round+v&&!R.defeated&&(game.user.isGM||!R.hidden)&&r.push(T),g&&!(o&&R.defeated)&&(game.user.isGM||!R.hidden)&&(T.round=t.round+v,T.owner&&R.token?.actor&&(T.maxLP=R.token.actor.system.status.wounds.max,T.currentLP=R.token.actor.system.status.wounds.value),P&&P!=T.round&&(T.newRound="newRound"),P=T.round,d.push(T),p--),y++,y>=n.length&&(y=0,v++)}t.turns=d}return t.isLastRound=t.turns[1]?.newRound,this.position.width=a*s+s*3+80,this.position.height=a+10,mergeObject(t,{itemWidth:a,unRolled:m,waitingTurns:r}),console.log(t),this.conditionalPanToCurrentCombatant(t),t}hasChangedTurn(e){let t=e.turn!=this.lastTurnUpdate||e.round!=this.lastRoundUpdate;return this.lastTurnUpdate=e.turn,this.lastRoundUpdate=e.round,t}async conditionalPanToCurrentCombatant(e){if(!game.settings.get("dsa5","enableCombatPan"))return;let t=e.turns[0];if(!t)return;let a=e.combat.combatants.get(t.id);!a||!this.hasChangedTurn(e)||setTimeout(()=>{let s=a.token;!s||!s.object||!s.object.isVisible||(canvas.animatePan({x:s.x,y:s.y}),!(!a.actor||!a.actor.isOwner)&&s.object.control({releaseOthers:!0}))},300)}async _onWheelResize(e){let t=game.settings.get("dsa5","iniTrackerSize");e.originalEvent.deltaY>0?t=Math.min(140,t+5):t=Math.max(30,t-5),await game.settings.set("dsa5","iniTrackerSize",t),await this.render(!0)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async s=>(s.stopPropagation(),s.preventDefault(),await this._onWheelResize(s),!1)),e.find(".toggleTracker").click(()=>{let s=ui.combat;s.renderPopout(s)}),e.find(".combat-control").click(s=>this._onCombatControl(s)),e.find(".convertToBrawl").click(s=>{game.combat?.convertToBrawl()});let a=e.find(".iniItem");a.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),a.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown(s=>this._onRightClick(s)),e.find(".combatant-control").click(s=>this._onCombatantControl(s)),e.find(".combatant .aggroButton").click(s=>{s.preventDefault(),s.stopPropagation(),ve.runActAttackDialog()}),e.find(".rollMine").click(s=>this.rollMyChars()),game.user.isGM&&e.find(".rolledInit").click(s=>this.editCombatant(s))}rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsa5","waitInit")}}editCombatant(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}_onCombatantControl(e){this._getCombatApp()._onCombatantControl(e)}_onCombatControl(e){e.currentTarget.dataset.control=="waitInit"?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}async waitInit(e){await game.combat.combatants.get(game.combat.current.combatantId).setFlag("dsa5","waitInit",game.combat.current.round),e.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(e)}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onCombatantMouseDown(e){this._getCombatApp()._onCombatantMouseDown(e)}_getCombatApp(){return game.combats.apps[0]}_canDragStart(e){return!1}_canDragDrop(e){return!1}_onDragStart(e){let t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}_onDrop(e){JSON.parse(e.dataTransfer.getData("text/plain")).type=="IniChange"}};u(Oe,"DSAIniTracker");var xe=class extends Tour{static async travelAgency(){let e=game.i18n.lang=="de"?"de":"en";console.log("Adding DSA/TDE Tours");for(let t of this.tours){let a=await game.dsa5.apps.DSATour.fromJSON(`${t.replace("/lang/",`/${e}/`)}.json`);game.tours.register(a.config.module,a.id,a)}if(!!game.user.isGM)for(let t of this.gmTours){let a=await game.dsa5.apps.DSATour.fromJSON(`${t.replace("/lang/",`/${e}/`)}.json`);game.tours.register(a.config.module,a.id,a)}}async _preStep(){this.currentStep.activateTab?ui.sidebar.activateTab(this.currentStep.activateTab):this.currentStep.activateLayer&&canvas.activeLayer.options.name!=this.currentStep.activateLayer?(await canvas[this.currentStep.activateLayer].activate(),await ta(100)):this.currentStep.appTab&&this.app.activateTab(this.currentStep.appTab)}exit(){super.exit()}async start(){if(this.config.preCommand){let t=Object.getPrototypeOf(async function(){}).constructor;await new t(this.config.preCommand).call(this)}if(this.app)for(await this.app.render(!0,{focus:!0});!this.app.rendered;)await ta(50);if(this.app||this.config.preCommand)for(;!$(this.steps[this.stepIndex+1].selector+":visible").length;)await ta(50);let e=await super.start();return $("#tooltip").show(),e}};u(xe,"DSATour"),F(xe,"tours",["systems/dsa5/modules/tours/lang/initial","systems/dsa5/modules/tours/lang/library","systems/dsa5/modules/tours/lang/actor"]),F(xe,"gmTours",["systems/dsa5/modules/tours/lang/mastermenu"]);var dt=class{async _getData(e){return{}}activateListeners(e){}async _renderData(e){let t=await this._getData(e);return mergeObject(t,e),await renderTemplate(this.constructor.template,t)}async prepareApp(e){return{name:game.i18n.localize(`PLAYER.${this.constructor.name}`),view:await this._renderData(e)}}async render(){await game.dsa5.apps.playerMenu.render(!0)}async activateTab(){await game.dsa5.apps.playerMenu.activateTab(game.i18n.localize(`PLAYER.${this.constructor.name}`))}get actor(){return game.dsa5.apps.playerMenu.actor}async _onDrop(e){}};u(dt,"PlayerMenuSubApp"),F(dt,"template",""),F(dt,"rulePath",{});var ze=class extends Application{constructor(e){super(e),this.entityAbilities=[],game.dsa5.apps.PlayerMenuSubApp=dt,this.summoningModifiers=[{id:1,name:"CONJURATION.offensiveImprovement",descr:"CONJURATION.offensiveImprovementDescr",changes:[{key:"system.meleeStats.attack",mode:2,value:2},{key:"system.meleeStats.damage",mode:2,value:4},{key:"system.rangeStats.attack",mode:2,value:2},{key:"system.rangeStats.damage",mode:2,value:4}]},{id:2,name:"CONJURATION.defensiveImprovement",descr:"CONJURATION.defensiveImprovementDescr",changes:[{key:"system.meleeStats.parry",mode:2,value:2},{key:"system.totalArmor",mode:2,value:2},{key:"system.status.wounds.gearmodifier",mode:2,value:10}]},{id:3,name:"CONJURATION.speedImprovement",descr:"CONJURATION.speedImprovementDescr",changes:[{key:"system.status.speed.gearmodifier",mode:2,value:2},{key:"system.status.dodge.gearmodifier",mode:2,value:2}]},{id:4,name:"CONJURATION.magicalImprovement",descr:"CONJURATION.magicalImprovementDescr",changes:[],fun:_.magicalImprovement},{id:5,name:"CONJURATION.resistanceImprovement",descr:"CONJURATION.resistanceImprovementDescr",changes:[{key:"system.status.soulpower.gearmodifier",mode:2,value:2},{key:"system.status.toughness.gearmodifier",mode:2,value:2}]},{id:6,name:"CONJURATION.mentalImprovement",descr:"CONJURATION.mentalImprovementDescr",changes:[{key:"system.characteristics.mu.gearmodifier",mode:2,value:2},{key:"system.characteristics.kl.gearmodifier",mode:2,value:2},{key:"system.characteristics.in.gearmodifier",mode:2,value:2},{key:"system.characteristics.ch.gearmodifier",mode:2,value:2}]},{id:7,name:"CONJURATION.physicalImprovement",descr:"CONJURATION.physicalImprovementDescr",changes:[{key:"system.characteristics.ff.gearmodifier",mode:2,value:2},{key:"system.characteristics.ge.gearmodifier",mode:2,value:2},{key:"system.characteristics.ko.gearmodifier",mode:2,value:2},{key:"system.characteristics.kk.gearmodifier",mode:2,value:2}]}],this.conjurationData={qs:0,consumedQS:0,packageModifier:0,selectedIds:[],selectedEntityIds:[],selectedPackageIds:[],conjurationTypes:{1:game.i18n.localize("CONJURATION.demon"),2:game.i18n.localize("CONJURATION.elemental")},rules:{1:{de:{pack:"dsa5-core.corerules",name:"Beschw\xF6rungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}},2:{de:{pack:"dsa5-core.corerules",name:"Beschw\xF6rungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}}},conjurationType:1,skills:{1:["invocatioMinima","invocatioMinor","invocatioMaior"].map(t=>game.i18n.localize(`LocalizedIDs.${t}`)),2:["manifesto","elementalServant","callDjinn","servantEarth","servantFlame","servantCold","servantWave","servantCloud","servantOre"].map(t=>game.i18n.localize(`LocalizedIDs.${t}`))},modifiers:{1:this.summoningModifiers,2:this.summoningModifiers},moreModifiers:{2:[{name:game.i18n.localize("CONJURATION.groupSummoning"),options:[1,2,3,4,5,6,7,8].map(t=>({name:t,val:t*-2+2}))}]},postFunction:{}},this.subApps=[]}registerSubApp(e){this.subApps.push(e)}async rollConjuration(e){if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("CONJURATION.dragConjuration"));let t=$(e.currentTarget).closest(".item").attr("data-item-id"),a=this.actor.items.get(t),s=[{name:game.i18n.localize("conjuringDifficulty"),value:getProperty(this.conjuration,"system.conjuringDifficulty.value")||0,selected:!0}];if(this.conjurationData.packageModifier&&s.push({name:game.i18n.localize("summoningPackage"),value:this.conjurationData.packageModifier,selected:!0}),this.conjurationData.moreModifiers[this.conjurationData.conjurationType]){let i=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].filter(n=>n.selected);for(let n of i)s.push({name:n.name,value:Number(n.selected),selected:!0})}this.actor.setupSkill(a,{moreModifiers:s,subtitle:` (${this.conjuration.name})`},void 0).then(async i=>{let n=await this.actor.basicTest(i);this.conjurationData.qs=n.result.qualityStep||0,this.render(!0)})}activateListeners(e){super.activateListeners(e),ne(e),e.find(".conjurationData").change(t=>{let a=$(t.currentTarget);setProperty(this.conjurationData,a.attr("name"),a.val()),a.attr("data-refresh")&&this.render()}),e.find(".skill-select").click(t=>this.rollConjuration(t)),e.find(".initLibrary").click(async t=>{$(t.currentTarget).html('<i class="fas fa-spin fa-spinner"></i>'),await game.dsa5.itemLibrary.buildEquipmentIndex(),this.render()}),e.find(".item-edit").click(t=>{let a=$(t.currentTarget).closest(".item").attr("data-item-id");this.actor.items.get(a).sheet.render(!0)}),e.find(".selectableRow").click(t=>this.selectImprovement(t)),e.find(".finalizeConjuration").click(()=>this.finalizeConjuration()),e.find(".ruleLink").click(t=>this.openRules(t)),e.find(".openChar").click(()=>{this.actor?.sheet.render(!0)}),e.find(".showEntity").click(t=>{t.stopPropagation(),u(async()=>{(await fromUuid(t.currentTarget.dataset.uuid)).sheet.render(!0)},"fun")()}),e.find(".moreModifiers").change(t=>{let a=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].find(s=>s.name==t.currentTarget.dataset.name);a.selected=$(t.currentTarget).val()});for(let t of this.subApps)t.activateListeners(e)}async openRules(e){let t=e.currentTarget.dataset.subapp,a=(t?this.subApps.find(i=>i.constructor.name==t).constructor.rulePath:this.conjurationData.rules[this.conjurationData.conjurationType])[game.i18n.lang];u(async()=>{let n=await game.packs.get(a.pack).getDocuments({name:a.name});for(let r of n)r.sheet.render(!0)},"fun")()}finalizeConjuration(){if(!this.conjurationData)return;if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("DSAError.noConjurationActive"));let e=[];for(let a of this.conjurationData.selectedIds)e.push(this.conjurationData.modifiers[this.conjurationData.conjurationType].find(s=>s.id==a));let t={source:this.conjuration.toObject(),creationData:{type:this.conjurationData.conjurationType,typeName:this.conjurationData.conjurationTypes[this.conjurationData.conjurationType],qs:this.conjurationData.qs,consumedQS:this.conjurationData.consumedQS,modifiers:e,entityIds:this.conjurationData.selectedEntityIds,packageIds:this.conjurationData.selectedPackageIds},summoner:{name:this.actor.name,img:this.actor.img}};game.user.isGM?ze.createConjuration(t):(game.socket.emit("system.dsa5",{type:"summonCreature",payload:t}),ui.notifications.notify(game.i18n.localize("CONJURATION.requestSend")))}static createConjuration({source:e,creationData:t,summoner:a}){new Ns(e,a,t).render(!0)}selectImprovement(e){let t=Number(e.currentTarget.dataset.max)||1,a=Number(e.currentTarget.dataset.selected)||0;a>=t?$(e.currentTarget).removeClass("selected"):($(e.currentTarget).addClass("selected"),e.currentTarget.dataset.selected=a+1);let s=[],i=[],n=[],r=0,o=0;$(this._element).find(".selectableRow.selected").each((c,m)=>{for(let d=0;d<Number(m.dataset.selected);d++)m.dataset.entityid?(i.push(m.dataset.id),r+=(Number(m.dataset.qs)||0)*-1):m.dataset.packageid?(n.push(m.dataset.id),o+=Number(m.dataset.mod)||0):s.push(Number(m.dataset.id))}),this.conjurationData.selectedIds=s,this.conjurationData.selectedEntityIds=i,this.conjurationData.selectedPackageIds=n,this.conjurationData.consumedQS=s.length+r,this.conjurationData.packageModifier=o,this.render()}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"summoning"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","playerMenu","sheet"]),width:500,height:740,title:game.i18n.localize("PLAYER.title"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/playermenu.html",e.resizable=!0,e}_canDragDrop(e){return!0}async _onDrop(e){let t;try{switch(t=JSON.parse(e.dataTransfer.getData("text/plain")),t.type){case"Actor":t=await Actor.implementation.fromDropData(t);break;case"Item":t=await Item.implementation.fromDropData(t);break}}catch{return!1}if(t.documentName=="Actor"){let a=game.actors.get(t.id);if(a.type=="creature"||$(e.target).closest(".summoningArea").length>0){if(this.conjuration=a,this.conjurationData.selectedIds=[],this.conjurationData.selectedEntityIds=[],this.conjurationData.selectedPackageIds=[],a.type=="creature"){for(let s of Object.keys(this.conjurationData.conjurationTypes))if(a.system.creatureClass.value.includes(this.conjurationData.conjurationTypes[s])){this.conjurationData.conjurationType=s;break}}}else this.trackedId=t.id,this.actor=a;this.render(!0)}else for(let a of this.subApps)if(await a._onDrop(t)===!0)break}async prepareEntityAbilities(){let e={entityAbilities:[],entityPackages:[]};if(game.dsa5.itemLibrary.equipmentBuild){let t=[game.i18n.localize("LocalizedIDs.all"),this.conjurationData.conjurationTypes[this.conjurationData.conjurationType]],a=await Promise.all((await game.dsa5.itemLibrary.getCategoryItems("trait",!1)).map(n=>n.getItem())),s=new Set,i=new Set;for(let n of a)n.system.distribution&&t.some(r=>n.system.distribution.includes(r))&&(n.system.traitType.value=="entity"&&!s.has(n.name)?(s.add(n.name),e.entityAbilities.push(n),n.count=this.conjurationData.selectedEntityIds.filter(r=>r==n.uuid).length,n.max=n.system.at.value||1):n.system.traitType.value=="summoning"&&!i.has(n.name)&&(i.add(n.name),n.count=this.conjurationData.selectedPackageIds.filter(r=>r==n.uuid).length,e.entityPackages.push(n)))}return e}async getData(e){let t=await super.getData(e);if(!game.user.isGM&&!this.actor&&(this.actor=game.user.character),this.actor){let a=this.conjurationData.qs-this.conjurationData.consumedQS+1,s=game.dsa5.itemLibrary.equipmentBuild,{entityAbilities:i,entityPackages:n}=await this.prepareEntityAbilities(),r=this.actor.items.filter(p=>this.conjurationData.skills[this.conjurationData.conjurationType].includes(p.name)&&["liturgy","ceremony","spell","ritual"].includes(p.type)).map(p=>p.toObject()),o=!1;for(let p of r)p.hasMighty=this.actor.items.find(g=>g.name==`${p.name} - ${game.i18n.localize("CONJURATION.powerfulCreature")}`),o||(o=p.hasMighty);let c=this.conjurationData.modifiers[this.conjurationData.conjurationType],m=o?2:1;for(let p of c)p.max=m,p.count=this.conjurationData.selectedIds.filter(g=>g==p.id).length;let d=await renderTemplate("systems/dsa5/templates/system/conjuration/summoning.html",{actor:this.actor,conjuration:this.conjuration||{name:game.i18n.localize("CONJURATION.dragConjuration"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,services:a,conjurationModifiers:c,equipmentIndexLoaded:s,entityAbilities:i,entityPackages:n,moreModifiers:this.conjurationData.moreModifiers[this.conjurationData.conjurationType],hasMighty:o});mergeObject(t,{conjurationSheet:d,conjurationskills:r})}return mergeObject(t,{actor:this.actor||{name:game.i18n.localize("CONJURATION.dragActor"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,conjurationTypes:this.conjurationData.conjurationTypes}),await this.prepareSubApps(t),t}async prepareSubApps(e){e.subApps=[];for(let t of this.subApps)e.subApps.push(await t.prepareApp(e))}};u(ze,"PlayerMenu");var Ns=class extends Q{constructor(e,t,a){super({title:`${game.i18n.localize("CONJURATION.request")} (${t.name})`,default:"ok",buttons:{}}),this.conjuration=e,this.summoner=t,this.creationData=a,this.confirmed=!1}async getData(e){let t=await super.getData(e),a=this.uniqueCountIds(this.creationData.entityIds);return mergeObject(t,{conjuration:this.conjuration,summoner:this.summoner,confirmed:this.confirmed,services:this.creationData.qs-this.creationData.consumedQS+1,creationData:this.creationData,conjurationModifiers:this.creationData.modifiers,entityModifiers:await Promise.all(Object.keys(a).map(async s=>{let i=(await fromUuid(s)).toObject(!1);return i.uuid=s,i.count=a[s],i.cost=Number(i.system.AsPCost.value)*a[s],i})),packageModifiers:await Promise.all(this.creationData.packageIds.map(s=>fromUuid(s))),actor:this.actor}),t}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog"]),width:470}),e.template="systems/dsa5/templates/system/conjuration/request.html",e}uniqueCountIds(e){return e.reduce((t,a)=>(t[a]?++t[a]:t[a]=1,t),{})}async createActor(){this.confirmed=!0;let e=await f.getFolderForType("Actor",null,game.i18n.localize("PLAYER.conjuration")),t=await f.getFolderForType("Actor",e.id,this.creationData.typeName),a=this.creationData.qs-this.creationData.consumedQS+1;this.conjuration.folder=t.id,this.conjuration.effects||(this.conjuration.effects=[]);for(let c of this.creationData.modifiers)this.conjuration.effects.push({changes:c.changes,duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize(c.name),flags:{dsa5:{description:`${game.i18n.localize("PLAYER.conjuration")} ${game.i18n.localize("extensions")}`,hideOnToken:!0,hidePlayers:!1}}}),c.fun&&c.fun(this.conjuration,this.creationData);let s=this.uniqueCountIds(this.creationData.entityIds),i=(await Promise.all(Object.keys(s).map(c=>fromUuid(c)))).map(c=>{let m=c.toObject(!1);return s[c.uuid]>1&&(m.system.step={value:s[c.uuid]}),m}),n=(await Promise.all(this.creationData.packageIds.map(c=>fromUuid(c)))).map(c=>c.toObject(!1));this.conjuration.effects.push({changes:[],duration:{},icon:"icons/svg/aura.svg",id:"services",name:game.i18n.localize("PLAYER.services"),flags:{dsa5:{value:a,max:500,description:`${game.i18n.localize("PLAYER.conjuration")} ${game.i18n.localize("PLAYER.services")}`,manual:a,auto:0,hideOnToken:!0,hidePlayers:!1}}}),game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type]&&await game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type](this.conjuration,this.creationData.qs-this.creationData.consumedQS,this.creationData.type),this.conjuration.type=="creature"&&!this.conjuration.system.creatureClass.value.includes(this.creationData.typeName)&&(this.conjuration.system.creatureClass.value+=`, ${this.creationData.typeName}`),this.actor=await S.create(this.conjuration);let r=[...i,...n].filter(c=>!this.conjuration.items.find(m=>m.type==c.type&&c.name==m.name));await this.actor.createEmbeddedDocuments("Item",r);for(let c of n)await ce.traitAdded(this.actor,c);for(let c of i)await ce.traitAdded(this.actor,c);await this.actor.update({"system.status.wounds.value":this.actor.system.status.wounds.max});let o=await renderTemplate("systems/dsa5/templates/system/conjuration/chat.html",{actor:this.actor,modifiers:this.creationData.modifiers,summoner:this.summoner,summonerImg:H.videoOrImgTag(this.summoner.img),conjureImg:H.videoOrImgTag(this.actor.img),services:a});await ChatMessage.create(f.chatDataSetup(o)),this.render()}activateListeners(e){super.activateListeners(e),e.find(".createActor").click(()=>{this.createActor()}),e.on("mousedown",".newNPC",async t=>{let a=t.currentTarget.dataset.id;t.button==2&&(game.actors.get(a).delete(),$(t.currentTarget).remove())}),e.on("click",".newNPC",async t=>{let a=t.currentTarget.dataset.id;game.actors.get(a).sheet.render(!0)}),e.on("dragstart",".newNPC",t=>{t.stopPropagation();let a=t.currentTarget,s={type:"Actor",uuid:a.dataset.uuid};t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(s))}),e.find(".showEntity").click(t=>{t.stopPropagation(),u(async()=>{(await fromUuid(t.currentTarget.dataset.uuid)).sheet.render(!0)},"fun")()})}};u(Ns,"ConjurationRequest");var tt=u(l=>class extends l{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["merchant-sheet"])}),e}static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/merchant-sheet.html"}get template(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsa5/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsa5/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsa5/templates/actors/merchant/merchant-epic.html";default:return super.template}return this.constructor.merchantTemplate}merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}async allowMerchant(e,t){let a=duplicate(this.actor.ownership),s=t?1:0;for(let i of e)a[i]=s;await this.actor.update({ownership:a},{diff:!1,recursive:!1,noHook:!0})}activateListeners(e){super.activateListeners(e),e.find(".allowMerchant").click(async t=>{let a=t.currentTarget.dataset.userId,s=$(t.currentTarget).find("i");await this.allowMerchant([a],!s.hasClass("fa-check-circle")),s.toggleClass("fa-circle fa-check-circle")}),e.find(".toggleAllAllowMerchant").click(async t=>{let a=game.users.filter(i=>!i.isGM).map(i=>i.id),s=t.currentTarget.dataset.lock=="true";await this.allowMerchant(a,s),this.render()}),e.find(".lockTradeSection").click(t=>this.lockTradeSection(t)),e.find(".item-tradeLock").click(t=>this.toggleTradeLock(t)),e.find(".randomGoods").click(t=>this.randomGoods(t)),e.find(".clearInventory").click(t=>this.clearInventory(t)),e.find(".removeOtherTradeFriend").click(()=>this.removeOtherTradeFriend()),e.find(".choseTradefriend").click(()=>this.choseTradefriend()),e.find(".setCustomPrice").click(t=>$(t.currentTarget).addClass("edit")),e.find(".customPriceTag").change(async t=>this.setCustomPrice(t)).blur(t=>$(t.currentTarget).closest(".setCustomPrice").removeClass("edit")),e.find(".buy-item").click(t=>{this.advanceWrapper(t,"buyItem",t),V.playMoneySound()}),e.find(".sell-item").click(t=>{this.advanceWrapper(t,"sellItem",t),V.playMoneySound()}),e.find(".item-external-edit").click(t=>{t.preventDefault();let a=this._getItemId(t);this.getTradeFriend().items.get(a).sheet.render(!0)}),e.find(".changeAmountAllItems").mousedown(t=>this.changeAmountAllItems(t)),e.find(".gearSearch").prop("disabled",!1)}_canDragStart(e){return!this.merchantSheetActivated()&&this.isEditable}async toggleTradeLock(e){let t=this._getItemId(e),a=this.actor.items.get(t);this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.tradeLocked":!a.system.tradeLocked}])}async setCustomPrice(e){e.stopPropagation(),e.preventDefault();let t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"flags.dsa5.customPriceTag":Number(e.target.value)}])}removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}async choseTradefriend(){(await At.getDialog(this)).render(!0)}async lockTradeSection(e){let t=[],a=this.filterRule(e),s;for(let i of this.actor.items)if(a(i)){let n=i.toObject();s===void 0&&(s=!n.system.tradeLocked),n.system.tradeLocked=s,t.push(n)}this.actor.updateEmbeddedDocuments("Item",t)}filterRule(e){let t=e.currentTarget.dataset.type;return b.equipmentTypes[t]?a=>a.type=="equipment"&&a.system.equipmentType.value==t:a=>a.type==t&&b.equipmentCategories.has(a.type)}async changeAmountAllItems(e){let t=[],a=this.filterRule(e);for(let s of this.actor.items)if(a(s)){let i=s.toObject();_.increment(e,i,"system.quantity.value",0),t.push(i)}this.actor.updateEmbeddedDocuments("Item",t)}async buyItem(e){await this.transferItem(this.actor,this.getTradeFriend(),e,!0)}async sellItem(e){await this.transferItem(this.getTradeFriend(),this.actor,e,!1)}async transferItem(e,t,a,s=!0){let i=this._getItemId(a),n=a.currentTarget.dataset.price,r=a.ctrlKey?10:1;game.user.isGM?await this.constructor.finishTransaction(e,t,n,i,s,r):(this.constructor.noNeedToPay(t,e,n)||G.canPay(t,n,!0))&&game.socket.emit("system.dsa5",{type:"trade",payload:{target:this.constructor.transferTokenData(t),source:this.constructor.transferTokenData(e),price:n,itemId:i,buy:s,amount:r}})}static transferTokenData(e){let t={actor:e.id};return e.token&&(t.token=e.token.id),t}static async finishTransaction(e,t,a,s,i,n){let r=e.items.get(s).toObject();if(n=Math.min(Number(r.system.quantity.value),n),Number(r.system.quantity.value)>0){let o=this.noNeedToPay(t,e,a);if(o||await G.payMoney(t,a,!0))if(getProperty(r,"system.worn.value")&&(r.system.worn.value=!1),i){let m=await this.updateTargetTransaction(t,r,n,e,a);await this.updateSourceTransaction(e,t,r,a,s,n),await this.transferNotification(r,t,e,i,a,n,o,m),await this.selfDestruction(e)}else{await this.updateSourceTransaction(e,t,r,a,s,n);let m=await this.updateTargetTransaction(t,r,n,e,a);await this.transferNotification(r,e,t,i,a,n,o,m)}}}static isTemporaryToken(e){return getProperty(e.system,"merchant.merchantType")=="loot"&&getProperty(e.system,"merchant.temporary")}static async selfDestruction(e){if(this.isTemporaryToken(e)&&!e.items.some(a=>b.equipmentCategories.has(a.type)||a.type=="money"&&a.system.quantity.value>0)){game.socket.emit("system.dsa5",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(e)}});let a=e.getActiveTokens().map(s=>s.id);await canvas.scene.deleteEmbeddedDocuments("Token",a),await game.actors.get(e.id).delete(),this.hideDeletedSheet(e)}}static async hideDeletedSheet(e){e.sheet.close(!0)}static async transferNotification(e,t,a,s,i,n,r,o){let c=game.settings.get("dsa5","merchantNotification");if(c==0||getProperty(e,"system.equipmentType.value")=="service")return;let m="MERCHANT."+(s?"buy":"sell")+(r?"Loot":"")+"Notification",d=e.type=="money"?game.i18n.localize(e.name):o.toAnchor().outerHTML,p=game.i18n.format(m,{item:d,source:t.name,target:a.name,amount:n,price:i,buy:s}),g=f.chatDataSetup(p);c==2&&(g.whisper=ChatMessage.getWhisperRecipients("GM").map(h=>h.id)),await ChatMessage.create(g)}static noNeedToPay(e,t,a){return a==0||getProperty(e.system,"merchant.merchantType")=="loot"||getProperty(t.system,"merchant.merchantType")=="loot"}static async updateSourceTransaction(e,t,a,s,i,n){let r=duplicate(a);Number(r.system.quantity.value)>n||r.type=="money"?(r.system.quantity.value=Number(r.system.quantity.value)-n,await e.updateEmbeddedDocuments("Item",[r])):await e.deleteEmbeddedDocuments("Item",[i]),this.noNeedToPay(e,t,s)||await G.getMoney(e,s,!0)}static async updateTargetTransaction(e,t,a,s,i){let n=duplicate(t);if(getProperty(n,"system.equipmentType.value")=="service"){let o=game.i18n.format("MERCHANT.buyNotification",{item:n.name,amount:a,source:e.name,target:s.name,price:i});ChatMessage.create(f.chatDataSetup(o))}else{let o=e.items.find(c=>C.areEquals(n,c));return n.system.quantity.value=a,o?(await C.stackItems(o,n,e),o):(await e.createEmbeddedDocuments("Item",[n]))[0]}}getTradeFriend(){return this.otherTradeFriend||game.user.character}async _manageDragItems(e,t){switch(t){case"creature":case"npc":case"character":this.setTradeFriend(e);break;default:return super._manageDragItems(e,t)}}async _onDropActor(e,t){let a=this.actor.limited,s=this.actor.isOwner;if(!(a||s))return!1;let{item:i,typeClass:n,selfTarget:r}=await Fe(t,this.id,!1);if(!r&&(s||a&&i.documentName=="Actor"))return await this._manageDragItems(i,n)}setTradeFriend(e){let t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}async _render(e=!1,t={}){if(!game.user.isGM&&getProperty(this.actor.system,"merchant.merchantType")=="loot"&&getProperty(this.actor.system,"merchant.locked")){AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1);return}await super._render(e,t)}_togglePlayerview(e){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}playerViewEnabled(){return getProperty(this.actor.system,"merchant.playerView")}async randomGoods(e){let t=await renderTemplate("systems/dsa5/templates/dialog/randomGoods-dialog.html",{categories:Array.from(b.equipmentCategories)});new Dialog({title:game.i18n.localize("MERCHANT.randomGoods"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:a=>this.addRandomGoods(this.actor,a,e)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async clearInventory(e){new Dialog({title:game.i18n.localize("MERCHANT.clearInventory"),content:game.i18n.localize("MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{this.removeAllGoods(this.actor,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async addRandomGoods(e,t,a){let s=$(a.currentTarget).text();$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=[];t.find('input[type="checkbox"]:checked').each(function(){let c=$(this).val();i.push({name:c,count:Number(t.find(`input[name="each_${c}"]`).val()),number:Number(t.find(`input[name="number_${c}"]`).val())})});let n=game.dsa5.itemLibrary;n.equipmentBuild||await n.buildEquipmentIndex();let r=[];for(let c of i){let m=(await n.getRandomItems(c.name,c.number)).map(d=>{let p=d.toObject();return p.system.quantity.value=c.count,p});r.push(...m)}let o={};r=r.filter(function(c){let m=getProperty(c,"system.effect");m=typeof m=="object"&&m!==null&&getProperty(m,"attributes")||"";let d=Number(getProperty(c,"system.price.value"))||0;if(m!=""||d>1e4)return!1;let p=`${c.type}_${c.name}`;return(o.hasOwnProperty(p)?!1:o[p]=!0)&&e.items.filter(function(g){return g.type==c.type&&g.name==c.name}).length==0}),await e.createEmbeddedDocuments("Item",r),$(a.currentTarget).text(s)}async removeAllGoods(e,t){let a=$(t.currentTarget).text();$(t.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let s=e.items.filter(i=>b.equipmentCategories.has(i.type)&&!getProperty(i,"worn.value")).map(i=>i.id);await e.deleteEmbeddedDocuments("Item",s),$(t.currentTarget).text(a)}async getData(e){let t=await super.getData(e);return t.merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",t.merchantTypes={none:game.i18n.localize("MERCHANT.typeNone"),merchant:game.i18n.localize("MERCHANT.typeMerchant"),loot:game.i18n.localize("MERCHANT.typeLoot"),epic:game.i18n.localize("MERCHANT.typeEpic")},t.invName=t.merchantTypes[t.merchantType],t.players=game.users.filter(a=>!a.isGM).map(a=>(a.allowedMerchant=this.actor.testUserPermission(a,"LIMITED",!1),a.buyingFactor=getProperty(this.actor.system,`merchant.factors.buyingFactor.${a.id}`),a.sellingFactor=getProperty(this.actor.system,`merchant.factors.sellingFactor.${a.id}`),a)),t.merchantType!="epic"?(this.prepareStorage(t),this.merchantSheetActivated()&&(this.filterWornEquipment(t),this.prepareTradeFriend(t),t.prepare.inventory.misc.items.length==0&&(t.prepare.inventory.misc.show=!1))):(this.prepareStorage(t),t.garadanOptions={1:game.i18n.localize("GARADAN.1"),2:game.i18n.localize("GARADAN.2"),3:game.i18n.localize("GARADAN.3"),4:game.i18n.localize("GARADAN.4"),6:game.i18n.localize("GARADAN.6")}),t.hasOtherTradeFriend=!!this.otherTradeFriend,t}filterWornEquipment(e){for(let[t,a]of Object.entries(e.prepare.inventory))a.items=a.items.filter(s=>!getProperty(s,"system.worn.value"))}prepareStorage(e){if(e.merchantType=="merchant")for(let[t,a]of Object.entries(e.prepare.inventory))for(let s of a.items)s.defaultPrice=this.getItemPrice(s),s.calculatedPrice=Number(parseFloat(`${s.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1)}`).toFixed(2))*(getProperty(this.actor.system,`merchant.factors.sellingFactor.${game.user.id}`)||1),s.priceTag=` / ${s.calculatedPrice}`;else if(e.merchantType=="loot"){for(let[a,s]of Object.entries(e.prepare.inventory))for(let i of s.items)i.calculatedPrice=this.getItemPrice(i);let t={items:e.prepare.money.coins.map(a=>(a.name=game.i18n.localize(a.name),a)),show:!0,dataType:"money"};t.items.length&&(e.prepare.inventory.money=t)}}getItemPrice(e){return Number(getProperty(e,"flags.dsa5.customPriceTag"))||(e.type=="consumable"?C.getSubClass(e.type).consumablePrice(e):Number(e.system.price.value))}prepareTradeFriend(e){let t=this.getTradeFriend();if(t){let a=t.prepareItems({details:[]}),s=getProperty(this.actor.system,"merchant.merchantType")=="loot"?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,`merchant.factors.buyingFactor.${game.user.id}`)||1),i=this.prepareSellPrices(a.inventory,s);i.misc.items.length==0&&(i.misc.show=!1),e.merchantType=="loot"&&(i.money={items:a.money.coins.map(n=>(n.name=game.i18n.localize(n.name),n)),show:!0,dataType:"money"}),mergeObject(e,{tradeFriend:{img:t.img,name:t.name,inventory:i,money:a.money}})}else mergeObject(e,{tradeFriend:{inventory:[],money:{coins:[]}}})}prepareSellPrices(e,t){for(let[a,s]of Object.entries(e))for(let i of s.items)i.calculatedPrice=Number(parseFloat(`${this.getItemPrice(i)*t}`).toFixed(2));return e}},"MerchantSheetMixin"),At=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{}),e}static async getDialog(e){let t=game.user.isGM?await game.dsa5.apps.gameMasterMenu.getTrackedHeros():game.actors.filter(s=>s.isOwner),a=new At({title:game.i18n.localize("DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsa5/templates/dialog/selectTradeFriend.html",{users:t}),default:"yes",buttons:{}});return a.actor=e,a}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){this.actor.setTradeFriend({_id:e.currentTarget.dataset.id}),this.close()}};u(At,"SelectTradefriendDialog");var Te=class extends tt(Ee){};u(Te,"MerchantSheetDSA5");function Ei(){game.socket.on("system.dsa5",l=>{switch(l.type){case"hideDeletedSheet":let e=l.payload.target.token?game.actors.tokens[l.payload.target.token]:game.actors.get(l.payload.target.actor);Te.hideDeletedSheet(e);return;default:de.socketListeners(l)}}),game.user.isGM&&game.socket.on("system.dsa5",l=>{if(!!f.isActiveGM())switch(l.type){case"updateKeepField":b.allowedforeignfields.includes(l.payload.field)&&game.actors.get(l.payload.actorId).update({[l.payload.field]:l.payload.updateData});break;case"target":{let e=game.scenes.get(l.payload.scene);new Token(e.getEmbeddedDocument("Token",l.payload.target)).actor.update({"flags.oppose":l.payload.opposeFlag})}break;case"addEffect":_DSAActiveEffectConfig.applyEffect(l.payload.id,l.payload.mode,l.payload.actors);break;case"updateMsg":game.messages.get(l.payload.id).update(l.payload.updateData);break;case"deleteMsg":game.messages.get(l.payload.id).delete();break;case"showDamage":H.showDamage(game.messages.get(l.payload.id),l.payload.hide);break;case"hideQueryButton":H.hideReactionButton(l.payload.id);break;case"updateGroupCheck":B.rerenderGC(game.messages.get(l.payload.messageId),l.payload.data);break;case"updateAttackMessage":game.messages.get(l.payload.messageId).update({"flags.data.unopposedStartMessage":l.payload.startMessageId});break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"clearOpposed":H.clearOpposed(game.actors.get(l.payload.actorId));break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(l.payload.speaker);break;case"trade":{let e=l.payload.source.token?game.actors.tokens[l.payload.source.token]:game.actors.get(l.payload.source.actor),t=l.payload.target.token?game.actors.tokens[l.payload.target.token]:game.actors.get(l.payload.target.actor);Te.finishTransaction(e,t,l.payload.price,l.payload.itemId,l.payload.buy,l.payload.amount)}break;case"playWhisperSound":l.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:l.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(l.payload.id).then(e=>{new J(e).socketedConditionAddActor(l.payload.actors.map(a=>game.actors.get(a)),l.payload.data)});break;case"socketedConditionAdd":fromUuid(l.payload.id).then(e=>{new J(e).socketedConditionAdd(l.payload.targets,l.payload.data)});break;case"socketedRemoveCondition":fromUuid(l.payload.id).then(e=>{new J(e).socketedRemoveCondition(l.payload.targets,l.payload.coreId)});break;case"socketedActorTransformation":fromUuid(l.payload.id).then(e=>{new J(e).socketedActorTransformation(l.payload.targets,l.payload.update)});break;case"itemDrop":{let e=l.payload.sourceActorId?game.actors.get(l.payload.sourceActorId):void 0;fromUuid(l.payload.itemId).then(t=>{Zs(e,t,l.payload.data,l.payload.amount)})}break;case"finalizeFoodContribution":case"hideDeletedSheet":case"finalizeidentification":case"updateHits":case"hideResistButton":case"receiveOfferedItems":case"startTrade":case"acceptTrade":case"tradeCanceled":case"tradeFinished":break;case"reduceGroupSchip":S.reduceGroupSchip();break;case"summonCreature":ze.createConjuration(l.payload);break;default:console.warn(`Unhandled socket data type ${l.type}`)}})}u(Ei,"connectSocket");function ni(){Hooks.on("ready",async()=>{Ei(),f.moduleEnabled("vtta-tokenizer")&&!await game.settings.get("dsa5","tokenizerSetup")&&game.user.isGM&&(await game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsa5/icons/backgrounds/token_green.webp"),await game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsa5/icons/backgrounds/token_black.webp"),await game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsa5/icons/backgrounds/token_blue.webp"),await game.settings.set("dsa5","tokenizerSetup",!0)),f.moduleEnabled("dice-so-nice")&&!await game.settings.get("dsa5","diceSetup")&&game.user.isGM&&(await game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0),await game.settings.set("dsa5","diceSetup",!0)),await $e.firstTimeMessage(),C.setupSubClasses(),Re.showOneMessage(),game.settings.get("dsa5","disableTokenhotbar")||ie.registerTokenHotbar(),Di(),Oe.connectHooks();let l=u(e=>{e.tabName=="settings"&&(xe.travelAgency(),Hooks.off("changeSidebarTab",l))},"hook");Hooks.on("changeSidebarTab",l),Ai(),vi()})}u(ni,"default");function ri(){Token.prototype.drawEffects=async function(){this.effects.removeChildren().forEach(i=>i.destroy()),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null;let t=this.document.effects,a=[];this.actor&&(a=await this.actor.actorEffects(),this.actor.isSwarm()&&a.push(new ActiveEffect({icon:"systems/dsa5/icons/thirdparty/bee.svg",id:"swarm",name:"swarm.name",flags:{dsa5:{value:this.actor.system.swarm?.effectiveCount||1}}})));let s={src:this.document.overlayEffect,tint:null};if(t.length||a.length){let i=[];for(let n of a){if(!n.icon)continue;let r=Color.from(n.tint??null);if(n.getFlag("core","overlay")){s={src:n.icon,tint:r};continue}i.push(this._drawEffect(n.icon,r,getProperty(n,"flags.dsa5.value")))}for(let n of t)i.push(this._drawEffect(n,null));await Promise.all(i)}this.effects.overlay=await this._drawOverlay(s.src,s.tint),this._refreshEffects()},Token.prototype._refreshEffects=function(){let t=0,a=Math.round(canvas.dimensions.size/2/5)*2,s=Math.floor(this.document.height*5),i=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(let n of this.effects.children)if(n!==i&&!n.isCounter)if(n===this.effects.overlay){let r=Math.min(this.w*.6,this.h*.6);n.width=n.height=r,n.position.set((this.w-r)/2,(this.h-r)/2)}else{if(n.width=n.height=a,n.x=Math.floor(t/s)*a,n.y=t%s*a,i.drawRoundedRect(n.x+1,n.y+1,a-2,a-2,2),n.counter>1&&!n.counterDrawn){let r=game.dsa5.config.effectTextStyle,o=game.settings.get("dsa5","statusEffectCounterColor");r._fill=/^#[0-9A-F]+$/.test(o)?o:"#000000";let c=this.effects.addChild(new PreciseText(n.counter,r));c.x=n.x,c.y=n.y,c.isCounter=!0,n.counterDrawn=!0}t++}},Token.prototype._drawEffect=async function(t,a,s){if(!t)return;let i=await loadTexture(t,{fallback:"icons/svg/hazard.svg"}),n=new PIXI.Sprite(i);return a&&(n.tint=a),n.counter=s,this.effects.addChild(n)},TokenHUD.prototype._onToggleEffect=function(t,{overlay:a=!1}={}){t.preventDefault();let s=t.currentTarget,i=s.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find(n=>n.id===s.dataset.statusId):s.getAttribute("src");if(!(!i.flags.dsa5?.max||i.flags.dsa5?.notEditable)){if(t.button==0)return this.object.incrementCondition(i);if(t.button==2)return this.object.decrementCondition(i)}},Token.prototype.incrementCondition=async function(t,{active:a,overlay:s=!1}={}){let i=this.actor.effects.find(n=>n.statuses.has(t.id));return!i||Number.isNumeric(getProperty(i,"flags.dsa5.value"))?await this.actor.addCondition(t.id,1,!1,!1):i&&await this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),a},Token.prototype.decrementCondition=async function(t,{active:a,overlay:s=!1}={}){return this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),a};let l=Token.prototype._onClickLeft2,e=u(t=>t?["merchant","loot"].includes(getProperty(t.system,"merchant.merchantType")):!1,"isMerchant");Token.prototype._onClickLeft2=function(t){if(!(game.user.isGM||!Y.isEnabled||!e(this.actor)||Y.inDistance(this)))return ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"));l.call(this,t)}}u(ri,"default");function oi(){Hooks.on("renderSettings",(l,e,t)=>{let a=$(`<button id="reportADSABug"><i class="fas fa-bug"></i> ${game.i18n.localize("DSA5Error")}</button>`);a.click(()=>{window.open("https://github.com/Plushtoast/dsa5-foundryVTT/issues","_blank")}),e.find("#settings-documentation").append(a),a=$(`<button><i class="fas fa-info-circle"></i> ${game.i18n.localize("DSA5Wiki")}</button>`),a.click(()=>{window.open("https://github.com/Plushtoast/dsa5-foundryVTT/wiki","_blank")}),e.find("#settings-documentation").append(a),a=$('<button class="fshopButton"><div></div> F-Shop</button>'),a.click(()=>{window.open(game.i18n.localize("fshopLink"),"_blank")}),e.find("#settings-documentation").append(a);let s=game.system.title.split("/")[game.i18n.lang=="de"?0:1],i=e.find("#game-details .system .system-info").html();e.find("#game-details .system").html(`<span class="system-title">${s}</span><span class="system-info">${i}</span>`)}),Hooks.on("renderCompendiumDirectory",(l,e,t)=>{let a=$(`<button id="openLibrary"><i class="fas fa-university"></i>${game.i18n.localize("ItemLibrary")}</button>`);e.find(".header-actions").append(a),a.click(()=>{game.dsa5.itemLibrary.render(!0)}),e.find('li[data-pack="dsa5.money"]').remove()}),Hooks.once("renderCompendiumDirectory",(l,e,t)=>{let a=game.i18n.lang=="de"?"en":"de",s=game.packs.filter(i=>getProperty(i.metadata,"flags.dsalang")==a);for(let i of s){let n=`${i.metadata.packageName}.${i.metadata.name}`;game.packs.delete(n),game.data.packs=game.data.packs.filter(r=>r.id!=n),e.find(`li[data-pack="${n}"]`).remove()}}),Hooks.on("renderActorDirectory",(l,e,t)=>{if(!game.user.isGM)for(let a of l.documents.filter(s=>s.isMerchant()&&getProperty(s,"system.merchant.hidePlayer")))e.find(`[data-document-id="${a.id}"]`).remove()})}u(oi,"default");function $i(){game.settings.register("dsa5","meleeBotchTableEnabled",{name:"DSASETTINGS.meleeBotchTableEnabled",hint:"DSASETTINGS.meleeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","rangeBotchTableEnabled",{name:"DSASETTINGS.rangeBotchTableEnabled",hint:"DSASETTINGS.rangeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","applyDamageInChat",{name:"DSASETTINGS.applyDamageInChat",hint:"DSASETTINGS.applyDamageInChatHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","doubleDamageOptions",{name:"DSASETTINGS.doubleDamageOptions",hint:"DSASETTINGS.doubleDamageOptionsHint",scope:"client",config:!0,default:!1,type:Boolean,requiresReload:!0}),game.settings.register("dsa5","defenseBotchTableEnabled",{name:"DSASETTINGS.defenseBotchTableEnabled",hint:"DSASETTINGS.defenseBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","higherDefense",{name:"DSASETTINGS.higherDefense",hint:"DSASETTINGS.higherDefenseHint",scope:"world",config:!0,default:"0",type:String,choices:{0:"0",2:"+2",4:"+4"}}),game.settings.register("dsa5","informationDistribution",{name:"DSASETTINGS.informationDistribution",hint:"DSASETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("DSASETTINGS.information0"),1:game.i18n.localize("DSASETTINGS.information1"),2:game.i18n.localize("DSASETTINGS.information2")}}),game.settings.register("dsa5","enableItemDropToCanvas",{name:"DSASETTINGS.enableItemDropToCanvas",hint:"DSASETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","statusEffectCounterColor",{name:"DSASETTINGS.statusEffectCounterColor",hint:"DSASETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsa5","migrationVersion",{name:"migrationVersion",hint:"migrationVersion",scope:"world",config:!1,default:25,type:Number}),game.settings.register("dsa5","journalFontSizeIndex",{name:"journalFontSizeIndex",hint:"journalFontSizeIndex",scope:"client",config:!1,default:5,type:Number}),game.settings.register("dsa5","firstTimeStart",{name:"firstTimeStart",hint:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","defaultConfigFinished",{name:"defaultConfigFinished",hint:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","tokenizerSetup",{name:"tokenizerSetup",hint:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","capQSat",{name:"DSASETTINGS.capQSat",hint:"DSASETTINGS.capQSatHint",scope:"world",config:!0,default:6,type:Number}),game.settings.register("dsa5","hideEffects",{name:"DSASETTINGS.hideEffects",hint:"DSASETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","inventorySound",{name:"DSASETTINGS.inventorySound",hint:"DSASETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","talentModifierEnabled",{name:"DSASETTINGS.talentModifierEnabled",hint:"DSASETTINGS.talentModifierEnabledHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","noConfirmationRoll",{name:"DSASETTINGS.noConfirmationRoll",hint:"DSASETTINGS.noConfirmationRollHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","lessRegeneration",{name:"DSASETTINGS.lessRegeneration",hint:"DSASETTINGS.lessRegenerationHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","limitCombatSpecAbs",{name:"DSASETTINGS.limitCombatSpecAbs",hint:"DSASETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","allowPhysicalDice",{name:"DSASETTINGS.allowPhysicalDice",hint:"DSASETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideOpposedDamage",{name:"DSASETTINGS.hideOpposedDamage",hint:"DSASETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableForeignSpellModifer",{name:"DSASETTINGS.enableForeignSpellModifer",hint:"DSASETTINGS.enableForeignSpellModiferHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","playerCanEditSpellMacro",{name:"DSASETTINGS.playerCanEditSpellMacro",hint:"DSASETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableDPS",{name:"DSASETTINGS.enableDPS",hint:"DSASETTINGS.enableDPSHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","iniTrackerSize",{name:"DSASETTINGS.iniTrackerSize",hint:"DSASETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:async e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.constructor.defaultOptions.itemWidth=e)}}),game.settings.register("dsa5","iniTrackerCount",{name:"DSASETTINGS.iniTrackerCount",hint:"DSASETTINGS.iniTrackerCountHint",scope:"client",config:!0,default:5,type:Number,range:{min:3,max:25,step:1},onChange:async e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.constructor.defaultOptions.actorCount=e)}}),game.settings.register("dsa5","tokenhotbarSize",{name:"DSASETTINGS.tokenhotbarSize",hint:"DSASETTINGS.tokenhotbarSizeHint",scope:"client",config:!1,default:35,type:Number,range:{min:15,max:100,step:5},onChange:async e=>{game.dsa5.apps.tokenHotbar&&(game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=e)}}),game.settings.register("dsa5","tokenhotbarLayout",{name:"DSASETTINGS.tokenhotbarLayout",hint:"DSASETTINGS.tokenhotbarLayoutHint",scope:"client",config:!1,default:0,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("DSASETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("DSASETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("DSASETTINGS.tokenhotbarLayout3")}});let l=duplicate(b.styles);for(let e of Object.keys(l))l[e]=game.i18n.localize(l[e]);game.settings.register("dsa5","globalStyle",{name:"DSASETTINGS.globalStyle",hint:"DSASETTINGS.globalStyleHint",scope:"client",config:!0,default:"dsa5-immersive",type:String,choices:l,onChange:async e=>{$("body").removeClass(Object.keys(l).join(" ")).addClass(e)}}),game.settings.register("dsa5","selfControlOnPain",{name:"DSASETTINGS.selfControlOnPain",hint:"DSASETTINGS.selfControlOnPainHint",scope:"world",config:!0,default:1,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.selfControlOnPain0"),1:game.i18n.localize("DSASETTINGS.selfControlOnPain1"),2:game.i18n.localize("DSASETTINGS.selfControlOnPain2")}}),game.settings.register("dsa5","forceLanguage",{name:"DSASETTINGS.forceLanguage",hint:"DSASETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German",en:"English"}}),game.settings.register("dsa5","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","masterSettings",{name:"masterSettings",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","iniTrackerPosition",{name:"iniTrackerPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","soundConfig",{name:"DSASETTINGS.soundConfig",hint:"DSASETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:async()=>{V.loadSoundConfig()}}),game.settings.registerMenu("dsa5","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("DSASETTINGS.changelog"),type:Ls,restricted:!1}),game.settings.registerMenu("dsa5","exportConfiguration",{name:"Export/Import Configuration",label:"Export/Import Configuration",hint:game.i18n.localize("DSASETTINGS.exportConfiguration"),type:Rs,restricted:!0}),game.settings.registerMenu("dsa5","configureTokenbar",{name:game.i18n.localize("DSASETTINGS.configureTokenbar"),label:game.i18n.localize("DSASETTINGS.configureTokenbar"),hint:game.i18n.localize("DSASETTINGS.configureTokenbarHint"),type:_s,restricted:!1}),game.settings.register("dsa5",`breadcrumbs_${game.world.id}`,{name:"DSASETTINGS.breadcrumbs",hint:"DSASETTINGS.breadcrumbsHint",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsa5","groupschips",{name:"DSASETTINGS.groupschips",hint:"DSASETTINGS.groupschips",scope:"world",config:!1,default:"0/0",type:String,onChange:async()=>{game.user.isGM&&game.dsa5.apps.gameMasterMenu.render()}}),game.settings.register("dsa5","expandChatModifierlist",{name:"DSASETTINGS.expandChatModifierlist",hint:"DSASETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexWorldItems",{name:"DSASETTINGS.indexWorldItems",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","filterDuplicateItems",{name:"DSASETTINGS.filterDuplicateItems",scope:"client",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","enableCombatFlow",{name:"DSASETTINGS.enableCombatFlow",hint:"DSASETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:()=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0)}}),game.settings.register("dsa5","enableCombatPan",{name:"DSASETTINGS.enableCombatPan",hint:"DSASETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","lightSightCompensationEnabled",{name:"lightSightCompensationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","randomWeaponSelection",{name:"DSASETTINGS.randomWeaponSelection",hint:"DSASETTINGS.randomWeaponSelection",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","showWeaponsOnHover",{name:"DSASETTINGS.showWeaponsOnHover",hint:"DSASETTINGS.showWeaponsOnHover",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","disableDidYouKnow",{name:"DSASETTINGS.disableDidYouKnow",hint:"DSASETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","disableTokenhotbar",{name:"DSASETTINGS.disableTokenhotbar",hint:"DSASETTINGS.disableTokenhotbarHint",scope:"client",config:!1,default:!1,type:Boolean,onChange:e=>{e?ie.unregisterTokenHotbar():ie.registerTokenHotbar()}}),game.settings.register("dsa5","disableTokenhotbarMaster",{name:"DSASETTINGS.disableTokenhotbarMaster",hint:"DSASETTINGS.disableTokenhotbarMasterHint",scope:"client",config:!1,default:!1,type:Boolean,onChange:()=>{game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.render(!0)}}),game.settings.register("dsa5","scrollingFontsize",{name:"DSASETTINGS.scrollingFontsize",hint:"DSASETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsa5","tokenhotbaropacity",{name:"DSASETTINGS.tokenhotbaropacity",hint:"DSASETTINGS.tokenhotbaropacityHint",scope:"client",config:!1,default:.75,type:Number,range:{min:0,max:1,step:.05}}),game.settings.register("dsa5","armorAndWeaponDamage",{name:"DSASETTINGS.armorAndWeaponDamage",hint:"DSASETTINGS.armorAndWeaponDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideRegenerationToOwner",{name:"DSASETTINGS.hideRegenerationToOwner",hint:"DSASETTINGS.hideRegenerationToOwnerHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","indexDescription",{name:"DSASETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","encumbranceForRange",{name:"DSASETTINGS.encumbranceForRange",hint:"DSASETTINGS.encumbranceForRangeHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","obfuscateTokenNames",{name:"DSASETTINGS.obfuscateTokenNames",hint:"DSASETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("DSASETTINGS.yesNumbered"),2:game.i18n.localize("DSASETTINGS.renameNumbered"),3:game.i18n.localize("yes"),4:game.i18n.localize("DSASETTINGS.rename")}}),game.settings.register("dsa5","merchantNotification",{name:"DSASETTINGS.merchantNotification",hint:"DSASETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("yes"),2:game.i18n.localize("MERCHANT.onlyGM")}}),game.settings.register("dsa5","sightOptions",{name:"sightOptions",scope:"world",config:!1,default:"0.5|0.7|0.85|0.95",type:String}),game.settings.register("dsa5","trackedActors",{name:"sightOptions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","enableMasterTokenFunctions",{name:"enableMasterTokenFunctions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","selectedActors",{name:"selectedActors",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object})}u($i,"setupConfiguration");var nn=u(l=>{let e=Array.from(game.settings.settings);l.find('[name="exportOnlyDSA"]').is(":checked")&&(e=e.filter(n=>/^dsa5\./.test(n[0])));let a={},s=/(^dsa5\.(selectedActors|trackedActors|groupschips|tokenhotbarPosition|iniTrackerPosition|migrationVersion)$|^dsa5\.breadcrumbs_)/;for(let n of e){if(s.test(n[0]))continue;let r=n[0].split("."),o=r.shift(),c=r.join(".");a[n[0]]=game.settings.get(o,c)}let i="fvtt-DSA5-Configuration.json";saveDataToFile(JSON.stringify(a,null,2),"text/json",i)},"exportSetting"),rn=u(async l=>{let e=l.find("form")[0];if(!e.data.files.length)return ui.notifications?.error("You did not upload a data file!");readTextFromFile(e.data.files[0]).then(async t=>{let a=JSON.parse(t),s=Array.from(game.settings.settings).map(i=>i[0]);for(let i of Object.keys(a))if(s.includes(i)){let n=i.split("."),r=n.shift(),o=n.join(".");await game.settings.set(r,o,a[i])}game.settings.sheet.render(!0)})},"importSettings"),Ls=class extends FormApplication{render(){Ft()}};u(Ls,"ChangelogForm");var Rs=class extends FormApplication{async render(){let e=await renderTemplate("systems/dsa5/templates/dialog/exportConfiguration-dialog.html",{});new Dialog({title:"Export configuration",content:e,default:"yes",buttons:{export:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Export"),callback:t=>nn(t)},import:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Import"),callback:t=>rn(t)}}}).render(!0)}};u(Rs,"ExportForm");var _s=class extends FormApplication{get template(){return"systems/dsa5/templates/dialog/configureTokenhotbar.html"}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{title:game.i18n.localize("DSASETTINGS.configureTokenbar")}),e}activateListeners(e){super.activateListeners(e),e.find(".resetTokenhotbar").click(t=>this.resetTokenHotbar(t)),e.find("select, input").change(async t=>{let a=t.currentTarget.name.split("."),s=t.currentTarget.dataset.dtype=="Number"?Number(t.currentTarget.value):t.currentTarget.value;t.currentTarget.type=="checkbox"&&(s=t.currentTarget.checked),await game.settings.set(a[0],a[1],s),game.dsa5.apps.tokenHotbar?.render(!0),this.render()}),e.find(".bags .slot").click(t=>this._onMasterFunctionClicked(t))}async _onMasterFunctionClicked(e){let t=e.currentTarget.dataset.id,a=game.settings.get("dsa5","enableMasterTokenFunctions");a[t]=!a[t],await game.settings.set("dsa5","enableMasterTokenFunctions",a),$(e.currentTarget).toggleClass("deactivated",a[t]),game.dsa5.apps.tokenHotbar.gmItems.find(s=>s.id==t).disabled=a[t],game.dsa5.apps.tokenHotbar?.render(!0)}async getData(e){let t=await super.getData(e);return mergeObject(t,{tokenhotbarSize:game.settings.get("dsa5","tokenhotbarSize"),tokenhotbarLayout:game.settings.get("dsa5","tokenhotbarLayout"),disableTokenhotbarMaster:game.settings.get("dsa5","disableTokenhotbarMaster"),disableTokenhotbar:game.settings.get("dsa5","disableTokenhotbar"),tokenhotbaropacity:game.settings.get("dsa5","tokenhotbaropacity"),isGM:game.user.isGM,gmButtons:game.dsa5.apps.tokenHotbar?.gmItems}),t}async resetTokenHotbar(e){e.preventDefault(),e.stopPropagation(),await game.settings.set("dsa5","tokenhotbarPosition",{}),await game.settings.set("dsa5","tokenhotbarLayout",0),await game.settings.set("dsa5","tokenhotbarSize",35),game.dsa5.apps.tokenHotbar?.resetPosition(),game.dsa5.apps.tokenHotbar?.render(!0)}};u(_s,"ConfigureTokenHotbar");function li(){Hooks.on("renderJournalSheet",(l,e,t)=>{e.find(".close").attr("data-tooltip","SHEET.Close"),e.find(".entry-image").attr("data-tooltip","SHEET.imageView"),e.find(".entry-text").attr("data-tooltip","SHEET.textView"),e.find(".share-image").attr("data-tooltip","SHEET.showToPlayers"),e.find(".import").attr("data-tooltip","SHEET.import"),e.find(".panMapNote").attr("data-tooltip","SHEET.panMapNote"),e.find(".increaseFontSize").attr("data-tooltip","SHEET.increaseFontSize")}),Hooks.on("renderJournalPageSheet",(l,e,t)=>{te.bindRollCommands(e),E.bindButtons(e),e.find("img").mousedown(a=>{a.button==2&&game.dsa5.apps.DSA5_Utility.showArtwork({name:l.name,uuid:"",img:$(a.currentTarget).attr("src")})}),lt(e)}),Hooks.on("getJournalSheetHeaderButtons",(l,e)=>{e.unshift({class:"increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>ci($(l._element).find(".journal-page-content"))}),!(!l.document.sceneNote&&!l.document.pages.some(t=>t.sceneNote))&&e.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:async()=>{let t=l._getCurrentPage(),a=Array.from(l.document.pages),s;if(a[t].sceneNote)s=a[t];else if(l.document.sceneNote)s=l.document;else if(s=a.find(i=>i.sceneNote),!s)return;canvas.notes.panToNote(s.sceneNote)}})})}u(li,"default");async function ci(l){let t=game.settings.get("dsa5","journalFontSizeIndex")+1;t==b.journalFontSizes.length+1?(t=0,await game.settings.set("dsa5","journalFontSizeIndex",t),l.css("fontSize",""),pe(game.i18n.format("CHATNOTIFICATION.fontsize",{size:"Default "}))):(await game.settings.set("dsa5","journalFontSizeIndex",t),on(l))}u(ci,"increaseFontSize");function on(l){let e=game.settings.get("dsa5","journalFontSizeIndex"),t=b.journalFontSizes[e-1]||14;pe(game.i18n.format("CHATNOTIFICATION.fontsize",{size:t})),l.css("fontSize",`${t}px`)}u(on,"setOuterFontSize");function cn(l,e,t){if(e.system.isPriest&&e.system.isMage){let s=`<div class="attribute bar3"><input type="text" name="system.status.karmaenergy.value" value="${e.system.status.karmaenergy.value}"></div>`;l.find(".col.middle").prepend(s),l.find(".bar3 input").change(async i=>{let n=i.currentTarget,r=n.value.trim(),o=r.startsWith("+")||r.startsWith("-");r.startsWith("=")&&(r=r.slice(1));let c=Number(r),m=n.name.split(".").reduce((d,p)=>d[p],e);await e.update({[n.name]:o?m+c:c}),t.clear()})}}u(cn,"addThirdBarToHUD");function dn(l,e,t){if(!game.user.isGM)return;let a=l.object.actor;if(!!a.isToken){if(canvas.tokens.controlled.length>=2){let s=a._id;if(!canvas.tokens.controlled.every(n=>n.actor?._id==s))return;e.find(".col.left").prepend(Oi("swarm.combine"));let i=e.find('.control-icon[data-action="swarm"]');i.click(()=>{un(a,l.object.document),i.remove()})}else if(a.isSwarm()){e.find(".col.left").prepend(Oi("swarm.split"));let s=e.find('.control-icon[data-action="swarm"]');s.click(()=>{mn(a,l.object.document),s.remove()})}}}u(dn,"swarmButtons");var Fs=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};u(Fs,"SwarmDialog");function Oi(l){return`<div class="control-icon" data-action="swarm"><i class="fas fa-locust" data-tooltip="${l}" width="36" height="36"></div>`}u(Oi,"swarmHud");async function mn(l,e){let t=Number(l.system.swarm.count)-1,a=await renderTemplate("systems/dsa5/templates/dialog/swarm-split-dialog.html",{actor:l,maxSplitsize:t});new Fs({title:game.i18n.localize("swarm.split"),content:a,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async s=>{let i=Number(s.find('input[type="range"]').val()),n=deepClone(e),r=Math.floor(l.system.status.wounds.value/l.system.swarm.count*i),o=l.system.status.wounds.value-r;await l.update({"system.swarm.count":l.system.swarm.count-i,"system.status.wounds.value":o},{skipSwarmUpdate:!0}),await canvas.scene.createEmbeddedDocuments("Token",[n]),await n.actor.update({"system.swarm.count":i,"system.status.wounds.value":r},{skipSwarmUpdate:!0});let c=["x","y"][Math.floor(Math.random()*2)],m=Math.random()>.5?1:-1;await canvas.scene.updateEmbeddedDocuments("Token",[{_id:n.id,[c]:e[c]+canvas.scene.grid.size*m}])}},delete:{icon:'<i class="fas fa-trash"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}u(mn,"splitSwarm");async function un(l,e){let t=0,a=0;for(let i of canvas.tokens.controlled)t+=Number(i.actor.system.swarm?.count)||1,a+=Number(i.actor.system.status.wounds.value);await e.actor.update({"system.swarm.count":t,"system.status.wounds.value":a},{skipSwarmUpdate:!0});let s=canvas.tokens.controlled.map(i=>i.id).filter(i=>i!=e.id);await canvas.scene.updateEmbeddedDocuments("Token",s.map(i=>({_id:i,x:e.x,y:e.y}))),await canvas.scene.deleteEmbeddedDocuments("Token",s)}u(un,"combineSwarm");function di(){Hooks.on("renderTokenHUD",(l,e,t)=>{et.hide(l.object);let a=l.object.actor;a&&(cn(e,a,l),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.lightHud(e,a,t),dn(l,e,t)),e.find('.control-icon[data-action="target"]').mousedown(s=>{s.button==2&&(game.user.updateTokenTargets([]),$(s.currentTarget).click(),s.preventDefault())}),e.find(".attribute input").off("change"),j.renderTokenHUD(l,e,t)})}u(di,"default");function mi(){Hooks.on("preCreateScene",function(l,e,t,a){e.grid?.units||l.updateSource({grid:{units:game.i18n.localize("gridUnits")}}),!t.dsaInit&&e.notes?.some(s=>getProperty(s,"flags.dsa5.initName"))&&ui.notifications.warn(game.i18n.localize("DSAError.mapsViaJournalbrowser"))}),Hooks.on("preCreateActiveEffect",function(l,e,t,a){if(l.parent.documentName!="Actor")return;let s={duration:{startTime:game.time.worldTime}};if(!game.combat){l.updateSource(s);return}s.duration.combat=game.combat.id,s.duration.startRound=game.combat.round,s.duration.startTurn=game.combat.turn,!l.duration.rounds&&l.duration.seconds&&(s.duration.rounds=l.duration.seconds/5),l.updateSource(s)})}u(mi,"default");function pi(){game.keybindings.register("dsa5","masterMenu",{name:"gmMenu",hint:game.i18n.localize("KEYBINDINGS.masterMenu"),editable:[{key:"KeyM"}],onDown:()=>f.renderToggle(game.dsa5.apps.gameMasterMenu),restricted:!0}),game.keybindings.register("dsa5","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:()=>f.renderToggle(game.dsa5.apps.journalBrowser)}),game.keybindings.register("dsa5","library",{name:"ItemLibrary",hint:game.i18n.localize("KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:()=>f.renderToggle(game.dsa5.itemLibrary)}),game.keybindings.register("dsa5","attacktest",{name:"attacktest",hint:game.i18n.localize("KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:()=>ve.runActAttackDialog()}),game.keybindings.register("dsa5","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:()=>xi("nextTurn")}),game.keybindings.register("dsa5","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:()=>xi("previousTurn")}),game.keybindings.register("dsa5","setTargetToUser",{name:"DIALOG.setTargetToUser",hint:game.i18n.localize("DIALOG.setTargetToUserHint"),editable:[],onDown:async()=>(await Se.getDialog()).render(!0),restricted:!0})}u(pi,"default");var xi=u(l=>{game.combat?.combatant?.isOwner&&game.combat[l]()},"combatTurn");function gi(){Roll.prototype.editRollAtIndex=function(l){let e=[];for(let t of l){let{index:a,val:s}=t,i=0;for(let n of this.terms){let r=n instanceof DiceTerm||n.class=="DiceTerm"||n instanceof Die||n.class=="Die",o=n instanceof OperatorTerm;if(r||n.faces){if(n.results[a-i]){let c=n.results[a-i].result;n.results[a-i].result=s,e.push(c)}r||(n.total=n.results.reduce((c,m)=>c+m.result,0)),i+=n.results.length}else!o&&(n.class=="OperatorTerm"||n.operator)&&(n.total=n.operator)}e.push(0)}return this._total=this._evaluateTotal(),e}}u(gi,"default");var Dt=class extends Application{constructor(e){super(e),this.adventures=[],this.books=[],this.rshs=[],this.fulltextsearch=!0}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","noscrollWizard","bookWizardsheet"]),width:800,height:880,template:"systems/dsa5/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}static initHook(){Dt.wizard=new Dt,game.dsa5.apps.journalBrowser=Dt.wizard,Hooks.on("renderJournalDirectory",(e,t)=>{let a=$('<div class="header-actions action-buttons flexrow"></div>'),s=$(`<button id="openJournalBrowser"><i class="fa fa-book"></i>${game.i18n.localize("Book.Wizard")}</button>`);s.on("click",()=>{Dt.wizard.render(!0)}),a.append(s),t.find(".header-actions:first-child").after(a)})}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>ci($(this._element).find(".chapter"))}),e.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:async t=>this._showBooks()}),e}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".library").attr("data-tooltip","Book.home"),$(this._element).find(".increaseFontSize").attr("data-tooltip","SHEET.increaseFontSize")}_showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!0,this.currentType=void 0,this.selectedSubChapter=void 0,this.loadPage(this._element)}async toggleBookVisibility(e,t,a){let s=game.settings.get("dsa5","expansionPermissions");s[e]=a,await game.settings.set("dsa5","expansionPermissions",s);let i=this[t].find(o=>o.id==e),n=await(await fetch(i.path)).json(),r=["actors","journal","scenes"];for(let o of r){if(!n[o])continue;let c=game.packs.get(n[o]),m=a?"OBSERVER":"NONE",d={ownership:{PLAYER:m,TRUSTED:m}};await c.configure(d)}this.render()}activateListeners(e){super.activateListeners(e),e.on("click",".toggleVisibility",async t=>{let a=t.currentTarget.dataset.itemid,s=t.currentTarget.dataset.type,i=$(t.currentTarget).find("i").hasClass("fa-toggle-off");this.toggleBookVisibility(a,s,i)}),e.on("click",".showMapNote",t=>{game.journal.get(t.currentTarget.dataset.entryid).panToNote()}),e.on("search keyup",".filterJournals",t=>{this.filterToc($(t.currentTarget).val())}),e.on("click",".show-item",async t=>{let a=t.currentTarget.dataset.uuid;(await fromUuid(a)).sheet.render(!0)}),e.on("click",".movePage",async t=>this.movePage(t)),e.on("click",".loadBook",t=>{this.selectedChapter=void 0,this.selectedType=void 0,this.content=void 0,this.loadBook($(t.currentTarget).text(),e,t.currentTarget.dataset.type)}),e.on("click",".getChapter",t=>{this.selectedType=$(t.currentTarget).closest(".toc").attr("data-type"),this.selectedChapter=t.currentTarget.dataset.id,this.content=void 0,this.loadPage(e)}),e.on("click",".subChapter",t=>{let a=$(t.currentTarget).text(),s=t.currentTarget.dataset.jid;s?this.loadJournalById(s):($(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-id="${a}"]`).addClass("selected"),this.loadJournal(a))}),te.bindRollCommands(e),e.find(".tocCollapser").click(t=>{$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")}),e.on("mousedown",".openPin",async t=>{let a=t.currentTarget.dataset.uuid;t.button==0?this.showJournal(await fromUuid(a)):t.button==2&&this.unpinJournal(a)}),e.on("click",".showJournal",t=>{this.popJournal($(t.currentTarget).closest("h1").attr("data-uuid"))}),e.on("click",".pinJournal",t=>{let a=$(t.currentTarget).closest("h1"),s=a.attr("data-uuid"),i=a.text();this.pinJournal(s,i)}),e.on("click",".activateScene",t=>{this.showSzene(t.currentTarget.dataset.id,t.currentTarget.dataset.mode)}),e.on("click",".fulltextsearch",t=>{this.fulltextsearch=!this.fulltextsearch,$(t.currentTarget).toggleClass("on"),this.filterToc(e.find(".filterJournals").val())}),e.on("mousedown",".chapter img",t=>{let a=this.book.id;t.button==2&&game.dsa5.apps.DSA5_Utility.showArtwork({name:a,uuid:"",img:$(t.currentTarget).attr("src")})}),E.bindButtons(e),e.on("click",".importBook",async()=>this.importBook()),lt(e),aa(e,".breadcrumbs",this.resaveBreadCrumbs)}async getPagy(e,t){let a=this.journals.filter(i=>i.flags.dsa5.parent==e).sort((i,n)=>i.flags.dsa5.sort>n.flags.dsa5.sort?1:-1),s=a.findIndex(i=>i._id==t);return{journals:a,targetindex:s}}async movePage(e){let t=e.currentTarget.dataset.action,{journals:a,targetindex:s}=await this.getPagy(this.selectedChapter,this.selectedSubChapter),i=[];for(let c of this.bookData.chapters)for(let m of c.content)i.push(m.name);let n=i.findIndex(c=>c==this.selectedChapter);if(this.bookData.chapters.findIndex(c=>c.name==this.selectedChapter),t=="next"?s++:s--,s<0){if(this.selectedChapter=i[n-1],!this.selectedChapter)return;a=(await this.getPagy(this.selectedChapter,void 0)).journals,s=0}else if(s>=a.length){if(this.selectedChapter=i[n+1],!this.selectedChapter)return;a=(await this.getPagy(this.selectedChapter,void 0)).journals,s=0}if(["prep","foundryUsage"].includes(this.selectedChapter))return;let r=a[s],o=await this.getToc();this._element.find(".toc").html(o),r&&await this.loadJournalById(r.id)}async loadJournal(e){await this.showJournal(this.journals.find(t=>t.name==e&&t.flags.dsa5.parent==this.selectedChapter))}async loadJournalById(e){await this.showJournal(this.journals.find(t=>t.id==e))}async resaveBreadCrumbs(e){let t={};for(let a of e.getElementsByTagName("div"))t[a.dataset.uuid]=a.innerText;await game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(t))}async filterToc(e){if(e!=null){e=e.toLowerCase().trim();let t;if(e!=""){let a=[];this.fulltextsearch?(this.journalIndex||(this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),await this.journalIndex.add(this.journals.map(s=>new js(s)))),a=await this.journalIndex.search(e)):a=this.journals.filter(s=>s.name.toLowerCase().trim().indexOf(e)!=-1),a=a.map(s=>`<li class="fas fa-caret-right"><a data-jid="${s.id}" class="subChapter">${s.name}</a></li>`),$(this._element).find(".tocContent").html(`<ul>${a.join(`
`)}</ul>`)}else t=await this.getToc(),$(this._element).find(".adventureWizard > .row-section > .toc").html(t).find(".filterJournals").focus()}}async showJournal(e){let t="";for(let n of e.pages){let r=e.sheet.getPageSheet(n.id),o=await r.getData(),c=(await r._renderInner(o)).get(),m=$(c[c.length-1]).html();n.type=="video"&&(m=`<div class="video-container">${m}</div>`),e.name!=n.name&&(m=`<h2>${n.name}</h2>${m}`),t+=m}let a=this.findSceneNote(e.getFlag("dsa5","initId")),s=await TextEditor.enrichHTML(t,{secrets:game.user.isGM,async:!0});this.content=`<div><h1 class="journalHeader" data-uuid="${e.uuid}">${e.name}<div class="jrnIcons">${a}<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>${s}`;let i=$(this._element).find(".chapter");i.html(this.content),this.selectedSubChapter=e.id,$(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-jid="${e.id}"]`).addClass("selected"),lt(i),i.find(".documentName-link, .entity-link, .content-link").on("click",n=>{let r=n.currentTarget.dataset;this.bookData&&r.pack==this.bookData.journal&&r.type!="JournalEntryPage"&&(n.stopPropagation(),this.loadJournalById(r.id))})}findSceneNote(e){if(e){let t=game.journal.find(a=>a.getFlag("dsa5","initId")==e);if(t&&t.sceneNote)return`<a class="showMapNote" data-entryId="${t.id}"><i class="fas fa-map-pin"></i></a>`}return""}async importBook(){game.user.isGM&&new Hs().render(this.bookData.moduleName)}async loadBook(e,t,a){a||(a=this.currentType),this.currentType=a,this.book=this[a].find(s=>s.id==e),await fetch(this.book.path).then(async s=>s.json()).then(async s=>{this.bookData=s;let i=game.packs.get(s.journal);await i.getIndex();let n=await i.getDocuments();this.journals=n,s.actors&&(i=game.packs.get(s.actors),n=await i.getIndex(),this.actors=n),s.scenes&&(i=game.packs.get(s.scenes),n=await i.getIndex(),this.scenes=n),this.checkChapters(i),this.loadPage(t)})}checkChapters(e){this.bookData.chapters||(this.bookData.isDynamic=!0,this.bookData.chapters=[{name:game.i18n.localize(`${this.bookData.moduleName}.name`),content:e.folders.map(t=>({name:t.name,id:t.id}))}])}async prefillActors(e){if(!e.actors)return[];let t=[],a=await game.folders.contents.find(i=>i.name==game.i18n.localize(`${this.bookData.moduleName}.name`)&&i.type=="Actor"&&i.folder==null),s=a?await game.folders.contents.filter(i=>i.type=="Actor"&&i.folder?.id==a.id).map(i=>i.id):void 0;for(let i of e.actors){let n=s?.length?game.actors.contents.find(m=>m.name==i&&s.includes(m.folder?.id)):void 0,r,o=n?.id,c=n?.uuid;n||(n=this.actors.find(m=>m.name==i),r=this.bookData.actors,o=n?._id,c=n?`Compendium.${r}.${o}`:void 0),t.push({name:i,actor:n,pack:r,id:o,uuid:c})}return t}async popJournal(e){(await fromUuid(e)).sheet.render(!0)}async showSzene(e,t="activate"){let a=game.scenes.contents.find(s=>s.name==e);if(!a)return ui.notifications.error(game.i18n.localize("DSAError.sceneNotInitialized"));switch(t){case"activate":a.activate();break;case"view":a.view();break;case"toggle":a.update({navigation:!a.navigation});break}}async getChapter(){if(this.book){if(this.content)return this.content;if(this.selectedChapter){if(this.selectedChapter=="prep"){let a={initDescr:game.i18n.format(`${this.bookData.moduleName}.importContent`,{defaultText:game.i18n.localize("importDefault")})},s=this.bookData.modules;for(let i of s)i.enabled=this.moduleEnabled(i.id);return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_preparation.html",{modules:s,info:a})}else if(this.selectedChapter=="foundryUsage")return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_foundry.html");let e=this.bookData.chapters.find(a=>a.name==this.selectedType).content.find(a=>a.id==this.selectedChapter),t=this.getSubChapters();return e.scenes||e.actors||t.length==0?await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_chapter.html",{chapter:e,subChapters:this.getSubChapters(),actors:await this.prefillActors(e)}):(this.selectedSubChapter=t[0].id,await this.loadJournalById(t[0].id))}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData})}else return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM})}filterBooks(e){let t=game.settings.get("dsa5","expansionPermissions");for(let a of e)t[a.id]!=null&&(a.visible=t[a.id]);return game.user.isGM?e:e.filter(a=>a.visible==null||a.visible).sort((a,s)=>a.id.localeCompare(s.id))}getSubChapters(){let e;return this.bookData.isDynamic?e=this.journals.filter(t=>t.folder.id==this.selectedChapter).sort((t,a)=>t.sort>a.sort?1:-1):e=this.journals.filter(t=>t.flags.dsa5.parent==this.selectedChapter).sort((t,a)=>t.flags.dsa5.sort>a.flags.dsa5.sort?1:-1),e.map(t=>({name:t.name,id:t.id,cssClass:t.id==this.selectedSubChapter?"selected":""}))}async getToc(){let e=[];if(this.book){if(e.push(...duplicate(this.bookData.chapters)),this.selectedChapter){let t;for(let a of e)if(t=a.content.find(s=>s.id==this.selectedChapter),t)break;t&&(t.cssClass="selected",t.subChapters=this.getSubChapters())}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_toc.html",{chapters:e,book:this.book,fulltextsearch:this.fulltextsearch?"on":""})}else return'<div class="libraryImg"></div>'}async loadPage(e){let t=await this.getChapter(),a=await this.getToc();e.find(".toc").html(a),e.find(".chapter").html(t)}async getData(e){let t=await super.getData(e),a=await this.getChapter(),s=await this.getToc(),i=game.settings.get("dsa5","journalFontSizeIndex"),n=b.journalFontSizes[i-1]||14;return mergeObject(t,{adventure:this.bookData,currentChapter:a,breadcrumbs:this.renderBreadcrumbs(),toc:s,fontSize:n}),t}async pinJournal(e,t=void 0){let a=this.readBreadCrumbs();t||(t=(await fromUuid(e))?.name||""),a[e]=t,game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(a)),this.render(!0)}unpinJournal(e){let t=this.readBreadCrumbs();delete t[e],game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(t)),this.render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch{return!1}t.type=="JournalEntry"&&this.pinJournal(t.pack?`Compendium.${t.pack}.${t.id}`:`JournalEntry.${t.id}`)}readBreadCrumbs(){let e={};try{e=JSON.parse(game.settings.get("dsa5",`breadcrumbs_${game.world.id}`))}catch{console.log("No Journalbrowser notes found")}return e}renderBreadcrumbs(){let e=this.readBreadCrumbs(),t=Object.entries(e).map(a=>`<div data-tooltip="${a[1]}" data-uuid="${a[0]}" class="openPin item">${a[1]}</div>`);return t.length>0?`<div id="breadcrumbs" class="breadcrumbs wrap row-section">${t.join("")}</div>`:""}moduleEnabled(e){return game.modules.get(e)?game.modules.get(e).active?"fa-check":"fa-dash":"fa-times"}},mt=Dt;u(mt,"BookWizard"),F(mt,"wizard");var Hs=class extends FormApplication{render(e){new game.dsa5.apps.DSA5Initializer("DSA5 Module Initialization",game.i18n.format(`${e}.importContent`,{defaultText:game.i18n.localize("importDefault")}),e,game.i18n.lang).render(!0)}};u(Hs,"InitializerForm");var js=class{constructor(e){let t=e.pages.find(a=>!0).text.content;this.document={name:e.name,data:$("<div>").html(t).text(),id:e.id}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}};u(js,"JournalSearch");var Mt=class{static registerButtons(){game.dsa5.apps.playerMenu=new ze,CONFIG.Canvas.layers.dsamenu={layerClass:Gs,group:"interface"},Hooks.on("getSceneControlButtons",e=>{let t=[{name:"JournalBrowser",title:game.i18n.localize("Book.Wizard"),icon:"fa fa-book",button:!0,onClick:()=>{f.renderToggle(game.dsa5.apps.journalBrowser)}},{name:"Library",title:game.i18n.localize("SHEET.Library"),icon:"fas fa-university",button:!0,onClick:()=>{f.renderToggle(game.dsa5.itemLibrary)}},{name:"PlayerMenu",title:game.i18n.localize("PLAYER.title"),icon:"fas fa-dsa5-player",button:!0,onClick:()=>{f.renderToggle(game.dsa5.apps.playerMenu)}}];game.user.isGM&&(game.dsa5.apps.gameMasterMenu||(game.dsa5.apps.gameMasterMenu=new Bs),t.push({name:"mastersMenu",title:game.i18n.localize("gmMenu"),icon:"fa fa-dsa5",button:!0,onClick:()=>{f.renderToggle(game.dsa5.apps.gameMasterMenu)}})),e.push({name:"GM Menu",title:game.i18n.localize("gmMenu"),icon:"fas fa-dsa5",layer:"dsamenu",tools:t})})}};u(Mt,"MastersMenu");var Gs=class extends InteractionLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"dsamenu",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}selectObjects(e){canvas.tokens.selectObjects(e)}};u(Gs,"DSAMenuLayer");var Bs=class extends Application{constructor(e){super(e),this.heros=[],this.lastSkill=`${game.i18n.localize("LocalizedIDs.perception")}|skill`,this.randomCreation=[],game.user.isGM&&(Hooks.on("updateActor",async(t,a,s,i)=>{if(!this.rendered)return;let n=["system.status.fatePoints","system.status.wounds","system.status.karmaenergy","system.status.astralenergy"];this.heros.some(r=>r.id==t.id)&&n.reduce((r,o)=>r||hasProperty(a,o),!1)&&this.render()}),Hooks.on("updateScene",async(t,a,s,i)=>{let n=["darkness"];if(game.canvas.id==t.id&&n.reduce((r,o)=>r||hasProperty(a,o),!1)){if(game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.onDarknessChange(),!this.rendered)return;this.render()}}),Hooks.on("canvasInit",()=>{!this.rendered||this.render()}))}async _render(e=!1,t={}){if(!game.user.isGM)return ui.notifications.error("DSAError.onlyGMallowed");await super._render(e,t)}getSelectedActors(){let e=game.settings.get("dsa5","selectedActors"),t=game.settings.get("dsa5","trackedActors"),a={};for(let s of Object.keys(e))t.actors?.includes(s)&&(a[s]=e[s]);return a}activateListeners(e){super.activateListeners(e),e.find("select.select2").select2(),ne(e),e.find(".heroLink").click(a=>{a.stopPropagation(),game.actors.get(this.getID(a)).sheet.render(!0)}),e.find(".addGlobalMod").click(()=>this.addGlobalMod()),e.find(".globalModEnable").change(a=>this.toggleGlobalMod(a)),e.find(".removeGlobalMod").click(a=>this.removeGlobalMod(a)),e.find(".editGlobalMod").click(a=>this.editGlobalMod(a)),e.find(".heroSelector").change(a=>{a.stopPropagation();let s=this.getSelectedActors();s[this.getID(a)]=$(a.currentTarget).is(":checked"),game.settings.set("dsa5","selectedActors",s)}),e.find(".skillSelektor").change(a=>{a.stopPropagation(),this.lastSkill=$(a.currentTarget).val()}),e.find(".rollChar").click(a=>{a.stopPropagation(),this.rollAbility([this.getID(a)])}),e.find(".rollAll").click(a=>{a.stopPropagation(),this.rollAbility(this.selectedIDs())}),e.find(".pay").click(a=>{a.stopPropagation(),this.doPayment([this.getID(a)],!0)}),e.find(".actorItem").click(async a=>{a.stopPropagation();let s=a.currentTarget.dataset.uuid;(await fromUuid(s)).sheet.render(!0)}),e.find(".getPaid").click(a=>{a.stopPropagation(),this.doPayment([this.getID(a)],!1)}),e.find(".resetSightThresholds").click(()=>this.resetSightThresholds()),e.find(".payAll").click(a=>{a.stopPropagation(),this.doPayment(this.selectedIDs(a),!0)}),e.find(".getPaidAll").click(a=>{a.stopPropagation(),this.doPayment(this.selectedIDs(a),!1)}),e.find(".selectAll").change(a=>this._selectAll(a,e)),e.find(".exp").click(a=>{a.stopPropagation(),this.getExp([this.getID(a)])}),e.find(".expAll").click(a=>{a.stopPropagation(),this.getExp(this.selectedIDs())}),e.find(".randomPlayer").mousedown(a=>{a.stopPropagation(),this._randomPlayer(e,a)}),e.find(".requestRoll").click(a=>{a.stopPropagation(),this.rollRequest()}),e.find(".heroSelector").click(a=>a.stopPropagation()),e.find(".hero").click(a=>{a.stopPropagation(a),$(a.currentTarget).find(".expandDetails").fadeToggle()});let t=u(a=>this._deleteHero(a),"deletehand");e.find(".hero").mouseenter(a=>{if(a.currentTarget.getElementsByClassName("hovermenu").length==0){let s=document.createElement("div");s.classList.add("hovermenu");let i=document.createElement("i");i.classList.add("fas","fa-times"),i.title=game.i18n.localize("SHEET.DeleteItem"),i.addEventListener("click",t,!1),s.appendChild(i),a.currentTarget.appendChild(s)}}),e.find(".hero").mouseleave(a=>{let s=a.toElement||a.relatedTarget;!s||s.parentNode==this||s==this||a.currentTarget.querySelectorAll(".hovermenu").forEach(i=>i.remove())}),e.find(".addGroupSchip").click(async a=>{await this.changeGroupSchipCount(Number(a.currentTarget.dataset.value))}),e.find(".groupschip").click(a=>{this.changeGroupSchip(a)}),e.find(".addFolder").click(async a=>this.editFolder(a)),e.find(".editFolder").change(async a=>this._editFolder(a)),e.find(".heroschip").click(a=>{a.stopPropagation(),a.preventDefault();let s=Number(a.currentTarget.getAttribute("data-val"));s==1&&$(a.currentTarget).closest(".hero").find(".fullSchip").length==1&&(s=0),game.actors.get(this.getID(a)).update({"system.status.fatePoints.value":s})}),e.find(".groupCheck").click(a=>{a.stopPropagation(),this.doGroupCheck()}),e.find(".changeSetting").change(async a=>{await game.settings.set("dsa5",a.currentTarget.name,a.currentTarget.checked)}),e.find(".changeSightTreshold").change(async a=>{$(a.currentTarget).closest(".row-section").find(".range-value").text(a.currentTarget.value),this.updateSightThreshold(a)}),e.find(".updateDarkness").change(async a=>{$(a.currentTarget).closest(".row-section").find(".range-value").text(a.currentTarget.value),this.updateDarkness(a)});for(let a of this.randomCreation)a.activateListeners(e);aa(e,".heros",this.updateHeroOrder,".hero"),e.on("dragstart",".hero",a=>{a.stopPropagation();let s=a.currentTarget,i={type:"Actor",uuid:s.dataset.uuid};a.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(i))}),e.find(".dragEveryone").each(function(a,s){s.setAttribute("draggable",!0)}),e.on("dragstart",".dragEveryone",a=>this._dragEveryone(a)),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.activateButtonListener(e)}async _dragEveryone(e){e.stopPropagation();let t;e.currentTarget.dataset.folder?t=expandObject(game.settings.get("dsa5","masterSettings")).folders.find(i=>i.id==e.currentTarget.dataset.folder).content:t=this.selectedIDs();let a={type:"GroupDrop",ids:t};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(a))}async _selectAll(e,t){e.stopPropagation();let a=".heroSelector";e.currentTarget.dataset.folder&&(a=`[data-id="${e.currentTarget.dataset.folder}"] .heroSelector`);let s=t.find(a);s.prop("checked",$(e.currentTarget).is(":checked")),s.change()}async _deleteHero(e){e.stopPropagation(),e.preventDefault();let t=$(e.currentTarget).closest(".hero").attr("data-id"),a=game.settings.get("dsa5","trackedActors").actors||[],s=a.indexOf(t);s>-1&&(a.splice(s,1),await game.settings.set("dsa5","trackedActors",{actors:a}),this.render(!0))}async updateHeroOrder(e){let t=[];for(let a of e.querySelectorAll(".hero"))t.push(a.dataset.id);await game.settings.set("dsa5","trackedActors",{actors:t})}async updateDarkness(e){canvas.scene&&canvas.scene.update({darkness:Number(e.currentTarget.value)},{animateDarkness:3e3})}async updateSightThreshold(e){let t=Number(e.currentTarget.dataset.index),a=Number(e.currentTarget.value),s=game.settings.get("dsa5","sightOptions").split("|");s[t]=a,await game.settings.set("dsa5","sightOptions",s.join("|"))}async resetSightThresholds(){await game.settings.set("dsa5","sightOptions",game.settings.settings.get("dsa5.sightOptions").default),this.render(!0)}getGroupSchipSetting(){return game.settings.get("dsa5","groupschips").split("/").map(e=>Number(e))}async changeGroupSchipCount(e){let t=this.getGroupSchipSetting();t[1]=Math.max(0,t[1]+e),t[0]=Math.min(t[1],t[0]),await game.settings.set("dsa5","groupschips",t.join("/"))}async changeGroupSchip(e){let t=Number(e.currentTarget.getAttribute("data-val"));t==1&&$(e.currentTarget).closest(".col").find(".fullSchip").length==1&&(t=0);let a=this.getGroupSchipSetting();a[0]=t,await game.settings.set("dsa5","groupschips",a.join("/"))}async _createFolder(){let e=expandObject(game.settings.get("dsa5","masterSettings"));e.folders||(e.folders=[]),e.folders.push({id:randomID(),name:game.i18n.localize("FOLDER.ExportNewFolder"),content:[]}),await game.settings.set("dsa5","masterSettings",e),await this.render(!0)}async _deleteFolder(e){let t=e.currentTarget.dataset.id,a=expandObject(game.settings.get("dsa5","masterSettings"));a.folders=a.folders.filter(s=>s.id!=t),await game.settings.set("dsa5","masterSettings",a),await this.render(!0)}async _editFolder(e){let t=e.currentTarget.dataset.id,a=expandObject(game.settings.get("dsa5","masterSettings"));a.folders.find(s=>s.id==t).name=e.currentTarget.value,await game.settings.set("dsa5","masterSettings",a)}async editFolder(e){switch(e.currentTarget.dataset.action){case"create":this._createFolder();break;case"delete":this._deleteFolder(e);break}}async addGlobalMod(){new Kt().render(!0)}async editGlobalMod(e){let t=e.currentTarget.dataset.key;new Kt(t).render(!0)}async toggleGlobalMod(e){let t=game.settings.get("dsa5","masterSettings");t.globalMods[e.currentTarget.dataset.key].enabled=e.currentTarget.checked,await game.settings.set("dsa5","masterSettings",t)}async removeGlobalMod(e){let t=game.settings.get("dsa5","masterSettings");delete t.globalMods[e.currentTarget.dataset.key],await game.settings.set("dsa5","masterSettings",t),this.render()}async _randomPlayer(e,t){let a=e.find(".hero"),s=await this.rollRandomPlayer(t.button==2);$(t.currentTarget).find("i").addClass("fa-spin"),a.removeClass("victim"),setTimeout(()=>{$(this._element).find(`.hero[data-id="${s}"]`).addClass("victim"),$(t.currentTarget).find("i").removeClass("fa-spin")},500)}async rollRandomPlayer(e){let t={},a=1,s=this.getSelectedActors(),i=Object.values(s).filter(o=>o).length!=0,n=this.heros.length?this.heros:await this.getTrackedHeros();for(let o of n)!s[o.id]&&i||(t[a]=o.id,a++,e&&x.hasVantage(o,game.i18n.localize("LocalizedIDs.misfortune"))&&(t[a]=o.id,a++),e&&o.hasCondition("badluck")&&(t[a]=o.id,a++));let r=(await new Roll(`1d${a-1}`).evaluate({async:!0})).total;return t[r]}async doPayment(e,t,a=0){let s=game.actors.filter(o=>e.includes(o.id)),i=this.getNames(s),n=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:a,text:game.i18n.localize(game.i18n.format(t?"MASTER.payText":"MASTER.getPaidText",{heros:i}))}),r=u(o=>{let c=o.find(".input-text").val();for(let m of s)G.handlePayAction(void 0,t,c,m)},"callback");this.buildDialog(game.i18n.localize(t?"MASTER.payTT":"PAYMENT.payButton"),n,r)}async getPaid(e){this.doPayment(e,!1)}async getExp(e,t=0){let a=game.actors.filter(n=>e.includes(n.id)),s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:t,text:game.i18n.localize(game.i18n.format("MASTER.awardXPText",{heros:this.getNames(a)}))}),i=u(async n=>{let r=Number(n.find(".input-text").val()),o=Math.max(1,Math.round(r*.25)),c=[],m=[];if(!isNaN(r)){for(let d of a){let p=r;d.system.isFamiliar||d.system.isPet?(p=o,m.push(d)):c.push(d),await d.update({"system.details.experience.total":d.system.details.experience.total+p})}c.length>0&&await ChatMessage.create(f.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:this.getNames(c),number:r}))),m.length>0&&await ChatMessage.create(f.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:this.getNames(m),number:r}))),this.rendered&&this.render(!0)}},"callback");this.buildDialog(game.i18n.localize("MASTER.awardXP"),s,i)}getNames(e){return e.map(t=>t.name).join(", ")}buildDialog(e,t,a){new ae({title:e,content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:s=>{a(s)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain")),t=await Actor.implementation.fromDropData(t)}catch{return!1}if(t.documentName=="Actor"){let a=game.settings.get("dsa5","trackedActors");a=a.actors||[],a.indexOf(t.id)==-1&&!t.pack&&(a.push(t.id),await game.settings.set("dsa5","trackedActors",{actors:a}),this.render(!0));let s=$(e.target).closest(".isFolder"),i=expandObject(game.settings.get("dsa5","masterSettings"));s.length?i.folders=i.folders.map(n=>(n.content=n.content.filter(r=>r!=t.id),n.id==s[0].dataset.id&&n.content.push(t.id),n)):i.folders=i.folders.map(n=>(n.content=n.content.filter(r=>r!=t.id),n)),await game.settings.set("dsa5","masterSettings",i),this.render(!0)}}selectedIDs(){let e=[],t=this.getSelectedActors();for(let[a,s]of Object.entries(t))s&&e.push(a);return e.length?e:game.settings.get("dsa5","trackedActors").actors||[]}async doGroupCheck(e=0){let[t,a]=this.lastSkill.split("|");if(a!="skill")return;let s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:e,text:game.i18n.localize(game.i18n.format("MASTER.doGroupCheck",{skill:t}))}),i=u(n=>{let r=Number(n.find(".input-text").val()),[o,c]=this.lastSkill.split("|");c=="skill"&&B.showGCMessage(o,r)},"callback");this.buildDialog(game.i18n.localize("HELP.groupcheck"),s,i)}async rollRequest(e=0){let[t,a]=this.lastSkill.split("|");if(a!="skill")return;let s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:e,text:game.i18n.localize(game.i18n.format("MASTER.doRequestRoll",{skill:t}))}),i=u(n=>{let r=Number(n.find(".input-text").val()),[o,c]=this.lastSkill.split("|");c=="skill"&&B.showRQMessage(o,r)},"callback");this.buildDialog(game.i18n.localize("HELP.request"),s,i)}rollAbility(e){let[t,a]=this.lastSkill.split("|");switch(a){case"skill":this.rollSkill(e,t);break;case"attribute":this.rollAttribute(e,t);break;case"regeneration":this.rollRegeneration(e);break}}rollRegeneration(e){let t=game.actors.filter(a=>e.includes(a.id));for(let a of t)a.setupRegeneration("regenerate",{rollMode:"blindroll",subtitle:` (${a.name})`},void 0).then(s=>{a.basicTest(s)})}rollAttribute(e,t){let a=game.actors.filter(i=>e.includes(i.id)),s=Object.keys(game.dsa5.config.characteristics).find(i=>game.i18n.localize(game.dsa5.config.characteristics[i])==t);for(let i of a)i.setupCharacteristic(s,{rollMode:"blindroll",subtitle:` (${i.name})`},void 0).then(n=>{i.basicTest(n)})}rollSkill(e,t){let a=game.actors.filter(s=>e.includes(s.id));for(let s of a){let i=s.items.find(n=>n.name==t&&n.type=="skill");s.setupSkill(i,{rollMode:"blindroll",subtitle:` (${s.name})`},void 0).then(n=>{s.basicTest(n)})}}getID(e){return $(e.currentTarget).closest(".hero").attr("data-id")}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","masterMenu","sheet"]),width:470,height:740,title:game.i18n.localize("gmMenu"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/mastermenu.html",e.resizable=!0,e}async getTrackedHeros(){let e=game.settings.get("dsa5","trackedActors"),t=[];return e.actors&&e.actors.length>0?t=game.actors.filter(a=>e.actors.includes(a.id)).sort((a,s)=>e.actors.indexOf(a.id)-e.actors.indexOf(s.id)):(t=game.actors.filter(a=>a.hasPlayerOwner),await game.settings.set("dsa5","trackedActors",{actors:t.map(a=>a.id)})),t}async getData(e){let t=await super.getData(e),a=await this.getTrackedHeros(),s=_.getGroupSchips(),i=game.settings.get("dsa5","sightOptions").split("|"),n=/ \[[a-zA-Z\d-]+\]/,r=[1,2,3,4].map(p=>({label:game.i18n.localize(`VisionDisruption.step${p}`).replace(n,""),value:i[p-1]}));t.sceneConfig={sceneAutomationEnabled:game.settings.get("dsa5","sightAutomationEnabled"),enableDPS:game.settings.get("dsa5","enableDPS"),lightSightCompensationEnabled:game.settings.get("dsa5","lightSightCompensationEnabled"),visions:r,darkness:canvas.scene?.darkness||0},this.heros=a;let o=this.getSelectedActors(),c=expandObject(game.settings.get("dsa5","masterSettings")),m=[],d=(c.folders||[]).map(p=>(p.contents=[],p.content=new Set(p.content),p));for(let p of a){let g=duplicate(p),h=[],y=[],v=[];for(let T of g.items)switch(T.type){case"disadvantage":h.push({name:T.name,uuid:T.uuid});break;case"advantage":y.push({name:T.name,uuid:T.uuid});break;case"money":v.push(T);break}mergeObject(g,{id:p.id,uuid:p.uuid,selected:o[p.id],schips:p.schipshtml(),purse:v.sort((T,R)=>R.system.price.value-T.system.price.value).map(T=>`<span data-tooltip="${T.name}">${T.system.quantity.value}</span>`).join(" - "),advantages:y,disadvantages:h,system:{status:{wounds:{max:p.system.status.wounds.max},astralenergy:{max:p.system.status.astralenergy.max},karmaenergy:{max:p.system.status.karmaenergy.max}},isMage:p.system.isMage,isPriest:p.system.isPriest}});let P=!1;for(let T of d)if(T.content.has(p.id)){T.contents.push(g),P=!0;break}P||m.push(g)}if(!this.abilities){let p=await f.allSkillsList();this.abilities=p.map(g=>({name:g,type:"skill"})).concat(Object.values(game.dsa5.config.characteristics).map(g=>({name:game.i18n.localize(g),type:"attribute"})).concat({name:game.i18n.localize("regenerate"),type:"regeneration"})).sort((g,h)=>g.name.localeCompare(h.name))}return mergeObject(t,{hasHeros:a.length>0,heros:m,folders:d,abilities:this.abilities,groupschips:s,masterSettings:c,lastSkill:this.lastSkill,randomCreation:this.randomCreation.map(p=>p.template),lightButton:game.dsa5.apps.LightDialog?await game.dsa5.apps.LightDialog.getButtonHTML():""}),t}registerRandomCreation(e){this.randomCreation.push(e)}};u(Bs,"GameMasterMenu");var Kt=class extends FormApplication{constructor(e){super(),this.mod_id=e}static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsa5/templates/system/global-mod-addition.html",e.title=game.i18n.localize("MASTER.addGlobalMod"),e.width=400,e.resizable=!0,e}activateListeners(e){super.activateListeners(e),e.find(".addGlobalMod").click(t=>this.addGlobalMod(t))}async getData(e){let t=await super.getData(e);return this.mod_id?t.config=expandObject(game.settings.get("dsa5","masterSettings").globalMods[this.mod_id]):t.config={value:0,victim:{npc:!0,player:!0}},t.categories=["skill","spell","meleeweapon","rangeweapon","ritual","ceremony","liturgy","trait"],t}async addGlobalMod(e){e.preventDefault();let t=expandObject(game.settings.get("dsa5","masterSettings")),a=expandObject(new FormDataExtended($(this._element).find("form")[0]).object);a.enabled=!0,a.name&&(this.mod_id?t.globalMods[this.mod_id]=a:mergeObject(t,{globalMods:{[randomID()]:a}}),await game.settings.set("dsa5","masterSettings",t),game.dsa5.apps.gameMasterMenu.render(),this.close())}};u(Kt,"GlobalModAddition");var It=class extends tt(Ie){static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/creature-merchant-sheet.html"}};u(It,"CreatureMerchantSheetDSA5");var Et=class extends tt(he){static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/character-merchant-sheet.html"}};u(Et,"CharacterMerchantSheetDSA5");var $t=class extends JournalSheet{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","dsajournal"])}),e}};u($t,"DSAJournalSheet");function fi(){ei(),ti(),ai(),si(),ii(),ni(),Ci(),ri(),oi(),li(),di(),Ys(),mi(),gi()}u(fi,"default");Hooks.once("init",()=>{loadTemplates(["systems/dsa5/templates/actors/actor-main.html","systems/dsa5/templates/actors/actor-talents.html","systems/dsa5/templates/items/item-description.html","systems/dsa5/templates/dialog/default-dialog.html","systems/dsa5/templates/dialog/parts/targets.html","systems/dsa5/templates/dialog/enhanced-default-dialog.html","systems/dsa5/templates/dialog/default-combat-dialog.html","systems/dsa5/templates/chat/roll/test-card.html","systems/dsa5/templates/items/item-equipment.html","systems/dsa5/templates/items/item-enchantment.html","systems/dsa5/templates/actors/actor-combat.html","systems/dsa5/templates/actors/actor-equipment.html","systems/dsa5/templates/actors/actor-notes.html","systems/dsa5/templates/dialog/parts/spellmodifiers.html","systems/dsa5/templates/dialog/parts/canChangeCastingTime.html","systems/dsa5/templates/actors/parts/schipspart.html","systems/dsa5/templates/chat/post-item.html","systems/dsa5/templates/items/item-stat.html","systems/dsa5/templates/items/item-extension.html","systems/dsa5/templates/actors/creature/creature-main.html","systems/dsa5/templates/actors/creature/creature-loot.html","systems/dsa5/templates/actors/creature/creature-notes.html","systems/dsa5/templates/actors/creature/creature-magic.html","systems/dsa5/templates/system/masterHeros.html","systems/dsa5/templates/actors/creature/creature-religion.html","systems/dsa5/templates/actors/parts/characteristics-large.html","systems/dsa5/templates/actors/parts/gearSearch.html","systems/dsa5/templates/actors/parts/magicalSigns.html","systems/dsa5/templates/actors/parts/containerContent.html","systems/dsa5/templates/actors/npc/npc-main.html","systems/dsa5/templates/actors/character/actor-magic.html","systems/dsa5/templates/actors/character/actor-religion.html","systems/dsa5/templates/actors/character/actor-aggregatedtests.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-small.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-large.html","systems/dsa5/templates/actors/parts/status_effects.html","systems/dsa5/templates/actors/parts/purse.html","systems/dsa5/templates/actors/parts/horse.html","systems/dsa5/templates/actors/parts/healthbar.html","systems/dsa5/templates/actors/merchant/merchant-commerce.html","systems/dsa5/templates/items/item-header.html","systems/dsa5/templates/items/item-effects.html","systems/dsa5/templates/items/item-aoe.html","systems/dsa5/templates/items/traditionArtifact.html","systems/dsa5/templates/status/advanced_functions.html","systems/dsa5/templates/actors/parts/information.html","systems/dsa5/templates/actors/parts/personaltrait.html","systems/dsa5/templates/actors/parts/combatskills.html","systems/dsa5/templates/actors/parts/attributes.html","systems/dsa5/templates/actors/parts/swarm.html","systems/dsa5/templates/actors/parts/carryandpurse.html","systems/dsa5/templates/actors/parts/specialabilities.html","systems/dsa5/templates/actors/parts/experienceBox.html","systems/dsa5/templates/actors/parts/temperature.html","systems/dsa5/templates/actors/parts/temperatureSmall.html","systems/dsa5/templates/actors/parts/spells.html","systems/dsa5/templates/dialog/parts/expChoices.html","systems/dsa5/templates/actors/parts/liturgies.html","systems/dsa5/templates/items/browse/actor.html","systems/dsa5/templates/items/browse/garadan.html","systems/dsa5/templates/items/browse/culture.html","systems/dsa5/templates/items/browse/species.html","systems/dsa5/templates/items/browse/career.html","systems/dsa5/templates/actors/parts/specblock.html"]),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsa5",he,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsa5",Ie,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsa5",Ee,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsa5",Te,{types:["npc"]}),Actors.registerSheet("dsa5",It,{types:["creature"]}),Actors.registerSheet("dsa5",Et,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsa5",_DSAActiveEffectConfig,{makeDefault:!0}),Journal.registerSheet("dsa5",$t,{makeDefault:!0}),K.setupSheets(),Hooks.call("registerDSAstyle",b.styles),$i(),Y.initDoorMinDistance(),mergeObject(CONFIG.JournalEntry.noteIcons,b.noteIcons),V.prepareSoundEffects(),$("body").addClass(game.settings.get("dsa5","globalStyle"))});Hooks.once("setup",()=>{if(!["de","en"].includes(game.i18n.lang))console.warn(`DSA5 - ${game.i18n.lang} is not a supported language. Falling back to default language.`),yn();else{let l=game.settings.get("dsa5","forceLanguage");["de","en"].includes(l)&&game.i18n.lang!=l&&bn(l)}mt.initHook(),pi(),Mt.registerButtons(),Se.registerButtons(),CONFIG.Canvas.lightAnimations.daylight={label:"LIGHT.daylight",illuminationShader:Yt},x.setupFunctions(),L.setupFunctions()});Hooks.once("i18nInit",()=>{kn()});var Ws=class extends Dialog{async close(e={}){if(!!["de","en"].includes(game.i18n.lang))return super.close(e)}};u(Ws,"ForbiddenLanguageDialog");var yn=u(()=>{let l={title:game.i18n.localize("language"),content:"<p>Your foundry language is not supported by this system. Due to technical reasons your foundry language setting has to be switched to either english or german.</p>",buttons:{de:{icon:'<i class="fa fa-check"></i>',label:"en",callback:async()=>{await game.settings.set("core","language","de"),foundry.utils.debouncedReload()}},en:{icon:'<i class="fas fa-check"></i>',label:"de",callback:async()=>{await game.settings.set("core","language","en"),foundry.utils.debouncedReload()}},logout:{icon:'<i class="fas fa-door-closed"></i>',label:game.i18n.localize("SETTINGS.Logout"),callback:async()=>{ui.menu.items.logout.onClick()}}}};new Ws(l).render(!0)},"showForbiddenLanguageDialog"),bn=u(l=>{let e={title:game.i18n.localize("DSASETTINGS.forceLanguage"),content:game.i18n.format("DSAError.wrongLanguage",{lang:l}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async()=>{await game.settings.set("core","language",l),foundry.utils.debouncedReload()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new Dialog(e).render(!0)},"showWrongLanguageDialog");function kn(){game.dsa5.config.knownShortcuts={[game.i18n.localize("CHARAbbrev.INI").toLowerCase()]:["status","initiative","gearmodifier"],[game.i18n.localize("CHARAbbrev.GS").toLowerCase()]:["status","speed","gearmodifier"],[game.i18n.localize("CHARAbbrev.AsP").toLowerCase()]:["status","astralenergy","gearmodifier"],[game.i18n.localize("CHARAbbrev.LeP").toLowerCase()]:["status","wounds","gearmodifier"],[game.i18n.localize("CHARAbbrev.KaP").toLowerCase()]:["status","karmaenergy","gearmodifier"],[game.i18n.localize("CHARAbbrev.AW").toLowerCase()]:["status","dodge","gearmodifier"],[game.i18n.localize("CHARAbbrev.SK").toLowerCase()]:["status","soulpower","gearmodifier"],[game.i18n.localize("CHARAbbrev.ZK").toLowerCase()]:["status","toughness","gearmodifier"],[game.i18n.localize("CHARAbbrev.FtP").toLowerCase()]:["status","fatePoints","gearmodifier"]};for(let l of Object.keys(b.characteristics))game.dsa5.config.knownShortcuts[game.i18n.localize(`CHARAbbrev.${l.toUpperCase()}`).toLowerCase()]=["characteristics",l.toLowerCase(),"gearmodifier"]}u(kn,"setupKnownEquipmentModifiers");var Ot=class extends AdaptiveIlluminationShader{},Yt=Ot;u(Yt,"DaylightIlluminationShader"),F(Yt,"fragmentShader",`
    ${Ot.SHADER_HEADER}
    ${Ot.PERCEIVED_BRIGHTNESS}

    void main() {
        ${Ot.FRAGMENT_BEGIN}
        ${Ot.TRANSITION}
       
        // Darkness
        framebufferColor = max(framebufferColor, colorBackground);        
        // Elevation
        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        
        // Final
        gl_FragColor = vec4(finalColor, 1.0);
      }`);var xt=class{static weaponLessMacro(e){let t=ChatMessage.getSpeaker(),a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor)),this.runWeaponless(a,e,t.token)}static weaponLessMacroId(e,t){let a=game.actors.get(t);this.runWeaponless(a,e)}static requestRoll(e,t=0){B.showRQMessage(e,t)}static requestGC(e,t=0,a={}){B.showGCMessage(e,t,a)}static rollCh(e,t={}){ee.check3D20(void 0,e,t)}static itemMacroById(e,t,a,s){let i=game.actors.get(e),n=i?i.items.find(r=>r.name===t&&r.type==a):null;this.runItem(i,n,t,s)}static itemMacro(e,t,a){let s=ChatMessage.getSpeaker(),i;s.token&&(i=game.actors.tokens[s.token]),i||(i=game.actors.get(s.actor));let n=i?i.items.find(r=>r.name===e&&r.type==t):null;this.runItem(i,n,e,a,s.token)}static charMacroById(e,t){let a=game.actors.get(t);this.runChar(a,e)}static charMacro(e){let t=ChatMessage.getSpeaker(),a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor)),this.runChar(a,e,t.token)}static runWeaponless(e,t,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));let s=t.split("Weaponless")[0];e.setupWeaponless(s,{},a).then(i=>{e.basicTest(i)})}static runChar(e,t,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));e.setupDodge({},a).then(s=>{e.basicTest(s)})}static runItem(e,t,a,s,i){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:a}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,s.mod,s,i).then(n=>{e.basicTest(n)});case"rangeweapon":return e.setupWeapon(t,"attack",s,i).then(n=>{e.basicTest(n)});case"skill":return e.setupSkill(t,s,i).then(n=>{e.basicTest(n)});case"ceremony":case"ritual":case"spell":case"liturgy":return e.setupSpell(t,s,i).then(n=>{e.basicTest(n)})}}};u(xt,"MacroDSA5");var zi={};Hooks.once("ready",()=>{Promise.all([f.allSkillsList(),f.allCombatSkills()]).then(l=>{let e=l[0].reduce((r,o)=>({...r,[o]:o}),{}),t=l[1].filter(r=>r.system.weapontype.value=="range").sort((r,o)=>r.name.localeCompare(o.name)).reduce((r,o)=>({...r,[o.name]:o.name}),{}),a=l[1].filter(r=>r.system.weapontype.value=="melee").sort((r,o)=>r.name.localeCompare(o.name)).reduce((r,o)=>({...r,[o.name]:o.name}),{}),s=l[1].concat([{name:game.i18n.localize("LocalizedIDs.all")}]).sort((r,o)=>r.name.localeCompare(o.name)).reduce((r,o)=>({...r,[o.name]:o.name}),{}),i=[];for(let[r,o]of Object.entries(b.specialAbilityCategories))r=="clerical"?i.push(`</optgroup><optgroup label="${game.i18n.localize("SpecCategory.clerical")}">`):r=="magical"&&i.push(`</optgroup><optgroup label="${game.i18n.localize("SpecCategory.magical")}">`),i.push(`<option value="${r}">${game.i18n.localize(o)}</option>`);let n=`<div class="form-group">
            <label class="label-text">${game.i18n.localize("Category")}</label>
            <select name="category.value" data-dtype="String">
                <option value="">${game.i18n.localize("Library.noFilter")}</option>          
                <optgroup label="${game.i18n.localize("SpecCategory.general")}">
                ${i.join("")}
                </optgroup>
            </select>
        </div>`;mergeObject(zi,{ammunition:[{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:b.ammunitiongroups}],equipment:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:b.equipmentTypes}],rangeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill.value",type:"select",options:t},{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:b.ammunitiongroups}],meleeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill.value",type:"select",options:a},{label:"guidevalue",attr:"guidevalue.value",type:"select",options:b.combatskillsGuidevalues},{label:"reach",attr:"reach.value",type:"select",options:b.meleeRanges}],poison:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:b.magicResistanceModifiers}],disease:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:b.magicResistanceModifiers}],consumable:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:b.equipmentTypes}],application:[{label:"TYPES.Item.skill",attr:"skill",type:"select",options:e}],trait:[{label:"traitType",attr:"traitType.value",type:"select",options:b.traitCategories}],career:[{label:"mageLevel",attr:"mageLevel.value",type:"select",options:b.mageLevels}],specialability:[{type:"prerendered",attr:"category.value",content:n},{label:"TYPES.Item.combatskill",attr:"list.value",type:"select",options:s,notStrict:!0},{label:"distribution",attr:"distribution",type:"text"}],liturgy:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:b.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spell:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:b.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ritual:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:b.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ceremony:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:b.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spellextension:[{label:"Category",attr:"category",type:"select",options:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}],magictrick:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"},{label:"distribution",attr:"distribution",type:"text"}],blessing:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],npc:[{label:"TYPES.Item.species",attr:"details.species.value",type:"text"},{label:"TYPES.Item.career",attr:"details.career.value",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture.value",type:"text"}],character:[{label:"TYPES.Item.species",attr:"details.species.value",type:"text"},{label:"TYPES.Item.career",attr:"details.career.value",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture.value",type:"text"}],creature:[{label:"creatureClass",attr:"creatureClass.value",type:"text"},{label:"sizeCategory",attr:"status.size.value",type:"select",options:b.sizeCategories}],armor:[{label:"protection",attr:"protection.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}},{label:"encumbrance",attr:"encumbrance.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4"}}],plant:[{label:"PLANT.landscape",attr:"location.landscape",type:"text"},{label:"PLANT.region",attr:"location.region",type:"text"},{label:"PLANT.healing",attr:"planttype.healing",type:"checkbox"},{label:"PLANT.poison",attr:"planttype.poison",type:"checkbox"},{label:"PLANT.physical",attr:"planttype.physical",type:"checkbox"},{label:"PLANT.psychic",attr:"planttype.psychic",type:"checkbox"},{label:"PLANT.crop",attr:"planttype.crop",type:"checkbox"},{label:"PLANT.defensive",attr:"planttype.defensive",type:"checkbox"},{label:"PLANT.supernatural",attr:"planttype.supernatural",type:"checkbox"},{label:"PLANT.highNorth",attr:"availability.highNorth",type:"range"},{label:"PLANT.grasLands",attr:"availability.grasLands",type:"range"},{label:"PLANT.swamps",attr:"availability.swamps",type:"range"},{label:"PLANT.woods",attr:"availability.woods",type:"range"},{label:"PLANT.jungle",attr:"availability.jungle",type:"range"},{label:"PLANT.mountains",attr:"availability.mountains",type:"range"},{label:"PLANT.desert",attr:"availability.desert",type:"range"},{label:"PLANT.maraskan",attr:"availability.maraskan",type:"range"}],magicalsign:[],patron:[],demonmark:[],essence:[],imprint:[{label:"Category",attr:"category",type:"text"}]})})});var Us=zi;var zt=class{constructor(e,t={}){let a=e.documentName||e.type;switch(e.documentName){case"Actor":case"Item":a=e.type;break}let s="";if(game.settings.get("dsa5","indexDescription"))switch(a){case"creature":case"npc":case"character":s=getProperty(e,"system.description.value");break;case"JournalEntry":s=getProperty(e,"system.content");break;default:s=getProperty(e,"description.value")}this.document={name:e.name,filterType:a,data:$("<div>").html(s).text(),id:e.id||e._id,visible:e.visible?e.visible:!0,compendium:e.compendium?e.compendium.metadata.packageName:t.packageName||"",pack:e.pack||(t.packageName?t.id:void 0),img:e.img,price:e.system?.price?.value}}get uuid(){if(this.document.compendium)return`Compendium.${this.document.pack}.${this.document.id}`;switch(this.itemType){case"character":case"creature":case"npc":return`Actor.${this.id}`;case"JournalEntry":return`JournalEntry.${this.id}`;default:return`Item.${this.id}`}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}get itemType(){return this.document.filterType}get hasPrice(){return b.equipmentCategories.has(this.document.filterType)}async getItem(){return await fromUuid(this.uuid)}hasPermission(){return this.document.visible}async render(){(await this.getItem()).sheet.render(!0)}get compendium(){return this.document.compendium}get img(){return this.itemType=="JournalEntry"?"systems/dsa5/icons/categories/DSA-Auge.webp":this.document.img}};u(zt,"SearchDocument");var Jt=class extends zt{constructor(e,t){super(e);let a=Us[t]||[];for(let s of a)this[s.attr]=s.attr.split(".").reduce((i,n)=>i[n]===void 0?{}:i[n],e.system)}};u(Jt,"AdvancedSearchDocument");var Pt=class extends Application{constructor(e){super(e),this.advancedFiltering=!1,this.journalBuild=!1,this.journalWorldBuild=!1,this.equipmentBuild=!1,this.equipmentWorldBuild,this.zooBuild=!1,this.zooWorldBuild=!1,this.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),this.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"],tag:["itemType"]}}),this.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"],tag:["itemType"]}}),this.detailFilter={},this.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},this.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1,disease:!1,consumable:!1,plant:!1},filterBy:{search:""}},character:{categories:{career:!1,advantage:!1,combatskill:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1,application:!1,demonmark:!1,patron:!1,essence:!1,imprint:!1},filterBy:{search:""}},spell:{categories:{blessing:!1,ceremony:!1,liturgy:!1,magictrick:!1,ritual:!1,spell:!1,spellextension:!1,magicalsign:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}}}async getData(e){let t=await super.getData(e);return t.categories=this.translateFilters(),t.isGM=game.user.isGM,t.items=this.items,t.advancedMode=this.advancedFiltering?"on":"",t.worldIndexed=game.settings.get("dsa5","indexWorldItems")?"on":"",t.fullTextEnabled=game.settings.get("dsa5","indexDescription")?"on":"",t.filterDuplicateItems=game.settings.get("dsa5","filterDuplicateItems")?"on":"",t.browseEnabled=this.browseEnabled?"on":"",this.advancedFiltering&&(t.advancedFilter=await this.buildDetailFilter("tbd",this.subcategory)),t}translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo,"Actor"),journal:this.buildFilter(this.filters.journal)}}purgeAdvancedFilters(){for(let e in this.filters)for(let t in this.filters[e].categories)this.filters[e].categories[t]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then(e=>{$(this._element).find(".advancedSearch .groupbox").html(e)})}buildFilter(e,t="Item"){let a=[];return Object.keys(e.categories).forEach(function(s){a.push({label:game.i18n.localize(`TYPES.${t}.${s}`),selected:e.categories[s],key:s})}),a=a.sort(function(s,i){return s.label.localeCompare(i.label)}),a}static get defaultOptions(){let e=super.defaultOptions;return e.id="DSA5ItemLibrary",e.classes.push("dsa5","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("ItemLibrary"),e.template="systems/dsa5/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}async getRandomItems(e,t){let a=[],s=this.equipmentIndex;return a.push(...await s.search(e,{field:["itemType"]})),(await Promise.all(this.shuffle(a.filter(i=>i.hasPermission)).slice(0,t+5).map(i=>i.getItem()))).filter(i=>{let n=i.getFlag("dsa5","enchantments");return!n||!n.find(r=>r.talisman)}).slice(0,t)}shuffle(e){let t=e.length,a,s;for(;t!==0;)s=Math.floor(Math.random()*t),t-=1,a=e[t],e[t]=e[s],e[s]=a;return e}async findCompendiumItem(e,t,a=!0){this.equipmentBuild||await this.buildEquipmentIndex();let s={field:["name"],where:{itemType:t}},i=await this.equipmentIndex.search(e,s);return a&&(i=i.filter(n=>n.compendium!="")),await Promise.all(i.map(n=>n.getItem()))}async getCategoryItems(e,t=!1,a=!1){await this.buildEquipmentIndex();let s=this.equipmentIndex.search(e,{field:["itemType"]});return t?(await Promise.all(s.map(i=>i.getItem()))).map(i=>i.toObject()):a?await Promise.all(s.map(i=>i.getItem())):s}async executeAdvancedFilter(e,t,a,s,i,n=[]){let r=u(g=>{for(let h of a)if(h[2]?g[h[0]]!=h[1]:g[h[0]].indexOf(h[1])==-1)return!1;return!0},"selFnct"),o=u(g=>{for(let h of s)if(g[h[0]].toLowerCase().indexOf(h[1])==-1)return!1;return!0},"txtFnct"),c=u(g=>{for(let h of i)if(g[h[0]]!=h[1])return!1;return!0},"cbFnct"),m=u(g=>{for(let h of n)if(g[h[0]]<h[1]||g[h[0]]>h[2])return!1;return!0},"rangeFct"),p=t.where(g=>(e==""||g.name.toLowerCase().indexOf(e)!=-1)&&r(g)&&o(g)&&c(g)&&m(g));return p=p.filter(g=>g.hasPermission).sort((g,h)=>g.name.toLowerCase()>h.name.toLowerCase()?1:-1),p}async advancedFilterStuff(e,t){let a=$(this._element).find(".detailFilters"),s=a.attr("data-subc"),i=this.filters[e].filterBy.search.toLowerCase(),n=this.detailFilter[s],r=[],o=[],c=[];for(let d of a.find("select")){let p=$(d).val();p!=""&&r.push([$(d).attr("name"),p,d.dataset.notstrict!="true"])}for(let d of a.find('input[type="text"]:not(.manualFilter)')){let p=$(d).val();p!=""&&o.push([$(d).attr("name"),p.toLowerCase()])}for(let d of a.find('input[type="checkbox"]:checked:not(.manualFilter)')){let p=$(d).val();p!=""&&c.push([$(d).attr("name"),p.toLowerCase()])}let m=await this.executeAdvancedFilter(i,n,r,o,c);return this.setBGImage(m,e),m=this.filterDuplications(m),m}filterDuplications(e){return game.settings.get("dsa5","filterDuplicateItems")&&(e=[...new Map(e.map(t=>[`${t.name}_${t.type}`,t])).values()]),e}async filterStuff(e,t,a){let s=this.filters[e].filterBy.search,i={field:["name","data"]},n=[],r=!1;for(let o in this.filters[e].categories){if(this.filters[e].categories[o]){let c,m=null;s==""?c=t.search(o,{field:["itemType"],sort:"name",where:{itemType:o}}):c=t.search(s,{...i,sort:"name",where:{itemType:o}});let d=Number(a)||0;c=c.slice(d,Math.min(d+60,c.length)),c.length==60&&(m=`${d+60}`),this.pages[e].next=m,n.push(...c)}r=this.filters[e].categories[o]||r}return r||(n=t.search(s,{...i,limit:60,page:a||!0,sort:"name"}),this.pages[e].next=n.next),n=n.result?n.result:n,n=n.filter(o=>o.hasPermission),this.setBGImage(n,e),n}setBGImage(e,t){$(this._element).find(`.${t} .libcontainer`)[`${e.length>0?"remove":"add"}Class`]("libraryImg")}async getItemTemplate(e,t){if(this.browseEnabled&&t=="Item")return(await Promise.all(e.map(async a=>{let s=`systems/dsa5/templates/items/browse/${a.document.filterType}.html`,i=await fromUuid(a.uuid),n=await renderTemplate(s,{document:i,isGM:game.user.isGM,...await i.sheet.getData()});return`<div class="uuid libItem ${a.document.filterType} col" data-uuid="${a.uuid}" data-item-id="${a.id}">${n}</div>`}))).join(`
`);{let a="systems/dsa5/templates/system/libraryItem.html";return await renderTemplate(a,{items:e})}}async renderResult(e,t,{index:a,itemType:s},i){let n=e.find(".searchResult .item-list"),r=await this.getItemTemplate(t,s);i||n.empty(),r=$(r);let o=u((c,m,d,p=!1)=>{c.stopPropagation();let g=m.find(c.currentTarget.dataset.itemId);c.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:d,uuid:g.uuid,pay:p}))},"itemDragStart");r.each(function(){let c=$(this);c.attr("draggable",!0).on("dragstart",m=>o(m,a,s)),c.find(".priceDrag").attr("draggable",!0).on("dragstart",m=>o(m,a,s,!0))}),n.append(r)}async filterItems(e,t,a){let s=this.selectIndex(t),i=this.advancedFiltering&&t!="journal"?await this.advancedFilterStuff(t,a):await this.filterStuff(t,s.index,a);return await this.renderResult(e,i,s,a),i}selectIndex(e){let t="Item",a=this.equipmentIndex;switch(e){case"zoo":t="Actor",a=this.zooIndex;break;case"journal":t="JournalEntry",a=this.journalIndex;break}return{index:a,itemType:t}}async _render(e=!1,t={}){await super._render(e,t),this.buildEquipmentIndex()}async buildEquipmentIndex(){await this._createIndex("equipment","Item",game.items)}async _createIndex(e,t,a){if(this[`${e}Build`])return;SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:0});let s=$(this._element).find(`*[data-tab="${e}"]`);this.showLoading(s,e);let i=game.packs.filter(p=>p.documentName==t&&(game.user.isGM||!p.private)&&!p.metadata.label.startsWith("WZ-")),n=100/(i.length+1),r=n,o=["name","system.type","system.description.value","img"],c;t=="Actor"?c=u(p=>p.getIndex({actorFields:o}),"func"):t=="JournalEntry"?c=u(p=>p.getDocuments(),"func"):c=u(p=>p.getDocuments({type__in:game.system.documentTypes.Item}),"func");let m=this.indexWorldItems(a,e);SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"world items"}),pct:Math.round(n)});let d=i.map(async p=>{let g=await c(p);r+=n,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:`${p.metadata.label} (${p.metadata.id})`}),pct:Math.round(r)}),m.push(...g.map(h=>new zt(h,p.metadata)))});return Promise.all(d).then(p=>{this[`${e}Index`].add(m),this[`${e}Build`]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:100}),this.hideLoading(s,e)})}subcategoryFields(e){let t=["name","itemType"],a=Us[e]||[];for(let s of a)t.push(s.attr);return t}indexWorldItems(e,t){let a=[];return game.settings.get("dsa5","indexWorldItems")&&(a.push(...e.filter(s=>s.visible).map(s=>new zt(s))),this[`${t}WorldBuild`]=!0),a}async createDetailIndex(e,t){if(!this.detailFilter[t]){let a=this.subcategoryFields(t),s=$(this._element).find(`*[data-tab="${e}"]`);s.find(".searchResult ul").html(""),this.showLoading(s,e),this.detailFilter[t]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:a}});let{index:i,itemType:n}=this.selectIndex(e),o=(n=="Item"?game.items:game.actors).filter(g=>g.visible&&g.type==t).map(g=>new Jt(g,t)),c=i.search(t,{field:["itemType"]}),m={};for(let g of c)!g.document.pack||(m[g.document.pack]||(m[g.document.pack]=[]),m[g.document.pack].push(g.document.id));let d=[];for(let g of Object.entries(m))d.push(game.packs.get(g[0]).getDocuments({_id__in:g[1],type:t}));let p=await Promise.all(d);for(let g of p)o.push(...g.map(h=>new Jt(h,t)));this.detailFilter[t].add(o),this.hideLoading(s,e)}}async buildDetailFilter(e,t){let a=Us[t]||[];if(a){let s=this.createDetailIndex(e,t),i=game.packs.filter(r=>r.metadata.type=="Item").reduce((r,o)=>{if(!r[o.metadata.packageName]){let c=game.i18n.has(`${o.metadata.packageName}.name`)?game.i18n.localize(`${o.metadata.packageName}.name`):game.modules.get(o.metadata.packageName)?.title.replace(/The Dark Eye 5th Ed. - /i,"")||"World";r[o.metadata.packageName]=c}return r},{}),n=await renderTemplate("systems/dsa5/templates/system/detailFilter.html",{fields:a,subcategory:t,moduleOptions:i});return await s,n}else return`<p>${game.i18n.localize("Library.selectAdvanced")}</p>`}checkWorldStuffIndex(){game.settings.get("dsa5","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}activateListeners(e){super.activateListeners(e),ne(e),e.on("click",".searchableAbility a",i=>gt(i)),e.on("click",".toggleAdvancedMode",()=>{this.advancedFiltering=!this.advancedFiltering,this.advancedFiltering?($(this._element).find(".toggleAdvancedMode").addClass("on"),$(this._element).find(".advancedSearch").fadeIn(),this.purgeAdvancedFilters()):($(this._element).find(".toggleAdvancedMode").removeClass("on"),$(this._element).find(".advancedSearch").fadeOut())}),e.on("change",".detailFilters input, .detailFilters select",()=>{let i=$(this._element).find(".tab.active"),n=i.attr("data-tab");this.filterItems(i,n)}),e.on("click",".filter",async i=>{let n=$(i.currentTarget).closest(".tab"),r=n.attr("data-tab"),o=i.currentTarget.dataset.category,c=$(i.currentTarget).is(":checked");this.advancedFiltering&&c&&(this.purgeAdvancedFilters(),this.subcategory=o,$(i.currentTarget).prop("checked",c),$(this._element).find(".advancedSearch .groupbox").html(await this.buildDetailFilter(r,o))),this.filters[r].categories[o]=c,this.filterItems(n,r)}),e.on("click",".item-name",i=>{this.getItemFromHTML(i).render()}),e.on("mousedown",".item-name",i=>{i.button==2&&f.showArtwork(this.getItemFromHTML(i))}),e.on("keyup",".filterBy-search",i=>{let n=$(i.currentTarget).closest(".tab"),r=n.attr("data-tab");this.filters[r].filterBy.search=$(i.currentTarget).val(),this.filterItems(n,r)});let t=u(i=>{i.stopPropagation();let n=i.currentTarget.dataset.type,r=i.currentTarget.dataset.uuid;!r||!n||i.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:n,uuid:r}))},"itemDragStart"),a=e.find(".show-item");a.click(async i=>{let n=i.currentTarget.dataset.uuid;(await fromUuid(n)).sheet.render(!0)}),a.attr("draggable",!0).on("dragstart",i=>t(i)),e.find('*[data-tab="journal"]').click(i=>{this._createIndex("journal","JournalEntry",game.journal)}),e.find('*[data-tab="zoo"]').click(i=>{this._createIndex("zoo","Actor",game.actors)}),e.find(".showDetails").click(i=>{let n=i.currentTarget.dataset.btn;$(i.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),e.find(`.${n} .detailBox`).toggleClass("dsahidden")}),e.find(".toggleWorldIndex").click(i=>{game.settings.set("dsa5","indexWorldItems",!game.settings.get("dsa5","indexWorldItems")),this.checkWorldStuffIndex(),$(i.currentTarget).toggleClass("on")}),e.find(".fulltextsearch").click(i=>{game.settings.set("dsa5","indexDescription",!game.settings.get("dsa5","indexDescription")),$(i.currentTarget).toggleClass("on")}),e.find(".browseEnabled").click(i=>{this.browseEnabled=!this.browseEnabled,$(i.currentTarget).toggleClass("on")}),e.find(".filterDuplicateItems").click(i=>{game.settings.set("dsa5","filterDuplicateItems",!game.settings.get("dsa5","filterDuplicateItems")),$(i.currentTarget).toggleClass("on")});let s=this;$(this._element).find(".window-content").on("scroll.infinit",debounce(function(i){if(s.advancedFiltering)return;let n=$(i.target),r=n.scrollTop()+n.innerHeight()>=n[0].scrollHeight-100,o=e.find(".tabs .item.active").attr("data-tab");if(r&&s.pages[o].next){let c=e.find(".tab.active");s.filterItems.call(s,c,o,s.pages[o].next)}},100))}getItemFromHTML(e){let t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}showLoading(e,t){this.setBGImage([1],t),$(`<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>${game.i18n.localize("Library.buildingIndex")}</div>`).appendTo(e.find(".searchResult"))}hideLoading(e,t){this.setBGImage([],t),e.find(".loader").remove()}};u(Pt,"DSA5ItemLibrary");var Nt=class extends Dialog{constructor(e,t,a,s=""){let i={title:e,content:t,buttons:{initialize:{label:game.i18n.localize("initialize"),callback:async()=>{this.lock||await this.initialize()}},cancel:{label:game.i18n.localize("cancel"),callback:async()=>{this.lock||await this.dontInitialize()}}}};super(i),this.module=a,this.lang=s,this.folders={},this.journals={},this.scenes={},this.actors={},this.lock=!1}async initNotes(e,t,a){let s=await this.getFolderForType("JournalEntry");for(let i of e.notes)try{let n=t.find(r=>r.flags.dsa5.initId==i.entryId);if(!a.has(n._id)){let r=getProperty(n,"flags.dsa5.parent"),o=s;this.folders[r]?o=this.folders[r]:r&&(o=await this.getFolderForType("JournalEntry",s.id,r,0,getProperty(n,"flags.dsa5.foldercolor")||"")),n.folder=o.id;let c=game.journal.find(m=>m.name==n.name&&m.folder?.id==o.id&&m.flags.dsa5.initId==i.entryId);if(c)await c.update(n),a.set(n._id,c.id);else{let m=await JournalEntry.create(n);a.set(n._id,m.id)}}i.entryId=a.get(n._id)}catch(n){console.warn(`Could not initialize Scene Notes for scene :${e.name}`+n)}}async initScenes(e){let t=await this.getFolderForType("Scene"),s=(await game.packs.get(e.scenes).getDocuments()).map(p=>p.toObject()),n=(await game.packs.get(e.journal).getDocuments()).map(p=>p.toObject()),r=[],o=[],c=new Map,m=!1;for(let p of s){let g=m,h=game.scenes.find(y=>y.name==p.name&&y.folder?.id==t.id);if(!m&&h&&([g,m]=await new Promise((y,v)=>{new Dialog({title:game.i18n.localize("Book.sceneReset"),content:game.i18n.format("Book.sceneResetDescription",{name:p.name}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{y([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("LocalizedIDs.all"),callback:()=>{y([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{y([!1,!1])}}},close:()=>{y([!1,!1])}}).render(!0)})),h&&!g){this.scenes[h.name]=h;continue}p.folder=t.id,await this.initNotes(p,n,c),h?(p._id=h.id,o.push(p)):r.push(p)}let d=await Scene.create(r,{dsaInit:!0});for(let p of d){this.scenes[p.name]=p;let g=await p.createThumbnail();await p.update({thumb:g.thumb},{diff:!1})}for(let p of o)await game.scenes.get(p._id).update(p),this.scenes[p.name]=game.scenes.get(p._id);if(e.initialScene){let p=this.scenes[e.initialScene];await game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0),await p.activate(),await p.update({navigation:!0})}}async initialize(){this.lock=!0;let e=$(this._element).find(".initialize");e.prepend('<i class="fas fa-spinner fa-spin"></i>');let t={};try{game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0)}catch{}try{await fetch(`modules/${this.module}/adventure${this.lang}.json`).then(async a=>a.json()).then(async a=>{t=a})}catch{try{await fetch(`modules/${this.module}/adventure.json`).then(async a=>a.json()).then(async a=>{t=a})}catch{console.warn(`Could not find book data for ${this.module} import.`)}}await fetch(`modules/${this.module}/initialization${this.lang}.json`).then(async a=>a.json()).then(async a=>{let s=a.folders;if(s){let i=await this.getFolderForType("JournalEntry"),n=a.folders[0].name;i&&(this.folders[i.data.name]=i,a.folders.shift());let r=await Folder.create(s);Array.isArray(r)||(r=[r]);for(let c of r)this.folders[c.data.name]=c;let o=[];for(let c in this.folders){let m=this.folders[c].getFlag("dsa5","parent"),d=m==n?game.i18n.localize(`${this.module}.name`):m;d&&o.push({_id:this.folders[c].id,parent:this.folders[d].id})}await Folder.updateDocuments(o)}if(a.items&&a.items.length>0){let i=await this.getFolderForType("Item"),n=[],r=[];for(let o of a.items){o.folder=i.id;let c=game.items.find(m=>m.name==o.name&&m.folder?.id==i.id);c?(o._id=c.id,r.push(o)):n.push(o)}await C.create(n),await C.updateDocuments(r)}if(a.playlists){let i=await this.getFolderForType("Playlist"),n=[],r=[],c=(await game.packs.get(a.playlists).getDocuments()).map(m=>m.toObject());for(let m of c){m.folder=i.id;let d=game.playlists.find(p=>p.name==m.name&&p.folder?.id==i.id);d?(m._id=d._id,r.push(m)):n.push(m)}await Playlist.create(n,{keepId:!0}),await Playlist.updateDocuments(r)}if(a.scenes&&await this.initScenes(a),a.actors){let i=await this.getFolderForType("Actor"),r=(await game.packs.get(a.actors).getDocuments()).map(g=>g.toObject()),o=[],c=[],m=new Map,d=0;if(getProperty(t,"chapters")){for(let g of t.chapters)for(let h of g.content)if(h.actors){let y=!1;for(let v of h.actors)m.has(v)||(m.set(v,h.name),y=!0);y&&(await this.getFolderForType("Actor",i.id,h.name,d),d+=1)}}for(let g of r){let h=m.has(g.name)?await this.getFolderForType("Actor",i.id,m.get(g.name)):i;g.folder=h.id,g._id&&delete g._id;let y=game.actors.find(v=>v.name==g.name&&[i.id,h.id].includes(v.folder?.id));y?(g._id=y.id,await y.deleteEmbeddedDocuments("Item",y.items.map(v=>v.id)),c.push(g)):o.push(g)}let p=await Actor.create(o);await Actor.updateDocuments(c);for(let g of p)this.actors[g.name]=g}}),this.lock=!1,e.find("i").remove(),ui.notifications.notify(game.i18n.localize("initComplete")),await this.close()}async dontInitialize(){game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0),ui.notifications.notify(game.i18n.localize("initSkipped")),await this.close()}submit(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(t){throw ui.notifications.error(t),new Error(t)}}async getFolderForType(e,t=null,a=null,s=0,i=""){return a||(a=game.i18n.localize(`${this.module}.name`)),f.getFolderForType(e,t,a,s,i)}};u(Nt,"DSA5Initializer");var Lt=class extends ChatMessage{get isRoll(){return this.isDSARoll||super.isRoll}get roll(){return this.isDSARoll?new Vs(""):super.roll}get isDSARoll(){return this.flags.data?this.flags.data.isDSARoll:!1}};u(Lt,"ChatMessageDSA5Roll");var Vs=class extends Roll{render(){return""}};u(Vs,"EmptyRoll");var Rt=class extends Hotbar{async _render(e=!1,t={}){await super._render(e,t),this.addContextColor()}async collapse(){return this._collapsed?!0:($(this.element).addClass("collapsedHotbar"),super.collapse())}async expand(){return this._collapsed?($(this.element).removeClass("collapsedHotbar"),super.expand()):!0}addContextColor(){let e=new RegExp(` ${game.i18n.localize("CHAR.PARRY")}$`),t=new RegExp(` ${game.i18n.localize("CHAR.ATTACK")}$`),a=$(this._element).find("#macro-list");for(let s of this.macros)!s.macro||(e.test(s.macro.name)?a.find(`[data-macro-id="${s.macro.id}"]`).addClass("parry"):t.test(s.macro.name)&&a.find(`[data-macro-id="${s.macro.id}"]`).addClass("attack"))}};u(Rt,"DSA5Hotbar");var _e=class{constructor(){this.tokens={},this.actors={}}static get wantedKeys(){let e=["vision","targetMovement","shooterMovement","quickChange","mountOptions","narrowSpace","advantageousPosition","doubleAttack","reduceCostSpell","forceSpell","increaseCastingTime","decreaseCastingTime","removeGesture","removeFormula"];return Y.isEnabled||e.push("distance"),e}getPath(e,t,a){let s=a||"",i=t._id||t.type;return e.token?`tokens.${e.token||e.actor}.${i}${s}`:`actors.${e.actor}.${i}${s}`}remember(e,t,a,s){let i=this.formDataSerialize(s);Object.entries(i).length>0&&setProperty(this,this.getPath(e,t,a),i)}recall(e,t,a){return getProperty(this,this.getPath(e,t,a))}formDataSerialize(e){let t=e.find("form"),a={};return t.find("select").each(function(){let s=$(this).attr("name");_e.wantedKeys.includes(s)&&(a[s]=$(this).val())}),t.find('input[type="checkbox"]').each(function(){let s=$(this).attr("name");_e.wantedKeys.includes(s)&&(a[s]=this.checked)}),t.find(".specAbs.active").each(function(){a.specAbs||(a.specAbs=[]),a.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})}),e.find('[name="situationalModifiers"] option').each(function(){a.situationalModifiers||(a.situationalModifiers=[]),a.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})}),a}};u(_e,"RollMemory");var Ks=class extends ActiveEffect{apply(e,t){if(Ks.itemChangeRegex.test(t.key)){let a=this._getModifiedItems(e,t);for(let s of a.items){let i=foundry.utils.flattenObject(s.overrides||{});i[a.key]=Number.isNumeric(s.value)?Number(a.value):a.value;let n={...t,key:a.key,value:a.value};super.apply(s,n),s.overrides=foundry.utils.expandObject(i)}}else return super.apply(e,t)}static async _onCreateDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await S.postUpdateConditions(a.parent);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await S.postUpdateConditions(a.parent);return super._onUpdateDocuments(e,t)}static async _onDeleteDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await S.postUpdateConditions(a.parent);return super._onDeleteDocuments(e,t)}isVisibleEffect(){return!this.disabled&&!this.notApplicable&&(game.user.isGM||!this.getFlag("dsa5","hidePlayers"))&&!this.getFlag("dsa5","hideOnToken")&&(this.origin==this.target?.uuid||!this.origin)}_displayScrollingStatus(e){let t=["dead"];!(game.user.isGM||this.target?.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects")?this.isVisibleEffect():t.some(i=>this.statuses.has(i)))||super._displayScrollingStatus(e)}_getModifiedItems(e,t){let a=t.key.split("."),s=a.shift();s=s.replace("@","").toLowerCase();let i=a.shift(),n=a.join("."),r=t.value;return{items:e?.items?.filter(c=>c.type==s&&(c.name==i||c.id==i))||[],key:n,value:r}}async _preUpdate(e,t,a){super._preUpdate(e,t,a),this._clearModifiedItems()}_clearModifiedItems(){if(this.parent instanceof CONFIG.Actor.documentClass){for(let e of this.changes)if(Ks.itemChangeRegex.test(e.key)){let t=this._getModifiedItems(this.parent,e);for(let a of t.items){let s=foundry.utils.flattenObject(a.overrides||{}),i=t.key;delete s[i];let n=getProperty(a._source,i);setProperty(a,i,n),a.overrides=foundry.utils.expandObject(s),a.sheet?.rendered&&a.sheet.render(!0)}}}}async _preDelete(e,t){super._preDelete(e,t),this._clearModifiedItems()}},ut=Ks;u(ut,"DSAActiveEffect"),F(ut,"itemChangeRegex",/^@/);var wn=u((l,e)=>{let t=getProperty(l,e.key)||null;t==null&&/^system\.(vulnerabilities|resistances)/.test(e.key)&&(t=[],setProperty(l,e.key,t));let a=getType(t),s=null;switch(a){case"Array":let i=[],n=e.effect.name;for(let r of`${e.value}`.split(/[;,]+/)){let o=r.split(" "),c=o.pop(),m=o.join(" ");i.push({source:n,value:c,target:m})}s=t.concat(i)}return s!==null&&setProperty(l,e.key,s),s},"applyCustomEffect");Hooks.on("applyActiveEffect",(l,e)=>wn(l,e));Hooks.once("init",()=>{console.log("Initializing DSA5 system"),CONFIG.statusEffects=b.statusEffects,game.dsa5={apps:{DSA5_Utility:f,DSA5Initializer:Nt,DSA5ChatListeners:ee,DSA5Payment:G,SpecialabilityRulesDSA5:L,AdvantageRulesDSA5:x,Migrakel:Ae,DSA5Dialog:Q,DSA5StatusEffects:E,DPS:Y,DSATables:U,DSA5SoundEffect:V,RequestRoll:B,DiceDSA5:_DiceDSA5,DSATour:xe,OpposeDSA:H,EquipmentDamage:W,DidYouKnow:Re,MeasuredTemplateDSA:ot,Riding:j,RuleChaos:_,Trade:de,DSAActiveEffectConfig:_DSAActiveEffectConfig},entities:{Actordsa5:S,Itemdsa5:C},sheets:{ActorSheetdsa5:Me,ActorSheetdsa5Character:he,ActorSheetdsa5Creature:Ie,ActorSheetdsa5NPC:Ee,MerchantSheetMixin:tt,MerchantSheetDSA5:Te,ItemSheetdsa5:K},wizards:{CareerWizard:Ye,CultureWizard:Ke,SpeciesWizard:Je},view:{tinyNotification:pe,tabSlider:ne,clickableAbility:gt},dialogs:{DialogReactDSA5:oe,ReactToSkillDialog:rt,ActAttackDialog:Ne,ReactToAttackDialog:Ce},macro:xt,config:b,memory:new _e,itemLibrary:new Pt},CONFIG.Actor.documentClass=S,CONFIG.Item.documentClass=C,CONFIG.ChatMessage.template="systems/dsa5/templates/chat/chat-message.html",CONFIG.ChatMessage.documentClass=Lt,CONFIG.ui.combat=ve,CONFIG.ui.hotbar=Rt,CONFIG.Combat.documentClass=ct,CONFIG.Combatant.documentClass=Vt,CONFIG.ActiveEffect.documentClass=ut,CONFIG.ActiveEffect.legacyTransferral=!1});fi();
