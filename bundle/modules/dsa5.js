var zi=Object.defineProperty;var Pi=(l,e,t)=>e in l?zi(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var R=(l,e,t)=>(Pi(l,typeof e!="symbol"?e+"":e,t),t),ti=(l,e,t)=>{if(!e.has(l))throw TypeError("Cannot "+t)};var ye=(l,e,t)=>(ti(l,e,"read from private field"),t?t.call(l):e.get(l)),Bt=(l,e,t)=>{if(e.has(l))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(l):e.set(l,t)},qt=(l,e,t,a)=>(ti(l,e,"write to private field"),a?a.call(l,t):e.set(l,t),t);var C={};C.statusEffects=[{icon:"icons/svg/skull.svg",id:"dead",name:"CONDITION.defeated",label:"CONDITION.defeated",description:"CONDITIONDESCRIPTION.defeated",flags:{dsa5:{}}},{id:"inpain",name:"CONDITION.inpain",icon:"icons/svg/blood.svg",description:"CONDITIONDESCRIPTION.inpain",changes:[{key:"system.condition.inpain",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"prone",name:"CONDITION.prone",icon:"icons/svg/falling.svg",description:"CONDITIONDESCRIPTION.prone",flags:{dsa5:{}}},{id:"unconscious",name:"CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"CONDITIONDESCRIPTION.unconscious",flags:{dsa5:{}}},{id:"rooted",name:"CONDITION.rooted",icon:"icons/svg/net.svg",description:"CONDITIONDESCRIPTION.rooted",flags:{dsa5:{}}},{id:"fixated",name:"CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"CONDITIONDESCRIPTION.fixated",flags:{dsa5:{}}},{id:"surprised",name:"CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"CONDITIONDESCRIPTION.surprised",flags:{dsa5:{}}},{id:"blind",name:"CONDITION.blind",icon:"icons/svg/blind.svg",description:"CONDITIONDESCRIPTION.blind",flags:{dsa5:{}}},{id:"poisoned",name:"CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"CONDITIONDESCRIPTION.poisoned",flags:{dsa5:{}}},{id:"sick",name:"CONDITION.sick",icon:"icons/svg/biohazard.svg",description:"CONDITIONDESCRIPTION.sick",flags:{dsa5:{}}},{id:"deaf",name:"CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"CONDITIONDESCRIPTION.deaf",flags:{dsa5:{}}},{id:"burning",name:"CONDITION.burning",icon:"icons/svg/fire.svg",description:"CONDITIONDESCRIPTION.burning",flags:{dsa5:{value:1,max:3}}},{id:"invisible",name:"CONDITION.invisible",icon:"icons/svg/circle.svg",description:"CONDITIONDESCRIPTION.invisible",flags:{dsa5:{}}},{id:"constricted",name:"CONDITION.constricted",icon:"icons/svg/cave.svg",description:"CONDITIONDESCRIPTION.constricted",flags:{dsa5:{}}},{id:"bloodrush",name:"CONDITION.bloodrush",icon:"icons/svg/bones.svg",description:"CONDITIONDESCRIPTION.bloodrush",changes:[{key:"system.skillModifiers.step",mode:0,value:"Kraftakt 2;Feat of Strength 2"}],flags:{dsa5:{}}},{id:"mute",name:"CONDITION.mute",icon:"icons/svg/silenced.svg",description:"CONDITIONDESCRIPTION.mute",flags:{dsa5:{}}},{id:"incapacitated",name:"CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"CONDITIONDESCRIPTION.incapacitated",flags:{dsa5:{}}},{id:"encumbered",name:"CONDITION.encumbered",icon:"icons/svg/anchor.svg",changes:[{key:"system.condition.encumbered",mode:2,value:1}],description:"CONDITIONDESCRIPTION.encumbered",flags:{dsa5:{value:1,max:4}}},{id:"stunned",name:"CONDITION.stunned",icon:"icons/svg/daze.svg",changes:[{key:"system.condition.stunned",mode:2,value:1}],description:"CONDITIONDESCRIPTION.stunned",flags:{dsa5:{value:1,max:4}}},{id:"raptured",name:"CONDITION.raptured",icon:"icons/svg/ice-aura.svg",changes:[{key:"system.condition.raptured",mode:2,value:1}],description:"CONDITIONDESCRIPTION.raptured",flags:{dsa5:{value:1,max:4}}},{id:"feared",name:"CONDITION.feared",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.feared",changes:[{key:"system.condition.feared",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"paralysed",name:"CONDITION.paralysed",icon:"icons/svg/paralysis.svg",description:"CONDITIONDESCRIPTION.paralysed",changes:[{key:"system.condition.paralysed",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"confused",name:"CONDITION.confused",icon:"icons/svg/stoned.svg",description:"CONDITIONDESCRIPTION.confused",changes:[{key:"system.condition.confused",mode:2,value:1}],flags:{dsa5:{value:1,max:4}}},{id:"minorSpirits",name:"CONDITION.minorSpirits",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.minorSpirits",changes:[{key:"system.skillModifiers.global",mode:0,value:-1}],duration:{seconds:600},flags:{dsa5:{}}},{id:"services",name:"PLAYER.services",icon:"icons/svg/aura.svg",description:"CONDITIONDESCRIPTION.services",flags:{dsa5:{value:1,max:500,hideOnToken:!0}}}];C.armorSubcategories={0:4,1:5,2:6,3:8,4:9,5:13,6:12,7:11,8:10};C.weaponStabilities={Blowpipes:10,Bows:4,Brawling:12,"Chain Weapons":10,Crossbows:6,Daggers:14,Discuses:12,Fans:13,"Fencing Weapons":8,"Impact Weapons":12,Lances:6,Pikes:12,Polearms:12,Shields:10,Slingshots:4,Swords:13,"Throwing Weapons":10,"Two-Handed Impact Weapons":11,"Two-Handed Swords":12,Whips:4};C.journalFontSizes=[8,10,12,14,16,18,20,24,28,32];C.styles={"dsa5-immersive":"dsaStyle.immersive","dsa5-immersive dsa5-legacy":"dsaStyle.legacy","dsa5-naked":"dsaStyle.naked"};C.fallingConditions={normal:0,soft1:-1,soft2:-2,soft3:-3,soft4:-4,rough1:1,rough2:2,rough3:3,rough4:4},C.combatSkillSubCategories={0:"COMBATSKILLCATEGORY.0",1:"COMBATSKILLCATEGORY.1",2:"COMBATSKILLCATEGORY.2",3:"COMBATSKILLCATEGORY.3",4:"COMBATSKILLCATEGORY.4",5:"COMBATSKILLCATEGORY.5"};C.effectTextStyle=CONFIG.canvasTextStyle.clone();C.effectTextStyle.fontSize="30";C.effectTextStyle.fontFamily="GentiumBasic";C.knownShortcuts={};C.gearModifyableCalculatedAttributes=["fatePoints","initiative","speed","astralenergy","karmaenergy","wounds","dodge","soulpower","toughness"];C.defaultWeapon={name:"default",type:"meleeweapon",effects:[],system:{type:"meleeweapon",crit:1,botch:20,reach:{value:"short"},damage:{value:"1d6"},atmod:{value:0,offHandMod:0},pamod:{value:0,offHandMod:0},guidevalue:{value:"ge/kk"},damageThreshold:{value:"5000"},worn:{offhand:!1}}};C.asyncHooks={postProcessDSARoll:[]};C.characteristics={mu:"CHAR.MU",kl:"CHAR.KL",in:"CHAR.IN",ch:"CHAR.CH",ff:"CHAR.FF",ge:"CHAR.GE",ko:"CHAR.KO",kk:"CHAR.KK"};C.equipmentTypes={misc:"Equipment.misc",clothes:"Equipment.clothes",tools:"Equipment.tools",light:"Equipment.light",healing:"Equipment.healing",bags:"Equipment.bags",wealth:"Equipment.wealth",writing:"Equipment.writing",alchemy:"Equipment.alchemy",service:"Equipment.service",luxus:"Equipment.luxus",blessed:"Equipment.blessed",food:"Equipment.food"};C.equipmentCategories=new Set(["meleeweapon","rangeweapon","equipment","ammunition","armor","poison","consumable","plant"]);C.systemTables=[{name:"Defense",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"defenseBotchTableEnabled"}},{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"meleeBotchTableEnabled"}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"rangeBotchTableEnabled"}},{name:"Liturgy",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}},{name:"Spell",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}}];C.morePackages={packages:{},names:{de:[],en:[]}};C.narrowSpaceModifiers={weaponshort:{attack:0,parry:0,label:"NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:-4,parry:-4,label:"NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-8,parry:-8,label:"NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:-2,parry:-2,label:"NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:-4,parry:-3,label:"NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-6,parry:-4,label:"NarrowSpaceModifiers.shield.long"}};C.traditionArtifacts={Animistenwaffe:15,Bannschwert:15,Druidendolch:15,Druidensichel:12,Zauberkleidung:15,Magierkugel:12,Zauberinstrument:15,Narrenkappe:15,Hexenkessel:15,Krallenkette:12,Lebensring:12,Alchimistenschale:15,"Scharlatanische Zauberkugel":15,Sippenchronik:15,Schelmenspielzeug:12,Zauberstecken:0,Magierstab:18,Trinkhorn:12,Schuppenbeutel:18,"Kristallomantische Kristallkugel":15,Echsenhaube:12};C.moneyNames={D:"Money-D",S:"Money-S",H:"Money-H",K:"Money-K"};C.areaTargetTypes={cube:"rect",line:"ray",sphere:"circle",cone:"cone"};C.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}};C.regnerationCampLocations={0:"regnerationCampLocations.normal","-1":"regnerationCampLocations.bad",1:"regnerationCampLocations.good"};C.regenerationInterruptOptions={0:"regenerationInterruptOptions.none","-1":"regenerationInterruptOptions.small","-2":"regenerationInterruptOptions.big"};C.targetMomevementOptions={0:"rangeMovementOptions.SLOW","-2":"rangeMovementOptions.FAST",2:"rangeMovementOptions.STATIONARY"};C.allowedforeignfields=["system.details.notes.value"];C.shooterMovementOptions={0:"rangeMovementOptions.SHOOTERSTATIONARY","-2":"rangeMovementOptions.SHOOTERMOVING","-4":"rangeMovementOptions.SHOOTERRUNNING"};C.mountedRangeOptionsSpecAb={STATIONARY:"0",SCHRITT:"0",TROT:"-5000",GALOPP:"-4"};C.mountedRangeOptions={STATIONARY:"0",SCHRITT:"-4",TROT:"-5000",GALOPP:"-8"};C.drivingArcherOptions={STATIONARY:"0",SCHRITT:"-2",GALOPP:"-4"};C.aimOptions={0:"aimOptions.0",2:"aimOptions.1",4:"aimOptions.2"};C.traitCategories={meleeAttack:"closeCombatAttacks",rangeAttack:"rangeCombatAttacks",armor:"armor",general:"general",familiar:"familiar",trick:"trick",training:"training",entity:"entityAbility",summoning:"summoningPackage"};C.ritualLocationModifiers={0:"-",1:"RITUALMODIFIER.holysite","-3":"RITUALMODIFIER.wrongsite"};C.ritualTimeModifiers={0:"-",1:"RITUALMODIFIER.matchingConstellation","-1":"RITUALMODIFIER.wrongConstellation"};C.ceremonyLocationModifiers={0:"-",2:"CEREMONYMODIFIER.holysite",1:"CEREMONYMODIFIER.temple","-1":"CEREMONYMODIFIER.otherTemple","-2":"CEREMONYMODIFIER.enemyGod","-3":"CEREMONYMODIFIER.archDemon","-4":"CEREMONYMODIFIER.nameless","-5":"CEREMONYMODIFIER.nemesis"};C.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,30,45,60,75,90,105,120,135,150,165,180]};C.hooks={};C.startXP={900:"EXP.inexperienced",1e3:"EXP.average",1100:"EXP.experienced",1200:"EXP.competent",1400:"EXP.masterful",1700:"EXP.brillant",2100:"EXP.legendary"};C.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /sp [a-z]*, /li [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk bet\xF6ren"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq bet\xF6ren"},{name:"threeD20Check",command:"/ch",example:"/ch"},{name:"groupcheck",command:"/gc",example:"/gc"}];C.ceremonyTimeModifiers={0:"-",1:"CEREMONYMODIFIER.monthGod",2:"CEREMONYMODIFIER.celebration","-5":"CEREMONYMODIFIER.namelessDays"};C.mageLevels={mundane:"mundane",clerical:"clerical",magical:"magical"};C.specialAbilityCategories={Combat:"SpecCategory.Combat",command:"SpecCategory.command",general:"SpecCategory.general",generalStyle:"SpecCategory.generalStyle",extGeneral:"SpecCategory.extGeneral",animal:"SpecCategory.animal",fatePoints:"SpecCategory.fatePoints",vampire:"SpecCategory.vampire",lykanthrop:"SpecCategory.lykanthrop",language:"SpecCategory.language",secret:"SpecCategory.secret",clerical:"SpecCategory.clerical",clericalStyle:"SpecCategory.clericalStyle",extClericalStyle:"SpecCategory.extClericalStyle",ceremonial:"SpecCategory.ceremonial",vision:"SpecCategory.vision",prayer:"SpecCategory.prayer",magical:"SpecCategory.magical",magicalStyle:"SpecCategory.magicalStyle",extMagical:"SpecCategory.extMagical",staff:"SpecCategory.staff",pact:"SpecCategory.pact",homunculus:"SpecCategory.homunculus"};C.sortedSpecs={combat:new Set(["Combat","command"]),magical:new Set(["magical","magicalStyle","extMagical","pact","homunculus"]),clerical:new Set(["clerical","clericalStyle","extClericalStyle","ceremonial","vision","prayer"]),unUsed:new Set(["staff"])};C.sortedSpecs.general=new Set(Object.keys(C.specialAbilityCategories).filter(l=>!Object.keys(C.sortedSpecs).some(e=>C.sortedSpecs[e].has(l))));C.addvantageRules={};C.removevantageRules={};C.vantagesNeedingAdaption={};C.addAbilityRules={};C.removeAbilityRules={};C.AbilitiesNeedingAdaption={};C.addTraitRules={};C.rangeWeaponModifiers={short:"RangeMod.short",medium:"RangeMod.medium",long:"RangeMod.long",rangesense:"RangeMod.rangesense",extreme:"RangeMod.extreme"};C.meleeRangesArray=["short","medium","long"];C.meleeRanges={short:"Range-short",medium:"Range-medium",long:"Range-long"};C.weapontypes={melee:"meleeweapon",range:"rangeweapon"};C.ammunitiongroups={"-":"-",arrow:"arrow",bolt:"bolt",bullet:"bullet",stone:"stone",dart:"dart",mag:"mag",infinite:"infinite"};C.combatskillsGuidevalues={ff:"CHAR.FF",ge:"CHAR.GE",kk:"CHAR.KK","ge/kk":"CHAR.GEKK"};C.skillDifficultyModifiers={eeasy:5,veasy:3,easy:1,challenging:0,difficult:-1,hard:-3,vhard:-5};C.magicResistanceModifiers={"-":"-",SK:"soulpower",ZK:"toughness"};C.sizeCategories={tiny:"SIZE.tiny",small:"SIZE.small",average:"SIZE.average",big:"SIZE.big",giant:"SIZE.giant"};C.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4};C.rangeSizeCategories={tiny:"RANGESIZE.tiny",small:"RANGESIZE.small",average:"RANGESIZE.average",big:"RANGESIZE.big",giant:"RANGESIZE.giant"},C.meleeSizeCategories={tiny:"MELEESIZE.tiny",small:"MELEESIZE.small",average:"MELEESIZE.average",big:"MELEESIZE.big",giant:"MELEESIZE.giant"};C.shieldSizes={short:"SIZE.small",medium:"SIZE.average",long:"SIZE.big"};C.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8};C.meleeSizeModifier={tiny:-4,small:0,average:0,big:0,giant:0};C.rangeVision={0:"VisionDisruption.step0","-2":"VisionDisruption.step1","-4":"VisionDisruption.step2","-6":"VisionDisruption.step3","-5000":"VisionDisruption.step4"};C.meleeRangeVision=l=>({"+0":"meleeVisionDisruption.0","-1":"meleeVisionDisruption.1","-2":"meleeVisionDisruption.2","-3":"meleeVisionDisruption.3",[l=="attack"?"*0,5":"-5000"]:"meleeVisionDisruption.4"});C.attributeDifficultyModifiers={eeasy:6,veasy:4,easy:2,challenging:0,difficult:-2,hard:-4,vhard:-6};C.skillDifficultyLabels={eeasy:"Skill-eeasy",veasy:"Skill-veasy",easy:"Skill-easy",challenging:"Skill-challenging",difficult:"Skill-difficult",hard:"Skill-hard",vhard:"Skill-vhard"};C.attributeDifficultyLabels={eeasy:"Attribute-eeasy",veasy:"Attribute-veasy",easy:"Attribute-easy",challenging:"Attribute-challenging",difficult:"Attribute-difficult",hard:"Attribute-hard",vhard:"Attribute-vhard"};C.skillGroups={body:"SKILL.body",social:"SKILL.social",knowledge:"SKILL.knowledge",trade:"SKILL.trade",nature:"SKILL.nature"};C.features=["Object","Spheres","Influence","Clairvoyance","Healing","Transformation","Telekinesis","Elemental","Illusion","Anti-Magic","Demonic","Temporal"];C.skillBurdens={yes:"yes",no:"no",maybe:"maybe"};C.StFs={A:"A",B:"B",C:"C",D:"D"};C.noteIcons={"Griffin Shield":"systems/dsa5/icons/thirdparty/griffinshield.svg","At Sea":"systems/dsa5/icons/thirdparty/at-sea.svg","Medieval Gate":"systems/dsa5/icons/thirdparty/medieval-gate.svg","Position Marker":"systems/dsa5/icons/thirdparty/position-marker.svg",River:"systems/dsa5/icons/thirdparty/river.svg",Trail:"systems/dsa5/icons/thirdparty/trail.svg"};CONFIG.time.roundTime=5;CONFIG.time.turnTime=0;var y=C;function ai(l,e=320,t=40){l.attr({width:e*.8,viewBox:`0 0 ${e} ${t}`});let a=l.find("text"),s=a.get(0).getBBox(),i=e/s.width,r=t/s.height,n=i<r,o=n?i:r;isFinite(o)&&a.attr({transform:"matrix("+o+", 0, 0, "+o+", 0,0)",x:Math.max(0,(e-s.width)/2),y:t*.75/(n?1:o)})}function Ut(l){return new Promise(e=>setTimeout(e,l))}async function Pe(l,e,t=!0){let a,s;l.type=="Actor"?(a=await Actor.implementation.fromDropData(l),s=e===a.id):(a=await Item.implementation.fromDropData(l),s=e===a.parent?.uuid);let i=a?.type;return t&&(a=a.toObject()),l.amount&&(a.system.quantity.value=Number(l.amount)),{item:a,typeClass:i,selfTarget:s}}function Vt(l,e,t,a="div"){if(e=l.find(e)[0],!e)return;e.classList.add("slist");let s=e.querySelectorAll(a),i=null;for(let r of s)r.draggable=!0,r.addEventListener("dragstart",function(n){i=this}),r.addEventListener("dragover",function(n){n.preventDefault()}),r.addEventListener("drop",async function(n){if(n.preventDefault(),this!=i){let o=0,c=0;for(let m=0;m<s.length;m++)i==s[m]&&(o=m),this==s[m]&&(c=m);o<c?this.parentNode.insertBefore(i,this.nextSibling):this.parentNode.insertBefore(i,this),await t(e)}})}function me(l){let e=$(".tinyNotifications");e.length||($("body").append('<ul class="tinyNotifications"></ul>'),e=$(".tinyNotifications"));let t=$(`<li>${l}</li>`);e.prepend(t),setTimeout(function(){t.remove()},1500)}function Wt(l,e,t,a){let s=Math.ceil(e.scrollLeft),i=e.scrollWidth-e.clientWidth;t.style.display=s>0?"block":"none",a.style.display=i>s?"block":"none",Ni(l)}async function rt(l){let e=$(l.currentTarget).closest(".searchableAbility")[0].dataset.category.split(" "),t=l.currentTarget.text.replace(/\d+$/,"").trim();for(let a of e){let i=(await game.dsa5.itemLibrary.findCompendiumItem(t,a)).find(r=>r.name==t);if(i){i.sheet.render(!0);return}}if(/\(/.test(t)){t=t.split("(")[0].trim()+" ()";for(let a of e){let i=(await game.dsa5.itemLibrary.findCompendiumItem(t,a)).find(r=>r.name==t);if(i){i.sheet.render(!0);return}}}}function Ni(l){let e=l.width(),t=Number(getComputedStyle(document.body).getPropertyValue("--minColumnWidth").replace("px","")),a=Number(getComputedStyle(document.body).getPropertyValue("--minColumnWidth60").replace("px","")),s=6;e>=t*2+s?l.removeClass("singleColumnLayout"):l.addClass("singleColumnLayout"),e<=a?l.addClass("minimumColumnLayout"):l.removeClass("minimumColumnLayout")}function se(l){let e=l.find(".navWrapper");for(let t of e){let a=t.querySelector(".left-btn"),s=t.querySelector(".right-btn"),i=t.querySelector(".sheet-tabs"),r=!1;s.addEventListener("click",()=>{i.scrollLeft+=150,setTimeout(()=>Wt(l,i,a,s),500)}),a.addEventListener("click",()=>{i.scrollLeft-=150,setTimeout(()=>Wt(l,i,a,s),500)}),new ResizeObserver(()=>Wt(l,i,a,s)).observe(t),i.addEventListener("mousemove",n=>{!r||(i.scrollLeft-=n.movementX,setTimeout(()=>Wt(l,i,a,s),500))}),i.addEventListener("mousedown",()=>{r=!0,i.classList.add("dragging"),document.addEventListener("mouseup",()=>{r=!1,i.classList.remove("dragging")},{once:!0})})}}var si=()=>{document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)};window.addEventListener("resize",si);si();async function Li(){if(!game.settings.get("dsa5","defaultConfigFinished")){console.log("Configuring default token settings");let l=game.settings.get("core","defaultToken");l.displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,l.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,l.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,l.bar1={attribute:"status.wounds"},await game.settings.set("core","defaultToken",l),await game.settings.set("core","leftClickRelease",!0),await game.settings.set("dsa5","defaultConfigFinished",!0)}}async function Ri(l,e){await wt(),l<24&&await _i(),await game.settings.set("dsa5","migrationVersion",e)}async function _i(){for(let l of game.actors){let e=l.effects.filter(t=>["inpain","encumbered"].includes(t.getFlag("core","statusId")));e.length&&await l.deleteEmbeddedDocuments("ActiveEffect",e.map(t=>t.id))}}async function wt(){let e=await(await fetch("systems/dsa5/lazy/updatenotes.json")).json();new na(e).render(!0)}function oa(){Hooks.once("ready",async function(){if(!game.user.isGM)return;await Li();let l=await game.settings.get("dsa5","migrationVersion"),e=26;l<e&&Ri(l,e)})}var na=class extends Application{constructor(e,t){super(t),this.json=e,this.versionIndex=3}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsa5/templates/system/patchviewer.html",e.resizable=!0,e}activateListeners(e){super.activateListeners(e),se(e),e.find(".showMore").click(t=>this.showMore(e))}async showMore(e){let t=[this.json.notes[this.json.notes.length-this.versionIndex]];if(t[0].version=="2.3.0"){e.find(".showMore").hide();return}let a=await this.fetchVersions(t);e.find(".changelogsection").append(a.changelog[0]),e.find(".newssection").append(a.news[0]),this.versionIndex+=1}async fetchVersions(e){let t=game.i18n.lang,a=await Promise.all(e.map(async i=>await renderTemplate(`systems/dsa5/lazy/patchhtml/changelog_${t}_${i.version}.html`))),s=await Promise.all(e.map(async i=>await renderTemplate(`systems/dsa5/lazy/patchhtml/news_${t}_${i.version}.html`)));return{changelog:a,news:s}}async getData(){let e=this.json.notes[this.json.notes.length-1],t=this.json.default.replace(/VERSION/g,e.version),a=`<h1>CHANGELOG</h1><p>${t}. </br><b>Important updates</b>: ${e.text}</p><p>For details or proposals visit our wiki page at <a href="https://github.com/Plushtoast/dsa5-foundryVTT/wiki" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>`;await ChatMessage.create(g.chatDataSetup(a,"roll"));let s=game.i18n.lang,i=await this.fetchVersions([e]),r=[this.json.notes[this.json.notes.length-2]],n=await this.fetchVersions(r),o=await renderTemplate(`systems/dsa5/lazy/patchhtml/modules_${s}.html`);return{patchName:t,changelog:i.changelog[0],news:i.news[0],prevVersions:r,prevChangeLogs:n.changelog,prevNews:n.news,modules:o}}};var la=class{static getTalentBonus(e,t,a){let s=[],i=game.settings.get("dsa5","talentModifierEnabled");for(let r of e.items.filter(n=>a.includes(n.type)&&n.system.effect.value.includes(t)))for(let n of r.system.effect.value.split(/;|,/))if(n.includes(t)){let o=g.parseAbilityString(n.trim());o.name==t&&s.push({name:r.name,value:o.step*(r.system.step?r.system.step.value:1),type:o.type,selected:i,source:r.name})}return s}static async stepXPCost(e,t){let a=e.system.APValue.value;return/;/.test(a)&&(a=a.split(";").map(i=>Number(i.trim()))[t]),Number(a)}static calcAPCostSum(e){let t=Number(e.system.APValue.value)*(Number(e.system.step.value)||1);if(/;/.test(e.system.APValue.value)){let a=e.system.APValue.value.split(";").map(s=>Number(s.trim()));t=0;for(let s=0;s<e.system.step.value;s++)t+=a[s]}return t}static simpleAdoption(e,t,a,s){if(s[a].effect&&(e.system.effect.value=`${t.name} ${s[a].effect}`),s[a].activeEffect){let i=duplicate(s[a].activeEffect);i.value=`${t.name} ${i.value}`;let r={changes:[i],duration:{},icon:"icons/svg/aura.svg",name:`${a} (${t.name})`,transfer:!0,flags:{dsa5:{description:`${a} (${t.name})`,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(r)}}static reverseAdoptionCalculation(e,t,a){let s=[y.vantagesNeedingAdaption,y.AbilitiesNeedingAdaption];for(let i of s)if(i[t.name]){let r=e.items.find(n=>i[t.name].items.includes(n.type)&&n.name==t.special);r&&(a.system.APValue.value=a.system.APValue.value?a.system.APValue.value.split("/")[r.system.StF.value.charCodeAt(0)-65]:0,la.simpleAdoption(a,r,t.name,i));break}return a}static hasItem(e,t,a){return e.items.find(s=>a.includes(s.type)&&s.name==t)!=null}static itemStep(e,t,a){let s=e.items.find(i=>a.includes(i.type)&&i.name==t);return s?Number(s.system.step.value):0}static itemAsModifier(e,t,a,s,i=!1,r=!1){let n=[],o=i?new RegExp(`^${g.escapeRegex(`${t} (`)}`):new RegExp(`^${g.escapeRegex(t)}$`),c=e.items.find(m=>s.includes(m.type)&&o.test(m.name));return c&&n.push({name:c.name,value:Number(c.system.step.value)*a,selected:r,source:c.name}),n}},Q=la;R(Q,"children",{});var We=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find(".select2").select2()}};var N=class extends Q{static setupFunctions(){}static async abilityAdded(e,t){y.addAbilityRules[t.name]&&y.addAbilityRules[t.name](e,t)}static async abilityRemoved(e,t,a=!0){y.removeAbilityRules[t.name]&&y.removeAbilityRules[t.name](e,t);let s=N.calcAPCostSum(t);s=await N.refundFreelanguage(t,e,s,a),await e._updateAPs(-1*s,{},{render:a})}static async _specialabilityReturnFunction(e,t,a,s){if(t==null)return;if(t=duplicate(t),s!=null){if(/,/.test(t.system.APValue.value)){let r=`${t.name.replace(" ()","")} (${s.name}`;t.system.APValue.value=t.system.APValue.value.split(",")[e.items.filter(n=>n.type==t.type&&n.name.includes(r)).length].trim()}N.simpleAdoption(t,s,t.name,y.AbilitiesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${s.name}${s.customEntry?", "+s.customEntry:""})`,s.system&&s.system.StF?.value&&/\//.test(t.system.APValue.value)&&(t.system.APValue.value=t.system.APValue.value.split("/")[s.system.StF.value.charCodeAt(0)-65].trim())}let i=e.items.find(r=>r.type==a&&r.name==t.name);if(i){let r=duplicate(i),n=await N.isFreeLanguage(t,e,/;/.test(r.system.APValue.value)?r.system.APValue.value.split(";").map(o=>Number(o.trim()))[r.system.step.value]:r.system.APValue.value,!1);r.system.step.value+1<=r.system.maxRank.value&&await e.checkEnoughXP(n)&&(r.system.step.value+=1,await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[r]),await N.abilityAdded(e,r))}else{let r=await N.isFreeLanguage(t,e,t.system.APValue.value.split(";").map(n=>n.trim())[0],!1);await e.checkEnoughXP(r)&&(await N.abilityAdded(e,t),await e._updateAPs(r,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}}static async refundFreelanguage(e,t,a,s=!0){if(e.system.category.value=="language"&&t.system.freeLanguagePoints){let i=Number(t.system.freeLanguagePoints.value),r=t.items.filter(c=>c.type=="specialability"&&c.system.category.value=="language").reduce((c,m)=>c+Number(m.system.step.value)*Number(m.system.APValue.value),0),n=Math.min(i,r-Number(a)),o=Math.max(0,i-n);await t.update({"system.freeLanguagePoints.used":Math.min(i,Number(n))},{render:s}),a=Math.max(0,a-o)}return a}static async isFreeLanguage(e,t,a,s=!0){if(e.system.category.value=="language"&&t.system.freeLanguagePoints){let i=Number(t.system.freeLanguagePoints.value),r=t.items.filter(c=>c.type=="specialability"&&c.system.category.value=="language").reduce((c,m)=>c+Number(m.system.step.value)*Number(m.system.APValue.value),0),n=Math.min(i,r),o=Math.max(0,i-n);await t.update({"system.freeLanguagePoints.used":Math.min(i,Number(n)+Number(a))},{render:s}),a=Math.max(0,a-o)}return a}static async needsAdoption(e,t,a){let s=y.AbilitiesNeedingAdaption[t.name];if(s){let i,r;if(s.items=="text")i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:t}),r=function(n){let o={name:n.find('[name="entryselection"]').val()};N._specialabilityReturnFunction(e,t,a,o)};else if(s.items=="array"){let n=s.elems.map(o=>({name:o}));i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:s.area}),r=function(o){let c=n.find(m=>m.name==o.find('[name="entryselection"]').val());N._specialabilityReturnFunction(e,t,a,c)}}else{let n=e.items.filter(o=>s.items.includes(o.type)).sort((o,c)=>o.name.localeCompare(c.name));i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:s.area}),r=function(o){let c=n.find(m=>m.name==o.find('[name="entryselection"]').val());c.customEntry=o.find('[name="custom"]').val(),N._specialabilityReturnFunction(e,t,a,c)}}await new We({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:r},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else N._specialabilityReturnFunction(e,t,a,null)}static hasAbility(e,t){return super.hasItem(e,t,["specialability"])}static abilityStep(e,t){return super.itemStep(e,t,["specialability"])}static abilityAsModifier(e,t,a=1,s=!1){return super.itemAsModifier(e,t,a,["specialability"],s)}};Q.children.SpecialabilityRulesDSA5=N;var vt=class{static multipleDefenseValue(e,t){let a=-3;return(t.type=="dodge"||getProperty(t,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle"))&&N.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulDodge"))?a=-2:N.hasAbility(e,game.i18n.localize("LocalizedIDs.mightyMasterfulParry"))?a=-1:N.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulParry"))&&(a=-2),N.hasAbility(e,game.i18n.localize("LocalizedIDs.vinsaltStyle"))&&(a-=1),Math.min(0,a)}static async bleedingMessage(e){await ChatMessage.create(g.chatDataSetup(game.i18n.format("CHATNOTIFICATION.applyBleeding",{actor:e.name,actorId:e.id,tokenId:e.token?e.token.id:""})))}static isShield(e){return game.i18n.localize("LocalizedIDs.Shields")==getProperty(e,"system.combatskill.value")}static _getFunctionData(e){return{data:e.currentTarget.dataset,actor:g.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}static quantityClick(e){let t=e.currentTarget.dataset.quantityfocus,a=$(e.currentTarget);if(t&&!a.is(":focus")){setTimeout(function(){a.select()});return}let s={val:Number(a.val())};vt.increment(e,s,"val"),a.val(s.val)}static getGroupSchips(){let e=game.settings.get("dsa5","groupschips").split("/").map(a=>Number(a)),t=[];for(let a=1;a<=e[1];a++)t.push({value:a,cssClass:a<=e[0]?"fullSchip":"emptySchip"});return t}static ensureNumber(e){e.system.AsPCost.value=Number(e.system.AsPCost.value)||e.system.AsPCost.value}static isYieldedTwohanded(e){let t=this.regex2h.test(e.name),a=e.system.worn.wrongGrip;return t&&!a||!t&&a}static obfuscateDropData(e,t){if(t)for(let a of t)mergeObject(e,{system:{obfuscation:{[a]:!0}}})}static _buildDuration(e){let t={duration:{startTime:game.time.worldTime,rounds:e,seconds:e*5}};return game.combat&&mergeObject(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}static async calcBleeding(e){let{data:t,actor:a}=vt._getFunctionData(e);if(!a)return;let s=a.items.find(i=>i.name==game.i18n.localize("LocalizedIDs.selfControl")&&i.type=="skill");a.setupSkill(s,{},t.token).then(async i=>{let r=await a.basicTest(i);if(r.result.successLevel<2){let n=r.result.qualityStep||0,o=7;r.result.successLevel==1?o-=Number(n):r.successLevel<1&&(o+=o);let c=a.hasCondition("bleeding"),m=vt._buildDuration(o);if(c){let d=game.combat?(c.data.duration.startRound||1)+c.data.duration.rounds-game.combat.round:c.data.duration.rounds;o>d&&await c.update(m)}else{let d=duplicate(CONFIG.statusEffects.find(u=>u.id=="bleeding"));mergeObject(d,m),await I.addCondition(a,d,1,!1,!0),await ChatMessage.create(g.chatDataSetup(game.i18n.format("CHATNOTIFICATION.gotBleeding",{actor:a.name})))}}})}static increment(e,t,a,s=void 0){let i=e.ctrlKey?10:1,r=e.button==2?-1:1,n=getProperty(t,a)+i*r;return s!=null&&(n=Math.max(s,n)),setProperty(t,a,n),n}static magicalImprovement(e,t){for(let a of e.items)["ritual","spell"].includes(a.type)&&(a.system.talentValue.value+=4)}},_=vt;R(_,"regex2h",/\(2H/);function ii(){Hooks.on("getImagePopoutHeaderButtons",(l,e)=>{e.unshift({class:"posttochat",icon:"fas fa-comment",onclick:async()=>Hi(l)})})}async function Hi(l){let e=l.object,t=await renderTemplate("systems/dsa5/templates/chat/imagetochat.html",{image:e});ChatMessage.create(g.chatDataSetup(t))}function ri(l){let e=l.currentTarget.dataset;g.showArtwork(e,!1)}var Z=class{static chatListeners(e){e.on("click",".openJournalBrowser",()=>game.dsa5.apps.journalBrowser.render(!0));let t=$('<a class="button showHelp" data-tooltip="HELP.showHelp"><i class="fas fa-question"></i></a>');t.click(()=>{Z.getHelp()}),$(e.find(".control-buttons")).prepend(t),e.on("click",".showPatchViewer",()=>wt()),e.on("click",".functionswitch",a=>_[a.currentTarget.dataset.function](a)),e.on("click",".panToToken",a=>Z.panToToken(a)),e.on("click",".popoutImage",a=>ri(a))}static async panToToken(e){let t=await fromUuid(e.currentTarget.dataset.uuid);!t||(canvas.animatePan({x:t.x,y:t.y}),t.isOwner&&t.object.control({releaseOthers:!0}))}static postStatus(e){let t=CONFIG.statusEffects.find(s=>s.id==e),a=`<h2><a class="chat-condition chatButton" data-id="${e}"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="${t.icon}"/>${game.i18n.localize(t.name)}</h2></a><p>${game.i18n.localize(t.description)}</p>`;ChatMessage.create(g.chatDataSetup(a,"roll"))}static getHelp(){let e=y.helpContent.map(t=>`<h2>${game.i18n.localize(`HELP.${t.name}`)}</h2>
            <p><b>${game.i18n.localize("HELP.command")}</b>: ${t.command}</p>
            <p><b>${game.i18n.localize("HELP.example")}</b>: ${t.example}</p>
            <p><b>${game.i18n.localize("Description")}</b>: ${game.i18n.localize(`HELP.descr${t.name}`)}`).join("")+`<br>
            <p>${game.i18n.localize("HELP.default")}</p>`;ChatMessage.create(g.chatDataSetup(e,"roll"))}static showConditions(){let t=duplicate(CONFIG.statusEffects).map(a=>(a.name=game.i18n.localize(a.name),a)).sort((a,s)=>a.name.localeCompare(s.name)).map(a=>`<a class="chat-condition chatButton" data-id="${a.id}"><img src="${a.icon}"/>${a.name}</a>`).join(" ");ChatMessage.create(g.chatDataSetup(t,"roll"))}static async check3D20(e,t,a={}){let s=12;e?(e=e.get(0),t=await g.skillByName(e.textContent),e.dataset.attrs&&(s=e.dataset.attrs.split("|"))):t&&(t=await g.skillByName(t)),t&&(t=t.toObject()),t||(t={name:"3d20",type:"skill",system:{talentValue:{value:0},characteristic1:{value:"mu"},characteristic2:{value:"kl"},characteristic3:{value:"in"},RPr:{value:"no"},burden:{value:"no"}}});let i=await g.emptyActor(s);i.setupSkill(t,a,"emptyActor").then(r=>{i.basicTest(r)})}static async showTables(){let e=await renderTemplate("systems/dsa5/templates/tables/systemtables.html",{tables:y.systemTables});ChatMessage.create(g.chatDataSetup(e,"roll"))}};Hooks.once("i18nInit",async()=>{if(!M.creatureData){let l=await fetch(`systems/dsa5/lazy/creaturetype/${game.i18n.lang}.json`);M.creatureData=await l.json(),M.magical=game.i18n.localize("WEAPON.magical"),M.clerical=game.i18n.localize("WEAPON.clerical"),M.silverPlated=game.i18n.localize("WEAPON.silverPlated"),game.dsa5.apps.CreatureType=M}});var ji=l=>!(!l||l.length===0),re=class{constructor(e){this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}static detectCreatureType(e){let t=e.type=="creature"?e.system.creatureClass.value:e.system.details.species.value;return Object.keys(re.creatureData.types).filter(s=>t.indexOf(s)>=0).map(s=>this.getClass(re.creatureData.types[s],t))}static getClass(e,t){let a={DemonType:ua,ChimeraType:ca,DaimonidType:da,DragonType:ma,ElementalType:pa,FairyType:ga,GhostType:fa,GolemType:ha,HomunculiType:ya,IntelligentCreatureType:ba,PlantType:ka,AnimalType:wa,UndeadType:va,SupernaturalType:Ta,MagicalConstructType:Sa,WerCreatureType:Ca,VampireType:Da}[e];return new a(t)}getName(){return Object.keys(re.creatureData.types).find(e=>re.creatureData.types[e]==this.constructor.name)}static checkImmunity(e){let t=[];switch(e.preData.source.type){case"poison":case"disease":{let a=game.i18n.localize("LocalizedIDs.immuneTo")+" ("+e.preData.source.name+")";for(let s of game.user.targets){let i=s.actor,r=i.items.find(n=>n.name==a&&n.type=="advantage");if(r)t.push({name:r.name,uuid:r.uuid,target:i.name,condition:e.preData.source.name});else{let n=re.detectCreatureType(s.actor);for(let o of n)if(o[`${e.preData.source.type}Immunity`]){t.push({name:e.preData.source.name,target:`${i.name} (${o.getName()})`,condition:e.preData.source.name});break}}}break}case"spell":case"ritual":{for(let a of game.user.targets){let s=re.detectCreatureType(a.actor),i=e.preData.source.system.feature.split(",").map(n=>n.trim()),r=!1;for(let n of s){for(let o of i)if(n.spellImmunities.includes(o)){t.push({name:e.preData.source.name,target:`${a.actor.name} (${n.getName()})`,condition:`${game.i18n.localize("feature")} ${o}`}),r=!0;break}if(r)break}}break}}return t}static creatureTypeName(e){if(e.type=="creature"){let t=e.system.creatureClass.value;return Object.keys(re.creatureData.types).filter(a=>t.indexOf(a)>=0)[0]}else return e.system.details.species.value}static addCreatureTypeModifiers(e,t,a,s){let i=re.detectCreatureType(e),r=["spell","ceremony","liturgy","ritual"].includes(t.type);for(let n of i){let o=n.damageModifier(t);if(r)for(let c of o)c.armorPen=n.spellResistanceModifier(e);a.push(...o)}a.push(...this.creatureBonusDamage(e,s)),re.addVulnerabilitiesToSource(e,t,a)}static addVulnerabilitiesToSource(e,t,a){let s=getProperty(e,"system.vulnerabilities");s&&["meleeweapon","rangeweapon"].includes(t.type)&&getProperty(s,"combatskill").reduce((r,n)=>{if(n.target==t.system.combatskill.value){let c=(/\*/.test(n.value)?Number(n.value.replace("*",""))>1:Number(n.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";a.push(...re.buildDamageMod(`${game.i18n.format(c,{name:t.system.combatskill.value})} (${n.source})`,n.value))}},a)}ignoredCondition(e){return!1}damageModifier(e){return[]}static creatureBonusDamage(e,t){let a=[],s=e.type=="creature"?e.system.creatureClass.value:e.system.details.species.value,i=getProperty(t,"system.creatureBonus");for(let r of i)s.indexOf(r.target)>=0&&a.push(...this.buildDamageMod(r.source,r.value,!0));return a}spellImmunity(e){return this.spellImmunities.some(t=>e.includes(t))}spellArmorModifier(e){return 0}poisonImmunity(){return this.poisonImmunity}diseaseImmunity(){return this.diseaseImmunity}spellResistanceModifier(e){return 0}static buildDamageMod(e,t,a=!0){return[{name:e,value:t,selected:a,type:"dmg",source:game.i18n.localize("target")}]}weaponAttributes(e){return getProperty(e,"system.effect.attributes")||""}getTypeByClass(e){return Object.keys(re.creatureData.types).find(t=>re.creatureData.types[t]===e)}isAttackItem(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&ji(this.weaponAttributes(e))}attributesRegex(e){let t=this.weaponAttributes(e);return new RegExp(`(${t.split(",").map(a=>g.escapeRegex(a.split("(")[0].trim())).join("|")})`,"i")}},M=re;R(M,"creatureData"),R(M,"magical"),R(M,"clerical");var Tt=class extends M{damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfLife){let s=`${M.clerical} (${a})`;if(t.test(s))return M.buildDamageMod(s,"*2")}}return super.damageModifier(e)}},ca=class extends Tt{},da=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation"].map(t=>game.i18n.localize(`Features.${t}`))}damageModifier(e){return this.isAttackItem(e)&&this.attributesRegex(e).test(M.clerical)?M.buildDamageMod(M.clerical,"*2"):super.damageModifier(e)}},ma=class extends M{},ua=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Transformation","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);if(t.test(M.clerical))return M.buildDamageMod(`${M.clerical} (${M.creatureData.opposingGod})`,"*2",!1);if(t.test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}spellArmorModifier(e){return Number(e.system.status.soulpower.max)}spellResistanceModifier(e){return Number(e.system.status.soulpower.max)}ignoredCondition(e){return!0}},pa=class extends M{constructor(e){super(e),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return M.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}spellArmorModifier(e){return Number(e.system.status.soulpower.max)}spellResistanceModifier(e){return Number(e.system.status.soulpower.max)}ignoredCondition(e){return!0}},ga=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}},fa=class extends M{constructor(e){super(e),this.spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfDeath){let s=`${M.clerical} (${a})`;if(t.test(s))return[]}if(t=this.attributesRegex(e),t.test(M.clerical))return M.buildDamageMod(M.clerical,"*0.5");if(t.test(M.magical))return M.buildDamageMod(M.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return M.buildDamageMod(M.magical,"*0.5");return M.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}ignoredCondition(e){return!["feared","inpain","confused"].includes(e)}},ha=class extends Tt{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["confused","paralysed"].includes(e)}},ya=class extends Tt{constructor(e){super(e),this.spellImmunities=["Healing"].map(t=>game.i18n.localize(`Features.${t}`))}ignoredCondition(e){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(e)}},ba=class extends M{},ka=class extends M{},wa=class extends M{},va=class extends M{constructor(e){super(e),this.spellImmunities=["Influence","Healing","Illusion"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(let a of M.creatureData.godOfDeath){let s=`${M.clerical} (${a})`;if(t.test(s))return M.buildDamageMod(s,"*2")}}return super.damageModifier(e)}ignoredCondition(e){return!["paralysed"].includes(e)}},Ta=class extends M{},Sa=class extends M{constructor(e){super(e),this.spellImmunities=["Transformation"].map(t=>game.i18n.localize(`Features.${t}`)),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["stunned","feared","paralysed","confused"].includes(e)}},Ca=class extends M{damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(M.silverPlated))return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return M.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}},Da=class extends M{damageModifier(e){return["spell","ceremony","liturgy","ritual"].includes(e.type)?super.damageModifier(e):M.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}};var I=class{static bindButtons(e){e.find(".chat-condition").each(function(t,a){a.setAttribute("draggable",!0),a.addEventListener("dragstart",s=>{let i={data:{type:"condition",payload:{id:s.currentTarget.dataset.id}}};s.dataTransfer.setData("text/plain",JSON.stringify(i))})}),e.on("click",".chat-condition",t=>Z.postStatus(t.currentTarget.dataset.id))}static createCustomEffect(e,t="",a){a=a||game.i18n.localize("CONDITION.custom"),t==""&&(t=a),e.addCondition({name:a,icon:"icons/svg/aura.svg",origin:e.uuid,flags:{dsa5:{description:t}}})}static prepareActiveEffects(e,t){let a=duplicate(CONFIG.statusEffects),s=[];t.conditions=[],t.transferedConditions=[];let i;e.documentName=="Item"?i=e.effects:(i=Array.from(e.allApplicableEffects()),game.user.isGM||(i=i.filter(n=>!n.getFlag("dsa5","hidePlayers"))));for(let n of i){let o=n.toObject();o.boolean=n.getFlag("dsa5","value")==null;let c=[...n.statuses][0];c&&(o.value=n.getFlag("dsa5","value"),o.editable=n.getFlag("dsa5","editable"),o.descriptor=c,o.manual=n.getFlag("dsa5","manual"),s.push(c)),e.documentName=="Item"||n.parent?.documentName!="Item"&&!n.notApplicable?t.conditions.push(o):n.notApplicable||(o.uuid=n.uuid,o.parent={uuid:n.parent?.uuid,name:n.parent?.name},t.transferedConditions.push(o))}t.manualConditions=a.filter(n=>!s.includes(n.id));let r=[];for(let n of Object.keys(e.system?.condition||{}))if(e.system.condition[n]){let o=y.statusEffects.find(c=>c.id==n);o&&r.push({icon:o.icon,id:n,name:game.i18n.localize(o.name),value:e.system.condition[n]})}t.cumulativeConditions=r}static async addCondition(e,t,a=1,s=!1,i=!0){if(!e.isOwner)return"Not owned";if(e.compendium)return"Can not add in compendium";if(s&&a<1)return this.removeCondition(e,t,a,i,s);if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(n=>n.id==t))),!t)return"No Effect Found";let r=this.hasCondition(e,t.id);return r&&r.flags.dsa5.value==null?r:r?await I.updateEffect(e,r,a,s,i,t):await I.createEffect(e,t,a,i)}static hasCondition(e,t){return e!=null&&t&&e.effects?e.effects.find(a=>a.statuses.has(t)):!1}static async removeCondition(e,t,a=1,s=!0,i=!1){if(!e.isOwner)return"Not owned";if(typeof t=="string"&&(t=duplicate(CONFIG.statusEffects.find(n=>n.id==t))),!t)return"No Effect Found";let r=this.hasCondition(e,t.id);if(r&&r.flags.dsa5.value==null)return e.token&&(e=e.token.actor),await e.deleteEmbeddedDocuments("ActiveEffect",[r.id]);if(r)return await I.removeEffect(e,r,a,i,s)}static immuneToEffect(e,t,a=!0){if(!t.id||!hasProperty(t,"flags.dsa5.max"))return;let s=getProperty(e,"system.immunities")||[],i;if(s.includes(t.id)&&(i={name:e.name,condition:game.i18n.localize(`CONDITION.${t.id}`)}),!i&&e.documentName=="Actor"){let n=M.detectCreatureType(e);for(let o of n)if(o.ignoredCondition(t.id)){i={name:`${e.name} (${o.getName()})`,condition:game.i18n.localize(`CONDITION.${t.id}`)};break}}if(!i||!(ui.notifications&&!a))return;let r=game.i18n.format("DSAError.conditionInvalidToCreature",{name:i.name,condition:i.condition});ui.notifications.warn(r)}static resistantToEffect(e,t){let a=[...t.statuses][0];return a?(getProperty(e,"system.resistances.effects")||[]).reduce((i,r)=>(r.target==a&&(i+=Number(r.value)),i),0):0}static async createEffect(e,t,a,s){t.name=game.i18n.localize(t.name),this.immuneToEffect(e,t,!1),s?(t.flags.dsa5.auto=Math.min(t.flags.dsa5.max,a),t.flags.dsa5.manual=0):(t.flags.dsa5.manual=Math.min(t.flags.dsa5.max,a),t.flags.dsa5.auto=0),t.flags.dsa5.value=Math.min(4,t.flags.dsa5.manual+t.flags.dsa5.auto),t.id&&(t.statuses=[t.id]),t.id=="dead"&&(t["flags.core.overlay"]=!0);let i=duplicate(t);(game.dsa5.config.statusEffectClasses[t.id]||I).levelDependentEffects(t,i);let r=await e.createEmbeddedDocuments("ActiveEffect",[i]);return delete t.id,r}static async removeEffect(e,t,a,s,i){let r=i?s?a:Math.max(0,t.flags.dsa5.auto-a):t.flags.dsa5.auto,n=i?t.flags.dsa5.manual:s?a:t.flags.dsa5.manual-a,o={flags:{dsa5:{auto:r,manual:n,value:Math.max(0,Math.min(t.flags.dsa5.max,n+r))}}};return o.flags.dsa5.auto<1&&o.flags.dsa5.manual==0?await e.deleteEmbeddedDocuments("ActiveEffect",[t.id]):((game.dsa5.config.statusEffectClasses[[...t.statuses][0]]||I).levelDependentEffects(t,o),await t.update(o))}static async levelDependentEffects(e,t){}static async updateEffect(e,t,a,s,i,r=void 0){this.immuneToEffect(e,t,!0);let n,o,c;return i?(o=Math.min(t.flags.dsa5.max,s?a:t.flags.dsa5.auto+a),n=o-t.flags.dsa5.auto,c={flags:{dsa5:{auto:o,manual:t.flags.dsa5.manual}}}):(o=s?a:t.flags.dsa5.manual+a,n=o-t.flags.dsa5.manual,c={flags:{dsa5:{manual:o,auto:t.flags.dsa5.auto}}}),n==0||(c.flags.dsa5.value=Math.max(0,Math.min(t.flags.dsa5.max,c.flags.dsa5.manual+c.flags.dsa5.auto)),r.duration&&(c.duration=r.duration,c.duration.startTime=game.time.worldTime),(game.dsa5.config.statusEffectClasses[[...t.statuses][0]]||I).levelDependentEffects(t,c),await t.update(c)),t}static calculateRollModifier(e,t,a,s={}){return e.flags.dsa5.value==null||a.type=="regenerate"?0:I.clampedCondition(t,e)}static clampedCondition(e,t){let a=[...t.statuses][0];if(!a)return 0;let s=Number(t.flags.dsa5.max),i=Math.clamped(e.system.condition[a]||0,0,s)*-1,r=this.resistantToEffect(e,t);return Math.clamped(i+r,-1*s,0)}static ModifierIsSelected(e,t={},a){return t.mode!="damage"}static getDamageBonus(){return 0}static getRollModifiers(e,t,a={}){let s=game.i18n.localize("status")+"/"+game.i18n.localize("condition"),i=[],r=[];for(let c of e.effects){if(c.disabled)continue;let m=[...c.statuses][0],d=game.dsa5.config.statusEffectClasses[m]||I,u=d.calculateRollModifier(c,e,t,a);m&&r.push(m),u!=0&&i.push({name:c.name,value:u,selected:d.ModifierIsSelected(t,a,e),source:s})}for(let[c,m]of Object.entries(e.system.condition))if(m&&!r.includes(c)){let d=duplicate(y.statusEffects.find(f=>f.id==c));if(!d)continue;let u=game.dsa5.config.statusEffectClasses[c]||I;d.flags.dsa5.value=m,d.statuses=[c];let p=u.calculateRollModifier(d,e,t,a);p!=0&&i.push({name:d.name,value:p,selected:u.ModifierIsSelected(t,a,e),source:s})}let n=e.hasPlayerOwner,o=game.settings.get("dsa5","masterSettings").globalMods||{};for(let c of Object.keys(o)){let m=expandObject(o[c]);if(!(!m.enabled||!m.target||!m.target[t.type])){if(n){if(!m.victim?.player)continue}else if(!m.victim?.npc)continue;i.push({name:m.name,value:m.value,selected:!0,source:game.i18n.localize("MASTER.globalMods")})}}return i}},Aa=class extends I{static ModifierIsSelected(e,t={},a){let s=e.type=="skill"&&e.system.burden.value=="yes",i=["rangeweapon"].includes(e.type)&&t.mode!="damage"&&game.settings.get("dsa5","encumbranceForRange"),r=!["skill","spell","ritual","ceremony","liturgy","rangeweapon"].includes(e.type)&&t.mode!="damage";return s||r||i}static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"||a.type=="skill"&&a.system.burden.value=="no"?0:super.calculateRollModifier(e,t,a,s)}},Ma=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="dodge"?-2:s.mode?s.mode=="attack"?-4:-2:0}},Ia=class extends I{static calculateRollModifier(e,t,a,s={}){let i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),r=t.system.happyTalents.value.split(/;|,/).map(n=>n.replace(i,"").trim());return r.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&r.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type)?this.clampedCondition(t,e)*-1-1:["ritual","spell","skill","combatskill"].includes(a.type)?this.clampedCondition(t,e):(a.type=="regenerate",0)}},Ea=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.perception")?-3:0}},$a=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"?a.name==game.i18n.localize("LocalizedIDs.featOfStrength")?2:0:s.mode=="attack"?4:0}},Oa=class extends I{static ModifierIsSelected(e,t={},a){return a.effects.find(s=>Array.from(s.statuses).includes("bloodrush"))==null}},xa=class extends I{static calculateRollModifier(e,t,a,s={}){if(a.type=="regenerate")return 0;switch(Number(this.clampedCondition(t,e))){case-2:let i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),r=t.system.happyTalents.value.split(/;|,/).map(n=>n.replace(i,"").trim());if(r.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&r.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type))return-2;case-3:return-3}return 0}},za=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.gambling")?Math.clamped(this.clampedCondition(t,e),-3,0):0}},Pa=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?0:a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.bodyControl")?Math.clamped(this.clampedCondition(t,e)+1,-2,0):0}},Na=class extends I{static calculateRollModifier(e,t,a,s={}){return 0}},La=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.willpower")?(this.clampedCondition(t,e)+1)*2:a.type=="regenerate"?this.clampedCondition(t,e):0}},Ra=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="skill"&&a.name==game.i18n.localize("LocalizedIDs.willpower")?Math.clamped(this.clampedCondition(t,e),-3,0):0}},_a=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?this.clampedCondition(t,e)*-1:0}},Fa=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="skill"&&a.system.group.value=="body"?Math.clamped(this.clampedCondition(t,e)-1,3,0)*-1:0}},Ha=class extends I{static calculateRollModifier(e,t,a,s={}){return a.type=="regenerate"?Math.pow(2,this.clampedCondition(t,e)*-1-1)*-1:0}},ja=class extends I{static calculateRollModifier(e,t,a,s={}){let i=this.clampedCondition(t,e);return a.type=="regenerate"?i==1?-1:i*-5:Math.clamped(i-1,0,3)}static levelDependentEffects(e,t){t.changes={1:[],2:[{key:"system.condition.stunned",mode:2,value:1/2}],3:[{key:"system.condition.stunned",mode:2,value:2/3}],4:[{key:"system.condition.stunned",mode:2,value:3/4}]}[t.flags.dsa5.value]}},Ga=class extends I{static levelDependentEffects(e,t){t.changes={1:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:1}],2:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:1/2}],3:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:2/3}],4:[{key:"system.condition.stunned",mode:2,value:1},{key:"system.condition.confused",mode:2,value:1/2}]}[t.flags.dsa5.value]}},Ba=class extends I{static levelDependentEffects(e,t){t.changes={1:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:1}],2:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:1/2}],3:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:2/3}],4:[{key:"system.condition.confused",mode:2,value:1},{key:"system.condition.paralysed",mode:2,value:1/2}]}[t.flags.dsa5.value]}},qa=class extends I{static calculateRollModifier(e,t,a,s={}){return 0}};y.statusEffectClasses={inpain:Oa,heat:Ga,cold:Ba,encumbered:Aa,stunned:I,raptured:Ia,feared:I,paralysed:I,confused:I,prone:Ma,deaf:Ea,bloodrush:$a,trance:xa,drunken:za,arousal:Na,burning:Pa,sikaryanloss:La,desire:Ra,theriak:_a,services:qa,sunken:Fa,hunger:Ha,thirst:ja};var O=class extends Q{static setupFunctions(){}static async vantageAdded(e,t){game.dsa5.config.addvantageRules[t.name]&&game.dsa5.config.addvantageRules[t.name](e,t)}static async vantageRemoved(e,t,a=!0){game.dsa5.config.removevantageRules[t.name]&&game.dsa5.config.removevantageRules[t.name](e,t);let s=O.calcAPCostSum(t);s=await O.removeSingularVantages(e,t,s),await e._updateAPs(-1*s,{},{render:a})}static async _vantageReturnFunction(e,t,a,s){if(t==null)return;if(t=duplicate(t),/,/.test(t.system.APValue.value)){let n=t.name.replace(" ()","");t.system.APValue.value=t.system.APValue.value.split(",")[e.items.filter(o=>o.type==t.type&&o.name.includes(n)).length].trim()}s!=null&&(O.simpleAdoption(t,s,t.name,y.vantagesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${s.name})`,s.system&&(t.system.APValue.value=t.system.APValue.value.split("/")[s.system.StF.value.charCodeAt(0)-65].trim()));let i=e.items.find(n=>n.type==a&&n.name==t.name),r;if(i){let n=duplicate(i);r=Number(/;/.test(n.system.APValue.value)?n.system.APValue.value.split(";").map(o=>Number(o.trim()))[n.system.step.value]:n.system.APValue.value),n.system.step.value+1<=n.system.max.value&&await e.checkEnoughXP(r)&&(n.system.step.value+=1,r=this.addSingularVantages(e,n,r),await e._updateAPs(r,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[n]),await O.vantageAdded(e,n))}else await e.checkEnoughXP(r=Number(t.system.APValue.value.split(";").map(n=>n.trim())[0]))&&(await O.vantageAdded(e,t),r=this.addSingularVantages(e,t,r),await e._updateAPs(r,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}static async needsAdoption(e,t,a){if(y.vantagesNeedingAdaption[t.name]){let s,i;if(y.vantagesNeedingAdaption[t.name].items=="text")s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:t}),i=function(r){let n={name:r.find('[name="entryselection"]').val()};O._vantageReturnFunction(e,t,a,n)};else{let r=e.items.filter(n=>y.vantagesNeedingAdaption[t.name].items.includes(n.type));s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:r,original:t}),i=function(n){let o=r.find(c=>c.name==n.find('[name="entryselection"]').val());O._vantageReturnFunction(e,t,a,o)}}await new We({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:s,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:i},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else O._vantageReturnFunction(e,t,a,null)}static addSingularVantages(e,t,a){let s=(i,r,n)=>i.type=="disadvantage"&&r.test(i.name);return O._calculateSingularVantages(t,e,a,s)}static removeSingularVantages(e,t,a){let s=(i,r,n)=>i.type=="disadvantage"&&r.test(i.name)&&i.name!=n.name;return O._calculateSingularVantages(t,e,a,s)}static _calculateSingularVantages(e,t,a,s,i=(r,n)=>Math.min(0,r-n)){if(e.type!="disadvantage")return a;for(let r of["principles","obligations"]){let n=new RegExp(`^${game.i18n.localize("LocalizedIDs."+r)} \\(`);if(n.test(e.name)){let o=t.items.filter(d=>s(d,n,e)),c=Math.min(0,...o.map(d=>O.calcAPCostSum(d))),m=O.calcAPCostSum(e);a=i(m,c)}}return a}static reduceSingularVantages(e,t,a){let s=(r,n,o)=>r.type=="disadvantage"&&n.test(r.name)&&r.name!=o.name,i=(r,n)=>r<n?a:0;return O._calculateSingularVantages(t,e,a,s,i)}static hasVantage(e,t){return super.hasItem(e,t,["advantage","disadvantage"])}static vantageStep(e,t){return super.itemStep(e,t,["advantage","disadvantage"])}static getVantageAsModifier(e,t,a=1,s=!1,i=!1){return super.itemAsModifier(e,t,a,["advantage","disadvantage"],s,i)}};Q.children.AdvantageRulesDSA5=O;var K=class{constructor(){R(this,"RECT_SPREAD",[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}])}static rangeFinder(e,t){let a=canvas.scene.grid.size,i=new Ray(e,t).distance/a,r=i*canvas.scene.grid.distance,n=Math.abs((getProperty(e,"system.elevation")||0)-(getProperty(t,"system.elevation")||0)),o=Math.hypot(r,n);return{elevation:n,distance:r,distanceSum:o,tileDistance:i,unit:canvas.scene.grid.units}}static inDistance(e){for(let t of canvas.scene.tokens)if(t.isOwner&&K.rangeFinder(e,t.object).tileDistance<=2)return!0;return!1}static inLight(e){let t=!1,a=!1;if(game.settings.get("dsa5","lightSightCompensationEnabled"))for(let s of canvas.effects.lightSources){if(!s.active||!s.object)continue;if(s.object==e){if(t=t||s.data.bright>0,a=a||s.data.dim>0,t)break;continue}let i=K.rangeFinder(e,s.object).distanceSum,r=s.object.document.config||s.object.document.light,n=r.bright>=i,o=r.dim>=i;if(!(!n&&!o)&&((s.data.walls===!1||s.shape.contains(e.center.x,e.center.y))&&(t=n||t,a=o||a),t))break}return{bright:t,dim:a}}static get isEnabled(){let e=canvas?.scene?.getFlag("dsa5","enableDPS");return e?e=="2":game.settings.get("dsa5","enableDPS")}static lightLevel(e,t){if(canvas.scene&&game.settings.get("dsa5","sightAutomationEnabled")){let a=0,s=canvas.scene?.darkness||0,i=game.settings.get("dsa5","sightOptions").split("|").map(n=>Number(n));for(;i[a]<=s;)a+=1;if(e){let n=O.vantageStep(e,game.i18n.localize("LocalizedIDs.darksight")),o=Number(getProperty(e,"system.sightModifier.value"))||0,c=Number(getProperty(e,"system.sightModifier.maxLevel"))||3,m=Array.from(game.user.targets);if(m.length){m=m[0];let d=K.inLight(m),u=0;d.bright?u=-2:d.dim&&(u=-1),a=Math.max(a+u,0)}a<=c&&a>0&&(n>1?a=0:a=Math.clamped(a+o-n,0,4))}let r=t.find(`[name="vision"] option:nth-child(${a+1})`);r.length&&(r[0].selected=!0)}}static distanceModifier(e,t,a){if(!K.isEnabled||!e)return 1;let s={};for(let i of game.user.targets){let r=K.rangeFinder(e,i);(s.distanceSum||0)<r.distanceSum&&(s=r)}if(s.unit==game.i18n.localize("gridUnits")){let i=Number(getProperty(a,"system.rangeMultiplier"))||1,r=t.system.reach.value.split("/").map(o=>Number(o)*i),n=0;for(;n<2&&r[n]<s.distanceSum;)n++;return n}else return 1}static initDoorMinDistance(){let e=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(t){return!game.user.isGM&&K.isEnabled&&!K.inDistance(this)?ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot")):e.apply(this,arguments)}}};Hooks.on("renderSceneConfig",(l,e,t)=>{let a=getProperty(l.object,"flags.dsa5.enableDPS"),s=`<div class="form-group dpsSelector">
        <label data-tooltip="DSASETTINGS.enableDPSHint">${game.i18n.localize("DSASETTINGS.enableDPS")}</label>
        <select name="flags.dsa5.enableDPS">
            <option value="" ${a==""?"selected":""}>${game.i18n.localize("globalConfig")}</option>
            <option value="2" ${a=="2"?"selected":""}>${game.i18n.localize("yes")}</option>
            <option value="1" ${a=="1"?"selected":""}>${game.i18n.localize("no")}</option>
        </select>
    </div>`;e.find(".dpsSelector").remove(),e.find('.tab[data-tab="grid"]').append(s)});var nt=class extends Dialog{static async getDialog(e){let t=Array.from(game.user.targets).map(i=>i.id),a=[],s=canvas.scene?canvas.scene.tokens.get(e.token)?.object:void 0;return game.combat&&game.combat.combatants.forEach(i=>{if(!!i.visible){if(i.isSelected=t.includes(i.token.id),s&&i.token){let r=canvas.scene.tokens.get(i.token.id).object;i.distance=K.rangeFinder(s,r),i.distance.distanceSum=Number(i.distance.distanceSum.toFixed(1))}a.push(i)}}),new nt({title:game.i18n.localize("DIALOG.addTarget"),content:await renderTemplate("systems/dsa5/templates/dialog/addTarget-dialog.html",{selectables:a}),default:"yes",buttons:{}})}activateListeners(e){super.activateListeners(e);let t=e.find(".combatant");t.click(a=>this.setTargets(a)),t.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),t.mousedown(a=>this._onRightClick(a))}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}_getCombatApp(){return game.combats.apps[0]}async setTargets(e){let t=e.originalEvent.shiftKey;t||$(e.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(e.currentTarget).addClass("selectedTarget");let a=e.currentTarget.dataset.combatantId;game.combat.combatants.get(a).token.object.setTarget(!0,{user:game.user,releaseOthers:!t,groupSelection:!0})}},Se=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5Decent"])}),e}static async getDialog(){let e=game.users.filter(t=>t.active&&!t.isGM);return new Se({title:game.i18n.localize("DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsa5/templates/dialog/selectForUserDialog.html",{users:e}),default:"yes",buttons:{}})}static registerButtons(){Hooks.on("getSceneControlButtons",e=>{if(!game.user.isGM)return;let t={name:"targetUser",title:game.i18n.localize("CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:async()=>{(await Se.getDialog()).render(!0)}};e[0].tools.splice(2,0,t)})}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){let t=Array.from(game.user.targets).map(i=>i.id),a=e.currentTarget.dataset.userId;game.users.get(a).updateTokenTargets(t),game.socket.emit("userActivity",a,{targets:t}),this.close()}},ot=class extends Dialog{static async getDialog(e){let t=game.users.filter(a=>a.active&&!a.isGM);new ot({title:game.i18n.localize("SHEET.PostItem"),content:await renderTemplate("systems/dsa5/templates/dialog/usermultipickdialog.html",{users:t}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:a=>{this.postContent(a,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}static async postContent(e,t){let a=g.chatDataSetup(t);if(!e.find("#sel_all").is(":checked")){let s=[];e.find(".usersel:checked").each(function(){s.push($(this).val())}),a.whisper=s}ChatMessage.create(a)}activateListeners(e){super.activateListeners(e),e.find('[name="sel_all"]').change(t=>{e.find(".usersel").prop("disabled",t.currentTarget.checked).prop("checked",t.currentTarget.checked)})}};var Wa=class extends Dialog{recallSettings(e,t,a,s){return this.recallData=game.dsa5.memory.recall(e,t,a),this.dialogData={mode:a,speaker:e,source:t,renderData:s},this}async _render(e,t){await super._render(e,t),this.prepareFormRecall($(this._element))}setRollButtonWarning(){return this.dialogData.mode=="attack"?`<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("DIALOG.noTarget")}</span>`:""}setMultipleTargetsWarning(){return this.dialogData.mode=="attack"?`<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("DIALOG.multipleTarget")}</span>`:""}renderRollValueDie(){if(this.dialogData.rollValue&&this.dialogData.mode!="damage"){let e=this.dialogData.mode=="attack"||this.dialogData.counterAttack?"die-mu":"die-in",t=this.dialogData.modifier||0;return`<span class="rollValue ${e} d20">${Math.clamped(this.dialogData.rollValue+t,1,20)}</span>`}else return""}async updateRollButton(e){let t=this.renderRollValueDie()+game.i18n.localize("Roll");e.length>0?e.length>1&&(t+=this.setMultipleTargetsWarning()):t+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(t)}async updateTargets(e,t){let a=await renderTemplate("systems/dsa5/templates/dialog/parts/targets.html",{targets:t});e.find(".targets").html(a),this.updateRollButton(t)}removeTarget(e){let t=e.currentTarget.dataset.id;$(e.currentTarget).remove();let a=[];game.user.targets.forEach(s=>{t!=s.id&&a.push(s.id)}),game.user.updateTokenTargets(a)}readTargets(){let e=[];return game.user.targets.forEach(t=>{t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})}),e}compareTargets(e,t){let a=this.readTargets();return JSON.stringify(t)!=JSON.stringify(a)&&(t=a,this.updateTargets(e,t)),t}activateListeners(e){super.activateListeners(e),e.find(".quantity-click").mousedown(t=>_.quantityClick(t)),e.find(".modifiers option").mousedown(t=>(t.preventDefault(),$(t.currentTarget).prop("selected",!$(t.currentTarget).prop("selected")),!1)),e.on("click",".rollTarget",t=>this.removeTarget(t)),e.on("click",".addTarget",t=>this.addTarget(t))}async addTarget(e){(await nt.getDialog(this.dialogData.speaker)).render(!0)}prepareFormRecall(e){if(this.recallData)for(let t in this.recallData)if(t=="specAbs")for(let a of this.recallData[t]){let s=e.find(`.specAbs[data-id="${a.id}"]`);s.addClass("active").attr("data-step",a.step),s.find(".step").text(Wa.roman[a.step])}else{let a=e.find(`[name="${t}"]`);if(Array.isArray(this.recallData[t])){let s=a.find("option");for(let i of s){let r=this.recallData[t].find(n=>n.name==$(i).text().trim());r&&(i.selected=r.selected)}}else a.attr("type")=="checkbox"?a[0].checked=this.recallData[t]:a.val(this.recallData[t])}}},te=Wa;R(te,"roman",[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"]);var Ne=class extends te{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}prepareFormRecall(e){super.prepareFormRecall(e),e.find(".spellModifier").trigger("change")}static getRollButtons(e,t,a,s){let i=X.getRollButtons(e,t,a,s);if(["spell","liturgy"].includes(e.source.type)){let r=Number(e.source.system.castingTime.value),n=e.source.system.castingTime.progress,o=e.source.system.castingTime.modified;if(r&&e.extra.speaker.token!="emptyActor"){let c=o>0?` (${n}/${o})`:"";mergeObject(i,{reloadButton:{label:`${game.i18n.localize("SPELL.reload")}${c}`,callback:async m=>{let d=await g.getSpeaker(e.extra.speaker),u={_id:e.source._id,"system.castingTime.progress":n+1};o==0&&(o=Number(m.find(".castingTime").text())-1,u["system.castingTime.modified"]=o),await d.updateEmbeddedDocuments("Item",[u]);let p=game.i18n.format("SPELL.isReloading",{actor:d.token?.name||d.prototypeToken.name,item:e.source.name,status:`${n+1}/${o}`});await ChatMessage.create(g.chatDataSetup(p))}}})}}return i}async applyTransformations(e,t){let a=t.find('[name="situationalModifiers"]');a.find('option[data-extension="1"]').remove();let s=[],i=Object.keys(Ne.rollModifiers).map(n=>`${n}.mod`);this.dialogData.renderData.rollModifiersPrepared=duplicate(this.dialogData.renderData.rollModifiers);for(let n of t.find(".specAbs.active")){let o=fromUuidSync(n.dataset.uuid);if(!!o)for(let c of o.effects)for(let m of c.changes)if(Ne.rollChanges.includes(m.key)){let d=o.name.split(" - "),u=game.i18n.localize(`MODS.${m.key}`);d=`${d[1]||d[0]}`;let p=`${u}: ${m.value}<br/>${game.i18n.localize("spellextension")}: ${d}`;s.push(`<option data-extension="1" selected="" data-tooltip="${p}" data-type="${m.key}" value="${m.value}">${d} - ${u}</option>`)}else m.key=="macro.transform"?await g.callItemTransformationMacro(m.value,e,c):i.includes(m.key)?c.apply(this.dialogData.renderData.rollModifiersPrepared,m):c.apply(e,m)}let r=this.dialogData.renderData.rollModifiersPrepared.extensionModifier.mod;if(r){let n=game.i18n.localize("ABBR.modifiers"),o=game.i18n.localize("spellextension"),c=`${n}: ${r}<br/>${o}`;s.push(`<option data-extension="1" selected="" data-tooltip="${c}" data-type="" value="${r}">${o} - ${n}</option>`)}a.append(s.join(""))}static setData(e,t){let a=duplicate(Ne.rollModifiers),s=`${t}RollModifiers`;if(e.system[s])for(let i of Object.keys(e.system[s]))a[i].mod+=Number(e.system[s][i]?.mod??0);return a}async recalcSpellModifiers(e,t){let a=e,s=duplicate(this.dialogData.source);_.ensureNumber(s);let i=a.find(".castingTime"),r=a.find(".aspcost"),n=a.find(".reach"),o=a.find(".maintainCost"),c=a.find(".ritual").length>0;await this.applyTransformations(s,a);let m=a.find(".maxMods");if(a.find(".spellModifier:checked").length>Number(m.text())){t&&(t.currentTarget.checked=!1),m.addClass("emphasize"),setTimeout(function(){m.removeClass("emphasize")},600);return}for(let L of Object.keys(this.dialogData.renderData.rollModifiersPrepared)){let D=this.dialogData.renderData.rollModifiersPrepared[L].mod;e.find(`.${L}Label`).text(`(${D})`),e.find(`#${L}`).val(D)}let d=e.find(".canChangeCastingTime");s.system.canChangeCastingTime.value=="true"?d.is(":empty")&&(d.html(await renderTemplate("systems/dsa5/templates/dialog/parts/canChangeCastingTime.html",{rollModifiers:this.dialogData.renderData.rollModifiers})),this.setPosition({height:"auto"})):d.is(":empty")||(d.html(""),this.setPosition({height:"auto"}));let u=s.system.AsPCost.value,p=s.system.range.value,f=s.system.castingTime.value,h=u,w=s.system.maintainCost.value;a.find(".variableBaseCost")[s.system.variableBaseCost=="true"?"show":"hide"]();let z=0;a.find(".spellModifier[data-cost]:checked").each(function(L,D){if(h=h*(D.value<0?.5:2),w!=""&&w!=null){let x=String(w).split(" ");x[0]=Math.max(Number(x[0])*(D.value<0?.5:2)),w=x.join(" ")}z+=Number(D.value)}),h<1?t&&(t.currentTarget.checked=!1):(r.text(h),o.text(w),r.attr("data-mod",z)),z=0,h=f,a.find(".spellModifier[data-castingTime]:checked").each(function(L,D){if(c){let x=Ne.bigTimes.indexOf(Number(h));if(x!=null){let E=x+(D.value>0?1:-1);E<Ne.bigTimes.length&&E>=0?h=Ne.bigTimes[E]:ui.notifications.error(game.i18n.localize("DSAError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("DSAError.TimeCannotBeParsed"))}else h=h*(D.value>0?2:.5);z+=Number(D.value)}),h<1?t&&(t.currentTarget.checked=!1):(i.text(h),i.attr("data-mod",z)),z=0;let v=game.i18n.localize("ReverseSpellRanges."+p);n.text(p),a.find(".spellModifier[data-reach]:checked").each(function(L,D){if(v=="self")D.checked=!1;else if(v=="touch")n.text("4 "+game.i18n.localize("step")),z+=Number(D.value);else{let x=p.split(" ");v=Number(x[0]),isNaN(v)?(t&&(t.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("DSAError.RangeCannotBeParsed"))):(n.text(v*2+" "+game.i18n.localize("step")),z+=Number(D.value))}}),n.attr("data-mod",z),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}activateListeners(e){super.activateListeners(e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown(s=>{$(s.currentTarget).toggleClass("active"),this.recalcSpellModifiers(e)}),e.find(".variableBaseCost").change(s=>{let i=$(s.currentTarget).parents(".skill-test"),r=i.find(".aspcost").attr("data-base"),n=$(s.currentTarget).val();i.find(".aspcost").attr("data-base",n),i.find(".aspcost").text(Number(i.find(".aspcost").text())*n/r)}),e.on("change",".spellModifier",s=>this.recalcSpellModifiers(e,s));let t=this.readTargets();t.length==0&&this.setRollButtonWarning();let a=this;this.checkTargets=setInterval(function(){t=a.compareTargets(e,t)},500)}},ne=Ne;R(ne,"rollChanges",["defenseMalus"]),R(ne,"rollModifiers",{forceSpell:{mod:1},reduceCostSpell:{mod:-1},increaseRangeSpell:{mod:-1},increaseCastingTime:{mod:1},decreaseCastingTime:{mod:-1},removeGesture:{mod:-2},removeFormula:{mod:-2},extensionModifier:{mod:0}}),R(ne,"bigTimes",[5,30,120,480,960,1920]);function ni(l,e={}){g.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}async function bn(l,e,t,a,s,i={}){let r={};if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else{let o=await game.packs.get(l).getDocuments({name:e});if(!o.length){for(let c of game.packs.filter(m=>m.documentName=="Macro"&&/\(internal\)/.test(m.metadata.label)))if(o=await c.getDocuments({name:e}),o.length)break}if(o.length){let c=Object.getPrototypeOf(async function(){}).constructor,m=new c("actor","item","qs","automatedAnimation","args",o[0].command);try{i.result=r;let d=mergeObject({automatedAnimation:ni},this);await m.call(d,t,a,s,ni,i)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),r.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:e}))}return r}Hooks.once("i18nInit",()=>{_DSAActiveEffectConfig.effectDurationRegexes=[{regEx:new RegExp(game.i18n.localize("DSAREGEX.combatRounds"),"i"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEX.minutes"),"i"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEX.hours"),"i"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEX.days"),"i"),seconds:3600*24},{regEx:new RegExp(game.i18n.localize("DSAREGEX.weeks"),"i"),seconds:3600*24*7},{regEx:new RegExp(game.i18n.localize("DSAREGEX.months"),"i"),seconds:3600*24*30},{regEx:new RegExp(game.i18n.localize("DSAREGEX.years"),"i"),seconds:3600*24*350}]});var _DSAActiveEffectConfig=class extends ActiveEffectConfig{static get defaultOptions(){return mergeObject(super.defaultOptions,{resizable:!0})}static async onEffectRemove(l,e){let t=getProperty(e,"flags.dsa5.onRemove");if(t)if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else try{let a=Object.getPrototypeOf(async function(){}).constructor;await new a("effect","actor",t).call(this,e,l)}catch(a){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(a),console.warn(a.stack)}}async checkTimesUpInstalled(){let l=g.moduleEnabled("times-up");return!l&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("DSAError.shouldTimesUp")),l}async _render(l=!1,e={}){await super._render(l,e);let t=0,a=getProperty(this.object,"parent.type"),s=["meleeweapon","rangeweapon"].includes(a)||a=="trait"&&["meleeAttack","rangeAttack"].includes(getProperty(this.object,"parent.system.traitType.value")),i={hasSpellEffects:s||["spell","liturgy","ritual","skill","ceremony","consumable","poison","disease","ammunition"].includes(a)||["specialability"].includes(a)&&getProperty(this.object,"parent.system.category.value")=="Combat",hasDamageTransformation:["ammunition"].includes(a),hasTriggerEffects:["specialability"].includes(a)},r=[];if((i.hasSpellEffects||i.hasDamageTransformation||i.hasTriggerEffects)&&r.push({name:"ActiveEffects.advancedFunctions.none",index:0}),i.hasSpellEffects)for(let d of["systemEffect","macro","creature"])r.push({name:`ActiveEffects.advancedFunctions.${d}`,index:t+=1});i.hasDamageTransformation&&r.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5}),i.hasTriggerEffects&&r.push({name:"ActiveEffects.advancedFunctions.postRoll",index:6},{name:"ActiveEffects.advancedFunctions.postOpposed",index:7});let n={systemEffects:this.getStatusEffects(),canEditMacros:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")},o=[2,6,7],c=$(this._element);c.find(".tabs").append(`<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>${game.i18n.localize("advanced")}</a>`);let m=await renderTemplate("systems/dsa5/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:r,effectConfigs:i,macroIndexes:o,config:n,isWeapon:s});c.find('.tab[data-tab="effects"]').after($(m)),c.find(".advancedSelector").change(d=>{let u=this.object;u.flags.dsa5.advancedFunction=$(d.currentTarget).val(),renderTemplate("systems/dsa5/templates/status/advanced_functions.html",{effect:u,config:n,macroIndexes:o}).then(p=>{c.find(".advancedFunctions").html(p)})}),this.checkTimesUpInstalled()}getStatusEffects(){return duplicate(CONFIG.statusEffects).map(l=>({id:l.id,name:game.i18n.localize(l.name)})).sort((l,e)=>l.name.localeCompare(e.name))}static applyRollTransformation(actor,options,functionID){let msg="",source=options.origin;for(let ef of source.effects)try{Number(getProperty(ef,"flags.dsa5.advancedFunction"))==functionID&&eval(getProperty(ef,"flags.dsa5.args3"))}catch(l){console.warn("Unable to apply advanced effect",l,ef)}return options.origin=source,{msg,options}}static async applyAdvancedFunction(actor,effects,source,testData,sourceActor,skipResistRolls=!0){let msg="",resistRolls=[],effectApplied=!1,effectsWithChanges=[],effectNames=new Set;for(let ef of effects){ef.origin&&delete ef.origin;let specStep=Number(getProperty(ef,"flags.dsa5.specStep"))||0;try{let customEf=Number(getProperty(ef,"flags.dsa5.advancedFunction")),qs=Math.min(testData.qualityStep||0,6),resistRoll=getProperty(ef,"flags.dsa5.resistRoll");if(resistRoll&&!skipResistRolls){let l=resistRoll.split(" "),e=`${l.pop()}`;resistRolls.push({skill:l.join(" "),mod:Math.round(Roll.safeEval(`${e}`.replace(/q(l|s)/i,qs).replace("step",specStep)))||0,effect:ef,target:actor,token:actor.token?actor.token.id:void 0})}else if(effectApplied=!0,effectNames.has(ef.name)||effectNames.add(ef.name),ef.changes&&ef.changes.length>0&&effectsWithChanges.push(ef),customEf)switch(customEf){case 1:{let l=duplicate(CONFIG.statusEffects.find(t=>t.id==getProperty(ef,"flags.dsa5.args0"))),e=`${getProperty(ef,"flags.dsa5.args1")}`||"1";l.duration=ef.duration,/,/.test(e)?e=Number(e.split(",")[qs-1]):e=Number(e.replace(game.i18n.localize("CHARAbbrev.QS"),qs)),await actor.addCondition(l,e,!1,!1)}break;case 2:game.user.can("MACRO_SCRIPT")?await eval(`(async () => {${getProperty(ef,"flags.dsa5.args3")}})()`):ui.notifications.warn("You are not allowed to use JavaScript macros.");break;case 3:let creatures=(getProperty(ef,"flags.dsa5.args4")||"").split(",").map(l=>`@Compendium[${l.trim().replace(/(@Compendium\[|\])/)}]`).join(" ");msg+=`<p><b>${game.i18n.localize("ActiveEffects.advancedFunctions.creature")}</b>:</p><p>${creatures}</p>`;break}}catch(l){console.warn("Unable to apply advanced effect"),console.warn(l),console.warn(ef)}}return await actor.createEmbeddedDocuments("ActiveEffect",effectsWithChanges),{msg,resistRolls,effectApplied,effectNames:Array.from(effectNames)}}static async resistEffect(l){let e=l.currentTarget.dataset,t={token:e.token,actor:e.actor,scene:canvas.id},a=g.getSpeaker(t);if(a){let s=a.items.find(i=>i.type=="skill"&&i.name==e.skill);a.setupSkill(s,{modifier:e.mod},e.token).then(async i=>{i.testData.opposable=!1,((await a.basicTest(i)).result.qualityStep||0)<1&&await this.applyEffect(e.message,e.mode,[t],{effectIds:[e.effect],skipResistRolls:!0})})}else console.warn("Actor not found for resist roll.")}static async applyEffect(l,e,t,a={}){let s=game.messages.get(l),i=s.flags.data.preData.source,r=s.flags.data.postData,n=s.speaker;["poison","disease"].includes(i.type)&&(r.qualityStep=r.successLevel>0?2:1);let o=g.getSpeaker(n)||g.getSpeaker(getProperty(s.flags,"data.preData.extra.speaker"))||game.actors.get(getProperty(s.flags,"data.preData.extra.actor.id")),c=o,m=(await this._parseEffectDuration(i,r,s.flags.data.preData,o)).filter(u=>!getProperty(u,"flags.dsa5.applyToOwner"));a.effectIds&&(m=m.filter(u=>a.effectIds.includes(u._id)));let d=[];if(e=="self"?o&&d.push(o):t?d=t.map(u=>g.getSpeaker(u)):game.user.targets.size&&game.user.targets.forEach(u=>{u.actor&&d.push(u.actor)}),game.user.isGM)for(let u of d){let{msg:p,resistRolls:f,effectApplied:h,effectNames:w}=await _DSAActiveEffectConfig.applyAdvancedFunction(u,m,i,r,c,a.skipResistRolls||!1);if(h){let v=`${game.i18n.format("ActiveEffects.appliedEffect",{target:u.token?.name||u.name,source:w.join(", ")})}${p||""}`;await ChatMessage.create(g.chatDataSetup(v))}f.length&&await this.createResistRollMessage(f,l,e)}else game.socket.emit("system.dsa5",{type:"addEffect",payload:{mode:e,id:l,actors:d.map(u=>({token:u.token?u.token.id:void 0,actor:u.id,scene:canvas.scene.id}))}})}static async createResistRollMessage(l,e,t){for(let a of l){let s=await renderTemplate("systems/dsa5/templates/chat/roll/resist-roll.html",{resist:a,id:e,mode:t});await ChatMessage.create(g.chatDataSetup(s))}}static async _parseEffectDuration(l,e,t,a){let s={};for(let c of t.situationalModifiers.filter(m=>m.specAbId))s[c.specAbId]=c.step;let i=Object.keys(s),r=a?a.items.filter(c=>i.includes(c.id)):[],n=l.effects?duplicate(l.effects):[];for(let c of r){let m=duplicate(c).effects;for(let d of m)setProperty(d,"flags.dsa5.specStep",s[c.id]);n.push(...m)}let o=getProperty(l,"system.duration.value")||"";o=o.replace(/ x /g," * ").replace(game.i18n.localize("CHARAbbrev.QS"),e.qualityStep);try{for(let c of _DSAActiveEffectConfig.effectDurationRegexes)if(c.regEx.test(o)){let m=o.replace(c.regEx,"").trim(),d=await _DiceDSA5._stringToRoll(m);if(!isNaN(d))for(let u of n){let p=d*c.seconds,f=getProperty(u,"flags.dsa5.customDuration");if(f){let h=f.split(",")[e.qualityStep-1];h&&h!="-"&&(p=Number(h))}u.duration.seconds=p,u.duration.rounds=u.duration.seconds/5}break}}catch{console.error(`Could not parse duration '${o}' of '${l.name}'`)}return n}dropDownMenu(){let l=game.i18n.localize("MODS.FW"),e=game.i18n.localize("skill"),t=game.i18n.localize("regenerate"),a=game.i18n.localize("MODS.FP"),s=game.i18n.localize("stepValue"),i=game.i18n.localize("MODS.QS"),r=game.i18n.localize("MODS.partChecks"),n=`${game.i18n.localize("LocalizedIDs.perception")} 1`,o=`${game.i18n.localize("LocalizedIDs.wrestle")} 1`,c=game.i18n.localize("closeCombatAttacks"),m=game.i18n.localize("rangeCombatAttacks"),d=`${t} (${game.i18n.localize("CHARAbbrev.CR")})`,u=game.i18n.localize("AsPCost"),p=game.i18n.localize("KaPCost"),f=game.i18n.localize("permanentCost"),h=`${game.i18n.localize("Healing")} 1`,w=`${game.i18n.localize("Description")} 1`,z=`${game.i18n.localize("LocalizedIDs.miracle")}`,v=[{name:game.i18n.localize("protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:game.i18n.localize("liturgyArmor"),val:"system.liturgyArmor",mode:2,ph:"1"},{name:`${game.i18n.localize("resistanceModifier")} (${game.i18n.localize("condition")})`,val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("spellArmor"),val:"system.spellArmor",mode:2,ph:"1"},{name:game.i18n.localize("carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.meleeStats.attack",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.PA")}`,val:"system.meleeStats.parry",mode:2,ph:"1"},{name:`${z} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.miracle.attack",mode:2,ph:"1"},{name:`${z} - ${game.i18n.localize("CHARAbbrev.PA")}`,val:"system.miracle.parry",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:`${c} - ${game.i18n.localize("MODS.defenseMalus")}`,val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:`${game.i18n.localize("CONJURATION.elemental")} 1`},{name:`${m} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.rangeStats.attack",mode:2,ph:"1"},{name:`${m} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:`${m} - ${game.i18n.localize("MODS.defenseMalus")}`,val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:`${game.i18n.localize("spell")} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.spellStats.damage",mode:2,ph:"1"},{name:`${game.i18n.localize("liturgy")} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.liturgyStats.damage",mode:2,ph:"1"},{name:p,val:"system.kapModifier",mode:2,ph:"1"},{name:u,val:"system.aspModifier",mode:2,ph:"1"},{name:`${f} ${game.i18n.localize("CHARAbbrev.AsP")}`,val:"system.status.astralenergy.permanentGear",mode:2,ph:"1"},{name:`${f} ${game.i18n.localize("CHARAbbrev.KaP")}`,val:"system.status.astralenergy.permanentGear",mode:2,ph:"1"},{name:`${e} - ${l}`,val:"system.skillModifiers.FW",mode:0,ph:n},{name:`${e} - ${a}`,val:"system.skillModifiers.FP",mode:0,ph:n},{name:`${e} - ${s}`,val:"system.skillModifiers.step",mode:0,ph:n},{name:`${e} - ${i}`,val:"system.skillModifiers.QL",mode:0,ph:n},{name:`${e} - ${r}`,val:"system.skillModifiers.TPM",mode:0,ph:n},{name:`${game.i18n.localize("vulnerability")} - ${game.i18n.localize("combatskill")}`,val:"system.vulnerabilities.combatskill",mode:0,ph:o},{name:`${e} - ${game.i18n.localize("MODS.global")}`,val:"system.skillModifiers.global",mode:0,ph:"1"},{name:`${d} - ${game.i18n.localize("wounds")}`,val:"system.repeatingEffects.startOfRound.wounds",mode:0,ph:"1d6"},{name:`${d} - ${game.i18n.localize("astralenergy")}`,val:"system.repeatingEffects.startOfRound.astralenergy",mode:0,ph:"1d6"},{name:`${d} - ${game.i18n.localize("karmaenergy")}`,val:"system.repeatingEffects.startOfRound.karmaenergy",mode:0,ph:"1d6"},{name:`${t} - ${game.i18n.localize("wounds")}`,val:"system.status.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:`${t} - ${game.i18n.localize("astralenergy")}`,val:"system.status.regeneration.AsPgearmodifier",mode:2,ph:"1"},{name:`${t} - ${game.i18n.localize("karmaenergy")}`,val:"system.status.regeneration.KaPgearmodifier",mode:2,ph:"1"},{name:`${game.i18n.localize("feature")} - ${u}`,val:"system.skillModifiers.feature.AsPCost",mode:0,ph:h},{name:`${game.i18n.localize("advanced")} - ${u}`,val:"system.skillModifiers.conditional.AsPCost",mode:0,ph:w},{name:`${game.i18n.localize("feature")} - ${p}`,val:"system.skillModifiers.feature.KaPCost",mode:0,ph:h},{name:`${game.i18n.localize("advanced")} - ${p}`,val:"system.skillModifiers.conditional.KaPCost",mode:0,ph:w},{name:`${game.i18n.localize("MODS.sight")}`,val:"system.sightModifier.value",mode:2,ph:"-1"},{name:`${game.i18n.localize("MODS.sightMax")}`,val:"system.sightModifier.maxLevel",mode:5,ph:"4"},{name:`${game.i18n.localize("LocalizedIDs.immuneTo")} ${game.i18n.localize("condition")}`,val:"system.immunities",mode:2,ph:"feared"},{name:game.i18n.localize("temperature.heatProtection"),val:"system.temperature.heatProtection",mode:2,ph:"1"},{name:game.i18n.localize("temperature.coldProtection"),val:"system.temperature.coldProtection",mode:2,ph:"1"}],L=["liturgy","ceremony","spell","ritual","skill","feature"];for(let D of L){let x=D=="skill"?"skillglobal":D,E=game.i18n.localize(x);v.push({name:`${E} - ${l}`,val:`system.skillModifiers.${D}.FW`,mode:0,ph:n},{name:`${E} - ${a}`,val:`system.skillModifiers.${D}.FP`,mode:0,ph:n},{name:`${E} - ${s}`,val:`system.skillModifiers.${D}.step`,mode:0,ph:n},{name:`${E} - ${i}`,val:`system.skillModifiers.${D}.QL`,mode:0,ph:n},{name:`${E} - ${r}`,val:`system.skillModifiers.${D}.TPM`,mode:0,ph:n})}for(let D of CONFIG.statusEffects)getProperty(D,"flags.dsa5.max")&&v.push({name:game.i18n.localize(D.name),val:`system.condition.${D.id}`,mode:2,ph:1});for(let D of Object.keys(y.characteristics))v.push({name:game.i18n.localize(`CHAR.${D.toUpperCase()}`),val:`system.characteristics.${D}.gearmodifier`,mode:2,ph:"1"});for(let D of y.gearModifyableCalculatedAttributes)v.push({name:game.i18n.localize(D),val:`system.status.${D}.gearmodifier`,mode:2,ph:"1"});for(let D of["spell","liturgy","ceremony","ritual"]){let x=g.categoryLocalization(D);for(let E of["soulpower","toughness"])v.push({name:`${game.i18n.localize(E)} (${x})`,val:`system.status.${E}.${D}resist`,mode:2,ph:"1"});for(let E of Object.keys(ne.rollModifiers))v.push({name:`${x} - ${game.i18n.localize(E.replace("Spell",""))}`,val:`system.${D}RollModifiers.${E}.mod`,mode:2,ph:"1"},{name:`${x} - ${game.i18n.localize(E.replace("Spell",""))} - ${game.i18n.localize("advanced")}`,val:`system.${D}RollModifiers.${E}.custom`,mode:0,ph:w})}v=v.sort((D,x)=>D.name.localeCompare(x.name));for(let D of v)(!D.ph||D.mode==null)&&console.warn(D);return v=v.map(D=>`<option value="${D.val}" data-mode="${D.mode}" data-ph="${D.ph}">${D.name}</option>`).join(`
`),`<select class="selMenu">${v}</select>`}activateListeners(l){super.activateListeners(l);let e=this.dropDownMenu();l.find(".changes-list .effect-change .key").append(e),l.find(".selMenu").select2({width:"element"}).change(t=>{let a=$(t.currentTarget);a.siblings("input").val(a.val());let s=a.closest(".effect-change"),i=a.find("option:selected");s.find(".mode select").val(i.attr("data-mode")),s.find(".value input").attr("placeholder",i.attr("data-ph")),a.blur()}),l.find(".select2").each((t,a)=>{$(a)[0].style.removeProperty("width")})}};var Kt=class{static async createTokenHook(e,t,a){if(!g.isActiveGM())return;let s=e.parent;if(this.isRiding(e.actor)&&s.active){let i=this.getHorse(e.actor);if(!i)return;let r=await i.getTokenDocument();r.updateSource({x:e.x,y:e.y,hidden:e.hidden});let n=(await s.createEmbeddedDocuments("Token",[r]))[0],o={"flags.dsa5.horseTokenId":n.id,elevation:(n.elevation??0)+1};mergeObject(o,this.adaptTokenSize(e,n)),await e.update(o),n.actorLink||await e.actor.update({"system.horse.actorLink":!1,"system.horse.token":{scene:s.id,token:n.id}})}}static isRiding(e){return getProperty(e,"system.horse.isRiding")}static updateTokenHook(e,t,a){if(!g.isActiveGM())return;let s=getProperty(e,"flags.dsa5.horseTokenId"),i=e.parent;s&&i.active&&(t.x||t.y)&&this.isRiding(e.actor)&&i.updateEmbeddedDocuments("Token",[{_id:s,x:e.x,y:e.y}])}static rollLoyalty(e,t={}){let a=this.getHorse(e);if(!a)return;let s=this.getLoyaltyFromHorse(a);if(!s)return ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:g.categoryLocalization("skill"),name:game.i18n.localize("LocalizedIDs.loyalty")}));a.setupSkill(s,t,a.token?.id).then(i=>{a.basicTest(i)})}static async updateRiderSpeed(e,t){if(!canvas?.tokens?.documentCollection)return;let a=e.getActiveTokens().map(s=>s.id);for(let s of Array.from(canvas.tokens.documentCollection))a.includes(s.getFlag("dsa5","horseTokenId"))&&t!=s.actor.system.status.speed.max&&(s.actor.prepareData(),s.actor.sheet.render())}static getLoyaltyFromHorse(e){return e.items.find(t=>t.type=="skill"&&t.name.startsWith(game.i18n.localize("LocalizedIDs.loyalty")))}static activateListeners(e,t){e.find(".riding-toggle").click(()=>this.toggleIsRiding(t)),e.find(".showHorse").click(()=>this.getHorse(t).sheet.render(!0)),e.find(".horse-delete").click(()=>this.clearMount(t)),e.find(".horse-loyalty").click(()=>this.rollLoyalty(t)),e.find('[name="horseSpeedSelector"]').change(async a=>{a.preventDefault();let s=Kt.getHorse(t);Kt.setSpeed(s,a.currentTarget.value)})}static async toggleIsRiding(e){await e.update({"system.horse.isRiding":!e.system.horse?.isRiding});let t=[];if(e.system.horse.isRiding){let a=this.getHorse(e),s;for(let i of a.getActiveTokens())t.push({_id:i.document.id,["flags.dsa5.-=horseTokenId"]:null}),s=i.document.id;for(let i of e.getActiveTokens())t.push({_id:i.document.id,elevation:Math.max(0,(i.elevation??0)+1),"flags.dsa5.horseTokenId":s});await this.addRidingCondition(e)}else{for(let a of e.getActiveTokens())t.push({_id:a.document.id,["flags.dsa5.-=horseTokenId"]:null,elevation:Math.max(0,(a.elevation??0)-1)});await this.removeRidingCondition(e)}await canvas.scene.updateEmbeddedDocuments("Token",t,{noHooks:!0})}static getRidingCondition(e){let t=game.i18n.localize("RIDING.riding");return e.effects.find(a=>a.name==t)}static async addRidingCondition(e){this.getRidingCondition(e)||await e.addCondition(this.ridingCondition())}static async removeRidingCondition(e){let t=this.getRidingCondition(e);t&&await e.deleteEmbeddedDocuments("ActiveEffect",[t.id])}static deleteTokenHook(){console.warn("delete riding token hook not implemented")}static getHorse(e,t=!1){let a;return e.system.horse&&(e.system.horse.token&&!e.system.horse.actorLink?a=g.getSpeaker(e.system.horse.token):a=game.actors.get(e.system.horse.actorId),!a&&t&&e.system.horse.isRiding&&(a={name:game.i18n.localize("unknown")})),a}static async unmountHorse(e,t){let a={["flags.dsa5.-=horseTokenId"]:null,elevation:Math.max(0,(t.elevation??0)-1)},s=t.getFlag("dsa5","horseResized");s&&mergeObject(a,{["flags.dsa5.-=horseResized"]:null,width:s.width,height:s.height}),await this.clearMount(e),await t.update(a)}static async clearMount(e){await e.update({system:{horse:{isRiding:!1,actorLink:!1,actorId:"","-=token":null}}}),await this.removeRidingCondition(e)}static ridingCondition(){return{name:game.i18n.localize("RIDING.riding"),icon:"systems/dsa5/icons/thirdparty/horse-head.svg",changes:[{key:"system.status.dodge.gearmodifier",mode:2,value:-2}],flags:{dsa5:{description:game.i18n.localize("RIDING.ridingDescription")}}}}static async setHorse(e,t){let a={system:{horse:{isRiding:!0,actorLink:t.prototypeToken.actorLink,actorId:t.id}}};!t.prototypeToken.actorLink&&t.token&&mergeObject(a,{system:{horse:{token:{scene:canvas.scene.id,token:t.token.id}}}}),await e.update(a),t.isToken&&await canvas.scene.updateEmbeddedDocuments("Token",e.getActiveTokens().map(s=>({_id:s.id,"flags.dsa5.horseTokenId":t.token.id,x:t.token.x,y:t.token.y})).concat({_id:t.token.id,["flags.dsa5.-=horseTokenId"]:null}),{noHooks:!0}),await this.addRidingCondition(e)}static adaptTokenSize(e,t){return e.width>=t.width?{width:.7*t.width,height:.7*t.height,"flags.dsa5.horseResized":{width:e.width,height:e.height}}:{}}static async mountHorse(e){let t=canvas.tokens.controlled.find(r=>r.document.id!=e.id),a=e.parent,s={system:{horse:{isRiding:!0,actorLink:t.actorLink,actorId:t.actor.id}}};t.actorLink||mergeObject(s,{system:{horse:{token:{scene:a.id,token:t.id}}}});let i={_id:e.id,"flags.dsa5.horseTokenId":t.id,x:t.x,y:t.y,elevation:(t.document.elevation??0)+1};mergeObject(i,this.adaptTokenSize(e.document,t.document)),await e.actor.update(s),await canvas.scene.updateEmbeddedDocuments("Token",[i,{_id:t.id,["flags.dsa5.-=horseTokenId"]:null}],{noHooks:!0}),await this.addRidingCondition(e.actor)}static getHorseSpeed(e){return e.effects.find(t=>getProperty(t,"flags.dsa5.horseSpeed"))?.flags.dsa5.horseSpeed||0}static horseSpeedModifier(e){let t=this.getHorseSpeed(e);return Object.keys(this.speedKeys).map(a=>Number(a)).indexOf(Number(t))}static increaseSpeed(e){let t=this.getHorseSpeed(e),a=Math.min(3,Object.keys(this.speedKeys).map(s=>Number(s)).indexOf(t)+1);this.setSpeed(e,Object.keys(this.speedKeys).map(s=>Number(s))[a])}static decreaseSpeed(e){let t=this.getHorseSpeed(e),a=Math.max(0,Object.keys(this.speedKeys).map(s=>Number(s)).indexOf(t)-1);this.setSpeed(e,Object.keys(this.speedKeys).map(s=>Number(s))[a])}static async setSpeed(e,t){await e.deleteEmbeddedDocuments("ActiveEffect",e.effects.filter(a=>hasProperty(a,"flags.dsa5.horseSpeed")).map(a=>a.id)),await e.addCondition({name:game.i18n.localize("speed")+": "+game.i18n.localize(`RIDING.speeds.${t}`),icon:"systems/dsa5/icons/thirdparty/horse-head.svg",changes:[this.speedKeys[t]],flags:{dsa5:{description:game.i18n.localize(`RIDING.speed.${t}`),horseSpeed:t}}})}static renderTokenHUD(e,t,a){let s=e.object.actor;if(canvas.tokens.controlled.length==2)t.find(".col.left").prepend(this.preRenderedMountHud),t.find('.control-icon[data-action="ride"]').click(()=>this.mountHorse(e.object));else if(this.isRiding(s)){t.find(".col.left").prepend(this.preRenderedUnmountHud);let i=t.find('.control-icon[data-action="ride"]');i.click(()=>{this.unmountHorse(s,e.object.document),i.remove()});let r=this.getHorse(s);t.find(".col.right").prepend(this.preRenderedSpeedHud),t.find('.control-icon[data-action="rideIncrease"]').click(()=>this.increaseSpeed(r)),t.find('.control-icon[data-action="rideDecrease"]').click(()=>this.decreaseSpeed(r))}}},H=Kt;R(H,"preRenderedUnmountHud",`
    <div class="control-icon" data-action="ride">
        <i class="fas fa-horse" style="transform: rotate(180deg)" data-tooltip="RIDING.unmount" width="36" height="36">
    </div>
    `),R(H,"preRenderedMountHud",'<div class="control-icon" data-action="ride"><i class="fas fa-horse" data-tooltip="RIDING.mount" width="36" height="36"></div>'),R(H,"preRenderedSpeedHud",`
    <div class="control-icon" data-action="rideIncrease"><i class="fas fa-caret-up" data-tooltip="RIDING.increase" width="36" height="36"></div>
    <div class="control-icon" data-action="rideDecrease"><i class="fas fa-caret-down" data-tooltip="RIDING.decrease" width="36" height="36"></div>
    `),R(H,"speedKeys",{0:{key:"system.status.speed.multiplier",mode:5,value:0},"-4":{key:"system.status.speed.initial",mode:5,value:4},"-5000":{key:"system.status.speed.multiplier",mode:5,value:.66},"-8":{key:"system.status.speed.multiplier",mode:5,value:1}});var ue=class extends Item{static defaultIcon(e){(!e.img||e.img=="")&&(e.type in this.defaultImages?e.img=this.defaultImages[e.type]:e.img="systems/dsa5/icons/blank.webp")}static async create(e,t){return this.defaultIcon(e),await super.create(e,t)}static getSpecAbModifiers(e,t){let a=[];for(let s of e.find(".specAbs")){let i=Number($(s).attr("data-step"));if(i>0){let r=t=="attack"?$(s).attr("data-atbonus"):$(s).attr("data-pabonus"),n=r.split(",").reduce((o,c)=>o+Number(c),0);a.push({name:$(s).find("a").text(),value:isNaN(n)?Number(r.replace("*","")):Number(n)*i,damageBonus:$(s).attr("data-tpbonus"),dmmalus:$(s).attr("data-dmmalus")*i,step:i,specAbId:$(s).attr("data-id"),type:/^\*/.test(r)?"*":void 0})}}return a}static setupSubClasses(){game.dsa5.config.ItemSubclasses={ritual:ls,spell:Ue,liturgy:Jt,ceremony:ts,advantage:Xt,disadvantage:Xt,aggregatedTest:Ja,trait:ps,blessing:es,magictrick:Yt,specialability:ds,disease:rs,poison:os,armor:Za,rangeweapon:Ct,meleeweapon:St,ammunition:Xa,equipment:ns,combatskill:as,skill:Dt,application:cs,consumable:ss,spellextension:us,species:ms,effectwrapper:Qa,plant:Ua,magicalsign:Va,patron:Ya,demonmark:Ka,information:is}}static buildSpeaker(e,t){return{token:t,actor:e?.id,scene:canvas.scene?.id}}static parseValueType(e,t){let a="";return/^\*/.test(t)&&(a="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:a}}async addCondition(e,t=1,a=!1,s=!0){return await I.addCondition(this,e,t,a,s)}async removeCondition(e,t=1,a=!0,s=!1){return I.removeCondition(this,e,t,a,s)}hasCondition(e){return I.hasCondition(this,e)}static getMiracleModifiers(e,t,a,s){let i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),r=(getProperty(e,"system.happyTalents.value")||"").split(/;|,/).map(o=>o.replace(i,"").trim()),n=[];if(r.includes(t.name)){let o=e.system.status.karmaenergy.value,c=getProperty(e,`system.miracle.${s}`)||0;if(o<4)return[];n.push({name:game.i18n.localize("LocalizedIDs.miracle"),value:2+c,type:a,selected:!1});let m=game.i18n.localize("LocalizedIDs.miracleMight");o>=6&&N.hasAbility(e,m)&&n.push({name:m,value:3+c,type:a,selected:!1})}return n}static getSkZkModifier(e,t){let a=[],s=[],i=["spell","liturgy","ceremony","ritual"].includes(t.type)&&t.system.effectFormula.value.trim()=="";game.user.targets.size&&game.user.targets.forEach(r=>{if(r.actor){let n=0;i&&(n=M.detectCreatureType(r.actor).reduce((d,u)=>d+u.spellResistanceModifier(r.actor),0));let o=getProperty(r.actor,`system.status.soulpower.${t.type}resist`)||0,c=getProperty(r.actor,`system.status.toughness.${t.type}resist`)||0;a.push((r.actor.system.status.soulpower.max+o)*-1-n),s.push((r.actor.system.status.toughness.max+c)*-1-n)}}),mergeObject(e,{SKModifier:a.length>0?Math.min(...a):0,ZKModifier:s.length>0?Math.min(...s):0})}static async _onCreateDocuments(e,t){for(let a of e)a.actor&&await T.postUpdateConditions(a.actor);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)a.actor&&await T.postUpdateConditions(a.actor);return super._onUpdateDocuments(e,t)}static async _onDeleteDocuments(e,t){for(let a of e)a.actor&&await T.postUpdateConditions(a.actor);return super._onDeleteDocuments(e,t)}static parseEffect(e,t){let a={},s=new RegExp(game.i18n.localize("CHARAbbrev.GS"),"gi");for(let i of e.split(/,|;/).map(r=>r.trim())){let r=i.replace(/(\s+)/g," ").trim().split(" ");r[0]=r[0].replace(s,t.system.status.speed.max),r.length==2&&(!isNaN(r[0])||/(=)?[+-]\d([+-]\d)?/.test(r[0])||/(=)?\d[dDwW]\d/.test(r[0])||/=\d+/.test(r[0])||/\*\d(\.\d)*/.test(r[0]))&&(a[r[1].toLowerCase()]==null?a[r[1].toLowerCase()]=[r[0]]:a[r[1].toLowerCase()].push(r[0]))}return a}static getDefenseMalus(e,t){let a=!1;if(t.flags.oppose){let s=game.messages.get(t.flags.oppose.messageId),i=s.flags.data.preData;a=!(getProperty(i,"source.type")=="meleeweapon"||getProperty(i,"source.system.traitType.value")=="meleeAttack");let r=/ \[(-)?\d{1,}\]/;for(let n of i.situationalModifiers)n.dmmalus!=null&&n.dmmalus!=0?e.push({name:`${game.i18n.localize("MODS.defenseMalus")} - ${n.name.replace(r,"")}`,value:n.dmmalus,selected:!0}):n.type=="defenseMalus"&&n.value!=0&&e.push({name:n.name.replace(r,""),value:n.value,selected:!0});s.flags.data.postData.halfDefense&&e.push({name:`${game.i18n.localize("MODS.defenseMalus")} - ${game.i18n.localize("halfDefenseShort")}`,value:.5,type:"*",selected:!0})}return a}static changeChars(e,t,a,s){e.system.characteristic1.value=t,e.system.characteristic2.value=a,e.system.characteristic3.value=s}static attackSpecAbs(e,t,a="effect.value"){let s=game.i18n.localize("LocalizedAbilityModifiers.at"),i=game.i18n.localize("LocalizedAbilityModifiers.tp"),r=game.i18n.localize("LocalizedAbilityModifiers.dm"),n=[];for(let o of e){let c=ue.parseEffect(getProperty(o.system,a),t),m=c[s]||0,d=c[i]||0,u=c[r]||0,p=["","2","3"].map(f=>getProperty(o,`system.effect.value${f}`)).filter(f=>f).length;if(m!=0||d!=0||u!=0||o.effects.size>0){let f=game.i18n.localize(y.combatSkillSubCategories[o.system.category.sub]);n.push({name:o.name,atbonus:m,tpbonus:d,dmmalus:u,label:`${s.toUpperCase()}: ${m}, ${i.toUpperCase()}: ${d}, ${r.toUpperCase()}: ${u}`,steps:o.system.step.value,category:{id:o.system.category.sub,css:`ab_${o.system.category.sub}`,name:f},id:o.id,actor:t.id,variantCount:p})}}return n}static defenseSpecAbs(e,t,a="effect.value"){let s=[],i=game.i18n.localize("LocalizedAbilityModifiers.pa");for(let r of e){let o=ue.parseEffect(getProperty(r.system,a),t)[i]||0;if(o!=0){let c=game.i18n.localize(y.combatSkillSubCategories[r.system.category.sub]),m=["","2","3"].map(d=>getProperty(r,`system.effect.value${d}`)).filter(d=>d).length;s.push({name:r.name,pabonus:o,tpbonus:0,dmmalus:0,label:`${i}: ${o}`,steps:r.system.step.value,category:{id:r.system.category.sub,css:`ab_${r.system.category.sub}`,name:c},id:r.id,actor:t.id,variantCount:m})}}return s}static buildCombatSpecAbs(e,t,a,s){let i;a?(a.push(game.i18n.localize("LocalizedIDs.all")),a=a.map(o=>o.toLowerCase()),i=(o,c)=>o.system.list.value.split(/;|,/).map(m=>m.trim().toLowerCase()).filter(m=>c.includes(m.replace(/ \([a-zA-Z äüöÄÖÜ]*\)/,""))).length>0):i=()=>!0;let r=game.combat?.isBrawling?()=>!0:o=>Number(o.system.category.sub)!=5,n=e.items.filter(o=>o.type=="specialability"&&t.includes(o.system.category.value)&&o.system.effect.value!=""&&i(o,a)&&r(o));return s=="attack"?this.attackSpecAbs(n,e):this.defenseSpecAbs(n,e)}static getCombatSkillModifier(e,t,a){if(t.type=="trait")return;let s=e.items.find(i=>i.type=="combatskill"&&i.name==t.system.combatskill.value);for(let i of s.effects)for(let r of i.changes)switch(r.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":a.push({name:`${s.name} - ${game.i18n.localize("MODS.defenseMalus")}`,value:r.value*-1,type:"defenseMalus",selected:!0});break}}static attackStatEffect(e,t){t!=0&&(t=isNaN(t)?t:Number(t),e.push({name:game.i18n.localize("statuseffects"),value:t,selected:!0}))}static getTargetSizeAndModifier(e,t,a){let s="average";return game.user.targets.forEach(i=>{if(i.actor){let r=getProperty(i.actor,"system.status.size.value");r&&(s=r),M.addCreatureTypeModifiers(i.actor,t,a,e)}}),s}static prepareRangeAttack(e,t,a,s,i,r,n=void 0){e.push(...O.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.restrictedSenseSight"),-2)),this.getCombatSkillModifier(t,s,e);let o=this.getTargetSizeAndModifier(t,s,e),c=Number(t.system.rangeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("statuseffects")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0});let m={...y.rangeWeaponModifiers};delete m[O.hasVantage(t,game.i18n.localize("LocalizedIDs.senseOfRange"))?"long":"rangesense"],N.hasAbility(t,game.i18n.localize("LocalizedIDs.extremeShot"))||delete m.extreme;let d=N.hasAbility(t,game.i18n.localize("LocalizedIDs.drivingArcher")),u=N.hasAbility(t,game.i18n.localize("LocalizedIDs.mountedArcher")),p;u&&H.isRiding(t)?p=duplicate(y.mountedRangeOptionsSpecAb):d?p=duplicate(y.drivingArcherOptions):p=duplicate(y.mountedRangeOptions),this.swarmModifiers(t,"attack",e),mergeObject(a,{rangeOptions:m,rangeDistance:Object.keys(m)[K.distanceModifier(game.canvas.tokens.get(i),s,n)],sizeOptions:y.rangeSizeCategories,visionOptions:y.rangeVision,mountedOptions:p,shooterMovementOptions:y.shooterMovementOptions,targetMovementOptions:y.targetMomevementOptions,targetSize:o,combatSpecAbs:r,aimOptions:y.aimOptions})}static swarmModifiers(e,t,a){e.system.swarm?.count>1&&(t=="attack"?a.push({name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:e.system.swarm.parry,type:"defenseMalus",selected:!0},{name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("CHARAbbrev.AT")}`,value:e.system.swarm.attack,selected:!0},{name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("CHARAbbrev.damage")}`,value:e.system.swarm.damage,type:"dmg",selected:!0}):a.push({name:`${game.i18n.localize("swarm.name")} - ${game.i18n.localize("CHARAbbrev.PA")}`,value:e.system.swarm.parry,selected:!0}))}static prepareMeleeAttack(e,t,a,s,i,r){let n="short";game.user.targets.forEach(m=>{if(m.actor){for(let d of m.actor.items)if((d.type=="meleeweapon"&&d.system.worn.value||d.type=="trait"&&d.system.traitType.value=="meleeAttack"&&d.system.pa)&&(y.meleeRangesArray.indexOf(d.system.reach.value)>y.meleeRangesArray.indexOf(n)&&(n=d.system.reach.value),n=="long"))break}});let o=this.getTargetSizeAndModifier(t,s,e);this.getCombatSkillModifier(t,s,e);let c=Number(t.system.meleeStats.defenseMalus)*-1;c!=0&&e.push({name:`${game.i18n.localize("statuseffects")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0}),this.swarmModifiers(t,"attack",e),mergeObject(a,{visionOptions:y.meleeRangeVision(a.mode),weaponSizes:y.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:n,combatSpecAbs:i,meleeSizeOptions:y.meleeSizeCategories,targetSize:o,constricted:t.hasCondition("constricted"),wrongHandDisabled:r,offHand:!r&&getProperty(s,"system.worn.offHand")})}static prepareMeleeParry(e,t,a,s,i,r){let n=ue.getDefenseMalus(e,t);this.swarmModifiers(t,"parry",e),mergeObject(a,{visionOptions:y.meleeRangeVision(a.mode),showDefense:!0,isRangeDefense:n,wrongHandDisabled:r&&getProperty(s,"system.worn.offHand"),offHand:!r&&getProperty(s,"system.worn.offHand")&&!_.isShield(s),melee:!0,combatSpecAbs:i,constricted:t.hasCondition("constricted")})}static _chatLineHelper(e,t){return`<b>${game.i18n.localize(e)}</b>: ${t||"-"}`}static setupDialog(e,t,a,s,i){return null}setupEffect(e,t={},a){return ue.getSubClass(this.type).setupDialog(e,t,this,a)}static checkEquality(e,t){return t.type==e.type&&e.name==t.name&&e.system.description?.value==t.system.description?.value}static async combineItem(e,t,a){return e=duplicate(e),e.system.quantity.value+=t.system.quantity.value,await a.updateEmbeddedDocuments("Item",[e])}static areEquals(e,t){return e.type!=t.type?!1:ue.getSubClass(e.type).checkEquality(e,t)}static async stackItems(e,t,a){return await ue.getSubClass(e.type).combineItem(e,t,a)}_setupCardOptions(e,t,a){let s=ChatMessage.getSpeaker();return{speaker:{alias:s.alias,scene:s.scene},flags:{img:s.token?canvas.tokens.get(s.token).document.img:this.img},title:t,template:e}}async itemTest({testData:e,cardOptions:t},a={}){e=await _DiceDSA5.rollDices(e,t);let s=await _DiceDSA5.rollTest(e);if(s.postFunction="itemTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}return a.suppressMessage||_DiceDSA5.renderRollCard(t,s,a.rerenderMessage),{result:s,cardOptions:t}}static chatData(e,t){return[]}static getSubClass(e){return game.dsa5.config.ItemSubclasses[e]||ue}async postItem(){ue.getSubClass(this.type)._postItem(this)}static async _postItem(e){let t=duplicate(e),a=getProperty(t,"system.obfuscation.details"),s=getProperty(t,"system.obfuscation.description");if(mergeObject(t,{properties:a?[]:ue.getSubClass(e.type).chatData(duplicate(t.system),e.name),descriptionObfuscated:s}),t.hasPrice="price"in t.system&&!a,t.hasPrice){let n=t.system.price.value;t.system.QL&&(n=ue.getSubClass(t.type).consumablePrice(t)),t.system.price.D=Math.floor(n/10),n-=t.system.price.D*10,t.system.price.S=Math.floor(n),n-=t.system.price.S,t.system.price.H=Math.floor(n/.1),n-=t.system.price.H*.1,t.system.price.K=Math.round(n/.01);let o=["D","S","H","K"].map(c=>`${t.system.price[c]} <div data-tooltip="${game.i18n.localize(`Money-${c}`)}" class="chatmoney money-${c}"></div>`).join(",");t.properties.push(`<b>${game.i18n.localize("price")}</b>: ${o}`)}e.pack&&(t.itemLink=e.link),t.img.includes("/blank.webp")&&(t.img=null);let i=await renderTemplate("systems/dsa5/templates/chat/post-item.html",t),r=g.chatDataSetup(i);ChatMessage.create(r)}},S=ue;R(S,"defaultImages",{advantage:"systems/dsa5/icons/categories/Vorteil.webp",disadvantage:"systems/dsa5/icons/categories/Nachteil.webp",armor:"systems/dsa5/icons/categories/Armor.webp",meleeweapon:"systems/dsa5/icons/categories/Meleeweapon.webp",rangeweapon:"systems/dsa5/icons/categories/Rangeweapon.webp",equipment:"systems/dsa5/icons/categories/Equipment.webp",consumable:"systems/dsa5/icons/categories/consumable.webp",liturgy:"systems/dsa5/icons/categories/Liturgy.webp",spell:"systems/dsa5/icons/categories/Spell.webp",ammunition:"systems/dsa5/icons/categories/Munition.webp",career:"systems/dsa5/icons/categories/Career.webp",magictrick:"systems/dsa5/icons/categories/Spelltrick.webp",blessing:"systems/dsa5/icons/categories/Blessing.webp",combatskill:"systems/dsa5/icons/categories/Combat_Skill.webp",skill:"systems/dsa5/icons/categories/Skill.webp",Geweihte:"systems/dsa5/icons/categories/Geweihte.webp",Weltliche:"systems/dsa5/icons/categories/Weltliche.webp",Zauberer:"systems/dsa5/icons/categories/Zauberer.webp",ritual:"systems/dsa5/icons/categories/ritual.webp",ceremony:"systems/dsa5/icons/categories/ceremony.webp",abilityclerical:"systems/dsa5/icons/categories/ability_clerical.webp",abilityCombat:"systems/dsa5/icons/categories/ability_combat.webp",abilityfatePoints:"systems/dsa5/icons/categories/ability_fate_points.webp",abilitygeneral:"systems/dsa5/icons/categories/ability_general.webp",specialability:"systems/dsa5/icons/categories/ability_general.webp",abilitymagical:"systems/dsa5/icons/categories/ability_magical.webp",abilitylanguage:"systems/dsa5/icons/categories/Ability_Language.webp",abilitystaff:"systems/dsa5/icons/categories/ability_staff.webp",abilityceremonial:"systems/dsa5/icons/categories/ability_ceremonial.webp",abilityanimal:"systems/dsa5/icons/categories/ability_animal.webp",trait:"systems/dsa5/icons/categories/trait.webp",Tiere:"systems/dsa5/icons/categories/Tiere.webp",aggregatedTest:"systems/dsa5/icons/categories/aggregated_test.webp",poison:"systems/dsa5/icons/categories/poison.webp",disease:"systems/dsa5/icons/categories/disease.webp",spellextension:"systems/dsa5/icons/categories/Spellextension.webp",species:"icons/environment/people/group.webp",application:"systems/dsa5/icons/categories/Skill.webp",trick:"systems/dsa5/icons/categories/Tiere.webp",disadvantageanimal:"systems/dsa5/icons/categories/NachteilAnimal.webp",advantageanimal:"systems/dsa5/icons/categories/VorteilAnimal.webp",diseaseanimal:"systems/dsa5/icons/categories/diseaseAnimal.webp",effectwrapper:"icons/svg/aura.svg",liturgyTalisman:"systems/dsa5/icons/categories/LiturgieTalisman.webp",plant:"systems/dsa5/icons/categories/plant.webp",magicalsign:"systems/dsa5/icons/categories/magicalsign.webp",abilitypact:"systems/dsa5/icons/categories/ability_pact.webp",demonmark:"systems/dsa5/icons/categories/ability_pact.webp",patron:"systems/dsa5/icons/categories/ability_pact.webp",information:"systems/dsa5/icons/categories/DSA-Auge.webp",essence:"systems/dsa5/icons/categories/wesenszug.webp",imprint:"systems/dsa5/icons/categories/praegung.webp"});var Ua=class extends S{static chatData(e,t){return[this._chatLineHelper("effect",e.effect),this._chatLineHelper("PLANT.recipes",e.recipes),this._chatLineHelper("PLANT.usages",e.usages)]}},Va=class extends S{static chatData(e,t){let a=[this._chatLineHelper("AsPCost",e.asp)];return e.category==2&&a.push(this._chatLineHelper("feature",e.feature)),a}},Ka=class extends S{static chatData(e,t){return[this._chatLineHelper("attributes",e.attribute),this._chatLineHelper("skills",e.skills),this._chatLineHelper("domains",e.domain)]}},Ya=class extends S{static chatData(e,t){return[this._chatLineHelper("skills",e.talents),this._chatLineHelper("culture",e.culture),this._chatLineHelper("Category",game.i18n.localize(`PATRON.${e.category}`))]}},Ja=class extends S{static async _postItem(e){let t="",a=game.i18n.localize("Ongoing");e.system.cummulatedQS.value>=10?(a=game.i18n.localize("Success"),t=`${await TextEditor.enrichHTML(e.system.partsuccess,{secrets:this.isOwner,async:!0})}${await TextEditor.enrichHTML(e.system.success,{secrets:this.isOwner,async:!0})}`):e.system.cummulatedQS.value>=6?(a=game.i18n.localize("PartSuccess"),t=`${await TextEditor.enrichHTML(e.system.partsuccess,{secrets:this.isOwner,async:!0})}`):e.system.allowedTestCount.value-e.system.usedTestCount.value<=0&&(a=game.i18n.localize("Failure"));let s=[this._chatLineHelper("cummulatedQS",`${e.system.cummulatedQS.value} / 10`),this._chatLineHelper("interval",e.system.interval.value),this._chatLineHelper("probes",`${e.system.usedTestCount.value} / ${e.system.allowedTestCount.value}`),this._chatLineHelper("result",a),t],i=getProperty(e,"system.obfuscation.description"),r=await renderTemplate("systems/dsa5/templates/chat/aggregatedTestResult.html",{descriptionObfuscated:i,item:e,properties:s}),n=g.chatDataSetup(r);ChatMessage.create(n)}},Xa=class extends S{static chatData(e,t){return[this._chatLineHelper("ammunitiongroup",game.i18n.localize(e.ammunitiongroup.value))]}},Qa=class extends S{},Za=class extends S{static chatData(e,t){let a=[this._chatLineHelper("protection",e.protection.value),this._chatLineHelper("encumbrance",e.encumbrance.value)];return e.effect.value!=""&&a.push(this._chatLineHelper("effect",e.effect.value)),a}},Yt=class extends S{static chatData(e,t){return[this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("feature",e.feature.value)]}},es=class extends Yt{},Ue=class extends S{static chatData(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",g.replaceConditions(g.replaceDies(e.effect.value)))]}static async getCallbackData(e,t,a){e.testDifficulty=0,e.situationalModifiers=T._parseModifiers(t);let s=new FormDataExtended(t.find("form")[0]).object;e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text(),maintainCost:t.find(".maintainCost").text()},e.situationalModifiers.push({name:game.i18n.localize("removeGesture"),value:Number(s.removeGesture)||0},{name:game.i18n.localize("removeFormula"),value:Number(s.removeFormula)||0},{name:game.i18n.localize("castingTime"),value:t.find(".castingTime").data("mod")},{name:game.i18n.localize("cost"),value:t.find(".aspcost").data("mod")},{name:game.i18n.localize("reach"),value:t.find(".reach").data("mod")},{name:game.i18n.localize("zkModifier"),value:s.zkModifier||0},{name:game.i18n.localize("skModifier"),value:s.skModifier||0},{name:game.i18n.localize("maintainedSpells"),value:s.maintainedSpells*-1}),e.extensions=Ue.getSpecAbModifiers(t),e.advancedModifiers={chars:[0,1,2].map(i=>s[`ch${i}`]),fws:s.fw,qls:s.qs},S.changeChars(e.source,...[0,1,2].map(i=>s[`characteristics${i}`])),await this.applyExtensions(e.source,e.extensions,a)}static async applyExtensions(e,t,a){_.ensureNumber(e);let s=Object.keys(ne.rollModifiers).map(i=>`${i}.mod`);for(let i of t){let r=fromUuidSync(i.uuid);if(!!r)for(let n of r.effects)for(let o of n.changes)ne.rollChanges.includes(o.key)||s.includes(o.key)||(o.key=="macro.transform"?await g.callItemTransformationMacro(o.value,e,n):n.apply(e,o))}}static getSpecAbModifiers(e){let t=[];for(let a of e.find(".specAbs.active"))t.push({name:a.dataset.name,title:a.getAttribute("title"),uuid:a.dataset.uuid});return t}static attackSpellMalus(e){let t=[];return e.system.effectFormula.value&&t.push({name:game.i18n.localize("MODS.defenseMalus"),value:-4,type:"defenseMalus",selected:!0,source:e.name}),t}static getPropertyModifiers(e,t){let a=["ceremony","liturgy"].includes(t.type),s=(getProperty(t,"system.feature")||"").replace(/\(a-z äöü\-\)/gi,"").split(",").map(c=>c.trim()),i=[],r=a?"KaPCost":"AsPCost",n=["FP","step","QL","TPM","FW",r];for(let c of n){let m=c=="step"?"":c,d=getProperty(e.system.skillModifiers,`feature.${c}`);i.push(...d.filter(u=>s.includes(u.target)).map(u=>({name:u.source,value:u.value,type:m,source:u.source})))}let o=getProperty(e.system.skillModifiers,`conditional.${r}`);return i.push(...o.map(c=>({name:c.target,value:c.value,type:r}))),i}static foreignSpellModifier(e,t,a,s){if(game.settings.get("dsa5","enableForeignSpellModifer")&&["npc","character"].includes(e.type)&&["spell","ritual"].includes(t.type)){let i=t.system.distribution.value.split(",").map(o=>o.trim().toLowerCase()),r=new RegExp(`(${game.i18n.localize("tradition")}|\\)|\\()`,"g"),n=e.system.tradition.magical.replace(r,"").split(",").map(o=>o.trim().toLowerCase());n.push(game.i18n.localize("general").toLowerCase()),s.isForeign=!i.some(o=>n.includes(o)),s.isForeign&&a.push({name:game.i18n.localize("DSASETTINGS.enableForeignSpellModifer"),value:-2,selected:!0})}}static getSituationalModifiers(e,t,a,s){e.push(...Q.getTalentBonus(t,s.name,["advantage","disadvantage","specialability","equipment"]),...O.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalAttunement"),1,!0),...O.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalRestriction"),-1,!0),...O.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.boundToArtifact"),-1,!0),...this.getPropertyModifiers(t,s),...this.attackSpellMalus(s)),this.foreignSpellModifier(t,s,e,a),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&M.addCreatureTypeModifiers(i.actor,s,e,t)}),e.push(...t.getSkillModifier(s.name,s.type));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value});this.getSkZkModifier(a,s)}static setupDialog(e,t,a,s,i){let r="spell";(a.type=="ceremony"||a.type=="liturgy")&&(r="liturgy");let n=a.name+" "+game.i18n.localize(`${a.type}Test`)+(t.subtitle||""),o={opposable:a.system.effectFormula.value.length>0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:S.buildSpeaker(s,i)},advancedModifiers:{chars:[0,0,0],fws:0,qls:0},calculatedSpellModifiers:{castingTime:0,cost:0,reach:0,maintainCost:0}},c={rollMode:t.rollMode,spellCost:a.system.AsPCost.value,maintainCost:a.system.maintainCost.value,spellCastingTime:a.system.castingTime.value,spellReach:a.system.range.value,canChangeCost:a.system.canChangeCost.value=="true",canChangeRange:a.system.canChangeRange.value=="true",canChangeCastingTime:a.system.canChangeCastingTime.value=="true",hasSKModifier:a.system.resistanceModifier.value=="SK",hasZKModifier:a.system.resistanceModifier.value=="ZK",maxMods:Math.floor(Number(a.system.talentValue.value)/4),extensions:this.prepareExtensions(s,a),variableBaseCost:a.system.variableBaseCost=="true",characteristics:[1,2,3].map(p=>a.system[`characteristic${p}`].value)},m=s?I.getRollModifiers(s,a):[];this.getSituationalModifiers(m,s,c,a),c.situationalModifiers=m;let d={title:n,template:`/systems/dsa5/templates/dialog/${r}-enhanced-dialog.html`,data:c,callback:async(p,f={})=>(u.rollMode=p.find('[name="rollMode"]').val(),await this.getCallbackData(o,p,s),mergeObject(o.extra.options,f),{testData:o,cardOptions:u})},u=s._setupCardOptions("systems/dsa5/templates/chat/roll/spell-card.html",n,i);return _DiceDSA5.setupDialog({dialogOptions:d,testData:o,cardOptions:u})}static prepareExtensions(e,t){return e.items.filter(a=>a.type=="spellextension"&&a.system.source==t.name&&a.system.category==t.type).map(a=>(a.shortName=a.name.split(" - ").length>1?a.name.split(" - ")[1]:a.name,a.descr=$(a.system.description.value).text()||"",a))}},Jt=class extends Ue{static chatData(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("KaPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",g.replaceConditions(g.replaceDies(e.effect.value)))]}},ts=class extends Jt{static getCallbackData(e,t,a){super.getCallbackData(e,t,a),e.situationalModifiers.push({name:game.i18n.localize("CEREMONYMODIFIER.artefact"),value:t.find('[name="artefactUsage"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}static getSituationalModifiers(e,t,a,s){super.getSituationalModifiers(e,t,a,s),mergeObject(a,{isCeremony:!0,locationModifiers:y.ceremonyLocationModifiers,timeModifiers:y.ceremonyTimeModifiers})}},as=class extends S{static chatData(e,t){return[this._chatLineHelper("Description",game.i18n.localize(`Combatskilldescr.${t}`))]}static setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize(r+"test"),o={opposable:!0,source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:S.buildSpeaker(s,i)}},c={title:n,template:"systems/dsa5/templates/dialog/combatskill-dialog.html",data:{rollMode:t.rollMode},callback:(d,u={})=>(m.rollMode=d.find('[name="rollMode"]').val(),o.situationalModifiers=T._parseModifiers(d),mergeObject(o.extra.options,u),{testData:o,cardOptions:m})},m=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSA5.setupDialog({dialogOptions:c,testData:o,cardOptions:m})}},ss=class extends S{static chatData(e,t){return[this._chatLineHelper("qualityStep",e.QL),this._chatLineHelper("effect",g.replaceDies(e.QLList.split(`
`)[e.QL-1])),this._chatLineHelper("charges",e.charges)]}static consumablePrice(e){let t=e.system.price.value;if(isNaN(t)){let a=t.split(";");return t=Number(a[e.system.QL-1]),isNaN(t)&&(t=Number(a.pop())||0),t}else return Number(t)*e.system.QL||0}static checkEquality(e,t){return e.type==t.type&&e.name==t.name&&e.system.description.value==t.system.description.value&&e.system.QL==t.system.QL}static async setupDialog(e,t,a,s){let i=game.i18n.format("CHATNOTIFICATION.usesItem",{actor:a.actor.name,item:a.name});if(!a.isOwned)return;if((a.system.quantity.value-1)*a.system.maxCharges+a.system.charges<=0){ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));return}let n=a.system.charges<=1?a.system.maxCharges:a.system.charges-1,o=a.system.charges<=1?a.system.quantity.value-1:a.system.quantity.value,c=g.replaceDies(a.system.QLList.split(`
`)[a.system.QL-1],!1),m=`<div><b>${i}</b></div><div>${a.system.description.value}</div><div><b>${game.i18n.localize("effect")}</b>: ${c}</div>`;o==0?await a.actor.deleteEmbeddedDocuments("Item",[a.id]):await a.update({"system.quantity.value":o,"system.charges":n}),await ChatMessage.create(g.chatDataSetup(m)),await this._applyActiveEffect(a)}static async _applyActiveEffect(e){let t=e.effects.toObject();if(t.length>0){let{msg:a,resistRolls:s,effectNames:i}=await _DSAActiveEffectConfig.applyAdvancedFunction(e.actor,t,e,{qualityStep:e.system.QL},e.actor),r=`${game.i18n.format("ActiveEffects.appliedEffect",{target:e.actor.token?.name||e.actor.name,source:i.join(", ")})} ${a||""}`;ChatMessage.create(g.chatDataSetup(r))}}static async combineItem(e,t,a){e=duplicate(e);let s=(e.system.quantity.value-1)*e.system.maxCharges+e.system.charges,i=(t.system.quantity.value-1)*t.system.maxCharges+t.system.charges,r=Math.floor((s+i)/e.system.maxCharges)+1,n=(s+i)%e.system.maxCharges;return n==0&&(r-=1,n=e.system.maxCharges),e.system.quantity.value=r,e.system.charges=n,await a.updateEmbeddedDocuments("Item",[e])}},is=class extends S{static async _postItem(e){let t=await renderTemplate("systems/dsa5/templates/chat/informationRequestRoll.html",{item:e}),a=g.chatDataSetup(t);ChatMessage.create(a)}},rs=class extends S{static chatData(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("incubation",e.incubation.value),this._chatLineHelper("damage",g.replaceConditions(g.replaceDies(e.damage.value))),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("source",g.replaceDies(e.source.value)),this._chatLineHelper("treatment",e.treatment.value),this._chatLineHelper("antidot",e.antidot.value),this._chatLineHelper("resistanceModifier",e.resistance.value)]}static getSituationalModifiers(e,t,a,s){s=g.toObjectIfPossible(s),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...O.getVantageAsModifier(i.actor,game.i18n.localize("LocalizedIDs.ResistanttoDisease"),-1,!1,!0))}),this.getSkZkModifier(a,s),mergeObject(a,{hasSKModifier:s.system.resistance.value=="SK",hasZKModifier:s.system.resistance.value=="ZK"})}static setupDialog(e,t,a,s,i){let r=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),n={opposable:!1,source:a,extra:{options:t,speaker:S.buildSpeaker(s,i)}},o={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,s,o,a),o.situationalModifiers=c,t.manualResistance&&mergeObject(o,t.manualResistance);let m={title:r,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:o,callback:(u,p={})=>(d.rollMode=u.find('[name="rollMode"]').val(),n.situationalModifiers=T._parseModifiers(u),n.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:u.find('[name="zkModifier"]').val()||0},{name:game.i18n.localize("skModifier"),value:u.find('[name="skModifier"]').val()||0}),mergeObject(n.extra.options,p),{testData:n,cardOptions:d})},d=a._setupCardOptions(`systems/dsa5/templates/chat/roll/${a.type}-card.html`,r,i);return _DiceDSA5.setupDialog({dialogOptions:m,testData:n,cardOptions:d})}},ns=class extends S{static chatData(e,t){return[this._chatLineHelper("equipmentType",game.i18n.localize(`Equipment.${e.equipmentType.value}`))]}},St=class extends S{static chatData(e,t){let a=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("atmod",e.atmod.value),this._chatLineHelper("pamod",e.pamod.value),this._chatLineHelper("reach",game.i18n.localize(`Range-${e.reach.value}`)),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill.value)];return e.effect.value!=""&&a.push(this._chatLineHelper(g.replaceConditions("effect",e.effect.value))),a}static getSituationalModifiers(e,t,a,s){let i=O.hasVantage(t,game.i18n.localize("LocalizedIDs.ambidextrous"));s=g.toObjectIfPossible(s);let r=[s.system.combatskill.value],n=S.buildCombatSpecAbs(t,["Combat"],r,a.mode);a.mode=="attack"?this.prepareMeleeAttack(e,t,a,s,n,i):a.mode=="parry"&&this.prepareMeleeParry(e,t,a,s,n,i),this.attackStatEffect(e,t.system.meleeStats[a.mode]),["attack","parry"].includes(a.mode)&&e.push(...St.getMiracleModifiers(t,{name:s.system.combatskill.value},"",a.mode))}static setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize(r+"test"),o={opposable:t.mode!="parry",source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:S.buildSpeaker(s,i)}},c=_.multipleDefenseValue(s,g.toObjectIfPossible(a)),m={rollMode:t.rollMode,mode:r,defenseCountString:game.i18n.format("defenseCount",{malus:c})},d=s?I.getRollModifiers(s,a,{mode:r}):[];this.getSituationalModifiers(d,s,m,a),m.situationalModifiers=d,t.situationalModifiers&&m.situationalModifiers.push(...t.situationalModifiers);let u={title:n,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:m,callback:(f,h={})=>(pe.resolveMeleeDialog(o,p,f,s,h,c,r),Hooks.call("callbackDialogCombatDSA5",o,s,f,a,i),o.isRangeDefense=m.isRangeDefense,{testData:o,cardOptions:p})},p=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSA5.setupDialog({dialogOptions:u,testData:o,cardOptions:p})}},os=class extends S{static chatData(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("poisonType",e.poisonType.value),this._chatLineHelper("start",e.start.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("resistanceModifier",e.resistance.value),this._chatLineHelper("effect",g.replaceConditions(g.replaceDies(e.effect.value)))]}static getSituationalModifiers(e,t,a,s){s=g.toObjectIfPossible(s),game.user.targets.size&&game.user.targets.forEach(i=>{i.actor&&e.push(...O.getVantageAsModifier(i.actor,game.i18n.localize("LocalizedIDs.poisonResistance"),-1,!1,!0))}),this.getSkZkModifier(a,s),mergeObject(a,{hasSKModifier:s.system.resistance.value=="SK",hasZKModifier:s.system.resistance.value=="ZK"})}static setupDialog(e,t,a,s,i){let r=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),n={opposable:!1,source:a,extra:{options:t,speaker:S.buildSpeaker(s,i)}},o={rollMode:t.rollMode},c=[];this.getSituationalModifiers(c,s,o,a),o.situationalModifiers=c;let m={title:r,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:o,callback:(u,p={})=>(d.rollMode=u.find('[name="rollMode"]').val(),n.situationalModifiers=T._parseModifiers(u),n.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:u.find('[name="zkModifier"]').val()||0}),n.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:u.find('[name="skModifier"]').val()||0}),mergeObject(n.extra.options,p),{testData:n,cardOptions:d})},d=a._setupCardOptions(`systems/dsa5/templates/chat/roll/${a.type}-card.html`,r,i);return _DiceDSA5.setupDialog({dialogOptions:m,testData:n,cardOptions:d})}},Ct=class extends S{static chatData(e,t){let a=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill.value),this._chatLineHelper("reach",e.reach.value)];return e.effect.value!=""&&a.push(this._chatLineHelper(g.replaceConditions("effect",e.effect.value))),a}static getSituationalModifiers(e,t,a,s,i){if(a.mode=="attack"){let r=g.toObjectIfPossible(s),n=[r.system.combatskill.value],o=S.buildCombatSpecAbs(t,["Combat"],n,a.mode),c=t.items.get(r.system.currentAmmo.value);if(c){c=c.toObject(!1),r.system.effect.attributes=(r.system.effect.attributes||"").split(",").concat((c.system.effect.attributes||"").split(",")).filter(d=>d!="").join(",");let m=getProperty(c.flags,"dsa5.poison");m&&mergeObject(s.flags,{dsa5:{poison:m}})}if(this.prepareRangeAttack(e,t,a,r,i,o,c),c){if(c.system.atmod&&e.push({name:`${c.name} - ${game.i18n.localize("atmod")}`,value:c.system.atmod,selected:!0,specAbId:r.system.currentAmmo.value}),c.system.damageMod||c.system.armorMod){let m={name:`${c.name} - ${game.i18n.localize("MODS.damage")}`,value:c.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:r.system.currentAmmo.value};c.system.armorMod&&(m.armorPen=c.system.armorMod),e.push(m)}c.effects.length&&e.push({name:`${c.name} - ${game.i18n.localize("TYPES.Item.ammunition")}`,value:1,type:"effect",selected:!0,specAbId:r.system.currentAmmo.value})}e.push(...Ct.getMiracleModifiers(t,{name:r.system.combatskill.value},"",a.mode))}this.attackStatEffect(e,t.system.rangeStats[a.mode])}static async checkAmmunitionState(e,t,a,s){let i=!0;if(s!="damage"){let r=e.system;if(r.ammunitiongroup.value!="infinite")if(r.ammunitiongroup.value=="-")t.extra.ammo=duplicate(e),i=t.extra.ammo.system.quantity.value>0;else{let n=a.items.get(r.currentAmmo.value);n?(t.extra.ammo=n.toObject(),r.ammunitiongroup.value=="mag"?i=t.extra.ammo.system.quantity.value>1||t.extra.ammo.system.mag.value>0&&t.extra.ammo.system.quantity.value>0:i=t.extra.ammo.system.quantity.value>0):i=!1}!i&&a.type=="creature"&&(i=!0)}return i||ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),i}static async setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize(r+"test"),o={opposable:t.mode!="parry",source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:S.buildSpeaker(s,i)}};if(!await this.checkAmmunitionState(a,o,s,r))return;let c={rollMode:t.rollMode,mode:r},m=s?I.getRollModifiers(s,a,{mode:r}):[];this.getSituationalModifiers(m,s,c,a,i),c.situationalModifiers=m,t.situationalModifiers&&c.situationalModifiers.push(...t.situationalModifiers);let d={title:n,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:c,callback:(p,f={})=>(pe.resolveRangeDialog(o,u,p,s,f),Hooks.call("callbackDialogCombatDSA5",o,s,p,a,i),{testData:o,cardOptions:u})},u=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSA5.setupDialog({dialogOptions:d,testData:o,cardOptions:u})}},ls=class extends Ue{static getCallbackData(e,t,a){super.getCallbackData(e,t,a),e.situationalModifiers.push({name:game.i18n.localize("RITUALMODIFIER.rightClothes"),value:t.find('[name="rightClothes"]').is(":checked")?1:0},{name:game.i18n.localize("RITUALMODIFIER.rightEquipment"),value:t.find('[name="rightEquipment"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}static getSituationalModifiers(e,t,a,s){super.getSituationalModifiers(e,t,a,s),mergeObject(a,{isRitual:!0,locationModifiers:y.ritualLocationModifiers,timeModifiers:y.ritualTimeModifiers})}},cs=class extends S{static chatData(e,t){let s=game.i18n.has(`APPLICATION.${e.system.skill} - ${t}`)?game.i18n.has(`APPLICATION.${e.system.skill} - ${t}`):e.description.value;return[this._chatLineHelper("Description",s)]}},Dt=class extends S{static chatData(e,t){let s=game.i18n.has(`SKILLdescr.${t}`)?game.i18n.localize(`SKILLdescr.${t}`):e.description.value;return[this._chatLineHelper("Description",s)]}static getSituationalModifiers(e,t,a,s){e.push(...Q.getTalentBonus(t,s.name,["advantage","disadvantage","specialability","equipment"]),...t.getSkillModifier(s.name,s.type),...Dt.getMiracleModifiers(t,s,"FW","skill"));for(let i of t.system.skillModifiers.global)e.push({name:i.source,value:i.value})}static setupDialog(e,t,a,s,i){let r=a.name+" "+game.i18n.localize("Test")+(t.subtitle||""),n={opposable:!0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:S.buildSpeaker(s,i)}},o={rollMode:t.rollMode,difficultyLabels:y.skillDifficultyLabels,modifier:t.modifier||0,characteristics:[1,2,3].map(d=>a.system[`characteristic${d}`].value),situationalModifiers:s?I.getRollModifiers(s,a):[]};t.situationalModifiers&&o.situationalModifiers.push(...t.situationalModifiers),this.getSituationalModifiers(o.situationalModifiers,s,o,a);let c={title:r,template:"/systems/dsa5/templates/dialog/skill-dialog.html",data:o,callback:(d,u={})=>(m.rollMode=d.find('[name="rollMode"]').val(),n.testDifficulty=y.skillDifficultyModifiers[d.find('[name="testDifficulty"]').val()],n.situationalModifiers=T._parseModifiers(d),n.advancedModifiers={chars:[0,1,2].map(p=>Number(d.find(`[name="ch${p}"]`).val())),fws:Number(d.find('[name="fw"]').val()),qls:Number(d.find('[name="qs"]').val())},S.changeChars(n.source,...[0,1,2].map(p=>d.find(`[name="characteristics${p}"]`).val())),mergeObject(n.extra.options,u),{testData:n,cardOptions:m})},m=s._setupCardOptions("systems/dsa5/templates/chat/roll/skill-card.html",r,i);return _DiceDSA5.setupDialog({dialogOptions:c,testData:n,cardOptions:m})}},ds=class extends S{static chatData(e,t){return[this._chatLineHelper("rule",e.rule.value)]}},ms=class extends S{},us=class extends S{static chatData(e,t){return[this._chatLineHelper("source",e.source),this._chatLineHelper("Category",game.i18n.localize(e.category))]}},ps=class extends S{static chatData(e,t){let a=[];switch(e.traitType.value){case"meleeAttack":a=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value)];break;case"rangeAttack":a=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value),this._chatLineHelper("reloadTime",e.reloadTime.value)];break;case"armor":a=[this._chatLineHelper("protection",e.damage.value)];break;case"general":a=[];break;case"familiar":a=[this._chatLineHelper("APValue",e.APValue.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("aspect",e.aspect.value)];break;case"trick":a=[this._chatLineHelper("APValue",e.APValue.value)];break;case"entity":a=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("CHARAbbrev.QL",e.AsPCost.value)];break;case"summoning":a=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("conjuringDifficulty",e.at.value)];break}return e.effect.value!=""&&a.push(this._chatLineHelper("effect",e.effect.value)),a}static getSituationalModifiers(e,t,a,s,i){s=g.toObjectIfPossible(s);let r=s.system.traitType.value,n=S.buildCombatSpecAbs(t,["Combat","animal"],void 0,a.mode);a.mode=="attack"&&r=="meleeAttack"?this.prepareMeleeAttack(e,t,a,s,n,!1):a.mode=="attack"&&r=="rangeAttack"?this.prepareRangeAttack(e,t,a,s,i,n):a.mode=="parry"&&this.prepareMeleeParry(e,t,a,s,n,!1),this.attackStatEffect(e,t.system[r=="meleeAttack"?"meleeStats":"rangeStats"][a.mode])}static setupDialog(e,t,a,s,i){let r=t.mode,n=a.name+" "+game.i18n.localize(r+"test"),o={opposable:t.mode!="parry",source:a,mode:r,extra:{actor:s.toObject(!1),options:t,speaker:S.buildSpeaker(s,i)}},c=_.multipleDefenseValue(s,a.toObject()),m={rollMode:t.rollMode,mode:r,defenseCountString:game.i18n.format("defenseCount",{malus:c})},d=getProperty(a,"system.traitType.value"),u=s?I.getRollModifiers(s,a,{mode:r}):[];this.getSituationalModifiers(u,s,m,a,i),m.situationalModifiers=u;let p={title:n,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:m,callback:(h,w={})=>(d=="meleeAttack"?pe.resolveMeleeDialog(o,f,h,s,w,c,r):pe.resolveRangeDialog(o,f,h,s,w),o.isRangeDefense=m.isRangeDefense,Hooks.call("callbackDialogCombatDSA5",o,s,h,a,i),{testData:o,cardOptions:f})},f=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",n,i);return _DiceDSA5.setupDialog({dialogOptions:p,testData:o,cardOptions:f})}},Xt=class extends S{static chatData(e,t){return[this._chatLineHelper("effect",e.effect.value)]}};var lt=class extends te{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}static setData(e,t,a){let s=duplicate(lt.rollModifiers);s.narrowSpace.mod=this.getNarrowSpaceModifier(a,a.mode);let i=`${t}RollModifiers`;if(e.system[i])for(let r of Object.keys(e.system[i]))s[r].mod+=Number(e.system[i][r]?.mod??0);return s}activateListeners(e){super.activateListeners(e);let t=e.find(".specAbs");t.mouseenter(i=>{if(i.currentTarget.getElementsByClassName("hovermenu").length==0){let r=document.createElement("div");r.classList.add("hovermenu");let n=document.createElement("i");n.classList.add("fas","fa-comment"),n.title=game.i18n.localize("SHEET.PostItem"),n.addEventListener("mousedown",this._postItem,!1),r.appendChild(n),i.currentTarget.appendChild(r)}}),t.mouseleave(i=>{let r=i.toElement||i.relatedTarget;r.parentNode==this||r==this||i.currentTarget.querySelectorAll(".hovermenu").forEach(n=>n.remove())}),e.find(".variantChange").mousedown(i=>this.changeSpecAbVariant(i)),e.on("mousedown",".specAbs",i=>{if(e.find(".opportunityAttack").is(":checked")){ui.notifications.error(game.i18n.localize("DSAError.opposedAttackNoSpecAbs"));return}let r=$(i.currentTarget),n=Number(r.attr("data-step")),o=Number(r.attr("data-maxStep")),c=Number(r.attr("data-category"));if(i.button==0){if(n=Math.min(o,n+1),[0,1].includes(c)&&game.settings.get("dsa5","limitCombatSpecAbs")){let m=r.siblings(`[data-category="${c}"]`);m.removeClass("active").attr("data-step",0),m.find(".step").text(te.roman[0])}}else i.button==2&&(n=Math.clamped(o,0,n-1));r.attr("data-step",n),r.toggleClass("active",n>0),r.find(".step").text(te.roman[n]),this.checkCounterAttack(i),this.calculateModifier()}),e.find(".opportunityAttack").change(i=>{if($(i.currentTarget).is(":checked"))for(let r of e.find(".specAbs"))$(r).removeClass("active").attr("data-step",0).find(".step").text("")}),e.on("change","input,select",i=>this.calculateModifier(i)),e.find(".modifiers option").mousedown(i=>{this.calculateModifier(i)}),e.find(".quantity-click").mousedown(i=>this.calculateModifier(i));let a=this.readTargets();this.calculateModifier();let s=this;this.checkTargets=setInterval(function(){a=s.compareTargets(e,a)},500)}checkCounterAttack(e){if(!this.dialogData.mode=="parry")return;let t=g.getSpeaker(this.dialogData.speaker);if(t&&t.items.get(e.currentTarget.dataset.id).name==game.i18n.localize("LocalizedIDs.counterAttack")){this.dialogData.counterAttack=e.button==0,this.prepareWeapon();let s=e.button==0?"attack":"parry",i=t.items.get(this.dialogData.source._id),r=I.getRollModifiers(t,i,{mode:s});S.getSubClass(i.type).getSituationalModifiers(r,t,{mode:s},i),s=="attack"&&(r=r.filter(o=>o.type!="defenseMalus"));let n=$(this._element).find("[name=situationalModifiers]");if(r.length>0){if(n.length==0){let c=`<div class="modifiers form-group custom-select">
                                            <label>${game.i18n.localize("DIALOG.SituationalModifiers")}</label>
                                            <select name="situationalModifiers" multiple data-tooltip="${game.i18n.localize("DIALOG.deselectWithStrg")}" />
                                        </div>`;$(this._element).find("[name=rollMode]").parent().after(c),this.position.height+=86,this.setPosition(this.position)}let o="";for(let c of r)o+=`<option value="${c.value}"
                                        data-tooltip="${Handlebars.helpers.situationalTooltip(c)}"
                                        ${c.type?" data-type="+c.type:""}
                                        ${c.specAbId?" data-specAbId="+c.specAbId:""}
                                        ${c.armorPen?" data-armorPen="+c.armorPen:""}
                                        ${c.selected?" selected":""}>
                                    ${c.name} [${c.value}]
                                </option>`;$(this._element).find(".modifiers select").html(o)}else n.length>0&&(n.parent().remove(),this.position.height-=86,this.setPosition(this.position))}}changeSpecAbVariant(e){e.stopPropagation(),e.preventDefault();let t=g.getSpeaker(this.dialogData.speaker);if(t){let s=Number(e.currentTarget.dataset.current)+1;s>=Number(e.currentTarget.dataset.variantcount)&&(s=0),e.currentTarget.dataset.current=s,$(e.currentTarget).text(["A","B","C"][s]);let i=$(e.currentTarget).closest(".specAbs")[0],r=t.items.get(i.dataset.id),n=`effect.value${["","2","3"][s]}`,o=(this.dialogData.mode=="attack"?S.attackSpecAbs([r],t,n):S.defenseSpecAbs([r],t,n))[0];i.dataset.dmmalus=o.dmmalus||0,i.dataset.atbonus=o.atbonus||0,i.dataset.tpbonus=o.tpbonus||0,i.dataset.pabonus=o.pabonus||0,i.dataset.tooltip=o.label,this.calculateModifier()}}async close(e={}){return clearInterval(this.checkTargets),await super.close(e)}_postItem(e){e.stopPropagation();let t=$(e.currentTarget).closest(".specAbs"),a=t.attr("data-actor"),s=t.attr("data-id");return game.actors.get(a).items.get(s).postItem(),!1}recallSettings(e,t,a,s){return super.recallSettings(e,t,a,s),this.prepareWeapon(),this}prepareWeapon(){let e,t=this.dialogData.source;if(["meleeweapon","rangeweapon"].includes(t.type)){let a=g.getSpeaker(this.dialogData.speaker);if(a){let s=t.system.combatskill.value,i=T._calculateCombatSkillValues(a.items.find(r=>r.type=="combatskill"&&r.name==s).toObject(),a.system);switch(t.type){case"meleeweapon":e=T._prepareMeleeWeapon(t,[i],a);break;case"rangeweapon":e=T._prepareRangeWeapon(t,[],[i],a);break}this.dialogData.mode=="attack"||this.dialogData.counterAttack?this.dialogData.rollValue=e.attack:this.dialogData.mode=="parry"&&(this.dialogData.rollValue=e.parry)}else t.type=="dodge"?this.dialogData.rollValue=t.system.value:this.dialogData.mode=="attack"||this.dialogData.counterAttack?this.dialogData.rollValue=Number(t.system.at.value):this.dialogData.mode=="parry"&&(this.dialogData.rollValue=Number(t.system.pa))}}prepareFormRecall(e){super.prepareFormRecall(e);let t=g.getSpeaker(this.dialogData.speaker);K.lightLevel(t,e);let a=H.isRiding(t),s=e.find('[name="advantageousPosition"]')[0];if(this.dialogData.mode=="attack"){let i=Array.from(game.user.targets).some(n=>H.isRiding(n.actor));s&&(i||a)&&(s.checked=a&&!i);let r=e.find('[name="mountedOptions"]')[0];if(a&&r){let n=H.getHorse(t);n&&(r.selectedIndex=H.horseSpeedModifier(n))}}else if(this.dialogData.mode=="parry"&&t.flags.oppose){let i=g.getSpeaker(t.flags.oppose.speaker),r=H.isRiding(i);s&&(r||a)&&(s.checked=a&&!r)}this.calculateModifier()}static assassinationModifiers(e,t){let a=t.assassinate;if(!a||a=="-")return[];e.opposingWeaponSize=0;let s=t.advantageousPosition?2:0,i=y.meleeRangesArray.indexOf(t.weaponsize),r=game.i18n.localize(`DIALOG.${a}`),n=[{name:r,value:10-s-i}];if(a=="assassinate"){let o=y.meleeRangesArray.indexOf(e.source.system.reach.value);!_.isYieldedTwohanded(e.source)&&e.source.system.worn.wrongGrip&&(o=Math.min(o,1));let c=Math.max(1,new Roll(e.source.system.damage.value.replace(/[DWw]/g,"d")).terms.reduce((u,p)=>u+(p.faces?p.number:0),0))-1,m=[2,0,-2,-4][o]-c*2,d=Math.max(1,5-o-c);n.push({name:r+" ("+game.i18n.localize("CHARAbbrev.damage")+")",damageBonus:m,value:0,step:1},{name:r+" (*)",damageBonus:`*${d}`,value:0,step:1})}else e.source.effects||(e.source.effects=[]),e.source.effects.find(o=>o._id==r)||e.source.effects.push({_id:r,changes:[],disabled:!1,duration:{},icon:"icons/svg/aura.svg",name:r,transfer:!0,flags:{dsa5:{description:r,resistRoll:`${game.i18n.localize("LocalizedIDs.selfControl")} -3`,hideOnToken:!1,hidePlayers:!1,customDuration:"",advancedFunction:"1",args0:"unconscious",args1:""}}});return n}async calculateModifier(){if(this.dialogData.mode=="damage")return;let e=this.dialogData.source,t=e.type=="trait"&&getProperty(e,"system.traitType.value")=="meleeAttack"||e.type=="meleeweapon"||e.type=="dodge",a={source:this.dialogData.source,extra:{options:{}}},s=g.getSpeaker(this.dialogData.speaker);t?lt.resolveMeleeDialog(a,{},this.element,s,{},-3,this.dialogData.mode):lt.resolveRangeDialog(a,{},this.element,s,{},this.dialogData.mode),this.dialogData.modifier=await _DiceDSA5._situationalModifiers(a),this.updateRollButton(this.readTargets())}static getNarrowSpaceModifier(e,t){return t?_.isShield(e.source)?getProperty(y.narrowSpaceModifiers,`shield${e.source.system.reach.shieldSize}.${t}`)||0:getProperty(y.narrowSpaceModifiers,`weapon${e.source.system.reach.value}.${t}`)||0:0}static resolveMeleeDialog(e,t,a,s,i,r,n){this._resolveDefault(e,t,a,i);let o=new FormDataExtended(a.find("form")[0]).object,c=lt.targetIsSwarm(e),m=s.isSwarm();e.opposingWeaponSize=m?0:o.weaponsize,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,o),e.situationalModifiers.push(S.parseValueType(game.i18n.localize("sight"),o.vision||0),{name:game.i18n.localize("attackFromBehind"),value:Number(o.attackFromBehind)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:o.damageModifier,value:0,step:1},{name:game.i18n.format("defenseCount",{malus:r}),value:(Number(o.defenseCount)||0)*r},{name:game.i18n.localize("wrongHand"),value:Number(o.wrongHand)||0},{name:game.i18n.localize("advantageousPosition"),value:Number(o.advantageousPosition)||0},{name:game.i18n.localize("sizeCategory"),value:c?0:y.meleeSizeModifier[o.size]||0},...S.getSpecAbModifiers(a,n),...this.assassinationModifiers(e,o),{name:game.i18n.localize("narrowSpace"),value:Number(o.narrowSpace)||0},{name:game.i18n.localize("doubleAttack"),value:Number(o.doubleAttack)||0}),e.situationalModifiers.some(d=>d.name==game.i18n.localize("LocalizedIDs.counterAttack"))&&(e.mode="attack",e.extra.counterAttack=!0)}static resolveRangeDialog(e,t,a,s,i){this._resolveDefault(e,t,a,i);let r=new FormDataExtended(a.find("form")[0]).object,n=Number(r.quickChange)||0,o=y.rangeSizeModifier[r.size]||0,c=y.rangeMods[r.distance||"medium"].attack;e.situationalModifiers.push({name:game.i18n.localize("target")+" "+a.find('[name="targetMovement"] option:selected').text(),value:Number(r.targetMovement)||0},{name:game.i18n.localize("shooter")+" "+a.find('[name="shooterMovement"] option:selected').text(),value:Number(r.shooterMovement)||0},{name:game.i18n.localize("mount")+" "+a.find('[name="mountedOptions"] option:selected').text(),value:Number(r.mountedOptions)||0},{name:game.i18n.localize("rangeMovementOptions.QUICKCHANGE"),value:n},{name:game.i18n.localize("MODS.combatTurmoil"),value:Number(r.combatTurmoil)||0},{name:game.i18n.localize("aim"),value:Number(r.aim)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:r.damageModifier,value:0,step:1},{name:game.i18n.localize("sight"),value:Number(r.vision)||0},{name:game.i18n.localize("sizeCategory"),value:o},{name:game.i18n.localize("distance"),value:c,damageBonus:y.rangeMods[r.distance||"medium"].damage},...S.getSpecAbModifiers(a,"attack"));let m=s.items.find(d=>d.type=="specialability"&&d.name==game.i18n.localize("LocalizedIDs.sharpshooter"));if(m){let d=getProperty(e.source,"system.combatskill.value")?.toLowerCase();if(d&&m.system.list.value.split(/;|,/).map(u=>u.trim().toLowerCase()).includes(d)){let u=[r.targetMovement,r.shooterMovement,r.mountedOptions,n,o,c],p=Math.abs(u.reduce((h,w)=>(Number(w)<0&&(h+=Number(w)),h),0)),f=Math.min(Number(m.system.step.value)*2,p);f&&e.situationalModifiers.push({name:game.i18n.localize("LocalizedIDs.sharpshooter"),value:f})}}}static _resolveDefault(e,t,a,s){t.rollMode=a.find('[name="rollMode"]').val(),e.situationalModifiers=T._parseModifiers(a),mergeObject(e.extra.options,s)}static targetIsSwarm(){let e=!1;return game.user.targets.forEach(t=>{if(t.actor?.isSwarm()){e=!0;return}}),e}static attackOfOpportunity(e,t){let a=Number(t.opportunityAttack)||0;if(a){e.push({name:game.i18n.localize("opportunityAttack"),value:a});let s=game.i18n.localize("LocalizedIDs.enemySense"),i=game.i18n.localize("LocalizedIDs.winhallStyle");game.user.targets.forEach(r=>{for(let n of r.actor?.items||[])n.type=="specialability"&&(n.name==s?e.push({name:s,value:-4}):n.name==i&&e.push({name:i,value:-2}))})}return a!=0}static getRollButtons(e,t,a,s){let i=X.getRollButtons(e,t,a,s);if(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType.value=="rangeAttack"){let r=e.source.type=="trait"?Number(e.source.system.reloadTime.value):T.calcLZ(e.source,e.extra.actor),n=e.source.system.reloadTime.progress;n<r&&mergeObject(i,{reloadButton:{label:`${game.i18n.localize("WEAPON.reload")} (${n}/${r})`,callback:async()=>{let o=await g.getSpeaker(e.extra.speaker);await o.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":n+1}]);let c=game.i18n.format("WEAPON.isReloading",{actor:o.token?.name||o.prototypeToken.name,item:e.source.name,status:`${n+1}/${r}`});await ChatMessage.create(g.chatDataSetup(c))}}})}return i}},pe=lt;R(pe,"rollModifiers",{wrongHand:{mod:-4},advantageousPosition:{mod:2},attackFromBehindLabel:{mod:-4},opportunityAttack:{mod:-4},doubleAttack:{mod:-2},narrowSpace:{mod:0},combatTurmoil:{mod:-2},quickChange:{mod:-4},targetMovement:{mod:0}});var At=class extends te{static getRollButtons(e,t,a,s){let i=X.getRollButtons(e,t,a,s);i.rollButton.label=game.i18n.localize("Opposed");let r={nonOpposedButton:{label:game.i18n.localize("Roll"),callback:n=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),e.opposable=!1,a(t.callback(n))}},routineRoll:{label:game.i18n.localize("ROLL.routine"),callback:n=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),e.routine=!0,mergeObject(e.extra.options,{cheat:!0,predefinedResult:[{val:2,index:0},{val:2,index:1},{val:2,index:2}]}),a(t.callback(n))}}};return mergeObject(r,i),r}activateListeners(e){super.activateListeners(e),e.on("change","input,select",s=>this.rememberFormData(s));let t=this.readTargets(),a=this;this.checkTargets=setInterval(function(){t=a.compareTargets(e,t)},500),this.rememberFormData(),e.on("mousedown",".quantity-click",s=>this.rememberFormData(s)),e.find(".modifiers option").mousedown(s=>{this.rememberFormData(s)})}rememberFormData(e){let t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=T._parseModifiers(this._element),this.calculateRoutine(t)}async calculateRoutine(e){let t=g.getSpeaker(this.dialogData.speaker),a=this.element.find(".routineRoll");if(!t)return a.prop("disabled",!0);let s=!0;for(let d=0;d<3;d++)if(t.system.characteristics[e[`characteristics${d}`]].max*e[`ch${d}`].max<13){s=!1;break}let i=this.dialogData.source.system.talentValue.value+e.fw+await _DiceDSA5._situationalModifiers(e,"FW"),r=y.skillDifficultyModifiers[e.testDifficulty]+await _DiceDSA5._situationalModifiers(e),n=Math.clamped(10-r*3,1,19),o=i>=n,c=s&&o,m=game.i18n.localize("ROLL.routine");a.prop("disabled",!c),a.html(c?`${m} (${game.i18n.localize("CHARAbbrev.FW")} ${Math.round(i/2)})`:m)}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}};var X=class extends te{static getDialogForItem(e,t){let a=e.extra.actor,s=e.source.type;switch(s){case"rangeweapon":case"meleeweapon":case"dodge":case"trait":return t.rollModifiers=pe.setData(a,s,e),pe;case"spell":case"ritual":case"liturgy":case"ceremony":return t.rollModifiers=ne.setData(a,s),ne;case"skill":return At}return X}static getRollButtons(e,t,a,s){let i={rollButton:{label:game.i18n.localize("Roll"),callback:r=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,r),a(t.callback(r))}}};return game.user.isGM&&mergeObject(i,{cheat:{label:game.i18n.localize("DIALOG.cheat"),callback:r=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,r),a(t.callback(r,{cheat:!0}))}}}),i}activateListeners(e){super.activateListeners(e),e.find(".dieButton").click(t=>{let a=$(t.currentTarget);a.attr("data-single")=="true"&&a.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),a.toggleClass("dieSelected")})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}};var le=class extends Q{static async traitAdded(e,t){y.addTraitRules[t.name]&&await y.addTraitRules[t.name](e,t)}static hasTrait(e,t){return super.hasItem(e,t,["trait"])}};Hooks.on("setup",()=>{let l=game.i18n.localize("LocalizedIDs.familiar");y.addTraitRules[l]=async(e,t)=>{t.effects.length==0&&(t.effects=[{changes:[{key:"system.status.wounds.gearmodifier",mode:2,value:10},{key:"system.status.soulpower.gearmodifier",mode:2,value:1},{key:"system.status.toughness.gearmodifier",mode:2,value:1},{key:"system.status.astralenergy.gearmodifier",mode:2,value:15},{key:"system.characteristics.mu.gearmodifier",mode:2,value:1},{key:"system.characteristics.kl.gearmodifier",mode:2,value:1},{key:"system.characteristics.in.gearmodifier",mode:2,value:1},{key:"system.characteristics.ch.gearmodifier",mode:2,value:1},{key:"system.characteristics.ff.gearmodifier",mode:2,value:1},{key:"system.characteristics.ge.gearmodifier",mode:2,value:1},{key:"system.characteristics.ko.gearmodifier",mode:2,value:1},{key:"system.characteristics.kk.gearmodifier",mode:2,value:1},{key:"system.totalArmor",mode:2,value:1}],duration:{},icon:"icons/svg/aura.svg",name:l,transfer:!0,flags:{dsa5:{description:l,hideOnToken:!0,hidePlayers:!1}}}]);let a=game.i18n.localize("LocalizedIDs.witchSense");if(!Q.hasItem(e,a,["trait"])){let s=await g.findAnyItem([{name:a,type:"trait"}]);await e.createEmbeddedDocuments("Item",s)}}});var oe=class extends Dialog{static async showDialog(e){let t=this.callbackResult;new oe({title:game.i18n.localize("Unopposed"),content:await this.getTemplate(e),default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:a=>{t(a.find('[name="entryselection"]').val(),e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}activateListeners(e){super.activateListeners(e),e.find(".select2").select2()}static getTargetActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.targetSpeaker,a=g.getSpeaker(t);return a?{actor:a,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}static async getTemplate(e){return""}static callbackResult(e,t,a){}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}},ct=class extends oe{static async getTemplate(e){let s=game.messages.get(e.flags.unopposeData.attackMessageId).flags.data.preData.source.name,i=(await g.allSkillsList()).map(r=>({name:r,id:r}));return i.unshift({name:game.i18n.localize("doNothing"),id:"doNothing"}),renderTemplate("systems/dsa5/templates/dialog/dialog-act.html",{items:i,original:s,title:"DIALOG.selectReaction"})}static callbackResult(e,t){let{actor:a,tokenId:s}=oe.getTargetActor(t);if(e=="doNothing")F.resolveUndefended(t);else{let i=a.items.find(r=>r.name==e&&r.type=="skill");i&&a.setupSkill(i,{},s).then(r=>{a.basicTest(r)})}}},Le=class extends Dialog{static async showDialog(e,t){let a=new Le({title:game.i18n.localize("attacktest"),content:await this.getTemplate(e),buttons:{}});a.actor=e,a.tokenId=t,a.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.actor,this.tokenId),this.close()})}static async getTemplate(e){let t=e.items.filter(n=>n.type=="combatskill").map(n=>T._calculateCombatSkillValues(n.toObject(),e.system)),a=t.find(n=>n.name==game.i18n.localize("LocalizedIDs.wrestle")),s=[{name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:a.system.attack.value}],i=["meleeweapon","rangeweapon"],r=["meleeAttack","rangeAttack"];for(let n of e.items)if(i.includes(n.type)&&n.system.worn.value==!0){let o=n.type=="meleeweapon"?T._prepareMeleeWeapon(n.toObject(),t,e):T._prepareRangeWeapon(n.toObject(),[],t,e);s.push({name:n.name,id:n.name,img:n.img,value:o.attack,item:o})}else n.type=="trait"&&r.includes(n.system.traitType.value)&&s.push({name:n.name,id:n.name,img:n.img,value:n.system.at.value});return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:s,title:"DIALOG.selectAction"})}callbackResult(e,t,a){if(e=="attackWeaponless")t.setupWeaponless("attack",{},a).then(s=>{t.basicTest(s)});else{let s=["meleeweapon","trait","rangeweapon"],i=t.items.find(r=>s.includes(r.type)&&r.name==e);i&&t.setupWeapon(i,"attack",{},a).then(r=>{t.basicTest(r)})}}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:550}),e}},Ce=class extends oe{static async showDialog(e){let t=new Ce({title:game.i18n.localize("Unopposed"),content:await this.getTemplate(e),buttons:{}});t.startMessage=e,t.render(!0)}static getAttackActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.attackMessageId,s=game.messages.get(t).flags.data.preData.extra.speaker,i=g.getSpeaker(s);return i?{actor:i,tokenId:s.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t.currentTarget.dataset.value,this.startMessage),this.close()})}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:550}),e}static async getTemplate(e){let{actor:t,tokenId:a}=oe.getTargetActor(e),s=Ce.getAttackActor(e),i=t.items.filter(m=>m.type=="combatskill").map(m=>T._calculateCombatSkillValues(m.toObject(),t.system)),r=i.find(m=>m.name==game.i18n.localize("LocalizedIDs.wrestle")),n=[{name:game.i18n.localize("doNothing"),id:"doNothing",img:"systems/dsa5/icons/categories/disease.webp"},{name:game.i18n.localize("dodge"),id:"dodge",img:"systems/dsa5/icons/categories/Dodge.webp",value:t.system.status.dodge.max},{name:game.i18n.localize("parryWeaponless"),id:"parryWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:r.system.parry.value}],o=0,c="";if(t){let m=["meleeweapon"];for(let d of t.items)if(m.includes(d.type)&&d.system.worn.value==!0){let u=T._prepareMeleeWeapon(d.toObject(),i,t);n.push({name:d.name,id:d.name,img:d.img,value:u.parry})}else d.type=="trait"&&Number(d.system.pa)>0&&n.push({name:d.name,id:d.name,img:d.img,value:d.system.pa});if(s){let d=getProperty(s.actor.system,"status.size.value");d=="big"?c="DIALOGDESCRIPTION.bigEnemy":d=="giant"&&(c="DIALOGDESCRIPTION.giantEnemy")}game.combat&&(o=await game.combat.getDefenseCount({actor:t.id,token:a,scene:canvas.scene?canvas.scene.id:null}))}return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-in",items:n,defenses:o,title:"DIALOG.selectReaction",sizeNotification:c})}callbackResult(e,t){let{actor:a,tokenId:s}=oe.getTargetActor(t);if(e=="doNothing")F.resolveUndefended(t);else if(e=="dodge")a.setupDodge({},s).then(i=>{a.basicTest(i)});else if(e=="parryWeaponless")a.setupWeaponless("parry",{},s).then(i=>{a.basicTest(i)});else{let i=["meleeweapon","trait"],r=a.items.find(n=>i.includes(n.type)&&n.name==e);r&&a.setupWeapon(r,"parry",{},s).then(n=>{a.basicTest(n)})}}};var q=class{static armorWearModifier(e,t){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(q.calculateWear(e)){case 1:case 2:t-=1;break;case 3:case 4:t=0}return Math.max(0,Number(t))}static armorGetsDamage(e,t){return(e>14||t.successLevel>2)&&game.settings.get("dsa5","armorAndWeaponDamage")}static armorEncumbranceModifier(e){return game.settings.get("dsa5","armorAndWeaponDamage")&&q.calculateWear(e)>1?1:0}static async showDamageToGear(e,t){if(game.settings.get("dsa5","armorAndWeaponDamage")){let a=g.getSpeaker(e.extra.speaker),s=0,i=getProperty(a,"flags.oppose.messageId");if(i){let n=game.messages.get(i);n&&(s=getProperty(n,"flags.data.postData.successLevel")||0)}let r=e.source;if(r._id&&r.system.structure&&(t.successLevel<-2||s>2)&&["meleeweapon","rangeweapon","armor"].includes(r.type))return a=await g.getSpeaker(t.speaker),a.items.get(r._id).uuid}}static breakingTest(e){if(!e)return ui.notifications.warn(game.i18n.format("DSAError.notfound",{category:"",name:game.i18n.localize("equipment")}));if(e.system.structure.max<=0)return ui.notifications.warn(game.i18n.format("DSAError.noBreakingStructure",{name:e.name}));let t=0,a;if(e.type=="armor"?(a=game.i18n.localize(`ARMORSUBCATEGORIES.${e.system.subcategory}`),t=getProperty(e,"system.structure.breakPointRating")||y.armorSubcategories[e.system.subcategory]):(a=e.system.combatskill.value,t=getProperty(e,"system.structure.breakPointRating")||y.weaponStabilities[game.i18n.localize(`LocalizedCTs.${a}`)]),!t){ui.notifications.error(game.i18n.format("DSAError.noBreakingResistance",{item:e.name}));return}let s="",i=getProperty(e,"effect.attributes")||"";new RegExp(`${M.magical}`,"i").test(i)?s=`${game.i18n.format("WEAPON.attributeWarning",{domain:M.clerical})}<br/>`:new RegExp(`${M.clerical}`,"i").test(i)&&(s=`${game.i18n.format("WEAPON.attributeWarning",{domain:M.magical})}<br/>`),new te({title:game.i18n.localize("DSASETTINGS.armorAndWeaponDamage"),content:`${s}<label for="threshold">${game.i18n.format("WEAR.check",{category:a})}</label>: <input class="quantity-click" style="width:80px" dtype="number" name="threshold" type="number" value="${t}"/>`,buttons:{Yes:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:r=>{q.resolveBreakingTest(e,Number(r.find('[name="threshold"]').val()),a)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}static async applyDamageLevelToItem(e,t){let a=Math.ceil(e.system.structure.max*.25)*t;await e.update({"system.structure.value":Math.max(0,e.system.structure.value-a)})}static async absoluteDamageLevelToItem(e,t){let a=Math.ceil(e.system.structure.max*.25)*t;await e.update({"system.structure.value":Math.min(e.system.structure.value,Math.max(0,e.system.structure.max-a))})}static async resolveBreakingTest(e,t,a){let s=await _DiceDSA5.manualRolls(await new Roll("1d20").evaluate({async:!0}),game.i18n.format("WEAR.check",{category:a}));await _DiceDSA5.showDiceSoNice(s,await game.settings.get("core","rollMode"));let i=s.total>t?1:0;await this.applyDamageLevelToItem(e,i);let r=q.calculateWear(e.data),n=await renderTemplate("systems/dsa5/templates/system/breakingtest.html",{wear:r,item:e,threshold:t,category:a,roll:s,result:game.i18n.localize(`WEAR.${e.type}.${r}`)});ChatMessage.create(g.chatDataSetup(n))}static damageTooltip(e){if(game.settings.get("dsa5","armorAndWeaponDamage")){let t=this.calculateWear(e);return{msg:game.i18n.localize(`WEAR.${e.type}.${t}`),css:`gearD damaged${t}`}}return{msg:"",css:""}}static weaponWearModifier(e){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(q.calculateWear(e)){case 1:e.attack-=1,e.parry&&(e.parry-=1);break;case 2:e.attack-=2,e.parry&&(e.parry-=2);break;case 3:case 4:e.attack=0,e.parry&&(e.parry=0)}}static calculateWear(e){return!e.system.structure||Number(e.system.structure.max<=0)?0:Math.floor((1-e.system.structure.value/e.system.structure.max)*4)}};var ce=class{static prepareSoundEffects(){ce.soundPaths={money:[],armor:[],meleeweapon:[],rangeweapon:[],default:[]},game.modules.get("gAudioBundle-3")&&(ce.soundPaths.money.push("modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"),ce.soundPaths.meleeweapon.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg")),game.modules.get("gAudioBundle-2")&&(ce.soundPaths.meleeweapon.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),ce.soundPaths.armor.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg"),ce.soundPaths.default.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg")),game.modules.get("gAudioBundle-4")&&ce.soundPaths.rangeweapon.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg"),Hooks.call("setDefaultDSASounds",ce.soundPaths)}static async playEffect(e,t,a,s=void 0,i=!1){let r=await this.getSound(e,t,a);if(r)try{s?(game.socket.emit("system.dsa5",{type:"playWhisperSound",payload:{whisper:s,soundPath:r}}),i||AudioHelper.play({src:r,volume:.8,loop:!1},!1)):AudioHelper.play({src:r,volume:.8,loop:!1},!0)}catch{console.warn(`Could not play item sound effect ${r}`)}}static async loadSoundConfig(){let e=await game.settings.get("dsa5","soundConfig");if(e)try{let a=await(await fetch(e)).json();this.sounds=a,console.log("DSA5 | Sound Config Loaded")}catch(t){console.warn(t)}}static successLevelToString(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}static async getSound(e,t,a){if(!this.sounds&&!this.triedInit&&(await this.loadSoundConfig(),this.triedInit=!0),!this.sounds)return;let s=this.successLevelToString(a),i=[],r;switch(t.type){case"meleeweapon":case"rangeweapon":i=[...s.map(n=>`${t.type}.manual.${t.name}.${e}_${n}`),`${t.type}.manual.${t.name}.${e}`,`${t.type}.manual.${t.name}.default.${e}`,`${t.type}.manual.${t.name}.default`,...s.map(n=>`${t.type}.${t.system.combatskill.value}.${e}_${n}`),`${t.type}.${t.system.combatskill.value}.${e}`,...s.map(n=>`${t.type}.${t.system.combatskill.value}.default_${n}`),`${t.type}.${t.system.combatskill.value}.default`];break;case"skill":i=[...s.map(n=>`${t.type}.${t.name}.${e}_${n}`),`${t.type}.${t.name}.${e}`,...s.map(n=>`${t.type}.${t.name}.default_${n}`),`${t.type}.${t.name}.default`];break;case"liturgy":case"spell":case"ceremony":case"ritual":i=[...s.map(n=>`${t.type}.${t.name}.${e}_${n}`),`${t.type}.${t.name}.${e}`,...s.map(n=>`${t.type}.${t.name}.default_${n}`),`${t.type}.${t.name}.default`];break}i.push(...s.map(n=>`${t.type}.default_${n}`),`${t.type}.default`);for(let n of i)if(!!hasProperty(this.sounds,n)&&(r=getProperty(this.sounds,n),r&&(typeof r=="string"||r instanceof String)))break;return r}static async playMoneySound(e=!1){let t=ce.soundPaths.money,a=t[Math.floor(Math.random()*t.length)];await this.playSoundPath(a,e)}static async playEquipmentWearStatusChange(e,t=!1){let a=ce.soundPaths[e.type]||ce.soundPaths.default;if(a.length>0){let s=a[Math.floor(Math.random()*a.length)];await this.playSoundPath(s,t,.5)}}static async playSoundPath(e,t=!1,a=.8){if(!!game.settings.get("dsa5","inventorySound"))try{AudioHelper.play({src:e,volume:a,loop:!1},t)}catch{console.warn(`Could not play item sound effect ${e}`)}}},U=ce;R(U,"sounds"),R(U,"triedInit",!1);var J=class{constructor(e){this.item=e}async callMacro(e,t,a={}){let i=await game.packs.get(e).getDocuments({name:t});if(!i.length){for(let n of game.packs.filter(o=>o.documentName=="Macro"&&/\(internal\)/.test(o.metadata.label)))if(i=await n.getDocuments({name:t}),i.length)break}let r={};if(i.length)try{a.result=r;let n=Object.getPrototypeOf(async function(){}).constructor,o=new n("args","actor","item",`
                const that = this;
                ${i[0].command.replace(/( |\(|{)this\./g," that.")}
                `);r.ret=await o.call(this,a,this.item.actor,this.item)}catch(n){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(n),r.error=!0}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:t}));return r}async executeOnUseEffect(){if(!game.user.can("MACRO_SCRIPT"))return ui.notifications.warn("You are not allowed to use JavaScript macros.");if(!this.item.actor)return;let e=J.getOnUseEffect(this.item);try{let t=Object.getPrototypeOf(async function(){}).constructor;await new t("item","actor",e).call(this,this.item,this.item.actor)}catch(t){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(t),console.warn(t.stack)}}static getOnUseEffect(e){return e.getFlag("dsa5","onUseEffect")}async automatedAnimation(e,t={}){g.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}effectDummy(e,t,a){return{name:e,icon:"icons/svg/aura.svg",changes:t,duration:a,flags:{dsa5:{value:null,editable:!0,description:e,custom:!0}}}}async socketedConditionAddActor(e,t){if(game.user.isGM){let a=typeof t=="string";a&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let s=[];for(let i of e)a?await i.addCondition(t,1,!1,!1):await i.addCondition(t),s.push(i.name);await this.createInfoMessage(t,s)}else{let a={id:this.item.uuid,data:t,actors:e.map(s=>s.id)};game.socket.emit("system.dsa5",{type:"socketedConditionAddActor",payload:a})}}async createInfoMessage(e,t,a=!0){if(t.length){let s=a?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",i=game.i18n.format(s,{source:e.name,target:t.join(", ")});await ChatMessage.create(g.chatDataSetup(i))}}async socketedRemoveCondition(e,t,a=1){if(game.user.isGM){let s=[];for(let r of e){let n=canvas.tokens.get(r);n.actor&&(await n.actor.removeCondition(t,a,!1),s.push(n.name))}let i=CONFIG.statusEffects.find(r=>r.id==t);i.name=game.i18n.localize(i.name),await this.createInfoMessage(i,s,!1)}else{let s={id:this.item.uuid,coreId:t,targets:e};game.socket.emit("system.dsa5",{type:"socketedRemoveCondition",payload:s})}}async socketedActorTransformation(e,t){if(game.user.isGM)for(let a of e){let s=canvas.tokens.get(a);s.actor&&await s.actor.update(t)}else{let a={id:this.item.uuid,targets:e,update:t};game.socket.emit("system.dsa5",{type:"socketedActorTransformation",payload:a})}}async socketedConditionAdd(e,t){if(game.user.isGM){let a=typeof t=="string";a&&(t=duplicate(CONFIG.statusEffects.find(i=>i.id==t)),t.name=game.i18n.localize(t.name));let s=[];for(let i of e){let r=canvas.tokens.get(i);r.actor&&(a?await r.actor.addCondition(t,1,!1,!1):await r.actor.addCondition(t),s.push(r.name))}await this.createInfoMessage(t,s)}else{let a={id:this.item.uuid,data:t,targets:e};game.socket.emit("system.dsa5",{type:"socketedConditionAdd",payload:a})}}};var Ve=class{static async postOpposed(e){let t=g.getSpeaker(e.attacker.speaker);!t||await this.runMacro(t,e.attacker.testResult,7,e)}static async postRoll(e){let t=g.getSpeaker(e.testData.speaker);!t||await this.runMacro(t,e.testData,6,e)}static async callMacro(e,t,a,s={}){return await new J(e).callMacro(t,a,s)}static async runMacro(e,t,a,s){if(!game.user.can("MACRO_SCRIPT"))ui.notifications.warn("You are not allowed to use JavaScript macros.");else for(let[i,r]of Object.entries(e.dsatriggers[a])){let n=e.items.get(i),o=n.effects.get(r),c=o.getFlag("dsa5","args3");try{let m=Object.getPrototypeOf(async function(){}).constructor;return await new m("actor","testData","type","data","source","ef",c).call(this,e,t,a,s,n,o)}catch(m){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(m)}}}};var F=class{static async handleOpposedTarget(e){if(!e)return;let t=g.getSpeaker(e.speaker);if(!t)return;let a=e.flags.data.postData,s=e.flags.data.preData;t.flags.oppose?F.answerOpposedTest(t,e,a,s):game.user.targets.size&&e.flags.data.isOpposedTest&&!e.flags.data.defenderMessage&&!e.flags.data.attackerMessage?F.createOpposedTest(t,e,a,s):e.flags.data.defenderMessage||e.flags.data.attackerMessage?F.resolveFinalMessage(e):e.flags.data.unopposedStartMessage?F.redoUndefended(e):e.flags.data.startMessagesList?F.changeStartMessage(e):(await this.showDamage(e),await this.showSpellWithoutTarget(e))}static async redoUndefended(e){let t=game.messages.get(e.flags.data.unopposedStartMessage);startmessage.flags.unopposeData.attackMessageId=e.id,this.resolveUndefended(t)}static async answerOpposedTest(e,t,a,s){let i=game.messages.get(e.flags.oppose.messageId);if(!i)return ui.notifications.error(game.i18n.localize("DSAError.staleData")),await F.clearOpposed(e),F.createOpposedTest(e,t,a,s);let r={speaker:e.flags.oppose.speaker,testResult:i.flags.data.postData,messageId:i.id,img:g.getSpeaker(e.flags.oppose.speaker)?.img};r.testResult.source=i.flags.data.preData.source,r.testResult.ammo&&r.testResult.source.effects.push(...r.testResult.ammo.effects);let n={speaker:t.speaker,testResult:a,messageId:t.id,img:e.msg},o=i.flags.data.defenderMessage?Array.from(i.flags.data.defenderMessage):[];o.push(t.id),game.user.isGM&&await i.update({"flags.data.defenderMessage":o}),await t.update({"flags.data.attackerMessage":i.id}),await this.completeOpposedProcess(r,n,{target:!0,startMessageId:e.flags.oppose.startMessageId,whisper:t.whisper,blind:t.blind}),await F.clearOpposed(e)}static videoOrImgTag(e){return/\.webm$/.test(e)?`<video loop autoplay src="${e}" width="50" height="50"></video>`:`<img src="${e}" width="50" height="50"/>`}static async createOpposedTest(e,t,a,s){let i;t.speaker.token?i=canvas.tokens.get(t.speaker.token).document:i=e.prototypeToken;let r=a.options?.mode=="damage";if(a.successLevel>0||r){let n=t.flags.data.preData.attackOfOpportunity,o=n?"":`<div><button class="unopposed-button small-button chat-button-target" data-target="true">${game.i18n.localize("Unopposed")}</button></div>`,c=[];game.user.targets.forEach(async m=>{if(m.actor){let d=`${F.opposeMessage(i,m,!1)} ${o}`,u=await ChatMessage.create({user:game.user.id,content:d,speaker:t.speaker,["flags.unopposeData"]:{attackMessageId:t.id,targetSpeaker:{scene:m.scene.id,token:m.id,alias:m.document.name}}}),p={speaker:t.speaker,messageId:t.id,startMessageId:u.id};game.user.isGM?await m.actor.update({"flags.oppose":p}):game.socket.emit("system.dsa5",{type:"target",payload:{target:m.id,scene:m.scene?.id||canvas.scene?.id,opposeFlag:p}}),c.push(u.id),n?await F.resolveUndefended(u,game.i18n.localize("OPPOSED.attackOfOpportunity")):r&&await F.resolveUndefended(u),Hooks.call("DSAOpposedRollStart",m)}}),t.flags.data.startMessagesList=c}else game.user.targets.forEach(async n=>{n.actor&&await ChatMessage.create({user:game.user.id,content:F.opposeMessage(i,n,!0),speaker:t.speaker})})}static opposeMessage(e,t,a){return`<div class="opposed-message">
            <b>${e.name}</b> ${game.i18n.localize("ROLL.Targeting")} <b>${t.document.name}</b> ${a?game.i18n.localize("ROLL.failed"):""}
            </div>
            <div class="opposed-tokens row-section">
                <div class="col two attacker">${F.videoOrImgTag(e.texture.src)}</div>
                <div class="col two defender">${F.videoOrImgTag(t.document.texture.src)}</div>
            </div>
             `}static async changeStartMessage(e){for(let t of e.flags.data.startMessagesList){let a=game.messages.get(t),s=a.flags.unopposeData;game.socket.emit("system.dsa5",{type:"target",payload:{target:s.targetSpeaker.token,scene:canvas.scene.id,opposeFlag:{speaker:e.speaker,messageId:e.id,startMessageId:a.id}}}),await a.update({"flags.unopposeData.attackMessageId":e.id})}}static resolveFinalMessage(e){let t,a;if(e.flags.data.defenderMessage)for(let s of e.flags.data.defenderMessage){t=F.getMessageDude(e);let i=game.messages.get(s);a=F.getMessageDude(i),this.completeOpposedProcess(t,a,{blind:e.blind,whisper:e.whisper})}else{a=F.getMessageDude(e);let s=game.messages.get(e.flags.data.attackerMessage);t=F.getMessageDude(s),this.completeOpposedProcess(t,a,{blind:e.blind,whisper:e.whisper})}}static getMessageDude(e){let t={speaker:e.speaker,testResult:mergeObject(e.flags.data.postData,{source:e.flags.data.preData.source}),img:g.getSpeaker(e.speaker).img,messageId:e.id};return t.testResult.ammo&&t.testResult.source.effects.push(...t.testResult.ammo.effects),t}static async showDamage(e,t=!1){game.user.isGM?(!t||!e.flags.data.hideDamage)&&e.flags.data.postData.damageRoll&&(await e.update({content:e.content.replace(`data-hide-damage="${!t}"`,`data-hide-damage="${t}"`),"flags.data.hideDamage":t}),t||_DiceDSA5._addRollDiceSoNice(e.flags.data.preData,Roll.fromData(e.flags.data.postData.damageRoll),game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"))):game.socket.emit("system.dsa5",{type:"showDamage",payload:{id:e.id,hide:t}})}static async playAutomatedJBA2(e,t,a){if(g.moduleEnabled("autoanimations")){let s=g.getSpeaker(e.speaker).getActiveTokens()[0],i=g.getSpeaker(t.speaker).getActiveTokens()[0];if(!s||!s.actor||!i||!i.actor)return;let r=s.actor.items.get(e.testResult.source._id);if(r||(r=new S(e.testResult.source,{temporary:!0})),!r)return;r=r.toObject();let n=[i],o=a.winner=="attacker",c=o?n:[],m=e.testResult.successLevel>1&&o,d=e.testResult.successLevel<1&&!o,u=t.testResult.successLevel>1&&!o,p=t.testResult.successLevel<1&&o,f=[],h=[];m?h.push(game.i18n.localize("CriticalSuccess")):d?h.push(game.i18n.localize("CriticalFailure")):u?h.push(`${game.i18n.localize("CHAR.PARRY")} ${game.i18n.localize("CriticalSuccess")}`):p&&h.push(`${game.i18n.localize("CHAR.PARRY")} ${game.i18n.localize("CriticalFailure")}`),o||h.push(game.i18n.localize("CHAR.PARRY"));for(let w of h)f.push({name:`${r.name} (${w})`},{name:w});f.push(r);for(let w of f)if(await AutomatedAnimations.playAnimation(s,w,{targets:n,hitTargets:c,playOnMiss:!0}))break}}static async showSpellWithoutTarget(e){if(g.moduleEnabled("autoanimations")){let t=getProperty(e,"flags.data");if(!t||t.isOpposedTest)return;if((getProperty(t,"postData.result")||-1)>0){let s=g.getSpeaker(t.postData.speaker).getActiveTokens()[0];if(!s||!s.actor)return;let i=Array.from(game.user.targets),r=s.actor.items.get(t.preData.source._id);i.length||(i=[s]),AutomatedAnimations.playAnimation(s,r,{targets:i})}}}static async clearOpposed(e){game.user.isGM?await e.update({["flags.-=oppose"]:null}):game.socket.emit("system.dsa5",{type:"clearOpposed",payload:{actorId:e.id}})}static async _handleReaction(e){let t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(t);switch(game.messages.get(a.flags.unopposeData.attackMessageId).flags.data.preData.source.type){case"skill":ct.showDialog(a);break;default:Ce.showDialog(a)}}static async chatListeners(e){e.on("click",".unopposed-button",t=>{t.preventDefault(),this._handleReaction(t)})}static async hideReactionButton(e){if(e)if(game.user.isGM){let t=game.messages.get(e),a=$(t.content);a.find("button.unopposed-button").remove(),a=$("<div></div>").append(a),await t.update({content:a.html()})}else game.socket.emit("system.dsa5",{type:"hideQueryButton",payload:{id:e}})}static async completeOpposedProcess(e,t,a){await Ve.postOpposed({attacker:e,defender:t,options:a});let s=await this.evaluateOpposedTest(e.testResult,t.testResult,a);return this.formatOpposedResult(s,e.speaker,t.speaker),this.rerenderMessagesWithModifiers(s,e,t),Hooks.call("finishOpposedTest",e,t,s,a),await this.finishOpposedTestHookAsync(e,t,s,a),this.playAutomatedJBA2(e,t,s),await this.renderOpposedResult(s,a),await this.hideReactionButton(a.startMessageId),s}static async finishOpposedTestHookAsync(e,t,a,s){}static async evaluateOpposedTest(e,t,a={}){let s={};if(s.other=[],a.additionalInfo&&s.other.push(a.additionalInfo),s.winner="attacker",["weapon","spell","liturgy","ceremony","ritual","combatskill"].includes(e.rollType)&&t.successLevel==null&&(t.successLevel=-5),e.rollType=="damage"&&(t.successLevel=-5,e.successLevel=1),t.successLevel!=null)switch(e.rollType){case"combatskill":case"talent":this._evaluateTalentOpposedRoll(e,t,s,a);break;case"ceremony":case"ritual":case"spell":case"liturgy":case"weapon":case"damage":this._evaluateWeaponOpposedRoll(e,t,s,a);break;default:ui.notifications.error("Can not oppose "+e.rollType),console.warn("Can not oppose "+e.rollType)}return s}static _evaluateWeaponOpposedRoll(e,t,a,s={}){if(e.successLevel>0&&t.successLevel<0){let i=this._calculateOpposedDamage(e,t,s);if(i.armorDamaged.damaged&&i.armorDamaged.ids.length){let c=i.armorDamaged.ids.join(";");a.other.push(`<div style="margin-top:10px" class="center"><button class="gearDamaged onlyTarget" data-uuid="${c}">${game.i18n.localize("WEAR.checkShort")}</button></div>`)}t.counterAttack&&(i.damage+=2,i.sum=i.damage-i.armor,i.tooltip=game.i18n.localize("LocalizedIDs.counterAttack")+" 2"),i.messages.length&&(i.tooltip||(i.tooltip=""),i.tooltip+=` ${i.messages.join("<br>")}`),a.winner="attacker";let r=[i.armorMod!=0?`${i.armorMod+" "+game.i18n.localize("Modifier")}`:"",i.armorMultiplier!=1?"*"+i.armorMultiplier+" "+game.i18n.localize("Modifier"):"",i.spellArmor!=0?`${i.spellArmor} ${game.i18n.localize("spellArmor")}`:"",i.liturgyArmor!=0?`${i.liturgyArmor} ${game.i18n.localize("liturgyArmor")}`:""].join(""),o=`<b>${game.combat?.isBrawling?game.i18n.localize("BRAWLING.temporary"):game.i18n.localize("damage")}</b>: <span${i.tooltip?` data-tooltip="${i.tooltip}"`:""}>${i.damage}</span><i class="lighticon fas fa-hand-fist" data-tooltip="Roll"></i> - <span data-tooltip="${r}">${i.armor}</span><i class="lighticon fa fa-shield-alt" data-tooltip="protection"></i> = ${i.sum}`;a.damage={description:o,value:i.sum,sp:i.damage}}else a.winner="defender"}static _calculateOpposedDamage(e,t,a={}){let s=g.getSpeaker(t.speaker),i=[],r=e.damage,n=game.i18n.localize("LocalizedIDs.immuneToCrit");e.doubleDamage&&s.items.find(L=>L.name==n&&L.type=="trait")&&(r=Math.floor(r/e.doubleDamage),i.push(n)),a.origin=e.source,a.damage=r;let o=_DSAActiveEffectConfig.applyRollTransformation(s,a,5).options.damage,{wornArmor:c,armor:m}=T.armorValue(s,a),d=[],u=0,p=e.armorPen||[];for(let L of p)/^\*/.test(L)?d.push(Number(L.replace("*",""))):u+=Number(L);let f=0,h=0;["spell","ritual"].includes(e.source.type)?f+=s.system.spellArmor||0:["liturgy","ceremony"].includes(e.source.type)&&(f+=s.system.liturgyArmor||0),m+=u;let w=d.reduce((L,D)=>L*D,1);m=Math.max(Math.round(m*w),0),m+=f+h;let z=q.armorGetsDamage(o,e),v=c.map(L=>L.uuid);return{damage:o,armor:m,armorDamaged:{damaged:z,ids:v},armorMod:u,spellArmor:f,liturgyArmor:h,armorMultiplier:w,messages:i,sum:o-m}}static _evaluateTalentOpposedRoll(e,t,a,s={}){e.successLevel>0&&e.successLevel>t.successLevel?a.winner="attacker":e.qualityStep>t.qualityStep||e.result>=0&&t.result<0?(a.winner="attacker",a.differenceSL=e.qualityStep-t.qualityStep):(a.winner="defender",a.differenceSL=t.qualityStep-e.qualityStep)}static formatOpposedResult(e,t,a){let s=e.differenceSL?"winsFP":"wins";return e.winner=="attacker"?(e.result=game.i18n.format("OPPOSED."+s,{winner:t.alias,loser:a.alias,SL:e.differenceSL}),e.img=t.img):e.winner=="defender"&&(e.result=game.i18n.format("OPPOSED."+s,{winner:a.alias,loser:t.alias,SL:e.differenceSL}),e.img=a.img),e.speakerAttack=t,e.speakerDefend=a,e}static rerenderMessagesWithModifiers(e,t,a){let s=game.messages.get(t.messageId);this.showDamage(s,e.winner!="attacker")}static async renderOpposedResult(e,t={}){e.hideData=game.settings.get("dsa5","hideOpposedDamage"),e.applyDamageInChat=game.settings.get("dsa5","applyDamageInChat"),e.isBrawling=game.combat?.isBrawling;let a=await renderTemplate("systems/dsa5/templates/chat/roll/opposed-result.html",e),s={user:game.user.id,content:a,"flags.opposeData":e,"flags.hideData":e.hideData,whisper:t.whisper,blind:t.blind};t.target&&(s["flags.startMessageId"]=t.startMessageId),await ChatMessage.create(s)}static async resolveUndefended(e,t=""){let a=e.flags.unopposeData,s=game.messages.get(a.attackMessageId),i={speaker:s.speaker,testResult:s.flags.data.postData,messageId:a.attackMessageId};i.testResult.source=s.flags.data.preData.source,i.testResult.ammo&&i.testResult.source.effects.push(...i.testResult.ammo.effects);let r=canvas.tokens.get(a.targetSpeaker.token),n={speaker:a.targetSpeaker,testResult:{actor:r.actor,speaker:{token:a.targetSpeaker.token}}};await this.clearOpposed(r.actor),await this.completeOpposedProcess(i,n,{target:!0,startMessageId:e.id,additionalInfo:t}),game.user.isGM?await s.update({"flags.data.unopposedStartMessage":e.id}):await game.socket.emit("system.dsa5",{type:"updateAttackMessage",payload:{messageId:s.id,startMessageId:e.id}})}};var Ke=class extends Dialog{static async showDialog(e){let t=new Ke({title:game.i18n.localize("WEAR.checkShort"),content:await this.getTemplate(e),buttons:{}});t.items=e,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click(t=>{this.callbackResult(t),this.close()})}static async getTemplate(e){let t=e.map(a=>({name:a.name,id:a.id,img:a.img}));return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{items:t,title:"WEAR.checkShort"})}callbackResult(e){q.breakingTest(this.items.find(t=>t.id==e.currentTarget.dataset.value))}};var W=class{static async showBotchCard(e,t={}){t.speaker={token:e.token,actor:e.actor,scene:e.scene},t.source=e.source;let a=y.systemTables.find(i=>i.name==e.table),s=await W.getRollTable(a.pack[game.i18n.lang],game.i18n.localize(`TABLENAMES.${e.table}`),e);for(let i of s){let r=t.speaker?await W.hasEffect(i):!1,n=g.replaceDies(g.replaceConditions(i.results[0].text)),o=`${game.i18n.localize("TABLENAMES."+e.table)}`,c=await renderTemplate("systems/dsa5/templates/tables/tableCard.html",{result:n,title:o,hasEffect:r}),m=await this.buildEffects(i,r);ChatMessage.create({user:game.user.id,content:c,whisper:t.whisper,blind:t.blind,flags:{data:{preData:{source:{effects:m},extra:{actor:{id:t.speaker.actor},speaker:t.speaker},situationalModifiers:[]},postData:{}},dsa5:{hasEffect:r,options:t}}})}}static async hasEffect(e){return getProperty(e.results[0],"flags.dsa5")||!1}static async buildEffects(e,t){let a=[];if(t&&t.resistEffect){let s=Array.isArray(t.resistEffect.fail)?t.resistEffect.fail:[t.resistEffect.fail];for(let i of s){let r=new J().effectDummy(i.description,t.resistEffect.changes||[],t.resistEffect.duration||{});i.systemEffect?mergeObject(r,{_id:"botchEffect",flags:{dsa5:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:`await actor.addCondition("${i.systemEffect}", ${i.level||1});`}}}):i.command&&mergeObject(r,{_id:"botchEffect",flags:{dsa5:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:i.command}}}),a.push(r)}}return a}static async getRollTable(e,t,a={}){let i=(await game.packs.get(e).getDocuments({name__in:[t]}))[0],r=await i.draw({displayChat:!1});return a.weaponless=="true"&&r.roll.total<7&&(r.roll.editRollAtIndex([{index:0,val:r.roll.total+5}]),r=await i.draw({displayChat:!1,roll:r.roll})),[r]}static async tableEnabledFor(e){let t=y.systemTables.find(a=>a.name==e);return t?game.settings.get(t.setting.module,t.setting.key):!1}static rollCritBotchButton(e,t,a){let s=game.i18n.localize(`TABLENAMES.${e}`),i=a.extra.speaker,r=a.source._id;return`, <a class="roll-button botch-roll" data-table="${e}" data-weaponless="${t}" data-source="${r}" data-token="${i.token}" data-actor="${i.actor}" data-scene="${i.scene}"><i class="fas fa-dice"></i>${s}</a>`}static async defaultBotch(){return", "+game.i18n.localize("selfDamage")+(await new Roll("1d6+2").evaluate({async:!0})).total}static defaultAttackCrit(e){let t=", "+game.i18n.localize("halfDefense");return e&&(t+=", "+game.i18n.format("doubleDamage",{x:2})),t}static defaultParryCrit(){return", "+game.i18n.localize("attackOfOpportunity")}};var j=class{static async payMoney(e,t,a=!1,s=!0){let i=j.canPay(e,t,a);return i.success&&await j._updateMoney(e,i.actorsMoney.money,i.actorsMoney.sum-i.money,s),!a&&i.msg!=""&&ChatMessage.create(g.chatDataSetup(`<p>${i.msg}</p>`,"roll")),i.success}static canPay(e,t,a){let s=this._getPaymoney(t),i={success:!1,msg:"",money:s};return s&&(i.actorsMoney=this._actorsMoney(e),i.actorsMoney.sum>=s?(i.msg=game.i18n.format("PAYMENT.pay",{actor:e.name,amount:j._moneyToString(s)}),i.success=!0):(i.msg=game.i18n.format("PAYMENT.cannotpay",{actor:e.name,amount:j._moneyToString(s)}),a&&ui.notifications.notify(i.msg))),i}static async getMoney(e,t,a=!1,s=!0){let i=this._getPaidmoney(t);if(i){let r=this._actorsMoney(e);await j._updateMoney(e,r.money,r.sum+i,s);let n=`<p>${game.i18n.format("PAYMENT.getPaid",{actor:e.name,amount:j._moneyToString(i)})}</p>`;return a||ChatMessage.create(g.chatDataSetup(n,"roll")),!0}}static async _updateMoney(e,t,a,s=!0){let i=j._moneyToCoins(a);for(let r of t)switch(r.name){case"Money-D":r.system.quantity.value=i.D;break;case"Money-S":r.system.quantity.value=i.S;break;case"Money-H":r.system.quantity.value=i.H;break;case"Money-K":r.system.quantity.value=i.K;break}await e.updateEmbeddedDocuments("Item",t,{render:s})}static createGetPaidChatMessage(e,t=void 0){let a=this._getPaidmoney(e);if(a){let s=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("PAYMENT.wage")}</b></p><p>${game.i18n.format("PAYMENT.getPaidSum",{amount:j._moneyToString(a)})}${s}</p><button class="payButton" data-pay="1" data-amount="${a}">${game.i18n.localize("PAYMENT.getPaidButton")}</button>`;ChatMessage.create(g.chatDataSetup(i,"roll"))}}static createPayChatMessage(e,t=void 0){let a=this._getPaymoney(e);if(a){let s=t?` (${t})`:"",i=`<p><b>${game.i18n.localize("PAYMENT.bill")}</b></p>${game.i18n.format("PAYMENT.paySum",{amount:j._moneyToString(a)})}${s}</p><button class="payButton" data-pay="0" data-amount="${a}">${game.i18n.localize("PAYMENT.payButton")}</button>`;ChatMessage.create(g.chatDataSetup(i,"roll"))}}static _getPaidmoney(e){let t=this._parseMoneyString(e);if(!t){let a=`<p><b>${game.i18n.localize("PAYMENT.error")}</b></p><p><i>${game.i18n.localize("PAYMENT.getPaidexample")}</i></p>`;return ChatMessage.create(g.chatDataSetup(a,"roll")),!1}return t}static _getPaymoney(e){let t=this._parseMoneyString(e);if(!t){let a=`<p><b>${game.i18n.localize("PAYMENT.error")}</b></p><p><i>${game.i18n.localize("PAYMENT.payexample")}</i></p>`;return ChatMessage.create(g.chatDataSetup(a,"roll")),!1}return t}static _parseMoneyString(e){let t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return t?Number(t[0]):!1}static _actorsMoney(e){let t=duplicate(e.items.filter(a=>a.type=="money"));return{money:t,sum:t.reduce((a,s)=>a+Number(s.system.quantity.value)*Number(s.system.price.value),0)}}static async handlePayAction(e,t,a,s=void 0){if(game.user.isGM&&!s){ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors"));return}s?U.playMoneySound(!0):s=game.user.character;let i=!1;s&&t?i=await j.payMoney(s,a):s&&!t?i=await j.getMoney(s,a):ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors")),i&&e&&(e.fadeOut(),game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:{[`flags.dsa5.userHidden.${game.user.id}`]:!0}}}))}static _moneyToCoins(e){let t=Math.round(e*100),a=Math.floor(t/1e3),s=Math.floor((t-a*1e3)/100),i=Math.floor((t-a*1e3-s*100)/10);return{D:a,S:s,H:i,K:Math.round(t-a*1e3-s*100-i*10)}}static _moneyToString(e){let t=j._moneyToCoins(e),a=[];for(let[s,i]of Object.entries(t))i>0&&a.push(`<span class="nobr">${i} <span data-tooltip="Money-${s}" class="chatmoney money-${s}"></span></span>`);return a.join(", ")}static async chatListeners(e){e.on("click",".payButton",t=>{let a=$(t.currentTarget);j.handlePayAction(a,Number(a.attr("data-pay"))!=1,a.attr("data-amount")),U.playMoneySound()})}};var be=class{constructor(){be.skills.length==0&&g.allSkills().then(e=>{be.skills=e.map(t=>({name:t.name,type:"skill"})).concat(Object.values(game.dsa5.config.characteristics).map(t=>({name:game.i18n.localize(t),type:"attribute"})).concat([{name:game.i18n.localize("regenerate"),type:"regeneration"},{name:game.i18n.localize("fallingDamage"),type:"fallingDamage"}]))}),this.filtering=!1,this.combatConstants={dodge:game.i18n.localize("dodge"),parryWeaponless:game.i18n.localize("parryWeaponless"),attackWeaponless:game.i18n.localize("attackWeaponless")}}get regex(){return new RegExp(`^/(${be.cmds.join(" |")})`)}async chatListeners(e){let t=this,a=e.find("#chat-message");e.on("keyup","#chat-message",async function(i){t._parseInput(i)}),e.on("click",".quick-item",async function(i){t._quickSelect($(i.currentTarget))}),a.on("keydown",function(i){t._navigateQuickFind(i)});let s=jQuery._data(a[0]).events.keydown;s.unshift(s.pop())}_parseInput(e){let t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(e.which==27)return this._closeQuickfind(e),!1;let a=this._getCmd(t),s=t.substring(1+a.length).toLowerCase().trim();this[`_filter${a}`](s,e),this.filtering=!0}else this._closeQuickfind(e)}_getCmd(e){return e.substring(1,3).toUpperCase().trim()}_completeCurrentEntry(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())+""}_closeQuickfind(e){this.filtering=!1,$(e.currentTarget).closest("#chat-form").find(".quickfind").remove()}_filterW(e,t){let a=game.users.contents.filter(s=>s.active&&s.name.toLowerCase().trim().indexOf(e)!=-1).map(s=>({name:s.name,type:"user"}));this._checkEmpty(a),this._setList(a,"W",t)}_filterAT(e,t){let{actor:a,tokenId:s}=be._getActor();if(a){let i=["meleeweapon","rangeweapon"],r=["meleeAttack","rangeAttack"],n=a.items.filter(o=>(i.includes(o.type)&&o.system.worn.value==!0||o.type=="trait"&&r.includes(o.system.traitType.value))&&o.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(o=>({name:o.name,type:"item"})).concat([{name:this.combatConstants.attackWeaponless,type:"item"}].filter(o=>o.name.toLowerCase().trim().indexOf(e)!=-1));this._checkEmpty(n),this._setList(n,"AT",t)}}_filterPA(e,t){let{actor:a,tokenId:s}=be._getActor();if(a){let i=["meleeweapon"],r=a.items.filter(n=>i.includes(n.type)&&n.name.toLowerCase().trim().indexOf(e)!=-1&&n.system.worn.value==!0).slice(0,5).map(n=>({name:n.name,type:"item"})).concat([{name:this.combatConstants.dodge,type:"item"},{name:this.combatConstants.parryWeaponless,type:"item"}].filter(n=>n.name.toLowerCase().trim().indexOf(e)!=-1));this._checkEmpty(r),this._setList(r,"PA",t)}}_filterSP(e,t){let{actor:a,tokenId:s}=be._getActor();if(a){let i=["spell","ritual"],r=a.items.filter(n=>i.includes(n.type)&&n.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(n=>({name:n.name,type:"item"}));this._checkEmpty(r),this._setList(r,"SP",t)}}_checkEmpty(e){e.length||e.push({name:game.i18n.localize("DSAError.noMatch"),type:"none"})}_filterLI(e,t){let{actor:a,tokenId:s}=be._getActor();if(a){let i=["liturgy","ceremony"],r=a.items.filter(n=>i.includes(n.type)&&n.name.toLowerCase().trim().indexOf(e)!=-1).slice(0,5).map(n=>({name:n.name,type:"item"}));this._checkEmpty(r),this._setList(r,"LI",t)}}_getSkills(e,t=void 0){e=e.replace(/(-|\+)?\d+/g,"").trim();let a=be.skills.filter(s=>s.name.toLowerCase().trim().indexOf(e)!=-1&&(t==null||t==s.type)).slice(0,5);return this._checkEmpty(a),a}_filterCH(e,t){this._setList(this._getSkills(e),"CH",t)}_filterSK(e,t){this._setList(this._getSkills(e),"SK",t)}_filterRQ(e,t){this._setList(this._getSkills(e),"RQ",t)}_filterGC(e,t){this._setList(this._getSkills(e,"skill"),"GC",t)}_setList(e,t,a){let s=$(`<div class="quickfind dsalist"><ul>${e.map(n=>`<li data-type="${n.type}" data-category="${t}" class="quick-item">${n.name}</li>`).join("")}</ul></div>`);s.find(".quick-item:first").addClass("focus");let i=$(a.currentTarget).closest("#chat-form"),r=i.find(".quickfind");r.length?r.replaceWith(s):i.append(s)}_navigateQuickFind(e){if(this.filtering){let t=$(e.currentTarget).closest("#chat-form").find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if(t.attr("data-category")=="W")break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}return!0}static _getActor(){let e=ChatMessage.getSpeaker(),t;return e.token&&(t=game.actors.tokens[e.token]),t||(t=game.actors.get(e.actor)),t?{actor:t,tokenId:e.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}_quickSelect(e){let t=e.attr("data-category");switch(t){case"NM":case"GC":case"RQ":case"CH":this[`_quick${t}`](e);break;case"W":this._completeCurrentEntry(e);break;default:let{actor:a,tokenId:s}=be._getActor();a&&(this._resetChatAutoCompletion(e),this[`_quick${t}`](e,a,s))}}_quickW(e,t,a){}_quickCH(e){Z.check3D20(e),this._resetChatAutoCompletion(e)}_quickSK(e,t,a){switch(e.attr("data-type")){case"skill":let s=t.items.find(r=>r.name==e.text()&&r.type=="skill");s&&t.setupSkill(s,{},a).then(r=>{t.basicTest(r)});break;case"attribute":let i=Object.keys(game.dsa5.config.characteristics).find(r=>game.i18n.localize(game.dsa5.config.characteristics[r])==e.text());t.setupCharacteristic(i,{},a).then(r=>{t.basicTest(r)});break;case"regeneration":t.setupRegeneration("regenerate",{},a).then(r=>{t.basicTest(r)});break}}_resetChatAutoCompletion(e){let t=e.closest("#chat-form");t.find("#chat-message").val(""),t.find(".quickfind").remove()}_quickGC(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(e),G.showGCMessage(e.text(),t)}_quickRQ(e){let t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(e),G.showRQMessage(e.text(),t)}_quickPA(e,t,a){let s=e.text();if(this.combatConstants.dodge==s)t.setupDodge({},a).then(i=>{t.basicTest(i)});else if(this.combatConstants.parryWeaponless==s)t.setupWeaponless("parry",{},a).then(i=>{t.basicTest(i)});else{let i=["meleeweapon"],r=t.items.find(n=>i.includes(n.type)&&n.name==e.text());r&&t.setupWeapon(r,"parry",{},a).then(n=>{t.basicTest(n)})}}_quickAT(e,t,a){let s=e.text();if(this.combatConstants.attackWeaponless==s)t.setupWeaponless("attack",{},a).then(i=>{t.basicTest(i)});else{let i=["meleeweapon","rangeweapon"],r=["meleeAttack","rangeAttack"],n=t.items.find(o=>i.includes(o.type)&&o.name==e.text());n||(n=t.items.find(o=>o.type=="trait"&&o.name==e.text()&&r.includes(o.system.traitType.value))),n&&t.setupWeapon(n,"attack",{},a).then(o=>{t.basicTest(o)})}}_quickSP(e,t,a){let s=["ritual","spell"],i=t.items.find(r=>s.includes(r.type)&&r.name==e.text());i&&t.setupSpell(i,{},a).then(r=>{t.basicTest(r)})}_quickLI(e,t,a){let s=["liturgy","ceremony"],i=t.items.find(r=>s.includes(r.type)&&r.name==e.text());i&&t.setupSpell(i,{},a).then(r=>{t.basicTest(r)})}static async infoItemAsync(e){(await fromUuid(e)).postItem()}static bindRollCommands(e){e.on("click",".request-roll",s=>{let i=s.currentTarget.dataset;return G.showRQMessage(i.name,Number(i.modifier)||0,i.label),s.stopPropagation(),!1}),e.on("click",".postInfo",s=>{let i=fromUuidSync(s.currentTarget.dataset.uuid);return i&&(typeof i.postItem=="function"?i.postItem():this.infoItemAsync(s.currentTarget.dataset.uuid)),s.stopPropagation(),!1}),e.on("click",".postContentChat",async s=>{let i=$(s.currentTarget).closest(".postChatSection").find(".postChatContent").html();ot.getDialog(i)}),e.on("click",".request-GC",s=>(G.showGCMessage(s.currentTarget.dataset.name,Number(s.currentTarget.dataset.modifier)||0),s.stopPropagation(),!1)),e.on("click",".request-CH",s=>(Z.check3D20(void 0,s.currentTarget.dataset.name,{modifier:Number(s.currentTarget.dataset.modifier)||0}),s.stopPropagation(),!1)),e.on("click",".request-Pay",s=>{!game.user.isGM||j.createPayChatMessage(s.currentTarget.dataset.modifier)}),e.on("click",".request-GetPaid",s=>{!game.user.isGM||j.createGetPaidChatMessage(s.currentTarget.dataset.modifier)}),e.on("click",".request-AP",s=>{if(!game.user.isGM)return;let i=game.dsa5.apps.gameMasterMenu;i.getExp(i.selectedIDs(),s.currentTarget.dataset.modifier)});let t=s=>{s.stopPropagation();let i=s.currentTarget.dataset.type,r=s.currentTarget.dataset.uuid;!r||!i||s.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:i,uuid:r}))},a=e.find(".show-item");a.click(async s=>{let i=s.currentTarget.dataset.uuid;(await fromUuid(i)).sheet.render(!0)}),a.attr("draggable",!0).on("dragstart",s=>t(s)),e.on("click",".actorEmbeddedAbility",async s=>{let r=(await fromUuid(s.currentTarget.dataset.actor)).items.get(s.currentTarget.dataset.id);r&&r.sheet.render(!0)})}},ee=be;R(ee,"skills",[]),R(ee,"cmds",["sk","at","pa","sp","li","rq","gc","w","ch"]);var G=class{static async requestGC(e,t,a,s=0){let{actor:i,tokenId:r}=ee._getActor();if(!i)return;game.user.updateTokenTargets([]);let n={modifier:s,postFunction:{cummulative:a,functionName:"game.dsa5.apps.RequestRoll.autoEditGroupCheckRoll"}};switch(e){case"attribute":break;default:let o=i.items.find(c=>c.name==t&&c.type==e);i.setupSkill(o,n,r).then(async c=>{let m=await i.basicTest(c);await G.editGroupCheckRoll(a,m,t,e)})}}static async autoEditGroupCheckRoll(e,t,a){await G.editGroupCheckRoll(e.cummulative,t,a.name,a.type)}static async editGroupCheckRoll(e,t,a,s){let i=await game.messages.get(e),r=i.flags,o=t.result.successLevel>1?2:1;r.botched=r.botched||t.result.successLevel<-1;let c=g.getSpeaker(t.result.speaker),m={messageId:t.result.messageId,actor:c.name,qs:(t.result.qualityStep||0)*o,success:t.result.successLevel,target:a,type:s},d=r.results.findIndex(u=>u.messageId==m.messageId);d>=0?r.results[d]=m:r.results.push(m),G.rerenderGC(i,r)}static async requestRoll(e,t,a=0){let{actor:s,tokenId:i}=ee._getActor();if(s){game.user.updateTokenTargets([]);let r={modifier:a};switch(e){case"attribute":let n=Object.keys(game.dsa5.config.characteristics).find(c=>game.i18n.localize(game.dsa5.config.characteristics[c])==t);s.setupCharacteristic(n,r,i).then(c=>{s.basicTest(c)});break;case"regeneration":s.setupRegeneration("regenerate",r,i).then(c=>{s.basicTest(c)});break;case"fallingDamage":s.setupFallingDamage(r,i);break;default:let o=s.items.find(c=>c.name==t&&c.type==e);s.setupSkill(o,r,i).then(c=>{s.basicTest(c)})}}}static async rerenderGC(e,t){if(game.user.isGM){let a=0;t.qs=t.results.reduce((i,r)=>(a+=r.success<0?1:0,r.success>1&&(a=0),i+r.qs),0),t.failed=a;for(let i of t.rollOptions)i.calculatedModifier=i.modifier-a;t.openRolls=t.maxRolls-t.results.length,t.doneRolls=t.results.length;let s=await renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",t);e.update({content:s,flags:t})}else game.socket.emit("system.dsa5",{type:"updateGroupCheck",payload:{messageId:e.id,data:t}});$("#chat-log").find(`[data-message-id="${e.id}"`).appendTo("#chat-log")}static showRQMessage(e,t=0,a=void 0){let s=t<0?` ${t}`:t>0?` +${t}`:"",i=ee.skills.find(n=>n.name==e).type,r=game.i18n.format("CHATNOTIFICATION.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${i}" data-modifier="${t}" data-name="${e}"><i class="fas fa-dice"></i> ${a||e}${s}</a>`});ChatMessage.create(g.chatDataSetup(r))}static async showGCMessage(e,t=0,a={}){let s=ee.skills.find(o=>o.name==e).type,i={results:[],qs:0,failed:0,modifier:t,name:game.user.name,maxRolls:7,openRolls:7,doneRolls:0,targetQs:10,rollOptions:[{type:s,modifier:t,calculatedModifier:t,target:e}]};mergeObject(i,a);let r=await renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",i),n=g.chatDataSetup(r);n.flags=i,ChatMessage.create(n)}static async addSkillToGC(e){let t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=await renderTemplate("systems/dsa5/templates/dialog/addgroupcheckskill.html",{skills:ee.skills.filter(i=>i.type=="skill").sort((i,r)=>i.name.localeCompare(r.name))}),s={title:game.i18n.localize("HELP.groupcheck"),content:a,buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async i=>{let r=game.messages.get(t),n=r.flags;n.rollOptions.push({type:"skill",modifier:i.find('[name="modifier"]').val(),target:i.find('[name="skill"]').val()}),G.rerenderGC(r,n)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new X(s).render(!0)}static async removeGCEntry(e){let t=$(e.currentTarget),a=Number(e.currentTarget.dataset.index),s=game.messages.get(t.parents(".message").attr("data-message-id")),i=s.flags;i.results.splice(a,1),G.rerenderGC(s,i)}static removeSkillFromGC(e){let t=$(e.currentTarget),a=game.messages.get(t.parents(".message").attr("data-message-id")),s=a.flags;s.rollOptions=s.rollOptions.filter(i=>!(i.type==e.currentTarget.dataset.type&&i.target==e.currentTarget.dataset.name)),s.results=s.results.filter(i=>!(i.type==e.currentTarget.dataset.type&&i.target==e.currentTarget.dataset.name)),G.rerenderGC(a,s)}static async editGC(e){let t=$(e.currentTarget),a=Number(e.currentTarget.dataset.index),s=game.messages.get(t.parents(".message").attr("data-message-id")),i=s.flags;if(a)i.results[a].qs=Number(t.val());else if(e.currentTarget.dataset.name){let r=i.rollOptions.find(n=>n.target==e.currentTarget.dataset.name&&e.currentTarget.dataset.type==n.type);r[e.currentTarget.dataset.field]=Number(t.val())}else i[e.currentTarget.dataset.field]=Number(t.val());G.rerenderGC(s,i)}static async updateInformationRoll(e,t,a){let s=[],i=await fromUuid(e.uuid),r=t.result.qualityStep||0;for(let n=1;n<=r;n++){let o=`qs${n}`;i.system[o]&&s.push(i.system[o])}if(t.result.successLevel>1&&i.system.crit?s.push(i.system.crit):t.result.successLevel<-1&&i.system.botch?s.push(i.system.botch):i.system.fail&&!r&&s.push(i.system.fail),s.length>0){await Promise.all(s.map(async o=>await TextEditor.enrichHTML(o,{async:!0}))),s.unshift(`<p><b>${i.name}</b></p>`);let n=g.chatDataSetup(s.join(""));e.recipients.length&&(n.whisper=e.recipients),ChatMessage.create(n)}}static async informationRequestRoll(e){let t=e.currentTarget.dataset.mod,a=e.currentTarget.dataset.uuid,{actor:s,tokenId:i}=ee._getActor();if(!s)return;let r=game.settings.get("dsa5","informationDistribution"),n=[];r==1?(n=game.users.filter(m=>m.isGM).map(m=>m.id),n.push(game.user.id)):r==2&&(n=game.users.filter(m=>m.isGM).map(m=>m.id));let o={modifier:t,postFunction:{functionName:"game.dsa5.apps.RequestRoll.updateInformationRoll",uuid:a,recipients:n}},c=s.items.find(m=>m.name==e.currentTarget.dataset.skill&&m.type=="skill");s.setupSkill(c,o,i).then(async m=>{m.testData.opposable=!1;let d=await s.basicTest(m);this.updateInformationRoll(o.postFunction,d)})}static chatListeners(e){e.on("change",".editGC",t=>G.editGC(t)),e.on("click",".request-roll",t=>{let a=t.currentTarget.dataset;G.requestRoll(a.type,a.name,Number(a.modifier)||0)}),e.on("click",".request-gc",t=>{let a=t.currentTarget.dataset;G.requestGC(a.type,a.name,$(t.currentTarget).parents(".message").attr("data-message-id"),Number(a.modifier)||0)}),e.on("click",".removeGC",t=>G.removeGCEntry(t)),e.on("click",".removeSkillFromGC",t=>G.removeSkillFromGC(t)),e.on("click",".addSkillToGC",t=>G.addSkillToGC(t)),e.on("click",".informationRequestRoll",t=>G.informationRequestRoll(t))}};var Mt,It,ge,dt=class extends MeasuredTemplate{constructor(){super(...arguments);Bt(this,Mt,void 0);Bt(this,It,0);Bt(this,ge,void 0)}static async placeTemplateFromChat(t){let a=$(t.currentTarget).parents(".message").attr("data-message-id"),s=game.messages.get(a),i=s.flags.data.preData.source,r=s.flags.data.postData,n=this.fromItem(i,r.successLevel);n&&n.drawPreview()}static fromItem(t,a){let s=t.system.target||{},i=game.dsa5.config.areaTargetTypes[s.type];if(!i||!s.value)return null;let r=Number(Roll.safeEval(`${s.value}`.replace(/(qs|ql)/gi,a)))||1,n={t:i,user:game.user.id,distance:r,direction:0,x:0,y:0,fillColor:game.user.color,flags:{dsa5:{origin:t.uuid}}};switch(i){case"cone":n.angle=Number(s.angle)||CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":n.distance=Math.hypot(r,r),n.width=r,n.direction=45;break;case"ray":n.width=s.width&&Number(Roll.safeEval(`${s.width}`.replace(/(qs|ql)/gi,a)))||canvas.dimensions.distance;break}let o=CONFIG.MeasuredTemplate.documentClass,c=new o(n,{parent:canvas.scene}),m=new this(c);return m.item=t,m.actorSheet=t.actor?.sheet||null,m}drawPreview(){let t=canvas.activeLayer;return this.draw(),this.layer.activate(),this.layer.preview.addChild(this),this.activatePreviewListeners(t)}activatePreviewListeners(t){return new Promise((a,s)=>{qt(this,Mt,t),qt(this,ge,{cancel:this._onCancelPlacement.bind(this),confirm:this._onConfirmPlacement.bind(this),move:this._onMovePlacement.bind(this),resolve:a,reject:s,rotate:this._onRotatePlacement.bind(this)}),canvas.stage.on("mousemove",ye(this,ge).move),canvas.stage.on("mousedown",ye(this,ge).confirm),canvas.app.view.oncontextmenu=ye(this,ge).cancel,canvas.app.view.onwheel=ye(this,ge).rotate})}async _finishPlacement(t){this.layer._onDragLeftCancel(t),canvas.stage.off("mousemove",ye(this,ge).move),canvas.stage.off("mousedown",ye(this,ge).confirm),canvas.app.view.oncontextmenu=null,canvas.app.view.onwheel=null,ye(this,Mt).activate(),await this.actorSheet?.maximize()}_onMovePlacement(t){t.stopPropagation();let a=Date.now();if(a-ye(this,It)<=20)return;let s=t.data.getLocalPosition(this.layer),i=canvas.grid.getSnappedPosition(s.x,s.y,2);this.document.updateSource({x:i.x,y:i.y}),this.refresh(),qt(this,It,a)}_onRotatePlacement(t){t.ctrlKey&&t.preventDefault(),t.stopPropagation();let a=canvas.grid.type>CONST.GRID_TYPES.SQUARE?30:15,s=t.shiftKey?a:5,i={direction:this.document.direction+s*Math.sign(t.deltaY)};this.document.updateSource(i),this.refresh()}async _onConfirmPlacement(t){await this._finishPlacement(t);let a=canvas.grid.getSnappedPosition(this.document.x,this.document.y,2);this.document.updateSource(a),ye(this,ge).resolve(canvas.scene.createEmbeddedDocuments("MeasuredTemplate",[this.document.toObject()]))}async _onCancelPlacement(t){await this._finishPlacement(t),ye(this,ge).reject()}};Mt=new WeakMap,It=new WeakMap,ge=new WeakMap;var Ye=class{static async applyEffect(e,t){let a=game.messages.get(e),s=getProperty(a,"flags.dsa5.hasEffect"),i=getProperty(a,"flags.dsa5.options")||{};if(s){let r=["damageModifier","gearDamaged","gearLost","resistEffect","malus","selfDamage","nextAction"],n=[],o;if(t=="self"){let m=g.getSpeaker(i.speaker);n.push(m),o=i.source?m.items.get(i.source):void 0}else n=Array.from(game.user.targets).map(m=>m.actor);for(let m of r){let d=getProperty(s,m);d&&(await Ye[m](d,t,n,o,e,a)||console.warn(`Table effect for <${m} not working yet`,d,t,n,o))}let c=game.i18n.format("ActiveEffects.appliedEffect",{source:game.i18n.localize("table"),target:n.map(m=>m.name).join(", ")});await a.update({content:a.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${c}"></i>`)})}}static async damageModifier(e,t,a,s){}static async nextAction(e,t,a,s){}static async opportunityAttack(e,t,a,s){}static async gearDamaged(e,t,a,s){if(s&&["meleeweapon","rangeweapon"].includes(s.type)){let i=getProperty(s,"system.effect.attributes")||"";return new RegExp(`(${M.magical}|${M.clerical})`,"i").test(i)?await s.update({"system.worn.value":!1}):await q.absoluteDamageLevelToItem(s,e),!0}}static async gearLost(e,t,a,s){if(s&&["meleeweapon","rangeweapon"].includes(s.type)){if(await s.update({"system.worn.value":!1}),e.distance){let i=await new Roll(e.distance).evaluate({async:!0}),r=await i.render(),n=game.i18n.format("WEAPON.dropped",{distance:i.total});ChatMessage.create(g.chatDataSetup(`<p>${n}</p>${r}`))}return!0}}static async resistEffect(e,t,a,s,i){for(let r of a){let n=[{skill:e.roll,mod:e.modifier||0,effect:{_id:"botchEffect",name:e.fail.description},target:r,token:r.token?r.token.id:void 0}];_DSAActiveEffectConfig.createResistRollMessage(n,i,t)}return!0}static evaluateTargetArg(e,t){let a=t,s=!0;if(e.target=="victim"){let i=Array.from(game.user.targets).map(r=>r.actor);i.length?a=i:(s=!1,ui.notifications.warn("DSAError.noVictim"))}return{hasTargets:s,finalTargets:a}}static async malus(e,t,a,s){let{hasTargets:i,finalTargets:r}=this.evaluateTargetArg(e,a);for(let n of e){let o=!i&&n.noTarget,c=o?n.noTarget.systemEffect:n.systemEffect,m=o?n.noTarget.level:n.level||1,d=o?n.noTarget.changes:n.changes,u=o?n.noTarget.duration:n.duration;if(c){let p=CONFIG.statusEffects.find(h=>h.id==c);if(!d){d=duplicate(p.changes);let h=d.find(w=>w.key==`system.condition.${c}`);h&&(h.value=m)}let f;if(d){let h=game.i18n.localize(`CONDITION.${c}`)+" - "+game.i18n.localize("botchCritEffect");f=new J().effectDummy(h,d,u||{}),f.icon=p.icon}else f=c;for(let h of r)await h.addCondition(f);return!0}else if(d){let p=new J().effectDummy(game.i18n.localize("botchCritEffect"),d||[],u||{});mergeObject(p,{flags:{dsa5:{hideOnToken:!1,hidePlayers:!1}}});for(let f of r)await f.addCondition(p);return!0}}}static async selfAttack(e,t,a,s){let{hasTargets:i,finalTargets:r}=this.evaluateTargetArg(e,a)}static async selfDamage(e,t,a,s){let{hasTargets:i,finalTargets:r}=this.evaluateTargetArg(e,a);if(s){let n=g.toObjectIfPossible(s);for(let o of r){let c=o.items.filter(p=>p.type=="combatskill").map(p=>T._calculateCombatSkillValues(p.toObject(),o.system)),m;e.damage?m={damagedie:e.damage,damageAdd:""}:s.type=="rangeweapon"?m=T._prepareRangeWeapon(n,[],c,o):s.type=="meleeweapon"?m=T._prepareMeleeWeapon(n,c,o):m=s.system.traitType.value=="meleeAttack"?T._prepareRangeTrait(n):T._prepareMeleetrait(n);let d=(m.damagedie+m.damageAdd).replace(/wWD/g,"d"),u=await new Roll(`(${d})*${e.multiplier||1}${e.modifier||""}`).evaluate({async:!0});await o.applyDamage(Math.round(u.total)),ChatMessage.create(g.chatDataSetup(await u.render()))}return!0}else{for(let n of r){let o=await new Roll("1d6").evaluate({async:!0});await n.applyDamage(Math.round(o.total)),ChatMessage.create(g.chatDataSetup(await o.render()))}return!0}}};var mt=async(l,e,t=1)=>{let a=game.messages.get(l.attr("data-message-id")),s=a.flags.opposeData,i=s?.speakerDefend,r=g.getSpeaker(i);if(!r.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));await r.applyDamage(s.damage[e]*t);let n={"flags.data.damageApplied":!0,content:a.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${game.i18n.localize("damageApplied")}"></i>`)};game.user.isGM?await a.update(n):game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:l.attr("data-message-id"),updateData:n}})};function oi(){let l=(E,A)=>g.fateAvailable(E,A),e=function(E,A="damage.value"){let b=game.messages.get(E.attr("data-message-id")).flags.opposeData,P=b?g.getSpeaker(b.speakerDefend)?.isOwner:!1;return((game.user.isGM||P)&&E.find(".opposed-card").length||E.find(".dice-roll").length)&&(getProperty(b,A)||0)>0},t=function(E){return e(E,"damage.sp")},a=function(E){let A=game.messages.get(E.attr("data-message-id"));return A.speaker.actor&&A.flags.data&&(game.actors.get(A.speaker.actor).isOwner||game.user.isGM)?["liturgy","ceremony","spell","ritual","magicalsign"].includes(A.flags.data.preData.source.type)||getProperty(A.flags.data.preData,"calculatedSpellModifiers.costsMana"):!1},s=function(E){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){let A=game.messages.get(E.attr("data-message-id"));return"hideData"in A.flags&&A.flags.hideData}return!1},i=function(E){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){let A=game.messages.get(E.attr("data-message-id"));return"hideData"in A.flags&&!A.flags.hideData}return!1},r=function(E,A=!1){let b=game.messages.get(E.attr("data-message-id"));if(b.speaker.actor&&b.flags.data&&b.flags.data.postData.successLevel>-2){let P=game.actors.get(b.speaker.actor);if(P.isOwner&&l(P,A)){let Y=b.flags.data.preData.source.type,fe=b.flags.data.preData.mode||"";["skill","spell","liturgy","ritual","ceremony"].includes(Y)&&(Y="char");let he=game.i18n.localize(`SCHIPSKILLS.${Y}${fe}`);return!b.flags.data.fateImproved&&P.items.getName(he)}}return!1},n=function(E){return r(E,!0)},o=function(E,A=!1){let b=game.messages.get(E.attr("data-message-id"));if(b.speaker.actor&&b.flags.data){let P=game.actors.get(b.speaker.actor);if(P.isOwner&&l(P,A)&&!b.flags.data.fatePointAddQSUsed)return b.flags.data.postData.successLevel>0&&b.flags.data.postData.qualityStep!=null}return!1},c=function(E){return o(E,!0)},m=function(E){let A=game.messages.get(E.attr("data-message-id"));if(A.speaker.actor&&A.flags.data){let b=game.actors.get(A.speaker.actor);if(b.isOwner)return b.items.find(P=>P.name==`${game.i18n.localize("LocalizedIDs.aptitude")} (${A.flags.data.preData.source.name})`)!=null&&!A.flags.data.talentedRerollUsed}return!1},d=function(E,A=!1){let b=game.messages.get(E.attr("data-message-id"));if(b.speaker.actor&&b.flags.data){let P=game.actors.get(b.speaker.actor);if(P.isOwner&&l(P,A))return b.flags.data.postData.damageRoll!=null&&!b.flags.data.fatePointDamageRerollUsed}return!1},u=function(E){return d(E,!0)},p=function(E,A=!1){let b=game.messages.get(E.attr("data-message-id"));if(b.speaker.actor&&b.flags.data){let P=game.actors.get(b.speaker.actor);if(P.isOwner&&l(P,A))return!b.flags.data.fatePointRerollUsed&&b.flags.data.postData.rollType!="regenerate"}return!1},f=function(E){return p(E,!0)},h=function(E){let A=game.messages.get(E.attr("data-message-id"));return A.speaker.actor&&A.flags.data&&game.actors.get(A.speaker.actor).isOwner&&["LeP","KaP","AsP"].some(P=>getProperty(A.flags,`data.postData.${P}`)!=null)?!A.flags.data.healApplied:!1},w=function(E){if(game.user.isGM){let A=game.messages.get(E.attr("data-message-id"));if("hideData"in A.flags){let b=!A.flags.hideData,P=$(A.content);P.find(".hideAnchor")[b?"addClass":"removeClass"]("hideData"),P=$("<div></div>").append(P),A.update({content:P.html(),"flags.hideData":b})}}},z=E=>{let A=game.messages.get(E.data("messageId"));return!A||!canvas.tokens?!1:A.isRoll&&A.isContentVisible&&canvas.tokens.controlled.length&&E.find(".dice-roll").length},v=(E,A,b=0)=>{let P=game.messages.get(E.attr("data-message-id"));game.actors.get(P.speaker.actor).useFateOnRoll(P,A,b)},L=(E,A,b=1)=>{let Y=game.messages.get(E.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map(fe=>{let he=fe.actor,Be=Math.round((A!="sp"?Y.total-T.armorValue(he).armor:Y.total)*b);return he.applyDamage(Math.max(0,Be))}))},D=async E=>{let A=game.messages.get(E.attr("data-message-id")),b=A.flags.data,P=g.getSpeaker(A.speaker);if(!P.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));let Y=b.preData.calculatedSpellModifiers.maintainCost.trim(),fe=["ritual","spell"].includes(b.preData.source.type)||getProperty(b.preData.calculatedSpellModifiers,"costsMana")?"AsP":"KaP",he=await P.applyMana(b.preData.calculatedSpellModifiers.finalcost,fe);if(Y&&Y!=0&&he&&b.postData.successLevel>0){let Be=b.preData.source.name;try{let kt=Y.match(/^\d{1,3}/)[0],it=Y.replace(/^\d{1,3}/,"").match(/\d{1,3}/);it=it&&Number(it[0])||1;let qe={name:`${Be} (${game.i18n.localize("maintainCost")})`,icon:"icons/svg/daze.svg",flags:{dsa5:{description:Y,maintain:kt,payType:fe}},changes:[],duration:{}},k=[{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.days"),"gi"),seconds:3600*24},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.seconds"),"gi"),seconds:1},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.weeks"),"gi"),seconds:3600*24*7},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.months"),"gi"),seconds:3600*24*30},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.years"),"gi"),seconds:3600*24*350}];for(let B of k)if(B.regEx.test(Y)){let Te=Number(it)*B.seconds;qe.duration.seconds=Te,qe.duration.rounds=qe.duration.seconds/5;break}await P.addCondition(qe)}catch{console.error(`Could not parse duration '${Y}' of '${Be}'`)}}await A.update({"flags.data.manaApplied":!0,content:A.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')})},x=()=>game.i18n.localize(game.combat?.isBrawling?"CHATCONTEXT.ApplyDamagePP":"CHATCONTEXT.ApplyDamage");Hooks.on("getChatLogEntryContext",(E,A)=>{A.push({name:game.i18n.localize("CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:i,callback:b=>{w(b)}},{name:game.i18n.localize("CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:s,callback:b=>{w(b)}},{name:game.i18n.localize("regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:h,callback:async b=>{let P=await game.messages.get(b.attr("data-message-id")),Y=g.getSpeaker(P.speaker);if(!Y.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));await P.update({"flags.data.healApplied":!0,content:P.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')}),await Y.applyRegeneration(P.flags.data.postData.LeP,P.flags.data.postData.AsP,P.flags.data.postData.KaP)}},{name:game.i18n.localize("CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:a,callback:async b=>{D(b)}},{name:x(),icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:b=>{mt(b,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:b=>{mt(b,"sp")}},{name:x(),icon:'<i class="fas fa-user-minus"></i>',condition:z,callback:b=>{L(b,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:z,callback:b=>{L(b,"sp")}},{name:game.i18n.localize("CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:p,callback:b=>{v(b,"reroll")}},{name:game.i18n.localize("CHATCONTEXT.RerollGroup"),icon:'<i class="fas fa-dice"></i>',condition:f,callback:b=>{v(b,"reroll",1)}},{name:game.i18n.localize("CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:m,callback:b=>{v(b,"isTalented")}},{name:game.i18n.localize("CHATCONTEXT.AddQS"),icon:'<i class="fas fa-plus-square"></i>',condition:o,callback:b=>{v(b,"addQS")}},{name:game.i18n.localize("CHATCONTEXT.AddQSGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:c,callback:b=>{v(b,"addQS",1)}},{name:game.i18n.localize("CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:d,callback:b=>{v(b,"rerollDamage")}},{name:game.i18n.localize("CHATCONTEXT.rerollDamageGroup"),icon:'<i class="fas fa-dice"></i>',condition:u,callback:b=>{v(b,"rerollDamage",1)}},{name:game.i18n.localize("CHATCONTEXT.improveFate"),icon:'<i class="fas fa-plus-square"></i>',condition:r,callback:b=>{v(b,"Improve")}},{name:game.i18n.localize("CHATCONTEXT.improveFateGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:n,callback:b=>{v(b,"Improve",1)}}),game.settings.get("dsa5","doubleDamageOptions")&&A.push({name:x()+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:e,callback:b=>{mt(b,"value",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:t,callback:b=>{mt(b,"sp",2)}},{name:x()+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:z,callback:b=>{L(b,"value",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:z,callback:b=>{L(b,"sp",2)}})})}var _DiceDSA5=class{static async rollTest(l){let e;switch(l.source.type){case"ceremony":case"ritual":case"liturgy":case"spell":e=await this.rollSpell(l);break;case"skill":e=await this.rollTalent(l);break;case"combatskill":e=await this.rollCombatskill(l);break;case"trait":l.mode=="parry"&&await this.updateDefenseCount(l),e=l.mode=="damage"?await this.rollDamage(l):await this.rollCombatTrait(l);break;case"regenerate":e=await this.rollRegeneration(l);break;case"meleeweapon":case"rangeweapon":l.mode=="parry"&&await this.updateDefenseCount(l),e=l.mode=="damage"?await this.rollDamage(l):await this.rollWeapon(l);break;case"dodge":await this.updateDefenseCount(l),e=await this.rollStatus(l);break;case"poison":case"disease":e=await this.rollItem(l);break;case"fallingDamage":e=await this.rollFallingDamage(l);break;default:e=await this.rollAttribute(l)}return mergeObject(e,deepClone(l.extra)),e}static async rollDices(l,e){if(!l.roll){let t=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration,a;switch(l.source.type){case"liturgy":case"spell":case"ceremony":case"ritual":case"skill":a=await new Roll("1d20+1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(l.source.system.characteristic1.value)),mergeObject(a.dice[1].options,t(l.source.system.characteristic2.value)),mergeObject(a.dice[2].options,t(l.source.system.characteristic3.value));break;case"regenerate":let s=[];l.regenerateLeP&&s.push([game.settings.get("dsa5","lessRegeneration")?"1d3":"1d6"]),l.extra.actor.isMage&&l.regenerateAsP&&s.push("1d6"),l.extra.actor.isPriest&&l.regenerateKaP&&s.push("1d6"),a=await new Roll(s.join("+")).evaluate({async:!0}),l.regenerateLeP&&mergeObject(a.dice[0].options,t("mu")),l.extra.actor.isMage&&l.regenerateAsP&&mergeObject(a.dice[s.length-1].options,t("ge")),l.extra.actor.isPriest&&l.regenerateKaP&&mergeObject(a.dice[s.length-1].options,t("in")),l.extra.actor.isMage&&l.regenerateAsP&&l.extra.actor.isPriest&&l.regenerateKaP&&mergeObject(a.dice[s.length-2].options,t("ge"));break;case"meleeweapon":case"rangeweapon":case"weaponless":case"combatskill":case"trait":if(l.mode=="damage"){let o=await this.damageFormula(l);a=await new Roll(o).evaluate({async:!0});for(let c=0;c<a.dice.length;c++)mergeObject(a.dice[c].options,t("damage"))}else a=await new Roll("1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(l.mode));break;case"dodge":a=await new Roll("1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t("dodge"));break;case"poison":case"disease":let i=t("in");a=await new Roll("1d20+1d20+1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,i),mergeObject(a.dice[1].options,i),mergeObject(a.dice[2].options,i);break;case"fallingDamage":let r=await this._situationalModifiers(l),n=`${l.fallingHeight}d6+${r}-${l.extra.options.availableQs||0}`;a=await new Roll(n).evaluate({async:!0});break;default:a=await new Roll("1d20").evaluate({async:!0}),mergeObject(a.dice[0].options,t(l.source.system.attr))}a=await _DiceDSA5.manualRolls(a,l.source.type,l.extra.options),await this.showDiceSoNice(a,e.rollMode),l.roll=a,l.rollMode=e.rollMode}return l}static async setupDialog({dialogOptions:l,testData:e,cardOptions:t}){let a=await game.settings.get("core","rollMode"),s="challenging";typeof e.source.toObject=="function"&&(e.source=e.source.toObject(!1)),mergeObject(e,{testDifficulty:s}),mergeObject(l.data,{testDifficulty:s,testModifier:l.data.modifier||0});let i=l.data.situationalModifiers||(e.extra.actor?I.getRollModifiers(e.extra.actor,e.source):[]);e.extra.options.moreModifiers!=null&&i.push(...e.extra.options.moreModifiers);let r=[];if(game.user.targets.forEach(n=>{n.actor&&r.push({name:n.actor.name,id:n.id,img:n.actor.img})}),mergeObject(l.data,{hasSituationalModifiers:i.length>0,situationalModifiers:i,rollMode:l.data.rollMode||a,rollModes:CONFIG.Dice.rollModes,defenseCount:await this.getDefenseCount(e),targets:r}),mergeObject(t,{user:game.user.id}),e.extra.options.bypass)return t.rollMode=e.extra.options.rollMode||a,e.situationalModifiers||(e.situationalModifiers=[]),{testData:e,cardOptions:t};{let n=X.getDialogForItem(e,l.data),o=await renderTemplate(l.template,l.data);return new Promise((c,m)=>{new n({title:l.title,content:o,buttons:n.getRollButtons(e,l,c,m),default:"rollButton"}).recallSettings(e.extra.speaker,e.source,e.mode,l.data).render(!0)})}}static async getDefenseCount(l){return game.combat?await game.combat.getDefenseCount(l.extra.speaker):0}static async _rollConfirm(){return await new Roll("1d20").evaluate({async:!0})}static async _rollSingleD20(l,e,t,a,s,i="",r=1){let n="",o=[];e+=a,e=Math.round(e*r);let c=e-l.terms[0].results[0].result,m=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration(t);o.push({char:t,res:l.terms[0].results[0].result,suc:c>=0,tar:e});let d=c>=0?1:-1,u=20,p=1;if(s.source.type=="meleeweapon"&&(u=Math.min(s.extra.actor.system.meleeStats.botch,s.source.system.botch),p=Math.max(s.extra.actor.system.meleeStats.crit,s.source.system.crit)),s.source.type=="rangeweapon"&&(u=Math.min(s.extra.actor.system.rangeStats.botch,s.source.system.botch),p=Math.max(s.extra.actor.system.rangeStats.crit,s.source.system.crit)),/(\(|,)( )?i\)$/.test(s.source.name)&&(N.hasAbility(s.extra.actor,game.i18n.localize("LocalizedIDs.improvisedWeaponMaster"))||(u=Math.min(19,u)),this._appendSituationalModifiers(s,`${game.i18n.localize("CHAR.ATTACK")} - ${game.i18n.localize("WEAPON.improvised")}`,2,"defenseMalus")),s.situationalModifiers.find(f=>f.name==game.i18n.localize("opportunityAttack")&&f.value!=0)&&(u=50,p=-50),l.terms[0].results.filter(f=>f.result<=p).length==1)if(n=game.i18n.localize("CriticalSuccess"),game.settings.get("dsa5","noConfirmationRoll"))d=3;else{let f=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"confirmationRoll",s.extra.options),h=e-f.terms[0].results[0].result;if(O.hasVantage(s.extra.actor,`${game.i18n.localize("LocalizedIDs.weaponAptitude")} (${i})`)&&!(h>=0)){let w=f.terms[0].results[0].result;f=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"LocalizedIDs.weaponAptitude",s.extra.options),h=e-f.terms[0].results[0].result,n+=", "+game.i18n.format("usedWeaponExpertise",{a:w,b:f.terms[0].results[0].result})}this._addRollDiceSoNice(s,f,m),o.push({char:t,res:f.terms[0].results[0].result,suc:h>=0,tar:e}),d=h>=0?3:2}else if(l.terms[0].results.filter(f=>f.result>=u).length==1)if(n=game.i18n.localize("CriticalFailure"),game.settings.get("dsa5","noConfirmationRoll"))d=-3;else{let f=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"confirmationRoll",s.extra.options),h=e-f.terms[0].results[0].result;if(O.hasVantage(s.extra.actor,`${game.i18n.localize("LocalizedIDs.weaponAptitude")} (${i})`)&&!(h>=0)){let w=f.terms[0].results[0].result;f=await _DiceDSA5.manualRolls(await _DiceDSA5._rollConfirm(),"LocalizedIDs.weaponAptitude",s.extra.options),h=e-f.terms[0].results[0].result,n+=", "+game.i18n.format("usedWeaponExpertise",{a:w,b:f.terms[0].results[0].result})}this._addRollDiceSoNice(s,f,m),o.push({char:t,res:f.terms[0].results[0].result,suc:h>=0,tar:e}),d=h>=0?-2:-3}return n==""?n=game.i18n.localize(c>=0?"Success":"Failure"):game.settings.get("dsa5","noConfirmationRoll")||(Math.abs(d)==3?n=`${game.i18n.localize("confirmed")} ${n}`:Math.abs(d)==2&&(n=`${game.i18n.localize("unconfirmed")} ${n}`)),{successLevel:d,characteristics:o,description:n,preData:s,modifiers:a,extra:{}}}static async rollFallingDamage(l){let e=l.roll,t=[];for(let s of e.terms[0].results)t.push({char:"damage",res:s.result,suc:!1});return{rollType:"fallingDamage",preData:l,modifiers:await this._situationalModifiers(l),extra:{},damage:Math.max(0,e.total),formula:e.formula,characteristics:t}}static async rollRegeneration(l){let e=await this._situationalModifiers(l),t=l.roll,a=[],s={rollType:"regenerate",preData:l,modifiers:e,extra:{}},i=[];l.regenerateLeP&&i.push("LeP"),l.extra.actor.system.isMage&&l.regenerateAsP&&i.push("AsP"),l.extra.actor.system.isPriest&&l.regenerateKaP&&i.push("KaP");let r=0;if(l.extra.actor.effects.some(o=>o.statuses.includes("sick"))){this._appendSituationalModifiers(l,game.i18n.localize("CONDITION.sick"),"*0");for(let o of i)a.push({char:o,res:0,die:"d6"}),s[o]=0,r+=2}else for(let o of i)this._appendSituationalModifiers(l,game.i18n.localize(`LocalizedIDs.regeneration${o}`),O.vantageStep(l.extra.actor,game.i18n.localize(`LocalizedIDs.regeneration${o}`)),o),this._appendSituationalModifiers(l,game.i18n.localize(`LocalizedIDs.weakRegeneration${o}`),O.vantageStep(l.extra.actor,game.i18n.localize(`LocalizedIDs.weakRegeneration${o}`))*-1,o),this._appendSituationalModifiers(l,game.i18n.localize(`LocalizedIDs.advancedRegeneration${o}`),N.abilityStep(l.extra.actor,game.i18n.localize(`LocalizedIDs.advancedRegeneration${o}`)),o),this._appendSituationalModifiers(l,`${game.i18n.localize(`CHARAbbrev.${o}`)} ${game.i18n.localize("Modifier")}`,l[`${o}Modifier`],o),this._appendSituationalModifiers(l,`${game.i18n.localize(`CHARAbbrev.${o}`)} ${game.i18n.localize("regenerate")}`,l[`regeneration${o}`],o),a.push({char:o,res:t.terms[r].results[0].result,die:"d6"}),s[o]=Math.round(Math.max(0,Number(t.terms[r].results[0].result)+Number(e)+await this._situationalModifiers(l,o))*Number(l.regenerationFactor)),r+=2;return s.characteristics=a,s}static async rollStatus(l){let e=l.roll||await new Roll("1d20").evaluate({async:!0}),t=await this._rollSingleD20(e,l.source.system.max,l.extra.statusId,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l));t.rollType="dodge";let a=l.extra.statusId=="dodge";return a&&t.successLevel==3?await W.tableEnabledFor("criticalMeleeDefense")?t.description+=W.rollCritBotchButton("criticalMeleeDefense",!1,l,l):t.description+=W.defaultParryCrit():a&&t.successLevel==-3&&(await W.tableEnabledFor("Defense")?t.description+=W.rollCritBotchButton("Defense",!0,l,l):t.description+=await W.defaultBotch()),t}static async rollAttribute(l){let e=l.roll?l.roll:await new Roll("1d20").evaluate({async:!0});this._appendSituationalModifiers(l,game.i18n.localize("Difficulty"),l.testDifficulty);let t=await this._rollSingleD20(e,l.source.system.value,l.extra.characteristicId,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l));return t.rollType="attribute",t}static async damageFormula(l){let e;if(l.source.type=="meleeweapon"){let t=T._calculateCombatSkillValues(l.extra.actor.items.find(a=>a.type=="combatskill"&&a.name==l.source.system.combatskill.value),l.extra.actor.system);e=T._prepareMeleeWeapon(l.source,[t],l.extra.actor)}else if(l.source.type=="rangeweapon"){let t=T._calculateCombatSkillValues(l.extra.actor.items.find(a=>a.type=="combatskill"&&a.name==l.source.system.combatskill.value),l.extra.actor.system);e=T._prepareRangeWeapon(l.source,[],[t],l.extra.actor)}else e=l.source.system;return l.source.system.damage.value.replace(/[Ww]/g,"d")+`+${e.extraDamage||0}`}static async rollDamage(l){let e=await this._situationalModifiers(l),t=[],a=l.roll,s=a.total+e;for(let i of a.terms)if(i instanceof Die||i.class=="Die")for(let r of i.results)t.push({char:l.mode,res:r.result,die:"d"+i.faces});return{rollType:"damage",damage:s,characteristics:t,preData:l,modifiers:e,extra:{}}}static async _situationalModifiers(l,e=""){let t=0;for(let a of l.situationalModifiers){if(a.value==null)continue;let s=Number(a.value)||await this._stringToRoll(a.value);t+=a.type==e||e==""&&a.type==null?s:0}return t}static _situationalPartCheckModifiers(l){return l.situationalModifiers.reduce(function(e,t){if(t.type=="TPM"){let a=t.value.split("|");return a.length!=3||(e[0]=e[0]+Number(a[0]),e[1]=e[1]+Number(a[1]),e[2]=e[2]+Number(a[2])),e}else return e},[0,0,0])}static _situationalMultipliers(l){return l.situationalModifiers.reduce(function(e,t){return e*(t.type=="*"&&Number(`${t.value}`.replace(/,/,"."))||1)},1)}static _appendSituationalModifiers(l,e,t,a=""){let s=l.situationalModifiers.find(i=>i.name==e);s?s.value=t:l.situationalModifiers.push({name:e,value:t,type:a})}static async rollCombatTrait(l){let e=l.roll||await new Roll("1d20").evaluate({async:!0}),t=l.source,a=t.system.traitType.value=="meleeAttack",s=l.mode=="attack";if(a){let o={system:{combatskill:{value:"-"},reach:{value:t.system.reach.value}}};this._appendSituationalModifiers(l,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(o,l))}let i=await this._rollSingleD20(e,Number(s?t.system.at.value:t.system.pa),l.mode,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l)),r=i.successLevel>0;await this.detailedWeaponResult(i,l,t),s&&r&&await _DiceDSA5.evaluateDamage(l,i,t,!a,i.doubleDamage),i.rollType="weapon";let n=_DiceDSA5.parseEffect(t);return n&&(i.parsedEffect=n),i}static async _stringToRoll(l,e){let t=[],a=/\d{1}[dDwW]\d/g,s=`${l}`;s.replace(a,function(n){t.push(new Roll(n.replace(/[Ww]/,"d")).evaluate({async:!0}))});let i=await Promise.all(t),r=s.replace(a,()=>{let n=i.shift();return e&&_DiceDSA5._addRollDiceSoNice(e,n,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),n.total});return await Roll.safeEval(r)}static async evaluateDamage(l,e,t,a,s){let i=t.system.damage.value.replace(/[Ww]/g,"d"),r=[],n=t.dmgMultipliers||[],o=n.map(h=>`${h.name} *${h.val}`),c=[],m=0;for(let h of l.situationalModifiers){let w=0;if(h.armorPen&&c.push(h.armorPen),h.damageBonus){if(/^\*/.test(h.damageBonus)){n.push({name:h.name,val:Number(h.damageBonus.replace("*",""))});continue}let z=/^=/.test(h.damageBonus),v=`${h.damageBonus}`.replace(/^=/,""),L=await _DiceDSA5._stringToRoll(v,l);if(w=L*(h.step||1),z){i=v.replace(/[Ww]/,"d"),r.push({name:h.name,roll:L});continue}else h.damageBonus=L,m+=w}}let d=l.damageRoll?l.damageRoll:await _DiceDSA5.manualRolls(await new Roll(i).evaluate({async:!0}),"CHAR.DAMAGE",l.extra.options),u=d.total,p=0;for(let h of d.terms)if(h instanceof Die||h.class=="Die")for(let w of h.results)p+=Number(w.result),e.characteristics.push({char:"damage",res:w.result,die:"d"+h.faces});let f=u-p;if(r.length>0)o.push(r[0].name+" "+u);else{u+=m,o.push(game.i18n.localize("Roll")+" "+p),f!=0&&o.push(game.i18n.localize("weaponModifier")+" "+f),l.situationalModifiers.reduce((z,v)=>{if(v.damageBonus){let L=/^\*/.test(v.damageBonus)?v.damageBonus:Number(v.damageBonus)*(v.step||1);o.push(`${v.name} ${L}`)}},o),l.situationalModifiers.find(z=>z.name.indexOf(game.i18n.localize("CONDITION.bloodrush"))>-1)&&(u+=2,o.push(game.i18n.localize("CONDITION.bloodrush")+" "+2)),t.extraDamage&&(u=Number(t.extraDamage)+Number(u),o.push(game.i18n.localize("damageThreshold")+" "+t.extraDamage));let h=l.extra.actor.system[a?"rangeStats":"meleeStats"].damage,w=await _DiceDSA5._stringToRoll(h,l);w!=0&&(u+=w,o.push(game.i18n.localize("statuseffects")+" "+w))}s&&(u=u*s,o.push(game.i18n.format("doubleDamage",{x:s})));for(let h of n)u=u*h.val;e.armorPen=c,e.damagedescription=o.join(", "),e.damage=Math.round(u),e.damageRoll=duplicate(d)}static async rollWeapon(l){let e=l.roll||await new Roll("1d20").evaluate({async:!0}),t,a=l.source,s=a.system.combatskill.value,i=T._calculateCombatSkillValues(l.extra.actor.items.find(c=>c.type=="combatskill"&&c.name==s),l.extra.actor.system),r=a.type=="meleeweapon";r?(t=T._prepareMeleeWeapon(a,[i],l.extra.actor),l.mode=="attack"&&this._appendSituationalModifiers(l,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(t,l))):t=T._prepareRangeWeapon(a,[],[i],l.extra.actor);let n=await this._rollSingleD20(e,t[l.mode],l.mode,await this._situationalModifiers(l),l,s,this._situationalMultipliers(l));await this.detailedWeaponResult(n,l,a),l.mode=="attack"&&n.successLevel>0&&!l.extra.counterAttack&&await _DiceDSA5.evaluateDamage(l,n,t,!r,n.doubleDamage),l.extra.counterAttack&&(g.getSpeaker(l.extra.speaker).addCondition("stunned"),n.description+=", "+g.replaceConditions(game.i18n.localize("stunnedByCounterAttack"))),n.rollType="weapon";let o=_DiceDSA5.parseEffect(t);return o&&(n.parsedEffect=o),n}static async detailedWeaponResult(l,e,t){let a=e.mode=="attack"&&!e.extra.counterAttack,s=t.type=="meleeweapon"||getProperty(t,"system.traitType.value")=="meleeAttack";switch(l.successLevel){case 3:a?(await W.tableEnabledFor("criticalAttack")?l.description+=W.rollCritBotchButton("criticalAttack",!1,e):(l.description+=W.defaultAttackCrit(!0),l.doubleDamage=2),l.halfDefense=!0):e.isRangeDefense&&await W.tableEnabledFor("criticalRangeDefense")?l.description+=W.rollCritBotchButton("criticalRangeDefense",!1,e):await W.tableEnabledFor("criticalMeleeDefense")?l.description+=W.rollCritBotchButton("criticalMeleeDefense",!1,e):l.description+=W.defaultParryCrit();break;case-3:let i=getProperty(t,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle")||t.type=="trait";a&&s&&await W.tableEnabledFor("Melee")?l.description+=W.rollCritBotchButton("Melee",i,e):a&&await W.tableEnabledFor("Range")?l.description+=W.rollCritBotchButton("Range",!1,e):!a&&await W.tableEnabledFor("Defense")?l.description+=W.rollCritBotchButton("Defense",i,e):l.description+=await W.defaultBotch();break;case 2:a&&(l.description+=W.defaultAttackCrit(!1),l.halfDefense=!0);break;case-2:break}}static async _addRollDiceSoNice(l,e,t){if(l.rollMode){for(let a=0;a<e.dice.length;a++)mergeObject(e.dice[a].options,t);await this.showDiceSoNice(e,l.rollMode)}}static async rollCombatskill(l){let e=l.roll?l.roll:await new Roll("1d20").evaluate({async:!0}),t=T._calculateCombatSkillValues(l.source,l.extra.actor.system),a=await this._rollSingleD20(e,t.system[l.mode].value,l.mode,await this._situationalModifiers(l),l,"",this._situationalMultipliers(l));return await this.detailedWeaponResult(a,l,t),a.rollType="combatskill",a}static async manualRolls(l,e="",t={}){if(t.cheat||game.settings.get("dsa5","allowPhysicalDice"))if(t.predefinedResult)l.editRollAtIndex(t.predefinedResult);else{let a=!1,s,i=[];for(let n of l.terms)if(n instanceof Die||n.class=="Die")for(let o of n.results)i.push({faces:n.faces,val:o.result});let r=await renderTemplate("systems/dsa5/templates/dialog/manualroll-dialog.html",{dice:i,description:e});if([a,s]=await new Promise((n,o)=>{new X({title:game.i18n.localize(t.cheat?"DIALOG.cheat":"DSASETTINGS.allowPhysicalDice"),content:r,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:c=>{n([!0,c])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{n([!1,0])}}}}).render(!0)}),a){let n=[];s.find(".dieInput").each(function(o){let c=Number($(this).val());c>0&&n.push({val:c,index:o}),o++}),l.editRollAtIndex(n)}}return l}static parseEffect(l){let e=l.system.effect?l.system.effect.value:void 0,t=[];if(e){let s=/^[a-z]+\|[öäüÖÄÜa-zA-z ]+$/;for(let i of e.split(";"))if(s.test(i.trim())){let r=i.split("|").map(n=>n.trim());if(r[0]=="condition"){let n=CONFIG.statusEffects.find(o=>o.id==r[1]);t.push(`<a class="chat-condition chatButton" data-id="${n.id}">
                            <img src="${n.icon}"/>${game.i18n.localize(n.name)}
                            </a>`)}else t.push(`<a class="roll-button roll-item" data-name="${r[1]}" data-type="${r[0]}"><i class="fas fa-dice"></i>${game.i18n.localize(r[0])}: ${r[1]}</a>`)}}let a=getProperty(l,"flags.dsa5.poison");return a&&t.push(`<a class="roll-button roll-item" data-removecharge="${!a.permanent}" data-name="${a.name}" data-type="poison"><i class="fas fa-dice"></i>${game.i18n.localize("poison")}: ${a.name}</a>`),t.join(", ")}static async calculateEnergyCost(l,e,t){let a=[],s,i,r,n;if(e.successLevel<0){let o=["traditionWitch","traditionFjarning","braniborian"].map(m=>game.i18n.localize(`LocalizedIDs.${m}`)),c=t.extra.actor.items.some(m=>m.type=="specialability"&&o.includes(m.name))?3:2;e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.finalcost/c)}if(l?(n="KaPCost",s=game.i18n.localize("LocalizedIDs.weakKarmicBody"),i=game.i18n.localize(`LocalizedIDs.${e.successLevel>0?"mightyKarmaControl":"karmaControl"}`),r={val:"kapModifier",name:"KaP"}):(n="AsPCost",s=game.i18n.localize("LocalizedIDs.weakAstralBody"),i=game.i18n.localize(`LocalizedIDs.${e.successLevel>0?"energyControl":"smallEnergyControl"}`),r={val:"aspModifier",name:"AsP"}),a.push({name:s,value:O.vantageStep(t.extra.actor,s)},{name:i,value:N.abilityStep(t.extra.actor,i)*-1},{name:`${game.i18n.localize("statuseffects")} (${game.i18n.localize("CHARAbbrev."+r.name)})`,value:t.extra.actor.system[r.val]+await this._situationalModifiers(t,n)}),a=a.filter(o=>o.value!=0),e.preData.calculatedSpellModifiers.description=a.map(o=>`${o.name} ${o.value}`).join(`
`),e.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(e.preData.calculatedSpellModifiers.finalcost)+a.reduce((o,c)=>o+c.value,0)),e.successLevel>0&&e.preData.calculatedSpellModifiers.maintainCost!=0){let o=e.preData.calculatedSpellModifiers.maintainCost.split(" ");o[0]=Math.round(Number(o[0])),e.preData.calculatedSpellModifiers.finalcost+=o[0],e.preData.calculatedSpellModifiers.maintainCost=o.join(" ")}}static async rollSpell(l){let e=await this._rollThreeD20(l),t=["ceremony","liturgy"].includes(l.source.type);if(e.rollType=l.source.type,e.preData.calculatedSpellModifiers.finalcost=e.preData.calculatedSpellModifiers.cost,e.successLevel>=2){let a=(await new Roll("1d6").evaluate({async:!0})).total;e.description=e.description+", "+game.i18n.localize("additionalFPs")+" "+a,e.result+=a,e.qualityStep=Math.min(game.settings.get("dsa5","capQSat"),Math.ceil(e.result/3)),e.preData.calculatedSpellModifiers.finalcost=Math.round(e.preData.calculatedSpellModifiers.cost/2)}else e.successLevel<=-2&&(e.description+=W.rollCritBotchButton(t?"Liturgy":"Spell",!1,l));if(e.successLevel>0&&l.source.system.effectFormula.value!=""){let a=l.source.system.effectFormula.value.replace(game.i18n.localize("CHARAbbrev.QS"),e.qualityStep).replace(/[Ww]/g,"d"),s=[];for(let o of l.situationalModifiers)o.armorPen&&s.push(o.armorPen);/(,|;)/.test(a)&&(a=a.split(/[,;]/)[e.qualityStep-1]);let i=l.damageRoll?l.damageRoll:await _DiceDSA5.manualRolls(await new Roll(a).evaluate({async:!0}),"CHAR.DAMAGE",l.extra.options);this._addRollDiceSoNice(l,i,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),e.calculatedEffectFormula=a;for(let o of i.terms)if(o instanceof Die||o.class=="Die")for(let c of o.results)e.characteristics.push({char:"effect",res:c.result,die:"d"+o.faces});let r=[],n=await _DiceDSA5._stringToRoll(l.extra.actor.system[t?"liturgyStats":"spellStats"].damage,l);n!=0&&r.push(game.i18n.localize("statuseffects")+" "+n),e.armorPen=s,e.damageRoll=i,e.damage=i.total+n,e.damagedescription=r.join(`
`)}await this.calculateEnergyCost(t,e,l);for(let a of["minorFairies","minorSpirits"]){let s=game.i18n.localize("CONDITION."+a);O.hasVantage(l.extra.actor,s)&&!l.extra.actor.effects.find(i=>i.name==s)&&(await new Roll("1d20").evaluate({async:!0})).total<=e.preData.calculatedSpellModifiers.finalcost&&(e.description+=", "+game.i18n.format("minorghostsappear",{creature:s}),g.getSpeaker(l.extra.speaker).addCondition(a))}return e}static async _rollThreeD20(l){let e=l.roll?Roll.fromData(l.roll):await new Roll("1d20+1d20+1d20").evaluate({async:!0}),t=[],a=0;this._appendSituationalModifiers(l,game.i18n.localize("Difficulty"),l.testDifficulty);let s=await this._situationalModifiers(l),i=l.source.system.talentValue.value+l.advancedModifiers.fws+await this._situationalModifiers(l,"FW"),r=this._situationalPartCheckModifiers(l,"TPM"),n=[1,2,3].map(p=>l.extra.actor.system.characteristics[l.source.system[`characteristic${p}`].value].value+s+l.advancedModifiers.chars[p-1]+r[p-1]),o=[0,1,2].map(p=>e.terms[p*2].results[0].result-n[p]);if(l.routine)i=Math.round(i/2);else for(let p of o)p>0&&(i-=p);let c=l.extra.actor.system.skillModifiers.crit,m=l.extra.actor.system.skillModifiers.botch;if(["spell","ritual"].includes(l.source.type)&&O.hasVantage(l.extra.actor,game.i18n.localize("LocalizedIDs.wildMagic"))&&(m=19),l.source.type=="skill"&&O.hasVantage(l.extra.actor,`${game.i18n.localize("LocalizedIDs.incompetent")} (${l.source.name})`)){let p=await new Roll("1d20").evaluate({async:!0}),f=o.reduce((w,z,v,L)=>z<L[w]?v:w,0),h=e.terms[f*2].total;i+=Math.max(o[f],0),i-=Math.max(0,p.total-n[f]),e.editRollAtIndex([{index:f,val:p.total}]),this._addRollDiceSoNice(l,p,e.terms[f*2].options),t.push(game.i18n.format("CHATNOTIFICATION.unableReroll",{die:f+1,oldVal:h,newVal:p.total}))}let d=0;l.source.type=="skill"&&le.hasTrait(l.extra.actor,`${game.i18n.localize("LocalizedIDs.automaticSuccess")} (${l.source.name})`)?(t.push(game.i18n.localize("LocalizedIDs.automaticSuccess")),a=1,d=1):l.source.type=="skill"&&le.hasTrait(l.extra.actor,`${game.i18n.localize("LocalizedIDs.automaticFail")} (${l.source.name})`)?(t.push(game.i18n.localize("LocalizedIDs.automaticFail")),a=-1):(a=_DiceDSA5.get3D20SuccessLevel(e,i,m,c),l.routine&&(a=1),t.push(_DiceDSA5.getSuccessDescription(a))),t=t.join(", ");let u=0;return a>0&&(i+=await this._situationalModifiers(l,"FP"),u=Math.max(1,(i==0?1:i>0?Math.ceil(i/3):0)+(l.qualityStep!=null?Number(l.qualityStep):0))+(l.advancedModifiers.qls||0)+await this._situationalModifiers(l,"QL")),u=Math.min(game.settings.get("dsa5","capQSat"),u),u<d&&(u=d),{result:i,characteristics:[0,1,2].map(p=>({char:l.source.system[`characteristic${p+1}`].value,res:e.terms[p*2].results[0].result,suc:o[p]<=0,tar:n[p]})),qualityStep:u,description:t,preData:l,successLevel:a,modifiers:s,extra:{}}}static async rollTalent(l){let e=await this._rollThreeD20(l);return e.rollType="talent",e}static get3D20SuccessLevel(l,e,t=20,a=1){let s=l.terms.filter(r=>r.results&&r.results[0].result<=a).length,i=l.terms.filter(r=>r.results&&r.results[0].result>=t).length;return s>=2?s:i>=2?i*-1:e>=0?1:-1}static getSuccessDescription(l){return game.i18n.localize(["AstoundingFailure","CriticalFailure","Failure","","Success","CriticalSuccess","AstoundingSuccess"][l+3])}static async rollItem(l){let e=l.roll||await new Roll("1d20+1d20+1d20").evaluate({async:!0}),t=[],a=await this._situationalModifiers(l),s=Number(l.source.system.step.value),i=[1,2,3].map(m=>10+Number(l.source.system.step.value)+a),r=[0,1,2].map(m=>e.terms[m*2].results[0].result-i[m]);for(let m of r)m>0&&(s-=m);let n=20,o=_DiceDSA5.get3D20SuccessLevel(e,s,n);t.push(_DiceDSA5.getSuccessDescription(o)),t=t.join(", ");let c={result:s,characteristics:[0,1,2].map(m=>({char:l.source.type,res:e.terms[m*2].results[0].result,suc:r[m]<=0,tar:i[m]})),qualityStep:Math.min(game.settings.get("dsa5","capQSat"),(s==0?1:s>0?Math.ceil(s/3):0)+(l.qualityStep!=null?Number(l.qualityStep):0)),description:t,preData:l,successLevel:o,modifiers:a,extra:{}};switch(l.source.type){case"poison":let m=l.source.system.duration.value.split(" / ").map(f=>f.trim()),d=l.source.system.effect.value.split(" / ").map(f=>f.trim());c.duration=m.length>1?c.successLevel>0?m[0]:m[1]:m[0],c.effect=d.length>1?c.successLevel>0?d[0]:d[1]:d[0];break;case"disease":let u=l.source.system.damage.value.split(" / ").map(f=>f.trim()),p=l.source.system.duration.value.split(" / ").map(f=>f.trim());c.damageeffect=u.length>1?c.successLevel>0?u[0]:u[1]:u[0],c.duration=p.length>1?c.successLevel>0?p[0]:p[1]:p[0];break}return c}static async updateDefenseCount(l){game.combat&&await game.combat.updateDefenseCount(l.extra.speaker)}static _compareWeaponReach(l,e){let t=e.situationalModifiers.find(i=>i.name==game.i18n.localize("LocalizedIDs.circumvent")),a=y.meleeRangesArray.indexOf(l.system.reach.value),s=y.meleeRangesArray.indexOf(e.opposingWeaponSize);return t&&s>a&&(t.value=Math.min(t.step,s-a)*2),Math.min(0,a-s)*2}static async showDiceSoNice(l,e){if(g.moduleEnabled("dice-so-nice")&&game.dice3d){let t=null,a=!1;switch(e){case"blindroll":a=!0,t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"gmroll":t=game.users.filter(i=>i.isGM).map(i=>i.id);break;case"selfroll":t=[];break}let s=game.dice3d.showForRoll(l,game.user,!0,t,a);game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")||await s}}static addApplyEffectData(l){let e=l.preData.source;if(l.successLevel>0){if(["meleeweapon","rangeweapon"].includes(e.type)||e.type=="trait"&&["rangeAttack","meleeAttack"].includes(e.system.traitType.value)){if(e.effects.some(a=>!getProperty(a,"flags.dsa5.applyToOwner")))return!0}else if(["spell","liturgy","ritual","ceremony","trait","skill"].includes(e.type)&&e.effects.length>0)return!0}else if(["disease","poison"].includes(e.type))return e.effects.length>0;let t=l.preData.situationalModifiers.filter(a=>a.specAbId).map(a=>a.specAbId);if(t.length>0){let a=l.preData.extra.actor.items.filter(s=>t.includes(s._id));for(let s of a)if(s.effects.length>0)return!0}return!1}static async renderRollCard(chatOptions,testData,rerenderMessage){let applyEffect=this.addApplyEffectData(testData),immuneTo=M.checkImmunity(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:preData.mode=="attack";await Ve.postRoll({testData,preData}),Hooks.call("postProcessDSARoll",chatOptions,testData,rerenderMessage,hideDamage),await g.callAsyncHooks("postProcessDSARoll",[testData]),delete preData.extra.actor,delete testData.actor,delete testData.preData;let hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsa5.config.areaTargetTypes,chatData={title:chatOptions.title,immuneTo,testData,hideData:game.user.isGM,preData,hideDamage,modifierList:preData.situationalModifiers.filter(l=>l.value!=0),applyEffect,hasAreaTemplate,showDamageToGear:await q.showDamageToGear(preData,testData)};if(preData.advancedModifiers&&(preData.advancedModifiers.chars.some(l=>l!=0)&&chatData.modifierList.push({name:game.i18n.localize("MODS.partChecks"),value:preData.advancedModifiers.chars}),preData.advancedModifiers.fws!=0&&chatData.modifierList.push({name:game.i18n.localize("MODS.FW"),value:preData.advancedModifiers.fws}),preData.advancedModifiers.qls!=0&&chatData.modifierList.push({name:game.i18n.localize("MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter(l=>l.isGM).map(l=>l.id)),chatOptions.rollMode==="blindroll"?chatOptions.blind=!0:chatOptions.rollMode==="selfroll"&&(chatOptions.whisper=[game.user.id]),U.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSARoll:!0},rerenderMessage){let postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction");postFunction&&(testData.messageId=rerenderMessage.id,await eval(postFunction.functionName)(postFunction,{result:testData,chatData},preData.source));let html=await renderTemplate(chatOptions.template,chatData),actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{},enriched=await TextEditor.enrichHTML(html,{rollData,async:!0});chatOptions.content=enriched;let newMsg=await rerenderMessage.update({content:chatOptions.content,["flags.data"]:chatOptions["flags.data"]});return ui.chat.updateMessage(newMsg),newMsg}else return chatOptions.content=await renderTemplate(chatOptions.template,chatData),await ChatMessage.create(chatOptions,!1)}static async _itemRoll(l){let e=$(l.currentTarget),t=e.parents(".message").attr("data-message-id"),a=game.messages.get(t),s=a.speaker,i=e.attr("data-type"),r=e.attr("data-name"),n=g.getSpeaker(s);if(n){let o=n.items.find(c=>c.name==r&&c.type==i);if(o){let c=new S(o.toObject(),{temporary:!0}),m=e.attr("data-removecharge")?e.attr("data-removecharge")=="true":!1;if(m&&c.system.quantity.value<1){ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));return}c.setupEffect().then(async d=>{await c.itemTest(d),m&&await o.update({"system.quantity.value":o.system.quantity.value-1})})}else ui.notifications.error(game.i18n.format("DSAError.notFound",{category:i,name:r}))}}static async _rollEdit(l){let e=$(l.currentTarget),t=e.parents(".message").attr("data-message-id"),a=game.messages.get(t),s=a.flags.data,i=s.preData;i.extra.actor=g.getSpeaker(i.extra.speaker).toObject(!1),i.extra.options.cheat&&delete i.extra.options.cheat;let r;switch(e.attr("data-edit-type")){case"roll":r=e.attr("data-edit-id");let o=Number(e.val());if(i.roll.terms.length>r*2){let m=Roll.fromData(i.roll);m.editRollAtIndex([{index:r,val:o}]),i.roll=m}else{let m=Roll.fromData(s.postData.damageRoll);r=r-i.roll.terms.filter(d=>d.results).length,m.editRollAtIndex([{index:r,val:o}]),i.damageRoll=m}break;case"mod":r=i.situationalModifiers.findIndex(m=>m.name==game.i18n.localize("chatEdit")),r>0&&i.situationalModifiers.splice(r,1);let c={name:game.i18n.localize("chatEdit"),value:Number(e.val())-await this._situationalModifiers(i)};i.situationalModifiers.push(c);break}let n={template:s.template,rollMode:s.rollMode,title:s.title,speaker:a.speaker,user:a.user.id};["gmroll","blindroll"].includes(n.rollMode)&&(n.whisper=game.users.filter(o=>o.isGM).map(o=>o.id)),n.rollMode==="blindroll"&&(n.blind=!0),["poison","disease"].includes(i.source.type)?new S(i.source,{temporary:!0})[`${s.postData.postFunction}`]({testData:i,cardOptions:n},{rerenderMessage:a}):g.getSpeaker(a.speaker)[`${s.postData.postFunction}`]({testData:i,cardOptions:n},{rerenderMessage:a})}static async gearDamaged(l){let e=l.currentTarget.dataset.uuid.split(";");if(e.length>1){let t=await Promise.all(e.map(a=>fromUuid(a)));Ke.showDialog(t)}else q.breakingTest(await fromUuid(e[0]))}static async rollResistPain(l){let e=l.currentTarget.dataset,t={token:e.token,actor:e.actor,scene:canvas.id},a=g.getSpeaker(t);a&&a.finishResistPainRoll()}static async wrapLock(l,e){let t=$(l.currentTarget);t.hasClass("locked")||(t.addClass("locked"),t.prepend('<i class="fas fa-spinner fa-spin"></i>'),await e(l,t),setTimeout(()=>{t.removeClass("locked"),t.find("i").remove()},2e3))}static async chatListeners(l){l.on("click",".expand-mods",e=>{e.preventDefault();let t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()}),l.on("click",".edit-toggle",e=>{e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()}),l.on("click",".botch-roll",e=>W.showBotchCard(e.currentTarget.dataset)),l.on("click",".roll-item",e=>_DiceDSA5._itemRoll(e)),l.on("click",".gearDamaged",async e=>_DiceDSA5.gearDamaged(e)),l.on("click",".applyDamage",async e=>mt($(e.currentTarget).closest(".message"),e.currentTarget.dataset.mode)),l.on("change",".roll-edit",e=>_DiceDSA5._rollEdit(e)),l.on("click",".applyEffect",async e=>{_DiceDSA5.wrapLock(e,async(t,a)=>{let s=a.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await _DSAActiveEffectConfig.applyEffect(s,i)})}),l.on("click",".applyTableEffect",async e=>{_DiceDSA5.wrapLock(e,async(t,a)=>{let s=a.parents(".message").attr("data-message-id"),i=t.currentTarget.dataset.target;await Ye.applyEffect(s,i)})}),l.on("click",".placeTemplate",async e=>dt.placeTemplateFromChat(e)),l.on("click",".message-delete",e=>{let t=game.messages.get($(e.currentTarget).parents(".message").attr("data-message-id"));if(!t.flags.unopposeData)return;let s=canvas.tokens.get(t.flags.unopposeData.targetSpeaker.token);F.clearOpposed(s.actor)}),l.on("click",".resistEffect",e=>_DSAActiveEffectConfig.resistEffect(e)),l.on("click",".resistPain",e=>_DiceDSA5.rollResistPain(e)),G.chatListeners(l)}};var T=class extends Actor{static async create(e,t){if(e instanceof Array||e.items)return await super.create(e,t);(!e.img||e.img=="icons/svg/mystery-man.svg")&&(e.img="icons/svg/mystery-man-black.svg");let a=await g.allSkills()||[],s=await g.allCombatSkills()||[],i=await g.allMoneyItems()||[];return e.items=[...a,...s,...i],e.type!="character"&&(e.system={status:{fatePoints:{current:0,value:0}}}),e.type!="creature"&&[void 0,0].includes(getProperty(e,"system.status.wounds.value"))&&mergeObject(e,{system:{status:{wounds:{value:16}}}}),await super.create(e,t)}_getArmorCompensation(e,t,a){let s=N.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance")),i=t.reduce((r,n)=>r+=Number(n.system.encumbrance.value),0);if(s>i){let r=[game.i18n.localize("CHARAbbrev.GS"),game.i18n.localize("CHARAbbrev.INI")];for(let n of r)!a[n]||(a[n]=a[n].filter(o=>o.type!="armor"))}}_getItemModifiers(){let e=[],t={};for(let a of this.items.filter(s=>["meleeweapon","rangeweapon","armor","equipment"].includes(s.type)&&getProperty(s,"system.worn.value")||["advantage","specialability","disadvantage"].includes(s.type)))this._buildGearAndAbilityModifiers(t,a),a.type=="armor"&&e.push(a);this._getArmorCompensation(this,e,t),this._applyModiferTransformations(t)}prepareDerivedData(){var t,a,s,i;let e=this.system;try{this._getItemModifiers();for(let h of Object.values(e.characteristics))h.value=h.initial+h.advances+(h.modifier||0)+h.gearmodifier;e.totalWeight=0;let r=[],n=game.i18n.localize("LocalizedIDs.familiar"),o=game.i18n.localize("LocalizedIDs.companion"),c=new Map,m=this.items.filter(h=>h.type=="equipment"&&h.system.equipmentType.value=="bags");for(let h of m)c.set(h.id,[]);for(let h of this.items)if(y.equipmentCategories.has(h.type)){let w=getProperty(h,"system.parent_id");if(w&&w!=h._id&&c.has(w)){c.get(w).push(h);continue}h.type=="armor"?(h.system.preparedWeight=parseFloat((h.system.weight.value*h.system.quantity.value).toFixed(3)),e.totalWeight+=parseFloat((h.system.weight.value*(h.system.worn.value?Math.max(0,h.system.quantity.value-1):h.system.quantity.value)).toFixed(3)),h.system.worn.value&&r.push(h)):(h.system.preparedWeight=parseFloat((h.system.weight.value*h.system.quantity.value).toFixed(3)),e.totalWeight+=Number(h.system.preparedWeight))}else switch(h.type){case"trait":h.name==n&&(e.isFamiliar=!0),h.name==o&&(e.isPet=!0);break;case"spell":case"ritual":case"magictrick":e.isMage=!0;break;case"liturgy":case"ceremony":case"blessing":e.isPriest=!0;break;case"specialability":y.sortedSpecs.magical.has(h.system.category.value)?e.isMage=!0:y.sortedSpecs.clerical.has(h.system.category.value)&&(e.isPriest=!0);break}e.isMage||(e.isMage=e.isFamiliar);for(let h of m){let w=getProperty(h,"system.parent_id");(!w||!c.has(w))&&(e.totalWeight+=this._calcBagweight(h,c,!0))}e.canAdvance=this.isOwner&&(this.type=="character"||e.isFamiliar||e.isPet),this.canAdvance=e.canAdvance,e.carrycapacity=e.characteristics.kk.value*2+e.carryModifier,e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent,e.details.experience.description=g.experienceDescription(e.details.experience.total)),(this.type=="character"||this.type=="npc")&&(e.status.wounds.current=e.status.wounds.initial+e.characteristics.ko.value*2,e.status.soulpower.value=(e.status.soulpower.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/6),e.status.toughness.value=(e.status.toughness.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/6),e.status.wounds.min=-1*e.characteristics.ko.value),e.status.fatePoints.max=Number(e.status.fatePoints.current)+Number(e.status.fatePoints.modifier)+e.status.fatePoints.gearmodifier,this.type=="creature"&&(e.status.wounds.current=e.status.wounds.initial,e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial),e.status.wounds.max=Math.round((e.status.wounds.current+e.status.wounds.modifier+e.status.wounds.advances)*e.status.wounds.multiplier+e.status.wounds.gearmodifier),e.status.regeneration.LePmax=e.status.regeneration.LePTemp+e.status.regeneration.LePMod+e.status.regeneration.LePgearmodifier,e.status.regeneration.KaPmax=e.status.regeneration.KaPTemp+e.status.regeneration.KaPMod+e.status.regeneration.KaPgearmodifier,e.status.regeneration.AsPmax=e.status.regeneration.AsPTemp+e.status.regeneration.AsPMod+e.status.regeneration.AsPgearmodifier;let d=e.guidevalue;(t=e.status.astralenergy).rebuy||(t.rebuy=0),(a=e.status.karmaenergy).rebuy||(a.rebuy=0),(s=e.status.astralenergy).permanentLoss||(s.permanentLoss=0),(i=e.status.karmaenergy).permanentLoss||(i.permanentLoss=0),e.status.astralenergy.permanentLossSum=e.status.astralenergy.permanentLoss-e.status.astralenergy.rebuy+e.status.astralenergy.permanentGear,e.status.karmaenergy.permanentLossSum=e.status.karmaenergy.permanentLoss-e.status.karmaenergy.rebuy+e.status.karmaenergy.permanentGear,(e.isFamiliar||d&&this.type!="creature")&&(e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial,e.characteristics[d.magical]&&(e.status.astralenergy.current+=Math.round(e.characteristics[d.magical].value*e.energyfactor.magical)),e.characteristics[d.clerical]&&(e.status.karmaenergy.current+=Math.round(e.characteristics[d.clerical].value*e.energyfactor.clerical))),e.status.astralenergy.max=e.status.astralenergy.current+e.status.astralenergy.modifier+e.status.astralenergy.advances+e.status.astralenergy.gearmodifier-e.status.astralenergy.permanentLossSum,e.status.karmaenergy.max=e.status.karmaenergy.current+e.status.karmaenergy.modifier+e.status.karmaenergy.advances+e.status.karmaenergy.gearmodifier-e.status.karmaenergy.permanentLossSum,e.status.soulpower.max=e.status.soulpower.value+e.status.soulpower.modifier+e.status.soulpower.gearmodifier,e.status.toughness.max=e.status.toughness.value+e.status.toughness.modifier+e.status.toughness.gearmodifier,e.status.dodge.value=Math.round(e.characteristics.ge.value/2)+e.status.dodge.gearmodifier;let u=this.calcEncumbrance(e),p=H.isRiding(this)?H.getHorse(this):void 0;this.calcInitiative(e,u,p),e.status.dodge.max=Number(e.status.dodge.value)+Number(e.status.dodge.modifier)+Number(game.settings.get("dsa5","higherDefense"))/2,e.armorEncumbrance=this.getArmorEncumbrance(this,r),this.prepareSwarm(e),this.effectivePain(e);let f=this.statuses.has("fixated");this.calcSpeed(e,f,p),f&&(e.status.dodge.max=Math.max(0,e.status.dodge.max-4))}catch(r){console.error(`Something went wrong with preparing actor data ${this.name}: `+r+r.stack),ui.notifications.error(game.i18n.format("DSAError.PreparationError",{name:this.name})+r+r.stack)}}static async deferredEffectAddition(e,t,a){let i=(t.effects.find(n=>n.statuses.has(e))?.flags.dsa5.auto||0)!=a,r=`changing${e}`;t[r]=i,i&&await t.addCondition(e,a,!0).then(()=>t[r]=void 0)}static async postUpdateConditions(e){if(g.isActiveGM()){let t=e.system,a=e.isMerchant();if(!le.hasTrait(e,game.i18n.localize("LocalizedIDs.painImmunity"))){let r=e.woundPain(t);await this.deferredEffectAddition("inpain",e,r)}let s=t.armorEncumbrance;(e.type!="creature"||e.canAdvance)&&!a&&(s+=Math.max(0,Math.ceil((t.totalWeight-t.carrycapacity-4)/4))),await this.deferredEffectAddition("encumbered",e,s);let i=e.woundPain(t,"temporaryLeP");await this.deferredEffectAddition("stunned",e,i),O.hasVantage(e,game.i18n.localize("LocalizedIDs.blind"))&&await e.addCondition("blind"),O.hasVantage(e,game.i18n.localize("LocalizedIDs.mute"))&&await e.addCondition("mute"),O.hasVantage(e,game.i18n.localize("LocalizedIDs.deaf"))&&await e.addCondition("deaf"),a&&await e.prepareMerchant()}}static async _onCreateDocuments(e,t){for(let a of e)await T.postUpdateConditions(a);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)await T.postUpdateConditions(a);return super._onUpdateDocuments(e,t)}prepareSwarm(e){let t=Number(e.swarm.count)||1;if(t<2)return;e.swarm.maxwounds=e.status.wounds.max,e.status.wounds.max*=t;let a=Math.min(Math.ceil(e.status.wounds.value/e.swarm.maxwounds),t),s=Number(e.swarm.gg)||1;e.swarm.attack+=Math.min(10,Math.floor(a/s)),e.swarm.parry+=-1,e.swarm.effectiveCount=a,e.swarm.damage=Math.min(5,Math.floor(a/s))}effectivePain(e){let t=e.condition.inpain||0;t<4&&(t-=O.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedFighter"))+O.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedAnimal"))+(N.hasAbility(this,game.i18n.localize("LocalizedIDs.traditionKor"))?1:0)),t>0&&(t+=O.vantageStep(this,game.i18n.localize("LocalizedIDs.sensitiveToPain"))+O.vantageStep(this,game.i18n.localize("LocalizedIDs.fragileAnimal"))),t=Math.clamped(t,0,4),e.condition.inpain=t}woundPain(e,t="wounds"){let a=0;return e.status[t].max>0&&(this.type!="creature"||e.status[t].max>=20?(a=Math.floor((1-e.status[t].value/e.status[t].max)*4),e.status[t].value<=5&&(a=4)):a=Math.floor(5-5*e.status[t].value/e.status[t].max)),Math.clamped(a,0,4)}calcSpeed(e,t,a){if(a){if(e.status.speed.max=a.system.status.speed.max,!e.status.speed.max){let s=a.system;a.calcSpeed(s,a.hasCondition("fixated"))}e.status.speed.max=a.system.status.speed.max}else{e.status.speed.max=e.status.speed.initial+(e.status.speed.modifier||0)+(e.status.speed.gearmodifier||0),e.status.speed.max=Math.round(Math.max(0,e.status.speed.max-Math.min(4,this.calcEncumbrance(e)))*e.status.speed.multiplier),this.hasCondition("bloodrush")||(e.status.speed.max=Math.max(0,e.status.speed.max-(e.condition?.inpain||0)));let s=this.hasCondition("paralysed");s&&(e.status.speed.max=Math.round(e.status.speed.max*(1-s.flags.dsa5.value*.25))),t||this.hasCondition("rooted")||this.hasCondition("incapacitated")?e.status.speed.max=0:this.hasCondition("prone")&&(e.status.speed.max=Math.min(1,e.status.speed.max)),H.updateRiderSpeed(this,e.status.speed.max)}}calcEncumbrance(e){return Math.clamped(e.condition?.encumbered||0,0,4)}calcInitiative(e,t,a){if(this.type=="character"||this.type=="npc"?e.status.initiative.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.status.initiative.modifier||0):e.status.initiative.value=e.status.initiative.current+(e.status.initiative.modifier||0),a){if(e.status.initiative.value=a.system.status.initiative.value,!e.status.initiative.value){let s=a.system;a.calcInitiative(s,a.calcEncumbrance(s)),e.status.initiative.value=s.status.initiative.value}}else{e.status.initiative.value+=(e.status.initiative.gearmodifier||0)-Math.min(4,t);let s=Number((.01*e.status.initiative.value).toFixed(2));e.status.initiative.value*=e.status.initiative.multiplier||1,e.status.initiative.value=Math.round(e.status.initiative.value)+s}}get creatureType(){return M.creatureTypeName(this)}async prepareMerchant(){if(getProperty(this,"system.merchant.merchantType")=="loot"){if(getProperty(this,"system.merchant.locked")&&!this.hasCondition("locked"))await this.addCondition(T.lockedCondition());else if(!getProperty(this,"system.merchant.locked")){let e=this.effects.find(t=>t.statuses.has("locked"));e&&await this.deleteEmbeddedDocuments("ActiveEffect",[e.id])}}}static lockedCondition(){return{id:"locked",name:game.i18n.localize("MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{dsa5:{noEffect:!0,hidePlayers:!0,description:game.i18n.localize("MERCHANT.locked")}}}}applyActiveEffects(){let e={};this.statuses??(this.statuses=new Set);let t=new Map;for(let o of Object.values(CONFIG.specialStatusEffects))t.set(o,this.statuses.has(o));this.statuses.clear();let a=[],s=1;for(let o of this.effects){if(o.disabled)continue;s=1;let c=o.getFlag("dsa5","value");c&&(s=Number(c));for(let m=0;m<s;m++)a.push(...o.changes.map(d=>(d=foundry.utils.duplicate(d),d.effect=o,d.priority=d.priority?d.priority:d.mode*10,d)));for(let m of o.statuses)this.statuses.add(m)}let i=!0,r=this.items.filter(o=>["rangeweapon","meleeweapon","equipment","armor"].includes(o.type)&&o.system.isArtifact&&(o.system.worn.value||o.type=="equipment"&&!o.system.worn.wearable)).map(o=>o.system.artifact);this.dsatriggers={6:{},7:{}};for(let o of this.items)for(let c of o.effects)if(!c.disabled){switch(i=!0,o.type){case"meleeweapon":case"rangeweapon":i=o.system.worn.value&&c.getFlag("dsa5","applyToOwner");break;case"armor":i=o.system.worn.value;break;case"equipment":i=!o.system.worn.wearable||o.system.worn.wearable&&o.system.worn.value;break;case"trait":i=!["meleeAttack","rangeAttack"].includes(o.system.traitType.value)||c.getFlag("dsa5","applyToOwner"),s=Number(getProperty(o.system,"step.value"))||1;break;case"ammunition":case"plant":case"consumable":case"combatskill":case"magicsign":case"poison":case"spell":case"liturgy":case"ceremony":case"ritual":case"skill":case"spellextension":i=!1;break;case"specialability":switch(o.system.category.value){case"Combat":i=[2,3].includes(Number(o.system.category.sub));break;case"staff":i=o.system.permanentEffects||r.includes(o.system.artifact);break;default:i=!0}s=Number(o.system.step.value)||1;let m=getProperty(c,"flags.dsa5.advancedFunction");this.dsatriggers.hasOwnProperty(m)&&(this.dsatriggers[m][o.id]=c.id);break;case"advantage":case"disadvantage":s=Number(o.system.step.value)||1;break}if(c.notApplicable=!i,!!i){for(let m=0;m<s;m++)a.push(...c.changes.map(d=>(d=foundry.utils.duplicate(d),d.effect=c,d.priority=d.priority?d.priority:d.mode*10,d)));for(let m of c.statuses)this.statuses.add(m)}}a.sort((o,c)=>o.priority-c.priority);for(let o of a){if(!o.key)continue;let c=o.effect.apply(this,o);Object.assign(e,c)}this.overrides=foundry.utils.expandObject(e);let n;for(let[o,c]of t){let m=this.statuses.has(o);if(m!==c){n??(n=this.getActiveTokens());for(let d of n)d._onApplyStatusEffect(o,m)}}}_setOnUseEffect(e){getProperty(e,"flags.dsa5.onUseEffect")&&(e.OnUseEffect=!0)}_setAEPayments(e){if(e.OnUseEffect)return;Number(getProperty(e,"system.AsPCost"))&&(e.AEpayable=!0)}prepareBaseData(){let e=this.system;mergeObject(e,{itemModifiers:{},condition:{},swarm:{attack:0,parry:0,damage:0},creatureType:this.creatureType,skillModifiers:{FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AsPCost:[],KaPCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],KaPCost:[],AsPCost:[]},...["liturgy","ceremony","ritual","spell","skill"].reduce((t,a)=>(t[a]={FP:[],step:[],QL:[],TPM:[],FW:[]},t),{})},status:{initiative:{multiplier:1},astralenergy:{permanentGear:0},karmaenergy:{permanentGear:0},wounds:{multiplier:1},speed:{multiplier:1},regeneration:{LePgearmodifier:0,KaPgearmodifier:0,AsPgearmodifier:0}},repeatingEffects:{startOfRound:{wounds:[],karmaenergy:[],astralenergy:[]}},temperature:{heatProtection:0,coldProtection:0},totalArmor:0,spellArmor:0,liturgyArmor:0,carryModifier:0,aspModifier:0,kapModifier:0,immunities:[],creatureBonus:[],miracle:{attack:0,parry:0},spellStats:{damage:"0"},liturgyStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1}});for(let t of y.gearModifyableCalculatedAttributes)e.status[t]&&(e.status[t].gearmodifier=0);for(let t of Object.values(e.characteristics))t.gearmodifier=0}getSkillModifier(e,t){let a=[],s=["FP","step","QL","TPM","FW"];for(let i of s){let r=i=="step"?"":i;a.push(...this.system.skillModifiers[i].filter(n=>n.target==e).map(n=>({name:n.source,value:n.value,type:r}))),this.system.skillModifiers[t]&&a.push(...this.system.skillModifiers[t][i].map(n=>({name:n.source,value:n.value,type:r})))}return a}prepareSheet(e){let t={system:{characteristics:{}}};if(mergeObject(t,this.prepareItems(e)),t.canAdvance){let a=["wounds","astralenergy","karmaenergy"];for(let s of a)mergeObject(t.system,{status:{[s]:{cost:game.i18n.format("advancementCost",{cost:g._calculateAdvCost(this.system.status[s].advances,"D")}),refund:game.i18n.format("refundCost",{cost:g._calculateAdvCost(this.system.status[s].advances,"D",0)})}}});for(let[s,i]of Object.entries(this.system.characteristics))t.system.characteristics[s]={cost:game.i18n.format("advancementCost",{cost:g._calculateAdvCost(i.initial+i.advances,"E")}),refund:game.i18n.format("refundCost",{cost:g._calculateAdvCost(i.initial+i.advances,"E",0)})}}return t}static canAdvance(e){return e.canAdvance}static armorValue(e,t={}){let a=e.items.filter(r=>r.type=="armor"&&r.system.worn.value==!0);t.origin&&(a=a.map(r=>{let n=mergeObject(duplicate(t),{armor:r});return _DSAActiveEffectConfig.applyRollTransformation(e,n,4).options.armor}));let s=a.reduce((r,n)=>r+q.armorWearModifier(n,n.system.protection.value),0),i=e.items.filter(r=>r.type=="trait"&&r.system.traitType.value=="armor").reduce((r,n)=>r+Number(n.system.at.value),0);return{wornArmor:a,armor:s+i+(e.system.totalArmor||0)}}static _calculateCombatSkillValues(e,t){if(e.system.weapontype.value=="melee"){let a=e.system.guidevalue.value.split("/").map(r=>Number(t.characteristics[r].initial)+Number(t.characteristics[r].modifier)+Number(t.characteristics[r].advances)+Number(t.characteristics[r].gearmodifier)),s=Math.max(...a);e.system.parry.value=Math.ceil(e.system.talentValue.value/2)+Math.max(0,Math.floor((s-8)/3))+Number(game.settings.get("dsa5","higherDefense"));let i=t.characteristics.mu.initial+t.characteristics.mu.modifier+t.characteristics.mu.advances+t.characteristics.mu.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((i-8)/3))}else{e.system.parry.value=0;let a=t.characteristics.ff.initial+t.characteristics.ff.modifier+t.characteristics.ff.advances+t.characteristics.ff.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((a-8)/3))}return e.cost=game.i18n.format("advancementCost",{cost:g._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e}_perpareItemAdvancementCost(e){return e.cost=game.i18n.format("advancementCost",{cost:g._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e.refund=game.i18n.format("refundCost",{cost:g._calculateAdvCost(e.system.talentValue.value,e.system.StF.value,0)}),e}async modifyTokenAttribute(e,t,a=!1,s=!0){let i=foundry.utils.getProperty(this.system,e),r;return s?(a&&(t=Math.clamped(i.min||0,Number(i.value)+t,i.max)),r={[`system.${e}.value`]:t}):(a&&(t=Number(i)+t),r={[`system.${e}`]:t}),Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:a,isBar:s},r)!==!1?this.update(r):this}schipshtml(){let e=[];for(let t=1;t<=Number(this.system.status.fatePoints.max);t++)e.push({value:t,cssClass:t<=Number(this.system.status.fatePoints.value)?"fullSchip":"emptySchip"});return e}prepareItems(e){let t=this.toObject(!1),a=[],s=[],i=[],r=[],n=[],o=[],c=[],m=[],d=[],u=[],p=Object.fromEntries(Object.keys(y.specialAbilityCategories).map(k=>[k,[]])),f=Object.fromEntries(Object.keys(y.traitCategories).map(k=>[k,[]])),h=[],w=[],z=[],v=[],L={hasSpells:this.system.isMage,hasPrayers:this.system.isPriest,liturgy:[],spell:[],ritual:[],ceremony:[],blessing:[],magictrick:[],magicalsign:[]},D={spell:{},ritual:{},ceremony:{},liturgy:{}},x=this.hasPlayerOwner?_.getGroupSchips():[],E=this.schipshtml(),A={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},plant:{items:[],show:!1,dataType:"plant"},poison:{items:[],show:!1,dataType:"poison"}};for(let k in y.equipmentTypes)A[k]={items:[],show:!1,dataType:k};A.misc.show=!0;let b={coins:[],total:0,show:!0};t.items=t.items.sort((k,B)=>k.name.localeCompare(B.name));let P=t.system.totalArmor||0,Y={body:[],social:[],knowledge:[],trade:[],nature:[]},fe=new Map;for(let k of t.items.filter(B=>B.type=="equipment"&&B.system.equipmentType.value=="bags"))fe.set(k._id,[]);let he=new Map,Be=[],kt=!1,it=H.getHorse(this,!0);for(let k of t.items)try{let B=getProperty(k,"system.parent_id");if(k.type=="ammunition"&&Be.push(T._prepareitemStructure(k)),B&&B!=k._id&&fe.has(B)){fe.get(B).push(k);continue}switch(e.details&&e.details.includes(k._id)&&(k.detailed="shown"),k.system.isArtifact&&(k.volume=y.traditionArtifacts[k.system.artifact]||0,k.volumeFinal=0,v.push(k)),k.type){case"skill":Y[k.system.group.value].push(this._perpareItemAdvancementCost(k));break;case"information":m.push(k);break;case"aggregatedTest":r.push(k);break;case"spellextension":D[k.system.category][k.system.source]?D[k.system.category][k.system.source].push(k.name):D[k.system.category][k.system.source]=[k.name];break;case"ritual":case"spell":case"liturgy":case"ceremony":L[k.type].push(T.buildSpellChargeProgress(this._perpareItemAdvancementCost(k)));break;case"magicalsign":case"magictrick":case"blessing":L[k.type].push(k);break;case"trait":switch(k.system.traitType.value){case"rangeAttack":k=T._prepareRangeTrait(k);break;case"meleeAttack":k=T._prepareMeleetrait(k);break;case"armor":P+=Number(k.system.at.value);break}f[k.system.traitType.value].push(k),kt=!0;break;case"combatskill":a.push(T._calculateCombatSkillValues(k,this.system));break;case"ammunition":A.ammunition.items.push(T.prepareMag(k)),A.ammunition.show=!0;break;case"meleeweapon":k.toggleValue=k.system.worn.value||!1,k.toggle=!0,this._setOnUseEffect(k),A.meleeweapons.items.push(T._prepareitemStructure(k)),A.meleeweapons.show=!0,k.toggleValue&&c.push(k);break;case"rangeweapon":k.toggleValue=k.system.worn.value||!1,k.toggle=!0,this._setOnUseEffect(k),A.rangeweapons.items.push(T._prepareitemStructure(k)),A.rangeweapons.show=!0;break;case"armor":k.toggleValue=k.system.worn.value||!1,A.armor.items.push(T._prepareitemStructure(k)),A.armor.show=!0,k.toggle=!0,this._setOnUseEffect(k),k.system.worn.value&&(k.system.protection.value=q.armorWearModifier(k,k.system.protection.value),P+=Number(k.system.protection.value),h.push(k));break;case"poison":case"plant":A[k.type].items.push(k),A[k.type].show=!0;break;case"consumable":A[k.system.equipmentType.value].items.push(T._prepareConsumable(k)),A[k.system.equipmentType.value].show=!0;break;case"equipment":k.toggle=getProperty(k,"system.worn.wearable")||!1,k.toggle&&(k.toggleValue=k.system.worn.value||!1),this._setOnUseEffect(k),A[k.system.equipmentType.value].items.push(T._prepareitemStructure(k)),A[k.system.equipmentType.value].show=!0;break;case"money":b.coins.push(k),b.total+=k.system.quantity.value*k.system.price.value;break;case"advantage":this._setOnUseEffect(k),s.push(k);break;case"disadvantage":this._setOnUseEffect(k),i.push(k);break;case"specialability":this._setOnUseEffect(k),this._setAEPayments(k),p[k.system.category.value].push(k);break;case"disease":n.push(k);break;case"patron":p.magical.push(k);break;case"demonmark":o.push(k);break;case"essence":d.push(k);break;case"imprint":u.push(k);break;case"application":he.has(k.system.skill)?he.get(k.system.skill).push(k):he.set(k.system.skill,[k]);break}}catch(B){this._itemPreparationError(k,B)}for(let k of A.bags.items)this._setBagContent(k,fe);for(let[k,B]of Object.entries(D))for(let[Te,Gt]of Object.entries(B)){let ei=L[k].find(xi=>xi.name==Te);ei?ei.extensions=Gt.join(", "):ui.notifications.warn(game.i18n.format("DSAError.noSpellForExtension",{name:Te,category:g.categoryLocalization(k),extension:Gt.join(",")}))}for(let k of A.rangeweapons.items)try{k.system.worn.value&&w.push(T._prepareRangeWeapon(k,Be,a,this))}catch(B){this._itemPreparationError(k,B)}for(let k of c)try{z.push(T._prepareMeleeWeapon(k,a,t,c.filter(B=>B._id!=k._id&&!_.isYieldedTwohanded(B))))}catch(B){this._itemPreparationError(k,B)}for(let k of Object.values(Y))for(let B of k)B.applications=he.get(B.name)||[];b.coins=b.coins.sort((k,B)=>k.system.price.value>B.system.price.value?-1:1),p.magical.push(...p.pact),p.clerical.push(...p.ceremonial);for(let k of p.staff){let B=v.find(Te=>Te.system.artifact==k.system.artifact);if(B){B.abilities==null&&(B.abilities=[]),B.abilities.push(k);let Te=Number(k.system.volume)||0,Gt=Te>0?"volumeFinal":"volume";B[Gt]+=Math.abs(Te)*Number(k.system.step.value)}else p.magical.push(k)}let qe=duplicate(y.characteristics);return qe["-"]="-",{totalWeight:parseFloat(this.system.totalWeight.toFixed(3)),traditionArtifacts:v,armorSum:P,sortedSpecs:y.sortedSpecs,spellArmor:t.system.spellArmor||0,liturgyArmor:t.system.liturgyArmor||0,money:b,encumbrance:this.system.condition?.encumbered||0,carrycapacity:this.system.carrycapacity,isSwarm:this.isSwarm(),canSwarm:!this.prototypeToken.actorLink,wornRangedWeapons:w,wornMeleeWeapons:z,horseActor:it,advantages:s,disadvantages:i,specAbs:p,information:m,aggregatedtests:r,wornArmor:h,essence:d,imprint:u,inventory:A,hasTrait:kt,demonmarks:o,diseases:n,canBuild:game.dsa5.sheets.DSACharBuilder&&!t.system.details.species?.value,itemModifiers:this.system.itemModifiers,languagePoints:{used:t.system.freeLanguagePoints?.used||0,available:t.system.freeLanguagePoints?.value||0},schips:E,groupschips:x,guidevalues:qe,magic:L,traits:f,combatskills:a,canAdvance:this.canAdvance,sheetLocked:t.system.sheetLocked.value,bodyAttrs:["ff","ge","ko","kk"],mentalAttrs:["mu","kl","in","ch"],allSkillsLeft:{body:Y.body,social:Y.social,nature:Y.nature},allSkillsRight:{knowledge:Y.knowledge,trade:Y.trade}}}isSwarm(){return this.system.swarm.count>1&&!this.prototypeToken.actorLink}getArmorEncumbrance(e,t){let a=t.reduce((i,r)=>(r.system.calculatedEncumbrance=Number(r.system.encumbrance.value)+q.armorEncumbranceModifier(r),r.system.damageToolTip=q.damageTooltip(r),i+=r.system.calculatedEncumbrance),0),s=H.isRiding(this)?-1:0;return Math.max(0,a-N.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance"))+s)}_calcBagweight(e,t,a=!0){let s=0;if(t.has(e._id)){let i=0;!e.system.worn.value&&a&&(s-=e.system.preparedWeight);for(let r of t.get(e._id))r.system.preparedWeight=Number(parseFloat((r.system.weight.value*r.system.quantity.value).toFixed(3))),t.has(r._id)?i+=this._calcBagweight(r,t,!1):i+=r.system.preparedWeight;a?e.system.worn.value&&(s+=i):s+=i+e.system.preparedWeight,e.system.bagweight=`${i.toFixed(3)}/${e.system.capacity}`}return s}_setBagContent(e,t){if(t.has(e._id)){e.children=[];for(let a of t.get(e._id))e.children.push(T._prepareitemStructure(T._prepareConsumable(a))),t.has(a._id)&&this._setBagContent(a,t)}}isMerchant(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}_itemPreparationError(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}_applyModiferTransformations(e){this.system.itemModifiers={};for(let t of Object.keys(e)){let a=game.dsa5.config.knownShortcuts[t.toLowerCase()];if(a){let s=e[t].reduce((i,r)=>i=i+r.value,0);this.system[a[0]][a[1]][a[2]]+=s,this.system.itemModifiers[t]={value:s,sources:e[t].map(i=>i.source)}}}}_buildGearAndAbilityModifiers(e,t){let a=getProperty(t,"system.effect.value");if(!!a)for(let s of a.split(/,|;/).map(i=>i.trim())){let i=s.replace(/(\s+)/g," ").trim().split(" ");if(i.length==2&&!isNaN(i[0])){let r={value:Number(i[0])*(t.system.step&&Number(t.system.step.value)||1),source:t.name,type:t.type};e[i[1]]==null?e[i[1]]=[r]:e[i[1]].push(r)}}}async _updateAPs(e,t={},a={}){if(T.canAdvance(this))if(!isNaN(e)&&e!=null){let s=Number(e);t["system.details.experience.spent"]=Number(this.system.details.experience.spent)+s,await this.update(t,a);let i=game.i18n.format(s>0?"advancementCost":"refundCost",{cost:Math.abs(s)});me(i)}else ui.notifications.error(game.i18n.localize("DSAError.APUpdateError"))}async checkEnoughXP(e){if(!T.canAdvance(this)||isNaN(e)||e==null||Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=e)return!0;if(Number(this.system.details.experience.total)==0){let t=await renderTemplate("systems/dsa5/templates/dialog/parts/expChoices.html",{entries:y.startXP}),a=0,s=!1;if([s,a]=await new Promise((i,r)=>{new Dialog({title:game.i18n.localize("DSAError.NotEnoughXP"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:n=>{i([!0,n.find(".APsel")[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{i([!1,0])}}}}).render(!0)}),s)return await this.update({"system.details.experience.total":Number(a)}),!0}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughXP")),!1}setupWeapon(e,t,a,s){return a.mode=t,S.getSubClass(e.type).setupDialog(null,a,e,this,s)}setupWeaponless(e,t={},a){let s=foundry.utils.duplicate(y.defaultWeapon);s.name=game.i18n.localize(`${e}Weaponless`),s.system.combatskill={value:game.i18n.localize("LocalizedIDs.wrestle")},s.system.damageThreshold.value=14;let i=[];return N.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyAstralBody"))&&i.push(game.i18n.localize("magical")),N.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyKarmalBody"))&&i.push(game.i18n.localize("blessed")),mergeObject(s,{system:{effect:{attributes:i.join(", ")}}}),t.mode=e,S.getSubClass(s.type).setupDialog(null,t,s,this,a)}setupSpell(e,t={},a){return S.getSubClass(e.type).setupDialog(null,t,e,this,a)}setupSkill(e,t={},a){return S.getSubClass(e.type).setupDialog(null,t,e,this,a)}tokenScrollingText(e){let t=this.isToken?[this.token?.object]:this.getActiveTokens(!0);for(let a of t){if(!a)continue;let s=0;for(let i of e)canvas.interface.createScrollingText(a.center,i.value,{anchor:s,direction:i.value>0?2:1,fontSize:game.settings.get("dsa5","scrollingFontsize"),stroke:i.stroke,strokeThickness:1,jitter:.25,duration:1e3}),s+=1}}async _preUpdate(e,t,a){await super._preUpdate(e,t,a);let s={wounds:9109504,astralenergy:723929,karmaenergy:303670};game.combat?.isBrawling&&(s.temporaryLeP=16525967);let i=[];for(let n of Object.keys(s)){let o=getProperty(e,`system.status.${n}.value`);o&&i.push({value:o-this.system.status[n].value,stroke:s[n]})}i.length&&this.tokenScrollingText(i);let r=getProperty(e,"system.swarm.count");if(r&&!t.skipSwarmUpdate){let n=getProperty(e,"system.status.wounds.value")||this.system.status.wounds.value,o=r-(this.system.swarm.count||1),c=this.system.swarm.maxwounds||this.system.status.wounds.max;setProperty(e,"system.status.wounds.value",Math.max(0,n+o*c))}}async applyDamage(e){if(game.combat?.isBrawling){let t=Math.min(this.system.status.temporaryLeP.max,this.system.status.temporaryLeP.value-e);await this.update({"system.status.temporaryLeP.value":t})}else{let t=Math.min(this.system.status.wounds.max,this.system.status.wounds.value-e);await this.update({"system.status.wounds.value":t})}}async applyRegeneration(e,t,a){let s={"system.status.wounds.value":Math.min(this.system.status.wounds.max,this.system.status.wounds.value+(e||0)),"system.status.karmaenergy.value":Math.min(this.system.status.karmaenergy.max,this.system.status.karmaenergy.value+(a||0)),"system.status.astralenergy.value":Math.min(this.system.status.astralenergy.max,this.system.status.astralenergy.value+(t||0))};await this.update(s)}async applyMana(e,t){let a=t=="AsP"?"astralenergy":"karmaenergy",s=Math.min(this.system.status[a].max,this.system.status[a].value-e);return s>=0?(await this.update({[`data.status.${a}.value`]:s}),!0):(ui.notifications.error(game.i18n.localize(`DSAError.NotEnough${t}`)),!1)}preparePostRollAction(e){let t=e.flags.data,a={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.user};return t.attackerMessage&&(a.attackerMessage=t.attackerMessage),t.defenderMessage&&(a.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(a.unopposedStartMessage=t.unopposedStartMessage),a}resetTargetAndMessage(e,t){e.originalTargets?.size&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}async fatererollDamage(e,t,a,s,i,r){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let n=i.postData.damageRoll,o=await _DiceDSA5.manualRolls(await new Roll(n.formula||n._formula).evaluate({async:!0}),"CHATCONTEXT.rerollDamage");for(let c=0;c<o.dice.length;c++)o.dice[c].options.colorset="black";await _DiceDSA5.showDiceSoNice(o,a.rollMode),ChatMessage.create(g.chatDataSetup(e)),a.damageRoll=duplicate(o),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointDamageRerollUsed":!0}),await this.reduceSchips(r)}async fateisTalented(e,t,a,s,i){t.talentedRerollUsed=!0,this.resetTargetAndMessage(i,t),e=`<h3 class="center"><b>${game.i18n.localize("CHATFATE.fatepointUsed")}</b></h3>
            ${game.i18n.format("CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"})}<br>`;let r=await renderTemplate("systems/dsa5/templates/dialog/isTalentedReroll-dialog.html",{testData:a,postData:i.postData});new X({title:game.i18n.localize("CHATFATE.selectDice"),content:r,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async n=>{let o=n.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(o.length>0){let c=[];for(let u of o){let p=a.roll.terms[u*2];c.push(p.number+"d"+p.faces+"["+p.options.colorset+"]")}c=await _DiceDSA5.manualRolls(await new Roll(c.join("+")).evaluate({async:!0}),"CHATCONTEXT.talentedReroll"),await _DiceDSA5.showDiceSoNice(c,a.rollMode);let m=0,d=[];for(let u of o){let p=a.source.system[`characteristic${u+1}`],f=p?game.i18n.localize(`CHARAbbrev.${p.value.toUpperCase()}`)+" - ":"";d.push(`${f}${a.roll.terms[u*2].results[0].result}/${c.terms[m*2].results[0].result}`),a.roll.terms[u*2].results[0].result=Math.min(c.terms[m*2].results[0].result,a.roll.terms[u*2].results[0].result),m+=1}e+=`<b>${game.i18n.localize("Roll")}</b>: ${d.join(", ")}`,ChatMessage.create(g.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.talentedRerollUsed":!0})}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}async fatereroll(e,t,a,s,i,r){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(i,t);let n=await renderTemplate("systems/dsa5/templates/dialog/fateReroll-dialog.html",{testData:a,postData:i.postData,singleDie:i.postData.characteristics.length==1});new X({title:game.i18n.localize("CHATFATE.selectDice"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async o=>{let c=o.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(c.length>0){let m=[];for(let w of c){let z=a.roll.terms[w*2];m.push(z.number+"d"+z.faces+"["+z.options.colorset+"]")}m=await _DiceDSA5.manualRolls(await new Roll(m.join("+")).evaluate({async:!0}),"CHATCONTEXT.Reroll"),await _DiceDSA5.showDiceSoNice(m,a.rollMode);let d=0,u=[],p=g.getSpeaker(a.extra.speaker),f=game.i18n.localize("LocalizedIDs.traditionPhex"),h=p.items.some(w=>w.type=="specialability"&&w.name==f);for(let w of c){let z=a.source.system[`characteristic${w+1}`],v=z?`${game.i18n.localize(`CHARAbbrev.${z.value.toUpperCase()}`)} - `:"";u.push(`${v}${a.roll.terms[w*2].results[0].result}/${m.terms[d*2].results[0].result}`),h?a.roll.terms[w*2].results[0].result=Math.min(m.terms[d*2].results[0].result,a.roll.terms[w*2].results[0].result):a.roll.terms[w*2].results[0].result=m.terms[d*2].results[0].result,d+=1}e+=`<br><b>${game.i18n.localize("Roll")}</b>: ${u.join(", ")}`,ChatMessage.create(g.chatDataSetup(e)),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointRerollUsed":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}async fateaddQS(e,t,a,s,i,r){ChatMessage.create(g.chatDataSetup(e)),game.user.targets.forEach(n=>n.setTarget(!1,{user:game.user,releaseOthers:!1,groupSelection:!0})),t.fatePointAddQSUsed=!0,a.qualityStep=1,this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fatePointAddQSUsed":!0}),await this.reduceSchips(r)}async fateImprove(e,t,a,s,i,r){ChatMessage.create(g.chatDataSetup(e)),this.resetTargetAndMessage(i,t);let n=s.flags.data.preData.source.type;if(["spell","liturgy","ceremony","ritual","skill"].includes(n)){let o=await renderTemplate("systems/dsa5/templates/dialog/fateImprove-dialog.html",{testData:a,postData:i.postData});new X({title:game.i18n.localize("CHATFATE.selectDice"),content:o,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async c=>{let m=[0,0,0],d=c.find(".dieSelected").map(function(){return Number($(this).attr("data-index"))}).get();if(d.length==1){m[d]=2;let u={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:m.join("|"),type:"roll"};a.roll.terms[d*2].results[0].result=Math.max(1,a.roll.terms[d*2].results[0].result-2),a.situationalModifiers.push(u),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fateImproved":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else{let o={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:2,type:"roll"};a.situationalModifiers.push(o),a.roll.terms[0].results[0].result=Math.max(1,a.roll.terms[0].results[0].result-2),this[`${i.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:s}),await s.update({"flags.data.fateImproved":!0}),await this.reduceSchips(r)}}async reduceSchips(e){e==0?await this.update({"system.status.fatePoints.value":this.system.status.fatePoints.value-1}):await T.reduceGroupSchip()}static async reduceGroupSchip(){if(game.user.isGM){let e=game.settings.get("dsa5","groupschips").split("/").map(t=>Number(t));e[0]=e[0]-1,await game.settings.set("dsa5","groupschips",e.join("/"))}else game.socket.emit("system.dsa5",{type:"reduceGroupSchip",payload:{}})}async useFateOnRoll(e,t,a){if(t=="isTalented"||g.fateAvailable(this,a==1)){let s=e.flags.data,i=this.preparePostRollAction(e),r,n;a==0?(r=this.system.status.fatePoints.value-1,n="PointsRemaining"):(r=game.settings.get("dsa5","groupschips").split("/")[0],n="GroupPointsRemaining");let o=`<h3 class="center"><b>${game.i18n.localize("CHATFATE.fatepointUsed")}</b></h3>
                ${game.i18n.format("CHATFATE."+t,{character:"<b>"+this.name+"</b>"})}<br>
                <b>${game.i18n.localize(`CHATFATE.${n}`)}</b>: ${r}`,c=s.preData;c.extra.actor=g.getSpeaker(c.extra.speaker).toObject(!1),this[`fate${t}`](o,i,c,e,s,a)}}get horseSpeed(){return H.getHorseSpeed(this)}setupFallingDamage(e,t){let a=game.i18n.localize("fallingDamage"),s=this.items.find(r=>r.type=="skill"&&r.name==game.i18n.localize("LocalizedIDs.bodyControl")).toObject(),i={subtitle:` (${a})`,postFunction:{functionName:"game.dsa5.entities.Actordsa5.updateFallingDamage",options:e,tokenId:t,speaker:S.buildSpeaker(this,t)}};this.setupSkill(s,i,t).then(async r=>{r.testData.opposable=!1;let n=await this.basicTest(r,{suppressMessage:!0});await T.updateFallingDamage(i.postFunction,n),await _DiceDSA5.renderRollCard(n.cardOptions,n.result,n.options.rerenderMessage)})}static async updateFallingDamage(e,t,a){let s=(t.result.qualityStep||0)*2;mergeObject(e.options,{availableQs:s});let i=g.getSpeaker(e.speaker),r=await i._setupFallingHeight(e.options,e.tokenId),n=await i.basicTest(r,{suppressMessage:!0}),o=await renderTemplate("systems/dsa5/templates/chat/roll/fallingdamage-card.html",n);t.result.other||(t.result.other=[]),t.result.other.push(o),t.chatData&&(t.chatData.other=[o])}_setupFallingHeight(e,t){let a=game.i18n.localize("fallingDamage"),s={source:{type:"fallingDamage"},opposable:!1,extra:{actor:this.toObject(!1),options:e,speaker:S.buildSpeaker(this,t)}},i=[],r={title:a,template:"/systems/dsa5/templates/dialog/fallingdamage-dialog.html",data:{rollMode:e.rollMode,situationalModifiers:i,fallingFloorOptions:y.fallingConditions,modifier:e.modifier||0},callback:(o,c={})=>(s.situationalModifiers=[],s.situationalModifiers.push({name:game.i18n.localize("fallingFloor"),value:o.find('[name="fallingFloor"]').val()}),n.rollMode=o.find('[name="rollMode"]').val(),s.fallingHeight=o.find('[name="testModifier"]').val(),mergeObject(s.extra.options,c),{testData:s,cardOptions:n})},n=this._setupCardOptions("systems/dsa5/templates/chat/roll/fallingdamage-card.html",a,t);return _DiceDSA5.setupDialog({dialogOptions:r,testData:s,cardOptions:n})}setupRegeneration(e,t={},a){let s=game.i18n.localize("regenerationTest"),i={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:t,speaker:S.buildSpeaker(this,a)}};i.extra.actor.isMage=this.system.isMage,i.extra.actor.isPriest=this.system.isPriest;let r=I.getRollModifiers(i.extra.actor,i.source),n={title:s,template:"/systems/dsa5/templates/dialog/regeneration-dialog.html",data:{rollMode:t.rollMode,regenerationInterruptOptions:y.regenerationInterruptOptions,regnerationCampLocations:y.regnerationCampLocations,showAspModifier:this.system.isMage,showKapModifier:this.system.isPriest,situationalModifiers:r,modifier:t.modifier||0},callback:(c,m={})=>{i.situationalModifiers=T._parseModifiers(c),o.rollMode=c.find('[name="rollMode"]').val(),i.situationalModifiers.push({name:game.i18n.localize("camplocation")+" - "+c.find('[name="regnerationCampLocations"] option:selected').text(),value:c.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("interruption")+" - "+c.find('[name="regenerationInterruptOptions"] option:selected').text(),value:c.find('[name="regenerationInterruptOptions"]').val()}),i.regenerationFactor=c.find('[name="badEnvironment"]').is(":checked")?.5:1;let d=["LeP","KaP","AsP"],u={};for(let p of d){i[`${p}Modifier`]=Number(c.find(`[name="${p}Modifier"]`).val()||0),i[`regeneration${p}`]=Number(this.system.status.regeneration[`${p}max`]);let f=c.find(`[name="regenerate${p}"]`).is(":checked")?1:0;i[`regenerate${p}`]=f,f&&(u[`system.status.regeneration.${p}Temp`]=0)}return mergeObject(i.extra.options,m),this.update(u),{testData:i,cardOptions:o}}},o=this._setupCardOptions("systems/dsa5/templates/chat/roll/regeneration-card.html",s,a);return _DiceDSA5.setupDialog({dialogOptions:n,testData:i,cardOptions:o})}setupDodge(e={},t){let a="dodge",s=this.system.status[a],i=game.i18n.localize(a)+" "+game.i18n.localize("Test"),r={source:{system:s,type:a},opposable:!1,extra:{statusId:a,actor:this.toObject(!1),options:e,speaker:S.buildSpeaker(this,t)}},n=[game.i18n.localize(a),game.i18n.localize("LocalizedIDs.wrestle")],o=S.buildCombatSpecAbs(this,["Combat"],n,"parry"),c=I.getRollModifiers(r.extra.actor,r.source),m=S.getDefenseMalus(c,this),d=_.multipleDefenseValue(this,r.source),u={title:i,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:{rollMode:e.rollMode,combatSpecAbs:o,showDefense:!0,situationalModifiers:c,isRangeAttack:m,defenseCountString:game.i18n.format("defenseCount",{malus:d}),isDodge:!0},callback:(f,h={})=>(p.rollMode=f.find('[name="rollMode"]').val(),r.situationalModifiers=T._parseModifiers(f),r.situationalModifiers.push(...S.getSpecAbModifiers(f,"parry")),r.situationalModifiers.push({name:game.i18n.localize("attackFromBehind"),value:f.find('[name="attackFromBehind"]').is(":checked")?-4:0},{name:game.i18n.format("defenseCount",{malus:d}),value:(Number(f.find('[name="defenseCount"]').val())||0)*d},{name:game.i18n.localize("advantageousPosition"),value:f.find('[name="advantageousPosition"]').is(":checked")?2:0}),mergeObject(r.extra.options,h),{testData:r,cardOptions:p})},p=this._setupCardOptions("systems/dsa5/templates/chat/roll/status-card.html",i,t);return _DiceDSA5.setupDialog({dialogOptions:u,testData:r,cardOptions:p})}setupCharacteristic(e,t={},a){let s=duplicate(this.system.characteristics[e]),i=g.attributeLocalization(e)+" "+game.i18n.localize("Test");s.attr=e;let r={opposable:!1,source:{type:"char",system:s},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:S.buildSpeaker(this,a)}},n={title:i,template:"/systems/dsa5/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,difficultyLabels:y.attributeDifficultyLabels,modifier:t.modifier||0},callback:(c,m={})=>(o.rollMode=c.find('[name="rollMode"]').val(),r.testDifficulty=y.attributeDifficultyModifiers[c.find('[name="testDifficulty"]').val()],r.situationalModifiers=T._parseModifiers(c),mergeObject(r.extra.options,m),{testData:r,cardOptions:o})},o=this._setupCardOptions("systems/dsa5/templates/chat/roll/characteristic-card.html",i,a);return _DiceDSA5.setupDialog({dialogOptions:n,testData:r,cardOptions:o})}static _parseModifiers(e,t){let a=[];return e.find('[name="situationalModifiers"] option:selected').each(function(){let s=$(this).val(),i={name:$(this).text().trim().split("[")[0],value:isNaN(s)?s:Number(s),type:$(this).attr("data-type")};i.type=="dmg"&&(i.damageBonus=i.value,i.value=0),$(this).attr("data-specAbId")&&(i.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(i.armorPen=$(this).attr("data-armorPen")),a.push(i)}),a.push({name:game.i18n.localize("manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),a}static _prepareConsumable(e){return e.system.maxCharges&&(e.consumable=!0,e.structureMax=e.system.maxCharges,e.structureCurrent=e.system.charges),e}static prepareMag(e){return e.system.ammunitiongroup.value=="mag"&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}static _prepareitemStructure(e){e.system.structure&&e.system.structure.max!=0&&(e.structureMax=e.system.structure.max,e.structureCurrent=e.system.structure.value);let t=getProperty(e,"flags.dsa5.enchantments");if(t&&t.length>0)e.enchantClass="rar";else if(e.effects.length>0)e.enchantClass="common";else if(e.system.effect&&e.system.effect.value!="")if(e.type=="armor")for(let a of e.system.effect.value.split(/,|;/).map(s=>s.trim())){let s=a.replace(/(\s+)/g," ").trim().split(" ");if(!(s.length==2&&[game.i18n.localize("CHARAbbrev.INI").toLowerCase(),game.i18n.localize("CHARAbbrev.GS").toLowerCase()].includes(s[1].toLowerCase())&&!isNaN(s[0])&&s[0]==-1)){e.enchantClass="common";break}}else e.enchantClass="common";return e}static _prepareMeleetrait(e){return e.attack=Number(e.system.at.value),e.system.pa!=0&&(e.parry=e.system.pa),this._parseDmg(e)}static _prepareMeleeWeapon(e,t,a,s=null){let i=t.find(r=>r.name==e.system.combatskill.value);if(i){e.attack=Number(i.system.attack.value)+Number(e.system.atmod.value);let r=e.system.guidevalue.value.split("/").map(c=>a.system.characteristics[c]?Number(a.system.characteristics[c].initial)+Number(a.system.characteristics[c].modifier)+Number(a.system.characteristics[c].advances)+Number(a.system.characteristics[c].gearmodifier):0),n=Math.ceil(i.system.talentValue.value/2)+Math.max(0,Math.floor((Math.max(...r)-8)/3))+Number(game.settings.get("dsa5","higherDefense"));e.parry=n+Number(e.system.pamod.value)+(_.isShield(e)?Number(e.system.pamod.value):0),e.yieldedTwoHand=_.isYieldedTwohanded(e),e.yieldedTwoHand||(s||(s=duplicate(a.items).filter(c=>c.type=="meleeweapon"&&c.system.worn.value&&c._id!=e._id&&!_.isYieldedTwohanded(c))),s.length>0&&(e.parry+=Math.max(...s.map(c=>c.system.pamod.offhandMod)),e.attack+=Math.max(...s.map(c=>c.system.atmod.offhandMod))));let o=0;if(e.system.worn.wrongGrip)if(e.yieldedTwoHand)e.parry-=1,o=1;else switch(e.system.reach.value="medium",game.i18n.localize(`LocalizedCTs.${e.system.combatskill.value}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":if(e.parry-=3,new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")).test(e.name))o=-2;else{let d=game.i18n.localize("wrongGrip.oneHanded");e.gripDamageText=` (${d} * 0.5)`,e.dmgMultipliers=[{name:d,val:"0.5"}]}break;default:e.parry-=1,o=-1}if(e=this._parseDmg(e),e.system.guidevalue.value!="-"){let c=Math.max(...e.system.guidevalue.value.split("/").map(d=>Number(a.system.characteristics[d].value))),m=Math.max(c-Number(e.system.damageThreshold.value),0)+o;m>0&&(e.extraDamage=m,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(m)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}q.weaponWearModifier(e),e.system.damageToolTip=q.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return e}async actorEffects(){let e=["dead"];return game.user.isGM||this.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects")?this.effects.filter(a=>a.isVisibleEffect()):this.effects.filter(a=>e.some(s=>a.statuses.has(s)))}async _preCreate(e,t,a){await super._preCreate(e,t,a);let s={};e.img||(s.img="icons/svg/mystery-man-black.svg"),e.type=="character"&&mergeObject(s,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(s)}static _prepareRangeTrait(e){return e.attack=Number(e.system.at.value),e.LZ=Number(e.system.reloadTime.value),e.LZ>0&&T.buildReloadProgress(e),this._parseDmg(e)}static calcLZ(e,t){let a=1,s=0;e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Throwing Weapons")?s=N.abilityStep(t,game.i18n.localize("LocalizedIDs.quickdraw"))*-1:e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Crossbows")&&N.hasAbility(t,`${game.i18n.localize("LocalizedIDs.quickload")} (${game.i18n.localize("LocalizedIDs.Crossbows")})`)?a=.5:s=N.abilityStep(t,`${game.i18n.localize("LocalizedIDs.quickload")} (${game.i18n.localize(e.system.combatskill.value)})`)*-1;let i=`${e.system.reloadTime.value}`.split("/");if(e.system.ammunitiongroup.value=="mag"){let r=t.items.find(o=>o.id==e.system.currentAmmo.value||o._id==e.system.currentAmmo.value),n=0;r&&(r=g.toObjectIfPossible(r),r.system.mag.value<=0&&(n=1)),i=i[n]||i[0]}else i=i[0];return Math.max(0,Math.round(Number(i)*a)+s)}static _parseDmg(e,t=void 0){let a=new Roll(e.system.damage.value.replace(/[Ww]/g,"d"),{async:!1}),s="",i="",r="+";for(let n of a.terms)n.faces?s=n.number+"d"+n.faces:n.operator?r=n.operator:n.number&&(i+=Number(`${r}${n.number}`));if(t){let n=getProperty(t,"system.damageMod");Number(n)?i+=`+${Number(n)}`:n&&(e.damageBonusDescription=`, ${n} ${game.i18n.localize("CHARAbbrev.damage")} ${t.name}`)}return i&&(i=Roll.safeEval(i)),e.damagedie=s||"0d6",e.damageAdd=i!=""?(Number(i)>=0?"+":"")+i:"",e}static buildReloadProgress(e){let t=e.system.reloadTime.progress/e.LZ;e.title=game.i18n.format("WEAPON.loading",{status:`${e.system.reloadTime.progress}/${e.LZ}`}),e.progress=`${e.system.reloadTime.progress}/${e.LZ}`,t>=1&&(e.title=game.i18n.localize("WEAPON.loaded")),this.progressTransformation(e,t)}static progressTransformation(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft=`${Math.round(t*360-179)}deg`):(e.transformRight=`${Math.round(t*360+1)}deg`,e.transformLeft=0)}static buildSpellChargeProgress(e){if(e.LZ=Number(e.system.castingTime.modified)||0,e.LZ>1){let t=e.system.castingTime.progress/e.LZ;e.title=game.i18n.format("SPELL.loading",{status:`${e.system.castingTime.progress}/${e.LZ}`}),e.progress=`${e.system.castingTime.progress}/${e.LZ}`,this.progressTransformation(e,t)}return e}static _prepareRangeWeapon(e,t,a,s){let i=a.find(n=>n.name==e.system.combatskill.value);e.calculatedRange=e.system.reach.value;let r;if(i){if(e.attack=Number(i.system.attack.value),e.system.ammunitiongroup.value!="-"&&(e.ammo=t.filter(n=>n.system.ammunitiongroup.value==e.system.ammunitiongroup.value),r=t.find(n=>n._id==e.system.currentAmmo.value),r)){let n=Number(r.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map(o=>Math.round(Number(o)*n)).join("/"),e.attack+=Number(r.system.atmod)||0,r.system.ammunitiongroup.value=="mag"&&(e.ammoMax=r.system.mag.max,e.ammoCurrent=r.system.mag.value)}e.LZ=T.calcLZ(e,s),e.LZ>0&&T.buildReloadProgress(e),q.weaponWearModifier(e),e.system.damageToolTip=q.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return this._parseDmg(e,r)}_setupCardOptions(e,t,a){let s=game.canvas?.tokens?.get(a),i={speaker:{alias:s?s.name:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{let r=ChatMessage.getSpeaker();r.actor==this.id&&(i.speaker.alias=r.alias,i.speaker.token=r.token,i.speaker.scene=r.scene,i.flags.img=r.token?canvas.tokens.get(r.token).img:i.flags.img)}return i}async swapMag(e){let t=this.items.get(e),a=this.items.get(t.system.currentAmmo.value);if(a&&a.system.quantity.value>1)return await this.updateEmbeddedDocuments("Item",[{_id:a.id,"system.quantity.value":a.system.quantity.value-1,"system.mag.value":a.system.mag.max}]),U.playEquipmentWearStatusChange(a),a;ui.notifications.error(game.i18n.localize("DSAError.NoAmmo"))}async payMiracles(e){if(!e.extra.miraclePaid){e.extra.miraclePaid=!0;let t=e.situationalModifiers.some(i=>i.name.trim()==game.i18n.localize("LocalizedIDs.miracleMight")),a=e.situationalModifiers.some(i=>i.name.trim()==game.i18n.localize("LocalizedIDs.miracle")),s=t?6:a?4:0;s&&await this.update({"system.status.karmaenergy.value":this.system.status.karmaenergy.value-s})}}async consumeAmmunition(e){if(e.extra.ammo&&!e.extra.ammoDecreased){if(e.extra.ammoDecreased=!0,e.extra.ammo._id){let t={_id:e.extra.ammo._id};e.extra.ammo.system.ammunitiongroup.value=="mag"?e.extra.ammo.system.mag.value<=0?(e.extra.ammo.system.quantity.value--,t["system.quantity.value"]=e.extra.ammo.system.quantity.value,t["system.mag.value"]=e.extra.ammo.system.mag.max-1):t["system.mag.value"]=e.extra.ammo.system.mag.value-1:(e.extra.ammo.system.quantity.value--,t["system.quantity.value"]=e.extra.ammo.system.quantity.value),await this.updateEmbeddedDocuments("Item",[t,{_id:e.source._id,"system.reloadTime.progress":0}])}}else(e.source.type=="rangeweapon"||e.source.type=="trait"&&e.source.system.traitType.value=="rangeAttack")&&!e.extra.ammoDecreased?(e.extra.ammoDecreased=!0,await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":0}])):["spell","liturgy"].includes(e.source.type)&&e.extra.speaker.token!="emptyActor"&&await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}])}_checkMaximumItemAdvancement(e,t){let a=0;switch(e.type){case"combatskill":a=Math.max(...e.system.guidevalue.value.split("/").map(o=>this.system.characteristics[o].value))+2+O.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalCombatTechnique")} (${e.name})`);break;case"spell":case"ritual":let i=0;for(let o of e.system.feature.replace(/\(a-z äöü\-\)/gi,"").split(",").map(c=>c.trim()))if(N.hasAbility(this,`${game.i18n.localize("LocalizedIDs.propertyKnowledge")} (${o})`)){i=this.maxByAttr(e);break}a=Math.max(14+O.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`),i);break;case"liturgy":case"ceremony":let r=new RegExp(`^${game.i18n.localize("LocalizedIDs.aspectKnowledge")}`),n=0;this.items.filter(o=>o.type=="specialability"&&r.test(o.name)).some(o=>e.system.distribution.value.includes(o.name.split("(")[1].split(")")[0]))&&(n=this.maxByAttr(e)),a=Math.max(14+O.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`),n);break;case"skill":a=this.maxByAttr(e);break}let s=t<=a;return s||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),{result:s,max:a}}maxByAttr(e){return Math.max(this.system.characteristics[e.system.characteristic1.value].value,this.system.characteristics[e.system.characteristic2.value].value,this.system.characteristics[e.system.characteristic3.value].value)+2+O.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`)}async basicTest({testData:e,cardOptions:t},a={}){e=await _DiceDSA5.rollDices(e,t);let s=await _DiceDSA5.rollTest(e);if(e.extra.options.other&&(s.other||(s.other=[]),s.other.push(...e.extra.options.other)),s.postFunction="basicTest",game.user.targets.size){t.isOpposedTest=e.opposable;let i=` - ${game.i18n.localize("Opposed")}`;t.isOpposedTest&&t.title.match(i+"$")!=i&&(t.title+=i)}if(await this.consumeAmmunition(e),await this.payMiracles(e),!a.suppressMessage){let i=await _DiceDSA5.renderRollCard(t,s,a.rerenderMessage);await F.handleOpposedTarget(i),s.messageId=i.id}return{result:s,cardOptions:t,options:a}}async addCondition(e,t=1,a=!1,s=!0){if(e=="bleeding"||e.id=="bleeding")return await _.bleedingMessage(this);if(this.isToken&&!this.token?.object){console.warn("Actor token object is null for",this.name);return}return await I.addCondition(this,e,t,a,s)}async addTimedCondition(e,t=1,a=!1,s=!0,i={}){return e=="bleeding"||e.id=="bleeding"?await _.bleedingMessage(this):(typeof e=="string"&&i.duration&&(e=duplicate(CONFIG.statusEffects.find(r=>r.id==e)),e.flags.dsa5.description=game.i18n.localize(e.name),e.name=game.i18n.localize(e.name),delete e.description,delete e.flags.dsa5.value,delete e.flags.dsa5.max,delete e.id,mergeObject(e,i)),await I.addCondition(this,e,t,a,s))}async initResistPainRoll(e){let t=game.settings.get("dsa5","selfControlOnPain");if(this.hasCondition("incapacitated"))return;if(t==2||t==1&&!this.hasPlayerOwner){await this.addCondition("incapacitated");return}let a=await renderTemplate("systems/dsa5/templates/chat/roll/resist-pain.html",{actor:this});await ChatMessage.create(g.chatDataSetup(a))}async finishResistPainRoll(){let e=this.items.find(t=>t.name==game.i18n.localize("LocalizedIDs.selfControl")&&t.type=="skill");this.setupSkill(e,{subtitle:` (${game.i18n.localize("ActiveEffects.resistRoll")})`},this.token?.id).then(async t=>{((await this.basicTest(t)).result.successLevel||0)<1&&this.addCondition("incapacitated")})}async removeCondition(e,t=1,a=!0,s=!1){return await I.removeCondition(this,e,t,a,s)}hasCondition(e){return I.hasCondition(this,e)}async markDead(e){let t=this.getActiveTokens();for(let a of t)a.combatant&&await a.combatant.update({defeated:e})}};function li(){let l={Rq:"roll",Gc:"GC",Ch:"CH"},e={Rq:"dice",Gc:"dice",Ch:"user-shield",AP:"trophy",Pay:"coins",GetPaid:"piggy-bank"},t={Rq:"",Gc:`${game.i18n.localize("HELP.groupcheck")} `,Ch:"",AP:"",Pay:"",GetPaid:""},a=/(-|\+)?\d+/,s=/(-|\+)?\d+(\.\d+)?/,i=/\[[a-zA-ZöüäÖÜÄ&; -]+/,r=/[\[\]]/g,n={Pay:game.i18n.localize("PAYMENT.payButton"),GetPaid:game.i18n.localize("PAYMENT.getPaidButton"),AP:game.i18n.localize("MASTER.awardXP")};if(!y.statusRegex){let o=y.statusEffects.map(m=>game.i18n.localize(m.name).toLowerCase()),c=["status","condition","level","levels"].map(m=>game.i18n.localize(m)).join("|");y.statusRegex={effects:o,regex:new RegExp(`(${c}) (${o.join("|")})`,"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Gc|Ch)\[[a-zA-ZöüäÖÜÄ&; -]+ (-|\+)?\d+\]({[a-zA-ZöüäÖÜÄß\(\)&; -]+})?/g,enricher:(o,c)=>{let m=o[0],d=o[1],u=Number(m.match(a)[0]),p=m.replace(u,"").match(i)[0].replace(r,"").trim(),f=m.match(/\{.*\}/)?m.match(/\{.*\}/)[0].replace(/[\{\}]/g,""):p;return $(`<a class="roll-button request-${l[d]}" data-type="skill" data-modifier="${u}" data-name="${p}" data-label="${f}"><em class="fas fa-${e[d]}"></em>${t[d]}${f} ${u}</a>`)[0]}},{pattern:/@(Pay|GetPaid|AP)\[(-|\+)?\d+(\.\d+)?\]({[a-zA-ZöüäÖÜÄß\(\)&; -]+})?/g,enricher:(o,c)=>{let m=o[0],d=o[1],u=Number(m.match(s)[0]),p=m.match(/\{.*\}/)?m.match(/\{.*\}/)[0].replace(/[\{\}]/g,""):n[d];return $(`<a class="roll-button request-${d}" data-type="skill" data-modifier="${u}" data-label="${p}"><em class="fas fa-${e[d]}"></em>${t[d]}${p} (${u})</a>`)[0]}},{pattern:y.statusRegex.regex,enricher:(o,c)=>$(gs(o))[0]},{pattern:/@Info\[[a-zA-ZöüäÖÜÄ&; -\.0-9]+\]/g,enricher:async(o,c)=>{let m=o[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),d=await fromUuid(m);if(!d||d.type!="information")return $('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0];if(!game.user.isGM)return $(`<a class="content-link"><i class="fas fa-mask"></i>${game.i18n.localize("GM notes")}</a>`)[0];let u={enrichedqs1:await TextEditor.enrichHTML(d.system.qs1,{async:!0}),enrichedqs2:await TextEditor.enrichHTML(d.system.qs2,{async:!0}),enrichedqs3:await TextEditor.enrichHTML(d.system.qs3,{async:!0}),enrichedqs4:await TextEditor.enrichHTML(d.system.qs4,{async:!0}),enrichedqs5:await TextEditor.enrichHTML(d.system.qs5,{async:!0}),enrichedqs6:await TextEditor.enrichHTML(d.system.qs6,{async:!0}),enrichedCrit:await TextEditor.enrichHTML(d.system.crit,{async:!0}),enrichedBotch:await TextEditor.enrichHTML(d.system.botch,{async:!0}),enrichedFail:await TextEditor.enrichHTML(d.system.fail,{async:!0})},p=await renderTemplate("systems/dsa5/templates/items/infopreview.html",{item:d,enriched:u});return $(p)[0]}},{pattern:/@EmbedItem\[[a-zA-ZöüäÖÜÄ&;, -\.0-9›‹âïß\/]+\]({[a-zA-Z=]+})?/g,enricher:async(o,c)=>{let m=o[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1),d=await fromUuid(m);if(!d){let z=m.split("."),v=game.packs.get(z[0]+"."+z[1]);v&&(d=await v.getDocuments({name:z[2]}),d=d[0])}if(!d)return $('<a class="content-link broken"><i class="fas fa-unlink"></i></a>')[0];let u=o[0],p=u.match(/\{.*\}/)?u.match(/\{.*\}/)[0].replace(/[\{\}]/g,""):"",f={};if(p)for(let z of p.split(" ")){let v=z.split("=");v.length==2&&(f[v[0]]=v[1])}let h=`systems/dsa5/templates/items/browse/${d.type}.html`,w=await renderTemplate(h,{document:d,isGM:game.user.isGM,...await d.sheet.getData(),...f});return $(w)[0]}},{pattern:/@PostChat\[(.*?)\]/g,enricher:async(o,c)=>{let m=o[1];return $(`<div class="row-section wrap maskfield postChatSection"><div class="col ninety"></div><div class="col ten center postContentChat" data-tooltip="SHEET.PostItem"><em class="far fa-comment-dots"></em></div><div class="col postChatContent">${m}</div></div>`)[0]}})}function gs(l){let t=l[0].split(" "),a=t.shift();t=t.join(" ");let s=y.statusEffects[y.statusRegex.effects.indexOf(t.toLowerCase())];return`<span>${a} <a class="chatButton chat-condition" data-id="${s.id}"><img src="${s.icon}"/>${t}</a></span>`}var g=class{static async skillByName(e){let t=game.packs.get(game.i18n.lang=="de"?"dsa5.skills":"dsa5.skillsen");await t.getIndex();let a=t.index.find(s=>s.name===e);return await t.getDocument(a._id)}static async allSkills(){let e=game.i18n.lang=="de"?"dsa5.skills":"dsa5.skillsen";return await this.getCompendiumEntries(e,"skill")}static moduleEnabled(e){return game.modules.get(e)&&game.modules.get(e).active}static async allCombatSkills(){let e=game.i18n.lang=="de"?"dsa5.skills":"dsa5.skillsen";return await this.getCompendiumEntries(e,"combatskill")}static async getCompendiumEntries(e,t){let a=await game.packs.get(e);if(!a)return ui.notifications.error("No content found");let s=Array.isArray(t)?t:[t];return(await a.getDocuments()).filter(r=>s.includes(r.type)).map(r=>r.toObject())}static renderToggle(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}static calcTokenSize(e,t){let a=game.dsa5.config.tokenSizeCategories[e.system.status.size.value];if(a)if(a<1)mergeObject(t,{texture:{scaleX:a,scaleY:a},width:1,height:1});else{let s=Math.floor(a),i=Math.max(a/s,.25);mergeObject(t,{width:s,height:s,texture:{scaleX:i,scaleY:i}})}}static async allMoneyItems(){return(await this.getCompendiumEntries("dsa5.money","money")).map(t=>(t.system.quantity.value=0,t)).filter(t=>Object.values(y.moneyNames).map(a=>a.toLowerCase()).includes(t.name.toLowerCase())).sort((t,a)=>t.system.price.value>a.system.price.value?-1:1)}static async allSkillsList(){return(await this.allSkills()||[]).map(e=>e.name).sort((e,t)=>e.localeCompare(t))}static async allCombatSkillsList(e){return((await this.allCombatSkills()).filter(t=>t.system.weapontype.value==e)||[]).map(t=>t.name).sort((t,a)=>t.localeCompare(a))}static async callItemTransformationMacro(e,t,a,s={}){let i=e.split("."),r=game.packs.get(`${i[0]}.${i[1]}`);if(!r)return console.warn(`Pack ${r} not found`),{};let n=await r.getDocuments({name:i[2]}),o={};if(n.length){let c=Object.getPrototypeOf(async function(){}).constructor,m=new c("args","source","effect",n[0].command);try{s.result=o,await m.call(this,s,t,a)}catch(d){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(d),o.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:e}));return o}static isActiveGM(){return game.users.activeGM?.isSelf}static parseAbilityString(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:e.match(/[-+]\d{1,2}$/)!=null}}static categoryLocalization(e){return game.i18n.localize(`TYPES.Item.${e}`)}static attributeLocalization(e){return game.i18n.localize(`CHAR.${e.toUpperCase()}`)}static attributeAbbrLocalization(e){return game.i18n.localize(`CHARAbbrev.${e.toUpperCase()}`)}static async callAsyncHooks(e,t){for(let a of y.asyncHooks[e])await a(...t)}static chatDataSetup(e,t,a,s){let i={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(i.rollMode)&&(i.whisper=ChatMessage.getWhisperRecipients("GM").map(r=>r.id)),i.rollMode==="blindroll"?i.blind=!0:i.rollMode==="selfroll"&&(i.whisper=[game.user]),a&&(i.speaker=ChatMessage.getSpeaker(),i.whisper=ChatMessage.getWhisperRecipients(a)),s&&(i.speaker=ChatMessage.getSpeaker(),i.whisper=s),i}static getSpeaker(e){let t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){let a=canvas.tokens.get(e.token);a&&(t=a.actor)}if(!t){let a=game.scenes.get(e.scene);try{a&&(t=new Token(a.getEmbeddedDocument("Token",e.token))?.actor)}catch{}}return t}static fateAvailable(e,t){return t?game.settings.get("dsa5","groupschips").split("/").map(a=>Number(a))[0]>0:e.system.status.fatePoints.value>0}static _calculateAdvCost(e,t,a=1){return y.advancementCosts[t][Number(e)+a]}static async getFolderForType(e,t=null,a=null,s=0,i="",r=void 0){let n=await game.folders.contents.find(o=>o.name==a&&o.type==e&&o.folder?.id==t);return n||(n=await Folder.create({name:a,type:e,sorting:r||(e=="JournalEntry"?"a":"m"),color:i,sort:s,parent:t})),n}static toObjectIfPossible(e){return typeof e.toObject=="function"?e.toObject(!1):duplicate(e)}static async showArtwork({img:e,name:t,uuid:a,isOwner:s},i=!1){return new ImagePopout(e,{title:i?s?t:"-":t,shareable:!0,uuid:a}).render(!0)}static async findAnyItem(e){let t=[],a=e.map(i=>i.name),s=e.map(i=>i.type);for(let i of game.items.contents){let r=a.indexOf(i.name);if(r>=0&&s[r]==i.type&&(a.splice(r,1),s.splice(r,1),t.push(i.toObject())),a.length<=0)break}if(a.length>0){let i=/^dsa5-core/,r=Array.from(game.packs.keys()).sort((n,o)=>(i.test(n)&&i.test(o)&&n.localeCompare(o),i.test(o)?-1:i.test(n)?1:n.localeCompare(o)));for(let n of r){let o=game.packs.get(n);if(o.documentName=="Item"&&(game.user.isGM||!o.private)&&(await o.getDocuments({name__in:a,type__in:s}).then(c=>{for(let m of c){let d=a.indexOf(m.name);d>=0&&s[d]==m.type&&(a.splice(d,1),s.splice(d,1),t.push(m.toObject()))}}),a.length<=0))break}}return t}static replaceDies(e,t=!1){let a=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,s=t?"":"/r ";return e.replace(a,function(i){return` [[${s}${i.replace(/[DwW]/,"d")}]]`})}static escapeRegex(e){return(typeof e=="string"||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static replaceConditions(e){return e&&e.replace(y.statusRegex.regex,t=>gs([t]))}static experienceDescription(e){let t=[2100,1700,1400,1200,1100,1e3],a=["EXP.legendary","EXP.brillant","EXP.masterful","EXP.competent","EXP.experienced","EXP.average"],s=0;for(let i of t){if(Number(e)>=Number(i))return a[s];s++}return"EXP.inexperienced"}static async emptyActor(e=12,t="Alrik"){Array.isArray(e)||(e=[e,e,e,e,e,e,e,e]);let a=await T.create({name:t,type:"npc",items:[],system:{status:{wounds:{value:50},fatePoints:{}},characteristics:{mu:{initial:e[0]},kl:{initial:e[1]},in:{initial:e[2]},ch:{initial:e[3]},ff:{initial:e[4]},ge:{initial:e[5]},ko:{initial:e[6]},kk:{initial:e[7]}}}},{temporary:!0,noHook:!0});return a.prepareData(),a}};var De=class{static async showDialog(e,t=!1){let[a]=await new Promise((s,i)=>{let r={Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("update"),callback:()=>{s([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{s([!1])}}};t&&(r.migrateAll={icon:'<i class="fas fa-exclamation-triangle "></i>',label:game.i18n.localize("replace"),callback:()=>{s([2])}}),new Dialog({title:game.i18n.localize("Migrakel.Migration"),content:e,default:"yes",buttons:r,close:()=>{s([!1])}}).render(!0)});return a}static async refreshStatusEffects(e){let t=[];for(let a of e.effects)a.origin&&t.push(a.id);await e.deleteEmbeddedDocuments("ActiveEffect",t)}static async updateVals(e,t,a){let s=game.dsa5.itemLibrary,i=[],r=[],n=new Map;if(await this.refreshStatusEffects(e),t({type:"equipment"})){let o=[],c=[];for(let d of e.items.filter(u=>u.type=="equipment"&&u.system.equipmentType.value=="bags")){let u=await s.findCompendiumItem(d.name,d.type);if(u.length>0){if(u=u.find(f=>f.name==d.name&&f.type==d.type),!u)continue;console.log(`MIGRATION - Updated ${d.name}`);let p=mergeObject(d.toObject(),a(u));c.push(p),o.push(d.id)}}let m=await e.createEmbeddedDocuments("Item",c);for(let d=0;d<m.length;d++)n.set(o[d],m[d].id);await e.deleteEmbeddedDocuments("Item",o)}for(let o of e.items.filter(c=>t(c)&&!(c.type=="equipment"&&c.system.equipmentType.value=="bags"))){let c=await s.findCompendiumItem(o.name,o.type);if(c.length>0){if(c=c.find(d=>d.name==o.name&&d.type==o.type),!c)continue;console.log(`MIGRATION - Updated ${o.name}`);let m=mergeObject(o.toObject(),a(c));m.system.parent_id&&n.has(m.system.parent_id)&&(m.system.parent_id=n.get(m.system.parent_id)),r.push(m),i.push(o.id)}}await e.createEmbeddedDocuments("Item",r),await e.deleteEmbeddedDocuments("Item",i),De.silent||ui.notifications.notify(game.i18n.localize("Migrakel.migrationDone"))}static async updateSpellsAndLiturgies(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.spells"),!0),s=i=>["spell","liturgy","ritual","ceremony","spellextension"].includes(i.type);if(a==2){let i=r=>{let n=r.toObject();return delete n.system.talentValue,n};await this.updateVals(e,s,i)}else if(a){let i=r=>{let n={effects:r.effects.toObject()};return r.type!="spellextension"&&(n.system={effectFormula:{value:r.system.effectFormula.value}}),n};await this.updateVals(e,s,i)}return a}static async updateSpecialAbilities(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.abilities"));if(a){let s=r=>{let n={system:{effect:{value:r.system.effect.value}},effects:r.effects.toObject()};return r.type=="specialability"&&(mergeObject(n,{system:{category:{sub:r.system.category.sub||0},list:{value:r.system.list.value},effect:{value2:getProperty(r,"system.effect.value2")||"",value3:getProperty(r,"system.effect.value3")||""}}}),r.system.category.value=="staff"&&mergeObject(n,{system:{feature:getProperty(r,"system.feature")||"",AsPCost:getProperty(r,"system.AsPCost")||"",volume:Number(getProperty(r,"system.volume"))||0,artifact:getProperty(r,"system.artifact")||"",permanentEffects:getProperty(r,"system.permanentEffects")||!1}})),this.updateMacro(n,r),n},i=r=>["specialability","advantage","disadvantage","trait"].includes(r.type);await this.updateVals(e,i,s)}return a}static async updateCombatskills(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.cskills"));if(a){let s=r=>({effects:r.effects.toObject()}),i=r=>["combatskill"].includes(r.type);await this.updateVals(e,i,s)}return a}static async updateSkills(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.skills"));if(a){let s=r=>["skill"].includes(r.type),i=r=>({img:r.img,effects:r.effects.toObject()});await this.updateVals(e,s,i)}return a}static updateMacro(e,t){let a=t.getFlag("dsa5","onUseEffect");a&&mergeObject(e,{flags:{dsa5:{onUseEffect:a}}})}static async updateGear(e,t=void 0){let a=t??await this.showDialog(game.i18n.localize("Migrakel.gear"));if(a){let s=r=>["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(r.type),i=r=>{let n={img:r.img,effects:r.effects.toObject()};return["poison","consumable"].includes(r.type)||mergeObject(n,{system:{effect:{value:r.system.effect.value}}}),["armor"].includes(r.type)&&mergeObject(n,{system:{subcategory:r.system.subcategory}}),["meleeweapon","rangeweapon","armor"].includes(r.type)&&mergeObject(n,{system:{structure:{max:r.system.structure.max,value:r.system.structure.value}}}),this.updateMacro(n,r),n};await this.updateVals(e,s,i)}return a}};var Je=class extends Dialog{constructor(e,t){super(t),this.actor=e,this.lock=!1}static async buildDialog(e){let t=await renderTemplate("systems/dsa5/templates/actors/parts/actorConfig.html",{actor:e});new Je(e,{title:game.i18n.localize("SHEET.actorConfig"),content:t,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Save"),callback:a=>{e.update({"system.config.autoBar":a.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":a.find('[name="autoSize"]').is(":checked")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async updateWrapper(e,t){if(this.lock)return;(async()=>{this.lock=!0,$(t.currentTarget).prepend('<i class="fas fa-spinner fa-spin"></i>'),await De[e](this.actor),$(t.currentTarget).find("i").remove(),this.lock=!1})()}activateListeners(e){super.activateListeners(e),e.find(".updateSpells").click(async t=>this.updateWrapper("updateSpellsAndLiturgies",t)),e.find(".updateAbilities").click(async t=>this.updateWrapper("updateSpecialAbilities",t)),e.find(".updatecSkills").click(async t=>this.updateWrapper("updateCombatskills",t)),e.find(".updateSkills").click(async t=>this.updateWrapper("updateSkills",t)),e.find(".updateGear").click(async t=>this.updateWrapper("updateGear",t))}};function Xe(l,e="img"){!game.user.isGM||l.find(e).each(function(t,a){a.setAttribute("draggable",!0),a.addEventListener("dragstart",s=>Gi(s))})}var Gi=l=>{canvas.tiles.activate();let e=l.currentTarget.src,t=l.currentTarget,a=canvas.dimensions.sceneHeight/t.naturalHeight,s=canvas.dimensions.sceneWidth/t.naturalWidth,i=Math.min(1,s,a),r=Math.round(canvas.dimensions.size/i),n={type:"Tile",texture:{src:e},tileSize:r};l.dataTransfer.setData("text/plain",JSON.stringify(n));let o=t.naturalWidth*i*canvas.stage.scale.x,c=t.naturalHeight*i*canvas.stage.scale.y,m=DragDrop.createDragImage(t,o,c);l.dataTransfer.setDragImage(m,o/2,c/2)};var Et=class extends FormApplication{constructor(e,t,a){super(),this.editfield=t,this.actorId=e,this.fieldname=a;let s=game.actors.get(this.actorId);this.object={fieldContent:getProperty(s,this.editfield)}}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{resizable:!0,width:600,height:600}),e}isEditable(){return!0}get title(){return`${game.actors.get(this.actorId).name} - ${game.i18n.localize(this.fieldname)}`}async _updateObject(e,t){game.socket.emit("system.dsa5",{type:"updateKeepField",payload:{actorId:this.actorId,field:this.editfield,updateData:t.fieldContent}})}async getData(e){let t=super.getData(e);return mergeObject(t,{fieldContent:this.object.fieldContent}),t}get template(){return"systems/dsa5/templates/dialog/foreignfieldeditor.html"}activateListeners(e){super.activateListeners(e)}};var de=class extends Application{static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsa5/templates/actors/merchant/merchant-trade.html",e.width=900,e.resizable=!0,e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],e.title=game.i18n.localize("MERCHANT.exchange"),e.classes.push("noscrollWizard"),e}constructor(e,t,a={}){super(),this.tradeData={offered:{},offer:{},id:a.id||randomID(),sourceId:e,targetId:t,offerAccepted:!1,offeredAccepted:!1}}async startTrade(){game.socket.emit("system.dsa5",{type:"startTrade",payload:{sourceId:this.tradeData.sourceId,targetId:this.tradeData.targetId,id:this.tradeData.id}}),this.render(!0)}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async getData(){let e=await super.getData(),t=g.getSpeaker(this.tradeData.sourceId),a=t.prepareItems({details:[]});a.inventory.money={items:a.money.coins.map(s=>(s.name=game.i18n.localize(s.name),s)),show:!0,dataType:"money"};for(let s of Object.values(a.inventory))for(let i of s.items)this.tradeData.offer[i._id]&&(i.system.quantity.value-=this.tradeData.offer[i._id].system.quantity.value);return mergeObject(e,{tradeData:this.tradeData,actor:g.getSpeaker(this.tradeData.targetId),tradeFriend:t,inventory:a}),e}static findTradeApp(e){for(let t of Object.values(ui.windows))if(t instanceof this&&t?.tradeData?.id===e)return t;return!1}async close(e={}){return e.skipSocket||game.socket.emit("system.dsa5",{type:"tradeCanceled",payload:{id:this.tradeData.id}}),super.close(e)}activateListeners(e){super.activateListeners(e),e.find(".trade").click(s=>this._offerItem(s));let t=s=>this._filterGear($(s.currentTarget));e.find(".item-edit").click(s=>this._editItem(s,this.tradeData.sourceId)),e.find(".item-external-edit").click(s=>this._editItem(s,this.tradeData.targetId)),e.find(".acceptTrade").click(s=>this.acceptTrade(s));let a=e.find(".gearSearch");a.keyup(s=>t(s)),a[0]&&a[0].addEventListener("search",t,!1)}_editItem(e,t){g.getSpeaker(t).items.get(e.currentTarget.dataset.itemId).sheet.render(!0)}_offerItem(e){if(this.tradeData.offerAccepted)return;let t=e.currentTarget.dataset.itemId,s=g.getSpeaker(this.tradeData.sourceId).items.get(t),i=e.ctrlKey?10:1,r=e.currentTarget.dataset.stopTrade,n=r?this.tradeData.offer[t].system.quantity.value:s.system.quantity.value;s&&(r?(this.tradeData.offer[t].system.quantity.value-=Math.min(i,n),this.tradeData.offer[t].system.quantity.value<=0&&delete this.tradeData.offer[t],this.offerChanged(),this.render()):(this.tradeData.offer[t]?n-=this.tradeData.offer[t].system.quantity.value:(this.tradeData.offer[t]=s.toObject(),this.tradeData.offer[t].system.quantity.value=0),n>0&&(this.tradeData.offer[t].system.quantity.value+=Math.min(i,n),this.offerChanged(),this.render())),U.playMoneySound())}async offerChanged(){game.socket.emit("system.dsa5",{type:"receiveOfferedItems",payload:{id:this.tradeData.id,trader:this.tradeData.sourceId,offered:this.tradeData.offer}})}static receiveOfferedItems(e){let t=this.findTradeApp(e.payload.id);t&&(e.payload.trader==t.tradeData.sourceId?(t.tradeData.offer=e.payload.offered,t.tradeData.offerAccepted=!1):(t.tradeData.offered=e.payload.offered,t.tradeData.offeredAccepted=!1),t.render())}static isGMTrade(e){return game.user.isGM&&!e.hasPlayerOwner}static isPlayerTrade(e){return!game.user.isGM&&e.isOwner}static socketStartTrade(e){let t=g.getSpeaker(e.payload.targetId);(this.isGMTrade(t)||this.isPlayerTrade(t))&&new de(e.payload.targetId,e.payload.sourceId,{id:e.payload.id}).render(!0)}acceptTrade(){this.tradeData.offerAccepted=!this.tradeData.offerAccepted,this.render(!0),game.socket.emit("system.dsa5",{type:"acceptTrade",payload:{id:this.tradeData.id,accepted:this.tradeData.offerAccepted}})}static tradeWasAccepted(e){let t=this.findTradeApp(e.payload.id);t&&(t.tradeData.offeredAccepted=e.payload.accepted,t.tradeData.offerAccepted&&t.tradeData.offeredAccepted?(t.finishTrade(),U.playMoneySound()):t.render())}async finishTrade(){g.isActiveGM()&&await de.updateData(this.tradeData),game.socket.emit("system.dsa5",{type:"tradeFinished",payload:{id:this.tradeData.id,tradeData:this.tradeData}}),this.close({skipSocket:!0}),U.playMoneySound()}static async updateData(e){let t=g.getSpeaker(e.sourceId),a=g.getSpeaker(e.targetId);await this.modifyActor(t,e.offer,e.offered),await this.modifyActor(a,e.offered,e.offer)}static async modifyActor(e,t,a){let s=[],i=[];for(let r of Object.keys(t)){let n=e.items.get(r);n&&(n.system.quantity.value<=t[r].system.quantity.value&&n.type!="money"?s.push(r):i.push({_id:r,"system.quantity.value":n.system.quantity.value-t[r].system.quantity.value}))}await e.deleteEmbeddedDocuments("Item",s,{render:!1}),await e.updateEmbeddedDocuments("Item",i,{render:!1});for(let r of Object.values(a))await e.sheet._manageDragItems(r,r.type)}static tradeWasFinished(e){let t=this.findTradeApp(e.payload.id);g.isActiveGM()&&de.updateData(e.payload.tradeData),t&&t.close({skipSocket:!0})}static tradeWasCanceled(e){let t=this.findTradeApp(e.payload.id);t&&t.close({skipSocket:!0})}static socketListeners(e){switch(e.type){case"receiveOfferedItems":return this.receiveOfferedItems(e),!0;case"startTrade":return this.socketStartTrade(e),!0;case"acceptTrade":return this.tradeWasAccepted(e),!0;case"tradeCanceled":return this.tradeWasCanceled(e),!0;case"tradeFinished":return this.tradeWasFinished(e),!0}}},Qt=class extends Application{constructor(e,t){super(t),this.actorId=S.buildSpeaker(e,e.token?.id)}async getData(e){let t=await super.getData(e);return t.actors=game.actors.filter(a=>a.hasPlayerOwner&&a.id!=this.actorId.actor),t}static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsa5/templates/actors/merchant/merchant-tradeoptions.html",e.resizable=!0,e.title=game.i18n.localize("MERCHANT.exchange"),e}_startTrade(e){let t=game.actors.get(e.currentTarget.dataset.id);new de(this.actorId,S.buildSpeaker(t,t.token?.id)).startTrade(),this.close()}activateListeners(e){super.activateListeners(e),e.find(".startTrade").on("dblclick",t=>this._startTrade(t))}};var ie=class extends Application{static registerTokenHotbar(){game.dsa5.apps.tokenHotbar||(game.dsa5.apps.tokenHotbar=new ie,game.dsa5.apps.tokenHotbar.updateDSA5Hotbar(),game.dsa5.apps.tokenHotbar.render(!0),Hooks.call("dsa5TokenHotbarReady",game.dsa5.apps.tokenHotbar))}static unregisterTokenHotbar(){game.dsa5.apps.tokenHotbar&&(game.dsa5.apps.tokenHotbar.close(),game.dsa5.apps.tokenHotbar=void 0)}constructor(e){if(super(e),this.searching="",this.combatSkills=["selfControl","featOfStrength","bodyControl","perception","loyalty"].map(a=>game.i18n.localize(`LocalizedIDs.${a}`)),this.defaultSkills=[game.i18n.localize("LocalizedIDs.perception")],game.user.isGM){this.callbackFunctions={};let a=game.settings.get("dsa5","enableMasterTokenFunctions");this.gmItems=[{name:"gmMenu",disabled:a.masterMenu,icon:"systems/dsa5/icons/categories/DSA-Auge.webp",id:"masterMenu",cssClass:"gm",abbrev:"",subfunction:"gm"},{name:"MASTER.randomPlayer",disabled:a.randomVictim,iconClass:"fa fa-dice-six",id:"randomVictim",cssClass:"gm",abbrev:"",subfunction:"gm"},{name:"TT.tokenhotbarMoney",disabled:a.payMoney,icon:"systems/dsa5/icons/money-D.webp",id:"payMoney",cssClass:"gm",abbrev:"",subfunction:"gm"}]}let t=a=>{let s=a.parent?a.parent.id:void 0;s&&ie.hookUpdate(s)};Hooks.on("controlToken",(a,s)=>{game.dsa5.apps.tokenHotbar?.updateDSA5Hotbar()}),Hooks.on("updateActor",(a,s)=>{ie.hookUpdate(a.id)}),Hooks.on("updateToken",(a,s,i)=>{!game.dsa5.apps.tokenHotbar||s._id==getProperty(game.dsa5.apps.tokenHotbar,"actor.prototypeToken.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}),Hooks.on("updateOwnedItem",(a,s)=>{ie.hookUpdate(a.data.id)}),Hooks.on("createOwnedItem",(a,s)=>{ie.hookUpdate(a.data.id)}),Hooks.on("deleteOwnedItem",(a,s)=>{ie.hookUpdate(a.data.id)}),Hooks.on("updateItem",(a,s)=>{t(a)}),Hooks.on("createItem",(a,s)=>{t(a)}),Hooks.on("deleteItem",(a,s)=>{t(a)}),Hooks.on("canvasInit",()=>{!this.rendered||this.render()})}registerMasterFunction(e,t){let a=game.settings.get("dsa5","enableMasterTokenFunctions");e.disabled=a[e.id],this.gmItems.push(e),this.callbackFunctions[e.id]=t}async prepareSkills(){let e=await g.allSkills();return this.skills=e.map(t=>({name:t.name,icon:t.img,id:t.name,cssClass:"skillgm",addClass:t.system.group.value,abbrev:t.name[0],subfunction:"skillgm"})),this.skills=this.skills.sort((t,a)=>t.addClass.localeCompare(a.addClass)||t.name.localeCompare(a.name)),this.skills}static hookUpdate(e){game.dsa5.apps.tokenHotbar&&e==getProperty(game.dsa5.apps.tokenHotbar,"actor.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}resetPosition(){let e=$("#hotbar").first().position(),t=game.settings.get("dsa5","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}static get defaultOptions(){let e=super.defaultOptions,t=$("#hotbar").first().position(),a=game.settings.get("dsa5","tokenhotbarSize"),s=game.settings.get("dsa5","tokenhotbarPosition");return mergeObject(e,{classes:e.classes.concat(["dsa5","tokenQuickHot"]),itemWidth:a,resizable:!1,height:a+45,zIndex:61,left:t.left+8,top:t.top-a-25,template:"systems/dsa5/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(e,s),e}async _onWheelResize(e){let t=game.settings.get("dsa5","tokenhotbarSize");e.originalEvent.deltaY>0?t=Math.min(100,t+5):t=Math.max(15,t-5),await game.settings.set("dsa5","tokenhotbarSize",t),await this.render(!0)}async _cycleLayout(e){if(e.button==2){let t=game.settings.get("dsa5","tokenhotbarLayout")+1;t==4&&(t=0),await game.settings.set("dsa5","tokenhotbarLayout",t),await this.render(!0)}}changeDarkness(e){let t=Number(e.currentTarget.value);canvas.scene&&canvas.scene.update({darkness:t},{animateDarkness:3e3}),me(t)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async i=>(i.stopPropagation(),i.preventDefault(),await this._onWheelResize(i),!1)),t.on("mousedown",async i=>{await this._cycleLayout(i)}),e.find(".itdarkness input").change(i=>this.changeDarkness(i));let a=this,s=function(i){return a.filterButtons(i),!1};e.find(".filterable").hover(function(){$(document).keydown(s)},function(){$(document).unbind("keydown",s)}),e.find(".quantity-click").mousedown(i=>_.quantityClick(i)),e.on("mousedown","li",async i=>(i.stopPropagation(),await this.executeQuickButton(i),!1)),e.on("mouseenter","li.primary",i=>{let r=i.currentTarget.dataset.category;this.category=r,setTimeout(()=>{e.find(".secondary").removeClass("shown"),r==this.category&&e.find(`.secondary[data-category="${r}"]`).addClass("shown")},700)}),e.on("mouseleave","li.primary",i=>{let r=i.currentTarget.dataset.category;this.category=void 0,setTimeout(()=>{r!=this.category&&(a.searching="",$(i.currentTarget).find(".secondary").removeClass("dsahidden"),e.find(`.secondary[data-category="${r}"]`).removeClass("shown"))},50)})}async handleEffect(e,t,a,s){let i=t.effects.get(a),r=[...i.statuses][0];e.button==0?r?await t.addCondition(r,1,!1,!1):i.sheet.render(!0):e.button==2&&(r?await t.removeCondition(r,1,!1):await t.sheet._deleteActiveEffect(a)),await this.render(!0)}async handleGMRoll(e){let t=e.currentTarget.dataset.id,a=Math.round($(e.currentTarget).closest(".tokenHotbarInner").find(".modifierVal").val());e.ctrlKey?game.dsa5.apps.DSA5ChatListeners.check3D20(void 0,t,{modifier:a}):e.button==2?game.dsa5.macro.requestGC(t,a,{maxRolls:7}):game.dsa5.macro.requestRoll(t,a)}async handleSkillRoll(e,t,a,s){let i={};if(e.button==2&&(i.rollMode="blindroll"),a=="rideLoyaltyID")H.rollLoyalty(t,i);else if(a=="attackWeaponless")t.setupWeaponless("attack",i,s).then(r=>{t.basicTest(r)});else{let r=t.items.get(a);if(r){if(e.originalEvent.ctrlKey)return r.sheet.render(!0);switch(r.type){case"meleeweapon":case"rangeweapon":case"trait":t.setupWeapon(r,"attack",i,s).then(n=>{t.basicTest(n)});break;case"liturgy":case"spell":t.setupSpell(r,i,s).then(n=>{t.basicTest(n)});break;case"skill":t.setupSkill(r,i,s).then(n=>{t.basicTest(n)});break;case"consumable":new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+r.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+r.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async()=>{await r.setupEffect(null,{},s),await this.updateDSA5Hotbar()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);break}}}}async handleTradeStart(e,t,a,s){for(let i of game.user.targets)i.actor&&new de(S.buildSpeaker(t,s),S.buildSpeaker(i.actor,i.id)).startTrade()}async handleOnUse(e,t,a,s){let i=t.items.get(a);await new J(i).executeOnUseEffect()}async handleGM(e,t,a,s){switch(a){case"masterMenu":g.renderToggle(game.dsa5.apps.gameMasterMenu);break;case"payMoney":this.payMoney(e);break;case"randomVictim":this.handleGMRandomVictim(e);break;default:a in this.callbackFunctions&&this.callbackFunctions[a](e,t,a,s)}}payMoney(e){let t=`${$(e.currentTarget).closest(".tokenHotbarInner").find(".modifierVal").val()}`;e.button==2?j.createGetPaidChatMessage(t):j.createPayChatMessage(t)}async handleGMRandomVictim(e){let t=await game.dsa5.apps.gameMasterMenu.rollRandomPlayer(e.button==2),a=game.actors.get(t);if(a){let s=await g.showArtwork(a);e.originalEvent.ctrlKey||setTimeout(()=>{s.close()},2e3)}}async handleSharedEffect(e){for(let t of canvas.tokens.controlled){let a=t.actor,s=t.id,i=a.effects.find(r=>r.name==e.currentTarget.dataset.name)?.id;await this.handleEffect(e,a,i,s)}}async executeQuickButton(e){let t=canvas.tokens.controlled[0]?.actor,a=canvas.tokens.controlled[0]?.id,s=e.currentTarget.dataset.id;switch(e.currentTarget.dataset.subfunction){case"trade":this.handleTradeStart(e,t,s,a);break;case"addEffect":Ae.showDialog();break;case"effect":this.handleEffect(e,t,s,a);break;case"sharedEffect":this.handleSharedEffect(e);break;case"onUse":this.handleOnUse(e,t,s,a);break;case"gm":this.handleGM(e,t,s,a);break;case"none":case"darkness":break;case"skillgm":this.handleGMRoll(e);break;default:this.handleSkillRoll(e,t,s,a)}}subWidth(e,t,a=7){return`style="width:${Math.ceil(e.length/a)*200}px"`}async getData(){let e=await super.getData(),t=this.actor,a={attacks:[],spells:[],default:[],skills:[],functions:[],gm:[]},s,i,r=[],n=[],o=[],c=game.settings.get("dsa5","tokenhotbarLayout"),m=c%2,d=ie.defaultOptions.itemWidth,u=["liturgy","spell"],p=!1;if(t){let h=[],w=[],z=H.isRiding(t),v=game.i18n.localize("LocalizedIDs.riding");if(o=(await t.actorEffects()).map(D=>({name:D.name,id:D.id,icon:D.icon,cssClass:"effect",abbrev:`${D.name[0]} ${D.getFlag("dsa5","value")||""}`,subfunction:"effect"})),game.combat){let D=t.items.filter(b=>b.type=="combatskill").map(b=>T._calculateCombatSkillValues(b.toObject(),t.system)),x=D.find(b=>b.name==game.i18n.localize("LocalizedIDs.wrestle"));x&&a.attacks.push({name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",icon:"systems/dsa5/icons/categories/attack_weaponless.webp",attack:x.system.attack.value,damage:"1d6"});let E=["meleeweapon","rangeweapon"],A=["meleeAttack","rangeAttack"];for(let b of t.items){if(["skill"].includes(b.type)&&(this.combatSkills.some(P=>b.name.startsWith(P))||z&&v==b.name)&&a.default.push({name:`${b.name} (${b.system.talentValue.value})`,id:b.id,icon:b.img,cssClass:"skill filterable",abbrev:b.name[0]}),b.type=="trait"&&A.includes(b.system.traitType.value)){let P=T._parseDmg(b.toObject());a.attacks.push({name:b.name,id:b.id,icon:b.img,cssClass:`weapon ${b.id}`,abbrev:b.name[0],attack:b.system.at.value,damage:P.damagedie,dadd:P.damageAdd})}else if(E.includes(b.type)&&b.system.worn.value==!0){let P=b.type=="meleeweapon"?T._prepareMeleeWeapon(b.toObject(),D,t):T._prepareRangeWeapon(b.toObject(),[],D,t);a.attacks.push({name:b.name,id:b.id,icon:b.img,cssClass:`weapon ${b.id}`,abbrev:b.name[0],attack:P.attack,damage:P.damagedie,dadd:P.damageAdd})}else if(u.includes(b.type))b.system.effectFormula.value?a.spells.push({name:b.name,id:b.id,icon:b.img,cssClass:"spell",abbrev:b.name[0]}):w.push({name:b.name,id:b.id,icon:b.img,cssClass:"spell",abbrev:b.name[0]});else if(["skill"].includes(b.type)){let P={name:`${b.name} (${b.system.talentValue.value})`,id:b.id,icon:b.img,cssClass:"skill",addClass:b.system.group.value,abbrev:b.name[0],tw:b.system.talentValue.value};h.push(P)}else b.type=="consumable"&&r.push({name:b.name,id:b.id,icon:b.img,cssClass:"consumable",abbrev:b.system.quantity.value});b.getFlag("dsa5","onUseEffect")&&n.push({name:b.name,id:b.id,icon:b.img,cssClass:"onUse",abbrev:b.name[0],subfunction:"onUse"})}if(s=r.pop(),z){let b=H.getHorse(t);if(b){let P=H.getLoyaltyFromHorse(b);P&&a.default.push({name:`${P.name} (${P.system.talentValue.value})`,id:"rideLoyaltyID",icon:P.img,cssClass:"skill",abbrev:P.name[0]})}}}else{let D=[];for(let x of t.items){if(["skill"].includes(x.type)&&(this.defaultSkills.includes(x.name)||z&&v==x.name)&&a.default.push({name:`${x.name} (${x.system.talentValue.value})`,id:x.id,icon:x.img,cssClass:"skill filterable",abbrev:x.name[0]}),["skill"].includes(x.type)){let E={name:`${x.name} (${x.system.talentValue.value})`,id:x.id,icon:x.img,cssClass:"skill",addClass:x.system.group.value,abbrev:x.name[0],tw:x.system.talentValue.value};x.system.talentValue.value>0&&(E.cssClass+=" filterable",D.push(E)),h.push(E)}else u.includes(x.type)&&(x.system.effectFormula.value?a.spells.push({name:x.name,id:x.id,icon:x.img,cssClass:"spell",abbrev:x.name[0]}):w.push({name:x.name,id:x.id,icon:x.img,cssClass:"spell",abbrev:x.name[0]}));x.getFlag("dsa5","onUseEffect")&&n.push({name:x.name,id:x.id,icon:x.img,cssClass:"onUse",abbrev:x.name[0],subfunction:"onUse"})}a.skills.push(...D.sort((x,E)=>E.tw-x.tw).slice(0,5))}i=n.pop();let L=game.i18n.localize("MERCHANT.exchange");a.functions.push({name:L,id:"trade",icon:"icons/svg/coins.svg",cssClass:"effect",abbrev:L[0],subfunction:"trade"}),a.spells.length==0&&w.length>0&&a.spells.push(w.pop()),a.spells.length>0&&w.length>0&&(a.spells[0].more=w.sort((D,x)=>D.name.localeCompare(x.name)),a.spells[0].subwidth=this.subWidth(w,d)),a.default.length>0&&h.length>0&&(a.default[0].more=h.sort((D,x)=>D.addClass.localeCompare(x.addClass)||D.name.localeCompare(x.name)),a.default[0].subwidth=this.subWidth(h,d,20)),s&&(r.length>0&&(s.more=r,s.subwidth=this.subWidth(r,d)),a.consumables=[s]),i&&(n.length>0&&(i.more=n,i.subwidth=this.subWidth(n,d)),a.onUsages=[i])}else if(game.user.isGM&&!game.settings.get("dsa5","disableTokenhotbarMaster")){p=!0;let h=this.skills||await this.prepareSkills();a.gm=this.gmItems.filter(w=>!w.disabled).concat([{name:"TT.tokenhotbarSkill",id:"skillgm",icon:"systems/dsa5/icons/categories/Skill.webp",cssClass:"skillgm filterable",abbrev:"",subfunction:"none",more:h,subwidth:this.subWidth(h,d,20)}])}if(this.showEffects){let h=game.i18n.localize("CONDITION.add"),w={name:"CONDITION.add",id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:h[0],subfunction:"addEffect"};if(o.length>0)w.more=o,w.subwidth=this.subWidth(o,d);else if(canvas.tokens.controlled.length>1){let z=(await canvas.tokens.controlled[0].actor.actorEffects()).map(v=>({name:v.name,id:v.id,icon:v.icon,cssClass:"effect",abbrev:`${v.name[0]} ${v.getFlag("dsa5","value")||""}`,subfunction:"sharedEffect"}));for(let v of canvas.tokens.controlled){let L=(await v.actor.actorEffects()).map(D=>D.name);z=z.filter(D=>L.includes(D.name))}w.more=z,w.subwidth=this.subWidth(z,d)}a.effects=[w]}let f=Object.keys(a).reduce((h,w)=>h+a[w].length,0)+(p?3:0);return m?(this.position.width=d,this.position.height=d*f+14):(this.position.width=d*f+14,this.position.height=d),mergeObject(e,{items:a,itemWidth:d,direction:c,count:f,gmMode:p,darkness:canvas.scene?.darkness||0,opacity:game.settings.get("dsa5","tokenhotbaropacity")}),e}filterButtons(e){switch(e.which){case 17:return;case 8:this.searching=this.searching.slice(0,-1);break;default:this.searching+=String.fromCharCode(e.which)}e.preventDefault(),e.stopPropagation();let t=this.searching.toLowerCase();me(t);let a=$(e.currentTarget).find(".subbuttons li");a.find(".dsahidden").removeClass("dsahidden"),a.filter(function(){return $(this).find("label").text().toLowerCase().trim().indexOf(t)==-1}).addClass("dsahidden")}async render(e,t={}){let a=await super.render(e,t);return this._element&&this._element.css({zIndex:61}),a}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){let r=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),n=this.element[0];if(!n.style.width||a){let o=a||n.offsetWidth,c=n.style.maxWidth||window.innerWidth;r.width=a=Math.clamped(o,0,c),n.style.width=a+"px",a+r.left>window.innerWidth&&(e=r.left)}return game.settings.set("dsa5","tokenhotbarPosition",{left:r.left,top:r.top}),r}async updateDSA5Hotbar(){let e=canvas.tokens.controlled;if(this.actor=void 0,this.showEffects=!1,e.length===1){let t=e[0].actor;t&&t.isOwner&&(this.actor=t)}e.length>=1&&(this.showEffects=!0),await this.render(!0,{focus:!1})}},Ae=class extends Dialog{static async showDialog(){let e=duplicate(CONFIG.statusEffects).map(a=>({name:game.i18n.localize(a.name),icon:a.icon,description:game.i18n.localize(a.description),id:a.id})).sort((a,s)=>a.name.localeCompare(s.name)),t=new Ae({title:game.i18n.localize("CONDITION.add"),content:await renderTemplate("systems/dsa5/templates/dialog/addstatusdialog.html",{effects:e}),buttons:{}});t.position.height=Math.ceil(e.length/3)*36+170,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").mouseenter(s=>{if(s.currentTarget.getElementsByClassName("hovermenu").length==0){let i=document.createElement("div");i.classList.add("hovermenu"),i.style.cssText="font-size: var(--font-size-20);";let r=document.createElement("i");r.classList.add("fas","fa-cogs"),r.title=game.i18n.localize("ActiveEffects.custom"),r.addEventListener("click",async n=>this.configureEffect(n),!1),i.appendChild(r),s.currentTarget.appendChild(i)}}),e.find(".reactClick").mouseleave(s=>{let i=s.toElement||s.relatedTarget;i.parentNode==this||i==this||s.currentTarget.querySelectorAll(".hovermenu").forEach(r=>r.remove())}),e.find(".quantity-click").mousedown(s=>_.quantityClick(s)),e.find(".reactClick").click(s=>this.addEffect(s.currentTarget.dataset.value));let t=s=>this._filterConditions($(s.currentTarget),e),a=e.find(".conditionSearch");a.keyup(s=>this._filterConditions($(s.currentTarget),e)),a[0]&&a[0].addEventListener("search",t,!1)}_filterConditions(e,t){if(e.val()!=null){let a=e.val().toLowerCase().trim(),s=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),s.filter(function(){return $(this).find("span").text().toLowerCase().trim().indexOf(a)==-1}).addClass("filterHide")}}static async modifyEffectDialog(e,t){new Ae({title:game.i18n.localize("CONDITION."+e),content:await renderTemplate("systems/dsa5/templates/dialog/configurestatusdialog.html"),default:"add",buttons:{add:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("CONDITION.add"),callback:async a=>{let s={},i=a.find("[name=unit]:checked").val()=="seconds"?Math.round(a.find(".duration").val()/5):a.find(".duration").val(),r=a.find(".effectname").val();i>0&&mergeObject(s,_._buildDuration(i)),r&&(s.name=r),await t(e,s)}}}}).render(!0,{width:400,resizable:!1,classes:["dsa5","dialog"]})}async configureEffect(e){e.stopPropagation();let a=$(e.currentTarget).closest(".reactClick").attr("data-value");this.close(),Ae.modifyEffectDialog(a,async(s,i)=>this.addEffect(s,i))}async addEffect(e,t={}){for(let a of canvas.tokens.controlled)await a.actor.addTimedCondition(e,1,!1,!1,t);game.dsa5.apps.tokenHotbar?.render(!0),this.close()}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:["dsa5","tokenStatusEffects"],width:700,resizable:!0}),e}};var fs=async(l,e,t,a)=>{if(game.user.isGM){let s=await game.dsa5.apps.DSA5_Utility.allMoneyItems(),i=await g.getFolderForType("Actor",null,"Dropped Items"),n=game.users.filter(u=>!u.isGM).map(u=>u.id).reduce((u,p)=>(u[p]=1,u),{default:0}),o=e.toObject();o.system.quantity.value=a,_.obfuscateDropData(o,t.tabsinvisible),getProperty(o,"system.worn.value")&&(o.system.worn.value=!1);let c={type:"npc",name:e.name,img:e.img,prototypeToken:{img:e.img,width:.4,height:.4},ownership:n,items:[...s,o],flags:{core:{sheetClass:"dsa5.MerchantSheetDSA5"}},folder:i,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},status:{wounds:{value:16}}}},d=await(await game.dsa5.entities.Actordsa5.create(c)).getTokenDocument({x:t.x,y:t.y,hidden:!1});if(!canvas.dimensions.rect.contains(d.x,d.y))return!1;if(l){await canvas.scene.createEmbeddedDocuments("Token",[d],{noHook:!0});let u=e.system.quantity.value-a;u<1?await l.deleteEmbeddedDocuments("Item",[e.id]):await l.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity.value":u}])}else await canvas.scene.createEmbeddedDocuments("Token",[d])}else{let s={itemId:e.uuid,sourceActorId:l?.id,data:t,amount:a};game.socket.emit("system.dsa5",{type:"itemDrop",payload:s})}},Bi=async(l,e)=>{let t=await Item.implementation.fromDropData(e),a=t.parent;if(!y.equipmentCategories.has(t.type))return;let s=async i=>{fs(a,t,e,i)};Qe.create(game.i18n.localize("DSASETTINGS.enableItemDropToCanvas"),game.i18n.format("MERCHANT.dropGround",{name:t.name}),t.system.quantity.value,s)},qi=async(l,e)=>{let t=e.x,a=e.y,s=0,i=l.grid.size,r=Math.ceil(Math.sqrt(e.ids.length));for(let n of e.ids){let o=game.actors.get(n);if(!o)continue;let c=await o.getTokenDocument({x:t,y:a,hidden:!1});c.constructor.create(c,{parent:l.scene}),r%s==0&&s>0?(a+=i,t=e.x):t+=i,s++}},ci=()=>{Hooks.on("dropCanvasData",async(l,e)=>{if(!!(game.settings.get("dsa5","enableItemDropToCanvas")||game.user.isGM||e.tokenId)){if(e.type=="Item")return Bi(l,e),!1;if(e.type=="GroupDrop")return qi(l,e),!1}})},Qe=class extends Dialog{static async create(e,t,a,s,i=1,r=void 0){r=r||a;let n=await renderTemplate("systems/dsa5/templates/dialog/dropToGround.html",{name:t,min:i,max:r,count:a});new Qe({title:e,content:n,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async o=>s(Number(o.find('[name="count"]').val()))},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};var Me=class extends ActorSheet{get actorType(){return this.actor.type}async _render(e=!1,t={}){this._saveSearchFields(),this._saveCollapsed(),await super._render(e,t),this._setCollapsed(),this._restoreSeachFields();let a=$(this._element),s={".close":"SHEET.Close",".configure-sheet":"SHEET.Configure",".configure-token":"SHEET.Token",".import":"SHEET.Import",".locksheet":"SHEET.Lock",".library":"SHEET.Library",".playerview":"SHEET.switchLimited",".actorConfig":"SHEET.actorConfig"};for(let i of Object.keys(s))a.find(i).attr("data-tooltip",s[i]);this.currentFocus&&(a.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null)}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(e,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),e}_saveSearchFields(){if(this.form===null)return;let e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}_restoreSeachFields(){if(this.searchFields!=null){let e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));let t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),this.searchFields.searchText!=""&&this._filterTalents(t);let a=$(e.find(".gearSearch"));a.val(this.searchFields.gearSearch),this.searchFields.searchText!=""&&this._filterGear(a)}}_saveCollapsed(){if(this.form===null)return;let e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];let t=e.find(".ch-collapse i");for(let a of t)this.collapsedBoxes.push($(a).attr("class"));for(let a of $(e.find(".expandDetails.shown")))this.openDetails.push($(a).closest(".item").attr("data-item-id"))}_setCollapsed(){let e=$(this.form).parent();if(this.collapsedBoxes){let t=e.find(".ch-collapse i");for(let a=0;a<t.length;a++)$(t[a]).attr("class",this.collapsedBoxes[a]),this.collapsedBoxes[a]&&this.collapsedBoxes[a].indexOf("fa-angle-down")!=-1&&$(t[a]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}}async getData(e){let t=await super.getData(e),a={actor:t.actor,editable:t.editable,limited:t.limited,owner:t.owner};return a.prepare=this.actor.prepareSheet({details:this.openDetails}),a.sizeCategories=y.sizeCategories,a.isGM=game.user.isGM,a.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},a.horseSpeeds=Object.keys(H.speedKeys),I.prepareActiveEffects(this.actor,a),a.enrichedOwnerdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.ownerdescription"),{secrets:this.object.isOwner,async:!0}),a.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.gmdescription"),{secrets:this.object.isOwner,async:!0}),a.enrichedNotes=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.value"),{secrets:this.object.isOwner,async:!0}),a.enrichedBiography=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.biography.value"),{secrets:this.object.isOwner,async:!0}),a}_onItemCreate(e){e.preventDefault();let t=e.currentTarget,a=duplicate(t.dataset);y.equipmentTypes[a.type]&&(a.type="equipment",a=mergeObject(a,{"system.equipmentType.value":e.currentTarget.attributes["item-section"].value,"system.effect.value":""})),["aggregatedTest","spell","liturgy","ritual","ceremony"].includes(a.type)||(a["system.weight.value"]=0,a["system.quantity.value"]=0),S.defaultIcon(a),a.name=g.categoryLocalization(a.type),this.actor.createEmbeddedDocuments("Item",[a])}_handleAggregatedProbe(e){let t=this._getItemId(e),a=this.actor.items.get(t).toObject(),s=a.system.talent[`value${e.currentTarget.dataset.which}`],i=this.actor.items.find(n=>n.name==s&&n.type=="skill"),r=`<h3 class="center"><b>${game.i18n.localize("TYPES.Item.aggregatedTest")}</b></h3>`;a.system.usedTestCount.value>=a.system.allowedTestCount.value?(r+=`${game.i18n.localize("Aggregated.noMoreAllowed")}`,ChatMessage.create(g.chatDataSetup(r))):this.actor.setupSkill(i,{moreModifiers:[{name:game.i18n.localize("failedTests"),value:-1*a.system.previousFailedTests.value,selected:!0},{name:game.i18n.localize("Modifier"),value:a.system.baseModifier,selected:!0}]},this.getTokenId()).then(n=>{this.actor.basicTest(n).then(o=>{o.result.successLevel>0?(a.system.cummulatedQS.value=o.result.qualityStep+a.system.cummulatedQS.value,a.system.cummulatedQS.value=Math.min(10,a.system.cummulatedQS.value)):a.system.previousFailedTests.value+=1,a.system.usedTestCount.value+=1,this.actor.updateEmbeddedDocuments("Item",[a]).then(()=>{let c=this.actor.items.get(t);c.postItem(),a.system.cummulatedQS.value>=10&&c.sheet.postFinishedItem()})})})}async consumeItem(e){new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+e.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+e.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{e.setupEffect(null,{},this.getTokenId())}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async _advanceAttribute(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial),a=g._calculateAdvCost(t,"E");await this._checkEnoughXP(a)&&await this._updateAPs(a,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)+1})}async _refundAttributeAdvance(e){let t=Number(this.actor.system.characteristics[e].advances)+Number(this.actor.system.characteristics[e].initial);if(Number(this.actor.system.characteristics[e].advances)>0){let a=g._calculateAdvCost(t,"E",0)*-1;await this._updateAPs(a,{[`system.characteristics.${e}.advances`]:Number(this.actor.system.characteristics[e].advances)-1})}}async _rebuyPC(e){this.actor.system.status[e].permanentLossSum>0&&await this._checkEnoughXP(2)&&await this._updateAPs(2,{[`system.status.${e}.rebuy`]:Number(this.actor.system.status[e].rebuy)+1})}async _refundPC(e){this.actor.system.status[e].rebuy>0&&await this._updateAPs(-2,{[`system.status.${e}.rebuy`]:Number(this.actor.system.status[e].rebuy)-1})}async _advancePoints(e){let t=Number(this.actor.system.status[e].advances),a=g._calculateAdvCost(t,"D");await this._checkEnoughXP(a)&&this._checkMaximumPointAdvancement(e,t+1)&&await this._updateAPs(a,{[`system.status.${e}.advances`]:Number(this.actor.system.status[e].advances)+1})}async _refundPointsAdvance(e){let t=Number(this.actor.system.status[e].advances);if(t>0){let a=g._calculateAdvCost(t,"D",0)*-1;await this._updateAPs(a,{[`system.status.${e}.advances`]:Number(this.actor.system.status[e].advances)-1})}}async _advanceItem(e){let t=this.actor.items.get(e).toObject(),a=g._calculateAdvCost(Number(t.system.talentValue.value),t.system.StF.value);await this._checkEnoughXP(a)&&this.actor._checkMaximumItemAdvancement(t,Number(t.system.talentValue.value)+1)?.result&&(await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.talentValue.value":t.system.talentValue.value+1}]),await this._updateAPs(a))}async _refundItemAdvance(e){let t=this.actor.items.get(e).toObject(),a=t.type=="combatskill"?6:0;if(t.system.talentValue.value>a){let s=g._calculateAdvCost(Number(t.system.talentValue.value),t.system.StF.value,0)*-1;await this.actor.updateEmbeddedDocuments("Item",[{_id:e,"system.talentValue.value":t.system.talentValue.value-1}]),await this._updateAPs(s)}}_checkMaximumPointAdvancement(e,t){let a=!1;switch(e){case"wounds":a=t<=this.actor.system.characteristics.ko.value;break;case"astralenergy":a=t<=(this.actor.system.characteristics[this.actor.system.guidevalue.magical]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue.magical].value*this.actor.system.energyfactor.magical);break;case"karmaenergy":a=t<=(this.actor.system.characteristics[this.actor.system.guidevalue.clerical]==null?0:this.actor.system.characteristics[this.actor.system.guidevalue.clerical].value*this.actor.system.energyfactor.clerical);break}return a||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),a}async _openLibrary(){game.dsa5.itemLibrary.render(!0)}async _configActor(){Je.buildDialog(this.actor)}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"library",icon:"fas fa-university",onclick:async()=>this._openLibrary()}),this.actor.isOwner&&(e.unshift({class:"actorConfig",icon:"fas fa-link",onclick:async()=>this._configActor()}),e.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:async t=>this._togglePlayerview(t)})),this.actor.system.canAdvance&&e.unshift({class:"locksheet",icon:`fas fa-${this.actor.system.sheetLocked.value?"":"un"}lock`,onclick:async t=>this._changeAdvanceLock(t)}),e}async _changeAdvanceLock(e){await this.actor.update({"system.sheetLocked.value":!this.actor.system.sheetLocked.value}),$(e.currentTarget).find("i").toggleClass("fa-unlock fa-lock")}async _checkEnoughXP(e){return await this.actor.checkEnoughXP(e)}async advanceWrapper(e,t,a){let i=$(e.currentTarget).find("i");i.hasClass("fa-spin")||(i.addClass("fa-spin fa-spinner"),await this[t](a),i.removeClass("fa-spin fa-spinner"))}playerViewEnabled(){return getProperty(this.actor.system,"playerView")}_togglePlayerview(e){this.actor.update({"system.playerView":!getProperty(this.actor.system,"playerView")})}showLimited(){return!game.user.isGM&&this.actor.limited||this.playerViewEnabled()}getTokenId(){return this.token?.id}rollDisease(e){let t=this.actor.items.get(e),a=this.actor.system.status.soulpower.max*-1,s=this.actor.system.status.toughness.max*-1;t.setupEffect(void 0,{rollMode:"gmroll",manualResistance:{SKModifier:a,ZKModifier:s}}).then(async i=>{let r=await t.itemTest(i);await this.actor.updateEmbeddedDocuments("Item",[{_id:t.id,"system.duration.resolved":r.result.duration}])})}async swapWeaponHand(e){let t=this._getItemId(e),a=this.actor.items.get(t);["Daggers","Fencing Weapons"].includes(game.i18n.localize(`LocalizedCTs.${a.system.combatskill.value}`))||await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.wrongGrip":!a.system.worn.wrongGrip}])}activateListeners(e){super.activateListeners(e);let t=d=>{this.actor.items.get(this._getItemId(d)).postItem()};e.find(".roll-disease").click(d=>this.rollDisease(this._getItemId(d))),se(e),e.find(".condition-edit").click(async d=>{(d.currentTarget.dataset.uuid?await fromUuid(d.currentTarget.dataset.uuid):this.actor.effects.get(d.currentTarget.dataset.id)).sheet.render(!0)}),e.find(".ch-collapse").click(d=>{$(d.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(d.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()}),e.find(".status-create").click(d=>{let u=$(d.currentTarget).closest(".statusEffectMenu").find("ul");u.fadeIn("fast",()=>{u.find("input").focus()})}),e.find(".statusEffectMenu ul").mouseleave(d=>$(d.currentTarget).fadeOut()),e.find(".roll-aggregated").mousedown(d=>this._handleAggregatedProbe(d)),e.find(".skill-select").mousedown(d=>{let u=this._getItemId(d),p=this.actor.items.get(u);d.button==0?this.actor.setupSkill(p,{},this.getTokenId()).then(f=>{this.actor.basicTest(f)}):d.button==2&&p.sheet.render(!0)}),e.find(".spell-select").mousedown(d=>{let u=this._getItemId(d),p=this.actor.items.get(u);d.button==0?this.actor.setupSpell(p,{},this.getTokenId()).then(f=>this.actor.basicTest(f)):d.button==2&&p.sheet.render(!0)}),e.find(".item-post").click(d=>t(d)),e.find(".item-dropdown").click(d=>{d.preventDefault(),$(d.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")}),e.find(".condition-show").mousedown(d=>{d.preventDefault();let u=d.currentTarget.dataset.id,p=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");if(d.button==0){let f=$(d.currentTarget).parents(".statusEffect").attr("data-origin");if(f)fromUuid(f).then(h=>h.sheet.render(!0));else{let h,w;p?(h=CONFIG.statusEffects.find(v=>v.id==p),w=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${h.id}"><img src="${h.icon}"/>${game.i18n.localize(h.name)}</a></b>: ${game.i18n.localize(h.description)}</div>`)):(h=this.actor.effects.find(v=>v.id==u),h&&(w=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${h.id}"><img src="${h.icon}"/>${game.i18n.localize(h.name)}</a></b>: ${game.i18n.localize(h.flags.dsa5.description)}</div>`)));let z=$(d.currentTarget).closest(".groupbox").find(".effectDescription");z.fadeOut("fast",function(){z.html(w).fadeIn("fast")})}}else d.button==2&&!d.currentTarget.dataset.locked&&this._deleteActiveEffect(u)}),e.on("click",".chat-condition",d=>Z.postStatus(d.currentTarget.dataset.id)),e.find(".money-change, .skill-advances").focusin(d=>{this.currentFocus=$(d.currentTarget).closest("[data-item-id]").attr("data-item-id")}),e.find(".item-edit").click(d=>{d.preventDefault();let u=this._getItemId(d);this.actor.items.get(u).sheet.render(!0)}),e.find(".showApplication").mousedown(d=>{if(d.preventDefault(),d.button==2)this._deleteItem(d);else{let u=this._getItemId(d);this.actor.items.get(u).sheet.render(!0)}}),e.find(".ch-value").click(d=>{d.preventDefault();let u=d.currentTarget.attributes["data-char"].value;this.actor.setupCharacteristic(u,{},this.getTokenId()).then(p=>this.actor.basicTest(p))}),e.find(".ch-status").click(d=>{d.preventDefault(),this.actor.setupDodge({},this.getTokenId()).then(u=>{this.actor.basicTest(u)})}),e.find(".ch-regenerate").click(d=>{d.preventDefault(),this.actor.setupRegeneration("regenerate",{},this.getTokenId()).then(u=>this.actor.basicTest(u))}),e.find(".ch-weaponless").click(d=>{d.preventDefault();let u=d.currentTarget.attributes["data-char"].value;this.actor.setupWeaponless(u,{},this.getTokenId()).then(p=>this.actor.basicTest(p))}),e.find(".ch-fallingDamage").click(d=>{d.preventDefault(),this.actor.setupFallingDamage({},this.getTokenId())}),e.find(".ch-rollCombat").click(d=>{d.preventDefault();let u=this._getItemId(d),p=d.currentTarget.dataset.mode,f=this.actor.items.get(u);this.actor.setupWeapon(f,p,{},this.getTokenId()).then(h=>this.actor.basicTest(h))});let a=d=>this._deleteItem(d);e.find(".cards .item").mouseenter(d=>{if(d.currentTarget.getElementsByClassName("hovermenu").length==0){let u=document.createElement("div");u.classList.add("hovermenu");let p=document.createElement("i");p.classList.add("fas","fa-times"),p.title=game.i18n.localize("SHEET.DeleteItem"),p.addEventListener("click",a,!1);let f=document.createElement("i");f.classList.add("fas","fa-comment"),f.title=game.i18n.localize("SHEET.PostItem"),f.addEventListener("click",t,!1),u.appendChild(f),u.appendChild(p),d.currentTarget.appendChild(u)}}),e.find(".cards .item").mouseleave(d=>{let u=d.toElement||d.relatedTarget;!u||u.parentNode==this||u==this||d.currentTarget.querySelectorAll(".hovermenu").forEach(p=>p.remove())});let s=this.actor.uuid;e.find(".actorDrag").each(function(d,u){u.setAttribute("draggable",!0),u.addEventListener("dragstart",p=>{let f={type:"Actor",uuid:s};p.dataTransfer.setData("text/plain",JSON.stringify(f))})}),e.find(".filterTalents").click(d=>{$(d.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(d.currentTarget).toggleClass("filtered")}),e.find(".charimg").mousedown(d=>{d.button==2&&g.showArtwork(this.actor,!0)}),ee.bindRollCommands(e);let i=d=>this._filterTalents($(d.currentTarget)),r=e.find(".talentSearch");r.keyup(d=>this._filterTalents($(d.currentTarget))),r[0]&&r[0].addEventListener("search",i,!1);let n=d=>this._filterConditions($(d.currentTarget)),o=e.find(".conditionSearch");o.keyup(d=>this._filterConditions($(d.currentTarget))),o[0]&&o[0].addEventListener("search",n,!1);let c=d=>this._filterGear($(d.currentTarget)),m=e.find(".gearSearch");m.keyup(d=>this._filterGear($(d.currentTarget))),m[0]&&m[0].addEventListener("search",c,!1),Xe(e,"img.charimg"),H.activateListeners(e,this.actor),this._bindKeepFieldsEnabled(e),this.isEditable&&(new ContextMenu(e,".item .withContext",[],{onOpen:this._onItemContext.bind(this)}),e.find(".startCharacterBuilder").click(()=>this.actor.setFlag("core","sheetClass","dsa5.DSACharBuilder")),e.find(".schipUpdate").click(d=>{d.preventDefault();let u=Number(d.currentTarget.getAttribute("data-val"));u==1&&$(this.form).find(".fullSchip").length==1&&(u=0),this.actor.update({"system.status.fatePoints.value":u})}),e.find(".swapWeaponHand").click(d=>this.swapWeaponHand(d)),e.find(".defenseToggle").click(()=>this.actor.update({"system.config.defense":!this.actor.system.config.defense})),e.find(".loadWeapon").mousedown(async d=>{let u=this._getItemId(d),p=this.actor.items.get(u).toObject();if(getProperty(p,"system.currentAmmo.value")==="")return;let f={_id:u};if(d.button==0){let h=p.type=="trait"?p.system.reloadTime.value:T.calcLZ(p,this.actor);f["system.reloadTime.progress"]=Math.min(p.system.reloadTime.progress+1,h)}else d.button==2&&(f["system.reloadTime.progress"]=0);await this.actor.updateEmbeddedDocuments("Item",[f])}),e.find(".chargeSpell").mousedown(async d=>{let u=this._getItemId(d),p=this.actor.items.get(u).toObject(),f=Number(p.system.castingTime.modified);d.button==0?p.system.castingTime.progress=Math.min(p.system.castingTime.progress+1,f):d.button==2&&(p.system.castingTime.progress=0,p.system.castingTime.modified=0),await this.actor.updateEmbeddedDocuments("Item",[p])}),e.find(".item-swapMag").click(async d=>{await this.actor.swapMag(this._getItemId(d))}),e.find(".ammo-selector").change(async d=>{d.preventDefault();let u=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:u,"system.currentAmmo.value":$(d.currentTarget).val()}])}),e.find(".item-toggle").click(d=>{let u=this._getItemId(d),p=this.actor.items.get(u).toObject();switch(p.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":this.actor.updateEmbeddedDocuments("Item",[{_id:u,"system.worn.value":!p.system.worn.value}]),U.playEquipmentWearStatusChange(p);break}}),e.find(".quantity-click").mousedown(d=>{let u=this._getItemId(d),p=this.actor.items.get(u).toObject();_.increment(d,p,"system.quantity.value",0),this.actor.updateEmbeddedDocuments("Item",[p])}),e.find(".status-add").mousedown(async d=>{let u=d.currentTarget.dataset.id;u=="custom"?I.createCustomEffect(this.actor):d.button==0?await this.actor.addCondition(u,1,!1,!1):d.button==2&&Ae.modifyEffectDialog(u,async(p,f)=>this.actor.addTimedCondition(p,1,!1,!1,f))}),e.find(".money-change").change(async d=>{let u=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:u,"system.quantity.value":Number(d.target.value)}])}),e.find(".skill-advances").change(async d=>{let u=this._getItemId(d);await this.actor.updateEmbeddedDocuments("Item",[{_id:u,"system.talentValue.value":Number(d.target.value)}])}),e.find(".advance-attribute").mousedown(d=>this.advanceWrapper(d,"_advanceAttribute",d.currentTarget.dataset.attr)),e.find(".refund-attribute").mousedown(d=>this.advanceWrapper(d,"_refundAttributeAdvance",d.currentTarget.dataset.attr)),e.find(".advance-item").mousedown(d=>this.advanceWrapper(d,"_advanceItem",this._getItemId(d))),e.find(".refund-item").mousedown(d=>this.advanceWrapper(d,"_refundItemAdvance",this._getItemId(d))),e.find(".advance-points").mousedown(d=>this.advanceWrapper(d,"_advancePoints",d.currentTarget.dataset.attr)),e.find(".refund-points").mousedown(d=>this.advanceWrapper(d,"_refundPointsAdvance",d.currentTarget.dataset.attr)),e.find(".rebuy-pc").mousedown(d=>this.advanceWrapper(d,"_rebuyPC",d.currentTarget.dataset.attr)),e.find(".refund-pc").mousedown(d=>this.advanceWrapper(d,"_refundPC",d.currentTarget.dataset.attr)),e.find(".onUseItem").mousedown(d=>this._onMacroUseItem(d)),e.find(".traditionPayCost").mousedown(d=>this._payAeSpecialAbilityCost(d)),e.find(".item-create").click(d=>this._onItemCreate(d)),e.find(".condition-toggle").mousedown(async d=>{let u=$(d.currentTarget).parents(".statusEffect").attr("data-id"),p=this.actor.effects.get(u);await p.update({disabled:!p.disabled})}),e.find(".condition-value").mousedown(async d=>{let u=$(d.currentTarget).parents(".statusEffect").attr("data-descriptor");d.button==0?await this.actor.addCondition(u,1,!1,!1):d.button==2&&await this.actor.removeCondition(u,1,!1)}),e.find(".item-delete").click(d=>this._deleteItem(d)),e.find(".tradition-delete").click(d=>this._deleteTraditionArtifact(d)),e.find(".selectTraditionartifact").click(()=>this.selectTraditionartifact()),e.find(".disableRegeneration").click(d=>{let p=`system.repeatingEffects.disabled.${d.currentTarget.dataset.type}`;this.actor.update({[p]:!getProperty(this.actor,p)})}))}_onItemContext(e){let t=this.actor.items.get($(e).closest(".item").attr("data-item-id"));!t||(ui.context.menuItems=this._getItemContextOptions(t),Hooks.call("dsa5.getItemContextOptions",t,ui.context.menuItems))}_getItemContextOptions(e){let t=[{name:"SHEET.EditItem",icon:"<i class='fas fa-edit fa-fw'></i>",callback:()=>e.sheet.render(!0)},{name:"SHEET.PostItem",icon:"<i class='fas fa-comment fa-fw'></i>",callback:()=>e.postItem()},{name:"SHEET.DuplicateItem",icon:"<i class='fas fa-copy fa-fw'></i>",callback:()=>this.handleItemCopy(e.toObject(),e.type)},{name:"SHEET.ConsumeItem",icon:"<i class='fas fa-wine-bottle fa-fw'></i>",condition:()=>e.type=="consumable",callback:()=>this.consumeItem(e)},{name:"SHEET.onUseEffect",icon:"<i class='fas fa-dice-six fa-fw'></i>",condition:()=>getProperty(e,"flags.dsa5.onUseEffect"),callback:()=>new J(e).executeOnUseEffect()},{name:"SHEET.DeleteItem",icon:"<i class='fas fa-trash fa-fw'></i>",callback:()=>this._itemDeleteDialog(e)},{name:"MERCHANT.exchange",icon:"<i class='fas fa-coins'></i>",condition:()=>y.equipmentCategories.has(e.type),callback:()=>this._startTrade(e)}];return(hasProperty(e,"system.worn.wearable")||["meleeweapon","rangeweapon","armor"].includes(e.type))&&t.push({name:"SHEET.EquipItem",icon:"<i class='fas fa-shield-alt fa-fw'></i>",callback:()=>e.update({"system.worn.value":!e.system.worn.value})}),Number(getProperty(e,"system.quantity.value"))>1&&t.push({name:"SHEET.SplitItem",icon:"<i class='fas fa-arrows-split-up-and-left fa-fw'></i>",callback:()=>this._splitItem(e)}),t}async _startTrade(e){new Qt(this.actor).render(!0)}_splitItem(e){let t=async a=>{let s=e.toObject();s.system.quantity.value=a,await this.actor.createEmbeddedDocuments("Item",[s],{render:!1}),await this.actor.updateEmbeddedDocuments("Item",[{_id:e.id,"system.quantity.value":e.system.quantity.value-a}])};Qe.create(game.i18n.localize("SHEET.SplitItem"),game.i18n.format("MERCHANT.splitItem",{name:e.name}),e.system.quantity.value-1,t,1,e.system.quantity.value-1)}_bindKeepFieldsEnabled(e){if(!this.isEditable){let t=e.find(".keepFieldsEnabled");for(let a of t){let s=a.dataset.attr,i=a.dataset.name;$(a).find(".editor").append(`<a data-attr="${s}" data-name="${i}" class="editor-edit"><i class="fas fa-edit"></i></a>`),$(a).find(".editor-edit").click(r=>this._openKeepFieldEditpage(r))}}}_openKeepFieldEditpage(e){let t=e.currentTarget.dataset.attr,a=e.currentTarget.dataset.name;new Et(this.actor.id,t,a).render(!0)}async _onMacroUseItem(e){let t=this.actor.items.get(this._getItemId(e));await new J(t).executeOnUseEffect()}async _payAeSpecialAbilityCost(e){let t=this.actor.items.get(this._getItemId(e)),a=Number(getProperty(t,"system.AsPCost"));if(!this.actor.applyMana(a,"AsP"))return;let i=game.i18n.format("CHATNOTIFICATION.paysTraditionAbility",{name:this.actor.name,ability:t.name,cost:a});e.button==2?ChatMessage.create(g.chatDataSetup(i,"gmroll")):ChatMessage.create(g.chatDataSetup(i))}_filterGear(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter(function(){return $(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async selectTraditionartifact(){!this.isEditable||new hs(this.actor).render(!0)}_deleteTraditionArtifact(e){if(!this.isEditable)return;this.actor.items.get(this._getItemId(e)).update({"system.isArtifact":!1})}_filterTalents(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.form).parent().find(".allTalents");a.find(".item, .table-header, .table-title").removeClass("filterHide"),a.addClass("showAll").find(".item").filter(function(){return $(this).find(".talentName").text().toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide"),t.length>0?(a.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),a.addClass("filterfull")):a.removeClass("filterfull")}}_filterConditions(e){if(e.val()!=null){let t=e.val().toLowerCase().trim(),a=$(this.form).find(".statusEffectMenu li:not(.search)");a.removeClass("filterHide"),a.filter(function(){return game.i18n.localize($(this).find("a").attr("data-tooltip")).toLowerCase().trim().indexOf(t)==-1}).addClass("filterHide")}}async _deleteActiveEffect(e){if(!this.isEditable)return;let t=this.actor.effects.find(a=>a.id==e);t&&(this.token?this.token.actor:this.actor)&&await this.actor.deleteEmbeddedDocuments("ActiveEffect",[t.id])}async _itemDeleteDialog(e){let t=game.i18n.format("DIALOG.DeleteItemDetail",{item:e.name}),a=await renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:t});await new Promise((s,i)=>{new Dialog({title:game.i18n.localize("DIALOG.deleteConfirmation"),content:a,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async()=>{await this._cleverDeleteItem(e.id),s(!0)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)})}async _deleteItem(e){if(!this.isEditable)return;let t=this._getItemId(e),a=this.actor.items.get(t);this._itemDeleteDialog(a)}async _cleverDeleteItem(e){let t=this.actor.items.get(e),a=[e];switch(t.type){case"advantage":case"disadvantage":await O.vantageRemoved(this.actor,t,!1);break;case"specialability":await N.abilityRemoved(this.actor,t,!1);break;case"blessing":case"magictrick":await this._updateAPs(-1,{},{render:!1});break;case"ritual":case"ceremony":case"liturgy":case"spell":{let s=0;for(let r=0;r<=t.system.talentValue.value;r++)s+=g._calculateAdvCost(r,t.system.StF.value,0);let i=this.actor.items.filter(r=>r.type=="spellextension"&&t.type==r.system.category&&t.name==r.system.source);i&&(s+=i.reduce((r,n)=>r+(Number(n.system.APValue.value)||0),0),a.push(...i.map(r=>r.id))),await this._updateAPs(s*-1,{},{render:!1})}break}await this.actor.deleteEmbeddedDocuments("Item",a)}_getItemId(e){return $(e.currentTarget).closest(".item").attr("data-item-id")}async _addMoney(e){let a=duplicate(this.actor.items.filter(s=>s.type=="money")).find(s=>s.name==e.name);a?(a.system.quantity.value+=e.system.quantity.value,await this.actor.updateEmbeddedDocuments("Item",[a])):await this.actor.createEmbeddedDocuments("Item",[e])}async _updateAPs(e,t={},a={}){await this.actor._updateAPs(e,t,a)}async _addVantage(e,t){O.needsAdoption(this.actor,e,t)}async _addSpecialAbility(e,t){N.needsAdoption(this.actor,e,t)}_onDragStart(e){let t=e.currentTarget;if(e.target.classList.contains("content-link"))return;let a;t.dataset.itemId&&(a=this.actor.items.get(t.dataset.itemId).toDragData(),t.dataset.mod&&(a.mod=t.dataset.mod)),t.dataset.id&&(a=this.actor.effects.get(t.dataset.id).toDragData()),a&&e.dataTransfer.setData("text/plain",JSON.stringify(a))}async _handleSpellExtension(e){if(!this.actor.items.find(a=>a.type==e.type&&a.name==e.name)){e=duplicate(e);let a=this.actor.items.find(s=>s.type==e.system.category&&s.name==e.system.source);if(!a)ui.notifications.error(game.i18n.format("DSAError.noSpellForExtension",{name:e.system.source,category:g.categoryLocalization(e.system.category),extension:e.name}));else{if(a.system.talentValue.value<e.system.talentValue){ui.notifications.error(game.i18n.localize("DSAError.talentValueTooLow"));return}let s=e.system.APValue.value;await this.actor.checkEnoughXP(s)&&(await this._updateAPs(s,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}}async _addSpellOrLiturgy(e){let t=this.actor.items.find(s=>s.type==e.type&&s.name==e.name),a;if(e=duplicate(e),!t){switch(e.type){case"spell":case"liturgy":case"ceremony":case"ritual":a=g._calculateAdvCost(0,e.system.StF.value,0);break;case"blessing":case"magictrick":a=1;break;case"magicalsign":a=e.system.APValue.value;break;default:return}await this.actor.checkEnoughXP(a)&&(await this._updateAPs(a,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[e]))}}async _addLoot(e){e=duplicate(e);let t=this.actor.items.find(a=>S.areEquals(e,a));return t?(await S.stackItems(t,e,this.actor))[0]:(this._tabs[0].active=="combat"&&e.system.worn&&(e.system.worn.value=!0),(await this.actor.createEmbeddedDocuments("Item",[e]))[0])}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some(t=>S.areEquals(e,t)))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async _addDemonMarkOrPatron(e){return await this._addUniqueItem(e)}async _addDisease(e){return e.system.duration.resolved="?",await this._addUniqueItem(e)}async handleItemCopy(e,t){e.name+=" (Copy)",this._manageDragItems(e,t)}async _addFullPack(e){let a=(await game.packs.get(e.name).getDocuments()).filter(s=>!this.actor.items.find(i=>i.type==s.type&&i.name==s.name));e.onlyType&&(a=a.filter(s=>s.type==e.onlyType)),await this.actor.createEmbeddedDocuments("Item",a.map(s=>s.toObject()))}async creatureDrop(e){game.dsa5.config.hooks.shapeshift?new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption")+": "+e.name,content:game.i18n.localize("DIALOG.whichFunction")+": "+e.name,default:"horse",buttons:{shapeshift:{icon:'<i class="fas fa-paw"></i>',label:game.i18n.localize("CONDITION.shapeshift"),callback:()=>{let t=game.dsa5.config.hooks.shapeshift;t.setShapeshift(this.actor,e),t.render(!0)}},horse:{icon:'<i class="fas fa-horse"></i>',label:game.i18n.localize("RIDING.horse"),callback:()=>{H.setHorse(this.actor,e)}}}}).render(!0):H.setHorse(this.actor,e)}async _manageDragItems(e,t){switch(t){case"disease":await this._addDisease(e);break;case"meleeweapon":case"rangeweapon":case"equipment":case"ammunition":case"armor":case"poison":case"consumable":case"plant":return await this._addLoot(e);case"disadvantage":case"advantage":await this._addVantage(e,t);break;case"specialability":await this._addSpecialAbility(e,t);break;case"money":await this._addMoney(e);break;case"ritual":case"ceremony":case"blessing":case"magictrick":case"liturgy":case"spell":case"magicalsign":await this._addSpellOrLiturgy(e);break;case"effectwrapper":await this._handleEffectWrapper(e);break;case"application":await this._handleApplication(e);break;case"spellextension":await this._handleSpellExtension(e);break;case"creature":this.creatureDrop(e);break;case"skill":case"imprint":case"essence":case"information":await this._addUniqueItem(e);break;case"patron":case"demonmark":await this._addDemonMarkOrPatron(e);break;default:ui.notifications.error(game.i18n.format("DSAError.canNotBeAdded",{item:e.name,category:game.i18n.localize(e.type)}))}}async _handleEffectWrapper(e){this.actor.createEmbeddedDocuments("ActiveEffect",e.effects.map(t=>(t.origin=null,t)))}async _handleLookup(e){let t=await g.findAnyItem(e.items);if(t){for(let a of e.items)if(a.count){let s=t.find(i=>i.name==a.name&&i.type==a.type);s?(s.system.quantity.value=a.count,a.qs&&a.type=="consumable"&&(s.system.QL=a.qs)):ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:a.type,name:a.name}))}await this.actor.createEmbeddedDocuments("Item",t)}else ui.notifications.error(game.i18n.format("DSAError.notFound",{category:thing.type,name:thing.name}))}async _handleApplication(e){e=duplicate(e),this.actor.items.find(a=>a.type==e.type&&a.name==e.name)||await this.actor.createEmbeddedDocuments("Item",[e])}async _handleRemoveSourceOnDrop(e){let t=e.parent;t&&t.isOwner&&await t.deleteEmbeddedDocuments("Item",[e._id])}async _onDropItemCreate(e){return e instanceof Array?this.actor.createEmbeddedDocuments("Item",e):await this._manageDragItems(e,e.type)}async _onDropActor(e,t){if(!this.actor.isOwner)return!1;let{item:a,typeClass:s,selfTarget:i}=await Pe(t,this.id,!1);if(!i)return await this._manageDragItems(a,s)}async _onDropActiveEffect(e,t){let a=await ActiveEffect.implementation.fromDropData(t);if(!this.actor.isOwner||!a||this.actor.uuid===a.parent?.uuid)return!1;let s=a.toObject();return s.origin=null,ActiveEffect.create(s,{parent:this.actor})}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;let a=await Item.implementation.fromDropData(t),s=a.toObject();_.obfuscateDropData(s,t.tabsinvisible);let i,r=!1,n=$(e.target).parents(".item");if(n&&y.equipmentCategories.has(a.type)){let c=n.attr("data-item-id");n.attr("data-category")=="bags"?c!=a.id&&(i=c):(n=this.actor.items.get(c),r=n&&hasProperty(a,"system.quantity.value")&&hasProperty(n,"system.quantity.value")&&S.areEquals(a,n))}let o=this.actor.uuid===a.parent?.uuid;if(o)if(e.ctrlKey)await this.handleItemCopy(s,a.type);else if(r)await n.update({"system.quantity.value":n.system.quantity.value+a.system.quantity.value},{render:!1}),await this.actor.deleteEmbeddedDocuments("Item",[a.id]);else if(i){let c={_id:a.id,"system.parent_id":i};a.system.worn&&a.system.worn.value&&(c["system.worn.value"]=!1),await this.actor.updateEmbeddedDocuments("Item",[c])}else y.equipmentCategories.has(a.type)&&await this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,system:{parent_id:0}}]);else{if(this._itemHasPrice(t)){let m=`${a.type=="consumable"?S.getSubClass(s.type).consumablePrice(s):Number(s.system.price.value)}`;if(m&&!await j.payMoney(this.actor,m,!0,!1))return;me(game.i18n.format("PAYMENT.pay",{actor:this.actor.name,amount:m})),U.playMoneySound()}await this._onDropItemCreate(s)}e.altKey&&!o&&y.equipmentCategories.has(a.type)&&await this._handleRemoveSourceOnDrop(a)}_itemHasPrice(e){return e.pay}},hs=class extends Application{constructor(e,t={}){super(t),this.actor=e}get template(){return"systems/dsa5/templates/actors/traditionPicker.html"}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:440,resizable:!0}),e}async getData(e){let t=await super.getData(e),a=this.actor.items.filter(s=>["equipment","armor","rangeweapon","meleeweapon"].includes(s.type));return mergeObject(t,{items:a}),t}activateListeners(e){super.activateListeners(e),e.find(".slot").click(async t=>{let a=this.actor.items.get(t.currentTarget.dataset.itemId);await a.update({"system.isArtifact":!a.system.isArtifact})})}};var ae=class extends Application{constructor(e){super(e),this.actor=null,this.errors=[],this.attributes=[],this.updating=!1}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","generationWizard"]),width:770,height:740}),e.resizable=!0,e}async findCompendiumItem(e,t){for(let a of t){let s=await game.dsa5.itemLibrary.findCompendiumItem(e,a);if(s=s.find(i=>i.name==e&&i.type==a&&i.system),s)return s}}_parseAttributes(e,t=","){let a=[],s=game.i18n.localize("combatskillcountdivider")+":";for(let i of e.split(t))if(i.includes(s)){let r=i.split(":");a.push({choices:r[1].split("/").map(n=>n.trim()),allowedCount:Number(r[0].match(/\d/g))})}return a}async parseToItem(e,t){return e.trim()==""?[]:await Promise.all(e.split(", ").map(async a=>{let s=g.parseAbilityString(a.trim()),i=await this.findCompendiumItem(s.original,t);if(i||(i=await this.findCompendiumItem(s.name,t)),i){let n=i.uuid;i=duplicate(i),i.uuid=n,i.tooltip=game.i18n.localize("Details"),i=Q.reverseAdoptionCalculation(this.actor,s,i),i.system.APValue&&(i.APunparseable=isNaN(i.system.APValue.value),i.apCost=i.APunparseable?i.system.APValue.value:s.step*Number(i.system.APValue.value))}else if(this.attributes.includes(s.name)){let n=0;for(let o=this.actor.system.characteristics[game.dsa5.config.knownShortcuts[s.name.toLowerCase()][1]].value+1;o<s.step+1;o++)n+=y.advancementCosts.E[o];i={name:s.name,step:s.step,attributeRequirement:!0,system:{APValue:{value:n}}}}else{console.warn(`Not found <${a}>`);let n=t.map(o=>g.categoryLocalization(o)).join("/");this.errors.push(`${n}: ${a}`),i={name:a.trim(),notFound:!0,tooltip:game.i18n.localize("DSAError.itemNotFound"),apCost:"?"}}i.replaceName=s.original,i.step=s.step;let r=this.actor.items.find(n=>t.includes(n.type)&&n.name==s.original)!=null;return i.disabled=r||i.notFound||i.APunparseable,r&&(i.tooltip=game.i18n.localize("YouAlreadyHaveit")),i}))}mergeLevels(e,t,a){let s=!1,i=e.find(r=>r.name==t.name&&r.type==t.type);if(i){s=!0;let r=Number(getProperty(t,"system.step.value"));r&&(i.system.step.value=Math.min(i.system.step.value+=r,i.system[a].value))}else e.push(t);return s}async addSelections(e,t=!0){let a=[];for(let s of e){if($(s).val()=="")continue;let r=(await fromUuid($(s).val())).toObject(),n=g.parseAbilityString(r.name);switch(r.name=$(s).attr("name"),r.type){case"advantage":case"disadvantage":r.system.step.value=Number(s.dataset.step),r=Q.reverseAdoptionCalculation(this.actor,n,r),this.mergeLevels(a,r,"max")||O.vantageAdded(this.actor,r);break;case"specialability":r.system.step.value=Number(s.dataset.step),s.dataset.free=="true"&&(r.system.APValue.value=0),r=Q.reverseAdoptionCalculation(this.actor,n,r),this.mergeLevels(a,r,"maxRank")||N.abilityAdded(this.actor,r);break;case"magictrick":this.mergeLevels(a,r);break}}await this.actor.createEmbeddedDocuments("Item",a,{render:t})}async fixPreviousCosts(e,t){for(let a of t){let s=e.find(i=>i.type==a.type&&i.name==a.name);s&&(a.apCost-=s.apCost)}}async alreadyAdded(e,t){if(e=="")return!1;let a=!1;return a=await new Promise((s,i)=>{new Dialog({title:game.i18n.localize("DIALOG.warning"),content:game.i18n.format("DIALOG.alreadyAddedCharacterpart",{category:g.categoryLocalization(t)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Ok"),default:!0,callback:()=>{s(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("Cancel"),default:!0,callback:()=>{s(!0)}}}}).render(!0)}),a}async updateSkill(e,t,a=1,s=!0){let i=[];for(let r of e){let n=g.parseAbilityString(r.trim()),o=this.actor.items.find(c=>c.type==t&&c.name==n.name);o?i.push({_id:o.id,"system.talentValue.value":Math.max(0,a*n.step+(s?Number(o.system.talentValue.value):0))}):(console.warn(`Could not find ${t} ${r}`),this.errors.push(`${g.categoryLocalization(t)}: ${r}`))}await this.actor.updateEmbeddedDocuments("Item",i,{render:!1})}async getData(e){let t=await super.getData(e);return await game.dsa5.itemLibrary.buildEquipmentIndex(),t}_validateInput(e,t=this){let a=/^exclusive_/;for(let s of e.find(".tab")){let i=$(s),r=new Set;for(let n of i.find(".exclusive"))r.add(n.className.split(/\s+/).filter(o=>a.test(o))[0]);for(let n of r){let o=i.find(".allowedCount_"+n.split("_")[1]),c=Number(o.attr("data-count"));if(i.find(`.${n}:checked`).length!=c)return this._showInputValidation(o,i,t),!1}}return!0}_showInputValidation(e,t,a){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices"));let s=e.closest(".tab").attr("data-tab");a.activateTab(s),ae.flashElem(t.find(`.tabs a[data-tab='${s}']`)),ae.flashElem(e.closest("div"))}activateListeners(e){super.activateListeners(e),se(e),e.find("button.ok").click(()=>{this.updating||(this.updating=!0,this.updateCharacter($(this._element)).then(()=>this.updating=!1))}),e.find("button.cancel").click(()=>{this.close()});let t=s=>{s.stopPropagation();let i=s.currentTarget.dataset.type,r=s.currentTarget.dataset.uuid;!r||!i||s.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:i,uuid:r}))},a=e.find(".show-item");a.click(async s=>{let i=s.currentTarget.dataset.uuid;(await fromUuid(i)).sheet.render(!0)}),a.attr("draggable",!0).on("dragstart",s=>t(s)),e.on("click",".searchableAbility a",s=>rt(s)),e.find(".exclusive").change(s=>{let i=$(s.currentTarget).closest(".tab"),r=$(s.currentTarget).attr("data-sel"),n=i.find(`.allowedCount_${r}`),o=Number(n.attr("data-count"));if(i.find(`.exclusive_${r}:checked`).length>o){s.currentTarget.checked=!1,ae.flashElem(n);return}})}static flashElem(e,t="emphasize"){e.addClass(t),setTimeout(function(){e.removeClass(t)},600)}finalizeUpdate(){this.errors.length==0?this.close():$(this._element).find(".dialog-buttons").html(`<div class="error"><p>${game.i18n.localize("DSAError.notUnderstood")}</p><ul><li>${this.errors.join("</li><li>")}</li></ul></div>`)}};var Ze=class extends ae{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")}`}),e.template="systems/dsa5/templates/wizard/add-culture-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content"),s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),ae.flashElem(i,"emphasize2")})}async getData(e){let t=await super.getData(e),a=await this.parseToItem(this.culture.system.recommendedAdvantages.value,["advantage"]),s=await this.parseToItem(this.culture.system.recommendedDisadvantages.value,["disadvantage"]),i=this.culture.system.writing.value==""?[]:await this.parseToItem(this.culture.system.writing.value.split(",").map(o=>`${game.i18n.localize("LocalizedIDs.literacy")} (${o.trim()})`).join(", "),["specialability"]),r=this.culture.system.language.value==""?[]:await this.parseToItem(this.culture.system.language.value.split(",").map(o=>`${game.i18n.localize("LocalizedIDs.language")} (${o.trim()}) 3`).join(", "),["specialability"]),n=Number(this.culture.system.APValue.value);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")} ${this.culture.name}`}),culture:this.culture,description:game.i18n.format("WIZARD.culturedescr",{culture:this.culture.name,cost:n}),advantages:a,disadvantages:s,writings:i,languages:r,advantagesToChose:a.length>0,disadvantagesToChose:s.length>0,writingsToChose:i.length>0,languagesToChose:r.length>0,languagesToSelect:r.length>1,vantagesToChose:a.length>0||s.length>0,generalToChose:i.length>0||r.length>0,enrichedClothing:await TextEditor.enrichHTML(getProperty(this.culture.system,"clothing.value"),{secrets:!1,async:!0}),enrichedDescription:await TextEditor.enrichHTML(getProperty(this.culture.system,"description.value"),{secrets:!1,async:!0})}),t}async addCulture(e,t){this.actor=e,this.culture=duplicate(t)}_validateInput(e,t=this){let a=e.find(".localKnowledge");if(a.val()=="")return this._showInputValidation(a,e,t),!1;let s=e.find(".selectOnlyOne");return s.length&&s.find(".optional:checked").length!=1?(this._showInputValidation(s,e,t),!1):super._validateInput(e,t)}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.culture.value,"culture")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.culture.value":this.culture.name},i=await this.findCompendiumItem(`${game.i18n.localize("LocalizedIDs.localKnowledge")} ()`,["specialability"]);i&&(i=duplicate(i),i.name=`${game.i18n.localize("LocalizedIDs.localKnowledge")} (${e.find(".localKnowledge").val()})`,i.system.APValue.value=0,await this.actor.createEmbeddedDocuments("Item",[i],{render:!1})),await this.addSelections(e.find(".optional:checked"),!1),await this.actor._updateAPs(a,{},{render:!1}),await this.updateSkill(this.culture.system.skills.value.split(","),"skill"),await this.actor.update(s),this.finalizeUpdate()}};var et=class extends ae{constructor(e){super(e),this.attributes=Object.keys(y.characteristics).map(t=>game.i18n.localize(`CHARAbbrev.${t.toUpperCase()}`))}static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.career")}`}),e.template="systems/dsa5/templates/wizard/add-career-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content");if($(t.currentTarget).hasClass("exclusiveTricks")){let r=Number(a.find(".maxTricks").attr("data-spelltricklimit"));if(a.find(".exclusiveTricks:checked").length>r){t.currentTarget.checked=!1,ae.flashElem(a.find(".maxTricks"));return}}let s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))}),a.find(".attributes:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),ae.flashElem(i,"emphasize2")})}_validateInput(e,t=this){let a=e.find(".maxTricks"),s=Number(a.attr("data-spelltricklimit"))||0;return e.find(".exclusiveTricks:checked").length!=s?(this._showInputValidation(a,e,t),!1):super._validateInput(e,t)}async getData(e){let t=await super.getData(e),a=await this.parseToItem(this.career.system.requirements.value,["disadvantage","advantage","specialability"]),s=a.filter(h=>["advantage","disadvantage"].includes(h.type)&&!h.disabled),i=await this.parseToItem(this.career.system.recommendedAdvantages.value,["advantage"]);this.fixPreviousCosts(a,i);let r=await this.parseToItem(this.career.system.recommendedDisadvantages.value,["disadvantage"]);this.fixPreviousCosts(a,r);let n=a.filter(h=>h.attributeRequirement),o=this._parseAttributes(this.career.system.combatSkills.value,/,|;/),c=this._parseAttributes(this.career.system.specialAbilities.value),m=this._parseAttributes(this.career.system.spells.value),d=this._parseAttributes(this.career.system.liturgies.value),u=Number(this.career.system.APValue.value),p=a.reduce(function(h,w){return h+(w.disabled?0:Number(w.system.APValue.value)||0)},0),f=a.filter(h=>h.type=="specialability"&&!h.disabled);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("career")} ${this.career.name}`}),career:this.career,description:game.i18n.format("WIZARD.careerdescr",{career:this.career.name,cost:u+p}),baseCost:u,advantages:i,disadvantages:r,missingVantages:s,specAbChoices:c,spellChoices:m,liturgyChoices:d,missingSpecialabilities:f,combatskillchoices:o,spelltricks:await this.parseToItem(this.career.system.spelltricks.value,["magictrick"]),attributeRequirements:n,advantagesToChose:i.length,disadvantagesToChose:r.length,vantagesToChose:i.length||r.length||s.length,missingVantagesToChose:s.length,missingSpecialabiltiesToChose:f.length,combatToChose:o.length,magicToChose:this.career.system.spelltrickCount.value||m.length,religionToChose:d.length,anyAttributeRequirements:n.length,generalToChose:f.length||n.length||c.length,enrichedClothing:await TextEditor.enrichHTML(getProperty(this.career.system,"clothing.value"),{secrets:!1,async:!0}),enrichedDescription:await TextEditor.enrichHTML(getProperty(this.career.system,"description.value"),{secrets:!1,async:!0})}),t}async addCareer(e,t){this.actor=e,this.career=duplicate(t)}async setAbility(e,t,a=[]){if(e.trim()=="")return;let s=[],i=[],r=game.i18n.localize("combatskillcountdivider")+":";for(let n of e.split(",").concat(a)){if(n.includes(r)||n=="")continue;let o=g.parseAbilityString(n.trim()),c=this.actor.items.find(m=>t.includes(m.type)&&m.name==o.original);if(c)c=duplicate(c),c.system.talentValue?c.system.talentValue.value=o.step:c.system.step&&(c.system.step.value=o.step),c=Q.reverseAdoptionCalculation(this.actor,o,c),i.push(c);else if(c=await this.findCompendiumItem(o.original,t),c||(c=await this.findCompendiumItem(o.name,t)),c)c=duplicate(c),c.name=o.original,c.system.talentValue?c.system.talentValue.value=o.step:c.system.step&&(c.system.step.value=o.step),c=Q.reverseAdoptionCalculation(this.actor,o,c),s.push(c);else{let m=t.map(d=>g.categoryLocalization(d)).join("/");this.errors.push(`${m}: ${n}`),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:m,name:n}))}}await this.actor.updateEmbeddedDocuments("Item",i,{render:!1}),await this.actor.createEmbeddedDocuments("Item",s,{render:!1})}async addBlessing(e,t){let a=[];for(let s of e){let i=s.trim();if(i=="")continue;let r=this.actor.items.find(n=>t==n.type&&n.name==i);r||(r=await this.findCompendiumItem(i,[t]),r?(r=duplicate(r),a.push(r)):(this.errors.push(`${g.categoryLocalization(t)}: ${s}`),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(t),name:i}))))}await this.actor.createEmbeddedDocuments("Item",a,{render:!1})}getExclusiveChoices(e,t){let a=[];for(let s of e.find(`${t}.exclusive:checked`))a.push($(s).val());return a}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.career.value,"career")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.career.value":this.career.name,"system.freeLanguagePoints.value":this.career.system.languagePoints.value};for(let r of e.find(".attributes")){let n=$(r).attr("data-attribute").toLowerCase();n=game.dsa5.config.knownShortcuts[n.toLowerCase()][1],Number(this.actor.system.characteristics[n].initial)+Number(this.actor.system.characteristics[n].advances)<Number($(r).val())&&(this.actor.canAdvance?s[`system.characteristics.${n}.advances`]=Number($(r).val())-Number(this.actor.system.characteristics[n].initial):s[`system.characteristics.${n}.initial`]=Number($(r).val()))}this.career.system.mageLevel.value!="mundane"&&(s[`system.guidevalue.${this.career.system.mageLevel.value}`]=this.career.system.guidevalue.value,s[`system.energyfactor.${this.career.system.mageLevel.value}`]=this.career.system.guidevalue.factor,s[`system.tradition.${this.career.system.mageLevel.value}`]=this.career.system.tradition.value,s[`system.feature.${this.career.system.mageLevel.value}`]=this.career.system.feature.value),this.career.system.mageLevel.value=="clerical"&&(s["system.happyTalents.value"]=this.career.system.happyTalents.value,await this.setAbility(this.career.system.liturgies.value,["liturgy","ceremony"],this.getExclusiveChoices(e,".liturgy")),await this.addBlessing(this.career.system.blessings.value.split(","),"blessing")),this.career.system.mageLevel.value=="magical"&&await this.setAbility(this.career.system.spells.value,["spell","ritual"],this.getExclusiveChoices(e,".spell")),await this.setAbility(this.career.system.specialAbilities.value,["specialability"],this.getExclusiveChoices(e,".specialability")),await this.actor._updateAPs(a,{},{render:!1}),await this.addSelections(e.find(".optional:checked"),!1),await this.updateSkill(this.career.system.skills.value.split(","),"skill");let i=this.career.system.combatSkills.value.split(",").concat(this.getExclusiveChoices(e,".combatskill")).filter(r=>!(r.includes(game.i18n.localize("combatskillcountdivider")+":")||r==""));await this.updateSkill(i,"combatskill",1,!1),await this.actor.update(s),this.finalizeUpdate()}};var tt=class extends ae{static get defaultOptions(){let e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")}`}),e.template="systems/dsa5/templates/wizard/add-species-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change(t=>{let a=$(t.currentTarget).closest(".content"),s=Number(a.attr("data-cost"));a.find(".optional:checked").each(function(){s+=Number($(this).attr("data-cost"))});let i=a.find(".apCost");i.text(s),ae.flashElem(i,"emphasize2")})}async _toGroups(e,t,a){return await Promise.all(e.split(`
`).map(async i=>{let r=i.split(":"),n;return r.length>1?n={name:r[0].trim(),res:await this.parseToItem(r[1].trim(),t)}:n={name:"",res:await this.parseToItem(i,t)},this.fixPreviousCosts(a,n.res),n}))}async getData(e){let t=await super.getData(e),a=await this.parseToItem(this.species.system.requirements.value,["disadvantage","advantage"]),s=a.filter(m=>["advantage","disadvantage"].includes(m.type)&&!m.disabled),i=await this._toGroups(this.species.system.recommendedAdvantages.value,["advantage"],a),r=await this._toGroups(this.species.system.recommendedDisadvantages.value,["disadvantage"],a),n=this._parseAttributes(this.species.system.attributeChange.value),o=Number(this.species.system.APValue.value),c=a.reduce(function(m,d){return m+(d.disabled?0:Number(d.system.APValue.value)||0)},0);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")} ${this.species.name}`}),species:this.species,description:game.i18n.format("WIZARD.speciesdescr",{species:this.species.name,cost:o+c}),advantagegroups:i,baseCost:o,disadvantagegroups:r,missingVantages:s,attributeRequirements:n,hasLocalization:game.i18n.has(`Racedescr.${this.species.name}`),anyAttributeRequirements:n.length>0,advantagesToChose:i.length>0,missingVantagesToChose:s.length>0,disadvantagesToChose:r.length>0,vantagesToChose:i.length>0||r.length>0||s.length>0,generalToChose:n.length>0}),t}async addSpecies(e,t){this.actor=e,this.species=duplicate(t)}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.species.value,"species")){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");return}let s={"system.details.species.value":this.species.name,"system.status.speed.initial":this.species.system.baseValues.speed.value,"system.status.soulpower.initial":this.species.system.baseValues.soulpower.value,"system.status.toughness.initial":this.species.system.baseValues.toughness.value,"system.status.wounds.initial":this.species.system.baseValues.wounds.value,"system.status.wounds.value":this.species.system.baseValues.wounds.value+this.actor.system.characteristics.ko.value*2},i=[];for(let r of e.find(".exclusive:checked"))i.push($(r).val());Object.keys(y.characteristics).forEach(r=>{s[`system.characteristics.${r}.species`]=0});for(let r of this.species.system.attributeChange.value.split(",").concat(i)){if(r.includes(game.i18n.localize("combatskillcountdivider")+":")||r=="")continue;let n=r.trim().split(" "),o=game.dsa5.config.knownShortcuts[n[0].toLowerCase().trim()].slice(0);o[o.length-1]="species",s[`system.${o.join(".")}`]=Number(n[1])}await this.actor._updateAPs(a,{},{render:!1}),await this.addSelections(e.find(".optional:checked"),!1),await this.actor.update(s),await this.actor.removeCondition("incapacitated"),this.finalizeUpdate()}};var ke=class extends Me{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","character-sheet"]),width:784}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/actor-sheet.html"}async _manageDragItems(e,t){switch(t){case"aggregatedTest":await this.actor.createEmbeddedDocuments("Item",[e]);break;case"species":let a=new tt;await a.addSpecies(this.actor,e),a.render(!0);break;case"culture":let s=new Ze;await s.addCulture(this.actor,e),s.render(!0);break;case"career":let i=new et;await i.addCareer(this.actor,e),i.render(!0);break;default:return super._manageDragItems(e,t)}}};var Ie=class extends Me{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","creature-sheet"])}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/creature-limited.html":"systems/dsa5/templates/actors/creature-sheet.html"}async getData(e){let t=await super.getData(e);return t.enrichedDescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"description.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedBehaviour=await TextEditor.enrichHTML(getProperty(this.actor.system,"behaviour.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedFlight=await TextEditor.enrichHTML(getProperty(this.actor.system,"flight.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedSpecialrules=await TextEditor.enrichHTML(getProperty(this.actor.system,"specialRules.value"),{secrets:this.object.isOwner,async:!0}),t}async _cleverDeleteItem(e){let t=this.actor.items.find(a=>a.id==e);switch(t.type){case"trait":await this._updateAPs(t.system.APValue.value*-1,{},{render:!1});break}await super._cleverDeleteItem(e)}async _addTrait(e){this.actor.items.find(a=>a.type=="trait"&&a.name==e.name)||(await this._updateAPs(e.system.APValue.value,{},{render:!1}),await le.traitAdded(this.actor,e),await this.actor.createEmbeddedDocuments("Item",[e]))}async _onDropItemCreate(e){return e.type=="trait"?this._addTrait(e):super._onDropItemCreate(e)}};var Ee=class extends ke{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","npc-sheet"])}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/npc-sheet.html"}};var Re=l=>class extends l{async obfuscateItem(e){e.stopPropagation(),e.preventDefault();let t=e.currentTarget.dataset.obfuscate;await this.item.update({[`system.obfuscation.${t}`]:!this.isObfuscated(t)})}isObfuscated(e){return getProperty(this.item,`system.obfuscation.${e}`)}activateListeners(e){super.activateListeners(e),e.on("click",".obfuscateSection",t=>this.obfuscateItem(t))}obfuscationCss(e){return this.isObfuscated(e)?"":" pale"}async _render(e=!1,t={}){await super._render(e,t);let a=["details","effects","description","enchantment"],s=!1;for(let i of a){let r=$(this._element).find(`nav [data-tab="${i}"]`);if(!r.length)continue;let n=t.tabsinvisible||this.isObfuscated(i),o=game.i18n.localize(`SHEET.${n?"deobfuscateItem":"obfuscateItem"}`);if(game.user.isGM){let c=`obfuscateSection${this.obfuscationCss(i)}`,m=r.find(`.${c}`),d=`<a data-tooltip="${o}" class="obfuscationBtn ${c}" data-obfuscate="${i}"><i class="fas fa-mask"></i></a>`;m.length?m.replaceWith(d):r.append(` ${d}`)}else n&&(r.hasClass("active")&&(s=!0),r.remove(),i=="details"&&$(this._element).find('[name="system.price.value"],[name="system.price.raw"]').replaceWith("<label>?</label>"))}if(s){let i=$(this._element).find("nav .item:first-child");if(i.length)this.activateTab(i.attr("data-tab"));else{let r=await renderTemplate("systems/dsa5/templates/items/obfuscatedItem.html",{item:this.item});$(this._element).find(".content").html(r)}}}};var V=class extends ItemSheet{_getSubmitData(e={}){let t=super._getSubmitData(e),a=foundry.utils.flattenObject(this.item.overrides||{});return Object.keys(a).forEach(s=>delete t[s]),t}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{tabs:[{navSelector:".tabs",contentSelector:".content"}],classes:e.classes.concat(["dsa5","item"]),width:471,height:500}),e}static setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsa5",V,{makeDefault:!0}),Items.registerSheet("dsa5",Ns,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsa5",Ms,{makeDefault:!0,types:["career"]}),Items.registerSheet("dsa5",Es,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsa5",_s,{makeDefault:!0,types:["advantage","disadvantage"]}),Items.registerSheet("dsa5",Ls,{makeDefault:!0,types:["ritual","ceremony","liturgy","spell"]}),Items.registerSheet("dsa5",Ps,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsa5",xs,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsa5",zs,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsa5",$s,{makeDefault:!0,types:["disease"]}),Items.registerSheet("dsa5",Is,{makeDefault:!0,types:["consumable"]}),Items.registerSheet("dsa5",Rs,{makeDefault:!0,types:["spellextension"]}),Items.registerSheet("dsa5",Os,{makeDefault:!0,types:["magictrick"]}),Items.registerSheet("dsa5",As,{makeDefault:!0,types:["blessing"]}),Items.registerSheet("dsa5",Ds,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsa5",ws,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsa5",vs,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsa5",ks,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsa5",Ts,{makeDefault:!0,types:["plant"]}),Items.registerSheet("dsa5",Cs,{makeDefault:!0,types:["magicalsign"]}),Items.registerSheet("dsa5",Ss,{makeDefault:!0,types:["patron"]}),Items.registerSheet("dsa5",bs,{makeDefault:!0,types:["information"]}),Items.registerSheet("dsa5",ys,{makeDefault:!0,types:["aggregatedTest"]}),Items.unregisterSheet("dsa5",V,{types:["armor","equipment","rangeweapon","blessing","magictrick","spellextension","consumable","aggregatedTest","species","career","culture","advantage","specialability","disadvantage","ritual","information","ceremony","liturgy","spell","disease","poison","meleeweapon","ammunition","plant","magicalsign","patron"]})}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".close").attr("data-tooltip","SHEET.Close"),$(this._element).find(".configure-sheet").attr("data-tooltip","SHEET.Configure"),$(this._element).find(".import").attr("data-tooltip","SHEET.Import"),$(this._element).find(".rolleffect").attr("data-tooltip","SHEET.RollEffect"),$(this._element).find(".showItemHead").attr("data-tooltip","SHEET.PostItem"),$(this._element).find(".consumeItem").attr("data-tooltip","SHEET.ConsumeItem"),$(this._element).find(".rollDamaged").attr("data-tooltip","DSASETTINGS.armorAndWeaponDamage"),$(this._element).find(".onUseEffect").attr("data-tooltip","SHEET.onUseEffect"),$(this._element).find(".postAsGroupCheck").attr("data-tooltip","SHEET.postAsGroupCheck")}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:async()=>this.item.postItem()}),this.item.actor&&J.getOnUseEffect(this.item)&&e.unshift({class:"onUseEffect",icon:"fas fa-dice-six",onclick:async()=>{new J(this.item).executeOnUseEffect()}}),e}setupEffect(e){this.item.setupEffect().then(t=>this.item.itemTest(t))}get template(){return`systems/dsa5/templates/items/item-${this.item.type}-sheet.html`}_getItemId(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}_advanceStep(){}_refundStep(){}async advanceWrapper(e,t){let s=$(e.currentTarget).find("i");s.hasClass("fa-spin")||(s.addClass("fa-spin fa-spinner"),await this[t](),s.removeClass("fa-spin fa-spinner"))}activateListeners(e){super.activateListeners(e),se(e),e.find(".advance-step").mousedown(a=>this.advanceWrapper(a,"_advanceStep")),e.find(".refund-step").mousedown(a=>this.advanceWrapper(a,"_refundStep")),e.find(".domainsPretty").click(a=>{$(a.currentTarget).hide(),$(a.currentTarget).next(".domainToggle").show()}),e.find('[data-edit="img"]').mousedown(a=>{a.button==2&&g.showArtwork(this.item)}),e.find(".status-add").click(()=>{I.createCustomEffect(this.item,"",this.item.name)}),e.find(".condition-show").mousedown(a=>{a.preventDefault();let s=a.currentTarget.dataset.id;a.button==0?this.item.effects.get(s).sheet.render(!0):a.button==2&&this.item.deleteEmbeddedDocuments("ActiveEffect",[s])}),e.find(".select2").select2(),e.find(".condition-toggle").mousedown(a=>{let s=$(a.currentTarget).parents(".statusEffect").attr("data-id"),i=this.item.effects.get(s);i.update({disabled:!i.disabled})}),e.find(".condition-edit").click(a=>{this.item.effects.get(a.currentTarget.dataset.id).sheet.render(!0)}),ee.bindRollCommands(e),I.bindButtons(e);let t=e.find(".item-header");if(t.length){let a=t.find("svg");if(a){new ResizeObserver(function(r){let n=r[0];ai(a,n.contentRect.width)}).observe(t.get(0));let i=t.find("input");i.get(0).disabled||(a.click(()=>{a.hide(),i.show(),i.focus()}),i.blur(function(){a.show(),i.hide()}))}}}async getData(e){let t=super.getData(e).data;switch(this.item.type){case"skill":t.characteristics=y.characteristics,t.skillGroups=y.skillGroups,t.skillBurdens=y.skillBurdens,t.hasLocalization=game.i18n.has(`SKILLdescr.${this.item.name}`),t.StFs=y.StFs;break;case"application":t.hasLocalization=game.i18n.has(`APPLICATION.${this.item.system.skill} - ${this.item.name}`),t.localization=game.i18n.localize(`APPLICATION.${this.item.system.skill} - ${this.item.name}`),t.allSkills=await g.allSkillsList();break;case"combatskill":t.weapontypes=y.weapontypes,t.guidevalues=y.combatskillsGuidevalues,t.hasLocalization=game.i18n.has(`Combatskilldescr.${this.item.name}`),t.StFs=y.StFs;break;case"trait":t.traitCategories=y.traitCategories,t.ranges=y.meleeRanges;break}if(t.isOwned=this.item.actor,t.editable=this.isEditable,t.isOwned){t.canAdvance=this.item.actor.canAdvance&&this._advancable();let a=getProperty(this.item,"flags.dsa5.customPriceTag");!this.isEditable&&a&&(t.customPrice=a)}return I.prepareActiveEffects(this.item,t),t.item=this.item,t.armorAndWeaponDamage=game.settings.get("dsa5","armorAndWeaponDamage"),t.isGM=game.user.isGM,t.enrichedDescription=await TextEditor.enrichHTML(getProperty(this.item.system,"description.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.item.system,"gmdescription.value"),{secrets:this.object.isOwner,async:!0}),t}_advancable(){return!1}},ys=class extends V{async getData(e){let t=await super.getData(e),a=this.item.getFlag("dsa5","embeddedItem"),s;return a&&(s=await renderTemplate(`systems/dsa5/templates/items/browse/${a.type}.html`,{document:a})),mergeObject(t,{allSkills:await g.allSkillsList(),embeddedItem:a,renderedItem:s,enrichedsuccess:await TextEditor.enrichHTML(this.item.system.success,{secrets:this.item.isOwner,async:!0}),enrichedpartsuccess:await TextEditor.enrichHTML(this.item.system.partsuccess,{secrets:this.item.isOwner,async:!0})}),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned||e.unshift({class:"postAsGroupCheck",icon:"fas fa-dice-d20",onclick:async()=>this.postAsGroupCheck()}),e}async postAsGroupCheck(){let e=["value","value2","value3"].filter(a=>this.item.system.talent[a]).map(a=>({type:"skill",modifier:this.item.system.baseModifier,calculatedModifier:this.item.system.baseModifier,target:this.item.system.talent[a]}));if(!e.length)return;let t={modifier:this.item.system.baseModifier,maxRolls:this.item.system.allowedTestCount.value,enrichedsuccess:await TextEditor.enrichHTML(this.item.system.success,{secrets:this.item.isOwner,async:!0}),enrichedpartsuccess:await TextEditor.enrichHTML(this.item.system.partsuccess,{secrets:this.item.isOwner,async:!0}),rollOptions:e};G.showGCMessage(e[0].target,0,t)}activateListeners(e){super.activateListeners(e),e.find(".buildItem").click(async()=>this.postFinishedItem())}async postFinishedItem(){if(!this.item.actor)return;let e=this.item.getFlag("dsa5","embeddedItem");if(!e)return;let t=await renderTemplate("systems/dsa5/templates/chat/production-result.html",{actor:this.item.actor,item:e,actorImg:F.videoOrImgTag(this.item.actor.img)}),a=g.chatDataSetup(t);a.flags={dsa5:{embeddedItem:e}},await ChatMessage.create(a)}},at=class extends V{async _onDrop(e){await this.enchant(e),this.isPoisonable&&await this.poison(e)}async enchant(e){let t=JSON.parse(e.dataTransfer.getData("text/plain"));await this._enchant([t])}async _enchant(e){let t=this.item.getFlag("dsa5","enchantments")||[];if(t.length+e.length>7)return ui.notifications.error(game.i18n.localize("DSAError.tooManyEnchants"));for(let a of e){let{item:s,typeClass:i,selfTarget:r}=await Pe(a,void 0,!1);if(["spell","liturgy","ceremony","ritual"].includes(i)){if(!s.pack)return ui.notifications.error(game.i18n.localize("DSAError.onlyCompendiumSpells"));let n={name:s.name,pack:s.pack,id:t.length,itemId:s.id,permanent:["liturgy","ceremony"].includes(i)||a.permanent,actorId:a.actorId,charged:!0,talisman:["liturgy","ceremony"].includes(i),fw:["liturgy","ceremony"].includes(i)?18:a.fw||0};t.push(n)}}if(t.length){let a={flags:{dsa5:{enchantments:t}}};await this.item.update(a)}}async poison(e){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:a,typeClass:s,selfTarget:i}=await Pe(t,void 0,!1);if(s=="poison"){let n={flags:{dsa5:{poison:{name:a.name,pack:a.pack,itemId:a._id,permanent:!1,actorId:t.actorId}}}};await this.item.update(n)}}toggleChargedState(e,t){for(let a of t)if(a.id==e){a.charged=a.talisman&&a.permanent?!0:!a.charged;break}this.item.update({flags:{dsa5:{enchantments:t}}})}activateListeners(e){super.activateListeners(e),e.find(".ench-toggle-permanent").click(t=>{let{id:a,enchantments:s}=this.enchantMentId(t);for(let i of s)if(i.id==a){i.permanent=!i.permanent;break}this.item.update({flags:{dsa5:{enchantments:s}}})}),e.find(".ench-toggle-charge").click(t=>{let{id:a,enchantments:s}=this.enchantMentId(t);this.toggleChargedState(a,s)}),e.find(".ench-roll").click(async t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=s.find(n=>n.id==a);if(!i.charged)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));let r=await this.getSpell(i);if(r){r=r.toObject(),r.system.talentValue.value=i.fw;let n=await g.emptyActor(14,this.item.name);n.setupSpell(r,{},"emptyActor").then(async o=>{let c=game.i18n.format("CHATNOTIFICATION.enchantmentUsed",{item:this.item.name,spell:r.name});await ChatMessage.create(g.chatDataSetup(c)),await n.basicTest(o),i.permanent?this.toggleChargedState(a,s):this.deleteEnchantment(a,s)})}}),e.find(".ench-fw").change(t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=Number($(t.currentTarget).val());if(!!i){for(let r of s)if(r.id==a){r.fw=i;break}this.item.update({flags:{dsa5:{enchantments:s}}})}}),e.find(".ench-delete").click(t=>{let{id:a,enchantments:s}=this.enchantMentId(t);this.deleteEnchantment(a,s)}),e.find(".ench-show").click(async t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=s.find(n=>n.id==a),r=await this.getSpell(i);r&&r.sheet.render(!0)}),e.find(".poison-toggle-permanent").click(t=>{this.item.update({flags:{dsa5:{poison:{permanent:!this.item.flags.dsa5.poison.permanent}}}})}),e.find(".poison-delete").click(t=>{this.deletePoison()}),e.find(".poison-show").click(async()=>{let t;this.item.actor&&(t=this.item.actor.items.find(a=>a.type=="poison"&&a.name==this.item.flags.dsa5.poison.name)),t||(t=await this.getSpell(this.item.flags.dsa5.poison)),t&&t.sheet.render(!0)})}deletePoison(){this.item.update({["flags.dsa5.-=poison"]:null})}deleteEnchantment(e,t){let a=t.findIndex(s=>s.id==e);t.splice(a,1),this.item.update({flags:{dsa5:{enchantments:t}}})}async getSpell(e){let t=await game.packs.get(e.pack);if(!t){ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound"));return}let a=await t.getDocument(e.itemId);if(!a){let s=await t.index.getName(e.name);s&&(a=await t.getDocument(s._id))}return a||ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),a}enchantMentId(e){return{id:$(e.currentTarget).parents(".statusEffect").attr("data-id"),enchantments:this.item.getFlag("dsa5","enchantments")}}prepareDomains(){let e=getProperty(this.item.system,"effect.attributes");if(e){let t=new RegExp(game.i18n.localize("WEAPON.magical"),"i"),a=new RegExp(game.i18n.localize("WEAPON.clerical"),"i");e=e.split(",").map(s=>{let i="";return t.test(s)?i="magical":a.test(s)&&(i="blessed"),`<li class="${i}">${s}</li>`}).join("")}return e}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{dragDrop:[{dragSelector:".item-list .item",dropSelector:".content"}]}),e}_canDragDrop(e){return this.isEditable}async getData(e){let t=await super.getData(e);t.enchantments=this.item.getFlag("dsa5","enchantments");let a=[];return t.poison=this.item.getFlag("dsa5","poison"),t.poison&&a.push("poison"),t.enchantments&&t.enchantments.some(s=>!s.talisman)&&a.push("enchantment"),t.enchantments&&t.enchantments.some(s=>s.talisman)&&a.push("talisman"),t.enchantmentLabel=a.map(s=>game.i18n.localize(s)).join("/"),t.traditionArtifacts=y.traditionArtifacts,t.hasEnchantments=t.poison||t.enchantments&&t.enchantments.length>0,t}},bs=class extends V{async getData(e){let t=await super.getData(e);return mergeObject(t,{allSkills:await g.allSkillsList(),enrichedqs1:await TextEditor.enrichHTML(this.item.system.qs1,{async:!0}),enrichedqs2:await TextEditor.enrichHTML(this.item.system.qs2,{async:!0}),enrichedqs3:await TextEditor.enrichHTML(this.item.system.qs3,{async:!0}),enrichedqs4:await TextEditor.enrichHTML(this.item.system.qs4,{async:!0}),enrichedqs5:await TextEditor.enrichHTML(this.item.system.qs5,{async:!0}),enrichedqs6:await TextEditor.enrichHTML(this.item.system.qs6,{async:!0}),enrichedCrit:await TextEditor.enrichHTML(this.item.system.crit,{async:!0}),enrichedBotch:await TextEditor.enrichHTML(this.item.system.botch,{async:!0}),enrichedFail:await TextEditor.enrichHTML(this.item.system.fail,{async:!0})}),t}},ks=class extends at{constructor(e,t){super(e,t),this.isPoisonable=!0}async getData(e){let t=await super.getData(e);return t.ammunitiongroups=y.ammunitiongroups,t.domains=this.prepareDomains(),t}},ws=class extends Re(at){async getData(e){let t=await super.getData(e);if(mergeObject(t,{equipmentTypes:y.equipmentTypes,domains:this.prepareDomains(),canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")}),this.isBagWithContents()){let a=0;mergeObject(t,{containerContent:this.item.actor.items.filter(s=>y.equipmentCategories.has(s.type)&&s.system.parent_id==this.item.id).map(s=>{s.system.preparedWeight=parseFloat((s.system.weight.value*s.system.quantity.value).toFixed(3)),a+=Number(s.system.preparedWeight);let i=getProperty(s,"flags.dsa5.enchantments");return i&&i.length>0?s.enchantClass="rar":(s.system.effect&&s.system.effect.value!=""||s.effects.length>0)&&(s.enchantClass="common"),s}),weightSum:parseFloat(a.toFixed(3)),weightWidth:`style="width: ${Math.min(this.item.system.capacity?a/this.item.system.capacity*100:0,100)}%"`,weightExceeded:a>Number(this.item.system.capacity)?"exceeded":""})}return t}async breakOverflow(e,t){let a=$(await renderTemplate("systems/dsa5/templates/items/baghover.html",e)),s=t.offset().top+52,i=t.offset().left-75;return a.appendTo($("body")),a.css({position:"absolute",left:i+"px",top:s+"px",bottom:"auto",right:"auto","z-index":1e4}),a}activateListeners(e){super.activateListeners(e);let t=e.find(".slot");t.mouseenter(async a=>{let s=$(a.currentTarget),i=await this.breakOverflow({name:s.attr("data-name"),weight:s.attr("data-weight"),quantity:s.attr("data-quantity")},s);i.fadeIn(),s.mouseleave(()=>{i.remove(),s.off("mouseleave")})}),t.mousedown(async a=>{let s=a.currentTarget.dataset.itemId,i=this.actor.items.get(s);a.button==0?i.sheet.render(!0):a.button==2&&($(".itemInfo").remove(),await i.update({"system.parent_id":0}),this.render(!0))})}isBagWithContents(){return this.item.actor&&getProperty(this.item,"system.equipmentType.value")=="bags"}async _onDrop(e){if(this.isBagWithContents()){let t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:a,typeClass:s,selfTarget:i}=await Pe(t,void 0),r=this.item.id==a.id,n=this.item.parent.id==t.actorId;if(y.equipmentCategories.has(s)&&!r){a.system.parent_id=this.item.id,a.system.worn&&a.system.worn.value&&(a.system.worn.value=!1),n?await this.item.actor.updateEmbeddedDocuments("Item",[a]):await this.item.actor.sheet._addLoot(a),this.render(!0);return}}await super._onDrop(e)}},vs=class extends Re(at){async getData(e){let t=await super.getData(e);return mergeObject(t,{domains:this.prepareDomains(),armorSubcategories:Object.keys(y.armorSubcategories),breakPointRating:y.armorSubcategories[this.item.system.subcategory]}),t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>q.breakingTest(this.item)}),e}},Ts=class extends Re(V){async getData(e){let t=await super.getData(e);return t.attributes=Object.keys(t.system.planttype).map(a=>({name:a,checked:t.system.planttype[a]})),t.enrichedEffect=await TextEditor.enrichHTML(getProperty(this.item.system,"effect"),{secrets:this.object.isOwner,async:!0}),t.enrichedRecipes=await TextEditor.enrichHTML(getProperty(this.item.system,"recipes"),{secrets:this.object.isOwner,async:!0}),t.enrichedInformation=await TextEditor.enrichHTML(getProperty(this.item.system,"infos"),{secrets:this.object.isOwner,async:!0}),t}},Ss=class extends V{async getData(e){let t=await super.getData(e);return t.patronCategories=[0,1,2,3].map(a=>({name:game.i18n.localize(`PATRON.${a}`),val:a})),t.priorities={0:game.i18n.localize("PATRON.primary"),1:game.i18n.localize("PATRON.secondary")},t}},Cs=class extends V{async getData(e){let t=await super.getData(e);return t.categories={1:game.i18n.localize("TYPES.Item.magicalsign"),2:game.i18n.localize("additionalsign")},t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async setupEffect(e){let t=Number(this.item.system.asp)||0;if(this.item.actor.system.status.astralenergy.value<t)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP"));let a=this.item.actor,s=game.dsa5.config.ItemSubclasses.magicalsign,i=a.items.find(n=>n.type=="skill"&&n.name==game.i18n.localize("LocalizedIDs.artisticAbility")),r=`<hr/><p><b>${this.item.name}</b></p><p>${this.item.system.description.value}</p><p>${s.chatData(this.item.system,"").join("</br>")} <span class="costCheck"></span></p>`;a.setupSkill(i,{other:[r],subtitle:` (${game.i18n.localize("TYPES.Item.magicalsign")})`},void 0).then(async n=>{let o=await a.basicTest(n,{suppressMessage:!0});o.result.preData.calculatedSpellModifiers={finalcost:t,costsMana:!0},await _DiceDSA5.renderRollCard(o.cardOptions,o.result,o.options.rerenderMessage)})}},Ds=class extends Re(at){_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>q.breakingTest(this.item)}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),ammunitiongroups:y.ammunitiongroups,combatskills:await g.allCombatSkillsList("range"),domains:this.prepareDomains(),breakPointRating:y.weaponStabilities[game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)]}),t}},As=class extends V{_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async setupEffect(e){if(this.item.actor.system.status.karmaenergy.value<1)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughKaP"));let t=game.dsa5.config.ItemSubclasses.magictrick;await this.item.actor.update({"system.status.karmaenergy.value":this.item.actor.system.status.karmaenergy.value-=1});let a=`<p><b>${this.item.name} - ${game.i18n.localize("blessing")} ${game.i18n.localize("probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(g.chatDataSetup(a))}},Ms=class extends V{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e),a=duplicate(y.characteristics);return a["-"]="-",t.mageLevels=y.mageLevels,t.guidevalues=a,t.enrichedClothing=await TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:this.object.isOwner,async:!0}),t}},Is=class extends Re(V){static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:480}),e}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"consumeItem",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.calculatedPrice=S.getSubClass(this.item.type).consumablePrice(this.item),t.availableSteps=t.system.QLList.split(`
`).map((a,s)=>s+1),t.equipmentTypes=y.equipmentTypes,t.enrichedIngredients=await TextEditor.enrichHTML(getProperty(this.item.system,"ingredients"),{secrets:this.object.isOwner,async:!0}),t}setupEffect(e){this.item.setupEffect()}},Es=class extends V{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){let t=await super.getData(e);return t.enrichedClothing=await TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:this.object.isOwner,async:!0}),t}},$s=class extends V{_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.resistances=y.magicResistanceModifiers,t}},Os=class extends V{_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async setupEffect(e){if(this.item.actor.system.status.astralenergy.value<1)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP"));let t=game.dsa5.config.ItemSubclasses.magictrick;await this.item.actor.update({"system.status.astralenergy.value":this.item.actor.system.status.astralenergy.value-=1});let a=`<p><b>${this.item.name} - ${game.i18n.localize("magictrick")} ${game.i18n.localize("probe")}</b></p><p>${this.item.system.description.value}</p><p>${t.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(g.chatDataSetup(a))}},xs=class extends Re(at){constructor(e,t){super(e,t),this.isPoisonable=!0}async getData(e){let t=await super.getData(e),a=mergeObject(duplicate(y.characteristics),{"ge/kk":game.i18n.localize("CHAR.GEKK"),["-"]:"-"}),s=_.regex2h.test(this.item.name),i="";if(!s)i="wrongGrip.yieldTwo";else switch(game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")).test(this.item.name)?i="wrongGrip.yieldOneBastard":i="wrongGrip.yieldOneSwordBlunt";break;default:i="wrongGrip.yieldOnePolearms"}if(mergeObject(t,{characteristics:a,twoHanded:s,wrongGripLabel:s?"wrongGrip.oneHanded":"wrongGrip.twoHanded",wrongGripHint:i,combatskills:await g.allCombatSkillsList("melee"),ranges:y.meleeRanges,shieldSizes:y.shieldSizes,isShield:_.isShield(this.item),domains:this.prepareDomains(),breakPointRating:y.weaponStabilities[game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)]}),this.item.actor){let r=this.item.actor.items.find(n=>n.type=="combatskill"&&n.name==this.item.system.combatskill.value);t.canBeOffHand=r&&!r.system.weapontype.twoHanded&&this.item.system.worn.value,t.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`))}return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>q.breakingTest(this.item)}),e}},zs=class extends Re(V){_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async t=>this.setupEffect(t)}),e}async getData(e){let t=await super.getData(e);return t.resistances=y.magicResistanceModifiers,t}},Ps=class extends V{async _refundStep(){if(this.item.system.step.value>1){let e=await N.stepXPCost(this.item,this.item.system.step.value-1);e=await N.refundFreelanguage(this.item,this.item.actor,e,!1),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value-1})}}async _advanceStep(){if(this.item.system.step.value<this.item.system.maxRank.value){let e=await N.stepXPCost(this.item,this.item.system.step.value);e=await N.isFreeLanguage(this.item,this.item.actor,e,!1),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value+1}))}}_advancable(){return this.item.system.maxRank.value>0}async getData(e){let t=await super.getData(e);return mergeObject(t,{categories:y.specialAbilityCategories,subCategories:y.combatSkillSubCategories,traditionArtifacts:y.traditionArtifacts,canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")}),t}},Ns=class extends V{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{width:530,height:570}),e}async getData(e){let t=await super.getData(e);return mergeObject(t,{hasLocalization:game.i18n.has(`Racedescr.${this.item.name}`)}),t}},Ls=class extends V{async getData(e){let t=await super.getData(e);return t.characteristics=y.characteristics,t.StFs=y.StFs,t.resistances=y.magicResistanceModifiers,t.targetTypes=y.areaTargetTypes,t.isOwned&&(t.extensions=this.item.actor.items.filter(a=>a.type=="spellextension"&&a.system.source==this.item.name&&this.item.type==a.system.category)),t}activateListeners(e){super.activateListeners(e),e.find(".item-edit").click(t=>{t.preventDefault();let a=this._getItemId(t);this.item.actor.items.get(a).sheet.render(!0)}),e.find(".item-delete").click(t=>{this._deleteItem(t)})}_deleteItem(e){let t=this._getItemId(e),a=this.actor.items.find(i=>i.id==t),s=game.i18n.format("DIALOG.DeleteItemDetail",{item:a.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:s}).then(i=>{new Dialog({title:game.i18n.localize("DIALOG.deleteConfirmation"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{this._cleverDeleteItem(t),$(e.currentTarget).closest(".item").remove()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)})}async _cleverDeleteItem(e){let t=this.item.actor.items.find(a=>a.id==e);await this.item.actor._updateAPs(-1*t.system.APValue.value,{},{render:!1}),await this.item.actor.deleteEmbeddedDocuments("Item",[e])}},Rs=class extends V{async getData(e){let t=await super.getData(e);return mergeObject(t,{categories:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}),t}},_s=class extends V{_advancable(){return this.item.system.max.value>0}async getData(e){let t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async _refundStep(){if(this.item.system.step.value>1){let e=await O.stepXPCost(this.item,this.item.system.step.value-1);e=await O.reduceSingularVantages(this.item.actor,this.item,e),await this.item.actor._updateAPs(e*-1,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value-1})}}async _advanceStep(){if(this.item.system.step.value<this.item.system.max.value){let e=await O.stepXPCost(this.item,this.item.system.step.value),t=duplicate(this.item);t.system.step.value+=1,e=await O.addSingularVantages(this.item.actor,t,e),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value+1}))}}};var Wi={"":"Modifier",defenseMalus:"MODS.defenseMalus",FW:"MODS.FW",KaPCost:"CHAR.KaPCost",AsPCost:"CHAR.AsPCost",FP:"MODS.FP",QL:"MODS.QS",dmg:"MODS.damage",damageBonus:"MODS.damage",armorPen:"MODS.armorPen",TPM:"MODS.partChecks"};function Ui(l,e){return`<span class="searchableAbility" data-category="${e}">`+l.split(",").map(t=>`<a>${t}</a>`).join(", ")+"<span>"}function di(l,e,t,a){if(a)return e.map(s=>`<span class="actorEmbeddedAbility" data-actor="${l.uuid}" data-id="${s._id}"><a>${s.name}${mi(getProperty(s.system,t),getProperty(s.system,a))}</a></span>`).join(", ");if(t){let s=[];for(let i of e){let r=getProperty(i.system,t);if(r){s.push(`<span class="actorEmbeddedAbility" data-actor="${l.uuid}" data-id="${i._id}"><a>${i.name} ${r}</a></span>`);continue}}return s.join(", ")}else return e.map(s=>`<span class="actorEmbeddedAbility" data-actor="${l.uuid}" data-id="${s._id}"><a>${s.name}</a></span>`).join(", ")}function Vi(l,e,t,a){let s=[];for(let i of Object.values(e)){if(i.length==0)continue;let r=di(l,i,t,a);r&&s.push(r)}return s.join(", ")}function mi(l,e){return e!=null&&Number(e)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][l-1]}function pi(){Handlebars.registerHelper({concatUp:(l,e)=>l+e.toUpperCase(),mod:(l,e)=>l%e,roman:(l,e)=>mi(l,e),isWEBM:l=>/.webm$/.test(l),itemCategory:l=>g.categoryLocalization(l),joinStr:(l,e)=>e.join(l),attrName:l=>g.attributeLocalization(l),attrAbbr:l=>g.attributeAbbrLocalization(l),diceThingsUp:(l,e)=>g.replaceDies(l,!1),clickableAbilities:(l,e)=>Ui(l,e),clickableActorItems:(l,e,t,a)=>di(l,e,t,a),clickableSection:(l,e,t,a)=>Vi(l,e,t,a),hasLocalization:(l,e)=>{let t=l.string||l;return game.i18n.has(t)?game.i18n.localize(t):e||""},replaceConditions:g.replaceConditions,floor:l=>Math.floor(Number(l)),sum:(l,e)=>l+e,br:l=>l.replace(/\n/g,"<br/>"),getAttr:(l,e,t)=>l.system.characteristics[e][t],hasElem:(l,e)=>l.some(t=>e==t),situationalTooltip:l=>{let e=game.i18n.localize(Wi[l.type]||"Modifier"),t=`${l.name}<br/>${e}: ${l.value}`;return l.source&&(t+=`<br/>${game.i18n.localize("source")}: ${l.source}`),t},grouped_each:(l,e,t)=>{let a="",s=[],i;if(e&&e.length>0){for(i=0;i<e.length;i++)i>0&&i%l===0&&(a+=t.fn(s),s=[]),s.push(e[i]);a+=t.fn(s)}return a},plantify:l=>game.i18n.localize(`PLANT.avLevels.${l||0}`),oddLength:l=>l.length%2==1})}function gi(){Hooks.once("init",()=>{game.dsa5.apps.DiceSoNiceCustomization=new _e}),Hooks.once("diceSoNiceReady",(l,e,t,a)=>{l.addColorset({name:"mu",description:"DSA5.mu",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"kl",description:"DSA5.kl",category:"DSA5.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"in",description:"DSA5.in",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ch",description:"DSA5.ch",category:"DSA5.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ff",description:"DSA5.ff",category:"DSA5.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ge",description:"DSA5.ge",category:"DSA5.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"ko",description:"DSA5.ko",category:"DSA5.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"kk",description:"DSA5.kk",category:"DSA5.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"attack",description:"DSA5.attack",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),l.addColorset({name:"dodge",description:"DSA5.dodge",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),l.addColorset({name:"parry",description:"DSA5.parry",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),game.dsa5.apps.DiceSoNiceCustomization.initConfigs(),_e.onConnect()})}var Fe=class extends Application{initConfigs(){let e=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(let[a,s]of Object.entries(e))mergeObject(this.choices,s);let t={damage:"black"};delete this.choices.custom,game.settings.registerMenu("dsa5","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("DSASETTINGS.dicesonicesettings"),type:Fs,restricted:!1});for(let a of Fe.attrs)game.settings.register("dsa5",`dice3d_${a}`,{name:`CHAR.${a.toUpperCase()}`,scope:"client",config:!1,default:t[a]||a,type:String}),game.settings.register("dsa5",`dice3d_system_${a}`,{name:`CHAR.${a.toUpperCase()}`,scope:"client",config:!1,default:"standard",type:String})}getAttributeConfiguration(e){return g.moduleEnabled("dice-so-nice")&&game.dice3d?{colorset:game.settings.get("dsa5",`dice3d_${e}`),appearance:{colorset:game.settings.get("dsa5",`dice3d_${e}`),system:game.settings.get("dsa5",`dice3d_system_${e}`)}}:{colorset:e}}activateListeners(e){super.activateListeners(),e.find('[name="entryselection"]').change(async t=>{await game.settings.set("dsa5",`dice3d_${t.currentTarget.dataset.attr}`,t.currentTarget.value)}),e.find('[name="systemselection"]').change(async t=>{await game.settings.set("dsa5",`dice3d_system_${t.currentTarget.dataset.attr}`,t.currentTarget.value),Fe.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}})})}static onConnect(){game.socket.on("system.dsa5",e=>{switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSA dice assets"),Fe.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":Fe.requestDicePreloads();break}}),this.collectPreloads(),game.socket.emit("system.dsa5",{type:"getPreloadDice3d"})}static collectPreloads(e=!0){let t=new Set;for(let a of Fe.attrs)t.add(game.settings.get("dsa5",`dice3d_system_${a}`));t=Array.from(t),e&&this.preloadDiceAssets(t),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:t})}static requestDicePreloads(){this.collectPreloads(!1)}static async preloadDiceAssets(e,t=[]){console.warn("loading",e);for(let a of e){let s=game.dice3d.DiceFactory.systems[a];if(!s){this.unloadedModels.push(a);continue}let i=s.dice.filter(r=>t.length==0||t.includes(r.type));for(let r of i)try{r.modelFile?await r.loadModel(game.dice3d.DiceFactory.loaderGLTF):await r.loadTextures()}catch{console.warn("Unable to load dice model",a,r)}}this.unloadedModels.length&&this.retries<6&&!this.retrying&&(this.retrying=!0,setTimeout(()=>{this.retries+=1;let a=new Set(this.unloadedModels);this.unloadedModels=[],this.retrying=!1,this.preloadDiceAssets(a)},1e4))}async getData(e){let t=await super.getData(e);t.choices=this.choices,t.systems=game.dice3d.DiceFactory.systems,t.selections={};for(let a of Fe.attrs)t.selections[a]={color:game.settings.get("dsa5",`dice3d_${a}`),system:game.settings.get("dsa5",`dice3d_system_${a}`)};return t}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{template:"systems/dsa5/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("DSASETTINGS.dicesonicesettings"),width:600}),e}},_e=Fe;R(_e,"unloadedModels",[]),R(_e,"retries",0),R(_e,"retrying",!1),R(_e,"attrs",["mu","kl","in","ch","ff","ge","ko","kk","attack","dodge","parry","damage"]);var Fs=class extends FormApplication{render(){game.dsa5.apps.DiceSoNiceCustomization.render(!0)}};function fi(){Hooks.on("preDeleteActiveEffect",(r,n,o)=>{if(n.noHook)return;let c=r.parent;if(c&&c.documentName=="Actor"&&getProperty(r,"flags.dsa5.maintain")){let m=[r._id],d=r.name.replace("("+game.i18n.localize("maintainCost")+")","").trim(),u=c.effects.filter(f=>f.name.startsWith(d)&&!f.origin&&f.id!=r._id),p=game.i18n.format("DIALOG.updateMaintainSpell",{actor:c.name});return u&&(p+=`<p>${game.i18n.localize("DIALOG.dependentMaintainEffects")}</p>`,p+=u.map(f=>`<p><label for="rel${f.id}">${f.name}</label><input class="effectRemoveSelector" checked type="checkbox" value="${f.id}" name="rel${f.id}"/></p>`).join("")),new Dialog({title:r.name,content:p,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("HELP.pay"),callback:async()=>{if(await c.applyMana(Number(getProperty(r,"flags.dsa5.maintain")),getProperty(r,"flags.dsa5.payType"))){let h={startTime:game.time.worldTime};game.combat&&(h.startRound=game.combat.round,h.startTurn=game.combat.turn),c.updateEmbeddedDocuments("ActiveEffect",[{_id:r._id,duration:h}])}}},delete:{icon:'<i class="fas fa-trash"></i>',label:game.i18n.localize("delete"),callback:f=>{for(let h of f.find(".effectRemoveSelector:checked"))m.push($(h).val());c.deleteEmbeddedDocuments("ActiveEffect",m,{noHook:!0})}}}}).render(!0),!1}}),Hooks.on("updateActor",(r,n)=>{!game.user.isGM&&r.limited&&hasProperty(n,"system.merchant.hidePlayer")&&ui.sidebar.render(!0)}),Hooks.on("deleteActiveEffect",(r,n)=>{if(!g.isActiveGM()||n.noHook)return;let o=r.parent;if(o&&o.documentName=="Actor"){let c=[...r.statuses][0];if(c=="bloodrush")return o.addCondition("stunned",2,!1,!1),!1;if(c=="dead"&&game.combat)return o.markDead(!1),!1;if(_DSAActiveEffectConfig.onEffectRemove(o,r),Hooks.call("deleteActorActiveEffect",o,r)===!1)return!1}}),Hooks.on("dropActorSheetData",(r,n,o)=>{switch(o.data?.type){case"condition":return r.addCondition(o.data.payload.id,1,!1,!1),!1;case"lookup":return n._handleLookup(o.data),!1;case"fullpack":return n._addFullPack(o.data),!1}}),Hooks.on("createActiveEffect",(r,n,o)=>{!g.isActiveGM()||(l(r),e(r))}),Hooks.on("deleteActiveEffect",(r,n,o)=>{!g.isActiveGM()||l(r)}),Hooks.on("updateActiveEffect",(r,n,o)=>{!g.isActiveGM()||(l(r),t(r))});function l(r){if(game.combat&&r.changes.some(n=>/(system\.status\.initiative|system\.characteristics.mu|system\.characteristics\.ge)/.test(n.key))){let n=r.parent.id,o=game.combat.combatants.find(c=>c.actor.id==n);o&&o.recalcInitiative()}}let e=async r=>{let n=r.parent;if(!n)return;await t(r,{},n);let o=[...r.statuses][0];o=="dead"&&game.combat?await n.markDead(!0):o=="unconscious"&&await n.addCondition("prone")},t=async(r,n={},o)=>{if(o||(o=r.parent),!o||o.documentName!="Actor")return;let c=/^system\.condition\./;for(let m of r.changes||[])c.test(m.key)&&m.mode==2&&(n[m.key.split(".")[2]]=Number(m.value));for(let m of Object.keys(n))if(o.system.condition[m]>=4&&(m=="inpain"?await o.initResistPainRoll(r):["encumbered","stunned","feared","confused","trance"].includes(m)?await o.addCondition("incapacitated"):m=="paralysed"?await o.addCondition("rooted"):["drunken","exhaustion"].includes(m)&&(await o.addCondition("stunned"),await o.removeCondition(m))),(Number(n.inpain)||0)>0&&!o.hasCondition("bloodrush")&&o.system.condition.inpain>0&&O.hasVantage(o,game.i18n.localize("LocalizedIDs.frenzy"))){await o.addCondition("bloodrush");let d=g.replaceConditions(`${game.i18n.format("CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+o.name+"</b>"})}`);ChatMessage.create(g.chatDataSetup(d))}},a=async(r,n)=>{(game.dsa5.apps.AskForNameDialog||Hs).getDialog(r,n)},s=async r=>{if(!!g.isActiveGM()&&game.settings.get("dsa5","randomWeaponSelection")&&r.actor.type!="character"){let n=[],o=[],c=[];for(let d of r.actor.items)d.type=="meleeweapon"&&d.system.worn.value?_.isShield(d)?o.push(d):n.push(d):d.type=="rangeweapon"&&d.system.worn.value&&c.push(d);let m=[];if(n.length){let d=n[Math.floor(Math.random()*n.length)],u=d._id,p;!_.regex2h.test(d.name)&&o.length&&(p=o[Math.floor(Math.random()*o.length)]._id);for(let f of n)f._id!=u&&m.push({_id:f._id,system:{worn:{value:!1}}});for(let f of o)f._id!=p&&m.push({_id:f._id,system:{worn:{value:!1}}})}if(c.length){let d=c[Math.floor(Math.random()*c.length)]._id;for(let u of c)u._id!=d&&m.push({_id:u._id,system:{worn:{value:!1}}})}m.length&&r.actor.updateEmbeddedDocuments("Item",m)}},i=async(r,n)=>{if(!g.isActiveGM())return;let o=r.actor;if(o.hasPlayerOwner)return;let c=Number(game.settings.get("dsa5","obfuscateTokenNames"));if(c==0||getProperty(o,"merchant.merchantType")=="loot")return;let m=canvas.scene.tokens.filter(u=>u.actor&&u.actor.id===o.id),d=game.i18n.localize("unknown");if([2,4].includes(c)){if(!(r.id||r._id))return;a(r,c);return}if(m.length>0&&c<3){let u=m.length;for(let p of m){let f=p.name.match(/\d+$/);f&&Number(f[0])>u&&(u=Number(f[0]))}d=`${m[0].name.replace(/ \d{1,}$/,"")} ${u+1}`}n.name=d};Hooks.on("updateToken",(r,n,o)=>{H.updateTokenHook(r,n,o)}),Hooks.on("deleteToken",r=>{H.deleteTokenHook(r),st.hide(r)}),Hooks.on("preCreateToken",(r,n,o,c)=>{let m=r.actor;if(!m)return;let d={};getProperty(m,"system.merchant.merchantType")=="loot"?mergeObject(d,{displayBars:0}):getProperty(m,"system.config.autoBar")&&(mergeObject(d,{bar1:{attribute:"status.wounds"}}),m.system.isMage?mergeObject(d,{bar2:{attribute:"status.astralenergy"}}):m.system.isPriest?mergeObject(d,{bar2:{attribute:"status.karmaenergy"}}):mergeObject(d,{bar2:{attribute:"tbd"}})),getProperty(m,"system.config.autoSize")&&g.calcTokenSize(m,d),i(r,d),r.updateSource(d)}),Hooks.on("createToken",(r,n,o)=>{n.noHook||(i(r,{}),s(r),H.createTokenHook(r,n,o))}),Hooks.on("hoverToken",(r,n)=>{!game.settings.get("dsa5","showWeaponsOnHover")||(n?st.show(r):st.hide(r))})}var st=class{static show(e){if(!game.combat||canvas.hud?.token?.rendered)return;let t=e.actor.items.filter(a=>a.type=="meleeweapon"||a.type=="rangeweapon"?a.system.worn.value:!1);if(t.length){let a=t.map(i=>`<img src="${i.img}" class="tinyHudIcons" title="${i.name}"/>`).join(" "),s=$(`<div id="hoverhud_${e.id}" style="position:absolute;">${a}</div>`);$("#hud").append(s),this.position(s,e,t.length)}}static position(e,t,a){let s=t.document,i=canvas.dimensions.size/100,r=a*43,n={width:r,height:42,left:t.center.x-r/2*i,top:t.y+s.height*canvas.dimensions.size+32};i!==1&&(n.transform=`scale(${i})`),e.css(n)}static hide(e){$(`#hoverhud_${e.id}`).remove()}},Hs=class extends Dialog{static async getDialog(e,t){new Dialog({title:game.i18n.localize("DSASETTINGS.obfuscateTokenNames"),content:`<label for="name">${game.i18n.localize("DSASETTINGS.rename")}</label> <input dtype="string" name="name" type="text" value="${e.actor.name}"/>`,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async a=>{let s=e.id||e._id,i=a.find('[name="name"]').val();if(t==2){let n=canvas.scene.tokens.filter(o=>o.name===i);if(n.length>0){let o=n.length;for(let c of n){let m=c.name.match(/\d+$/);m&&Number(m[0])>o&&(o=Number(m[0]))}i=`${n[0].name.replace(/ \d{1,}$/,"")} ${o+1}`}}await canvas.scene.tokens.get(s).update({name:i})}},unknown:{icon:'<i class="fa fa-question"></i>',label:game.i18n.localize("unknown"),callback:async()=>{let a=e.id||e._id;await canvas.scene.tokens.get(a).update({name:game.i18n.localize("unknown")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}};function hi(){Hooks.on("hotbarDrop",(l,e,t)=>{if(e.mod=="dodge"){let a={name:game.i18n.localize(e.mod),img:"systems/dsa5/icons/categories/Dodge.webp"},s;return game.user.isGM||e.actorId==null?s=`game.dsa5.macro.charMacro("${e.mod}")`:s=`game.dsa5.macro.charMacroById("${e.mod}", "${e.actorId}")`,Zt(s,a.name,a.img,t)}else if(e.mod=="attackWeaponless"||e.mod=="parryWeaponless"){let a={name:game.i18n.localize(e.mod),img:"systems/dsa5/icons/categories/attack_weaponless.webp"},s;return game.user.isGM||e.actorId==null?s=`game.dsa5.macro.weaponLessMacro("${e.mod}")`:s=`game.dsa5.macro.weaponLessMacroId("${e.mod}", "${e.actorId}")`,Zt(s,a.name,a.img,t)}else if(e.type=="Item"){let a=fromUuidSync(e.uuid);if(!["ritual","ceremony","meleeweapon","rangeweapon","skill","combatskill","spell","liturgy","char","trait"].includes(a.type)||(a.type=="meleeweapon"||a.type=="combatskill")&&!["attack","parry"].includes(e.mod))return;if((a.type=="rangeweapon"||a.type=="trait")&&!["attack"].includes(e.mod))return;let i=`{mod: "${e.mod}"}`,r;game.user.isGM||e.actorId==null?r=`game.dsa5.macro.itemMacro("${a.name}", "${a.type}", ${i});`:r=`game.dsa5.macro.itemMacroById("${e.actorId}", "${a.name}", "${a.type}", ${i})`;let n=e.mod==null?a.name:`${a.name} - ${game.i18n.localize("CHAR."+e.mod.toUpperCase())}`;return Zt(r,n,a.img,t)}else if(e.type=="Actor"||e.type=="JournalEntry"){let a=fromUuidSync(e.uuid),s=`(await fromUuid('${e.uuid}')).sheet.render(true)`;return Zt(s,a.name,a.img,t)}})}function Zt(l,e,t,a){let s=game.macros.contents.find(i=>i.name===e&&i.command===l);return s?game.user.assignHotbarMacro(s,a):Macro.create({name:e,type:"script",img:t,command:l},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,a)),!1}function yi(){Hooks.on("renderChatLog",(l,e,t)=>{F.chatListeners(e),_DiceDSA5.chatListeners(e),j.chatListeners(e);let a=new ee;Hooks.call("startDSA5ChatAutoCompletion",a),a.chatListeners(e),Z.chatListeners(e)}),Hooks.on("renderChatMessage",(l,e,t)=>{if(game.user.isGM)e.find(".chat-button-player").remove();else{e.find(".chat-button-gm").remove();let a,s=e.find(".chat-button-target");s.length&&(a=oe.getTargetActor(t.message),a&&a.actor&&!a.actor.isOwner&&s.remove());let i=g.getSpeaker(t.message.speaker);i&&!i.isOwner&&(e.find(".selfButton").remove(),e.find(".d20").attr("data-tooltip",""));let r=e.find(".onlyTarget");r.length&&(a=g.getSpeaker({token:r.attr("data-token"),actor:r.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}),a&&!a.isOwner&&r.remove()),e.find(".hideData").remove(),getProperty(t.message,`flags.dsa5.userHidden.${game.user.id}`)&&e.find(".payButton").remove()}game.settings.get("dsa5","expandChatModifierlist")&&(e.find(".expand-mods i").toggleClass("fa-minus fa-plus"),e.find(".expand-mods + ul").css({display:"block"})),I.bindButtons(e),e.find(".embeddedItemDrag").each(function(a,s){s.setAttribute("draggable",!0),s.addEventListener("dragstart",i=>Qi(i))})}),Hooks.on("chatMessage",(l,e,t)=>{let a=e.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(a=a?a[0]:"",a){case"/pay":return game.user.isGM?j.createPayChatMessage(e):j.payMoney(g.getSpeaker(t.speaker),e),!1;case"/getPaid":return game.user.isGM?j.createGetPaidChatMessage(e):j.getMoney(g.getSpeaker(t.speaker),e),!1;case"/help":return Z.getHelp(),!1;case"/conditions":return Z.showConditions(),!1;case"/tables":return Z.showTables(),!1}}),Hooks.on("preCreateChatMessage",(l,e,t,a)=>{if(getProperty(l,"flags.core.initiativeRoll")){let s=l.rolls[0].terms,i=`${s[0].number}`.split(".")[0],r=`${game.i18n.localize("baseValue")}: ${i}, ${game.i18n.localize("randomValue")}: ${s.at(-3).values[0]}")}`,n=[];for(let m of s)if(m.faces&&m.faces==6)for(let d=0;d<m.number;d++)n.push(`<span class="die-damage d${m.faces}">${m.results[d].result}</span>`);let c={content:`<div>
                <div class="card-content hide-option roll-result">
                    <b>${game.i18n.localize("Roll")}</b>: ${n.join("")}
                </div>
                <div class="card-content" data-tooltip="${r}">
                    <b>${game.i18n.localize("initiative")}</b>: ${Math.floor(l.rolls[0]._total*100)/100}
                </div>
            </div>`,flavor:void 0};l.updateSource(c)}})}function Qi(l){let e=$(l.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(e).getFlag("dsa5","embeddedItem"),s={type:"Item",data:a};l.dataTransfer.setData("text/plain",JSON.stringify(s))}var $e=class{static async firstTimeMessage(){if(!await game.settings.get("dsa5","firstTimeStart")){await $e.setupDefaultOptions();let e=game.i18n.localize("WELCOME");ChatMessage.create(g.chatDataSetup(e)),$e.firstTimeLanguage(),await game.settings.set("dsa5","firstTimeStart",!0)}}static firstTimeLanguage(){let e=["de","en"],t={title:game.i18n.localize("DIALOG.firstTime"),content:game.i18n.localize("DIALOG.firstTimeWarning"),default:"de",buttons:{}};for(let a of e)t.buttons[a]={label:game.i18n.localize(a),callback:()=>$e.setLanguage(a)};new Dialog(t).render(!0)}static async setLanguage(e){await game.settings.set("dsa5","firstTimeStart",!0),await game.settings.set("dsa5","forceLanguage",e),await game.settings.set("core","language",e),foundry.utils.debouncedReload()}static async setupDefaultOptions(){let e=game.settings.get("core",Combat.CONFIG_SETTING);e.skipDefeated=!0,await game.settings.set("core",Combat.CONFIG_SETTING,e),await game.settings.set("core","leftClickRelease",!0)}};var ut=class{static async stopFade(e){e.stopPropagation(),e.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(e.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click(()=>$(".didYouKnow").remove())):fetch(`systems/dsa5/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:a,fadeOut:ut.fadeOut});$("body").find(".didYouKnow").replaceWith(s),ut.activateListeners()})}static activateListeners(){$(".didYouKnow .stopFade").click(async e=>await this.stopFade(e)),$(".didYouKnow").click(()=>$(".didYouKnow").remove()),$(".didYouKnow").fadeIn()}static async showOneMessage(e=8e3){game.settings.get("dsa5","disableDidYouKnow")||fetch(`systems/dsa5/lazy/didyouknow/${game.i18n.lang}.json`).then(async t=>t.json()).then(async t=>{let a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:a,fadeOut:ut.fadeOut});$("body").append(s),this.activateListeners(),setTimeout(function(){ut.fadeOut&&$(".didYouKnow").fadeOut(1e3,()=>$(".didYouKnow").remove())},e)})}},He=ut;R(He,"fadeOut",!0);var we=class extends CombatTracker{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"/systems/dsa5/templates/system/combattracker.html"})}activateListeners(e){super.activateListeners(e),e.find(".combatant.actor .aggroButton").click(t=>{t.preventDefault(),t.stopPropagation(),we.runActAttackDialog()}),e.find("#combat-tracker").on("scroll.combattracker",debounce(function(t){let a=$(t.target),s=e.find(".combatant.active")[0].offsetTop;e.find(".aggroButton").animate({top:s-a.scrollTop()},50)},50)),e.find(".convertToBrawl").click(()=>game.combat.convertToBrawl())}static runActAttackDialog(){if(!game.combat)return;let e=game.combat.combatant;(game.user.isGM||e.isOwner)&&Le.showDialog(e.actor,e.tokenId)}async getData(e){let t=await super.getData(e);for(let a of t.turns){let s=t.combat.turns.find(n=>n.id==a.id),i=game.user.isGM||s.actor&&s.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects");a.defenseCount=s.getFlag("dsa5","defenseCount")||0,a.actionCount=Number(getProperty(s,"actor.system.actionCount.value"))||0,a.actionCounts=`${a.actionCount} ${game.i18n.localize("actionCount")}`;let r=[];if(s.actor){for(let n of s.actor.items)if(n.type=="rangeweapon"&&n.system.worn.value&&n.system.reloadTime.progress>0){let o={name:n.name,remaining:T.calcLZ(n,s.actor)-n.system.reloadTime.progress};o.remaining>0&&r.push(o)}else if(["spell","liturgy"].includes(n.type)&&n.system.castingTime.modified>0){let o={name:n.name,remaining:n.system.castingTime.modified-n.system.castingTime.progress};o.remaining>0&&r.push(o)}}r=r.sort((n,o)=>n.remaining-o.remaining),r.length>0&&(a.ongoings=`${game.i18n.localize("COMBATTRACKER.ongoing")}<br>${r.map(n=>`${n.name} - ${n.remaining}`).join("<br>")}`,a.ongoing=r[0].remaining),a.effects=new Set,s.token&&(s.token.effects.forEach(n=>a.effects.add(n)),s.token.overlayEffect&&a.effects.add(s.token.overlayEffect)),s.actor&&s.actor.temporaryEffects.forEach(n=>{n.statuses.has(CONFIG.Combat.defeatedStatusId)?a.defeated=!0:n.icon&&i&&!n.notApplicable&&(game.user.isGM||!n.getFlag("dsa5","hidePlayers"))&&!n.getFlag("dsa5","hideOnToken")&&a.effects.add(n.icon)})}return t.isBrawling=game.combat?.isBrawling,t}},pt=class extends Combat{constructor(e,t){super(e,t)}async refreshTokenbars(){game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}get isBrawling(){return this.getFlag("dsa5","isBrawling")}_onCreate(e,t,a){super._onCreate(e,t,a),this.refreshTokenbars()}_onDelete(e,t){super._onDelete(e,t),this.refreshTokenbars()}async convertToBrawl(e=void 0){let t=e??!this.isBrawling,a=[],s=[],i=[];if(t)for(let r of this.combatants){if(!r.actor)return{};let n=await r.brawlingChange();r.actor.isToken?await r.actor.update(n.actorChange):a.push(n.actorChange),s.push(...n.tokenChange),pt.brawlStart()}else for(let r of this.combatants){if(!r.actor)return{};let n=await r.undoBrawlingChange();r.actor.isToken?await r.actor.update(n.actorChange):a.push(n.actorChange),s.push(...n.tokenChange),n.damage.brawlDamage>0&&i.push({name:r.token.name,id:r.token.id,data:n.damage})}await T.updateDocuments(a),await game.canvas.scene.updateEmbeddedDocuments("Token",s),await this.setFlag("dsa5","isBrawling",t),i.length&&await this.showBrawlingDamage(i)}async showBrawlingDamage(e){let t=await renderTemplate("systems/dsa5/templates/chat/brawling-damage.html",{messages:e});ChatMessage.create(g.chatDataSetup(t))}static async brawlStart(e=2e3){$(".bumFight").remove();let t=await renderTemplate("systems/dsa5/templates/system/bumFight/animation.html",{});$("body").append(t);let a=$(".bumFight");a.click(()=>a.remove()),a.addClass("fight"),setTimeout(function(){a.fadeOut(1e3,()=>a.remove())},e)}async nextRound(){if(game.user.isGM)for(let e of this.turns)await e.setFlag("dsa5","defenseCount",0);else await game.socket.emit("system.dsa5",{type:"clearCombat",payload:{}});return await super.nextRound()}async getDefenseCount(e){let t=this.getCombatantFromActor(e);return t&&t.getFlag("dsa5","defenseCount")||0}getCombatantFromActor(e){let t;return e.token?t=Array.from(this.combatants).find(a=>a.tokenId==e.token):t=Array.from(this.combatants).find(a=>a.actorId==e.actor),t?this.combatants.get(t.id):void 0}async updateDefenseCount(e){if(game.user.isGM){let t=this.getCombatantFromActor(e);t&&!getProperty(t.actor,"system.config.defense")&&await t.setFlag("dsa5","defenseCount",(t.getFlag("dsa5","defenseCount")||0)+1)}else await game.socket.emit("system.dsa5",{type:"updateDefenseCount",payload:{speaker:e}})}},ea=class extends Combatant{constructor(e,t){e.flags==null&&(e.flags={}),mergeObject(e.flags,{dsa5:{defenseCount:0}}),super(e,t)}brawlingChange(){let e=g.getSpeaker({actor:this.actor.id,scene:this.sceneId,token:this.token.id}),t=getProperty(e,"system.config.autoBar")?e.getActiveTokens().map(s=>({_id:s.id,bar1:{attribute:"status.temporaryLeP"}})):[],a={_id:e.id,system:{status:{temporaryLeP:{value:e.system.status.wounds.value,max:e.system.status.wounds.value}}}};return{tokenChange:t,actorChange:a}}async getBrawlingTable(){if(!this.brawlingTable){let t=(await game.packs.get(game.i18n.lang=="de"?"dsa5.patzer":"dsa5.botch").getDocuments({name__in:[game.i18n.lang=="de"?"Pr\xFCgelei - Verletzungen":"Brawling - Injuries"]}))[0];this.brawlingTable=t}return this.brawlingTable}async undoBrawlingChange(){let e=g.getSpeaker({actor:this.actor.id,scene:this.sceneId,token:this.token.id}),t=getProperty(e,"system.config.autoBar")?e.getActiveTokens().map(n=>({_id:n.id,bar1:{attribute:"status.wounds"}})):[],a=Math.max(0,e.system.status.temporaryLeP.max-e.system.status.temporaryLeP.value),s=0,i;if(a>0){i=await(await this.getBrawlingTable()).draw({displayChat:!1}),i=i.results[0];let n=i.getFlag("dsa5","brawlDamage");s=Math.round(a*n)}let r={_id:e.id,system:{status:{temporaryLeP:{value:0,max:0},wounds:{value:e.system.status.wounds.value-s}}}};return{tokenChange:t,actorChange:r,damage:{brawlDamage:s,result:i}}}async recalcInitiative(){if(this.initiative){let t={initiative:(await this.getFlag("dsa5","baseRoll")||0)+this.actor.system.status.initiative.value};await this.update(t)}}};Hooks.on("preCreateCombatant",(l,e,t)=>{let a=g.getSpeaker({actor:l.actorId,scene:l.sceneId,token:l.tokenId});if(getProperty(a.system,"merchant.merchantType")=="loot")return!1;if(l.combat.isBrawling){let s=l.brawlingChange();delete s.actorChange._id,a.update(s.actorChange).then(()=>{game.canvas.scene.updateEmbeddedDocuments("Token",s.tokenChange)})}});Hooks.on("deleteCombatant",(l,e,t)=>{let a=g.getSpeaker({actor:l.actorId,scene:l.sceneId,token:l.tokenId});if(getProperty(a.system,"merchant.merchantType")=="loot")return!1;l.combat.isBrawling&&l.undoBrawlingChange().then(async s=>{!l.token||(delete s.actorChange._id,await a.update(s.actorChange),await game.canvas.scene.updateEmbeddedDocuments("Token",s.tokenChange),s.damage.brawlDamage>0&&l.combat.showBrawlingDamage([{name:l.token.name,id:l.token.id,data:s.damage}]))})});Hooks.on("preDeleteCombat",(l,e,t)=>{if(!e.noHook&&l.isBrawling)return l.convertToBrawl(!1).then(()=>{l.delete({noHook:!0})}),!1});Hooks.on("updateCombatant",(l,e,t)=>{if(!!game.user.isGM)if(e.initiative){if(!l.getFlag("dsa5","baseRoll")){let s=`${e.initiative}`.split("."),i=Number(s[0])-Math.round(l.actor.system.status.initiative.value);l.setFlag("dsa5","baseRoll",i)}}else"initiative"in e&&e.initiative==null&&l.update({["flags.dsa5.-=baseRoll"]:null})});var $t=class{static async updateCombatHook(e,t,a,s){!t.round&&!t.turn||e.round!=0&&e.turns&&e.active&&e.previous.round<e.current.round&&await $t.startOfRound(e)}static async startOfRound(e){let t=game.users.find(a=>a.active&&a.isGM);if(!!(t&&game.user.id==t.id)){for(let a of e.turns)if(!a.defeated){for(let s of a.actor.effects){if(s.disabled)continue;let i=[...s.statuses][0];i=="bleeding"?await this.applyBleeding(a,e):i=="burning"&&await this.applyBurning(a,s,e)}await this.startOfRoundEffects(a,e)}}}static async startOfRoundEffects(e,t){let a=["wounds","astralenergy","karmaenergy"];for(let s of a){if(getProperty(e.actor.system.repeatingEffects,`disabled.${s}`))continue;let i=e.actor.system.repeatingEffects.startOfRound[s].map(m=>m.value).join("+");if(!i)continue;let r=await new Roll(i).evaluate({async:!0}),n=await r.render(),o=game.i18n.localize(r.total>0?"CHATNOTIFICATION.regenerates":"CHATNOTIFICATION.getsHurt"),c=`${this.buildActorName(e)} ${o} ${game.i18n.localize(s)} ${n}`;await this.sendEventMessage(c,t,e),s=="wounds"?await e.actor.applyDamage(r.total*-1):await e.actor.applyMana(r.total*-1,s=="astralenergy"?"AsP":"KaP")}}static async applyBleeding(e,t){if(e.actor.system.status.wounds.value<1)return;let a=game.i18n.format("CHATNOTIFICATION.bleeding",{actor:this.buildActorName(e)});await this.sendEventMessage(a,t,e),await e.actor.applyDamage(1)}static async applyBurning(e,t,a){if(e.actor.system.status.wounds.value<1)return;let s=Number(t.getFlag("dsa5","value")),i=I.resistantToEffect(e.actor,t),r={0:"1",1:"1d3",2:"1d6",3:"2d6"}[s-i]||"1",n=await new Roll(r).evaluate({async:!0}),o=await n.render(),c=game.i18n.format(`CHATNOTIFICATION.burning.${s}`,{actor:this.buildActorName(e),damage:o});await this.sendEventMessage(c,a,e),await e.actor.applyDamage(n.total)}static buildActorName(e){let t=e.token.name;return game.settings.get("dsa5","hideRegenerationToOwner")&&e.token.name!=e.token.actor.name&&(t+=` (${e.token.actor.name})`),e.token.actor.toAnchor({name:t}).outerHTML}static async sendEventMessage(e,t,a){if(game.settings.get("dsa5","hideRegenerationToOwner")){let s=t.combatants.get(a.id).players;s.push(...game.users.filter(r=>r.isGM).map(r=>r.id));let i=g.chatDataSetup(e,void 0,void 0,s);delete i.speaker,await ChatMessage.create(i)}else await ChatMessage.create(g.chatDataSetup(e))}};Hooks.on("updateCombat",$t.updateCombatHook);var Oe=class extends Application{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","initTracker"]),template:"systems/dsa5/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"DSAIniTracker",itemWidth:game.settings.get("dsa5","iniTrackerSize"),actorCount:game.settings.get("dsa5","iniTrackerCount"),position:game.settings.get("dsa5","iniTrackerPosition")}),e}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){let r=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),n=this.element[0];if(!n.style.width||a){let o=a||n.offsetWidth,c=n.style.maxWidth||window.innerWidth;r.width=a=Math.clamped(o,0,c),n.style.width=a+"px",a+r.left>window.innerWidth&&(e=r.left)}return game.settings.set("dsa5","iniTrackerPosition",{left:r.left,top:r.top}),r}static connectHooks(){Hooks.on("renderDSA5CombatTracker",(e,t,a)=>{!game.settings.get("dsa5","enableCombatFlow")||(game.combat?(game.dsa5.apps.initTracker||(game.dsa5.apps.initTracker=new Oe),game.dsa5.apps.initTracker.updateTracker(a)):game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0))})}updateTracker(e){this.combatData=e,this.render(!0,{focus:!1})}async getData(e){let t=this.combatData,a=Oe.defaultOptions.itemWidth,s=Oe.defaultOptions.actorCount,i=t.round,r=t.turns,n=[],o=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,c=r.some(d=>d.active),m=t.turns.some(d=>d.owner&&!d.hasRolled&&(!game.user.isGM||t.combat.combatants.get(d.id).isNPC));if(r.length){let d=[],u=s,p=!1,f=-1,h=0,w=0,z;for(;!(u==0||w==s);){let v=duplicate(r[h]),L=t.combat.combatants.get(v.id);p&&h==f&&(v.css=v.css.replace("active","")),!i||v.active&&!p||!c&&!p?(p=!0,f=h):L.getFlag("dsa5","waitInit")==t.round+w&&!L.defeated&&(game.user.isGM||!L.hidden)&&n.push(v),p&&!(o&&L.defeated)&&(game.user.isGM||!L.hidden)&&(v.round=t.round+w,v.owner&&L.token?.actor&&(v.maxLP=L.token.actor.system.status.wounds.max,v.currentLP=L.token.actor.system.status.wounds.value),z&&z!=v.round&&(v.newRound="newRound"),z=v.round,d.push(v),u--),h++,h>=r.length&&(h=0,w++)}t.turns=d}return t.isLastRound=t.turns[1]?.newRound,this.position.width=a*s+s*3+80,this.position.height=a+10,mergeObject(t,{itemWidth:a,unRolled:m,waitingTurns:n}),this.conditionalPanToCurrentCombatant(t),t}hasChangedTurn(e){let t=e.turn!=this.lastTurnUpdate||e.round!=this.lastRoundUpdate;return this.lastTurnUpdate=e.turn,this.lastRoundUpdate=e.round,t}async conditionalPanToCurrentCombatant(e){if(!game.settings.get("dsa5","enableCombatPan"))return;let t=e.turns[0];if(!t)return;let a=e.combat.combatants.get(t.id);!a||!this.hasChangedTurn(e)||setTimeout(()=>{let s=a.token;!s||!s.object||!s.object.isVisible||(canvas.animatePan({x:s.x,y:s.y}),!(!a.actor||!a.actor.isOwner)&&s.object.control({releaseOthers:!0}))},300)}async _onWheelResize(e){let t=game.settings.get("dsa5","iniTrackerSize");e.originalEvent.deltaY>0?t=Math.min(140,t+5):t=Math.max(30,t-5),await game.settings.set("dsa5","iniTrackerSize",t),await this.render(!0)}activateListeners(e){super.activateListeners(e);let t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",async s=>(s.stopPropagation(),s.preventDefault(),await this._onWheelResize(s),!1)),e.find(".toggleTracker").click(()=>{let s=ui.combat;s.renderPopout(s)}),e.find(".combat-control").click(s=>this._onCombatControl(s)),e.find(".convertToBrawl").click(s=>{game.combat?.convertToBrawl()});let a=e.find(".iniItem");a.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),a.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown(s=>this._onRightClick(s)),e.find(".combatant-control").click(s=>this._onCombatantControl(s)),e.find(".combatant .aggroButton").click(s=>{s.preventDefault(),s.stopPropagation(),we.runActAttackDialog()}),e.find(".rollMine").click(s=>this.rollMyChars()),game.user.isGM&&e.find(".rolledInit").click(s=>this.editCombatant(s))}rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}_onRightClick(e){if(e.button==2){let t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsa5","waitInit")}}editCombatant(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}_onCombatantControl(e){this._getCombatApp()._onCombatantControl(e)}_onCombatControl(e){e.currentTarget.dataset.control=="waitInit"?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}async waitInit(e){await game.combat.combatants.get(game.combat.current.combatantId).setFlag("dsa5","waitInit",game.combat.current.round),e.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(e)}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onCombatantMouseDown(e){this._getCombatApp()._onCombatantMouseDown(e)}_getCombatApp(){return game.combats.apps[0]}_canDragStart(e){return!1}_canDragDrop(e){return!1}_onDragStart(e){let t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}_onDrop(e){JSON.parse(e.dataTransfer.getData("text/plain")).type=="IniChange"}};var xe=class extends Tour{static async travelAgency(){let e=game.i18n.lang=="de"?"de":"en";console.log("Adding DSA/TDE Tours");for(let t of this.tours){let a=await game.dsa5.apps.DSATour.fromJSON(`${t.replace("/lang/",`/${e}/`)}.json`);game.tours.register(a.config.module,a.id,a)}if(!!game.user.isGM)for(let t of this.gmTours){let a=await game.dsa5.apps.DSATour.fromJSON(`${t.replace("/lang/",`/${e}/`)}.json`);game.tours.register(a.config.module,a.id,a)}}async _preStep(){this.currentStep.activateTab?ui.sidebar.activateTab(this.currentStep.activateTab):this.currentStep.activateLayer&&canvas.activeLayer.options.name!=this.currentStep.activateLayer?(await canvas[this.currentStep.activateLayer].activate(),await Ut(100)):this.currentStep.appTab&&this.app.activateTab(this.currentStep.appTab)}exit(){super.exit()}async start(){if(this.config.preCommand){let t=Object.getPrototypeOf(async function(){}).constructor;await new t(this.config.preCommand).call(this)}if(this.app)for(await this.app.render(!0,{focus:!0});!this.app.rendered;)await Ut(50);if(this.app||this.config.preCommand)for(;!$(this.steps[this.stepIndex+1].selector+":visible").length;)await Ut(50);let e=await super.start();return $("#tooltip").show(),e}};R(xe,"tours",["systems/dsa5/modules/tours/lang/initial","systems/dsa5/modules/tours/lang/library","systems/dsa5/modules/tours/lang/actor"]),R(xe,"gmTours",["systems/dsa5/modules/tours/lang/mastermenu"]);var gt=class{async _getData(e){return{}}activateListeners(e){}async _renderData(e){let t=await this._getData(e);return mergeObject(t,e),await renderTemplate(this.constructor.template,t)}async prepareApp(e){return{name:game.i18n.localize(`PLAYER.${this.constructor.name}`),view:await this._renderData(e)}}async render(){await game.dsa5.apps.playerMenu.render(!0)}async activateTab(){await game.dsa5.apps.playerMenu.activateTab(game.i18n.localize(`PLAYER.${this.constructor.name}`))}get actor(){return game.dsa5.apps.playerMenu.actor}async _onDrop(e){}};R(gt,"template",""),R(gt,"rulePath",{});var ze=class extends Application{constructor(e){super(e),this.entityAbilities=[],game.dsa5.apps.PlayerMenuSubApp=gt,this.summoningModifiers=[{id:1,name:"CONJURATION.offensiveImprovement",descr:"CONJURATION.offensiveImprovementDescr",changes:[{key:"system.meleeStats.attack",mode:2,value:2},{key:"system.meleeStats.damage",mode:2,value:4},{key:"system.rangeStats.attack",mode:2,value:2},{key:"system.rangeStats.damage",mode:2,value:4}]},{id:2,name:"CONJURATION.defensiveImprovement",descr:"CONJURATION.defensiveImprovementDescr",changes:[{key:"system.meleeStats.parry",mode:2,value:2},{key:"system.totalArmor",mode:2,value:2},{key:"system.status.wounds.gearmodifier",mode:2,value:10}]},{id:3,name:"CONJURATION.speedImprovement",descr:"CONJURATION.speedImprovementDescr",changes:[{key:"system.status.speed.gearmodifier",mode:2,value:2},{key:"system.status.dodge.gearmodifier",mode:2,value:2}]},{id:4,name:"CONJURATION.magicalImprovement",descr:"CONJURATION.magicalImprovementDescr",changes:[],fun:_.magicalImprovement},{id:5,name:"CONJURATION.resistanceImprovement",descr:"CONJURATION.resistanceImprovementDescr",changes:[{key:"system.status.soulpower.gearmodifier",mode:2,value:2},{key:"system.status.toughness.gearmodifier",mode:2,value:2}]},{id:6,name:"CONJURATION.mentalImprovement",descr:"CONJURATION.mentalImprovementDescr",changes:[{key:"system.characteristics.mu.gearmodifier",mode:2,value:2},{key:"system.characteristics.kl.gearmodifier",mode:2,value:2},{key:"system.characteristics.in.gearmodifier",mode:2,value:2},{key:"system.characteristics.ch.gearmodifier",mode:2,value:2}]},{id:7,name:"CONJURATION.physicalImprovement",descr:"CONJURATION.physicalImprovementDescr",changes:[{key:"system.characteristics.ff.gearmodifier",mode:2,value:2},{key:"system.characteristics.ge.gearmodifier",mode:2,value:2},{key:"system.characteristics.ko.gearmodifier",mode:2,value:2},{key:"system.characteristics.kk.gearmodifier",mode:2,value:2}]}],this.conjurationData={qs:0,consumedQS:0,packageModifier:0,selectedIds:[],selectedEntityIds:[],selectedPackageIds:[],conjurationTypes:{1:game.i18n.localize("CONJURATION.demon"),2:game.i18n.localize("CONJURATION.elemental")},rules:{1:{de:{pack:"dsa5-core.corerules",name:"Beschw\xF6rungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}},2:{de:{pack:"dsa5-core.corerules",name:"Beschw\xF6rungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}}},conjurationType:1,skills:{1:["invocatioMinima","invocatioMinor","invocatioMaior"].map(t=>game.i18n.localize(`LocalizedIDs.${t}`)),2:["manifesto","elementalServant","callDjinn","servantEarth","servantFlame","servantCold","servantWave","servantCloud","servantOre"].map(t=>game.i18n.localize(`LocalizedIDs.${t}`))},modifiers:{1:this.summoningModifiers,2:this.summoningModifiers},moreModifiers:{2:[{name:game.i18n.localize("CONJURATION.groupSummoning"),options:[1,2,3,4,5,6,7,8].map(t=>({name:t,val:t*-2+2}))}]},postFunction:{}},this.subApps=[]}registerSubApp(e){this.subApps.push(e)}async rollConjuration(e){if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("CONJURATION.dragConjuration"));let t=$(e.currentTarget).closest(".item").attr("data-item-id"),a=this.actor.items.get(t),s=[{name:game.i18n.localize("conjuringDifficulty"),value:getProperty(this.conjuration,"system.conjuringDifficulty.value")||0,selected:!0}];if(this.conjurationData.packageModifier&&s.push({name:game.i18n.localize("summoningPackage"),value:this.conjurationData.packageModifier,selected:!0}),this.conjurationData.moreModifiers[this.conjurationData.conjurationType]){let i=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].filter(r=>r.selected);for(let r of i)s.push({name:r.name,value:Number(r.selected),selected:!0})}this.actor.setupSkill(a,{moreModifiers:s,subtitle:` (${this.conjuration.name})`},void 0).then(async i=>{let r=await this.actor.basicTest(i);this.conjurationData.qs=r.result.qualityStep||0,this.render(!0)})}activateListeners(e){super.activateListeners(e),se(e),e.find(".conjurationData").change(t=>{let a=$(t.currentTarget);setProperty(this.conjurationData,a.attr("name"),a.val()),a.attr("data-refresh")&&this.render()}),e.find(".skill-select").click(t=>this.rollConjuration(t)),e.find(".initLibrary").click(async t=>{$(t.currentTarget).html('<i class="fas fa-spin fa-spinner"></i>'),await game.dsa5.itemLibrary.buildEquipmentIndex(),this.render()}),e.find(".item-edit").click(t=>{let a=$(t.currentTarget).closest(".item").attr("data-item-id");this.actor.items.get(a).sheet.render(!0)}),e.find(".selectableRow").click(t=>this.selectImprovement(t)),e.find(".finalizeConjuration").click(()=>this.finalizeConjuration()),e.find(".ruleLink").click(t=>this.openRules(t)),e.find(".openChar").click(()=>{this.actor?.sheet.render(!0)}),e.find(".showEntity").click(t=>{t.stopPropagation(),(async()=>{(await fromUuid(t.currentTarget.dataset.uuid)).sheet.render(!0)})()}),e.find(".moreModifiers").change(t=>{let a=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].find(s=>s.name==t.currentTarget.dataset.name);a.selected=$(t.currentTarget).val()});for(let t of this.subApps)t.activateListeners(e)}async openRules(e){let t=e.currentTarget.dataset.subapp,a=(t?this.subApps.find(i=>i.constructor.name==t).constructor.rulePath:this.conjurationData.rules[this.conjurationData.conjurationType])[game.i18n.lang];(async()=>{let r=await game.packs.get(a.pack).getDocuments({name:a.name});for(let n of r)n.sheet.render(!0)})()}finalizeConjuration(){if(!this.conjurationData)return;if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("DSAError.noConjurationActive"));let e=[];for(let a of this.conjurationData.selectedIds)e.push(this.conjurationData.modifiers[this.conjurationData.conjurationType].find(s=>s.id==a));let t={source:this.conjuration.toObject(),creationData:{type:this.conjurationData.conjurationType,typeName:this.conjurationData.conjurationTypes[this.conjurationData.conjurationType],qs:this.conjurationData.qs,consumedQS:this.conjurationData.consumedQS,modifiers:e,entityIds:this.conjurationData.selectedEntityIds,packageIds:this.conjurationData.selectedPackageIds},summoner:{name:this.actor.name,img:this.actor.img}};game.user.isGM?ze.createConjuration(t):(game.socket.emit("system.dsa5",{type:"summonCreature",payload:t}),ui.notifications.notify(game.i18n.localize("CONJURATION.requestSend")))}static createConjuration({source:e,creationData:t,summoner:a}){new js(e,a,t).render(!0)}selectImprovement(e){let t=Number(e.currentTarget.dataset.max)||1,a=Number(e.currentTarget.dataset.selected)||0;a>=t?$(e.currentTarget).removeClass("selected"):($(e.currentTarget).addClass("selected"),e.currentTarget.dataset.selected=a+1);let s=[],i=[],r=[],n=0,o=0;$(this._element).find(".selectableRow.selected").each((c,m)=>{for(let d=0;d<Number(m.dataset.selected);d++)m.dataset.entityid?(i.push(m.dataset.id),n+=(Number(m.dataset.qs)||0)*-1):m.dataset.packageid?(r.push(m.dataset.id),o+=Number(m.dataset.mod)||0):s.push(Number(m.dataset.id))}),this.conjurationData.selectedIds=s,this.conjurationData.selectedEntityIds=i,this.conjurationData.selectedPackageIds=r,this.conjurationData.consumedQS=s.length+n,this.conjurationData.packageModifier=o,this.render()}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"summoning"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","playerMenu","sheet"]),width:500,height:740,title:game.i18n.localize("PLAYER.title"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/playermenu.html",e.resizable=!0,e}_canDragDrop(e){return!0}async _onDrop(e){let t;try{switch(t=JSON.parse(e.dataTransfer.getData("text/plain")),t.type){case"Actor":t=await Actor.implementation.fromDropData(t);break;case"Item":t=await Item.implementation.fromDropData(t);break}}catch{return!1}if(t.documentName=="Actor"){let a=game.actors.get(t.id);if(a.type=="creature"||$(e.target).closest(".summoningArea").length>0){if(this.conjuration=a,this.conjurationData.selectedIds=[],this.conjurationData.selectedEntityIds=[],this.conjurationData.selectedPackageIds=[],a.type=="creature"){for(let s of Object.keys(this.conjurationData.conjurationTypes))if(a.system.creatureClass.value.includes(this.conjurationData.conjurationTypes[s])){this.conjurationData.conjurationType=s;break}}}else this.trackedId=t.id,this.actor=a;this.render(!0)}else for(let a of this.subApps)if(await a._onDrop(t)===!0)break}async prepareEntityAbilities(){let e={entityAbilities:[],entityPackages:[]};if(game.dsa5.itemLibrary.equipmentBuild){let t=[game.i18n.localize("LocalizedIDs.all"),this.conjurationData.conjurationTypes[this.conjurationData.conjurationType]],a=await Promise.all((await game.dsa5.itemLibrary.getCategoryItems("trait",!1)).map(r=>r.getItem())),s=new Set,i=new Set;for(let r of a)r.system.distribution&&t.some(n=>r.system.distribution.includes(n))&&(r.system.traitType.value=="entity"&&!s.has(r.name)?(s.add(r.name),e.entityAbilities.push(r),r.count=this.conjurationData.selectedEntityIds.filter(n=>n==r.uuid).length,r.max=r.system.at.value||1):r.system.traitType.value=="summoning"&&!i.has(r.name)&&(i.add(r.name),r.count=this.conjurationData.selectedPackageIds.filter(n=>n==r.uuid).length,e.entityPackages.push(r)))}return e}async getData(e){let t=await super.getData(e);if(!game.user.isGM&&!this.actor&&(this.actor=game.user.character),this.actor){let a=this.conjurationData.qs-this.conjurationData.consumedQS+1,s=game.dsa5.itemLibrary.equipmentBuild,{entityAbilities:i,entityPackages:r}=await this.prepareEntityAbilities(),n=this.actor.items.filter(u=>this.conjurationData.skills[this.conjurationData.conjurationType].includes(u.name)&&["liturgy","ceremony","spell","ritual"].includes(u.type)).map(u=>u.toObject()),o=!1;for(let u of n)u.hasMighty=this.actor.items.find(p=>p.name==`${u.name} - ${game.i18n.localize("CONJURATION.powerfulCreature")}`),o||(o=u.hasMighty);let c=this.conjurationData.modifiers[this.conjurationData.conjurationType],m=o?2:1;for(let u of c)u.max=m,u.count=this.conjurationData.selectedIds.filter(p=>p==u.id).length;let d=await renderTemplate("systems/dsa5/templates/system/conjuration/summoning.html",{actor:this.actor,conjuration:this.conjuration||{name:game.i18n.localize("CONJURATION.dragConjuration"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,services:a,conjurationModifiers:c,equipmentIndexLoaded:s,entityAbilities:i,entityPackages:r,moreModifiers:this.conjurationData.moreModifiers[this.conjurationData.conjurationType],hasMighty:o});mergeObject(t,{conjurationSheet:d,conjurationskills:n})}return mergeObject(t,{actor:this.actor||{name:game.i18n.localize("CONJURATION.dragActor"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,conjurationTypes:this.conjurationData.conjurationTypes}),await this.prepareSubApps(t),t}async prepareSubApps(e){e.subApps=[];for(let t of this.subApps)e.subApps.push(await t.prepareApp(e))}},js=class extends X{constructor(e,t,a){super({title:`${game.i18n.localize("CONJURATION.request")} (${t.name})`,default:"ok",buttons:{}}),this.conjuration=e,this.summoner=t,this.creationData=a,this.confirmed=!1}async getData(e){let t=await super.getData(e),a=this.uniqueCountIds(this.creationData.entityIds);return mergeObject(t,{conjuration:this.conjuration,summoner:this.summoner,confirmed:this.confirmed,services:this.creationData.qs-this.creationData.consumedQS+1,creationData:this.creationData,conjurationModifiers:this.creationData.modifiers,entityModifiers:await Promise.all(Object.keys(a).map(async s=>{let i=(await fromUuid(s)).toObject(!1);return i.uuid=s,i.count=a[s],i.cost=Number(i.system.AsPCost.value)*a[s],i})),packageModifiers:await Promise.all(this.creationData.packageIds.map(s=>fromUuid(s))),actor:this.actor}),t}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog"]),width:470}),e.template="systems/dsa5/templates/system/conjuration/request.html",e}uniqueCountIds(e){return e.reduce((t,a)=>(t[a]?++t[a]:t[a]=1,t),{})}async createActor(){this.confirmed=!0;let e=await g.getFolderForType("Actor",null,game.i18n.localize("PLAYER.conjuration")),t=await g.getFolderForType("Actor",e.id,this.creationData.typeName),a=this.creationData.qs-this.creationData.consumedQS+1;this.conjuration.folder=t.id,this.conjuration.effects||(this.conjuration.effects=[]);for(let c of this.creationData.modifiers)this.conjuration.effects.push({changes:c.changes,duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize(c.name),flags:{dsa5:{description:`${game.i18n.localize("PLAYER.conjuration")} ${game.i18n.localize("extensions")}`,hideOnToken:!0,hidePlayers:!1}}}),c.fun&&c.fun(this.conjuration,this.creationData);let s=this.uniqueCountIds(this.creationData.entityIds),i=(await Promise.all(Object.keys(s).map(c=>fromUuid(c)))).map(c=>{let m=c.toObject(!1);return s[c.uuid]>1&&(m.system.step={value:s[c.uuid]}),m}),r=(await Promise.all(this.creationData.packageIds.map(c=>fromUuid(c)))).map(c=>c.toObject(!1));this.conjuration.effects.push({changes:[],duration:{},icon:"icons/svg/aura.svg",id:"services",name:game.i18n.localize("PLAYER.services"),flags:{dsa5:{value:a,max:500,description:`${game.i18n.localize("PLAYER.conjuration")} ${game.i18n.localize("PLAYER.services")}`,manual:a,auto:0,hideOnToken:!0,hidePlayers:!1}}}),game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type]&&await game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type](this.conjuration,this.creationData.qs-this.creationData.consumedQS,this.creationData.type),this.conjuration.type=="creature"&&!this.conjuration.system.creatureClass.value.includes(this.creationData.typeName)&&(this.conjuration.system.creatureClass.value+=`, ${this.creationData.typeName}`),this.actor=await T.create(this.conjuration);let n=[...i,...r].filter(c=>!this.conjuration.items.find(m=>m.type==c.type&&c.name==m.name));await this.actor.createEmbeddedDocuments("Item",n);for(let c of r)await le.traitAdded(this.actor,c);for(let c of i)await le.traitAdded(this.actor,c);await this.actor.update({"system.status.wounds.value":this.actor.system.status.wounds.max});let o=await renderTemplate("systems/dsa5/templates/system/conjuration/chat.html",{actor:this.actor,modifiers:this.creationData.modifiers,summoner:this.summoner,summonerImg:F.videoOrImgTag(this.summoner.img),conjureImg:F.videoOrImgTag(this.actor.img),services:a});await ChatMessage.create(g.chatDataSetup(o)),this.render()}activateListeners(e){super.activateListeners(e),e.find(".createActor").click(()=>{this.createActor()}),e.on("mousedown",".newNPC",async t=>{let a=t.currentTarget.dataset.id;t.button==2&&(game.actors.get(a).delete(),$(t.currentTarget).remove())}),e.on("click",".newNPC",async t=>{let a=t.currentTarget.dataset.id;game.actors.get(a).sheet.render(!0)}),e.on("dragstart",".newNPC",t=>{t.stopPropagation();let a=t.currentTarget,s={type:"Actor",uuid:a.dataset.uuid};t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(s))}),e.find(".showEntity").click(t=>{t.stopPropagation(),(async()=>{(await fromUuid(t.currentTarget.dataset.uuid)).sheet.render(!0)})()})}};var je=l=>class extends l{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["merchant-sheet"])}),e}static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/merchant-sheet.html"}get template(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsa5/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsa5/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsa5/templates/actors/merchant/merchant-epic.html";default:return super.template}return this.constructor.merchantTemplate}merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}async allowMerchant(e,t){let a=duplicate(this.actor.ownership),s=t?1:0;for(let i of e)a[i]=s;await this.actor.update({ownership:a},{diff:!1,recursive:!1,noHook:!0})}activateListeners(e){super.activateListeners(e),e.find(".allowMerchant").click(async t=>{let a=t.currentTarget.dataset.userId,s=$(t.currentTarget).find("i");await this.allowMerchant([a],!s.hasClass("fa-check-circle")),s.toggleClass("fa-circle fa-check-circle")}),e.find(".toggleAllAllowMerchant").click(async t=>{let a=game.users.filter(i=>!i.isGM).map(i=>i.id),s=t.currentTarget.dataset.lock=="true";await this.allowMerchant(a,s),this.render()}),e.find(".lockTradeSection").click(t=>this.lockTradeSection(t)),e.find(".item-tradeLock").click(t=>this.toggleTradeLock(t)),e.find(".randomGoods").click(t=>this.randomGoods(t)),e.find(".clearInventory").click(t=>this.clearInventory(t)),e.find(".removeOtherTradeFriend").click(()=>this.removeOtherTradeFriend()),e.find(".choseTradefriend").click(()=>this.choseTradefriend()),e.find(".setCustomPrice").click(t=>$(t.currentTarget).addClass("edit")),e.find(".customPriceTag").change(async t=>this.setCustomPrice(t)).blur(t=>$(t.currentTarget).closest(".setCustomPrice").removeClass("edit")),e.find(".buy-item").click(t=>{this.advanceWrapper(t,"buyItem",t),U.playMoneySound()}),e.find(".sell-item").click(t=>{this.advanceWrapper(t,"sellItem",t),U.playMoneySound()}),e.find(".item-external-edit").click(t=>{t.preventDefault();let a=this._getItemId(t);this.getTradeFriend().items.get(a).sheet.render(!0)}),e.find(".changeAmountAllItems").mousedown(t=>this.changeAmountAllItems(t)),e.find(".gearSearch").prop("disabled",!1)}_canDragStart(e){return!this.merchantSheetActivated()&&this.isEditable}async toggleTradeLock(e){let t=this._getItemId(e),a=this.actor.items.get(t);this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.tradeLocked":!a.system.tradeLocked}])}async setCustomPrice(e){e.stopPropagation(),e.preventDefault();let t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"flags.dsa5.customPriceTag":Number(e.target.value)}])}removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}async choseTradefriend(){(await Ot.getDialog(this)).render(!0)}async lockTradeSection(e){let t=[],a=this.filterRule(e),s;for(let i of this.actor.items)if(a(i)){let r=i.toObject();s===void 0&&(s=!r.system.tradeLocked),r.system.tradeLocked=s,t.push(r)}this.actor.updateEmbeddedDocuments("Item",t)}filterRule(e){let t=e.currentTarget.dataset.type;return y.equipmentTypes[t]?a=>a.type=="equipment"&&a.system.equipmentType.value==t:a=>a.type==t&&y.equipmentCategories.has(a.type)}async changeAmountAllItems(e){let t=[],a=this.filterRule(e);for(let s of this.actor.items)if(a(s)){let i=s.toObject();_.increment(e,i,"system.quantity.value",0),t.push(i)}this.actor.updateEmbeddedDocuments("Item",t)}async buyItem(e){await this.transferItem(this.actor,this.getTradeFriend(),e,!0)}async sellItem(e){await this.transferItem(this.getTradeFriend(),this.actor,e,!1)}async transferItem(e,t,a,s=!0){let i=this._getItemId(a),r=a.currentTarget.dataset.price,n=a.ctrlKey?10:1;game.user.isGM?await this.constructor.finishTransaction(e,t,r,i,s,n):(this.constructor.noNeedToPay(t,e,r)||j.canPay(t,r,!0))&&game.socket.emit("system.dsa5",{type:"trade",payload:{target:this.constructor.transferTokenData(t),source:this.constructor.transferTokenData(e),price:r,itemId:i,buy:s,amount:n}})}static transferTokenData(e){let t={actor:e.id};return e.token&&(t.token=e.token.id),t}static async finishTransaction(e,t,a,s,i,r){let n=e.items.get(s).toObject();if(r=Math.min(Number(n.system.quantity.value),r),Number(n.system.quantity.value)>0){let o=this.noNeedToPay(t,e,a);if(o||await j.payMoney(t,a,!0))if(getProperty(n,"system.worn.value")&&(n.system.worn.value=!1),i){let m=await this.updateTargetTransaction(t,n,r,e,a);await this.updateSourceTransaction(e,t,n,a,s,r),await this.transferNotification(n,t,e,i,a,r,o,m),await this.selfDestruction(e)}else{await this.updateSourceTransaction(e,t,n,a,s,r);let m=await this.updateTargetTransaction(t,n,r,e,a);await this.transferNotification(n,e,t,i,a,r,o,m)}}}static isTemporaryToken(e){return getProperty(e.system,"merchant.merchantType")=="loot"&&getProperty(e.system,"merchant.temporary")}static async selfDestruction(e){if(this.isTemporaryToken(e)&&!e.items.some(a=>y.equipmentCategories.has(a.type)||a.type=="money"&&a.system.quantity.value>0)){game.socket.emit("system.dsa5",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(e)}});let a=e.getActiveTokens().map(s=>s.id);await canvas.scene.deleteEmbeddedDocuments("Token",a),await game.actors.get(e.id).delete(),this.hideDeletedSheet(e)}}static async hideDeletedSheet(e){e.sheet.close(!0)}static async transferNotification(e,t,a,s,i,r,n,o){let c=game.settings.get("dsa5","merchantNotification");if(c==0||getProperty(e,"system.equipmentType.value")=="service")return;let m="MERCHANT."+(s?"buy":"sell")+(n?"Loot":"")+"Notification",d=e.type=="money"?game.i18n.localize(e.name):o.toAnchor().outerHTML,u=game.i18n.format(m,{item:d,source:t.name,target:a.name,amount:r,price:i,buy:s}),p=g.chatDataSetup(u);c==2&&(p.whisper=ChatMessage.getWhisperRecipients("GM").map(f=>f.id)),await ChatMessage.create(p)}static noNeedToPay(e,t,a){return a==0||getProperty(e.system,"merchant.merchantType")=="loot"||getProperty(t.system,"merchant.merchantType")=="loot"}static async updateSourceTransaction(e,t,a,s,i,r){let n=duplicate(a);Number(n.system.quantity.value)>r||n.type=="money"?(n.system.quantity.value=Number(n.system.quantity.value)-r,await e.updateEmbeddedDocuments("Item",[n])):await e.deleteEmbeddedDocuments("Item",[i]),this.noNeedToPay(e,t,s)||await j.getMoney(e,s,!0)}static async updateTargetTransaction(e,t,a,s,i){let r=duplicate(t);if(getProperty(r,"system.equipmentType.value")=="service"){let o=game.i18n.format("MERCHANT.buyNotification",{item:r.name,amount:a,source:e.name,target:s.name,price:i});ChatMessage.create(g.chatDataSetup(o))}else{let o=e.items.find(c=>S.areEquals(r,c));return r.system.quantity.value=a,o?(await S.stackItems(o,r,e),o):(await e.createEmbeddedDocuments("Item",[r]))[0]}}getTradeFriend(){return this.otherTradeFriend||game.user.character}async _manageDragItems(e,t){switch(t){case"creature":case"npc":case"character":this.setTradeFriend(e);break;default:return super._manageDragItems(e,t)}}async _onDropActor(e,t){let a=this.actor.limited,s=this.actor.isOwner;if(!(a||s))return!1;let{item:i,typeClass:r,selfTarget:n}=await Pe(t,this.id,!1);if(!n&&(s||a&&i.documentName=="Actor"))return await this._manageDragItems(i,r)}setTradeFriend(e){let t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}async _render(e=!1,t={}){if(!game.user.isGM&&getProperty(this.actor.system,"merchant.merchantType")=="loot"&&getProperty(this.actor.system,"merchant.locked")){AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1);return}await super._render(e,t)}_togglePlayerview(e){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}playerViewEnabled(){return getProperty(this.actor.system,"merchant.playerView")}async randomGoods(e){let t=await renderTemplate("systems/dsa5/templates/dialog/randomGoods-dialog.html",{categories:Array.from(y.equipmentCategories)});new Dialog({title:game.i18n.localize("MERCHANT.randomGoods"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:a=>this.addRandomGoods(this.actor,a,e)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async clearInventory(e){new Dialog({title:game.i18n.localize("MERCHANT.clearInventory"),content:game.i18n.localize("MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{this.removeAllGoods(this.actor,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async addRandomGoods(e,t,a){let s=$(a.currentTarget).text();$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=[];t.find('input[type="checkbox"]:checked').each(function(){let c=$(this).val();i.push({name:c,count:Number(t.find(`input[name="each_${c}"]`).val()),number:Number(t.find(`input[name="number_${c}"]`).val())})});let r=game.dsa5.itemLibrary;r.equipmentBuild||await r.buildEquipmentIndex();let n=[];for(let c of i){let m=(await r.getRandomItems(c.name,c.number)).map(d=>{let u=d.toObject();return u.system.quantity.value=c.count,u});n.push(...m)}let o={};n=n.filter(function(c){let m=getProperty(c,"system.effect");m=typeof m=="object"&&m!==null&&getProperty(m,"attributes")||"";let d=Number(getProperty(c,"system.price.value"))||0;if(m!=""||d>1e4)return!1;let u=`${c.type}_${c.name}`;return(o.hasOwnProperty(u)?!1:o[u]=!0)&&e.items.filter(function(p){return p.type==c.type&&p.name==c.name}).length==0}),await e.createEmbeddedDocuments("Item",n),$(a.currentTarget).text(s)}async removeAllGoods(e,t){let a=$(t.currentTarget).text();$(t.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let s=e.items.filter(i=>y.equipmentCategories.has(i.type)&&!getProperty(i,"worn.value")).map(i=>i.id);await e.deleteEmbeddedDocuments("Item",s),$(t.currentTarget).text(a)}async getData(e){let t=await super.getData(e);return t.merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",t.merchantTypes={none:game.i18n.localize("MERCHANT.typeNone"),merchant:game.i18n.localize("MERCHANT.typeMerchant"),loot:game.i18n.localize("MERCHANT.typeLoot"),epic:game.i18n.localize("MERCHANT.typeEpic")},t.invName=t.merchantTypes[t.merchantType],t.players=game.users.filter(a=>!a.isGM).map(a=>(a.allowedMerchant=this.actor.testUserPermission(a,"LIMITED",!1),a.buyingFactor=getProperty(this.actor.system,`merchant.factors.buyingFactor.${a.id}`),a.sellingFactor=getProperty(this.actor.system,`merchant.factors.sellingFactor.${a.id}`),a)),t.merchantType!="epic"?(this.prepareStorage(t),this.merchantSheetActivated()&&(this.filterWornEquipment(t),this.prepareTradeFriend(t),t.prepare.inventory.misc.items.length==0&&(t.prepare.inventory.misc.show=!1))):(this.prepareStorage(t),t.garadanOptions={1:game.i18n.localize("GARADAN.1"),2:game.i18n.localize("GARADAN.2"),3:game.i18n.localize("GARADAN.3"),4:game.i18n.localize("GARADAN.4"),6:game.i18n.localize("GARADAN.6")}),t.hasOtherTradeFriend=!!this.otherTradeFriend,t}filterWornEquipment(e){for(let[t,a]of Object.entries(e.prepare.inventory))a.items=a.items.filter(s=>!getProperty(s,"system.worn.value"))}prepareStorage(e){if(e.merchantType=="merchant")for(let[t,a]of Object.entries(e.prepare.inventory))for(let s of a.items)s.defaultPrice=this.getItemPrice(s),s.calculatedPrice=Number(parseFloat(`${s.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1)}`).toFixed(2))*(getProperty(this.actor.system,`merchant.factors.sellingFactor.${game.user.id}`)||1),s.priceTag=` / ${s.calculatedPrice}`;else if(e.merchantType=="loot"){for(let[a,s]of Object.entries(e.prepare.inventory))for(let i of s.items)i.calculatedPrice=this.getItemPrice(i);let t={items:e.prepare.money.coins.map(a=>(a.name=game.i18n.localize(a.name),a)),show:!0,dataType:"money"};t.items.length&&(e.prepare.inventory.money=t)}}getItemPrice(e){return Number(getProperty(e,"flags.dsa5.customPriceTag"))||(e.type=="consumable"?S.getSubClass(e.type).consumablePrice(e):Number(e.system.price.value))}prepareTradeFriend(e){let t=this.getTradeFriend();if(t){let a=t.prepareItems({details:[]}),s=getProperty(this.actor.system,"merchant.merchantType")=="loot"?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,`merchant.factors.buyingFactor.${game.user.id}`)||1),i=this.prepareSellPrices(a.inventory,s);i.misc.items.length==0&&(i.misc.show=!1),e.merchantType=="loot"&&(i.money={items:a.money.coins.map(r=>(r.name=game.i18n.localize(r.name),r)),show:!0,dataType:"money"}),mergeObject(e,{tradeFriend:{img:t.img,name:t.name,inventory:i,money:a.money}})}else mergeObject(e,{tradeFriend:{inventory:[],money:{coins:[]}}})}prepareSellPrices(e,t){for(let[a,s]of Object.entries(e))for(let i of s.items)i.calculatedPrice=Number(parseFloat(`${this.getItemPrice(i)*t}`).toFixed(2));return e}},Ot=class extends Dialog{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{}),e}static async getDialog(e){let t=game.user.isGM?await game.dsa5.apps.gameMasterMenu.getTrackedHeros():game.actors.filter(s=>s.isOwner),a=new Ot({title:game.i18n.localize("DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsa5/templates/dialog/selectTradeFriend.html",{users:t}),default:"yes",buttons:{}});return a.actor=e,a}activateListeners(e){super.activateListeners(e),e.find(".combatant").click(t=>this.setTargetToUser(t))}setTargetToUser(e){this.actor.setTradeFriend({_id:e.currentTarget.dataset.id}),this.close()}};var ve=class extends je(Ee){};function bi(){game.socket.on("system.dsa5",l=>{switch(l.type){case"hideDeletedSheet":let e=l.payload.target.token?game.actors.tokens[l.payload.target.token]:game.actors.get(l.payload.target.actor);ve.hideDeletedSheet(e);return;default:de.socketListeners(l)}}),game.user.isGM&&game.socket.on("system.dsa5",l=>{if(!!g.isActiveGM())switch(l.type){case"updateKeepField":y.allowedforeignfields.includes(l.payload.field)&&game.actors.get(l.payload.actorId).update({[l.payload.field]:l.payload.updateData});break;case"target":{let e=game.scenes.get(l.payload.scene);new Token(e.getEmbeddedDocument("Token",l.payload.target)).actor.update({"flags.oppose":l.payload.opposeFlag})}break;case"addEffect":_DSAActiveEffectConfig.applyEffect(l.payload.id,l.payload.mode,l.payload.actors);break;case"updateMsg":game.messages.get(l.payload.id).update(l.payload.updateData);break;case"deleteMsg":game.messages.get(l.payload.id).delete();break;case"showDamage":F.showDamage(game.messages.get(l.payload.id),l.payload.hide);break;case"hideQueryButton":F.hideReactionButton(l.payload.id);break;case"updateGroupCheck":G.rerenderGC(game.messages.get(l.payload.messageId),l.payload.data);break;case"updateAttackMessage":game.messages.get(l.payload.messageId).update({"flags.data.unopposedStartMessage":l.payload.startMessageId});break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"clearOpposed":F.clearOpposed(game.actors.get(l.payload.actorId));break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(l.payload.speaker);break;case"trade":{let e=l.payload.source.token?game.actors.tokens[l.payload.source.token]:game.actors.get(l.payload.source.actor),t=l.payload.target.token?game.actors.tokens[l.payload.target.token]:game.actors.get(l.payload.target.actor);ve.finishTransaction(e,t,l.payload.price,l.payload.itemId,l.payload.buy,l.payload.amount)}break;case"playWhisperSound":l.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:l.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(l.payload.id).then(e=>{new J(e).socketedConditionAddActor(l.payload.actors.map(a=>game.actors.get(a)),l.payload.data)});break;case"socketedConditionAdd":fromUuid(l.payload.id).then(e=>{new J(e).socketedConditionAdd(l.payload.targets,l.payload.data)});break;case"socketedRemoveCondition":fromUuid(l.payload.id).then(e=>{new J(e).socketedRemoveCondition(l.payload.targets,l.payload.coreId)});break;case"socketedActorTransformation":fromUuid(l.payload.id).then(e=>{new J(e).socketedActorTransformation(l.payload.targets,l.payload.update)});break;case"itemDrop":{let e=l.payload.sourceActorId?game.actors.get(l.payload.sourceActorId):void 0;fromUuid(l.payload.itemId).then(t=>{fs(e,t,l.payload.data,l.payload.amount)})}break;case"finalizeFoodContribution":case"hideDeletedSheet":case"finalizeidentification":case"updateHits":case"hideResistButton":case"receiveOfferedItems":case"startTrade":case"acceptTrade":case"tradeCanceled":case"tradeFinished":break;case"reduceGroupSchip":T.reduceGroupSchip();break;case"summonCreature":ze.createConjuration(l.payload);break;default:console.warn(`Unhandled socket data type ${l.type}`)}})}function ki(){Hooks.on("ready",async()=>{bi(),g.moduleEnabled("vtta-tokenizer")&&!await game.settings.get("dsa5","tokenizerSetup")&&game.user.isGM&&(await game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsa5/icons/backgrounds/token_green.webp"),await game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsa5/icons/backgrounds/token_black.webp"),await game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsa5/icons/backgrounds/token_blue.webp"),await game.settings.set("dsa5","tokenizerSetup",!0)),g.moduleEnabled("dice-so-nice")&&!await game.settings.get("dsa5","diceSetup")&&game.user.isGM&&(await game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0),await game.settings.set("dsa5","diceSetup",!0)),await $e.firstTimeMessage(),S.setupSubClasses(),He.showOneMessage(),game.settings.get("dsa5","disableTokenhotbar")||ie.registerTokenHotbar(),ci(),Oe.connectHooks();let l=e=>{e.tabName=="settings"&&(xe.travelAgency(),Hooks.off("changeSidebarTab",l))};Hooks.on("changeSidebarTab",l),li(),ii()})}function wi(){Token.prototype.drawEffects=async function(){this.effects.removeChildren().forEach(i=>i.destroy()),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null;let t=this.document.effects,a=[];this.actor&&(a=await this.actor.actorEffects(),this.actor.isSwarm()&&a.push(new ActiveEffect({icon:"systems/dsa5/icons/thirdparty/bee.svg",id:"swarm",name:"swarm.name",flags:{dsa5:{value:this.actor.system.swarm?.effectiveCount||1}}})));let s={src:this.document.overlayEffect,tint:null};if(t.length||a.length){let i=[];for(let r of a){if(!r.icon)continue;let n=Color.from(r.tint??null);if(r.getFlag("core","overlay")){s={src:r.icon,tint:n};continue}i.push(this._drawEffect(r.icon,n,getProperty(r,"flags.dsa5.value")))}for(let r of t)i.push(this._drawEffect(r,null));await Promise.all(i)}this.effects.overlay=await this._drawOverlay(s.src,s.tint),this._refreshEffects()},Token.prototype._refreshEffects=function(){let t=0,a=Math.round(canvas.dimensions.size/2/5)*2,s=Math.floor(this.document.height*5),i=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(let r of this.effects.children)if(r!==i&&!r.isCounter)if(r===this.effects.overlay){let n=Math.min(this.w*.6,this.h*.6);r.width=r.height=n,r.position.set((this.w-n)/2,(this.h-n)/2)}else{if(r.width=r.height=a,r.x=Math.floor(t/s)*a,r.y=t%s*a,i.drawRoundedRect(r.x+1,r.y+1,a-2,a-2,2),r.counter>1&&!r.counterDrawn){let n=game.dsa5.config.effectTextStyle,o=game.settings.get("dsa5","statusEffectCounterColor");n._fill=/^#[0-9A-F]+$/.test(o)?o:"#000000";let c=this.effects.addChild(new PreciseText(r.counter,n));c.x=r.x,c.y=r.y,c.isCounter=!0,r.counterDrawn=!0}t++}},Token.prototype._drawEffect=async function(t,a,s){if(!t)return;let i=await loadTexture(t,{fallback:"icons/svg/hazard.svg"}),r=new PIXI.Sprite(i);return a&&(r.tint=a),r.counter=s,this.effects.addChild(r)},TokenHUD.prototype._onToggleEffect=function(t,{overlay:a=!1}={}){t.preventDefault();let s=t.currentTarget,i=s.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find(r=>r.id===s.dataset.statusId):s.getAttribute("src");if(!!i.flags.dsa5.editable){if(t.button==0)return this.object.incrementCondition(i);if(t.button==2)return this.object.decrementCondition(i)}},Token.prototype.incrementCondition=async function(t,{active:a,overlay:s=!1}={}){let i=this.actor.effects.find(r=>r.statuses.has(t.id));return!i||Number.isNumeric(getProperty(i,"flags.dsa5.value"))?await this.actor.addCondition(t.id,1,!1,!1):i&&await this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),a},Token.prototype.decrementCondition=async function(t,{active:a,overlay:s=!1}={}){return this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),a};let l=Token.prototype._onClickLeft2,e=t=>t?["merchant","loot"].includes(getProperty(t.system,"merchant.merchantType")):!1;Token.prototype._onClickLeft2=function(t){if(!(game.user.isGM||!K.isEnabled||!e(this.actor)||K.inDistance(this)))return ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"));l.call(this,t)}}function vi(){Hooks.on("renderSettings",(l,e,t)=>{let a=$(`<button id="reportADSABug"><i class="fas fa-bug"></i> ${game.i18n.localize("DSA5Error")}</button>`);a.click(()=>{window.open("https://github.com/Plushtoast/dsa5-foundryVTT/issues","_blank")}),e.find("#settings-documentation").append(a),a=$(`<button><i class="fas fa-info-circle"></i> ${game.i18n.localize("DSA5Wiki")}</button>`),a.click(()=>{window.open("https://github.com/Plushtoast/dsa5-foundryVTT/wiki","_blank")}),e.find("#settings-documentation").append(a),a=$('<button class="fshopButton"><div></div> F-Shop</button>'),a.click(()=>{window.open(game.i18n.localize("fshopLink"),"_blank")}),e.find("#settings-documentation").append(a);let s=game.system.title.split("/")[game.i18n.lang=="de"?0:1],i=e.find("#game-details .system .system-info").html();e.find("#game-details .system").html(`<span class="system-title">${s}</span><span class="system-info">${i}</span>`)}),Hooks.on("renderCompendiumDirectory",(l,e,t)=>{let a=$(`<button id="openLibrary"><i class="fas fa-university"></i>${game.i18n.localize("ItemLibrary")}</button>`);e.find(".header-actions").append(a),a.click(()=>{game.dsa5.itemLibrary.render(!0)}),e.find('li[data-pack="dsa5.money"]').remove()}),Hooks.once("renderCompendiumDirectory",(l,e,t)=>{let a=game.i18n.lang=="de"?"en":"de",s=game.packs.filter(i=>getProperty(i.metadata,"flags.dsalang")==a);for(let i of s){let r=`${i.metadata.packageName}.${i.metadata.name}`;game.packs.delete(r),game.data.packs=game.data.packs.filter(n=>n.id!=r),e.find(`li[data-pack="${r}"]`).remove()}}),Hooks.on("renderActorDirectory",(l,e,t)=>{if(!game.user.isGM)for(let a of l.documents.filter(s=>s.isMerchant()&&getProperty(s,"system.merchant.hidePlayer")))e.find(`[data-document-id="${a.id}"]`).remove()})}function Ti(){game.settings.register("dsa5","meleeBotchTableEnabled",{name:"DSASETTINGS.meleeBotchTableEnabled",hint:"DSASETTINGS.meleeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","rangeBotchTableEnabled",{name:"DSASETTINGS.rangeBotchTableEnabled",hint:"DSASETTINGS.rangeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","applyDamageInChat",{name:"DSASETTINGS.applyDamageInChat",hint:"DSASETTINGS.applyDamageInChatHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","doubleDamageOptions",{name:"DSASETTINGS.doubleDamageOptions",hint:"DSASETTINGS.doubleDamageOptionsHint",scope:"client",config:!0,default:!1,type:Boolean,requiresReload:!0}),game.settings.register("dsa5","defenseBotchTableEnabled",{name:"DSASETTINGS.defenseBotchTableEnabled",hint:"DSASETTINGS.defenseBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","higherDefense",{name:"DSASETTINGS.higherDefense",hint:"DSASETTINGS.higherDefenseHint",scope:"world",config:!0,default:"0",type:String,choices:{0:"0",2:"+2",4:"+4"}}),game.settings.register("dsa5","informationDistribution",{name:"DSASETTINGS.informationDistribution",hint:"DSASETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("DSASETTINGS.information0"),1:game.i18n.localize("DSASETTINGS.information1"),2:game.i18n.localize("DSASETTINGS.information2")}}),game.settings.register("dsa5","enableItemDropToCanvas",{name:"DSASETTINGS.enableItemDropToCanvas",hint:"DSASETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","statusEffectCounterColor",{name:"DSASETTINGS.statusEffectCounterColor",hint:"DSASETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsa5","migrationVersion",{name:"migrationVersion",hint:"migrationVersion",scope:"world",config:!1,default:25,type:Number}),game.settings.register("dsa5","journalFontSizeIndex",{name:"journalFontSizeIndex",hint:"journalFontSizeIndex",scope:"client",config:!1,default:5,type:Number}),game.settings.register("dsa5","firstTimeStart",{name:"firstTimeStart",hint:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","defaultConfigFinished",{name:"defaultConfigFinished",hint:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","tokenizerSetup",{name:"tokenizerSetup",hint:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","capQSat",{name:"DSASETTINGS.capQSat",hint:"DSASETTINGS.capQSatHint",scope:"world",config:!0,default:6,type:Number}),game.settings.register("dsa5","hideEffects",{name:"DSASETTINGS.hideEffects",hint:"DSASETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","inventorySound",{name:"DSASETTINGS.inventorySound",hint:"DSASETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","talentModifierEnabled",{name:"DSASETTINGS.talentModifierEnabled",hint:"DSASETTINGS.talentModifierEnabledHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","noConfirmationRoll",{name:"DSASETTINGS.noConfirmationRoll",hint:"DSASETTINGS.noConfirmationRollHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","lessRegeneration",{name:"DSASETTINGS.lessRegeneration",hint:"DSASETTINGS.lessRegenerationHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","limitCombatSpecAbs",{name:"DSASETTINGS.limitCombatSpecAbs",hint:"DSASETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","allowPhysicalDice",{name:"DSASETTINGS.allowPhysicalDice",hint:"DSASETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideOpposedDamage",{name:"DSASETTINGS.hideOpposedDamage",hint:"DSASETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableForeignSpellModifer",{name:"DSASETTINGS.enableForeignSpellModifer",hint:"DSASETTINGS.enableForeignSpellModiferHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","playerCanEditSpellMacro",{name:"DSASETTINGS.playerCanEditSpellMacro",hint:"DSASETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableDPS",{name:"DSASETTINGS.enableDPS",hint:"DSASETTINGS.enableDPSHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","iniTrackerSize",{name:"DSASETTINGS.iniTrackerSize",hint:"DSASETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:async e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.constructor.defaultOptions.itemWidth=e)}}),game.settings.register("dsa5","iniTrackerCount",{name:"DSASETTINGS.iniTrackerCount",hint:"DSASETTINGS.iniTrackerCountHint",scope:"client",config:!0,default:5,type:Number,range:{min:3,max:25,step:1},onChange:async e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.constructor.defaultOptions.actorCount=e)}}),game.settings.register("dsa5","tokenhotbarSize",{name:"DSASETTINGS.tokenhotbarSize",hint:"DSASETTINGS.tokenhotbarSizeHint",scope:"client",config:!1,default:35,type:Number,range:{min:15,max:100,step:5},onChange:async e=>{game.dsa5.apps.tokenHotbar&&(game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=e)}}),game.settings.register("dsa5","tokenhotbarLayout",{name:"DSASETTINGS.tokenhotbarLayout",hint:"DSASETTINGS.tokenhotbarLayoutHint",scope:"client",config:!1,default:0,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("DSASETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("DSASETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("DSASETTINGS.tokenhotbarLayout3")}});let l=duplicate(y.styles);for(let e of Object.keys(l))l[e]=game.i18n.localize(l[e]);game.settings.register("dsa5","globalStyle",{name:"DSASETTINGS.globalStyle",hint:"DSASETTINGS.globalStyleHint",scope:"client",config:!0,default:"dsa5-immersive",type:String,choices:l,onChange:async e=>{$("body").removeClass(Object.keys(l).join(" ")).addClass(e)}}),game.settings.register("dsa5","selfControlOnPain",{name:"DSASETTINGS.selfControlOnPain",hint:"DSASETTINGS.selfControlOnPainHint",scope:"world",config:!0,default:1,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.selfControlOnPain0"),1:game.i18n.localize("DSASETTINGS.selfControlOnPain1"),2:game.i18n.localize("DSASETTINGS.selfControlOnPain2")}}),game.settings.register("dsa5","forceLanguage",{name:"DSASETTINGS.forceLanguage",hint:"DSASETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German",en:"English"}}),game.settings.register("dsa5","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","masterSettings",{name:"masterSettings",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","iniTrackerPosition",{name:"iniTrackerPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","soundConfig",{name:"DSASETTINGS.soundConfig",hint:"DSASETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:async()=>{U.loadSoundConfig()}}),game.settings.registerMenu("dsa5","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("DSASETTINGS.changelog"),type:Gs,restricted:!1}),game.settings.registerMenu("dsa5","exportConfiguration",{name:"Export/Import Configuration",label:"Export/Import Configuration",hint:game.i18n.localize("DSASETTINGS.exportConfiguration"),type:Bs,restricted:!0}),game.settings.registerMenu("dsa5","configureTokenbar",{name:game.i18n.localize("DSASETTINGS.configureTokenbar"),label:game.i18n.localize("DSASETTINGS.configureTokenbar"),hint:game.i18n.localize("DSASETTINGS.configureTokenbarHint"),type:Ws,restricted:!1}),game.settings.register("dsa5",`breadcrumbs_${game.world.id}`,{name:"DSASETTINGS.breadcrumbs",hint:"DSASETTINGS.breadcrumbsHint",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsa5","groupschips",{name:"DSASETTINGS.groupschips",hint:"DSASETTINGS.groupschips",scope:"world",config:!1,default:"0/0",type:String,onChange:async()=>{game.user.isGM&&game.dsa5.apps.gameMasterMenu.render()}}),game.settings.register("dsa5","expandChatModifierlist",{name:"DSASETTINGS.expandChatModifierlist",hint:"DSASETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexWorldItems",{name:"DSASETTINGS.indexWorldItems",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","filterDuplicateItems",{name:"DSASETTINGS.filterDuplicateItems",scope:"client",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","enableCombatFlow",{name:"DSASETTINGS.enableCombatFlow",hint:"DSASETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:()=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0)}}),game.settings.register("dsa5","enableCombatPan",{name:"DSASETTINGS.enableCombatPan",hint:"DSASETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","lightSightCompensationEnabled",{name:"lightSightCompensationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","randomWeaponSelection",{name:"DSASETTINGS.randomWeaponSelection",hint:"DSASETTINGS.randomWeaponSelection",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","showWeaponsOnHover",{name:"DSASETTINGS.showWeaponsOnHover",hint:"DSASETTINGS.showWeaponsOnHover",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","disableDidYouKnow",{name:"DSASETTINGS.disableDidYouKnow",hint:"DSASETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","disableTokenhotbar",{name:"DSASETTINGS.disableTokenhotbar",hint:"DSASETTINGS.disableTokenhotbarHint",scope:"client",config:!1,default:!1,type:Boolean,onChange:e=>{e?ie.unregisterTokenHotbar():ie.registerTokenHotbar()}}),game.settings.register("dsa5","disableTokenhotbarMaster",{name:"DSASETTINGS.disableTokenhotbarMaster",hint:"DSASETTINGS.disableTokenhotbarMasterHint",scope:"client",config:!1,default:!1,type:Boolean,onChange:()=>{game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.render(!0)}}),game.settings.register("dsa5","scrollingFontsize",{name:"DSASETTINGS.scrollingFontsize",hint:"DSASETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsa5","tokenhotbaropacity",{name:"DSASETTINGS.tokenhotbaropacity",hint:"DSASETTINGS.tokenhotbaropacityHint",scope:"client",config:!1,default:.75,type:Number,range:{min:0,max:1,step:.05}}),game.settings.register("dsa5","armorAndWeaponDamage",{name:"DSASETTINGS.armorAndWeaponDamage",hint:"DSASETTINGS.armorAndWeaponDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideRegenerationToOwner",{name:"DSASETTINGS.hideRegenerationToOwner",hint:"DSASETTINGS.hideRegenerationToOwnerHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","indexDescription",{name:"DSASETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","encumbranceForRange",{name:"DSASETTINGS.encumbranceForRange",hint:"DSASETTINGS.encumbranceForRangeHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","obfuscateTokenNames",{name:"DSASETTINGS.obfuscateTokenNames",hint:"DSASETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("DSASETTINGS.yesNumbered"),2:game.i18n.localize("DSASETTINGS.renameNumbered"),3:game.i18n.localize("yes"),4:game.i18n.localize("DSASETTINGS.rename")}}),game.settings.register("dsa5","merchantNotification",{name:"DSASETTINGS.merchantNotification",hint:"DSASETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("yes"),2:game.i18n.localize("MERCHANT.onlyGM")}}),game.settings.register("dsa5","sightOptions",{name:"sightOptions",scope:"world",config:!1,default:"0.5|0.7|0.85|0.95",type:String}),game.settings.register("dsa5","trackedActors",{name:"sightOptions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","enableMasterTokenFunctions",{name:"enableMasterTokenFunctions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","selectedActors",{name:"selectedActors",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object})}var sr=l=>{let e=Array.from(game.settings.settings);l.find('[name="exportOnlyDSA"]').is(":checked")&&(e=e.filter(r=>/^dsa5\./.test(r[0])));let a={},s=/(^dsa5\.(selectedActors|trackedActors|groupschips|tokenhotbarPosition|iniTrackerPosition|migrationVersion)$|^dsa5\.breadcrumbs_)/;for(let r of e){if(s.test(r[0]))continue;let n=r[0].split("."),o=n.shift(),c=n.join(".");a[r[0]]=game.settings.get(o,c)}let i="fvtt-DSA5-Configuration.json";saveDataToFile(JSON.stringify(a,null,2),"text/json",i)},ir=async l=>{let e=l.find("form")[0];if(!e.data.files.length)return ui.notifications?.error("You did not upload a data file!");readTextFromFile(e.data.files[0]).then(async t=>{let a=JSON.parse(t),s=Array.from(game.settings.settings).map(i=>i[0]);for(let i of Object.keys(a))if(s.includes(i)){let r=i.split("."),n=r.shift(),o=r.join(".");await game.settings.set(n,o,a[i])}game.settings.sheet.render(!0)})},Gs=class extends FormApplication{render(){wt()}},Bs=class extends FormApplication{async render(){let e=await renderTemplate("systems/dsa5/templates/dialog/exportConfiguration-dialog.html",{});new Dialog({title:"Export configuration",content:e,default:"yes",buttons:{export:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Export"),callback:t=>sr(t)},import:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Import"),callback:t=>ir(t)}}}).render(!0)}},Ws=class extends FormApplication{get template(){return"systems/dsa5/templates/dialog/configureTokenhotbar.html"}static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{title:game.i18n.localize("DSASETTINGS.configureTokenbar")}),e}activateListeners(e){super.activateListeners(e),e.find(".resetTokenhotbar").click(t=>this.resetTokenHotbar(t)),e.find("select, input").change(async t=>{let a=t.currentTarget.name.split("."),s=t.currentTarget.dataset.dtype=="Number"?Number(t.currentTarget.value):t.currentTarget.value;t.currentTarget.type=="checkbox"&&(s=t.currentTarget.checked),await game.settings.set(a[0],a[1],s),game.dsa5.apps.tokenHotbar?.render(!0),this.render()}),e.find(".bags .slot").click(t=>this._onMasterFunctionClicked(t))}async _onMasterFunctionClicked(e){let t=e.currentTarget.dataset.id,a=game.settings.get("dsa5","enableMasterTokenFunctions");a[t]=!a[t],await game.settings.set("dsa5","enableMasterTokenFunctions",a),$(e.currentTarget).toggleClass("deactivated",a[t]),game.dsa5.apps.tokenHotbar.gmItems.find(s=>s.id==t).disabled=a[t],game.dsa5.apps.tokenHotbar?.render(!0)}async getData(e){let t=await super.getData(e);return mergeObject(t,{tokenhotbarSize:game.settings.get("dsa5","tokenhotbarSize"),tokenhotbarLayout:game.settings.get("dsa5","tokenhotbarLayout"),disableTokenhotbarMaster:game.settings.get("dsa5","disableTokenhotbarMaster"),disableTokenhotbar:game.settings.get("dsa5","disableTokenhotbar"),tokenhotbaropacity:game.settings.get("dsa5","tokenhotbaropacity"),isGM:game.user.isGM,gmButtons:game.dsa5.apps.tokenHotbar?.gmItems}),t}async resetTokenHotbar(e){e.preventDefault(),e.stopPropagation(),await game.settings.set("dsa5","tokenhotbarPosition",{}),await game.settings.set("dsa5","tokenhotbarLayout",0),await game.settings.set("dsa5","tokenhotbarSize",35),game.dsa5.apps.tokenHotbar?.resetPosition(),game.dsa5.apps.tokenHotbar?.render(!0)}};function Si(){Hooks.on("renderJournalSheet",(l,e,t)=>{e.find(".close").attr("data-tooltip","SHEET.Close"),e.find(".entry-image").attr("data-tooltip","SHEET.imageView"),e.find(".entry-text").attr("data-tooltip","SHEET.textView"),e.find(".share-image").attr("data-tooltip","SHEET.showToPlayers"),e.find(".import").attr("data-tooltip","SHEET.import"),e.find(".panMapNote").attr("data-tooltip","SHEET.panMapNote"),e.find(".increaseFontSize").attr("data-tooltip","SHEET.increaseFontSize")}),Hooks.on("renderJournalPageSheet",(l,e,t)=>{ee.bindRollCommands(e),I.bindButtons(e),e.find("img").mousedown(a=>{a.button==2&&game.dsa5.apps.DSA5_Utility.showArtwork({name:l.name,uuid:"",img:$(a.currentTarget).attr("src")})}),Xe(e)}),Hooks.on("getJournalSheetHeaderButtons",(l,e)=>{e.unshift({class:"increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>Us($(l._element).find(".journal-page-content"))}),!(!l.document.sceneNote&&!l.document.pages.some(t=>t.sceneNote))&&e.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:async()=>{let t=l._getCurrentPage(),a=Array.from(l.document.pages),s;if(a[t].sceneNote)s=a[t];else if(l.document.sceneNote)s=l.document;else if(s=a.find(i=>i.sceneNote),!s)return;canvas.notes.panToNote(s.sceneNote)}})})}async function Us(l){let t=game.settings.get("dsa5","journalFontSizeIndex")+1;t==y.journalFontSizes.length+1?(t=0,await game.settings.set("dsa5","journalFontSizeIndex",t),l.css("fontSize",""),me(game.i18n.format("CHATNOTIFICATION.fontsize",{size:"Default "}))):(await game.settings.set("dsa5","journalFontSizeIndex",t),rr(l))}function rr(l){let e=game.settings.get("dsa5","journalFontSizeIndex"),t=y.journalFontSizes[e-1]||14;me(game.i18n.format("CHATNOTIFICATION.fontsize",{size:t})),l.css("fontSize",`${t}px`)}function or(l,e,t){if(e.system.isPriest&&e.system.isMage){let s=`<div class="attribute bar3"><input type="text" name="system.status.karmaenergy.value" value="${e.system.status.karmaenergy.value}"></div>`;l.find(".col.middle").prepend(s),l.find(".bar3 input").change(async i=>{let r=i.currentTarget,n=r.value.trim(),o=n.startsWith("+")||n.startsWith("-");n.startsWith("=")&&(n=n.slice(1));let c=Number(n),m=r.name.split(".").reduce((d,u)=>d[u],e);await e.update({[r.name]:o?m+c:c}),t.clear()})}}function lr(l,e,t){if(!game.user.isGM)return;let a=l.object.actor;if(!!a.isToken){if(canvas.tokens.controlled.length>=2){let s=a._id;if(!canvas.tokens.controlled.every(r=>r.actor?._id==s))return;e.find(".col.left").prepend(Ci("swarm.combine"));let i=e.find('.control-icon[data-action="swarm"]');i.click(()=>{dr(a,l.object.document),i.remove()})}else if(a.isSwarm()){e.find(".col.left").prepend(Ci("swarm.split"));let s=e.find('.control-icon[data-action="swarm"]');s.click(()=>{cr(a,l.object.document),s.remove()})}}}var Vs=class extends Dialog{activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change(t=>{$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())})}};function Ci(l){return`<div class="control-icon" data-action="swarm"><i class="fas fa-locust" data-tooltip="${l}" width="36" height="36"></div>`}async function cr(l,e){let t=Number(l.system.swarm.count)-1,a=await renderTemplate("systems/dsa5/templates/dialog/swarm-split-dialog.html",{actor:l,maxSplitsize:t});new Vs({title:game.i18n.localize("swarm.split"),content:a,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async s=>{let i=Number(s.find('input[type="range"]').val()),r=deepClone(e),n=Math.floor(l.system.status.wounds.value/l.system.swarm.count*i),o=l.system.status.wounds.value-n;await l.update({"system.swarm.count":l.system.swarm.count-i,"system.status.wounds.value":o},{skipSwarmUpdate:!0}),await canvas.scene.createEmbeddedDocuments("Token",[r]),await r.actor.update({"system.swarm.count":i,"system.status.wounds.value":n},{skipSwarmUpdate:!0});let c=["x","y"][Math.floor(Math.random()*2)],m=Math.random()>.5?1:-1;await canvas.scene.updateEmbeddedDocuments("Token",[{_id:r.id,[c]:e[c]+canvas.scene.grid.size*m}])}},delete:{icon:'<i class="fas fa-trash"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async function dr(l,e){let t=0,a=0;for(let i of canvas.tokens.controlled)t+=Number(i.actor.system.swarm?.count)||1,a+=Number(i.actor.system.status.wounds.value);await e.actor.update({"system.swarm.count":t,"system.status.wounds.value":a},{skipSwarmUpdate:!0});let s=canvas.tokens.controlled.map(i=>i.id).filter(i=>i!=e.id);await canvas.scene.updateEmbeddedDocuments("Token",s.map(i=>({_id:i,x:e.x,y:e.y}))),await canvas.scene.deleteEmbeddedDocuments("Token",s)}function Di(){Hooks.on("renderTokenHUD",(l,e,t)=>{st.hide(l.object);let a=l.object.actor;a&&(or(e,a,l),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.lightHud(e,a,t),lr(l,e,t)),e.find('.control-icon[data-action="target"]').mousedown(s=>{s.button==2&&(game.user.updateTokenTargets([]),$(s.currentTarget).click(),s.preventDefault())}),e.find(".attribute input").off("change"),H.renderTokenHUD(l,e,t)})}function Ai(){Hooks.on("preCreateScene",function(l,e,t,a){e.grid?.units||l.updateSource({grid:{units:game.i18n.localize("gridUnits")}}),!t.dsaInit&&e.notes?.some(s=>getProperty(s,"flags.dsa5.initName"))&&ui.notifications.warn(game.i18n.localize("DSAError.mapsViaJournalbrowser"))}),Hooks.on("preCreateActiveEffect",function(l,e,t,a){if(l.parent.documentName!="Actor")return;let s={duration:{startTime:game.time.worldTime}};if(!game.combat){l.updateSource(s);return}s.duration.combat=game.combat.id,s.duration.startRound=game.combat.round,s.duration.startTurn=game.combat.turn,!l.duration.rounds&&l.duration.seconds&&(s.duration.rounds=l.duration.seconds/5),l.updateSource(s)})}function Ii(){game.keybindings.register("dsa5","masterMenu",{name:"gmMenu",hint:game.i18n.localize("KEYBINDINGS.masterMenu"),editable:[{key:"KeyM"}],onDown:()=>g.renderToggle(game.dsa5.apps.gameMasterMenu),restricted:!0}),game.keybindings.register("dsa5","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:()=>g.renderToggle(game.dsa5.apps.journalBrowser)}),game.keybindings.register("dsa5","library",{name:"ItemLibrary",hint:game.i18n.localize("KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:()=>g.renderToggle(game.dsa5.itemLibrary)}),game.keybindings.register("dsa5","attacktest",{name:"attacktest",hint:game.i18n.localize("KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:()=>we.runActAttackDialog()}),game.keybindings.register("dsa5","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:()=>Mi("nextTurn")}),game.keybindings.register("dsa5","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:()=>Mi("previousTurn")}),game.keybindings.register("dsa5","setTargetToUser",{name:"DIALOG.setTargetToUser",hint:game.i18n.localize("DIALOG.setTargetToUserHint"),editable:[],onDown:async()=>(await Se.getDialog()).render(!0),restricted:!0})}var Mi=l=>{game.combat?.combatant?.isOwner&&game.combat[l]()};function Ei(){Roll.prototype.editRollAtIndex=function(l){let e=[];for(let t of l){let{index:a,val:s}=t,i=0;for(let r of this.terms){let n=r instanceof DiceTerm||r.class=="DiceTerm"||r instanceof Die||r.class=="Die",o=r instanceof OperatorTerm;if(n||r.faces){if(r.results[a-i]){let c=r.results[a-i].result;r.results[a-i].result=s,e.push(c)}n||(r.total=r.results.reduce((c,m)=>c+m.result,0)),i+=r.results.length}else!o&&(r.class=="OperatorTerm"||r.operator)&&(r.total=r.operator)}e.push(0)}return this._total=this._evaluateTotal(),e}}var ft=class extends Application{constructor(e){super(e),this.adventures=[],this.books=[],this.rshs=[],this.fulltextsearch=!0}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","noscrollWizard","bookWizardsheet"]),width:800,height:880,template:"systems/dsa5/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}static initHook(){ft.wizard=new ft,game.dsa5.apps.journalBrowser=ft.wizard,Hooks.on("renderJournalDirectory",(e,t)=>{let a=$('<div class="header-actions action-buttons flexrow"></div>'),s=$(`<button id="openJournalBrowser"><i class="fa fa-book"></i>${game.i18n.localize("Book.Wizard")}</button>`);s.click(()=>{ft.wizard.render(!0)}),a.append(s),t.find(".header-actions:first-child").after(a)})}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>Us($(this._element).find(".chapter"))}),e.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:async t=>this._showBooks()}),e}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".library").attr("data-tooltip","Book.home"),$(this._element).find(".increaseFontSize").attr("data-tooltip","SHEET.increaseFontSize")}_showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!0,this.currentType=void 0,this.selectedSubChapter=void 0,this.loadPage(this._element)}async toggleBookVisibility(e,t,a){let s=game.settings.get("dsa5","expansionPermissions");s[e]=a,await game.settings.set("dsa5","expansionPermissions",s);let i=this[t].find(o=>o.id==e),r=await(await fetch(i.path)).json(),n=["actors","journal","scenes"];for(let o of n){if(!r[o])continue;let c=game.packs.get(r[o]),m=a?"OBSERVER":"NONE",d={ownership:{PLAYER:m,TRUSTED:m}};await c.configure(d)}this.render()}activateListeners(e){super.activateListeners(e),e.on("click",".toggleVisibility",async t=>{let a=t.currentTarget.dataset.itemid,s=t.currentTarget.dataset.type,i=$(t.currentTarget).find("i").hasClass("fa-toggle-off");this.toggleBookVisibility(a,s,i)}),e.on("click",".showMapNote",t=>{game.journal.get(t.currentTarget.dataset.entryid).panToNote()}),e.on("search keyup",".filterJournals",t=>{this.filterToc($(t.currentTarget).val())}),e.on("click",".movePage",async t=>this.movePage(t)),e.on("click",".loadBook",t=>{this.selectedChapter=void 0,this.selectedType=void 0,this.content=void 0,this.loadBook($(t.currentTarget).text(),e,t.currentTarget.dataset.type)}),e.on("click",".getChapter",t=>{this.selectedType=$(t.currentTarget).closest(".toc").attr("data-type"),this.selectedChapter=t.currentTarget.dataset.id,this.content=void 0,this.loadPage(e)}),e.on("click",".subChapter",t=>{let a=$(t.currentTarget).text(),s=t.currentTarget.dataset.jid;s?this.loadJournalById(s):($(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-id="${a}"]`).addClass("selected"),this.loadJournal(a))}),ee.bindRollCommands(e),e.find(".tocCollapser").click(t=>{$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")}),e.on("mousedown",".openPin",async t=>{let a=t.currentTarget.dataset.uuid;t.button==0?this.showJournal(await fromUuid(a)):t.button==2&&this.unpinJournal(a)}),e.on("click",".showJournal",t=>{this.popJournal($(t.currentTarget).closest("h1").attr("data-uuid"))}),e.on("click",".pinJournal",t=>{let a=$(t.currentTarget).closest("h1"),s=a.attr("data-uuid"),i=a.text();this.pinJournal(s,i)}),e.on("click",".activateScene",t=>{this.showSzene(t.currentTarget.dataset.id,t.currentTarget.dataset.mode)}),e.on("click",".fulltextsearch",t=>{this.fulltextsearch=!this.fulltextsearch,$(t.currentTarget).toggleClass("on"),this.filterToc(e.find(".filterJournals").val())}),e.on("mousedown",".chapter img",t=>{let a=this.book.id;t.button==2&&game.dsa5.apps.DSA5_Utility.showArtwork({name:a,uuid:"",img:$(t.currentTarget).attr("src")})}),I.bindButtons(e),e.on("click",".importBook",async()=>this.importBook()),Xe(e),Vt(e,".breadcrumbs",this.resaveBreadCrumbs)}async getPagy(e,t){let a=this.journals.filter(i=>i.flags.dsa5.parent==e).sort((i,r)=>i.flags.dsa5.sort>r.flags.dsa5.sort?1:-1),s=a.findIndex(i=>i._id==t);return{journals:a,targetindex:s}}async movePage(e){let t=e.currentTarget.dataset.action,{journals:a,targetindex:s}=await this.getPagy(this.selectedChapter,this.selectedSubChapter),i=[];for(let c of this.bookData.chapters)for(let m of c.content)i.push(m.name);let r=i.findIndex(c=>c==this.selectedChapter);if(this.bookData.chapters.findIndex(c=>c.name==this.selectedChapter),t=="next"?s++:s--,s<0){if(this.selectedChapter=i[r-1],!this.selectedChapter)return;a=(await this.getPagy(this.selectedChapter,void 0)).journals,s=0}else if(s>=a.length){if(this.selectedChapter=i[r+1],!this.selectedChapter)return;a=(await this.getPagy(this.selectedChapter,void 0)).journals,s=0}if(["prep","foundryUsage"].includes(this.selectedChapter))return;let n=a[s],o=await this.getToc();this._element.find(".toc").html(o),n&&await this.loadJournalById(n.id)}async loadJournal(e){await this.showJournal(this.journals.find(t=>t.name==e&&t.flags.dsa5.parent==this.selectedChapter))}async loadJournalById(e){await this.showJournal(this.journals.find(t=>t.id==e))}async resaveBreadCrumbs(e){let t={};for(let a of e.getElementsByTagName("div"))t[a.dataset.uuid]=a.innerText;await game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(t))}async filterToc(e){if(e!=null){e=e.toLowerCase().trim();let t;if(e!=""){let a=[];this.fulltextsearch?(this.journalIndex||(this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),await this.journalIndex.add(this.journals.map(s=>new Ys(s)))),a=await this.journalIndex.search(e)):a=this.journals.filter(s=>s.name.toLowerCase().trim().indexOf(e)!=-1),a=a.map(s=>`<li class="fas fa-caret-right"><a data-jid="${s.id}" class="subChapter">${s.name}</a></li>`),$(this._element).find(".tocContent").html(`<ul>${a.join(`
`)}</ul>`)}else t=await this.getToc(),$(this._element).find(".adventureWizard > .row-section > .toc").html(t).find(".filterJournals").focus()}}async showJournal(e){let t="";for(let r of e.pages){let n=e.sheet.getPageSheet(r.id),o=await n.getData(),c=(await n._renderInner(o)).get(),m=$(c[c.length-1]).html();r.type=="video"&&(m=`<div class="video-container">${m}</div>`),t+=m}let a=this.findSceneNote(e.getFlag("dsa5","initId")),s=await TextEditor.enrichHTML(t,{secrets:game.user.isGM,async:!0});this.content=`<div><h1 class="journalHeader" data-uuid="${e.uuid}">${e.name}<div class="jrnIcons">${a}<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>${s}`;let i=$(this._element).find(".chapter");i.html(this.content),this.selectedSubChapter=e.id,$(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-jid="${e.id}"]`).addClass("selected"),Xe(i),i.find(".documentName-link, .entity-link, .content-link").click(r=>{let n=$(r.currentTarget);this.bookData&&n.attr("data-pack")==this.bookData.journal&&(r.stopPropagation(),this.loadJournalById(n.attr("data-id")))})}findSceneNote(e){if(e){let t=game.journal.find(a=>a.getFlag("dsa5","initId")==e);if(t&&t.sceneNote)return`<a class="showMapNote" data-entryId="${t.id}"><i class="fas fa-map-pin"></i></a>`}return""}async importBook(){game.user.isGM&&new Ks().render(this.bookData.moduleName)}async loadBook(e,t,a){a||(a=this.currentType),this.currentType=a,this.book=this[a].find(s=>s.id==e),await fetch(this.book.path).then(async s=>s.json()).then(async s=>{this.bookData=s;let i=game.packs.get(s.journal);await i.getIndex();let r=await i.getDocuments();this.journals=r,s.actors&&(i=game.packs.get(s.actors),r=await i.getIndex(),this.actors=r),s.scenes&&(i=game.packs.get(s.scenes),r=await i.getIndex(),this.scenes=r),this.checkChapters(i),this.loadPage(t)})}checkChapters(e){this.bookData.chapters||(this.bookData.isDynamic=!0,this.bookData.chapters=[{name:game.i18n.localize(`${this.bookData.moduleName}.name`),content:e.folders.map(t=>({name:t.name,id:t.id}))}])}async prefillActors(e){if(!e.actors)return[];let t=[],a=await game.folders.contents.find(i=>i.name==game.i18n.localize(`${this.bookData.moduleName}.name`)&&i.type=="Actor"&&i.folder==null),s=a?await game.folders.contents.filter(i=>i.type=="Actor"&&i.folder?.id==a.id).map(i=>i.id):void 0;for(let i of e.actors){let r=s?.length?game.actors.contents.find(m=>m.name==i&&s.includes(m.folder?.id)):void 0,n,o=r?.id,c=r?.uuid;r||(r=this.actors.find(m=>m.name==i),n=this.bookData.actors,o=r?._id,c=r?`Compendium.${n}.${o}`:void 0),t.push({name:i,actor:r,pack:n,id:o,uuid:c})}return t}async popJournal(e){(await fromUuid(e)).sheet.render(!0)}async showSzene(e,t="activate"){let a=game.scenes.contents.find(s=>s.name==e);if(!a)return ui.notifications.error(game.i18n.localize("DSAError.sceneNotInitialized"));switch(t){case"activate":a.activate();break;case"view":a.view();break;case"toggle":a.update({navigation:!a.navigation});break}}async getChapter(){if(this.book){if(this.content)return this.content;if(this.selectedChapter){if(this.selectedChapter=="prep"){let a={initDescr:game.i18n.format(`${this.bookData.moduleName}.importContent`,{defaultText:game.i18n.localize("importDefault")})},s=this.bookData.modules;for(let i of s)i.enabled=this.moduleEnabled(i.id);return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_preparation.html",{modules:s,info:a})}else if(this.selectedChapter=="foundryUsage")return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_foundry.html");let e=this.bookData.chapters.find(a=>a.name==this.selectedType).content.find(a=>a.id==this.selectedChapter),t=this.getSubChapters();return e.scenes||e.actors||t.length==0?await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_chapter.html",{chapter:e,subChapters:this.getSubChapters(),actors:await this.prefillActors(e)}):(this.selectedSubChapter=t[0].id,await this.loadJournalById(t[0].id))}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData})}else return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM})}filterBooks(e){let t=game.settings.get("dsa5","expansionPermissions");for(let a of e)t[a.id]!=null&&(a.visible=t[a.id]);return game.user.isGM?e:e.filter(a=>a.visible==null||a.visible).sort((a,s)=>a.id.localeCompare(s.id))}getSubChapters(){let e;return this.bookData.isDynamic?e=this.journals.filter(t=>t.folder.id==this.selectedChapter).sort((t,a)=>t.sort>a.sort?1:-1):e=this.journals.filter(t=>t.flags.dsa5.parent==this.selectedChapter).sort((t,a)=>t.flags.dsa5.sort>a.flags.dsa5.sort?1:-1),e.map(t=>({name:t.name,id:t.id,cssClass:t.id==this.selectedSubChapter?"selected":""}))}async getToc(){let e=[];if(this.book){if(e.push(...duplicate(this.bookData.chapters)),this.selectedChapter){let t;for(let a of e)if(t=a.content.find(s=>s.id==this.selectedChapter),t)break;t&&(t.cssClass="selected",t.subChapters=this.getSubChapters())}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_toc.html",{chapters:e,book:this.book,fulltextsearch:this.fulltextsearch?"on":""})}else return'<div class="libraryImg"></div>'}async loadPage(e){let t=await this.getChapter(),a=await this.getToc();e.find(".toc").html(a),e.find(".chapter").html(t)}async getData(e){let t=await super.getData(e),a=await this.getChapter(),s=await this.getToc(),i=game.settings.get("dsa5","journalFontSizeIndex"),r=y.journalFontSizes[i-1]||14;return mergeObject(t,{adventure:this.bookData,currentChapter:a,breadcrumbs:this.renderBreadcrumbs(),toc:s,fontSize:r}),t}async pinJournal(e,t=void 0){let a=this.readBreadCrumbs();t||(t=(await fromUuid(e))?.name||""),a[e]=t,game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(a)),this.render(!0)}unpinJournal(e){let t=this.readBreadCrumbs();delete t[e],game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(t)),this.render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch{return!1}t.type=="JournalEntry"&&this.pinJournal(t.pack?`Compendium.${t.pack}.${t.id}`:`JournalEntry.${t.id}`)}readBreadCrumbs(){let e={};try{e=JSON.parse(game.settings.get("dsa5",`breadcrumbs_${game.world.id}`))}catch{console.log("No Journalbrowser notes found")}return e}renderBreadcrumbs(){let e=this.readBreadCrumbs(),t=Object.entries(e).map(a=>`<div data-tooltip="${a[1]}" data-uuid="${a[0]}" class="openPin item">${a[1]}</div>`);return t.length>0?`<div id="breadcrumbs" class="breadcrumbs wrap row-section">${t.join("")}</div>`:""}moduleEnabled(e){return game.modules.get(e)?game.modules.get(e).active?"fa-check":"fa-dash":"fa-times"}},ht=ft;R(ht,"wizard");var Ks=class extends FormApplication{render(e){new game.dsa5.apps.DSA5Initializer("DSA5 Module Initialization",game.i18n.format(`${e}.importContent`,{defaultText:game.i18n.localize("importDefault")}),e,game.i18n.lang).render(!0)}},Ys=class{constructor(e){let t=e.pages.find(a=>!0).text.content;this.document={name:e.name,data:$("<div>").html(t).text(),id:e.id}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}};var xt=class{static registerButtons(){game.dsa5.apps.playerMenu=new ze,CONFIG.Canvas.layers.dsamenu={layerClass:Js,group:"interface"},Hooks.on("getSceneControlButtons",e=>{let t=[{name:"JournalBrowser",title:game.i18n.localize("Book.Wizard"),icon:"fa fa-book",button:!0,onClick:()=>{g.renderToggle(game.dsa5.apps.journalBrowser)}},{name:"Library",title:game.i18n.localize("SHEET.Library"),icon:"fas fa-university",button:!0,onClick:()=>{g.renderToggle(game.dsa5.itemLibrary)}},{name:"PlayerMenu",title:game.i18n.localize("PLAYER.title"),icon:"fas fa-dsa5-player",button:!0,onClick:()=>{g.renderToggle(game.dsa5.apps.playerMenu)}}];game.user.isGM&&(game.dsa5.apps.gameMasterMenu||(game.dsa5.apps.gameMasterMenu=new Xs),t.push({name:"mastersMenu",title:game.i18n.localize("gmMenu"),icon:"fa fa-dsa5",button:!0,onClick:()=>{g.renderToggle(game.dsa5.apps.gameMasterMenu)}})),e.push({name:"GM Menu",title:game.i18n.localize("gmMenu"),icon:"fas fa-dsa5",layer:"dsamenu",tools:t})})}},Js=class extends InteractionLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"dsamenu",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}selectObjects(e){canvas.tokens.selectObjects(e)}},Xs=class extends Application{constructor(e){super(e),this.heros=[],this.lastSkill=`${game.i18n.localize("LocalizedIDs.perception")}|skill`,this.randomCreation=[],game.user.isGM&&(Hooks.on("updateActor",async(t,a,s,i)=>{if(!this.rendered)return;let r=["system.status.fatePoints","system.status.wounds","system.status.karmaenergy","system.status.astralenergy"];this.heros.some(n=>n.id==t.id)&&r.reduce((n,o)=>n||hasProperty(a,o),!1)&&this.render()}),Hooks.on("updateScene",async(t,a,s,i)=>{let r=["darkness"];if(game.canvas.id==t.id&&r.reduce((n,o)=>n||hasProperty(a,o),!1)){if(game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.onDarknessChange(),!this.rendered)return;this.render()}}),Hooks.on("canvasInit",()=>{!this.rendered||this.render()}))}async _render(e=!1,t={}){if(!game.user.isGM)return ui.notifications.error("DSAError.onlyGMallowed");await super._render(e,t)}getSelectedActors(){let e=game.settings.get("dsa5","selectedActors"),t=game.settings.get("dsa5","trackedActors"),a={};for(let s of Object.keys(e))t.actors?.includes(s)&&(a[s]=e[s]);return a}activateListeners(e){super.activateListeners(e),e.find("select.select2").select2(),se(e),e.find(".heroLink").click(a=>{a.stopPropagation(),game.actors.get(this.getID(a)).sheet.render(!0)}),e.find(".addGlobalMod").click(()=>this.addGlobalMod()),e.find(".globalModEnable").change(a=>this.toggleGlobalMod(a)),e.find(".removeGlobalMod").click(a=>this.removeGlobalMod(a)),e.find(".editGlobalMod").click(a=>this.editGlobalMod(a)),e.find(".heroSelector").change(a=>{a.stopPropagation();let s=this.getSelectedActors();s[this.getID(a)]=$(a.currentTarget).is(":checked"),game.settings.set("dsa5","selectedActors",s)}),e.find(".skillSelektor").change(a=>{a.stopPropagation(),this.lastSkill=$(a.currentTarget).val()}),e.find(".rollChar").click(a=>{a.stopPropagation(),this.rollAbility([this.getID(a)])}),e.find(".rollAll").click(a=>{a.stopPropagation(),this.rollAbility(this.selectedIDs())}),e.find(".pay").click(a=>{a.stopPropagation(),this.doPayment([this.getID(a)],!0)}),e.find(".actorItem").click(async a=>{a.stopPropagation();let s=a.currentTarget.dataset.uuid;(await fromUuid(s)).sheet.render(!0)}),e.find(".getPaid").click(a=>{a.stopPropagation(),this.doPayment([this.getID(a)],!1)}),e.find(".resetSightThresholds").click(()=>this.resetSightThresholds()),e.find(".payAll").click(a=>{a.stopPropagation(),this.doPayment(this.selectedIDs(a),!0)}),e.find(".getPaidAll").click(a=>{a.stopPropagation(),this.doPayment(this.selectedIDs(a),!1)}),e.find(".selectAll").change(a=>this._selectAll(a,e)),e.find(".exp").click(a=>{a.stopPropagation(),this.getExp([this.getID(a)])}),e.find(".expAll").click(a=>{a.stopPropagation(),this.getExp(this.selectedIDs())}),e.find(".randomPlayer").mousedown(a=>{a.stopPropagation(),this._randomPlayer(e,a)}),e.find(".requestRoll").click(a=>{a.stopPropagation(),this.rollRequest()}),e.find(".heroSelector").click(a=>a.stopPropagation()),e.find(".hero").click(a=>{a.stopPropagation(a),$(a.currentTarget).find(".expandDetails").fadeToggle()});let t=a=>this._deleteHero(a);e.find(".hero").mouseenter(a=>{if(a.currentTarget.getElementsByClassName("hovermenu").length==0){let s=document.createElement("div");s.classList.add("hovermenu");let i=document.createElement("i");i.classList.add("fas","fa-times"),i.title=game.i18n.localize("SHEET.DeleteItem"),i.addEventListener("click",t,!1),s.appendChild(i),a.currentTarget.appendChild(s)}}),e.find(".hero").mouseleave(a=>{let s=a.toElement||a.relatedTarget;!s||s.parentNode==this||s==this||a.currentTarget.querySelectorAll(".hovermenu").forEach(i=>i.remove())}),e.find(".addGroupSchip").click(async a=>{await this.changeGroupSchipCount(Number(a.currentTarget.dataset.value))}),e.find(".groupschip").click(a=>{this.changeGroupSchip(a)}),e.find(".addFolder").click(async a=>this.editFolder(a)),e.find(".editFolder").change(async a=>this._editFolder(a)),e.find(".heroschip").click(a=>{a.stopPropagation(),a.preventDefault();let s=Number(a.currentTarget.getAttribute("data-val"));s==1&&$(a.currentTarget).closest(".hero").find(".fullSchip").length==1&&(s=0),game.actors.get(this.getID(a)).update({"system.status.fatePoints.value":s})}),e.find(".groupCheck").click(a=>{a.stopPropagation(),this.doGroupCheck()}),e.find(".changeSetting").change(async a=>{await game.settings.set("dsa5",a.currentTarget.name,a.currentTarget.checked)}),e.find(".changeSightTreshold").change(async a=>{$(a.currentTarget).closest(".row-section").find(".range-value").text(a.currentTarget.value),this.updateSightThreshold(a)}),e.find(".updateDarkness").change(async a=>{$(a.currentTarget).closest(".row-section").find(".range-value").text(a.currentTarget.value),this.updateDarkness(a)});for(let a of this.randomCreation)a.activateListeners(e);Vt(e,".heros",this.updateHeroOrder,".hero"),e.on("dragstart",".hero",a=>{a.stopPropagation();let s=a.currentTarget,i={type:"Actor",uuid:s.dataset.uuid};a.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(i))}),e.find(".dragEveryone").each(function(a,s){s.setAttribute("draggable",!0)}),e.on("dragstart",".dragEveryone",a=>this._dragEveryone(a)),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.activateButtonListener(e)}async _dragEveryone(e){e.stopPropagation();let t;e.currentTarget.dataset.folder?t=expandObject(game.settings.get("dsa5","masterSettings")).folders.find(i=>i.id==e.currentTarget.dataset.folder).content:t=this.selectedIDs();let a={type:"GroupDrop",ids:t};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(a))}async _selectAll(e,t){e.stopPropagation();let a=".heroSelector";e.currentTarget.dataset.folder&&(a=`[data-id="${e.currentTarget.dataset.folder}"] .heroSelector`);let s=t.find(a);s.prop("checked",$(e.currentTarget).is(":checked")),s.change()}async _deleteHero(e){e.stopPropagation(),e.preventDefault();let t=$(e.currentTarget).closest(".hero").attr("data-id"),a=game.settings.get("dsa5","trackedActors").actors||[],s=a.indexOf(t);s>-1&&(a.splice(s,1),await game.settings.set("dsa5","trackedActors",{actors:a}),this.render(!0))}async updateHeroOrder(e){let t=[];for(let a of e.querySelectorAll(".hero"))t.push(a.dataset.id);await game.settings.set("dsa5","trackedActors",{actors:t})}async updateDarkness(e){canvas.scene&&canvas.scene.update({darkness:Number(e.currentTarget.value)},{animateDarkness:3e3})}async updateSightThreshold(e){let t=Number(e.currentTarget.dataset.index),a=Number(e.currentTarget.value),s=game.settings.get("dsa5","sightOptions").split("|");s[t]=a,await game.settings.set("dsa5","sightOptions",s.join("|"))}async resetSightThresholds(){await game.settings.set("dsa5","sightOptions",game.settings.settings.get("dsa5.sightOptions").default),this.render(!0)}getGroupSchipSetting(){return game.settings.get("dsa5","groupschips").split("/").map(e=>Number(e))}async changeGroupSchipCount(e){let t=this.getGroupSchipSetting();t[1]=Math.max(0,t[1]+e),t[0]=Math.min(t[1],t[0]),await game.settings.set("dsa5","groupschips",t.join("/"))}async changeGroupSchip(e){let t=Number(e.currentTarget.getAttribute("data-val"));t==1&&$(e.currentTarget).closest(".col").find(".fullSchip").length==1&&(t=0);let a=this.getGroupSchipSetting();a[0]=t,await game.settings.set("dsa5","groupschips",a.join("/"))}async _createFolder(){let e=expandObject(game.settings.get("dsa5","masterSettings"));e.folders||(e.folders=[]),e.folders.push({id:randomID(),name:game.i18n.localize("FOLDER.ExportNewFolder"),content:[]}),await game.settings.set("dsa5","masterSettings",e),await this.render(!0)}async _deleteFolder(e){let t=e.currentTarget.dataset.id,a=expandObject(game.settings.get("dsa5","masterSettings"));a.folders=a.folders.filter(s=>s.id!=t),await game.settings.set("dsa5","masterSettings",a),await this.render(!0)}async _editFolder(e){let t=e.currentTarget.dataset.id,a=expandObject(game.settings.get("dsa5","masterSettings"));a.folders.find(s=>s.id==t).name=e.currentTarget.value,await game.settings.set("dsa5","masterSettings",a)}async editFolder(e){switch(e.currentTarget.dataset.action){case"create":this._createFolder();break;case"delete":this._deleteFolder(e);break}}async addGlobalMod(){new ta().render(!0)}async editGlobalMod(e){let t=e.currentTarget.dataset.key;new ta(t).render(!0)}async toggleGlobalMod(e){let t=game.settings.get("dsa5","masterSettings");t.globalMods[e.currentTarget.dataset.key].enabled=e.currentTarget.checked,await game.settings.set("dsa5","masterSettings",t)}async removeGlobalMod(e){let t=game.settings.get("dsa5","masterSettings");delete t.globalMods[e.currentTarget.dataset.key],await game.settings.set("dsa5","masterSettings",t),this.render()}async _randomPlayer(e,t){let a=e.find(".hero"),s=await this.rollRandomPlayer(t.button==2);$(t.currentTarget).find("i").addClass("fa-spin"),a.removeClass("victim"),setTimeout(()=>{$(this._element).find(`.hero[data-id="${s}"]`).addClass("victim"),$(t.currentTarget).find("i").removeClass("fa-spin")},500)}async rollRandomPlayer(e){let t={},a=1,s=this.getSelectedActors(),i=Object.values(s).filter(o=>o).length!=0,r=this.heros.length?this.heros:await this.getTrackedHeros();for(let o of r)!s[o.id]&&i||(t[a]=o.id,a++,e&&O.hasVantage(o,game.i18n.localize("LocalizedIDs.misfortune"))&&(t[a]=o.id,a++),e&&o.hasCondition("badluck")&&(t[a]=o.id,a++));let n=(await new Roll(`1d${a-1}`).evaluate({async:!0})).total;return t[n]}async doPayment(e,t,a=0){let s=game.actors.filter(o=>e.includes(o.id)),i=this.getNames(s),r=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:a,text:game.i18n.localize(game.i18n.format(t?"MASTER.payText":"MASTER.getPaidText",{heros:i}))}),n=o=>{let c=o.find(".input-text").val();for(let m of s)j.handlePayAction(void 0,t,c,m)};this.buildDialog(game.i18n.localize(t?"MASTER.payTT":"PAYMENT.payButton"),r,n)}async getPaid(e){this.doPayment(e,!1)}async getExp(e,t=0){let a=game.actors.filter(r=>e.includes(r.id)),s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:t,text:game.i18n.localize(game.i18n.format("MASTER.awardXPText",{heros:this.getNames(a)}))}),i=async r=>{let n=Number(r.find(".input-text").val()),o=Math.max(1,Math.round(n*.25)),c=[],m=[];if(!isNaN(n)){for(let d of a){let u=n;d.system.isFamiliar||d.system.isPet?(u=o,m.push(d)):c.push(d),await d.update({"system.details.experience.total":d.system.details.experience.total+u})}c.length>0&&await ChatMessage.create(g.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:this.getNames(c),number:n}))),m.length>0&&await ChatMessage.create(g.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:this.getNames(m),number:n}))),this.rendered&&this.render(!0)}};this.buildDialog(game.i18n.localize("MASTER.awardXP"),s,i)}getNames(e){return e.map(t=>t.name).join(", ")}buildDialog(e,t,a){new te({title:e,content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:s=>{a(s)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain")),t=await Actor.implementation.fromDropData(t)}catch{return!1}if(t.documentName=="Actor"){let a=game.settings.get("dsa5","trackedActors");a=a.actors||[],a.indexOf(t.id)==-1&&!t.pack&&(a.push(t.id),await game.settings.set("dsa5","trackedActors",{actors:a}),this.render(!0));let s=$(e.target).closest(".isFolder"),i=expandObject(game.settings.get("dsa5","masterSettings"));s.length?i.folders=i.folders.map(r=>(r.content=r.content.filter(n=>n!=t.id),r.id==s[0].dataset.id&&r.content.push(t.id),r)):i.folders=i.folders.map(r=>(r.content=r.content.filter(n=>n!=t.id),r)),await game.settings.set("dsa5","masterSettings",i),this.render(!0)}}selectedIDs(){let e=[],t=this.getSelectedActors();for(let[a,s]of Object.entries(t))s&&e.push(a);return e.length?e:game.settings.get("dsa5","trackedActors").actors||[]}async doGroupCheck(e=0){let[t,a]=this.lastSkill.split("|");if(a!="skill")return;let s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:e,text:game.i18n.localize(game.i18n.format("MASTER.doGroupCheck",{skill:t}))}),i=r=>{let n=Number(r.find(".input-text").val()),[o,c]=this.lastSkill.split("|");c=="skill"&&G.showGCMessage(o,n)};this.buildDialog(game.i18n.localize("HELP.groupcheck"),s,i)}async rollRequest(e=0){let[t,a]=this.lastSkill.split("|");if(a!="skill")return;let s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{amount:e,text:game.i18n.localize(game.i18n.format("MASTER.doRequestRoll",{skill:t}))}),i=r=>{let n=Number(r.find(".input-text").val()),[o,c]=this.lastSkill.split("|");c=="skill"&&G.showRQMessage(o,n)};this.buildDialog(game.i18n.localize("HELP.request"),s,i)}rollAbility(e){let[t,a]=this.lastSkill.split("|");switch(a){case"skill":this.rollSkill(e,t);break;case"attribute":this.rollAttribute(e,t);break;case"regeneration":this.rollRegeneration(e);break}}rollRegeneration(e){let t=game.actors.filter(a=>e.includes(a.id));for(let a of t)a.setupRegeneration("regenerate",{rollMode:"blindroll",subtitle:` (${a.name})`},void 0).then(s=>{a.basicTest(s)})}rollAttribute(e,t){let a=game.actors.filter(i=>e.includes(i.id)),s=Object.keys(game.dsa5.config.characteristics).find(i=>game.i18n.localize(game.dsa5.config.characteristics[i])==t);for(let i of a)i.setupCharacteristic(s,{rollMode:"blindroll",subtitle:` (${i.name})`},void 0).then(r=>{i.basicTest(r)})}rollSkill(e,t){let a=game.actors.filter(s=>e.includes(s.id));for(let s of a){let i=s.items.find(r=>r.name==t&&r.type=="skill");s.setupSkill(i,{rollMode:"blindroll",subtitle:` (${s.name})`},void 0).then(r=>{s.basicTest(r)})}}getID(e){return $(e.currentTarget).closest(".hero").attr("data-id")}static get defaultOptions(){let e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","masterMenu","sheet"]),width:470,height:740,title:game.i18n.localize("gmMenu"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/mastermenu.html",e.resizable=!0,e}async getTrackedHeros(){let e=game.settings.get("dsa5","trackedActors"),t=[];return e.actors&&e.actors.length>0?t=game.actors.filter(a=>e.actors.includes(a.id)).sort((a,s)=>e.actors.indexOf(a.id)-e.actors.indexOf(s.id)):(t=game.actors.filter(a=>a.hasPlayerOwner),await game.settings.set("dsa5","trackedActors",{actors:t.map(a=>a.id)})),t}async getData(e){let t=await super.getData(e),a=await this.getTrackedHeros(),s=_.getGroupSchips(),i=game.settings.get("dsa5","sightOptions").split("|"),r=/ \[[a-zA-Zäöü\d-]+\]/,n=[1,2,3,4].map(u=>({label:game.i18n.localize(`VisionDisruption.step${u}`).replace(r,""),value:i[u-1]}));t.sceneConfig={sceneAutomationEnabled:game.settings.get("dsa5","sightAutomationEnabled"),enableDPS:game.settings.get("dsa5","enableDPS"),lightSightCompensationEnabled:game.settings.get("dsa5","lightSightCompensationEnabled"),visions:n,darkness:canvas.scene?.darkness||0},this.heros=a;let o=this.getSelectedActors(),c=expandObject(game.settings.get("dsa5","masterSettings")),m=[],d=(c.folders||[]).map(u=>(u.contents=[],u.content=new Set(u.content),u));for(let u of a){let p=duplicate(u),f=[],h=[],w=[];for(let v of p.items)switch(v.type){case"disadvantage":f.push({name:v.name,uuid:v.uuid});break;case"advantage":h.push({name:v.name,uuid:v.uuid});break;case"money":w.push(v);break}mergeObject(p,{id:u.id,uuid:u.uuid,selected:o[u.id],schips:u.schipshtml(),purse:w.sort((v,L)=>L.system.price.value-v.system.price.value).map(v=>`<span data-tooltip="${v.name}">${v.system.quantity.value}</span>`).join(" - "),advantages:h,disadvantages:f,system:{status:{wounds:{max:u.system.status.wounds.max},astralenergy:{max:u.system.status.astralenergy.max},karmaenergy:{max:u.system.status.karmaenergy.max}},isMage:u.system.isMage,isPriest:u.system.isPriest}});let z=!1;for(let v of d)if(v.content.has(u.id)){v.contents.push(p),z=!0;break}z||m.push(p)}if(!this.abilities){let u=await g.allSkillsList();this.abilities=u.map(p=>({name:p,type:"skill"})).concat(Object.values(game.dsa5.config.characteristics).map(p=>({name:game.i18n.localize(p),type:"attribute"})).concat({name:game.i18n.localize("regenerate"),type:"regeneration"})).sort((p,f)=>p.name.localeCompare(f.name))}return mergeObject(t,{hasHeros:a.length>0,heros:m,folders:d,abilities:this.abilities,groupschips:s,masterSettings:c,lastSkill:this.lastSkill,randomCreation:this.randomCreation.map(u=>u.template),lightButton:game.dsa5.apps.LightDialog?await game.dsa5.apps.LightDialog.getButtonHTML():""}),t}registerRandomCreation(e){this.randomCreation.push(e)}},ta=class extends FormApplication{constructor(e){super(),this.mod_id=e}static get defaultOptions(){let e=super.defaultOptions;return e.template="systems/dsa5/templates/system/global-mod-addition.html",e.title=game.i18n.localize("MASTER.addGlobalMod"),e.width=400,e.resizable=!0,e}activateListeners(e){super.activateListeners(e),e.find(".addGlobalMod").click(t=>this.addGlobalMod(t))}async getData(e){let t=await super.getData(e);return this.mod_id?t.config=expandObject(game.settings.get("dsa5","masterSettings").globalMods[this.mod_id]):t.config={value:0,victim:{npc:!0,player:!0}},t.categories=["skill","spell","meleeweapon","rangeweapon","ritual","ceremony","liturgy","trait"],t}async addGlobalMod(e){e.preventDefault();let t=expandObject(game.settings.get("dsa5","masterSettings")),a=expandObject(new FormDataExtended($(this._element).find("form")[0]).object);a.enabled=!0,a.name&&(this.mod_id?t.globalMods[this.mod_id]=a:mergeObject(t,{globalMods:{[randomID()]:a}}),await game.settings.set("dsa5","masterSettings",t),game.dsa5.apps.gameMasterMenu.render(),this.close())}};var zt=class extends je(Ie){static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/creature-merchant-sheet.html"}};var Pt=class extends je(ke){static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/character-merchant-sheet.html"}};var Nt=class extends JournalSheet{static get defaultOptions(){let e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","dsajournal"])}),e}};function $i(){pi(),gi(),fi(),hi(),yi(),ki(),oi(),wi(),vi(),Si(),Di(),oa(),Ai(),Ei()}Hooks.once("init",()=>{loadTemplates(["systems/dsa5/templates/actors/actor-main.html","systems/dsa5/templates/actors/actor-talents.html","systems/dsa5/templates/items/item-description.html","systems/dsa5/templates/dialog/default-dialog.html","systems/dsa5/templates/dialog/parts/targets.html","systems/dsa5/templates/dialog/enhanced-default-dialog.html","systems/dsa5/templates/dialog/default-combat-dialog.html","systems/dsa5/templates/chat/roll/test-card.html","systems/dsa5/templates/items/item-equipment.html","systems/dsa5/templates/items/item-enchantment.html","systems/dsa5/templates/actors/actor-combat.html","systems/dsa5/templates/actors/actor-equipment.html","systems/dsa5/templates/actors/actor-notes.html","systems/dsa5/templates/dialog/parts/spellmodifiers.html","systems/dsa5/templates/dialog/parts/canChangeCastingTime.html","systems/dsa5/templates/actors/parts/schipspart.html","systems/dsa5/templates/chat/post-item.html","systems/dsa5/templates/items/item-stat.html","systems/dsa5/templates/items/item-extension.html","systems/dsa5/templates/actors/creature/creature-main.html","systems/dsa5/templates/actors/creature/creature-loot.html","systems/dsa5/templates/actors/creature/creature-notes.html","systems/dsa5/templates/actors/creature/creature-magic.html","systems/dsa5/templates/system/masterHeros.html","systems/dsa5/templates/actors/creature/creature-religion.html","systems/dsa5/templates/actors/parts/characteristics-large.html","systems/dsa5/templates/actors/parts/gearSearch.html","systems/dsa5/templates/actors/parts/magicalSigns.html","systems/dsa5/templates/actors/parts/containerContent.html","systems/dsa5/templates/actors/npc/npc-main.html","systems/dsa5/templates/actors/character/actor-magic.html","systems/dsa5/templates/actors/character/actor-religion.html","systems/dsa5/templates/actors/character/actor-aggregatedtests.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-small.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-large.html","systems/dsa5/templates/actors/parts/status_effects.html","systems/dsa5/templates/actors/parts/purse.html","systems/dsa5/templates/actors/parts/horse.html","systems/dsa5/templates/actors/parts/healthbar.html","systems/dsa5/templates/actors/merchant/merchant-commerce.html","systems/dsa5/templates/items/item-header.html","systems/dsa5/templates/items/item-effects.html","systems/dsa5/templates/items/item-aoe.html","systems/dsa5/templates/items/traditionArtifact.html","systems/dsa5/templates/status/advanced_functions.html","systems/dsa5/templates/actors/parts/information.html","systems/dsa5/templates/actors/parts/personaltrait.html","systems/dsa5/templates/actors/parts/combatskills.html","systems/dsa5/templates/actors/parts/attributes.html","systems/dsa5/templates/actors/parts/swarm.html","systems/dsa5/templates/actors/parts/carryandpurse.html","systems/dsa5/templates/actors/parts/specialabilities.html","systems/dsa5/templates/actors/parts/experienceBox.html","systems/dsa5/templates/actors/parts/temperature.html","systems/dsa5/templates/actors/parts/temperatureSmall.html","systems/dsa5/templates/actors/parts/spells.html","systems/dsa5/templates/dialog/parts/expChoices.html","systems/dsa5/templates/actors/parts/liturgies.html","systems/dsa5/templates/items/browse/actor.html","systems/dsa5/templates/items/browse/garadan.html","systems/dsa5/templates/items/browse/culture.html","systems/dsa5/templates/items/browse/species.html","systems/dsa5/templates/items/browse/career.html","systems/dsa5/templates/actors/parts/specblock.html"]),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsa5",ke,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsa5",Ie,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsa5",Ee,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsa5",ve,{types:["npc"]}),Actors.registerSheet("dsa5",zt,{types:["creature"]}),Actors.registerSheet("dsa5",Pt,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsa5",_DSAActiveEffectConfig,{makeDefault:!0}),Journal.registerSheet("dsa5",Nt,{makeDefault:!0}),V.setupSheets(),Hooks.call("registerDSAstyle",y.styles),Ti(),K.initDoorMinDistance(),mergeObject(CONFIG.JournalEntry.noteIcons,y.noteIcons),U.prepareSoundEffects(),$("body").addClass(game.settings.get("dsa5","globalStyle"))});Hooks.once("setup",()=>{if(!["de","en"].includes(game.i18n.lang))console.warn(`DSA5 - ${game.i18n.lang} is not a supported language. Falling back to default language.`),fr();else{let l=game.settings.get("dsa5","forceLanguage");["de","en"].includes(l)&&game.i18n.lang!=l&&hr(l)}ht.initHook(),Ii(),xt.registerButtons(),Se.registerButtons(),CONFIG.Canvas.lightAnimations.daylight={label:"LIGHT.daylight",illuminationShader:aa},O.setupFunctions(),N.setupFunctions()});Hooks.once("i18nInit",()=>{yr()});var Qs=class extends Dialog{async close(e={}){if(!!["de","en"].includes(game.i18n.lang))return super.close(e)}},fr=()=>{let l={title:game.i18n.localize("language"),content:"<p>Your foundry language is not supported by this system. Due to technical reasons your foundry language setting has to be switched to either english or german.</p>",buttons:{de:{icon:'<i class="fa fa-check"></i>',label:"en",callback:async()=>{await game.settings.set("core","language","de"),foundry.utils.debouncedReload()}},en:{icon:'<i class="fas fa-check"></i>',label:"de",callback:async()=>{await game.settings.set("core","language","en"),foundry.utils.debouncedReload()}},logout:{icon:'<i class="fas fa-door-closed"></i>',label:game.i18n.localize("SETTINGS.Logout"),callback:async()=>{ui.menu.items.logout.onClick()}}}};new Qs(l).render(!0)},hr=l=>{let e={title:game.i18n.localize("DSASETTINGS.forceLanguage"),content:game.i18n.format("DSAError.wrongLanguage",{lang:l}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async()=>{await game.settings.set("core","language",l),foundry.utils.debouncedReload()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new Dialog(e).render(!0)};function yr(){game.dsa5.config.knownShortcuts={[game.i18n.localize("CHARAbbrev.INI").toLowerCase()]:["status","initiative","gearmodifier"],[game.i18n.localize("CHARAbbrev.GS").toLowerCase()]:["status","speed","gearmodifier"],[game.i18n.localize("CHARAbbrev.AsP").toLowerCase()]:["status","astralenergy","gearmodifier"],[game.i18n.localize("CHARAbbrev.LeP").toLowerCase()]:["status","wounds","gearmodifier"],[game.i18n.localize("CHARAbbrev.KaP").toLowerCase()]:["status","karmaenergy","gearmodifier"],[game.i18n.localize("CHARAbbrev.AW").toLowerCase()]:["status","dodge","gearmodifier"],[game.i18n.localize("CHARAbbrev.SK").toLowerCase()]:["status","soulpower","gearmodifier"],[game.i18n.localize("CHARAbbrev.ZK").toLowerCase()]:["status","toughness","gearmodifier"],[game.i18n.localize("CHARAbbrev.FtP").toLowerCase()]:["status","fatePoints","gearmodifier"]};for(let l of Object.keys(y.characteristics))game.dsa5.config.knownShortcuts[game.i18n.localize(`CHARAbbrev.${l.toUpperCase()}`).toLowerCase()]=["characteristics",l.toLowerCase(),"gearmodifier"]}var yt=class extends AdaptiveIlluminationShader{},aa=yt;R(aa,"fragmentShader",`
    ${yt.SHADER_HEADER}
    ${yt.PERCEIVED_BRIGHTNESS}

    void main() {
        ${yt.FRAGMENT_BEGIN}
        ${yt.TRANSITION}
       
        // Darkness
        framebufferColor = max(framebufferColor, colorBackground);        
        // Elevation
        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        
        // Final
        gl_FragColor = vec4(finalColor, 1.0);
      }`);var Lt=class{static weaponLessMacro(e){let t=ChatMessage.getSpeaker(),a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor)),this.runWeaponless(a,e,t.token)}static weaponLessMacroId(e,t){let a=game.actors.get(t);this.runWeaponless(a,e)}static requestRoll(e,t=0){G.showRQMessage(e,t)}static requestGC(e,t=0,a={}){G.showGCMessage(e,t,a)}static rollCh(e,t={}){Z.check3D20(void 0,e,t)}static itemMacroById(e,t,a,s){let i=game.actors.get(e),r=i?i.items.find(n=>n.name===t&&n.type==a):null;this.runItem(i,r,t,s)}static itemMacro(e,t,a){let s=ChatMessage.getSpeaker(),i;s.token&&(i=game.actors.tokens[s.token]),i||(i=game.actors.get(s.actor));let r=i?i.items.find(n=>n.name===e&&n.type==t):null;this.runItem(i,r,e,a,s.token)}static charMacroById(e,t){let a=game.actors.get(t);this.runChar(a,e)}static charMacro(e){let t=ChatMessage.getSpeaker(),a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor)),this.runChar(a,e,t.token)}static runWeaponless(e,t,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));let s=t.split("Weaponless")[0];e.setupWeaponless(s,{},a).then(i=>{e.basicTest(i)})}static runChar(e,t,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));e.setupDodge({},a).then(s=>{e.basicTest(s)})}static runItem(e,t,a,s,i){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:a}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,s.mod,s,i).then(r=>{e.basicTest(r)});case"rangeweapon":return e.setupWeapon(t,"attack",s,i).then(r=>{e.basicTest(r)});case"skill":return e.setupSkill(t,s,i).then(r=>{e.basicTest(r)});case"ceremony":case"ritual":case"spell":case"liturgy":return e.setupSpell(t,s,i).then(r=>{e.basicTest(r)})}}};var Oi={};Hooks.once("ready",()=>{Promise.all([g.allSkillsList(),g.allCombatSkills()]).then(l=>{let e=l[0].reduce((n,o)=>({...n,[o]:o}),{}),t=l[1].filter(n=>n.system.weapontype.value=="range").sort((n,o)=>n.name.localeCompare(o.name)).reduce((n,o)=>({...n,[o.name]:o.name}),{}),a=l[1].filter(n=>n.system.weapontype.value=="melee").sort((n,o)=>n.name.localeCompare(o.name)).reduce((n,o)=>({...n,[o.name]:o.name}),{}),s=l[1].concat([{name:game.i18n.localize("LocalizedIDs.all")}]).sort((n,o)=>n.name.localeCompare(o.name)).reduce((n,o)=>({...n,[o.name]:o.name}),{}),i=[];for(let[n,o]of Object.entries(y.specialAbilityCategories))n=="clerical"?i.push(`</optgroup><optgroup label="${game.i18n.localize("SpecCategory.clerical")}">`):n=="magical"&&i.push(`</optgroup><optgroup label="${game.i18n.localize("SpecCategory.magical")}">`),i.push(`<option value="${n}">${game.i18n.localize(o)}</option>`);let r=`<div class="form-group">
            <label class="label-text">${game.i18n.localize("Category")}</label>
            <select name="category.value" data-dtype="String">
                <option value="">${game.i18n.localize("Library.noFilter")}</option>          
                <optgroup label="${game.i18n.localize("SpecCategory.general")}">
                ${i.join("")}
                </optgroup>
            </select>
        </div>`;mergeObject(Oi,{ammunition:[{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:y.ammunitiongroups}],equipment:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:y.equipmentTypes}],rangeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill.value",type:"select",options:t},{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:y.ammunitiongroups}],meleeweapon:[{label:"TYPES.Item.combatskill",attr:"combatskill.value",type:"select",options:a},{label:"guidevalue",attr:"guidevalue.value",type:"select",options:y.combatskillsGuidevalues},{label:"reach",attr:"reach.value",type:"select",options:y.meleeRanges}],poison:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:y.magicResistanceModifiers}],disease:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:y.magicResistanceModifiers}],consumable:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:y.equipmentTypes}],application:[{label:"TYPES.Item.skill",attr:"skill",type:"select",options:e}],trait:[{label:"traitType",attr:"traitType.value",type:"select",options:y.traitCategories}],career:[{label:"mageLevel",attr:"mageLevel.value",type:"select",options:y.mageLevels}],specialability:[{type:"prerendered",attr:"category.value",content:r},{label:"TYPES.Item.combatskill",attr:"list.value",type:"select",options:s,notStrict:!0},{label:"distribution",attr:"distribution",type:"text"}],liturgy:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:y.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spell:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:y.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ritual:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:y.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ceremony:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:y.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spellextension:[{label:"Category",attr:"category",type:"select",options:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}],magictrick:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"},{label:"distribution",attr:"distribution",type:"text"}],blessing:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],npc:[{label:"TYPES.Item.species",attr:"details.species.value",type:"text"},{label:"TYPES.Item.career",attr:"details.career.value",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture.value",type:"text"}],character:[{label:"TYPES.Item.species",attr:"details.species.value",type:"text"},{label:"TYPES.Item.career",attr:"details.career.value",type:"text"},{label:"TYPES.Item.culture",attr:"details.culture.value",type:"text"}],creature:[{label:"creatureClass",attr:"creatureClass.value",type:"text"},{label:"sizeCategory",attr:"status.size.value",type:"select",options:y.sizeCategories}],armor:[{label:"protection",attr:"protection.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}},{label:"encumbrance",attr:"encumbrance.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4"}}],plant:[{label:"PLANT.landscape",attr:"location.landscape",type:"text"},{label:"PLANT.region",attr:"location.region",type:"text"},{label:"PLANT.healing",attr:"planttype.healing",type:"checkbox"},{label:"PLANT.poison",attr:"planttype.poison",type:"checkbox"},{label:"PLANT.physical",attr:"planttype.physical",type:"checkbox"},{label:"PLANT.psychic",attr:"planttype.psychic",type:"checkbox"},{label:"PLANT.crop",attr:"planttype.crop",type:"checkbox"},{label:"PLANT.defensive",attr:"planttype.defensive",type:"checkbox"},{label:"PLANT.supernatural",attr:"planttype.supernatural",type:"checkbox"},{label:"PLANT.highNorth",attr:"availability.highNorth",type:"range"},{label:"PLANT.grasLands",attr:"availability.grasLands",type:"range"},{label:"PLANT.swamps",attr:"availability.swamps",type:"range"},{label:"PLANT.woods",attr:"availability.woods",type:"range"},{label:"PLANT.jungle",attr:"availability.jungle",type:"range"},{label:"PLANT.mountains",attr:"availability.mountains",type:"range"},{label:"PLANT.desert",attr:"availability.desert",type:"range"},{label:"PLANT.maraskan",attr:"availability.maraskan",type:"range"}],magicalsign:[],patron:[],demonmark:[],essence:[],imprint:[{label:"Category",attr:"category",type:"text"}]})})});var sa=Oi;var Rt=class{constructor(e,t={}){let a=e.documentName||e.type;switch(e.documentName){case"Actor":case"Item":a=e.type;break}let s="";if(game.settings.get("dsa5","indexDescription"))switch(a){case"creature":case"npc":case"character":s=getProperty(e,"system.description.value");break;case"JournalEntry":s=getProperty(e,"system.content");break;default:s=getProperty(e,"description.value")}this.document={name:e.name,filterType:a,data:$("<div>").html(s).text(),id:e.id||e._id,visible:e.visible?e.visible:!0,compendium:e.compendium?e.compendium.metadata.packageName:t.packageName||"",pack:e.pack||(t.packageName?t.id:void 0),img:e.img,price:e.system?.price?.value}}get uuid(){if(this.document.compendium)return`Compendium.${this.document.pack}.${this.document.id}`;switch(this.itemType){case"character":case"creature":case"npc":return`Actor.${this.id}`;case"JournalEntry":return`JournalEntry.${this.id}`;default:return`Item.${this.id}`}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}get itemType(){return this.document.filterType}get hasPrice(){return y.equipmentCategories.has(this.document.filterType)}async getItem(){return await fromUuid(this.uuid)}hasPermission(){return this.document.visible}async render(){(await this.getItem()).sheet.render(!0)}get compendium(){return this.document.compendium}get img(){return this.itemType=="JournalEntry"?"systems/dsa5/icons/categories/DSA-Auge.webp":this.document.img}},ia=class extends Rt{constructor(e,t){super(e);let a=sa[t]||[];for(let s of a)this[s.attr]=s.attr.split(".").reduce((i,r)=>i[r]===void 0?{}:i[r],e.system)}},_t=class extends Application{constructor(e){super(e),this.advancedFiltering=!1,this.journalBuild=!1,this.journalWorldBuild=!1,this.equipmentBuild=!1,this.equipmentWorldBuild,this.zooBuild=!1,this.zooWorldBuild=!1,this.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),this.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"],tag:["itemType"]}}),this.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"],tag:["itemType"]}}),this.detailFilter={},this.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},this.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1,disease:!1,consumable:!1,plant:!1},filterBy:{search:""}},character:{categories:{career:!1,advantage:!1,combatskill:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1,application:!1,demonmark:!1,patron:!1,essence:!1,imprint:!1},filterBy:{search:""}},spell:{categories:{blessing:!1,ceremony:!1,liturgy:!1,magictrick:!1,ritual:!1,spell:!1,spellextension:!1,magicalsign:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}}}async getData(e){let t=await super.getData(e);return t.categories=this.translateFilters(),t.isGM=game.user.isGM,t.items=this.items,t.advancedMode=this.advancedFiltering?"on":"",t.worldIndexed=game.settings.get("dsa5","indexWorldItems")?"on":"",t.fullTextEnabled=game.settings.get("dsa5","indexDescription")?"on":"",t.filterDuplicateItems=game.settings.get("dsa5","filterDuplicateItems")?"on":"",t.browseEnabled=this.browseEnabled?"on":"",this.advancedFiltering&&(t.advancedFilter=await this.buildDetailFilter("tbd",this.subcategory)),t}translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo,"Actor"),journal:this.buildFilter(this.filters.journal)}}purgeAdvancedFilters(){for(let e in this.filters)for(let t in this.filters[e].categories)this.filters[e].categories[t]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then(e=>{$(this._element).find(".advancedSearch .groupbox").html(e)})}buildFilter(e,t="Item"){let a=[];return Object.keys(e.categories).forEach(function(s){a.push({label:game.i18n.localize(`TYPES.${t}.${s}`),selected:e.categories[s],key:s})}),a=a.sort(function(s,i){return s.label.localeCompare(i.label)}),a}static get defaultOptions(){let e=super.defaultOptions;return e.id="DSA5ItemLibrary",e.classes.push("dsa5","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("ItemLibrary"),e.template="systems/dsa5/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}async getRandomItems(e,t){let a=[],s=this.equipmentIndex;return a.push(...await s.search(e,{field:["itemType"]})),(await Promise.all(this.shuffle(a.filter(i=>i.hasPermission)).slice(0,t+5).map(i=>i.getItem()))).filter(i=>{let r=i.getFlag("dsa5","enchantments");return!r||!r.find(n=>n.talisman)}).slice(0,t)}shuffle(e){let t=e.length,a,s;for(;t!==0;)s=Math.floor(Math.random()*t),t-=1,a=e[t],e[t]=e[s],e[s]=a;return e}async findCompendiumItem(e,t,a=!0){this.equipmentBuild||await this.buildEquipmentIndex();let s={field:["name"],where:{itemType:t}},i=await this.equipmentIndex.search(e,s);return a&&(i=i.filter(r=>r.compendium!="")),await Promise.all(i.map(r=>r.getItem()))}async getCategoryItems(e,t=!1,a=!1){await this.buildEquipmentIndex();let s=this.equipmentIndex.search(e,{field:["itemType"]});return t?(await Promise.all(s.map(i=>i.getItem()))).map(i=>i.toObject()):a?await Promise.all(s.map(i=>i.getItem())):s}async executeAdvancedFilter(e,t,a,s,i,r=[]){let n=p=>{for(let f of a)if(f[2]?p[f[0]]!=f[1]:p[f[0]].indexOf(f[1])==-1)return!1;return!0},o=p=>{for(let f of s)if(p[f[0]].toLowerCase().indexOf(f[1])==-1)return!1;return!0},c=p=>{for(let f of i)if(p[f[0]]!=f[1])return!1;return!0},m=p=>{for(let f of r)if(p[f[0]]<f[1]||p[f[0]]>f[2])return!1;return!0},u=t.where(p=>(e==""||p.name.toLowerCase().indexOf(e)!=-1)&&n(p)&&o(p)&&c(p)&&m(p));return u=u.filter(p=>p.hasPermission).sort((p,f)=>p.name.toLowerCase()>f.name.toLowerCase()?1:-1),u}async advancedFilterStuff(e,t){let a=$(this._element).find(".detailFilters"),s=a.attr("data-subc"),i=this.filters[e].filterBy.search.toLowerCase(),r=this.detailFilter[s],n=[],o=[],c=[];for(let d of a.find("select")){let u=$(d).val();u!=""&&n.push([$(d).attr("name"),u,d.dataset.notstrict!="true"])}for(let d of a.find('input[type="text"]:not(.manualFilter)')){let u=$(d).val();u!=""&&o.push([$(d).attr("name"),u.toLowerCase()])}for(let d of a.find('input[type="checkbox"]:checked:not(.manualFilter)')){let u=$(d).val();u!=""&&c.push([$(d).attr("name"),u.toLowerCase()])}let m=await this.executeAdvancedFilter(i,r,n,o,c);return this.setBGImage(m,e),m=this.filterDuplications(m),m}filterDuplications(e){return game.settings.get("dsa5","filterDuplicateItems")&&(e=[...new Map(e.map(t=>[`${t.name}_${t.type}`,t])).values()]),e}async filterStuff(e,t,a){let s=this.filters[e].filterBy.search,i={field:["name","data"]},r=[],n=!1;for(let o in this.filters[e].categories){if(this.filters[e].categories[o]){let c,m=null;s==""?c=t.search(o,{field:["itemType"],sort:"name",where:{itemType:o}}):c=t.search(s,{...i,sort:"name",where:{itemType:o}});let d=Number(a)||0;c=c.slice(d,Math.min(d+60,c.length)),c.length==60&&(m=`${d+60}`),this.pages[e].next=m,r.push(...c)}n=this.filters[e].categories[o]||n}return n||(r=t.search(s,{...i,limit:60,page:a||!0,sort:"name"}),this.pages[e].next=r.next),r=r.result?r.result:r,r=r.filter(o=>o.hasPermission),this.setBGImage(r,e),r}setBGImage(e,t){$(this._element).find(`.${t} .libcontainer`)[`${e.length>0?"remove":"add"}Class`]("libraryImg")}async getItemTemplate(e,t){if(this.browseEnabled&&t=="Item")return(await Promise.all(e.map(async a=>{let s=`systems/dsa5/templates/items/browse/${a.document.filterType}.html`,i=await fromUuid(a.uuid),r=await renderTemplate(s,{document:i,isGM:game.user.isGM,...await i.sheet.getData()});return`<div class="uuid libItem ${a.document.filterType} col" data-uuid="${a.uuid}" data-item-id="${a.id}">${r}</div>`}))).join(`
`);{let a="systems/dsa5/templates/system/libraryItem.html";return await renderTemplate(a,{items:e})}}async renderResult(e,t,{index:a,itemType:s},i){let r=e.find(".searchResult .item-list"),n=await this.getItemTemplate(t,s);i||r.empty(),n=$(n);let o=(c,m,d,u=!1)=>{c.stopPropagation();let p=m.find(c.currentTarget.dataset.itemId);c.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:d,uuid:p.uuid,pay:u}))};n.each(function(){let c=$(this);c.attr("draggable",!0).on("dragstart",m=>o(m,a,s)),c.find(".priceDrag").attr("draggable",!0).on("dragstart",m=>o(m,a,s,!0))}),r.append(n)}async filterItems(e,t,a){let s=this.selectIndex(t),i=this.advancedFiltering&&t!="journal"?await this.advancedFilterStuff(t,a):await this.filterStuff(t,s.index,a);return await this.renderResult(e,i,s,a),i}selectIndex(e){let t="Item",a=this.equipmentIndex;switch(e){case"zoo":t="Actor",a=this.zooIndex;break;case"journal":t="JournalEntry",a=this.journalIndex;break}return{index:a,itemType:t}}async _render(e=!1,t={}){await super._render(e,t),this.buildEquipmentIndex()}async buildEquipmentIndex(){await this._createIndex("equipment","Item",game.items)}async _createIndex(e,t,a){if(this[`${e}Build`])return;SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:0});let s=$(this._element).find(`*[data-tab="${e}"]`);this.showLoading(s,e);let i=game.packs.filter(u=>u.documentName==t&&(game.user.isGM||!u.private)&&!u.metadata.label.startsWith("WZ-")),r=100/(i.length+1),n=r,o=["name","system.type","system.description.value","img"],c;t=="Actor"?c=u=>u.getIndex({actorFields:o}):t=="JournalEntry"?c=u=>u.getDocuments():c=u=>u.getDocuments({type__in:game.system.documentTypes.Item});let m=this.indexWorldItems(a,e);SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"world items"}),pct:Math.round(r)});let d=i.map(async u=>{let p=await c(u);n+=r,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:`${u.metadata.label} (${u.metadata.id})`}),pct:Math.round(n)}),m.push(...p.map(f=>new Rt(f,u.metadata)))});return Promise.all(d).then(u=>{this[`${e}Index`].add(m),this[`${e}Build`]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:100}),this.hideLoading(s,e)})}subcategoryFields(e){let t=["name","itemType"],a=sa[e]||[];for(let s of a)t.push(s.attr);return t}indexWorldItems(e,t){let a=[];return game.settings.get("dsa5","indexWorldItems")&&(a.push(...e.filter(s=>s.visible).map(s=>new Rt(s))),this[`${t}WorldBuild`]=!0),a}async createDetailIndex(e,t){if(!this.detailFilter[t]){let a=this.subcategoryFields(t),s=$(this._element).find(`*[data-tab="${e}"]`);s.find(".searchResult ul").html(""),this.showLoading(s,e),this.detailFilter[t]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:a}});let{index:i,itemType:r}=this.selectIndex(e),o=(r=="Item"?game.items:game.actors).filter(p=>p.visible&&p.type==t).map(p=>new ia(p,t)),c=i.search(t,{field:["itemType"]}),m={};for(let p of c)!p.document.pack||(m[p.document.pack]||(m[p.document.pack]=[]),m[p.document.pack].push(p.document.id));let d=[];for(let p of Object.entries(m))d.push(game.packs.get(p[0]).getDocuments({_id__in:p[1],type:t}));let u=await Promise.all(d);for(let p of u)o.push(...p.map(f=>new ia(f,t)));this.detailFilter[t].add(o),this.hideLoading(s,e)}}async buildDetailFilter(e,t){let a=sa[t]||[];if(a){let s=this.createDetailIndex(e,t),i=game.packs.filter(n=>n.metadata.type=="Item").reduce((n,o)=>{if(!n[o.metadata.packageName]){let c=game.i18n.has(`${o.metadata.packageName}.name`)?game.i18n.localize(`${o.metadata.packageName}.name`):game.modules.get(o.metadata.packageName)?.title.replace(/The Dark Eye 5th Ed. - /i,"")||"World";n[o.metadata.packageName]=c}return n},{}),r=await renderTemplate("systems/dsa5/templates/system/detailFilter.html",{fields:a,subcategory:t,moduleOptions:i});return await s,r}else return`<p>${game.i18n.localize("Library.selectAdvanced")}</p>`}checkWorldStuffIndex(){game.settings.get("dsa5","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}activateListeners(e){super.activateListeners(e),se(e),e.on("click",".searchableAbility a",i=>rt(i)),e.on("click",".toggleAdvancedMode",()=>{this.advancedFiltering=!this.advancedFiltering,this.advancedFiltering?($(this._element).find(".toggleAdvancedMode").addClass("on"),$(this._element).find(".advancedSearch").fadeIn(),this.purgeAdvancedFilters()):($(this._element).find(".toggleAdvancedMode").removeClass("on"),$(this._element).find(".advancedSearch").fadeOut())}),e.on("change",".detailFilters input, .detailFilters select",()=>{let i=$(this._element).find(".tab.active"),r=i.attr("data-tab");this.filterItems(i,r)}),e.on("click",".filter",async i=>{let r=$(i.currentTarget).closest(".tab"),n=r.attr("data-tab"),o=i.currentTarget.dataset.category,c=$(i.currentTarget).is(":checked");this.advancedFiltering&&c&&(this.purgeAdvancedFilters(),this.subcategory=o,$(i.currentTarget).prop("checked",c),$(this._element).find(".advancedSearch .groupbox").html(await this.buildDetailFilter(n,o))),this.filters[n].categories[o]=c,this.filterItems(r,n)}),e.on("click",".item-name",i=>{this.getItemFromHTML(i).render()}),e.on("mousedown",".item-name",i=>{i.button==2&&g.showArtwork(this.getItemFromHTML(i))}),e.on("keyup",".filterBy-search",i=>{let r=$(i.currentTarget).closest(".tab"),n=r.attr("data-tab");this.filters[n].filterBy.search=$(i.currentTarget).val(),this.filterItems(r,n)});let t=i=>{i.stopPropagation();let r=i.currentTarget.dataset.type,n=i.currentTarget.dataset.uuid;!n||!r||i.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:r,uuid:n}))},a=e.find(".show-item");a.click(async i=>{let r=i.currentTarget.dataset.uuid;(await fromUuid(r)).sheet.render(!0)}),a.attr("draggable",!0).on("dragstart",i=>t(i)),e.find('*[data-tab="journal"]').click(i=>{this._createIndex("journal","JournalEntry",game.journal)}),e.find('*[data-tab="zoo"]').click(i=>{this._createIndex("zoo","Actor",game.actors)}),e.find(".showDetails").click(i=>{let r=i.currentTarget.dataset.btn;$(i.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),e.find(`.${r} .detailBox`).toggleClass("dsahidden")}),e.find(".toggleWorldIndex").click(i=>{game.settings.set("dsa5","indexWorldItems",!game.settings.get("dsa5","indexWorldItems")),this.checkWorldStuffIndex(),$(i.currentTarget).toggleClass("on")}),e.find(".fulltextsearch").click(i=>{game.settings.set("dsa5","indexDescription",!game.settings.get("dsa5","indexDescription")),$(i.currentTarget).toggleClass("on")}),e.find(".browseEnabled").click(i=>{this.browseEnabled=!this.browseEnabled,$(i.currentTarget).toggleClass("on")}),e.find(".filterDuplicateItems").click(i=>{game.settings.set("dsa5","filterDuplicateItems",!game.settings.get("dsa5","filterDuplicateItems")),$(i.currentTarget).toggleClass("on")});let s=this;$(this._element).find(".window-content").on("scroll.infinit",debounce(function(i){if(s.advancedFiltering)return;let r=$(i.target),n=r.scrollTop()+r.innerHeight()>=r[0].scrollHeight-100,o=e.find(".tabs .item.active").attr("data-tab");if(n&&s.pages[o].next){let c=e.find(".tab.active");s.filterItems.call(s,c,o,s.pages[o].next)}},100))}getItemFromHTML(e){let t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}showLoading(e,t){this.setBGImage([1],t),$(`<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>${game.i18n.localize("Library.buildingIndex")}</div>`).appendTo(e.find(".searchResult"))}hideLoading(e,t){this.setBGImage([],t),e.find(".loader").remove()}};var Ft=class extends Dialog{constructor(e,t,a,s=""){let i={title:e,content:t,buttons:{initialize:{label:game.i18n.localize("initialize"),callback:async()=>{this.lock||await this.initialize()}},cancel:{label:game.i18n.localize("cancel"),callback:async()=>{this.lock||await this.dontInitialize()}}}};super(i),this.module=a,this.lang=s,this.folders={},this.journals={},this.scenes={},this.actors={},this.lock=!1}async initNotes(e,t,a){let s=await this.getFolderForType("JournalEntry");for(let i of e.notes)try{let r=t.find(n=>n.flags.dsa5.initId==i.entryId);if(!a.has(r._id)){let n=getProperty(r,"flags.dsa5.parent"),o=s;this.folders[n]?o=this.folders[n]:n&&(o=await this.getFolderForType("JournalEntry",s.id,n,0,getProperty(r,"flags.dsa5.foldercolor")||"")),r.folder=o.id;let c=game.journal.find(m=>m.name==r.name&&m.folder?.id==o.id&&m.flags.dsa5.initId==i.entryId);if(c)await c.update(r),a.set(r._id,c.id);else{let m=await JournalEntry.create(r);a.set(r._id,m.id)}}i.entryId=a.get(r._id)}catch(r){console.warn(`Could not initialize Scene Notes for scene :${e.name}`+r)}}async initScenes(e){let t=await this.getFolderForType("Scene"),s=(await game.packs.get(e.scenes).getDocuments()).map(u=>u.toObject()),r=(await game.packs.get(e.journal).getDocuments()).map(u=>u.toObject()),n=[],o=[],c=new Map,m=!1;for(let u of s){let p=m,f=game.scenes.find(h=>h.name==u.name&&h.folder?.id==t.id);if(!m&&f&&([p,m]=await new Promise((h,w)=>{new Dialog({title:game.i18n.localize("Book.sceneReset"),content:game.i18n.format("Book.sceneResetDescription",{name:u.name}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{h([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("LocalizedIDs.all"),callback:()=>{h([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{h([!1,!1])}}},close:()=>{h([!1,!1])}}).render(!0)})),f&&!p){this.scenes[f.name]=f;continue}u.folder=t.id,await this.initNotes(u,r,c),f?(u._id=f.id,o.push(u)):n.push(u)}let d=await Scene.create(n,{dsaInit:!0});for(let u of d){this.scenes[u.name]=u;let p=await u.createThumbnail();await u.update({thumb:p.thumb},{diff:!1})}for(let u of o)await game.scenes.get(u._id).update(u),this.scenes[u.name]=game.scenes.get(u._id);if(e.initialScene){let u=this.scenes[e.initialScene];await game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0),await u.activate(),await u.update({navigation:!0})}}async initialize(){this.lock=!0;let e=$(this._element).find(".initialize");e.prepend('<i class="fas fa-spinner fa-spin"></i>');let t={};try{game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0)}catch{}try{await fetch(`modules/${this.module}/adventure${this.lang}.json`).then(async a=>a.json()).then(async a=>{t=a})}catch{try{await fetch(`modules/${this.module}/adventure.json`).then(async a=>a.json()).then(async a=>{t=a})}catch{console.warn(`Could not find book data for ${this.module} import.`)}}await fetch(`modules/${this.module}/initialization${this.lang}.json`).then(async a=>a.json()).then(async a=>{let s=a.folders;if(s){let i=await this.getFolderForType("JournalEntry"),r=a.folders[0].name;i&&(this.folders[i.data.name]=i,a.folders.shift());let n=await Folder.create(s);Array.isArray(n)||(n=[n]);for(let c of n)this.folders[c.data.name]=c;let o=[];for(let c in this.folders){let m=this.folders[c].getFlag("dsa5","parent"),d=m==r?game.i18n.localize(`${this.module}.name`):m;d&&o.push({_id:this.folders[c].id,parent:this.folders[d].id})}await Folder.updateDocuments(o)}if(a.items&&a.items.length>0){let i=await this.getFolderForType("Item"),r=[],n=[];for(let o of a.items){o.folder=i.id;let c=game.items.find(m=>m.name==o.name&&m.folder?.id==i.id);c?(o._id=c.id,n.push(o)):r.push(o)}await S.create(r),await S.updateDocuments(n)}if(a.playlists){let i=await this.getFolderForType("Playlist"),r=[],n=[],c=(await game.packs.get(a.playlists).getDocuments()).map(m=>m.toObject());for(let m of c){m.folder=i.id;let d=game.playlists.find(u=>u.name==m.name&&u.folder?.id==i.id);d?(m._id=d._id,n.push(m)):r.push(m)}await Playlist.create(r,{keepId:!0}),await Playlist.updateDocuments(n)}if(a.scenes&&await this.initScenes(a),a.actors){let i=await this.getFolderForType("Actor"),n=(await game.packs.get(a.actors).getDocuments()).map(p=>p.toObject()),o=[],c=[],m=new Map,d=0;if(getProperty(t,"chapters")){for(let p of t.chapters)for(let f of p.content)if(f.actors){let h=!1;for(let w of f.actors)m.has(w)||(m.set(w,f.name),h=!0);h&&(await this.getFolderForType("Actor",i.id,f.name,d),d+=1)}}for(let p of n){let f=m.has(p.name)?await this.getFolderForType("Actor",i.id,m.get(p.name)):i;p.folder=f.id,p._id&&delete p._id;let h=game.actors.find(w=>w.name==p.name&&[i.id,f.id].includes(w.folder?.id));h?(p._id=h.id,await h.deleteEmbeddedDocuments("Item",h.items.map(w=>w.id)),c.push(p)):o.push(p)}let u=await Actor.create(o);await Actor.updateDocuments(c);for(let p of u)this.actors[p.name]=p}}),this.lock=!1,e.find("i").remove(),ui.notifications.notify(game.i18n.localize("initComplete")),await this.close()}async dontInitialize(){game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0),ui.notifications.notify(game.i18n.localize("initSkipped")),await this.close()}submit(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(t){throw ui.notifications.error(t),new Error(t)}}async getFolderForType(e,t=null,a=null,s=0,i=""){return a||(a=game.i18n.localize(`${this.module}.name`)),g.getFolderForType(e,t,a,s,i)}};var Ht=class extends ChatMessage{get isRoll(){return this.isDSARoll||super.isRoll}get roll(){return this.isDSARoll?new Zs(""):super.roll}get isDSARoll(){return this.flags.data?this.flags.data.isDSARoll:!1}},Zs=class extends Roll{render(){return""}};var jt=class extends Hotbar{async _render(e=!1,t={}){await super._render(e,t),this.addContextColor()}async collapse(){return this._collapsed?!0:($(this.element).addClass("collapsedHotbar"),super.collapse())}async expand(){return this._collapsed?($(this.element).removeClass("collapsedHotbar"),super.expand()):!0}addContextColor(){let e=new RegExp(` ${game.i18n.localize("CHAR.PARRY")}$`),t=new RegExp(` ${game.i18n.localize("CHAR.ATTACK")}$`),a=$(this._element).find("#macro-list");for(let s of this.macros)!s.macro||(e.test(s.macro.name)?a.find(`[data-macro-id="${s.macro.id}"]`).addClass("parry"):t.test(s.macro.name)&&a.find(`[data-macro-id="${s.macro.id}"]`).addClass("attack"))}};var Ge=class{constructor(){this.tokens={},this.actors={}}static get wantedKeys(){let e=["vision","targetMovement","shooterMovement","quickChange","mountOptions","narrowSpace","advantageousPosition","doubleAttack","reduceCostSpell","forceSpell","increaseCastingTime","decreaseCastingTime","removeGesture","removeFormula"];return K.isEnabled||e.push("distance"),e}getPath(e,t,a){let s=a||"",i=t._id||t.type;return e.token?`tokens.${e.token||e.actor}.${i}${s}`:`actors.${e.actor}.${i}${s}`}remember(e,t,a,s){let i=this.formDataSerialize(s);Object.entries(i).length>0&&setProperty(this,this.getPath(e,t,a),i)}recall(e,t,a){return getProperty(this,this.getPath(e,t,a))}formDataSerialize(e){let t=e.find("form"),a={};return t.find("select").each(function(){let s=$(this).attr("name");Ge.wantedKeys.includes(s)&&(a[s]=$(this).val())}),t.find('input[type="checkbox"]').each(function(){let s=$(this).attr("name");Ge.wantedKeys.includes(s)&&(a[s]=this.checked)}),t.find(".specAbs.active").each(function(){a.specAbs||(a.specAbs=[]),a.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})}),e.find('[name="situationalModifiers"] option').each(function(){a.situationalModifiers||(a.situationalModifiers=[]),a.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})}),a}};var ra=class extends ActiveEffect{apply(e,t){if(ra.itemChangeRegex.test(t.key)){let a=this._getModifiedItems(e,t);for(let s of a.items){let i=foundry.utils.flattenObject(s.overrides||{});i[a.key]=Number.isNumeric(s.value)?Number(a.value):a.value;let r={...t,key:a.key,value:a.value};super.apply(s,r),s.overrides=foundry.utils.expandObject(i)}}else return super.apply(e,t)}static async _onCreateDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await T.postUpdateConditions(a.parent);return super._onCreateDocuments(e,t)}static async _onUpdateDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await T.postUpdateConditions(a.parent);return super._onUpdateDocuments(e,t)}static async _onDeleteDocuments(e,t){for(let a of e)a.parent.documentName=="Actor"&&await T.postUpdateConditions(a.parent);return super._onDeleteDocuments(e,t)}isVisibleEffect(){return!this.disabled&&!this.notApplicable&&(game.user.isGM||!this.getFlag("dsa5","hidePlayers"))&&!this.getFlag("dsa5","hideOnToken")&&(this.origin==this.target?.uuid||!this.origin)}_displayScrollingStatus(e){let t=["dead"];!(game.user.isGM||this.target?.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects")?this.isVisibleEffect():t.some(i=>this.statuses.has(i)))||super._displayScrollingStatus(e)}_getModifiedItems(e,t){let a=t.key.split("."),s=a.shift();s=s.replace("@","").toLowerCase();let i=a.shift(),r=a.join("."),n=t.value;return{items:e?.items?.filter(c=>c.type==s&&(c.name==i||c.id==i))||[],key:r,value:n}}async _preUpdate(e,t,a){super._preUpdate(e,t,a),this._clearModifiedItems()}_clearModifiedItems(){if(this.parent instanceof CONFIG.Actor.documentClass){for(let e of this.changes)if(ra.itemChangeRegex.test(e.key)){let t=this._getModifiedItems(this.parent,e);for(let a of t.items){let s=foundry.utils.flattenObject(a.overrides||{}),i=t.key;delete s[i];let r=getProperty(a._source,i);setProperty(a,i,r),a.overrides=foundry.utils.expandObject(s),a.sheet?.rendered&&a.sheet.render(!0)}}}}async _preDelete(e,t){super._preDelete(e,t),this._clearModifiedItems()}},bt=ra;R(bt,"itemChangeRegex",/^@/);var br=(l,e)=>{let t=getProperty(l,e.key)||null;t==null&&/^system\.(vulnerabilities|resistances)/.test(e.key)&&(t=[],setProperty(l,e.key,t));let a=getType(t),s=null;switch(a){case"Array":let i=[],r=e.effect.name;for(let n of`${e.value}`.split(/[;,]+/)){let o=n.split(" "),c=o.pop(),m=o.join(" ");i.push({source:r,value:c,target:m})}s=t.concat(i)}return s!==null&&setProperty(l,e.key,s),s};Hooks.on("applyActiveEffect",(l,e)=>br(l,e));Hooks.once("init",()=>{console.log("Initializing DSA5 system"),CONFIG.statusEffects=y.statusEffects,game.dsa5={apps:{DSA5_Utility:g,DSA5Initializer:Ft,DSA5ChatListeners:Z,DSA5Payment:j,SpecialabilityRulesDSA5:N,AdvantageRulesDSA5:O,Migrakel:De,DSA5Dialog:X,DSA5StatusEffects:I,DPS:K,DSATables:W,DSA5SoundEffect:U,RequestRoll:G,DiceDSA5:_DiceDSA5,DSATour:xe,OpposeDSA:F,EquipmentDamage:q,DidYouKnow:He,MeasuredTemplateDSA:dt,Riding:H,RuleChaos:_,Trade:de,DSAActiveEffectConfig:_DSAActiveEffectConfig},entities:{Actordsa5:T,Itemdsa5:S},sheets:{ActorSheetdsa5:Me,ActorSheetdsa5Character:ke,ActorSheetdsa5Creature:Ie,ActorSheetdsa5NPC:Ee,MerchantSheetMixin:je,MerchantSheetDSA5:ve,ItemSheetdsa5:V},wizards:{CareerWizard:et,CultureWizard:Ze,SpeciesWizard:tt},view:{tinyNotification:me,tabSlider:se,clickableAbility:rt},dialogs:{DialogReactDSA5:oe,ReactToSkillDialog:ct,ActAttackDialog:Le,ReactToAttackDialog:Ce},macro:Lt,config:y,memory:new Ge,itemLibrary:new _t},CONFIG.Actor.documentClass=T,CONFIG.Item.documentClass=S,CONFIG.ChatMessage.template="systems/dsa5/templates/chat/chat-message.html",CONFIG.ChatMessage.documentClass=Ht,CONFIG.ui.combat=we,CONFIG.ui.hotbar=jt,CONFIG.Combat.documentClass=pt,CONFIG.Combatant.documentClass=ea,CONFIG.ActiveEffect.documentClass=bt,CONFIG.ActiveEffect.legacyTransferral=!1});$i();
