/*! For license information please see dsa5.bundle.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__={369:(t,r,a)=>{a.d(r,{Z:()=>x});var o=a(491),i=a(577),c=a(562),u=a(600),l=a(538),p=a(272),d=a(173),h=a(973),m=a(839),y=a(101),g=a(122),v=a(707),_=a(702),b=a(61),w=(a(604),a(803)),k=a(472);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _slicedToArray(t,r){return function _arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function _iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||_unsupportedIterableToArray(t,r)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ownKeys(t,r){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.push.apply(a,o)}return a}function _objectSpread(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(a),!0).forEach((function(r){_defineProperty(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(a,r))}))}return t}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var x=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(Actordsa5,Actor);var r,a,x,S,T,A,O,P,E,C,D,I,R,L,G,M,j,z,N,H,W,B,Z,q,U,Y,V,K=_createSuper(Actordsa5);function Actordsa5(){return _classCallCheck(this,Actordsa5),K.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(Actordsa5,[{key:"_getArmorCompensation",value:function _getArmorCompensation(t,r,a){return d.Z.abilityStep(t,game.i18n.localize("LocalizedIDs.inuredToEncumbrance"))>r.reduce((function(t,r){return t+Number(r.system.encumbrance.value)}),0)}},{key:"prepareDerivedData",value:function prepareDerivedData(){var t=this.system;try{var r,a={},i=this._getArmorCompensation(this,this.items.filter((function(t){return"armor"==t.type&&getProperty(t,"system.worn.value")})),a),c=_createForOfIteratorHelper(this.items.filter((function(t){return["meleeweapon","rangeweapon","armor","equipment"].includes(t.type)&&getProperty(t,"system.worn.value")||["advantage","specialability","disadvantage"].includes(t.type)})));try{for(c.s();!(r=c.n()).done;){var u=r.value;i=this._addGearAndAbilityModifiers(a,u,i)}}catch(t){c.e(t)}finally{c.f()}t.itemModifiers=this._applyModiferTransformations(a);for(var l=0,h=Object.values(t.characteristics);l<h.length;l++){var m=h[l];m.value=m.initial+m.advances+(m.modifier||0)+m.gearmodifier,m.cost=game.i18n.format("advancementCost",{cost:o.Z._calculateAdvCost(m.initial+m.advances,"E")}),m.refund=game.i18n.format("refundCost",{cost:o.Z._calculateAdvCost(m.initial+m.advances,"E",0)})}var v=g.Z.isFamiliar(this),_=g.Z.isPet(this);t.canAdvance=("character"==this.type||v||_)&&this.isOwner,t.isMage=v||this.items.some((function(t){return["ritual","spell","magictrick"].includes(t.type)||"specialability"==t.type&&["magical","staff","pact"].includes(t.system.category.value)})),t.isPriest=this.items.some((function(t){return["ceremony","liturgy","blessing"].includes(t.type)||"specialability"==t.type&&["ceremonial","clerical"].includes(t.system.category.value)})),t.canAdvance&&(t.details.experience.current=t.details.experience.total-t.details.experience.spent,t.details.experience.description=o.Z.experienceDescription(t.details.experience.total)),"character"!=this.type&&"npc"!=this.type||(t.status.wounds.current=t.status.wounds.initial+2*t.characteristics.ko.value,t.status.soulpower.value=(t.status.soulpower.initial||0)+Math.round((t.characteristics.mu.value+t.characteristics.kl.value+t.characteristics.in.value)/6),t.status.toughness.value=(t.status.toughness.initial||0)+Math.round((t.characteristics.ko.value+t.characteristics.ko.value+t.characteristics.kk.value)/6),t.status.initiative.value=Math.round((t.characteristics.mu.value+t.characteristics.ge.value)/2)+(t.status.initiative.modifier||0)),t.status.fatePoints.max=Number(t.status.fatePoints.current)+Number(t.status.fatePoints.modifier)+t.status.fatePoints.gearmodifier,"creature"==this.type&&(t.status.wounds.current=t.status.wounds.initial,t.status.astralenergy.current=t.status.astralenergy.initial,t.status.karmaenergy.current=t.status.karmaenergy.initial,t.status.initiative.value=t.status.initiative.current+(t.status.initiative.modifier||0)),t.status.wounds.max=Math.round((t.status.wounds.current+t.status.wounds.modifier+t.status.wounds.advances)*t.status.wounds.multiplier+t.status.wounds.gearmodifier),t.status.astralenergy.max=t.status.astralenergy.current+t.status.astralenergy.modifier+t.status.astralenergy.advances+t.status.astralenergy.gearmodifier,t.status.karmaenergy.max=t.status.karmaenergy.current+t.status.karmaenergy.modifier+t.status.karmaenergy.advances+t.status.karmaenergy.gearmodifier,t.status.regeneration.LePmax=t.status.regeneration.LePTemp+t.status.regeneration.LePMod+t.status.regeneration.LePgearmodifier,t.status.regeneration.KaPmax=t.status.regeneration.KaPTemp+t.status.regeneration.KaPMod+t.status.regeneration.KaPgearmodifier,t.status.regeneration.AsPmax=t.status.regeneration.AsPTemp+t.status.regeneration.AsPMod+t.status.regeneration.AsPgearmodifier;var b=t.guidevalue;(v||b&&"creature"!=this.type)&&(t.status.astralenergy.current=t.status.astralenergy.initial,t.status.karmaenergy.current=t.status.karmaenergy.initial,t.characteristics[b.magical]&&(t.status.astralenergy.current+=Math.round(t.characteristics[b.magical].value*t.energyfactor.magical)),t.characteristics[b.clerical]&&(t.status.karmaenergy.current+=Math.round(t.characteristics[b.clerical].value*t.energyfactor.clerical)),t.status.astralenergy.max=t.status.astralenergy.current+t.status.astralenergy.modifier+t.status.astralenergy.advances+t.status.astralenergy.gearmodifier,t.status.karmaenergy.max=t.status.karmaenergy.current+t.status.karmaenergy.modifier+t.status.karmaenergy.advances+t.status.karmaenergy.gearmodifier),t.status.speed.max=t.status.speed.initial+(t.status.speed.modifier||0)+t.status.speed.gearmodifier,t.status.soulpower.max=t.status.soulpower.value+t.status.soulpower.modifier+t.status.soulpower.gearmodifier,t.status.toughness.max=t.status.toughness.value+t.status.toughness.modifier+t.status.toughness.gearmodifier,t.status.dodge.value=Math.round(t.characteristics.ge.value/2)+t.status.dodge.gearmodifier;var w=this.hasCondition("encumbered");w=w?Number(w.flags.dsa5.value):0,t.status.speed.max=Math.round(Math.max(0,t.status.speed.max-Math.min(4,w))*(t.status.speed.multiplier||1)),t.status.initiative.value+=t.status.initiative.gearmodifier-Math.min(4,w);var k=Number((.01*t.status.initiative.value).toFixed(2));t.status.initiative.value*=t.status.initiative.multiplier||1,t.status.initiative.value=Math.round(t.status.initiative.value)+k,t.status.dodge.max=Number(t.status.dodge.value)+Number(t.status.dodge.modifier)+Number(game.settings.get("dsa5","higherDefense"))/2;var x="creature"!=this.type||t.status.wounds.max>=20,S=0;if(t.status.wounds.max>0&&(x?(S=Math.floor(4*(1-t.status.wounds.value/t.status.wounds.max)),t.status.wounds.value<=5&&(S=4)):S=Math.floor(5-5*t.status.wounds.value/t.status.wounds.max),S<4&&(S-=p.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedFighter"))+p.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedAnimal"))+(d.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.traditionKor"))?1:0)),S>0&&(S+=p.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.sensitiveToPain"))+p.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.fragileAnimal"))),S=Math.clamped(S,0,4)),this.hasCondition("bloodrush")||(t.status.speed.max=Math.max(0,t.status.speed.max-S)),o.Z.isActiveGM()){var T=t.pain!=S;t.pain=S,T&&!y.Z.hasTrait(this,game.i18n.localize("LocalizedIDs.painImmunity"))&&this.addCondition("inpain",S,!0).then((function(){return t.pain=void 0})),p.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.blind"))&&this.addCondition("blind"),p.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.mute"))&&this.addCondition("mute"),p.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.deaf"))&&this.addCondition("deaf"),this.isMerchant()&&this.prepareMerchant()}var A=this.hasCondition("paralysed");A&&(t.status.speed.max=Math.round(t.status.speed.max*(1-.25*A.flags.dsa5.value))),this.hasCondition("fixated")?(t.status.speed.max=0,t.status.dodge.max=Math.max(0,t.status.dodge.max-4)):this.hasCondition("rooted")||this.hasCondition("incapacitated")?t.status.speed.max=0:this.hasCondition("prone")&&(t.status.speed.max=Math.min(1,t.status.speed.max))}catch(t){console.error("Something went wrong with preparing actor data: "+t+t.stack),ui.notifications.error(game.i18n.localize("ACTOR.PreparationError")+t+t.stack)}}},{key:"creatureType",get:function get(){return k.Z.creatureTypeName(this)}},{key:"prepareMerchant",value:(V=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(){var t;return _regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:if("loot"!=getProperty(this,"system.merchant.merchantType")){r.next=11;break}if(!getProperty(this,"system.merchant.locked")||this.hasCondition("locked")){r.next=6;break}return r.next=4,this.addCondition(Actordsa5.lockedCondition());case 4:r.next=11;break;case 6:if(getProperty(this,"system.merchant.locked")){r.next=11;break}if(!(t=this.effects.find((function(t){return"locked"==getProperty(t,"flags.core.statusId")})))){r.next=11;break}return r.next=11,this.deleteEmbeddedDocuments("ActiveEffect",[t.id]);case 11:case"end":return r.stop()}}),_callee,this)}))),function prepareMerchant(){return V.apply(this,arguments)})},{key:"applyActiveEffects",value:function applyActiveEffects(){var t=this,r={},a=this.effects.reduce((function(r,a){if(a.disabled)return r;var o=1;if(a.origin){var i=a.origin.match(/[^.]+$/)[0],c=t.items.get(i);if(c){var u=!0;switch(c.type){case"meleeweapon":case"rangeweapon":case"armor":u=c.system.worn.value;break;case"equipment":u=c.system.worn.wearable&&c.system.worn.value||!c.system.worn.wearable;break;case"ammunition":case"plant":case"consumable":case"combatskill":case"magicsign":case"poison":case"spell":case"liturgy":case"ceremony":case"ritual":case"spellextension":u=!1;break;case"specialability":u="Combat"!=c.system.category.value||[2,3].includes(c.system.category.sub),o=Number(c.system.step.value)||1;break;case"advantage":case"disadvantage":o=Number(c.system.step.value)||1}if(a.notApplicable=!u,!u)return r}}for(var l=0;l<o;l++)r.push.apply(r,_toConsumableArray(a.changes.map((function(t){return(t=foundry.utils.duplicate(t)).effect=a,t.priority=t.priority?t.priority:10*t.mode,t}))));return r}),[]);a.sort((function(t,r){return t.priority-r.priority}));var o,i=_createForOfIteratorHelper(a);try{for(i.s();!(o=i.n()).done;){var c=o.value,u=c.effect.apply(this,c);null!==u&&(r[c.key]=u)}}catch(t){i.e(t)}finally{i.f()}this.overrides=foundry.utils.expandObject(r)}},{key:"_setOnUseEffect",value:function _setOnUseEffect(t){getProperty(t,"flags.dsa5.onUseEffect")&&(t.OnUseEffect=!0)}},{key:"prepareBaseData",value:function prepareBaseData(){var t=this.system;mergeObject(t,{skillModifiers:_objectSpread({FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AsPCost:[],KaPCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],KaPCost:[],AsPCost:[]}},["liturgy","ceremony","ritual","spell","skill"].reduce((function(t,r){return t[r]={FP:[],step:[],QL:[],TPM:[],FW:[]},t}),{})),status:{initiative:{multiplier:1},wounds:{multiplier:1},regeneration:{LePgearmodifier:0,KaPgearmodifier:0,AsPgearmodifier:0}},repeatingEffects:{startOfRound:{wounds:[],karmaenergy:[],astralenergy:[]}},totalArmor:0,spellArmor:0,liturgyArmor:0,carryModifier:0,aspModifier:0,kapModifier:0,immunities:[],creatureBonus:[],miracle:{attack:0,parry:0},spellStats:{damage:"0"},liturgyStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1}});var r,a=_createForOfIteratorHelper(i.Z.gearModifyableCalculatedAttributes);try{for(a.s();!(r=a.n()).done;){var o=r.value;t.status[o]&&(t.status[o].gearmodifier=0)}}catch(t){a.e(t)}finally{a.f()}for(var c=0,u=Object.values(t.characteristics);c<u.length;c++){u[c].gearmodifier=0}}},{key:"getSkillModifier",value:function getSkillModifier(t,r){for(var a=this,o=[],i=function _loop(){var i=u[c],l="step"==i?"":i;o.push.apply(o,_toConsumableArray(a.system.skillModifiers[i].filter((function(r){return r.target==t})).map((function(t){return{name:t.source,value:t.value,type:l}})))),a.system.skillModifiers[r]&&o.push.apply(o,_toConsumableArray(a.system.skillModifiers[r][i].map((function(t){return{name:t.source,value:t.value,type:l}}))))},c=0,u=["FP","step","QL","TPM","FW"];c<u.length;c++)i();return o}},{key:"prepareSheet",value:function prepareSheet(t){var r=duplicate(this),a={system:{}};if(mergeObject(a,this.prepareItems(t)),a.canAdvance)for(var i=0,c=["wounds","astralenergy","karmaenergy"];i<c.length;i++){var u=c[i];mergeObject(a.system,{status:_defineProperty({},u,{cost:game.i18n.format("advancementCost",{cost:o.Z._calculateAdvCost(r.system.status[u].advances,"D")}),refund:game.i18n.format("refundCost",{cost:o.Z._calculateAdvCost(r.system.status[u].advances,"D",0)})})})}return a}},{key:"_perpareItemAdvancementCost",value:function _perpareItemAdvancementCost(t){return t.cost=game.i18n.format("advancementCost",{cost:o.Z._calculateAdvCost(t.system.talentValue.value,t.system.StF.value)}),t.refund=game.i18n.format("refundCost",{cost:o.Z._calculateAdvCost(t.system.talentValue.value,t.system.StF.value,0)}),t.canAdvance=Actordsa5.canAdvance(this),t}},{key:"prepareItems",value:function prepareItems(t){for(var r,a,o=this,c=this.toObject(!1),u=[],l=[],p=[],d=[],h=[],m=[],y=[],v=[],b=Object.fromEntries(Object.keys(i.Z.specialAbilityCategories).map((function(t){return[t,[]]}))),w=Object.fromEntries(Object.keys(i.Z.traitCategories).map((function(t){return[t,[]]}))),k=[],x=[],S=[],T=[],A={hasSpells:this.system.isMage,hasPrayers:this.system.isPriest,liturgy:[],spell:[],ritual:[],ceremony:[],blessing:[],magictrick:[],magicalsign:[]},O={spell:{},ritual:{},ceremony:{},liturgy:{}},P=[],E=1;E<=Number(c.system.status.fatePoints.max);E++)P.push({value:E,cssClass:E<=Number(c.system.status.fatePoints.value)?"fullSchip":"emptySchip"});var C={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},plant:{items:[],show:!1,dataType:"plant"},poison:{items:[],show:!1,dataType:"poison"}};for(var D in i.Z.equipmentTypes)C[D]={items:[],show:!1,dataType:D};C.misc.show=!0;var I={coins:[],total:0,show:!0};c.items=c.items.sort((function(t,r){return t.name.localeCompare(r.name)}));var R,L=c.system.totalArmor||0,G=0,M={body:[],social:[],knowledge:[],trade:[],nature:[]},j=new Map,z=_createForOfIteratorHelper(c.items.filter((function(t){return"equipment"==t.type&&"bags"==t.system.equipmentType.value})));try{for(z.s();!(R=z.n()).done;){var N=R.value;j.set(N._id,[])}}catch(t){z.e(t)}finally{z.f()}var H,$=new Map,W=[],B=!1,Z=_createForOfIteratorHelper(c.items);try{for(Z.s();!(H=Z.n()).done;){var q=H.value;try{var U=getProperty(q,"system.parent_id");if("ammunition"==q.type&&W.push(Actordsa5._prepareitemStructure(q)),U&&U!=q._id&&j.has(U)){j.get(U).push(q);continue}switch(t.details&&t.details.includes(q._id)&&(q.detailed="shown"),q.system.isArtifact&&(q.volume=i.Z.traditionArtifacts[q.system.artifact]||0,q.volumeFinal=0,T.push(q)),q.type){case"skill":M[q.system.group.value].push(this._perpareItemAdvancementCost(q));break;case"information":v.push(q);break;case"aggregatedTest":d.push(q);break;case"spellextension":O[q.system.category][q.system.source]?O[q.system.category][q.system.source].push(q.name):O[q.system.category][q.system.source]=[q.name];break;case"ritual":case"spell":case"liturgy":case"ceremony":A[q.type].push(Actordsa5.buildSpellChargeProgress(this._perpareItemAdvancementCost(q)));break;case"magicalsign":case"magictrick":case"blessing":A[q.type].push(q);break;case"trait":switch(q.system.traitType.value){case"rangeAttack":q=Actordsa5._prepareRangeTrait(q);break;case"meleeAttack":q=Actordsa5._prepareMeleetrait(q);break;case"armor":L+=Number(q.system.at.value)}w[q.system.traitType.value].push(q),B=!0;break;case"combatskill":u.push(Actordsa5._calculateCombatSkillValues(q,this.system));break;case"ammunition":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),C.ammunition.items.push(Actordsa5.prepareMag(q)),C.ammunition.show=!0,G+=Number(q.weight);break;case"meleeweapon":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),q.toggleValue=q.system.worn.value||!1,q.toggle=!0,this._setOnUseEffect(q),C.meleeweapons.items.push(Actordsa5._prepareitemStructure(q)),C.meleeweapons.show=!0,q.toggleValue&&y.push(q),G+=Number(q.weight);break;case"rangeweapon":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),q.toggleValue=q.system.worn.value||!1,q.toggle=!0,this._setOnUseEffect(q),C.rangeweapons.items.push(Actordsa5._prepareitemStructure(q)),C.rangeweapons.show=!0,G+=Number(q.weight);break;case"armor":q.toggleValue=q.system.worn.value||!1,C.armor.items.push(Actordsa5._prepareitemStructure(q)),C.armor.show=!0,q.toggle=!0,this._setOnUseEffect(q),q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),G+=parseFloat((q.system.weight.value*(q.toggleValue?Math.max(0,q.system.quantity.value-1):q.system.quantity.value)).toFixed(3)),q.system.worn.value&&(q.system.protection.value=_.Z.armorWearModifier(q,q.system.protection.value),L+=Number(q.system.protection.value),k.push(q));break;case"plant":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),C.plant.items.push(q),C.plant.show=!0,G+=Number(q.weight);break;case"poison":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),C.poison.items.push(q),C.poison.show=!0,G+=Number(q.weight);break;case"consumable":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),C[q.system.equipmentType.value].items.push(Actordsa5._prepareConsumable(q)),C[q.system.equipmentType.value].show=!0,G+=Number(q.weight);break;case"equipment":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),q.toggle=getProperty(q,"system.worn.wearable")||!1,q.toggle&&(q.toggleValue=q.system.worn.value||!1),this._setOnUseEffect(q),C[q.system.equipmentType.value].items.push(Actordsa5._prepareitemStructure(q)),C[q.system.equipmentType.value].show=!0,G+=Number(q.weight);break;case"money":q.weight=parseFloat((q.system.weight.value*q.system.quantity.value).toFixed(3)),I.coins.push(q),G+=Number(q.weight),I.total+=q.system.quantity.value*q.system.price.value;break;case"advantage":this._setOnUseEffect(q),l.push(q);break;case"disadvantage":this._setOnUseEffect(q),p.push(q);break;case"specialability":this._setOnUseEffect(q),b[q.system.category.value].push(q);break;case"disease":h.push(q);break;case"patron":b.magical.push(q);break;case"demonmark":m.push(q);break;case"application":$.has(q.system.skill)?$.get(q.system.skill).push(q):$.set(q.system.skill,[q])}}catch(t){this._itemPreparationError(q,t)}}}catch(t){Z.e(t)}finally{Z.f()}var Y,V=_createForOfIteratorHelper(C.bags.items);try{for(V.s();!(Y=V.n()).done;){var K=Y.value;G+=this._setBagContent(K,j)}}catch(t){V.e(t)}finally{V.f()}for(var J=0,Q=Object.entries(O);J<Q.length;J++)for(var X=_slicedToArray(Q[J],2),ee=X[0],te=X[1],re=function _loop2(){var t=_slicedToArray(ae[ne],2),r=t[0],a=t[1];A[ee].find((function(t){return t.name==r})).extensions=a.join(", ")},ne=0,ae=Object.entries(te);ne<ae.length;ne++)re();var oe,ie=_createForOfIteratorHelper(C.rangeweapons.items);try{for(ie.s();!(oe=ie.n()).done;){var ce=oe.value;try{ce.system.worn.value&&x.push(Actordsa5._prepareRangeWeapon(ce,W,u,this))}catch(t){this._itemPreparationError(ce,t)}}}catch(t){ie.e(t)}finally{ie.f()}for(var se=function _loop3(){var t=le[ue];try{S.push(Actordsa5._prepareMeleeWeapon(t,u,c,y.filter((function(r){return r._id!=t._id&&!g.Z.isYieldedTwohanded(r)}))))}catch(r){o._itemPreparationError(t,r)}},ue=0,le=y;ue<le.length;ue++)se();for(var fe=0,pe=Object.entries(M);fe<pe.length;fe++){var de,he=_slicedToArray(pe[fe],2),me=(he[0],_createForOfIteratorHelper(he[1]));try{for(me.s();!(de=me.n()).done;){var ye=de.value;ye.applications=$.get(ye.name)||[]}}catch(t){me.e(t)}finally{me.f()}}I.coins=I.coins.sort((function(t,r){return t.system.price.value>r.system.price.value?-1:1}));var ge=2*c.system.characteristics.kk.value+c.system.carryModifier,ve=this.getArmorEncumbrance(this,k);"creature"==this.type&&!this.canAdvance||this.isMerchant()||(ve+=Math.max(0,Math.ceil((G-ge-4)/4))),this.addCondition("encumbered",ve,!0),G=parseFloat(G.toFixed(3)),(r=b.magical).push.apply(r,_toConsumableArray(b.pact)),(a=b.clerical).push.apply(a,_toConsumableArray(b.ceremonial));var _e,be=_createForOfIteratorHelper(b.staff);try{var we=function _loop4(){var t=_e.value,r=T.find((function(r){return r.system.artifact==t.system.artifact}));if(r){null==r.abilities&&(r.abilities=[]),r.abilities.push(t);var a=Number(t.system.volume)||0;r[a>0?"volumeFinal":"volume"]+=Math.abs(a)*Number(t.system.step.value)}else b.magical.push(t)};for(be.s();!(_e=be.n()).done;)we()}catch(t){be.e(t)}finally{be.f()}var ke=duplicate(i.Z.characteristics);return ke["-"]="-",{totalWeight:G,traditionArtifacts:T,armorSum:L,spellArmor:c.system.spellArmor||0,liturgyArmor:c.system.liturgyArmor||0,money:I,encumbrance:ve,carrycapacity:ge,wornRangedWeapons:x,wornMeleeWeapons:S,advantages:l,disadvantages:p,specAbs:b,information:v,aggregatedtests:d,wornArmor:k,inventory:C,hasTrait:B,demonmarks:m,diseases:h,itemModifiers:this.system.itemModifiers,languagePoints:{used:c.system.freeLanguagePoints?c.system.freeLanguagePoints.used:0,available:c.system.freeLanguagePoints?c.system.freeLanguagePoints.value:0},schips:P,guidevalues:ke,magic:A,traits:w,combatskills:u,canAdvance:this.system.canAdvance,sheetLocked:c.system.sheetLocked.value,allSkillsLeft:{body:M.body,social:M.social,nature:M.nature},allSkillsRight:{knowledge:M.knowledge,trade:M.trade}}}},{key:"getArmorEncumbrance",value:function getArmorEncumbrance(t,r){var a=r.reduce((function(t,r){return r.calculatedEncumbrance=Number(r.system.encumbrance.value)+_.Z.armorEncumbranceModifier(r),r.damageToolTip=_.Z.damageTooltip(r),t+r.calculatedEncumbrance}),0);return Math.max(0,a-d.Z.abilityStep(t,game.i18n.localize("LocalizedIDs.inuredToEncumbrance")))}},{key:"_setBagContent",value:function _setBagContent(t,r){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=0;if(r.has(t._id)){t.children=[];var i=0;!t.toggleValue&&a&&(o-=t.weight);var c,u=_createForOfIteratorHelper(r.get(t._id));try{for(u.s();!(c=u.n()).done;){var l=c.value;l.weight=Number(parseFloat((l.system.weight.value*l.system.quantity.value).toFixed(3))),i+=l.weight,t.children.push(Actordsa5._prepareitemStructure(Actordsa5._prepareConsumable(l))),r.has(l._id)&&(i+=this._setBagContent(l,r,!1))}}catch(t){u.e(t)}finally{u.f()}!t.toggleValue&&a||(o+=i),t.bagweight="".concat(i.toFixed(3),"/").concat(t.system.capacity)}return o}},{key:"isMerchant",value:function isMerchant(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}},{key:"_itemPreparationError",value:function _itemPreparationError(t,r){console.error("Something went wrong with preparing item "+t.name+": "+r),console.warn(r),console.warn(t),ui.notifications.error("Something went wrong with preparing item "+t.name+": "+r)}},{key:"_applyModiferTransformations",value:function _applyModiferTransformations(t){for(var r=0,a=Object.entries(t);r<a.length;r++){var o=_slicedToArray(a[r],2),i=o[0],c=o[1],u=game.dsa5.config.knownShortcuts[i.toLowerCase()];u?this.system[u[0]][u[1]][u[2]]+=c.value:delete t[i]}return t}},{key:"_addGearAndAbilityModifiers",value:function _addGearAndAbilityModifiers(t,r,a){var o=getProperty(r,"system.effect.value");if(!o)return a;var i,c=!0,u=_createForOfIteratorHelper(o.split(/,|;/).map((function(t){return t.trim()})));try{for(u.s();!(i=u.n()).done;){var l=i.value.replace(/(\s+)/g," ").trim().split(" ");2==l.length&&(isNaN(l[0])||(a&&"armor"==r.type&&[game.i18n.localize("CHARAbbrev.INI").toLowerCase(),game.i18n.localize("CHARAbbrev.GS").toLowerCase()].includes(l[1].toLowerCase())?c=!1:null==t[l[1]]?t[l[1]]={value:Number(l[0])*(r.system.step&&Number(r.system.step.value)||1),sources:[r.name]}:(t[l[1]].value+=Number(l[0])*(r.system.step&&Number(r.system.step.value)||1),t[l[1]].sources.push(r.name))))}}catch(t){u.e(t)}finally{u.f()}return a&&c}},{key:"_updateAPs",value:(Y=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r,a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:if(r=i.length>1&&void 0!==i[1]?i[1]:{},!Actordsa5.canAdvance(this)){c.next=12;break}if(isNaN(t)||null==t){c.next=11;break}return a=Number(t),r["system.details.experience.spent"]=Number(this.system.details.experience.spent)+a,c.next=7,this.update(r);case 7:o=game.i18n.format(a>0?"advancementCost":"refundCost",{cost:Math.abs(a)}),(0,v.p0)(o),c.next=12;break;case 11:ui.notifications.error(game.i18n.localize("DSAError.APUpdateError"));case 12:case"end":return c.stop()}}),_callee2,this)}))),function _updateAPs(t){return Y.apply(this,arguments)})},{key:"checkEnoughXP",value:(U=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r,a,o,c,u,l;return _regeneratorRuntime().wrap((function _callee3$(p){for(;;)switch(p.prev=p.next){case 0:if(Actordsa5.canAdvance(this)){p.next=2;break}return p.abrupt("return",!0);case 2:if(!isNaN(t)&&null!=t){p.next=4;break}return p.abrupt("return",!0);case 4:if(!(Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=t)){p.next=8;break}return p.abrupt("return",!0);case 8:if(!Number(0==this.system.details.experience.total)){p.next=23;break}return r=Object.entries(i.Z.startXP).map((function(t){var r=_slicedToArray(t,2),a=r[0],o=r[1];return'<option value="'.concat(a,'">').concat(game.i18n.localize(o)," (").concat(a,")</option>")})).join(""),a="<p>".concat(game.i18n.localize("DSAError.zeroXP"),"</p><label>").concat(game.i18n.localize("APValue"),': </label><select name ="APsel">').concat(r,"</select>"),o=0,c=!1,p.next=15,new Promise((function(t,r){new Dialog({title:game.i18n.localize("DSAError.NotEnoughXP"),content:a,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(r){t([!0,r.find('[name="APsel"]')[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function callback(){t([!1,0])}}}}).render(!0)}));case 15:if(u=p.sent,l=_slicedToArray(u,2),c=l[0],o=l[1],!c){p.next=23;break}return p.next=22,this.update({"system.details.experience.total":Number(o)});case 22:return p.abrupt("return",!0);case 23:return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughXP")),p.abrupt("return",!1);case 25:case"end":return p.stop()}}),_callee3,this)}))),function checkEnoughXP(t){return U.apply(this,arguments)})},{key:"setupWeapon",value:function setupWeapon(t,r,a,o){return a.mode=r,m.Z.getSubClass(t.type).setupDialog(null,a,t,this,o)}},{key:"setupWeaponless",value:function setupWeaponless(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0,o=foundry.utils.duplicate(i.Z.defaultWeapon);return o.name=game.i18n.localize("".concat(t,"Weaponless")),o.system.combatskill={value:game.i18n.localize("LocalizedIDs.wrestle")},o.system.damageThreshold.value=14,d.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyAstralBody"))&&mergeObject(o,{system:{effect:{attributes:game.i18n.localize("magical")}}}),r.mode=t,m.Z.getSubClass(o.type).setupDialog(null,r,o,this,a)}},{key:"setupSpell",value:function setupSpell(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;return m.Z.getSubClass(t.type).setupDialog(null,r,t,this,a)}},{key:"setupSkill",value:function setupSkill(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;return m.Z.getSubClass(t.type).setupDialog(null,r,t,this,a)}},{key:"tokenScrollingText",value:function tokenScrollingText(t){var r,a,o=_createForOfIteratorHelper(this.isToken?[null===(r=this.token)||void 0===r?void 0:r.object]:this.getActiveTokens(!0));try{for(o.s();!(a=o.n()).done;){var i=a.value;if(i){var c,u=0,l=_createForOfIteratorHelper(t);try{for(l.s();!(c=l.n()).done;){var p=c.value;canvas.interface.createScrollingText(i.center,p.value,{anchor:u,direction:p.value>0?2:1,fontSize:game.settings.get("dsa5","scrollingFontsize"),stroke:p.stroke,strokeThickness:1,jitter:.25,duration:1e3}),u+=1}}catch(t){l.e(t)}finally{l.f()}}}}catch(t){o.e(t)}finally{o.f()}}},{key:"_preUpdate",value:(q=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r,a){var o,i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee4$(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,_get(_getPrototypeOf(Actordsa5.prototype),"_preUpdate",this).call(this,t,r,a);case 2:for(o={wounds:9109504,astralenergy:723929,karmaenergy:303670},i=[],c=0,u=Object.keys(o);c<u.length;c++)l=u[c],(p=getProperty(t,"system.status.".concat(l,".value")))&&i.push({value:p-this.system.status[l].value,stroke:o[l]});i.length&&this.tokenScrollingText(i);case 6:case"end":return d.stop()}}),_callee4,this)}))),function _preUpdate(t,r,a){return q.apply(this,arguments)})},{key:"applyDamage",value:(Z=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t){var r;return _regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:return r=Math.min(this.system.status.wounds.max,this.system.status.wounds.value-t),a.next=3,this.update({"system.status.wounds.value":r});case 3:case"end":return a.stop()}}),_callee5,this)}))),function applyDamage(t){return Z.apply(this,arguments)})},{key:"applyRegeneration",value:(B=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r,a){var o;return _regeneratorRuntime().wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return o={"system.status.wounds.value":Math.min(this.system.status.wounds.max,this.system.status.wounds.value+(t||0)),"system.status.karmaenergy.value":Math.min(this.system.status.karmaenergy.max,this.system.status.karmaenergy.value+(a||0)),"system.status.astralenergy.value":Math.min(this.system.status.astralenergy.max,this.system.status.astralenergy.value+(r||0))},i.next=3,this.update(o);case 3:case"end":return i.stop()}}),_callee6,this)}))),function applyRegeneration(t,r,a){return B.apply(this,arguments)})},{key:"applyMana",value:(W=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t,r){var a,o;return _regeneratorRuntime().wrap((function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:if(a="AsP"==r?"astralenergy":"karmaenergy",!((o=Math.min(this.system.status[a].max,this.system.status[a].value-t))>=0)){i.next=8;break}return i.next=5,this.update(_defineProperty({},"data.status.".concat(a,".value"),o));case 5:return i.abrupt("return",!0);case 8:return ui.notifications.error(game.i18n.localize("DSAError.NotEnough".concat(r))),i.abrupt("return",!1);case 10:case"end":return i.stop()}}),_callee7,this)}))),function applyMana(t,r){return W.apply(this,arguments)})},{key:"preparePostRollAction",value:function preparePostRollAction(t){var r=t.flags.data,a={flags:{img:t.flags.img},rollMode:r.rollMode,speaker:t.speaker,template:r.template,title:r.title,user:t.user};return r.attackerMessage&&(a.attackerMessage=r.attackerMessage),r.defenderMessage&&(a.defenderMessage=r.defenderMessage),r.unopposedStartMessage&&(a.unopposedStartMessage=r.unopposedStartMessage),a}},{key:"resetTargetAndMessage",value:function resetTargetAndMessage(t,r){t.originalTargets&&t.originalTargets.size>0&&(game.user.targets=t.originalTargets,game.user.targets.user=game.user),!t.defenderMessage&&t.startMessagesList&&(r.startMessagesList=t.startMessagesList)}},{key:"fatererollDamage",value:(H=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t,r,a,i,u,l){var p,d,h;return _regeneratorRuntime().wrap((function _callee8$(m){for(;;)switch(m.prev=m.next){case 0:return r.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(u,r),p=u.postData.damageRoll,m.t0=c.Z,m.next=6,new Roll(p.formula||p._formula).evaluate({async:!0});case 6:return m.t1=m.sent,m.next=9,m.t0.manualRolls.call(m.t0,m.t1,"CHATCONTEXT.rerollDamage");case 9:for(d=m.sent,h=0;h<d.dice.length;h++)d.dice[h].options.colorset="black";return m.next=13,c.Z.showDiceSoNice(d,a.rollMode);case 13:return ChatMessage.create(o.Z.chatDataSetup(t)),a.damageRoll=duplicate(d),this["".concat(u.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),m.next=18,i.update({"flags.data.fatePointDamageRerollUsed":!0});case 18:return m.next=20,this.reduceSchips(l);case 20:case"end":return m.stop()}}),_callee8,this)}))),function fatererollDamage(t,r,a,o,i,c){return H.apply(this,arguments)})},{key:"fateisTalented",value:(N=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t,r,a,i,u){var p,d=this;return _regeneratorRuntime().wrap((function _callee10$(h){for(;;)switch(h.prev=h.next){case 0:return r.talentedRerollUsed=!0,this.resetTargetAndMessage(u,r),t='<h3 class="center"><b>'.concat(game.i18n.localize("CHATFATE.faitepointUsed"),"</b></h3>\n            ").concat(game.i18n.format("CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"}),"<br>"),h.next=5,renderTemplate("systems/dsa5/templates/dialog/isTalentedReroll-dialog.html",{testData:a,postData:u.postData});case 5:p=h.sent,new l.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:p,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:function(){var l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(l){var p,h,m,y,g,v,_,b,w,k,x,S,T;return _regeneratorRuntime().wrap((function _callee9$(A){for(;;)switch(A.prev=A.next){case 0:if(!((p=l.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get()).length>0)){A.next=23;break}h=[],m=_createForOfIteratorHelper(p);try{for(m.s();!(y=m.n()).done;)g=y.value,v=a.roll.terms[2*g],h.push(v.number+"d"+v.faces+"["+v.options.colorset+"]")}catch(t){m.e(t)}finally{m.f()}return A.t0=c.Z,A.next=8,new Roll(h.join("+")).evaluate({async:!0});case 8:return A.t1=A.sent,A.next=11,A.t0.manualRolls.call(A.t0,A.t1,"CHATCONTEXT.talentedReroll");case 11:return h=A.sent,A.next=14,c.Z.showDiceSoNice(h,a.rollMode);case 14:_=0,b=[],w=_createForOfIteratorHelper(p);try{for(w.s();!(k=w.n()).done;)x=k.value,S=a.source.system["characteristic".concat(x+1)],T=S?game.i18n.localize("CHARAbbrev.".concat(S.value.toUpperCase()))+" - ":"",b.push("".concat(T).concat(a.roll.terms[2*x].results[0].result,"/").concat(h.terms[2*_].results[0].result)),a.roll.terms[2*x].results[0].result=Math.min(h.terms[2*_].results[0].result,a.roll.terms[2*x].results[0].result),_+=1}catch(t){w.e(t)}finally{w.f()}return t+="<b>".concat(game.i18n.localize("Roll"),"</b>: ").concat(b.join(", ")),ChatMessage.create(o.Z.chatDataSetup(t)),d["".concat(u.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),A.next=23,i.update({"flags.data.talentedRerollUsed":!0});case 23:case"end":return A.stop()}}),_callee9)})));return function callback(t){return l.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 7:case"end":return h.stop()}}),_callee10,this)}))),function fateisTalented(t,r,a,o,i){return N.apply(this,arguments)})},{key:"fatereroll",value:(z=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(t,r,a,i,u,p){var d,h=this;return _regeneratorRuntime().wrap((function _callee12$(m){for(;;)switch(m.prev=m.next){case 0:return r.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(u,r),m.next=4,renderTemplate("systems/dsa5/templates/dialog/fateReroll-dialog.html",{testData:a,postData:u.postData});case 4:d=m.sent,new l.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:d,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:function(){var l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(l){var d,m,y,g,v,_,b,w,k,x,S,T,A,O,P,E;return _regeneratorRuntime().wrap((function _callee11$(C){for(;;)switch(C.prev=C.next){case 0:if(!((d=l.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get()).length>0)){C.next=28;break}m=[],y=_createForOfIteratorHelper(d);try{for(y.s();!(g=y.n()).done;)v=g.value,_=a.roll.terms[2*v],m.push(_.number+"d"+_.faces+"["+_.options.colorset+"]")}catch(t){y.e(t)}finally{y.f()}return C.t0=c.Z,C.next=8,new Roll(m.join("+")).evaluate({async:!0});case 8:return C.t1=C.sent,C.next=11,C.t0.manualRolls.call(C.t0,C.t1,"CHATCONTEXT.Reroll");case 11:return m=C.sent,C.next=14,c.Z.showDiceSoNice(m,a.rollMode);case 14:b=0,w=[],k=o.Z.getSpeaker(a.extra.speaker),x=game.i18n.localize("LocalizedIDs.traditionPhex"),S=k.items.some((function(t){return"specialability"==t.type&&t.name==x})),T=_createForOfIteratorHelper(d);try{for(T.s();!(A=T.n()).done;)O=A.value,P=a.source.system["characteristic".concat(O+1)],E=P?"".concat(game.i18n.localize("CHARAbbrev.".concat(P.value.toUpperCase()))," - "):"",w.push("".concat(E).concat(a.roll.terms[2*O].results[0].result,"/").concat(m.terms[2*b].results[0].result)),a.roll.terms[2*O].results[0].result=S?Math.min(m.terms[2*b].results[0].result,a.roll.terms[2*O].results[0].result):m.terms[2*b].results[0].result,b+=1}catch(t){T.e(t)}finally{T.f()}return t+="<br><b>".concat(game.i18n.localize("Roll"),"</b>: ").concat(w.join(", ")),ChatMessage.create(o.Z.chatDataSetup(t)),h["".concat(u.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),C.next=26,i.update({"flags.data.fatePointRerollUsed":!0});case 26:return C.next=28,h.reduceSchips(p);case 28:case"end":return C.stop()}}),_callee11)})));return function callback(t){return l.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 6:case"end":return m.stop()}}),_callee12,this)}))),function fatereroll(t,r,a,o,i,c){return z.apply(this,arguments)})},{key:"fateaddQS",value:(j=_asyncToGenerator(_regeneratorRuntime().mark((function _callee13(t,r,a,i,c,u){return _regeneratorRuntime().wrap((function _callee13$(l){for(;;)switch(l.prev=l.next){case 0:return ChatMessage.create(o.Z.chatDataSetup(t)),game.user.targets.forEach((function(t){return t.setTarget(!1,{user:game.user,releaseOthers:!1,groupSelection:!0})})),r.fatePointAddQSUsed=!0,a.qualityStep=1,this["".concat(c.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),l.next=7,i.update({"flags.data.fatePointAddQSUsed":!0});case 7:return l.next=9,this.reduceSchips(u);case 9:case"end":return l.stop()}}),_callee13,this)}))),function fateaddQS(t,r,a,o,i,c){return j.apply(this,arguments)})},{key:"fateImprove",value:(M=_asyncToGenerator(_regeneratorRuntime().mark((function _callee15(t,r,a,i,c,u){var p,d,h,m=this;return _regeneratorRuntime().wrap((function _callee15$(y){for(;;)switch(y.prev=y.next){case 0:if(ChatMessage.create(o.Z.chatDataSetup(t)),this.resetTargetAndMessage(c,r),p=i.flags.data.preData.source.type,!["spell","liturgy","ceremony","ritual","skill"].includes(p)){y.next=10;break}return y.next=6,renderTemplate("systems/dsa5/templates/dialog/fateImprove-dialog.html",{testData:a,postData:c.postData});case 6:d=y.sent,new l.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:d,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee14(t){var o,l,p;return _regeneratorRuntime().wrap((function _callee14$(d){for(;;)switch(d.prev=d.next){case 0:if(o=[0,0,0],1!=(l=t.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get()).length){d.next=12;break}return o[l]=2,p={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:o.join("|"),type:"roll"},a.roll.terms[2*l].results[0].result=Math.max(1,a.roll.terms[2*l].results[0].result-2),a.situationalModifiers.push(p),m["".concat(c.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),d.next=10,i.update({"flags.data.fateImproved":!0});case 10:return d.next=12,m.reduceSchips(u);case 12:case"end":return d.stop()}}),_callee14)})));return function callback(r){return t.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0),y.next=18;break;case 10:return h={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:2,type:"roll"},a.situationalModifiers.push(h),a.roll.terms[0].results[0].result=Math.max(1,a.roll.terms[0].results[0].result-2),this["".concat(c.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),y.next=16,i.update({"flags.data.fateImproved":!0});case 16:return y.next=18,this.reduceSchips(u);case 18:case"end":return y.stop()}}),_callee15,this)}))),function fateImprove(t,r,a,o,i,c){return M.apply(this,arguments)})},{key:"reduceSchips",value:(G=_asyncToGenerator(_regeneratorRuntime().mark((function _callee16(t){var r;return _regeneratorRuntime().wrap((function _callee16$(a){for(;;)switch(a.prev=a.next){case 0:if(0!=t){a.next=5;break}return a.next=3,this.update({"system.status.fatePoints.value":this.system.status.fatePoints.value-1});case 3:a.next=9;break;case 5:return(r=game.settings.get("dsa5","groupschips").split("/").map((function(t){return Number(t)})))[0]=r[0]-1,a.next=9,game.settings.set("dsa5","groupschips",r.join("/"));case 9:case"end":return a.stop()}}),_callee16,this)}))),function reduceSchips(t){return G.apply(this,arguments)})},{key:"useFateOnRoll",value:(L=_asyncToGenerator(_regeneratorRuntime().mark((function _callee17(t,r,a){var i,c,u,l,p,d;return _regeneratorRuntime().wrap((function _callee17$(h){for(;;)switch(h.prev=h.next){case 0:("isTalented"==r||o.Z.fateAvailable(this,1==a))&&(i=t.flags.data,c=this.preparePostRollAction(t),0==a?(u=this.system.status.fatePoints.value-1,l="PointsRemaining"):(u=game.settings.get("dsa5","groupschips").split("/")[0],l="GroupPointsRemaining"),p='<h3 class="center"><b>'.concat(game.i18n.localize("CHATFATE.faitepointUsed"),"</b></h3>\n                ").concat(game.i18n.format("CHATFATE."+r,{character:"<b>"+this.name+"</b>"}),"<br>\n                <b>").concat(game.i18n.localize("CHATFATE.".concat(l)),"</b>: ").concat(u),(d=i.preData).extra.actor=o.Z.getSpeaker(d.extra.speaker).toObject(!1),this["fate".concat(r)](p,c,d,t,i,a));case 1:case"end":return h.stop()}}),_callee17,this)}))),function useFateOnRoll(t,r,a){return L.apply(this,arguments)})},{key:"setupRegeneration",value:function setupRegeneration(t){var r=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2?arguments[2]:void 0,u=game.i18n.localize("regenerationTest"),l={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:t,actor:this.toObject(!1),options:a,speaker:{token:o,actor:this.id}}};l.extra.actor.isMage=this.system.isMage,l.extra.actor.isPriest=this.system.isPriest;var p=h.Z.getRollModifiers(l.extra.actor,l.source),d={title:u,template:"/systems/dsa5/templates/dialog/regeneration-dialog.html",data:{rollMode:a.rollMode,regenerationInterruptOptions:i.Z.regenerationInterruptOptions,regnerationCampLocations:i.Z.regnerationCampLocations,showAspModifier:this.system.isMage,showKapModifier:this.system.isPriest,situationalModifiers:p,modifier:a.modifier||0},callback:function callback(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};l.situationalModifiers=Actordsa5._parseModifiers(t),m.rollMode=t.find('[name="rollMode"]').val(),l.situationalModifiers.push({name:game.i18n.localize("camplocation")+" - "+t.find('[name="regnerationCampLocations"] option:selected').text(),value:t.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("interruption")+" - "+t.find('[name="regenerationInterruptOptions"] option:selected').text(),value:t.find('[name="regenerationInterruptOptions"]').val()}),l.regenerationFactor=t.find('[name="badEnvironment"]').is(":checked")?.5:1;for(var o=["LeP","KaP","AsP"],i={},c=0,u=o;c<u.length;c++){var p=u[c];l["".concat(p,"Modifier")]=Number(t.find('[name="'.concat(p,'Modifier"]')).val()||0),l["regeneration".concat(p)]=Number(r.system.status.regeneration["".concat(p,"max")]);var d=t.find('[name="regenerate'.concat(p,'"]')).is(":checked")?1:0;l["regenerate".concat(p)]=d,d&&(i["system.status.regeneration.".concat(p,"Temp")]=0)}return mergeObject(l.extra.options,a),r.update(i),{testData:l,cardOptions:m}}},m=this._setupCardOptions("systems/dsa5/templates/chat/roll/regeneration-card.html",u,o);return c.Z.setupDialog({dialogOptions:d,testData:l,cardOptions:m})}},{key:"setupDodge",value:function setupDodge(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0,a="dodge",o=this.system.status[a],i=game.i18n.localize(a)+" "+game.i18n.localize("Test"),u={source:{system:o,type:a},opposable:!1,extra:{statusId:a,actor:this.toObject(!1),options:t,speaker:{token:r,actor:this.id}}},l=[game.i18n.localize(a),game.i18n.localize("LocalizedIDs.wrestle")],p=m.Z.buildCombatSpecAbs(this,["Combat"],l,"parry"),d=h.Z.getRollModifiers(u.extra.actor,u.source),y=m.Z.getDefenseMalus(d,this),v=g.Z.multipleDefenseValue(this,u.source),_={title:i,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:{rollMode:t.rollMode,combatSpecAbs:p,showDefense:!0,situationalModifiers:d,isRangeAttack:y,defenseCountString:game.i18n.format("defenseCount",{malus:v})},callback:function callback(t){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return b.rollMode=t.find('[name="rollMode"]').val(),u.situationalModifiers=Actordsa5._parseModifiers(t),(r=u.situationalModifiers).push.apply(r,_toConsumableArray(m.Z.getSpecAbModifiers(t,"parry"))),u.situationalModifiers.push({name:game.i18n.localize("attackFromBehind"),value:t.find('[name="attackFromBehind"]').is(":checked")?-4:0},{name:game.i18n.format("defenseCount",{malus:v}),value:(Number(t.find('[name="defenseCount"]').val())||0)*v}),mergeObject(u.extra.options,a),{testData:u,cardOptions:b}}},b=this._setupCardOptions("systems/dsa5/templates/chat/roll/status-card.html",i,r);return c.Z.setupDialog({dialogOptions:_,testData:u,cardOptions:b})}},{key:"setupCharacteristic",value:function setupCharacteristic(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0,o=this.system.characteristics[t],u=game.i18n.localize(o.label)+" "+game.i18n.localize("Test"),l={opposable:!1,source:{type:"char",system:o},extra:{characteristicId:t,actor:this.toObject(!1),options:r,speaker:{token:a,actor:this.id}}},p={title:u,template:"/systems/dsa5/templates/dialog/characteristic-dialog.html",data:{rollMode:r.rollMode,difficultyLabels:i.Z.attributeDifficultyLabels,modifier:r.modifier||0},callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d.rollMode=t.find('[name="rollMode"]').val(),l.testDifficulty=i.Z.attributeDifficultyModifiers[t.find('[name="testDifficulty"]').val()],l.situationalModifiers=Actordsa5._parseModifiers(t),mergeObject(l.extra.options,r),{testData:l,cardOptions:d}}},d=this._setupCardOptions("systems/dsa5/templates/chat/roll/characteristic-card.html",u,a);return c.Z.setupDialog({dialogOptions:p,testData:l,cardOptions:d})}},{key:"actorEffects",value:(R=_asyncToGenerator(_regeneratorRuntime().mark((function _callee18(){var t,r,a=this;return _regeneratorRuntime().wrap((function _callee18$(o){for(;;)switch(o.prev=o.next){case 0:if(t=["dead"],o.t0=game.user.isGM||this.testUserPermission(game.user,"OBSERVER"),o.t0){o.next=6;break}return o.next=5,game.settings.get("dsa5","hideEffects");case 5:o.t0=!o.sent;case 6:return r=o.t0,o.abrupt("return",r?this.effects.filter((function(t){return!t.disabled&&!t.notApplicable&&(game.user.isGM||!t.getFlag("dsa5","hidePlayers"))&&!t.getFlag("dsa5","hideOnToken")&&(t.origin==a.uuid||!t.origin)})):this.effects.filter((function(r){return t.includes(r.getFlag("core","statusId"))})));case 8:case"end":return o.stop()}}),_callee18,this)}))),function actorEffects(){return R.apply(this,arguments)})},{key:"_preCreate",value:(I=_asyncToGenerator(_regeneratorRuntime().mark((function _callee19(t,r,a){var o;return _regeneratorRuntime().wrap((function _callee19$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,_get(_getPrototypeOf(Actordsa5.prototype),"_preCreate",this).call(this,t,r,a);case 2:o={},t.img||(o.img="icons/svg/mystery-man-black.svg"),"character"==t.type&&mergeObject(o,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(o);case 6:case"end":return i.stop()}}),_callee19,this)}))),function _preCreate(t,r,a){return I.apply(this,arguments)})},{key:"_setupCardOptions",value:function _setupCardOptions(t,r,a){var o=game.canvas.tokens.get(a),i={speaker:{alias:o?o.name:this.prototypeToken.name,actor:this.id},title:r,template:t,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{var c=ChatMessage.getSpeaker();c.actor==this.id&&(i.speaker.alias=c.alias,i.speaker.token=c.token,i.speaker.scene=c.scene,i.flags.img=c.token?canvas.tokens.get(c.token).img:i.flags.img)}return i}},{key:"swapMag",value:(D=_asyncToGenerator(_regeneratorRuntime().mark((function _callee20(t){var r,a;return _regeneratorRuntime().wrap((function _callee20$(o){for(;;)switch(o.prev=o.next){case 0:if(r=this.items.get(t),!((a=this.items.get(r.system.currentAmmo.value))&&a.system.quantity.value>1)){o.next=7;break}return o.next=5,this.updateEmbeddedDocuments("Item",[{_id:a.id,"system.quantity.value":a.system.quantity.value-1,"system.mag.value":a.system.mag.max}]);case 5:return w.Z.playEquipmentWearStatusChange(a),o.abrupt("return",a);case 7:return ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),o.abrupt("return",void 0);case 9:case"end":return o.stop()}}),_callee20,this)}))),function swapMag(t){return D.apply(this,arguments)})},{key:"payMiracles",value:(C=_asyncToGenerator(_regeneratorRuntime().mark((function _callee21(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee21$(i){for(;;)switch(i.prev=i.next){case 0:if(t.extra.miraclePaid){i.next=8;break}if(t.extra.miraclePaid=!0,r=t.situationalModifiers.some((function(t){return t.name.trim()==game.i18n.localize("LocalizedIDs.miracleMight")})),a=t.situationalModifiers.some((function(t){return t.name.trim()==game.i18n.localize("LocalizedIDs.miracle")})),!(o=r?6:a?4:0)){i.next=8;break}return i.next=8,this.update({"system.status.karmaenergy.value":this.system.status.karmaenergy.value-o});case 8:case"end":return i.stop()}}),_callee21,this)}))),function payMiracles(t){return C.apply(this,arguments)})},{key:"consumeAmmunition",value:(E=_asyncToGenerator(_regeneratorRuntime().mark((function _callee22(t){var r;return _regeneratorRuntime().wrap((function _callee22$(a){for(;;)switch(a.prev=a.next){case 0:if(!t.extra.ammo||t.extra.ammoDecreased){a.next=9;break}if(t.extra.ammoDecreased=!0,!t.extra.ammo._id){a.next=7;break}return r={_id:t.extra.ammo._id},"mag"==t.extra.ammo.system.ammunitiongroup.value?t.extra.ammo.system.mag.value<=0?(t.extra.ammo.system.quantity.value--,r["system.quantity.value"]=t.extra.ammo.system.quantity.value,r["system.mag.value"]=t.extra.ammo.system.mag.max-1):r["system.mag.value"]=t.extra.ammo.system.mag.value-1:(t.extra.ammo.system.quantity.value--,r["system.quantity.value"]=t.extra.ammo.system.quantity.value),a.next=7,this.updateEmbeddedDocuments("Item",[r,{_id:t.source._id,"system.reloadTime.progress":0}]);case 7:case 13:a.next=18;break;case 9:if("rangeweapon"!=t.source.type&&("trait"!=t.source.type||"rangeAttack"!=t.source.system.traitType.value)||t.extra.ammoDecreased){a.next=15;break}return t.extra.ammoDecreased=!0,a.next=13,this.updateEmbeddedDocuments("Item",[{_id:t.source._id,"system.reloadTime.progress":0}]);case 15:if(!["spell","liturgy"].includes(t.source.type)||"emptyActor"==t.extra.speaker.token){a.next=18;break}return a.next=18,this.updateEmbeddedDocuments("Item",[{_id:t.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}]);case 18:case"end":return a.stop()}}),_callee22,this)}))),function consumeAmmunition(t){return E.apply(this,arguments)})},{key:"basicTest",value:(P=_asyncToGenerator(_regeneratorRuntime().mark((function _callee23(t){var r,a,o,i,l,p,d,h=arguments;return _regeneratorRuntime().wrap((function _callee23$(m){for(;;)switch(m.prev=m.next){case 0:return r=t.testData,a=t.cardOptions,o=h.length>1&&void 0!==h[1]?h[1]:{},m.next=4,c.Z.rollDices(r,a);case 4:return r=m.sent,m.next=7,c.Z.rollTest(r);case 7:return i=m.sent,r.extra.options.other&&(i.other||(i.other=[]),(l=i.other).push.apply(l,_toConsumableArray(r.extra.options.other))),i.postFunction="basicTest",game.user.targets.size&&(a.isOpposedTest=r.opposable,p=" - ".concat(game.i18n.localize("Opposed")),a.isOpposedTest&&a.title.match(p+"$")!=p&&(a.title+=p)),m.next=13,this.consumeAmmunition(r);case 13:return m.next=15,this.payMiracles(r);case 15:if(o.suppressMessage){m.next=22;break}return m.next=18,c.Z.renderRollCard(a,i,o.rerenderMessage);case 18:return d=m.sent,m.next=21,u.Z.handleOpposedTarget(d);case 21:i.messageId=d.id;case 22:return m.abrupt("return",{result:i,cardOptions:a,options:o});case 23:case"end":return m.stop()}}),_callee23,this)}))),function basicTest(t){return P.apply(this,arguments)})},{key:"addCondition",value:(O=_asyncToGenerator(_regeneratorRuntime().mark((function _callee24(t){var r,a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee24$(c){for(;;)switch(c.prev=c.next){case 0:if(r=i.length>1&&void 0!==i[1]?i[1]:1,a=i.length>2&&void 0!==i[2]&&i[2],o=!(i.length>3&&void 0!==i[3])||i[3],"bleeding"!=t){c.next=7;break}return c.next=6,g.Z.bleedingMessage(this);case 6:case 9:return c.abrupt("return",c.sent);case 7:return c.next=9,h.Z.addCondition(this,t,r,a,o);case 10:case"end":return c.stop()}}),_callee24,this)}))),function addCondition(t){return O.apply(this,arguments)})},{key:"initResistPainRoll",value:(A=_asyncToGenerator(_regeneratorRuntime().mark((function _callee25(){var t,r;return _regeneratorRuntime().wrap((function _callee25$(a){for(;;)switch(a.prev=a.next){case 0:if(2!=(t=game.settings.get("dsa5","selfControlOnPain"))&&!this.hasCondition("incapacitated")&&(1!=t||this.hasPlayerOwner)){a.next=3;break}return a.abrupt("return");case 3:return a.next=5,renderTemplate("systems/dsa5/templates/chat/roll/resist-pain.html",{actor:this});case 5:return r=a.sent,a.next=8,ChatMessage.create(o.Z.chatDataSetup(r));case 8:case"end":return a.stop()}}),_callee25,this)}))),function initResistPainRoll(){return A.apply(this,arguments)})},{key:"finishResistPainRoll",value:(T=_asyncToGenerator(_regeneratorRuntime().mark((function _callee27(){var t,r,a=this;return _regeneratorRuntime().wrap((function _callee27$(o){for(;;)switch(o.prev=o.next){case 0:r=this.items.find((function(t){return t.name==game.i18n.localize("LocalizedIDs.selfControl")&&"skill"==t.type})),this.setupSkill(r,{subtitle:" (".concat(game.i18n.localize("ActiveEffects.resistRoll"),")")},null===(t=this.token)||void 0===t?void 0:t.id).then(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee26(t){return _regeneratorRuntime().wrap((function _callee26$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a.basicTest(t);case 2:(r.sent.result.successLevel||0)<1&&a.addCondition("incapacitated");case 5:case"end":return r.stop()}}),_callee26)})));return function(r){return t.apply(this,arguments)}}());case 2:case"end":return o.stop()}}),_callee27,this)}))),function finishResistPainRoll(){return T.apply(this,arguments)})},{key:"_dependentEffects",value:(S=_asyncToGenerator(_regeneratorRuntime().mark((function _callee28(t,r,a){var i;return _regeneratorRuntime().wrap((function _callee28$(c){for(;;)switch(c.prev=c.next){case 0:if(4!=duplicate(r).flags.dsa5.value){c.next=22;break}if("inpain"!=t){c.next=7;break}return c.next=5,this.initResistPainRoll();case 5:c.next=22;break;case 7:if(!["encumbered","stunned","feared","confused","trance"].includes(t)){c.next=12;break}return c.next=10,this.addCondition("incapacitated");case 10:c.next=22;break;case 12:if("paralysed"!=t){c.next=17;break}return c.next=15,this.addCondition("rooted");case 15:c.next=22;break;case 17:if(!["drunken","exhaustion"].includes(t)){c.next=22;break}return c.next=20,this.addCondition("stunned");case 20:return c.next=22,this.removeCondition(t);case 22:if("dead"!=t||!game.combat){c.next=25;break}return c.next=25,this.markDead(!0);case 25:if("unconscious"!=t){c.next=28;break}return c.next=28,this.addCondition("prone");case 28:if(!(a>0&&"inpain"==t&&!this.hasCondition("bloodrush")&&p.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.frenzy")))){c.next=33;break}return c.next=31,this.addCondition("bloodrush");case 31:i=o.Z.replaceConditions("".concat(game.i18n.format("CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+this.name+"</b>"}))),ChatMessage.create(o.Z.chatDataSetup(i));case 33:case"end":return c.stop()}}),_callee28,this)}))),function _dependentEffects(t,r,a){return S.apply(this,arguments)})},{key:"removeCondition",value:(x=_asyncToGenerator(_regeneratorRuntime().mark((function _callee29(t){var r,a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee29$(c){for(;;)switch(c.prev=c.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:1,a=!(i.length>2&&void 0!==i[2])||i[2],o=i.length>3&&void 0!==i[3]&&i[3],c.next=5,h.Z.removeCondition(this,t,r,a,o);case 5:return c.abrupt("return",c.sent);case 6:case"end":return c.stop()}}),_callee29,this)}))),function removeCondition(t){return x.apply(this,arguments)})},{key:"hasCondition",value:function hasCondition(t){return h.Z.hasCondition(this,t)}},{key:"markDead",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee30(t){var r,a,o,i;return _regeneratorRuntime().wrap((function _callee30$(c){for(;;)switch(c.prev=c.next){case 0:r=this.getActiveTokens(),a=_createForOfIteratorHelper(r),c.prev=2,a.s();case 4:if((o=a.n()).done){c.next=11;break}if(!(i=o.value).combatant){c.next=9;break}return c.next=9,i.combatant.update({defeated:t});case 9:c.next=4;break;case 11:c.next=16;break;case 13:c.prev=13,c.t0=c.catch(2),a.e(c.t0);case 16:return c.prev=16,a.f(),c.finish(16);case 19:case"end":return c.stop()}}),_callee30,this,[[2,13,16,19]])}))),function markDead(t){return a.apply(this,arguments)})}],[{key:"create",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee31(t,r){var a,i,c,u;return _regeneratorRuntime().wrap((function _callee31$(l){for(;;)switch(l.prev=l.next){case 0:if(!(t instanceof Array)){l.next=4;break}return l.next=3,_get(_getPrototypeOf(Actordsa5),"create",this).call(this,t,r);case 3:return l.abrupt("return",l.sent);case 4:if(!t.items){l.next=8;break}return l.next=7,_get(_getPrototypeOf(Actordsa5),"create",this).call(this,t,r);case 7:return l.abrupt("return",l.sent);case 8:return t.items=[],t.img&&"icons/svg/mystery-man.svg"!=t.img||(t.img="icons/svg/mystery-man-black.svg"),l.next=12,o.Z.allSkills();case 12:if(l.t0=l.sent,l.t0){l.next=15;break}l.t0=[];case 15:return i=l.t0,l.next=18,o.Z.allCombatSkills();case 18:if(l.t1=l.sent,l.t1){l.next=21;break}l.t1=[];case 21:return c=l.t1,l.next=24,o.Z.allMoneyItems();case 24:if(l.t2=l.sent,l.t2){l.next=27;break}l.t2=[];case 27:return u=l.t2,(a=t.items).push.apply(a,_toConsumableArray(i).concat(_toConsumableArray(c),_toConsumableArray(u))),"character"!=t.type&&(t.system={status:{fatePoints:{current:0,value:0}}}),"creature"!=t.type&&[void 0,0].includes(getProperty(t,"system.status.wounds.value"))&&mergeObject(t,{system:{status:{wounds:{value:16}}}}),l.next=33,_get(_getPrototypeOf(Actordsa5),"create",this).call(this,t,r);case 33:return l.abrupt("return",l.sent);case 34:case"end":return l.stop()}}),_callee31,this)}))),function create(t,a){return r.apply(this,arguments)})},{key:"lockedCondition",value:function lockedCondition(){return{label:game.i18n.localize("MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{core:{statusId:"locked"},dsa5:{value:null,editable:!0,noEffect:!0,hidePlayers:!0,description:game.i18n.localize("MERCHANT.locked"),custom:!0}}}}},{key:"canAdvance",value:function canAdvance(t){return t.canAdvance}},{key:"armorValue",value:function armorValue(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.items.filter((function(t){return"armor"==t.type&&1==t.system.worn.value}));r.origin&&(a=a.map((function(a){var o=mergeObject(duplicate(r),{armor:a});return b.Z.applyRollTransformation(t,o,4).options.armor})));var o=a.reduce((function(t,r){return t+_.Z.armorWearModifier(r,r.system.protection.value)}),0),i=t.items.filter((function(t){return"trait"==t.type&&"armor"==t.system.traitType.value})).reduce((function(t,r){return t+Number(r.system.at.value)}),0);return{wornArmor:a,armor:o+i+(t.system.totalArmor||0)}}},{key:"_calculateCombatSkillValues",value:function _calculateCombatSkillValues(t,r){if("melee"==t.system.weapontype.value){var a=t.system.guidevalue.value.split("/").map((function(t){return Number(r.characteristics[t].initial)+Number(r.characteristics[t].modifier)+Number(r.characteristics[t].advances)+Number(r.characteristics[t].gearmodifier)})),i=Math.max.apply(Math,_toConsumableArray(a));t.system.parry.value=Math.ceil(t.system.talentValue.value/2)+Math.max(0,Math.floor((i-8)/3))+Number(game.settings.get("dsa5","higherDefense"));var c=r.characteristics.mu.initial+r.characteristics.mu.modifier+r.characteristics.mu.advances+r.characteristics.mu.gearmodifier;t.system.attack.value=t.system.talentValue.value+Math.max(0,Math.floor((c-8)/3))}else{t.system.parry.value=0;var u=r.characteristics.ff.initial+r.characteristics.ff.modifier+r.characteristics.ff.advances+r.characteristics.ff.gearmodifier;t.system.attack.value=t.system.talentValue.value+Math.max(0,Math.floor((u-8)/3))}return t.cost=game.i18n.format("advancementCost",{cost:o.Z._calculateAdvCost(t.system.talentValue.value,t.system.StF.value)}),t.canAdvance=Actordsa5.canAdvance(r),t}},{key:"_parseModifiers",value:function _parseModifiers(t,r){var a=[];return t.find('[name="situationalModifiers"] option:selected').each((function(){var t=$(this).val(),r={name:$(this).text().trim().split("[")[0],value:isNaN(t)?t:Number(t),type:$(this).attr("data-type")};"dmg"==r.type&&(r.damageBonus=r.value,r.value=0),$(this).attr("data-specAbId")&&(r.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(r.armorPen=$(this).attr("data-armorPen")),a.push(r)})),a.push({name:game.i18n.localize("manual"),value:Number(t.find('[name="testModifier"]').val()),type:""}),a}},{key:"_prepareConsumable",value:function _prepareConsumable(t){return t.system.maxCharges&&(t.consumable=!0,t.structureMax=t.system.maxCharges,t.structureCurrent=t.system.charges),t}},{key:"prepareMag",value:function prepareMag(t){return"mag"==t.system.ammunitiongroup.value&&(t.structureMax=t.system.mag.max,t.structureCurrent=t.system.mag.value),t}},{key:"_prepareitemStructure",value:function _prepareitemStructure(t){t.system.structure&&0!=t.system.structure.max&&(t.structureMax=t.system.structure.max,t.structureCurrent=t.system.structure.value);var r=getProperty(t,"flags.dsa5.enchantments");if(r&&r.length>0)t.enchantClass="rar";else if(t.system.effect&&""!=t.system.effect.value||t.effects.length>0)if("armor"==t.type){var a,o=_createForOfIteratorHelper(t.system.effect.value.split(/,|;/).map((function(t){return t.trim()})));try{for(o.s();!(a=o.n()).done;){var i=a.value.replace(/(\s+)/g," ").trim().split(" ");if(2!=i.length||![game.i18n.localize("CHARAbbrev.INI").toLowerCase(),game.i18n.localize("CHARAbbrev.GS").toLowerCase()].includes(i[1].toLowerCase())||isNaN(i[0])||-1!=i[0]){t.enchantClass="common";break}}}catch(t){o.e(t)}finally{o.f()}}else t.enchantClass="common";return t}},{key:"_prepareMeleetrait",value:function _prepareMeleetrait(t){return t.attack=Number(t.system.at.value),0!=t.system.pa&&(t.parry=t.system.pa),this._parseDmg(t)}},{key:"_prepareMeleeWeapon",value:function _prepareMeleeWeapon(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=r.find((function(r){return r.name==t.system.combatskill.value}));if(i){t.attack=Number(i.system.attack.value)+Number(t.system.atmod.value);var c=t.system.guidevalue.value.split("/").map((function(t){return a.system.characteristics[t]?Number(a.system.characteristics[t].initial)+Number(a.system.characteristics[t].modifier)+Number(a.system.characteristics[t].advances)+Number(a.system.characteristics[t].gearmodifier):0})),u=Math.ceil(i.system.talentValue.value/2)+Math.max(0,Math.floor((Math.max.apply(Math,_toConsumableArray(c))-8)/3))+Number(game.settings.get("dsa5","higherDefense"));t.parry=u+Number(t.system.pamod.value)+(t.system.combatskill.value==game.i18n.localize("LocalizedIDs.Shields")?Number(t.system.pamod.value):0),t.yieldedTwoHand=g.Z.isYieldedTwohanded(t),t.yieldedTwoHand||(o||(o=duplicate(a.items).filter((function(r){return"meleeweapon"==r.type&&r.system.worn.value&&r._id!=t._id&&!g.Z.isYieldedTwohanded(r)}))),o.length>0&&(t.parry+=Math.max.apply(Math,_toConsumableArray(o.map((function(t){return t.system.pamod.offhandMod})))),t.attack+=Math.max.apply(Math,_toConsumableArray(o.map((function(t){return t.system.atmod.offhandMod}))))));var l=0;if(t.system.worn.wrongGrip)if(t.yieldedTwoHand)t.parry-=1,l=1;else{t.system.reach.value="medium";var p=game.i18n.localize("LocalizedCTs.".concat(t.system.combatskill.value));switch(p){case"Two-Handed Impact Weapons":case"Two-Handed Swords":t.parry-=3;var d=new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex"));if(d.test(t.name))l=-2;else{var h=game.i18n.localize("wrongGrip.oneHanded");t.gripDamageText=" (".concat(h," * 0.5)"),t.dmgMultipliers=[{name:h,val:"0.5"}]}break;default:t.parry-=1,l=-1}}if("-"!=(t=this._parseDmg(t)).system.guidevalue.value){var m=Math.max.apply(Math,_toConsumableArray(t.system.guidevalue.value.split("/").map((function(t){return Number(a.system.characteristics[t].value)})))),y=m-Number(t.system.damageThreshold.value)+l;y>0&&(t.extraDamage=y,t.damageAdd=Roll.safeEval(t.damageAdd+" + "+Number(y)),t.damageAdd=(t.damageAdd>0?"+":"")+t.damageAdd)}_.Z.weaponWearModifier(t),t.damageToolTip=_.Z.damageTooltip(t)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:t.system.combatskill.value,item:t.name}));return t}},{key:"_prepareRangeTrait",value:function _prepareRangeTrait(t){return t.attack=Number(t.system.at.value),t.LZ=Number(t.system.reloadTime.value),t.LZ>0&&Actordsa5.buildReloadProgress(t),this._parseDmg(t)}},{key:"calcLZ",value:function calcLZ(t,r){var a=1,o=0;t.system.combatskill.value==game.i18n.localize("LocalizedIDs.Throwing Weapons")?o=-1*d.Z.abilityStep(r,game.i18n.localize("LocalizedIDs.quickdraw")):t.system.combatskill.value==game.i18n.localize("LocalizedIDs.Crossbows")&&d.Z.hasAbility(r,"".concat(game.i18n.localize("LocalizedIDs.quickload")," (").concat(game.i18n.localize("LocalizedIDs.Crossbows"),")"))?a=.5:o=-1*d.Z.abilityStep(r,"".concat(game.i18n.localize("LocalizedIDs.quickload")," (").concat(game.i18n.localize(t.system.combatskill.value),")"));var i="".concat(t.system.reloadTime.value).split("/");if("mag"==t.system.ammunitiongroup.value){var c=r.items.find((function(r){return r.id==t.system.currentAmmo.value||r._id==t.system.currentAmmo.value})),u=0;c&&(c=c.toObject()).system.mag.value<=0&&(u=1),i=i[u]||i[0]}else i=i[0];return Math.max(0,Math.round(Number(i)*a)+o)}},{key:"_parseDmg",value:function _parseDmg(t){var r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,o=new Roll(t.system.damage.value.replace(/[Ww]/g,"d"),{async:!1}),i="",c="",u="+",l=_createForOfIteratorHelper(o.terms);try{for(l.s();!(r=l.n()).done;){var p=r.value;p.faces?i=p.number+"d"+p.faces:p.operator?u=p.operator:p.number&&(c+=Number("".concat(u).concat(p.number)))}}catch(t){l.e(t)}finally{l.f()}if(a){var d=getProperty(a,"system.damageMod");Number(d)?c+="+".concat(Number(d)):d&&(t.damageBonusDescription=", ".concat(d," ").concat(game.i18n.localize("CHARAbbrev.damage")," ").concat(a.name))}return c&&(c=Roll.safeEval(c)),t.damagedie=i||"0d6",t.damageAdd=""!=c?(Number(c)>=0?"+":"")+c:"",t}},{key:"buildReloadProgress",value:function buildReloadProgress(t){var r=t.system.reloadTime.progress/t.LZ;t.title=game.i18n.format("WEAPON.loading",{status:"".concat(t.system.reloadTime.progress,"/").concat(t.LZ)}),t.progress="".concat(t.system.reloadTime.progress,"/").concat(t.LZ),r>=1&&(t.title=game.i18n.localize("WEAPON.loaded")),this.progressTransformation(t,r)}},{key:"progressTransformation",value:function progressTransformation(t,r){r>=.5?(t.transformRight="181deg",t.transformLeft="".concat(Math.round(360*r-179),"deg")):(t.transformRight="".concat(Math.round(360*r+1),"deg"),t.transformLeft=0)}},{key:"buildSpellChargeProgress",value:function buildSpellChargeProgress(t){if(t.LZ=Number(t.system.castingTime.modified)||0,t.LZ>1){var r=t.system.castingTime.progress/t.LZ;t.title=game.i18n.format("SPELL.loading",{status:"".concat(t.system.castingTime.progress,"/").concat(t.LZ)}),t.progress="".concat(t.system.castingTime.progress,"/").concat(t.LZ),this.progressTransformation(t,r)}return t}},{key:"_prepareRangeWeapon",value:function _prepareRangeWeapon(t,r,a,o){var i,c=a.find((function(r){return r.name==t.system.combatskill.value}));if(t.calculatedRange=t.system.reach.value,c){if(t.attack=Number(c.system.attack.value),"-"!=t.system.ammunitiongroup.value&&(r||(r=actorData.inventory.ammunition.items),t.ammo=r.filter((function(r){return r.system.ammunitiongroup.value==t.system.ammunitiongroup.value})),i=r.find((function(r){return r._id==t.system.currentAmmo.value})))){var u=Number(i.system.rangeMultiplier)||1;t.calculatedRange=t.calculatedRange.split("/").map((function(t){return Math.round(Number(t)*u)})).join("/"),t.attack+=Number(i.system.atmod)||0,"mag"==i.system.ammunitiongroup.value&&(t.ammoMax=i.system.mag.max,t.ammoCurrent=i.system.mag.value)}t.LZ=Actordsa5.calcLZ(t,o),t.LZ>0&&Actordsa5.buildReloadProgress(t),_.Z.weaponWearModifier(t),t.damageToolTip=_.Z.damageTooltip(t)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:t.system.combatskill.value,item:t.name}));return this._parseDmg(t,i)}}]),Actordsa5}()},416:(t,r,a)=>{a.d(r,{Z:()=>c,x:()=>i});var o=a(565);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var i=function(t){_inherits(AddTargetDialog,Dialog);var r,a,i=_createSuper(AddTargetDialog);function AddTargetDialog(){return _classCallCheck(this,AddTargetDialog),i.apply(this,arguments)}return _createClass(AddTargetDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(AddTargetDialog.prototype),"activateListeners",this).call(this,t);var a=t.find(".combatant");a.click((function(t){return r.setTargets(t)})),a.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),a.mousedown((function(t){return r._onRightClick(t)}))}},{key:"_onCombatantHoverOut",value:function _onCombatantHoverOut(t){this._getCombatApp()._onCombatantHoverOut(t)}},{key:"_onCombatantHoverIn",value:function _onCombatantHoverIn(t){this._getCombatApp()._onCombatantHoverIn(t)}},{key:"_onRightClick",value:function _onRightClick(t){if(2==t.button){var r=game.combat.combatants.get(t.currentTarget.dataset.combatantId);if(r.token)return canvas.animatePan({x:r.token.x,y:r.token.y})}}},{key:"_getCombatApp",value:function _getCombatApp(){return game.combats.apps[0]}},{key:"setTargets",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a;return _regeneratorRuntime().wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:(r=t.originalEvent.shiftKey)||$(t.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(t.currentTarget).addClass("selectedTarget"),a=t.currentTarget.dataset.combatantId,game.combat.combatants.get(a).token.object.setTarget(!0,{user:game.user,releaseOthers:!r,groupSelection:!0});case 6:case"end":return o.stop()}}),_callee)}))),function setTargets(t){return a.apply(this,arguments)})}],[{key:"getDialog",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r,a,i,c;return _regeneratorRuntime().wrap((function _callee2$(u){for(;;)switch(u.prev=u.next){case 0:return a=Array.from(game.user.targets).map((function(t){return t.id})),i=[],c=canvas.scene?null===(r=canvas.scene.tokens.get(t.token))||void 0===r?void 0:r.object:void 0,game.combat&&game.combat.combatants.forEach((function(t){if(t.visible){if(t.isSelected=a.includes(t.token.id),c&&t.token){var r=canvas.scene.tokens.get(t.token.id).object;t.distance=o.Z.rangeFinder(c,r),t.distance.distanceSum=Number(t.distance.distanceSum.toFixed(1))}i.push(t)}})),u.t0=AddTargetDialog,u.t1=game.i18n.localize("DIALOG.addTarget"),u.next=8,renderTemplate("systems/dsa5/templates/dialog/addTarget-dialog.html",{selectables:i});case 8:return u.t2=u.sent,u.t3={},u.t4={title:u.t1,content:u.t2,default:"yes",buttons:u.t3},u.abrupt("return",new u.t0(u.t4));case 12:case"end":return u.stop()}}),_callee2)}))),function getDialog(t){return r.apply(this,arguments)})}]),AddTargetDialog}(),c=function(t){_inherits(SelectUserDialog,Dialog);var r,a=_createSuper(SelectUserDialog);function SelectUserDialog(){return _classCallCheck(this,SelectUserDialog),a.apply(this,arguments)}return _createClass(SelectUserDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(SelectUserDialog.prototype),"activateListeners",this).call(this,t),t.find(".combatant").click((function(t){return r.setTargetToUser(t)}))}},{key:"setTargetToUser",value:function setTargetToUser(t){var r=Array.from(game.user.targets).map((function(t){return t.id})),a=t.currentTarget.dataset.userId;game.users.get(a).updateTokenTargets(r),game.socket.emit("userActivity",a,{targets:r}),this.close()}}],[{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(SelectUserDialog),"defaultOptions",this);return mergeObject(t,{classes:t.classes.concat(["dsa5Decent"])}),t}},{key:"getDialog",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(){var t;return _regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return t=game.users.filter((function(t){return t.active&&!t.isGM})),r.t0=SelectUserDialog,r.t1=game.i18n.localize("DIALOG.setTargetToUser"),r.next=5,renderTemplate("systems/dsa5/templates/dialog/selectForUserDialog.html",{users:t});case 5:return r.t2=r.sent,r.t3={},r.t4={title:r.t1,content:r.t2,default:"yes",buttons:r.t3},r.abrupt("return",new r.t0(r.t4));case 9:case"end":return r.stop()}}),_callee3)}))),function getDialog(){return r.apply(this,arguments)})},{key:"registerButtons",value:function registerButtons(){Hooks.on("getSceneControlButtons",(function(t){if(game.user.isGM){var r,a={name:"targetUser",title:game.i18n.localize("CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(){return _regeneratorRuntime().wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,SelectUserDialog.getDialog();case 2:t.sent.render(!0);case 3:case"end":return t.stop()}}),_callee4)}))),function onClick(){return r.apply(this,arguments)})};t[0].tools.splice(2,0,a)}}))}}]),SelectUserDialog}()},70:(t,r,a)=>{a.d(r,{Z:()=>g});var o=a(369),i=a(839),c=a(272),u=a(577),l=a(562),p=a(122),d=a(173),h=a(491),m=a(538),y=a(5);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var g=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(DSA5CombatDialog,t);var r,a=_createSuper(DSA5CombatDialog);function DSA5CombatDialog(){return _classCallCheck(this,DSA5CombatDialog),a.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5CombatDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(DSA5CombatDialog.prototype),"activateListeners",this).call(this,t);var a=t.find(".specAbs");a.mouseenter((function(t){if(0==t.currentTarget.getElementsByClassName("hovermenu").length){var a=document.createElement("div");a.classList.add("hovermenu");var o=document.createElement("i");o.classList.add("fas","fa-comment"),o.title=game.i18n.localize("SHEET.PostItem"),o.addEventListener("mousedown",r._postItem,!1),a.appendChild(o),t.currentTarget.appendChild(a)}})),a.mouseleave((function(t){var a=t.toElement||t.relatedTarget;a.parentNode!=r&&a!=r&&t.currentTarget.querySelectorAll(".hovermenu").forEach((function(t){return t.remove()}))})),t.on("mousedown",".specAbs",(function(a){if(t.find(".opportunityAttack").is(":checked"))ui.notifications.error(game.i18n.localize("DSAError.opposedAttackNoSpecAbs"));else{var o=$(a.currentTarget),i=Number(o.attr("data-step")),c=Number(o.attr("data-maxStep")),u=Number(o.attr("data-category"));if(0==a.button){if(i=Math.min(c,i+1),[0,1].includes(u)&&game.settings.get("dsa5","limitCombatSpecAbs")){var l=o.siblings('[data-category="'.concat(u,'"]'));l.removeClass("active").attr("data-step",0),l.find(".step").text(y.Z.roman[0])}}else 2==a.button&&(i=Math.clamped(c,0,i-1));o.attr("data-step",i),i>0?o.addClass("active"):o.removeClass("active"),o.find(".step").text(y.Z.roman[i]),r.calculateModifier()}})),t.find(".opportunityAttack").change((function(r){if($(r.currentTarget).is(":checked")){var a,o=function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}(t.find(".specAbs"));try{for(o.s();!(a=o.n()).done;){var i=a.value;$(i).removeClass("active").attr("data-step",0).find(".step").text("")}}catch(t){o.e(t)}finally{o.f()}}})),t.on("change","input,select",(function(t){return r.calculateModifier(t)})),t.find(".modifiers option").mousedown((function(t){r.calculateModifier(t)})),t.find(".quantity-click").mousedown((function(t){return r.calculateModifier(t)}));var o=this.readTargets();this.calculateModifier();var i=this;this.checkTargets=setInterval((function(){o=i.compareTargets(t,o)}),500)}},{key:"close",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(){var t,r=arguments;return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},clearInterval(this.checkTargets),a.next=4,_get(_getPrototypeOf(DSA5CombatDialog.prototype),"close",this).call(this,t);case 4:return a.abrupt("return",a.sent);case 5:case"end":return a.stop()}}),_callee,this)}))),function close(){return r.apply(this,arguments)})},{key:"_postItem",value:function _postItem(t){t.stopPropagation();var r=$(t.currentTarget).closest(".specAbs"),a=r.attr("data-actor"),o=r.attr("data-id");return game.actors.get(a).items.get(o).postItem(),!1}},{key:"recallSettings",value:function recallSettings(t,r,a){return _get(_getPrototypeOf(DSA5CombatDialog.prototype),"recallSettings",this).call(this,t,r,a),this.prepareWeapon(),this}},{key:"prepareWeapon",value:function prepareWeapon(){var t,r=this.dialogData.source,a=h.Z.getSpeaker(this.dialogData.speaker);if(a)if(["meleeweapon","rangeweapon"].includes(r.type)){var i=r.system.combatskill.value,c=o.Z._calculateCombatSkillValues(a.items.find((function(t){return"combatskill"==t.type&&t.name==i})).toObject(),a.system);switch(r.type){case"meleeweapon":t=o.Z._prepareMeleeWeapon(r,[c],a);break;case"rangeweapon":t=o.Z._prepareRangeWeapon(r,[],[c],a)}"attack"==this.dialogData.mode?this.dialogData.rollValue=t.attack:"parry"==this.dialogData.mode&&(this.dialogData.rollValue=t.parry)}else"dodge"==r.type?this.dialogData.rollValue=r.system.value:"attack"==this.dialogData.mode?this.dialogData.rollValue=Number(r.system.at.value):"parry"==this.dialogData.mode&&(this.dialogData.rollValue=Number(r.system.pa))}},{key:"prepareFormRecall",value:function prepareFormRecall(t){if(_get(_getPrototypeOf(DSA5CombatDialog.prototype),"prepareFormRecall",this).call(this,t),canvas.scene&&game.settings.get("dsa5","sightAutomationEnabled")){for(var r=canvas.scene?canvas.scene.darkness:0,a=game.settings.get("dsa5","sightOptions").split("|").map((function(t){return Number(t)})),o=0;a[o]<=r;)o+=1;var i=h.Z.getSpeaker(this.dialogData.speaker);if(i){var u=c.Z.vantageStep(i,game.i18n.localize("LocalizedIDs.darksight"))+d.Z.abilityStep(i,game.i18n.localize("LocalizedIDs.sappeurStyle")),l=d.Z.abilityStep(i,game.i18n.localize("LocalizedIDs.blindFighting"));o<4&&o>0&&(u>1?o=0:(o=Math.max(0,o-u),d.Z.hasAbility(i,game.i18n.localize("LocalizedIDs.traditionBoron"))&&(o=Math.max(0,o-1)),o=Math.min(4,o+c.Z.vantageStep(i,game.i18n.localize("LocalizedIDs.nightBlind"))))),o=Math.max(0,o-l)}var p=t.find('[name="vision"] option:nth-child('.concat(o+1,")"));p.length&&(p[0].selected=!0)}}},{key:"calculateModifier",value:function calculateModifier(){if("damage"!=this.dialogData.mode){var t=this.dialogData.source,r="trait"==t.type&&getProperty(t,"system.traitType.value")||"meleeweapon"==t.type,a={source:this.dialogData.source,extra:{options:{}}},o=h.Z.getSpeaker(this.dialogData.speaker);r?DSA5CombatDialog.resolveMeleeDialog(a,{},this.element,o,{},-3,this.dialogData.mode):DSA5CombatDialog.resolveRangeDialog(a,{},this.element,o,{},this.dialogData.mode),this.dialogData.modifier=l.Z._situationalModifiers(a),this.updateRollButton(this.readTargets())}}}],[{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(DSA5CombatDialog),"defaultOptions",this);return mergeObject(t,{width:700,resizable:!0}),t}},{key:"assassinationModifiers",value:function assassinationModifiers(t,r){var a=r.assassinate;if(!a||"-"==a)return[];t.opposingWeaponSize=0;var o=r.advantageousPosition?2:0,i=["short","medium","long"].indexOf(r.weaponsize),c=game.i18n.localize("DIALOG.".concat(a)),u=[{name:c,value:10-o-i}];if("assassinate"==a){var l=["short","medium","long"].indexOf(t.source.system.reach.value);!p.Z.isYieldedTwohanded(t.source)&&t.source.system.worn.wrongGrip&&(l=Math.min(l,1));var d=Math.max(1,new Roll(t.source.system.damage.value.replace(/[DWw]/g,"d")).terms.reduce((function(t,r){return t+(r.faces?r.number:0)}),0))-1,h=[2,0,-2,-4][l]-2*d,m=Math.max(1,5-l-d);u.push({name:c+" ("+game.i18n.localize("CHARAbbrev.damage")+")",damageBonus:h,value:0,step:1},{name:c+" (*)",damageBonus:"*".concat(m),value:0,step:1})}else t.source.effects||(t.source.effects=[]),t.source.effects.push({_id:c,changes:[],disabled:!1,duration:{},icon:"icons/svg/aura.svg",label:c,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:c,custom:!0,auto:null,manual:0,resistRoll:"".concat(game.i18n.localize("LocalizedIDs.selfControl")," -3"),hideOnToken:!1,hidePlayers:!1,customDuration:"",advancedFunction:"1",args0:"unconscious",args1:""}}});return u}},{key:"resolveMeleeDialog",value:function resolveMeleeDialog(t,r,a,o,c,u,l){var p;this._resolveDefault(t,r,a,c);var h=new FormDataExtended(a.find("form")[0]).object;t.opposingWeaponSize=h.weaponsize,t.narrowSpace=h.narrowSpace,t.attackOfOpportunity=this.attackOfOpportunity(t.situationalModifiers,h),(p=t.situationalModifiers).push.apply(p,[i.Z.parseValueType(game.i18n.localize("sight"),h.vision||0),{name:game.i18n.localize("attackFromBehind"),value:h.attackFromBehind?-4:0},{name:game.i18n.localize("MODS.damage"),damageBonus:h.damageModifier,value:0,step:1},{name:game.i18n.format("defenseCount",{malus:u}),value:(Number(h.defenseCount)||0)*u},{name:game.i18n.localize("wrongHand"),value:h.wrongHand?-4:0},{name:game.i18n.localize("advantageousPosition"),value:h.advantageousPosition?2:0}].concat(_toConsumableArray(i.Z.getSpecAbModifiers(a,l)),_toConsumableArray(this.assassinationModifiers(t,h)))),"attack"==l&&t.situationalModifiers.push({name:game.i18n.localize("doubleAttack"),value:h.doubleAttack?-2+d.Z.abilityStep(o,game.i18n.localize("LocalizedIDs.twoWeaponCombat")):0})}},{key:"resolveRangeDialog",value:function resolveRangeDialog(t,r,a,o,c){var l;this._resolveDefault(t,r,a,c);var p=new FormDataExtended(a.find("form")[0]).object;t.rangeModifier=p.distance,(l=t.situationalModifiers).push.apply(l,[{name:game.i18n.localize("target")+" "+a.find('[name="targetMovement"] option:selected').text(),value:Number(p.targetMovement)||0},{name:game.i18n.localize("shooter")+" "+a.find('[name="shooterMovement"] option:selected').text(),value:Number(p.shooterMovement)||0},{name:game.i18n.localize("mount")+" "+a.find('[name="mountedOptions"] option:selected').text(),value:Number(p.mountedOptions)||0},{name:game.i18n.localize("rangeMovementOptions.QUICKCHANGE"),value:p.quickChange?-4:0},{name:game.i18n.localize("MODS.combatTurmoil"),value:p.combatTurmoil?-2:0},{name:game.i18n.localize("aim"),value:Number(p.aim)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:p.damageModifier,value:0,step:1},{name:game.i18n.localize("sight"),value:Number(p.vision||0)}].concat(_toConsumableArray(i.Z.getSpecAbModifiers(a,"attack")),[{name:game.i18n.localize("sizeCategory"),value:u.Z.rangeSizeModifier[p.size]}]))}},{key:"_resolveDefault",value:function _resolveDefault(t,r,a,i){r.rollMode=a.find('[name="rollMode"]').val(),t.situationalModifiers=o.Z._parseModifiers(a),mergeObject(t.extra.options,i)}},{key:"attackOfOpportunity",value:function attackOfOpportunity(t,r){var a=r.opportunityAttack?-4:0;if(a){t.push({name:game.i18n.localize("opportunityAttack"),value:a});var o=game.i18n.localize("LocalizedIDs.enemySense");game.user.targets.forEach((function(r){r.actor&&r.actor.items.find((function(t){return"specialability"==t.type&&t.name==o}))&&t.push({name:o,value:a})}))}return 0!=a}},{key:"getRollButtons",value:function getRollButtons(t,r,a,i){var c,u=m.Z.getRollButtons(t,r,a,i);if("rangeweapon"==t.source.type||"trait"==t.source.type&&"rangeAttack"==t.source.system.traitType.value){var l="trait"==t.source.type?Number(t.source.system.reloadTime.value):o.Z.calcLZ(t.source,t.extra.actor),p=t.source.system.reloadTime.progress;p<l&&mergeObject(u,{reloadButton:{label:"".concat(game.i18n.localize("WEAPON.reload")," (").concat(p,"/").concat(l,")"),callback:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var r,a;return _regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,h.Z.getSpeaker(t.extra.speaker);case 2:return r=o.sent,o.next=5,r.updateEmbeddedDocuments("Item",[{_id:t.source._id,"system.reloadTime.progress":p+1}]);case 5:return a=game.i18n.format("WEAPON.isReloading",{actor:t.extra.actor.name,item:t.source.name,status:"".concat(p+1,"/").concat(l)}),o.next=8,ChatMessage.create(h.Z.chatDataSetup(a));case 8:case"end":return o.stop()}}),_callee2)}))),function callback(){return c.apply(this,arguments)})}})}return u}}]),DSA5CombatDialog}(y.Z)},538:(t,r,a)=>{a.d(r,{Z:()=>m});var o=a(70),i=a(5),c=a(491),u=a(577),l=a(369),p=a(562);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _readOnlyError(t){throw new TypeError('"'+t+'" is read-only')}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var d=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(DSA5SkillDialog,t);var r=_createSuper(DSA5SkillDialog);function DSA5SkillDialog(){return _classCallCheck(this,DSA5SkillDialog),r.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5SkillDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(DSA5SkillDialog.prototype),"activateListeners",this).call(this,t),t.on("change","input,select",(function(t){return r.rememberFormData(t)}));var a=this.readTargets(),o=this;this.checkTargets=setInterval((function(){a=o.compareTargets(t,a)}),500),this.rememberFormData(),t.on("mousedown",".quantity-click",(function(t){return r.rememberFormData(t)})),t.find(".modifiers option").mousedown((function(t){r.rememberFormData(t)}))}},{key:"rememberFormData",value:function rememberFormData(t){var r=new FormDataExtended(this.element.find("form")[0]).object;r.situationalModifiers=l.Z._parseModifiers(this._element),this.calculateRoutine(r)}},{key:"calculateRoutine",value:function calculateRoutine(t){var r=c.Z.getSpeaker(this.dialogData.speaker),a=this.element.find(".routineRoll");if(!r)return a.prop("disabled",!0);for(var o=0;o<3;o++)if(r.system.characteristics[t["characteristics".concat(o)]].max*t["ch".concat(o)].max<13){_readOnlyError("routineAllowed");break}var i=this.dialogData.source.system.talentValue.value+t.fw+p.Z._situationalModifiers(t,"FW"),l=u.Z.skillDifficultyModifiers[t.testDifficulty]+p.Z._situationalModifiers(t),d=i>=Math.clamped(10-3*l,1,19),h=game.i18n.localize("ROLL.routine");a.prop("disabled",!d),a.html(d?"".concat(h," (").concat(game.i18n.localize("CHARAbbrev.FW")," ").concat(Math.round(i/2),")"):h)}}],[{key:"getRollButtons",value:function getRollButtons(t,r,a,o){var i=m.getRollButtons(t,r,a,o);i.rollButton.label=game.i18n.localize("Opposed");var c={nonOpposedButton:{label:game.i18n.localize("Roll"),callback:function callback(o){game.dsa5.memory.remember(t.extra.speaker,t.source,t.mode,o),t.opposable=!1,a(r.callback(o))}},routineRoll:{label:game.i18n.localize("ROLL.routine"),callback:function callback(o){game.dsa5.memory.remember(t.extra.speaker,t.source,t.mode,o),t.routine=!0,mergeObject(t.extra.options,{cheat:!0,predefinedResult:[{val:2,index:0},{val:2,index:1},{val:2,index:2}]}),a(r.callback(o))}}};return mergeObject(c,i),c}},{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(DSA5SkillDialog),"defaultOptions",this);return mergeObject(t,{width:700,resizable:!0}),t}}]),DSA5SkillDialog}(i.Z),h=a(954);function dialog_dsa5_typeof(t){return dialog_dsa5_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dialog_dsa5_typeof(t)}function dialog_dsa5_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function dialog_dsa5_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function dialog_dsa5_get(){return dialog_dsa5_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=dialog_dsa5_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},dialog_dsa5_get.apply(this,arguments)}function dialog_dsa5_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=dialog_dsa5_getPrototypeOf(t)););return t}function dialog_dsa5_setPrototypeOf(t,r){return dialog_dsa5_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},dialog_dsa5_setPrototypeOf(t,r)}function dialog_dsa5_createSuper(t){var r=function dialog_dsa5_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=dialog_dsa5_getPrototypeOf(t);if(r){var i=dialog_dsa5_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return dialog_dsa5_possibleConstructorReturn(this,a)}}function dialog_dsa5_possibleConstructorReturn(t,r){if(r&&("object"===dialog_dsa5_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function dialog_dsa5_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function dialog_dsa5_getPrototypeOf(t){return dialog_dsa5_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},dialog_dsa5_getPrototypeOf(t)}var m=function(t){!function dialog_dsa5_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&dialog_dsa5_setPrototypeOf(t,r)}(DSA5Dialog,t);var r=dialog_dsa5_createSuper(DSA5Dialog);function DSA5Dialog(){return dialog_dsa5_classCallCheck(this,DSA5Dialog),r.apply(this,arguments)}return function dialog_dsa5_createClass(t,r,a){return r&&dialog_dsa5_defineProperties(t.prototype,r),a&&dialog_dsa5_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5Dialog,[{key:"activateListeners",value:function activateListeners(t){dialog_dsa5_get(dialog_dsa5_getPrototypeOf(DSA5Dialog.prototype),"activateListeners",this).call(this,t),t.find(".dieButton").click((function(t){var r=$(t.currentTarget);"true"==r.attr("data-single")&&r.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),r.toggleClass("dieSelected")}))}}],[{key:"getDialogForItem",value:function getDialogForItem(t){switch(t){case"rangeweapon":case"meleeweapon":case"dodge":case"trait":return o.Z;case"spell":case"ritual":case"liturgy":case"ceremony":return h.Z;case"skill":return d}return DSA5Dialog}},{key:"getRollButtons",value:function getRollButtons(t,r,a,o){var i={rollButton:{label:game.i18n.localize("Roll"),callback:function callback(o){game.dsa5.memory.remember(t.extra.speaker,t.source,t.mode,o),a(r.callback(o))}}};return game.user.isGM&&mergeObject(i,{cheat:{label:game.i18n.localize("DIALOG.cheat"),callback:function callback(o){game.dsa5.memory.remember(t.extra.speaker,t.source,t.mode,o),a(r.callback(o,{cheat:!0}))}}}),i}},{key:"defaultOptions",get:function get(){var t=dialog_dsa5_get(dialog_dsa5_getPrototypeOf(DSA5Dialog),"defaultOptions",this);return mergeObject(t,{resizable:!0}),t}}]),DSA5Dialog}(i.Z)},266:(t,r,a)=>{a.d(r,{Z:()=>i});var o=a(702);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var i=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(EquipmentDamageDialog,Dialog);var r,a,i=_createSuper(EquipmentDamageDialog);function EquipmentDamageDialog(){return _classCallCheck(this,EquipmentDamageDialog),i.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(EquipmentDamageDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(EquipmentDamageDialog.prototype),"activateListeners",this).call(this,t),t.find(".reactClick").click((function(t){r.callbackResult(t),r.close()}))}},{key:"callbackResult",value:function callbackResult(t){o.Z.breakingTest(this.items.find((function(r){return r.id==t.currentTarget.dataset.value})))}}],[{key:"showDialog",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r;return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=EquipmentDamageDialog,a.t1=game.i18n.localize("WEAR.checkShort"),a.next=4,this.getTemplate(t);case 4:a.t2=a.sent,a.t3={},a.t4={title:a.t1,content:a.t2,buttons:a.t3},(r=new a.t0(a.t4)).items=t,r.render(!0);case 10:case"end":return a.stop()}}),_callee,this)}))),function showDialog(t){return a.apply(this,arguments)})},{key:"getTemplate",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r;return _regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return r=t.map((function(t){return{name:t.name,id:t.id,img:t.img}})),a.next=3,renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{items:r,title:"WEAR.checkShort"});case 3:return a.abrupt("return",a.sent);case 4:case"end":return a.stop()}}),_callee2)}))),function getTemplate(t){return r.apply(this,arguments)})}]),EquipmentDamageDialog}()},118:(t,r,a)=>{a.d(r,{$G:()=>l,HS:()=>p,MN:()=>d,ZP:()=>u});var o=a(369),i=a(600),c=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var u=function(t){_inherits(DialogReactDSA5,Dialog);var r,a,o=_createSuper(DialogReactDSA5);function DialogReactDSA5(){return _classCallCheck(this,DialogReactDSA5),o.apply(this,arguments)}return _createClass(DialogReactDSA5,null,[{key:"showDialog",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r;return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return r=this.callbackResult,a.t0=DialogReactDSA5,a.t1=game.i18n.localize("Unopposed"),a.next=5,this.getTemplate(t);case 5:a.t2=a.sent,a.t3={ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:function callback(a){r(a.find('[name="entryselection"]').val(),t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},a.t4={title:a.t1,content:a.t2,default:"ok",buttons:a.t3},new a.t0(a.t4).render(!0);case 9:case"end":return a.stop()}}),_callee,this)}))),function showDialog(t){return a.apply(this,arguments)})},{key:"getTargetActor",value:function getTargetActor(t){if(!canvas.tokens)return{};var r=t.flags.unopposeData.targetSpeaker,a=canvas.tokens.get(r.token).actor;return a?{actor:a,tokenId:r.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}},{key:"getTemplate",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){return _regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return","");case 1:case"end":return t.stop()}}),_callee2)}))),function getTemplate(t){return r.apply(this,arguments)})},{key:"callbackResult",value:function callbackResult(t,r,a){}},{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(DialogReactDSA5),"defaultOptions",this);return mergeObject(t,{resizable:!0}),t}}]),DialogReactDSA5}(),l=function(t){_inherits(ReactToSkillDialog,t);var r,a=_createSuper(ReactToSkillDialog);function ReactToSkillDialog(){return _classCallCheck(this,ReactToSkillDialog),a.apply(this,arguments)}return _createClass(ReactToSkillDialog,null,[{key:"getTemplate",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r,a,o,i;return _regeneratorRuntime().wrap((function _callee3$(u){for(;;)switch(u.prev=u.next){case 0:return r=game.messages.get(t.flags.unopposeData.attackMessageId),a=r.flags.data.preData.source,o=a.name,u.next=5,c.Z.allSkillsList();case 5:return(i=u.sent.map((function(t){return{name:t,id:t}}))).unshift({name:game.i18n.localize("doNothing"),id:"doNothing"}),u.abrupt("return",renderTemplate("systems/dsa5/templates/dialog/dialog-act.html",{items:i,original:o,title:"DIALOG.selectReaction"}));case 8:case"end":return u.stop()}}),_callee3)}))),function getTemplate(t){return r.apply(this,arguments)})},{key:"callbackResult",value:function callbackResult(t,r){var a=u.getTargetActor(r),o=a.actor,c=a.tokenId;if("doNothing"==t)i.Z.resolveUndefended(r);else{var l=o.items.find((function(r){return r.name==t&&"skill"==r.type}));l&&o.setupSkill(l,{},c).then((function(t){o.basicTest(t)}))}}}]),ReactToSkillDialog}(u),p=function(t){_inherits(ActAttackDialog,Dialog);var r,a,i=_createSuper(ActAttackDialog);function ActAttackDialog(){return _classCallCheck(this,ActAttackDialog),i.apply(this,arguments)}return _createClass(ActAttackDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(ActAttackDialog.prototype),"activateListeners",this).call(this,t),t.find(".reactClick").click((function(t){r.callbackResult(t.currentTarget.dataset.value,r.actor,r.tokenId),r.close()}))}},{key:"callbackResult",value:function callbackResult(t,r,a){if("attackWeaponless"==t)r.setupWeaponless("attack",{},a).then((function(t){r.basicTest(t)}));else{var o=["meleeweapon","trait","rangeweapon"],i=r.items.find((function(r){return o.includes(r.type)&&r.name==t}));i&&r.setupWeapon(i,"attack",{},a).then((function(t){r.basicTest(t)}))}}}],[{key:"showDialog",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r){var a;return _regeneratorRuntime().wrap((function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:return o.t0=ActAttackDialog,o.t1=game.i18n.localize("attacktest"),o.next=4,this.getTemplate(t);case 4:o.t2=o.sent,o.t3={},o.t4={title:o.t1,content:o.t2,buttons:o.t3},(a=new o.t0(o.t4)).actor=t,a.tokenId=r,a.render(!0);case 11:case"end":return o.stop()}}),_callee4,this)}))),function showDialog(t,r){return a.apply(this,arguments)})},{key:"getTemplate",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t){var r,a,i,c,u,l,p,d,h;return _regeneratorRuntime().wrap((function _callee5$(m){for(;;)switch(m.prev=m.next){case 0:r=t.items.filter((function(t){return"combatskill"==t.type})).map((function(r){return o.Z._calculateCombatSkillValues(r.toObject(),t.system)})),a=r.find((function(t){return t.name==game.i18n.localize("LocalizedIDs.wrestle")})),i=[{name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:a.system.attack.value}],c=["meleeweapon","rangeweapon"],u=["meleeAttack","rangeAttack"],l=_createForOfIteratorHelper(t.items);try{for(l.s();!(p=l.n()).done;)d=p.value,c.includes(d.type)&&1==d.system.worn.value?(h="meleeweapon"==d.type?o.Z._prepareMeleeWeapon(d.toObject(),r,t):o.Z._prepareRangeWeapon(d.toObject(),[],r,t),i.push({name:d.name,id:d.name,img:d.img,value:h.attack})):"trait"==d.type&&u.includes(d.system.traitType.value)&&i.push({name:d.name,id:d.name,img:d.img,value:d.system.at.value})}catch(t){l.e(t)}finally{l.f()}return m.next=9,renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:i,title:"DIALOG.selectAction"});case 9:return m.abrupt("return",m.sent);case 10:case"end":return m.stop()}}),_callee5)}))),function getTemplate(t){return r.apply(this,arguments)})},{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(ActAttackDialog),"defaultOptions",this);return mergeObject(t,{width:550}),t}}]),ActAttackDialog}(),d=function(t){_inherits(ReactToAttackDialog,t);var r,a,c=_createSuper(ReactToAttackDialog);function ReactToAttackDialog(){return _classCallCheck(this,ReactToAttackDialog),c.apply(this,arguments)}return _createClass(ReactToAttackDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(ReactToAttackDialog.prototype),"activateListeners",this).call(this,t),t.find(".reactClick").click((function(t){r.callbackResult(t.currentTarget.dataset.value,r.startMessage),r.close()}))}},{key:"callbackResult",value:function callbackResult(t,r){var a=u.getTargetActor(r),o=a.actor,c=a.tokenId;if("doNothing"==t)i.Z.resolveUndefended(r);else if("dodge"==t)o.setupDodge({},c).then((function(t){o.basicTest(t)}));else if("parryWeaponless"==t)o.setupWeaponless("parry",{},c).then((function(t){o.basicTest(t)}));else{var l=["meleeweapon","trait"],p=o.items.find((function(r){return l.includes(r.type)&&r.name==t}));p&&o.setupWeapon(p,"parry",{},c).then((function(t){o.basicTest(t)}))}}}],[{key:"showDialog",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t){var r;return _regeneratorRuntime().wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=ReactToAttackDialog,a.t1=game.i18n.localize("Unopposed"),a.next=4,this.getTemplate(t);case 4:a.t2=a.sent,a.t3={},a.t4={title:a.t1,content:a.t2,buttons:a.t3},(r=new a.t0(a.t4)).startMessage=t,r.render(!0);case 10:case"end":return a.stop()}}),_callee6,this)}))),function showDialog(t){return a.apply(this,arguments)})},{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(ReactToAttackDialog),"defaultOptions",this);return mergeObject(t,{width:550}),t}},{key:"getTemplate",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){var r,a,i,c,l,p,d,h,m,y,g,v;return _regeneratorRuntime().wrap((function _callee7$(_){for(;;)switch(_.prev=_.next){case 0:if(r=u.getTargetActor(t),a=r.actor,i=r.tokenId,c=a.items.filter((function(t){return"combatskill"==t.type})).map((function(t){return o.Z._calculateCombatSkillValues(t.toObject(),a.system)})),l=c.find((function(t){return t.name==game.i18n.localize("LocalizedIDs.wrestle")})),p=[{name:game.i18n.localize("doNothing"),id:"doNothing",img:"systems/dsa5/icons/categories/disease.webp"},{name:game.i18n.localize("dodge"),id:"dodge",img:"systems/dsa5/icons/categories/Dodge.webp",value:a.system.status.dodge.max},{name:game.i18n.localize("parryWeaponless"),id:"parryWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:l.system.parry.value}],d=0,!a){_.next=13;break}h=["meleeweapon"],m=_createForOfIteratorHelper(a.items);try{for(m.s();!(y=m.n()).done;)g=y.value,h.includes(g.type)&&1==g.system.worn.value?(v=o.Z._prepareMeleeWeapon(g.toObject(),c,a),p.push({name:g.name,id:g.name,img:g.img,value:v.parry})):"trait"==g.type&&Number(g.system.pa)>0&&p.push({name:g.name,id:g.name,img:g.img,value:g.system.pa})}catch(t){m.e(t)}finally{m.f()}if(!game.combat){_.next=13;break}return _.next=12,game.combat.getDefenseCount({actor:a.id,token:i,scene:canvas.scene?canvas.scene.id:null});case 12:d=_.sent;case 13:return _.next=15,renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-in",items:p,defenses:d,title:"DIALOG.selectReaction"});case 15:return _.abrupt("return",_.sent);case 16:case"end":return _.stop()}}),_callee7)}))),function getTemplate(t){return r.apply(this,arguments)})}]),ReactToAttackDialog}(u)},5:(t,r,a)=>{a.d(r,{Z:()=>c});var o=a(122),i=a(416);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var c=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(DialogShared,Dialog);var r,a,c,u,l=_createSuper(DialogShared);function DialogShared(){return _classCallCheck(this,DialogShared),l.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DialogShared,[{key:"recallSettings",value:function recallSettings(t,r,a){return this.recallData=game.dsa5.memory.recall(t,r,a),this.dialogData={mode:a,speaker:t,source:r},this}},{key:"_render",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,_get(_getPrototypeOf(DialogShared.prototype),"_render",this).call(this,t,r);case 2:this.prepareFormRecall($(this._element));case 3:case"end":return a.stop()}}),_callee,this)}))),function _render(t,r){return u.apply(this,arguments)})},{key:"setRollButtonWarning",value:function setRollButtonWarning(){if("attack"==this.dialogData.mode){var t=game.i18n.localize("DIALOG.noTarget");return'<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> '.concat(t,"</span>")}return""}},{key:"setMultipleTargetsWarning",value:function setMultipleTargetsWarning(){if("attack"==this.dialogData.mode){var t=game.i18n.localize("DIALOG.multipleTarget");return'<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> '.concat(t,"</span>")}return""}},{key:"renderRollValueDie",value:function renderRollValueDie(){if(this.dialogData.rollValue&&"damage"!=this.dialogData.mode){var t="attack"==this.dialogData.mode?"die-mu":"die-in",r=this.dialogData.modifier||0;return'<span class="rollValue '.concat(t,' d20">').concat(this.dialogData.rollValue+r,"</span>")}return""}},{key:"updateRollButton",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r;return _regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:r=this.renderRollValueDie()+game.i18n.localize("Roll"),t.length>0?t.length>1&&(r+=this.setMultipleTargetsWarning()):r+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(r);case 3:case"end":return a.stop()}}),_callee2,this)}))),function updateRollButton(t){return c.apply(this,arguments)})},{key:"updateTargets",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r){var a;return _regeneratorRuntime().wrap((function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,renderTemplate("systems/dsa5/templates/dialog/parts/targets.html",{targets:r});case 2:a=o.sent,t.find(".targets").html(a),this.updateRollButton(r);case 5:case"end":return o.stop()}}),_callee3,this)}))),function updateTargets(t,r){return a.apply(this,arguments)})},{key:"removeTarget",value:function removeTarget(t){var r=t.currentTarget.dataset.id;$(t.currentTarget).remove();var a=[];game.user.targets.forEach((function(t){r!=t.id&&a.push(t.id)})),game.user.updateTokenTargets(a)}},{key:"readTargets",value:function readTargets(){var t=[];return game.user.targets.forEach((function(r){r.actor&&t.push({name:r.actor.name,img:r.actor.img,id:r.id})})),t}},{key:"compareTargets",value:function compareTargets(t,r){var a=this.readTargets();return JSON.stringify(r)!=JSON.stringify(a)&&(r=a,this.updateTargets(t,r)),r}},{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(DialogShared.prototype),"activateListeners",this).call(this,t),t.find(".quantity-click").mousedown((function(t){var r=t.currentTarget.dataset.quantityfocus,a=$(t.currentTarget);if(!r||a.is(":focus")){var i={val:Number(a.val())};o.Z.increment(t,i,"val"),a.val(i.val)}else setTimeout((function(){a.select()}))})),t.find(".modifiers option").mousedown((function(t){return t.preventDefault(),$(t.currentTarget).prop("selected",!$(t.currentTarget).prop("selected")),!1})),t.on("click",".rollTarget",(function(t){return r.removeTarget(t)})),t.on("click",".addTarget",(function(t){return r.addTarget(t)}))}},{key:"addTarget",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){return _regeneratorRuntime().wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.x.getDialog(this.dialogData.speaker);case 2:t.sent.render(!0);case 3:case"end":return t.stop()}}),_callee4,this)}))),function addTarget(t){return r.apply(this,arguments)})},{key:"prepareFormRecall",value:function prepareFormRecall(t){var r=this;if(this.recallData)for(var a in this.recallData)if("specAbs"==a){var o,i=_createForOfIteratorHelper(this.recallData[a]);try{for(i.s();!(o=i.n()).done;){var c=o.value,u=t.find('.specAbs[data-id="'.concat(c.id,'"]'));u.addClass("active").attr("data-step",c.step),u.find(".step").text(DialogShared.roman[c.step])}}catch(t){i.e(t)}finally{i.f()}}else{var l=t.find('[name="'.concat(a,'"]'));if(Array.isArray(this.recallData[a])){var p,d=_createForOfIteratorHelper(l.find("option"));try{var h=function _loop(){var t=p.value,o=r.recallData[a].find((function(r){return r.name==$(t).text().trim()}));o&&(t.selected=o.selected)};for(d.s();!(p=d.n()).done;)h()}catch(t){d.e(t)}finally{d.f()}}else"checkbox"==l.attr("type")?l[0].checked=this.recallData[a]:l.val(this.recallData[a])}}}]),DialogShared}();!function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}(c,"roman",[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"])},954:(t,r,a)=>{a.d(r,{Z:()=>u});var o=a(122),i=a(491),c=a(538);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var u=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(DSA5SpellDialog,t);var r,a,u=_createSuper(DSA5SpellDialog);function DSA5SpellDialog(){return _classCallCheck(this,DSA5SpellDialog),u.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5SpellDialog,[{key:"prepareFormRecall",value:function prepareFormRecall(t){_get(_getPrototypeOf(DSA5SpellDialog.prototype),"prepareFormRecall",this).call(this,t),t.find(".spellModifier").trigger("change")}},{key:"applyTransformations",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){var a,o,c,u,l,p,d,h,m,y,g,v,_,b,w;return _regeneratorRuntime().wrap((function _callee$(k){for(;;)switch(k.prev=k.next){case 0:(a=r.find('[name="situationalModifiers"]')).find('option[data-extension="1"]').remove(),o=[],c=_createForOfIteratorHelper(r.find(".specAbs.active")),k.prev=4,c.s();case 6:if((u=c.n()).done){k.next=57;break}if(l=u.value,p=fromUuidSync(l.dataset.uuid)){k.next=11;break}return k.abrupt("continue",55);case 11:d=_createForOfIteratorHelper(p.effects),k.prev=12,d.s();case 14:if((h=d.n()).done){k.next=47;break}m=h.value,y=_createForOfIteratorHelper(m.changes),k.prev=17,y.s();case 19:if((g=y.n()).done){k.next=37;break}if(v=g.value,!DSA5SpellDialog.rollChanges.includes(v.key)){k.next=29;break}_=p.name.split(" - "),b=game.i18n.localize("MODS.".concat(v.key)),_="".concat(_[1]||_[0]),w="".concat(b,": ").concat(v.value,"<br/>").concat(game.i18n.localize("spellextension"),": ").concat(_),o.push('<option data-extension="1" selected="" data-tooltip="'.concat(w,'" data-type="').concat(v.key,'" value="').concat(v.value,'">').concat(_," - ").concat(b,"</option>")),k.next=35;break;case 29:if("macro.transform"!=v.key){k.next=34;break}return k.next=32,i.Z.callItemTransformationMacro(v.value,t,m);case 32:k.next=35;break;case 34:m.apply(t,v);case 35:k.next=19;break;case 37:k.next=42;break;case 39:k.prev=39,k.t0=k.catch(17),y.e(k.t0);case 42:return k.prev=42,y.f(),k.finish(42);case 45:k.next=14;break;case 47:k.next=52;break;case 49:k.prev=49,k.t1=k.catch(12),d.e(k.t1);case 52:return k.prev=52,d.f(),k.finish(52);case 55:k.next=6;break;case 57:k.next=62;break;case 59:k.prev=59,k.t2=k.catch(4),c.e(k.t2);case 62:return k.prev=62,c.f(),k.finish(62);case 65:a.append(o.join(""));case 66:case"end":return k.stop()}}),_callee,null,[[4,59,62,65],[12,49,52,55],[17,39,42,45]])}))),function applyTransformations(t,r){return a.apply(this,arguments)})},{key:"recalcSpellModifiers",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a,i,c,u,l,p,d,h,m,y,g,v,_,b,w;return _regeneratorRuntime().wrap((function _callee2$(k){for(;;)switch(k.prev=k.next){case 0:return a=t,i=duplicate(this.dialogData.source),o.Z.ensureNumber(i),c=a.find(".castingTime"),u=a.find(".aspcost"),l=a.find(".reach"),p=a.find(".maintainCost"),d=a.find(".ritual").length>0,k.next=10,this.applyTransformations(i,a);case 10:if(h=a.find(".maxMods"),!(a.find(".spellModifier:checked").length>Number(h.text()))){k.next=16;break}return r&&(r.currentTarget.checked=!1),h.addClass("emphasize"),setTimeout((function(){h.removeClass("emphasize")}),600),k.abrupt("return");case 16:m=i.system.AsPCost.value,y=i.system.range.value,g=i.system.castingTime.value,v=m,_=i.system.maintainCost.value,a.find(".variableBaseCost")["true"==i.system.variableBaseCost?"show":"hide"](),b=0,a.find(".spellModifier[data-cost]:checked").each((function(t,r){if(v*=r.value<0?.5:2,""!=_&&null!=_){var a=String(_).split(" ");a[0]=Math.max(Number(a[0])*(r.value<0?.5:2)),_=a.join(" ")}b+=Number(r.value)})),v<1?r&&(r.currentTarget.checked=!1):(u.text(v),p.text(_),u.attr("data-mod",b)),b=0,v=g,a.find(".spellModifier[data-castingTime]:checked").each((function(t,r){if(d){var a=DSA5SpellDialog.bigTimes.indexOf(Number(v));if(null!=a){var o=a+(r.value>0?1:-1);o<DSA5SpellDialog.bigTimes.length&&o>=0?v=DSA5SpellDialog.bigTimes[o]:ui.notifications.error(game.i18n.localize("DSAError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("DSAError.TimeCannotBeParsed"))}else v*=r.value>0?2:.5;b+=Number(r.value)})),v<1?r&&(r.currentTarget.checked=!1):(c.text(v),c.attr("data-mod",b)),b=0,w=game.i18n.localize("ReverseSpellRanges."+y),l.text(y),a.find(".spellModifier[data-reach]:checked").each((function(t,a){if("self"==w)a.checked=!1;else if("touch"==w)l.text("4 "+game.i18n.localize("step")),b+=Number(a.value);else{var o=y.split(" ");w=Number(o[0]),isNaN(w)?(r&&(r.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("DSAError.RangeCannotBeParsed"))):(l.text(2*w+" "+game.i18n.localize("step")),b+=Number(a.value))}})),l.attr("data-mod",b),t.find(".reloadButton").prop("disabled",Number(t.find(".castingTime").text())<2);case 35:case"end":return k.stop()}}),_callee2,this)}))),function recalcSpellModifiers(t,a){return r.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(DSA5SpellDialog.prototype),"activateListeners",this).call(this,t),t.find(".reloadButton").prop("disabled",Number(t.find(".castingTime").text())<2),t.find(".specAbs").mousedown((function(a){$(a.currentTarget).toggleClass("active"),r.recalcSpellModifiers(t)})),t.find(".variableBaseCost").change((function(t){var r=$(t.currentTarget).parents(".skill-test"),a=r.find(".aspcost").attr("data-base"),o=$(t.currentTarget).val();r.find(".aspcost").attr("data-base",o),r.find(".aspcost").text(Number(r.find(".aspcost").text())*o/a)})),t.find(".spellModifier").change((function(a){return r.recalcSpellModifiers(t,a)}));var a=this.readTargets();0==a.length&&this.setRollButtonWarning();var o=this;this.checkTargets=setInterval((function(){a=o.compareTargets(t,a)}),500)}}],[{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(DSA5SpellDialog),"defaultOptions",this);return mergeObject(t,{width:700,resizable:!0}),t}},{key:"getRollButtons",value:function getRollButtons(t,r,a,o){var u,l=c.Z.getRollButtons(t,r,a,o);if(["spell","liturgy"].includes(t.source.type)){var p=Number(t.source.system.castingTime.value),d=t.source.system.castingTime.progress,h=t.source.system.castingTime.modified;if(p&&"emptyActor"!=t.extra.speaker.token){var m=h>0?" (".concat(d,"/").concat(h,")"):"";mergeObject(l,{reloadButton:{label:"".concat(game.i18n.localize("SPELL.reload")).concat(m),callback:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(r){var a,o,c;return _regeneratorRuntime().wrap((function _callee3$(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,i.Z.getSpeaker(t.extra.speaker);case 2:return a=u.sent,o={_id:t.source._id,"system.castingTime.progress":d+1},0==h&&(h=Number(r.find(".castingTime").text())-1,o["system.castingTime.modified"]=h),u.next=7,a.updateEmbeddedDocuments("Item",[o]);case 7:return c=game.i18n.format("SPELL.isReloading",{actor:t.extra.actor.name,item:t.source.name,status:"".concat(d+1,"/").concat(h)}),u.next=10,ChatMessage.create(i.Z.chatDataSetup(c));case 10:case"end":return u.stop()}}),_callee3)}))),function callback(t){return u.apply(this,arguments)})}})}}return l}}]),DSA5SpellDialog}(a(5).Z);_defineProperty(u,"rollChanges",["defenseMalus"]),_defineProperty(u,"bigTimes",[5,30,120,480,960,1920])},846:(t,r,a)=>{a.d(r,{q:()=>conditionsMatcher,v:()=>setEnrichers});var o=a(577);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function setEnrichers(){var t,r={Rq:"roll",Gc:"GC",Ch:"CH"},a={Rq:"dice",Gc:"dice",Ch:"user-shield"},i={Rq:"",Gc:"".concat(game.i18n.localize("HELP.groupcheck")," "),Ch:""},c=/(-|\+)?\d+/,u=/\[[a-zA-z&; -]+/,l=/[\[\]]/g;if(!o.Z.statusRegex){var p=o.Z.statusEffects.map((function(t){return game.i18n.localize(t.label).toLowerCase()})),d=["status","condition","level","levels"].map((function(t){return game.i18n.localize(t)})).join("|");o.Z.statusRegex={effects:p,regex:new RegExp("(".concat(d,") (").concat(p.join("|"),")"),"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Gc|Ch)\[[a-zA-z&; -]+ (-|\+)?\d+\]/g,enricher:function enricher(t,o){var p=t[0],d=t[1],h=Number(p.match(c)[0]),m=p.replace(h,"").match(u)[0].replace(l,"").trim();return $('<a class="roll-button request-'.concat(r[d],'" data-type="skill" data-modifier="').concat(h,'" data-name="').concat(m,'"><em class="fas fa-').concat(a[d],'"></em>').concat(i[d]).concat(m," ").concat(h,"</a>"))[0]}},{pattern:o.Z.statusRegex.regex,enricher:function enricher(t,r){return $(conditionsMatcher(t))[0]}},{pattern:/@Info\[[a-zA-z&; -\.0-9]+\]/g,enricher:(t=function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(_regeneratorRuntime().mark((function _callee(t,r){var a,o,i;return _regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return a=t[0].match(/(?<=\[)(.*?)(?=\])/)[0],r.next=3,fromUuid(a);case 3:if((o=r.sent)&&"information"==o.type){r.next=6;break}return r.abrupt("return",$('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0]);case 6:if(game.user.isGM){r.next=8;break}return r.abrupt("return",$('<a class="content-link"><i class="fas fa-mask"></i>'.concat(game.i18n.localize("GM notes"),"</a>"))[0]);case 8:return r.next=10,renderTemplate("systems/dsa5/templates/items/infopreview.html",{item:o});case 10:return i=r.sent,r.abrupt("return",$(i)[0]);case 12:case"end":return r.stop()}}),_callee)}))),function enricher(r,a){return t.apply(this,arguments)})})}function conditionsMatcher(t){var r=t[0].split(" "),a=r.shift();r=r.join(" ");var i=o.Z.statusEffects[o.Z.statusRegex.effects.indexOf(r.toLowerCase())];return"<span>".concat(a,' <a class="chatButton chat-condition" data-id="').concat(i.id,'"><img src="').concat(i.icon,'"/>').concat(r,"</a></span>")}},839:(t,r,a)=>{a.d(r,{Z:()=>w});var o=a(491),i=a(562),c=a(369),u=a(973),l=a(272),p=a(577),d=a(794),h=a(61),m=a(122),y=a(472),g=a(565),v=a(70),_=a(173),b=a(954);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function ownKeys(t,r){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.push.apply(a,o)}return a}function _objectSpread(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(a),!0).forEach((function(r){_defineProperty(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(a,r))}))}return t}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var w=function(t){_inherits(Itemdsa5,Item);var r,a,c,d,h,m,v,b,w,Q=_createSuper(Itemdsa5);function Itemdsa5(){return _classCallCheck(this,Itemdsa5),Q.apply(this,arguments)}return _createClass(Itemdsa5,[{key:"addCondition",value:(w=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:1,a=i.length>2&&void 0!==i[2]&&i[2],o=!(i.length>3&&void 0!==i[3])||i[3],c.next=5,u.Z.addCondition(this,t,r,a,o);case 5:return c.abrupt("return",c.sent);case 6:case"end":return c.stop()}}),_callee,this)}))),function addCondition(t){return w.apply(this,arguments)})},{key:"_dependentEffects",value:(b=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r,a){return _regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),_callee2)}))),function _dependentEffects(t,r,a){return b.apply(this,arguments)})},{key:"removeCondition",value:(v=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r,a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee3$(c){for(;;)switch(c.prev=c.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:1,a=!(i.length>2&&void 0!==i[2])||i[2],o=i.length>3&&void 0!==i[3]&&i[3],c.abrupt("return",u.Z.removeCondition(this,t,r,a,o));case 4:case"end":return c.stop()}}),_callee3,this)}))),function removeCondition(t){return v.apply(this,arguments)})},{key:"hasCondition",value:function hasCondition(t){return u.Z.hasCondition(this,t)}},{key:"setupEffect",value:function setupEffect(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;return Itemdsa5.getSubClass(this.type).setupDialog(t,r,this,a)}},{key:"_setupCardOptions",value:function _setupCardOptions(t,r,a){var o=ChatMessage.getSpeaker();return{speaker:{alias:o.alias,scene:o.scene},flags:{img:o.token?canvas.tokens.get(o.token).document.img:this.img},title:r,template:t}}},{key:"itemTest",value:(m=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){var r,a,o,c,u,l=arguments;return _regeneratorRuntime().wrap((function _callee4$(p){for(;;)switch(p.prev=p.next){case 0:return r=t.testData,a=t.cardOptions,o=l.length>1&&void 0!==l[1]?l[1]:{},p.next=4,i.Z.rollDices(r,a);case 4:return r=p.sent,p.next=7,i.Z.rollTest(r);case 7:return(c=p.sent).postFunction="itemTest",game.user.targets.size&&(a.isOpposedTest=r.opposable,u=" - ".concat(game.i18n.localize("Opposed")),a.isOpposedTest&&a.title.match(u+"$")!=u&&(a.title+=u)),o.suppressMessage||i.Z.renderRollCard(a,c,o.rerenderMessage),p.abrupt("return",{result:c,cardOptions:a});case 12:case"end":return p.stop()}}),_callee4)}))),function itemTest(t){return m.apply(this,arguments)})},{key:"postItem",value:(h=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(){return _regeneratorRuntime().wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:Itemdsa5.getSubClass(this.type)._postItem(this);case 1:case"end":return t.stop()}}),_callee5,this)}))),function postItem(){return h.apply(this,arguments)})}],[{key:"defaultIcon",value:function defaultIcon(t){t.img&&""!=t.img||(t.type in this.defaultImages?t.img=this.defaultImages[t.type]:t.img="systems/dsa5/icons/blank.webp")}},{key:"create",value:(d=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r){return _regeneratorRuntime().wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return this.defaultIcon(t),a.next=3,_get(_getPrototypeOf(Itemdsa5),"create",this).call(this,t,r);case 3:return a.abrupt("return",a.sent);case 4:case"end":return a.stop()}}),_callee6,this)}))),function create(t,r){return d.apply(this,arguments)})},{key:"getSpecAbModifiers",value:function getSpecAbModifiers(t,r){var a,o=[],i=_createForOfIteratorHelper(t.find(".specAbs"));try{for(i.s();!(a=i.n()).done;){var c=a.value,u=Number($(c).attr("data-step"));if(u>0){var l="attack"==r?$(c).attr("data-atbonus"):$(c).attr("data-pabonus"),p=l.split(",").reduce((function(t,r){return t+Number(r)}),0);o.push({name:$(c).find("a").text(),value:isNaN(p)?Number(l.replace("*","")):Number(p)*u,damageBonus:$(c).attr("data-tpbonus"),dmmalus:$(c).attr("data-dmmalus")*u,step:u,specAbId:$(c).attr("data-id"),type:/^\*/.test(l)?"*":void 0})}}}catch(t){i.e(t)}finally{i.f()}return o}},{key:"setupSubClasses",value:function setupSubClasses(){game.dsa5.config.ItemSubclasses={ritual:Z,spell:I,liturgy:R,ceremony:L,advantage:J,disadvantage:J,aggregatedTest:A,trait:K,blessing:D,magictrick:C,specialability:U,disease:z,poison:W,armor:E,rangeweapon:B,meleeweapon:H,ammunition:O,equipment:N,combatskill:G,skill:q,consumable:M,spellextension:V,species:Y,effectwrapper:P,plant:k,magicalsign:x,patron:T,demonmark:S,information:j}}},{key:"buildSpeaker",value:function buildSpeaker(t,r){return{token:r,actor:t?t.id:void 0,scene:canvas.scene?canvas.scene.id:null}}},{key:"parseValueType",value:function parseValueType(t,r){var a="";return/^\*/.test(r)&&(a="*",r=r.substring(1).replace(",",".")),{name:t,value:Number(r),type:a}}},{key:"getMiracleModifiers",value:function getMiracleModifiers(t,r,a,o){var i=new RegExp("".concat(game.i18n.localize("combatskill")," "),"gi"),c=[];if((getProperty(t,"system.happyTalents.value")||"").split(/;|,/).map((function(t){return t.replace(i,"").trim()})).includes(r.name)){var u=t.system.status.karmaenergy.value,l=getProperty(t,"system.miracle.".concat(o))||0;if(u<4)return[];c.push({name:game.i18n.localize("LocalizedIDs.miracle"),value:2+l,type:a,selected:!1});var p=game.i18n.localize("LocalizedIDs.miracleMight");u>=6&&_.Z.hasAbility(t,p)&&c.push({name:p,value:3+l,type:a,selected:!1})}return c}},{key:"getSkZkModifier",value:function getSkZkModifier(t,r){var a=[],o=[],i=["spell","liturgy","ceremony","ritual"].includes(r.type)&&""==r.system.effectFormula.value.trim();game.user.targets.size&&game.user.targets.forEach((function(t){if(t.actor){var r=0;if(i)r=y.Z.detectCreatureType(t.actor).reduce((function(r,a){return r+a.spellResistanceModifier(t.actor)}),0);a.push(-1*t.actor.system.status.soulpower.max-r),o.push(-1*t.actor.system.status.toughness.max-r)}})),mergeObject(t,{SKModifier:a.length>0?Math.min.apply(Math,a):0,ZKModifier:o.length>0?Math.min.apply(Math,o):0})}},{key:"parseEffect",value:function parseEffect(t,r){var a,o={},i=new RegExp(game.i18n.localize("CHARAbbrev.GS"),"gi"),c=_createForOfIteratorHelper(t.split(/,|;/).map((function(t){return t.trim()})));try{for(c.s();!(a=c.n()).done;){var u=a.value.replace(/(\s+)/g," ").trim().split(" ");u[0]=u[0].replace(i,r.system.status.speed.max),2==u.length&&(!isNaN(u[0])||/(=)?[+-]\d([+-]\d)?/.test(u[0])||/(=)?\d[dDwW]\d/.test(u[0])||/=\d+/.test(u[0])||/\*\d(\.\d)*/.test(u[0]))&&(null==o[u[1].toLowerCase()]?o[u[1].toLowerCase()]=[u[0]]:o[u[1].toLowerCase()].push(u[0]))}}catch(t){c.e(t)}finally{c.f()}return o}},{key:"getDefenseMalus",value:function getDefenseMalus(t,r){var a=!1;if(r.flags.oppose){var o=game.messages.get(r.flags.oppose.messageId),i=o.flags.data.preData;a=!("meleeweapon"==getProperty(i,"source.type")||"meleeAttack"==getProperty(i,"source.system.traitType.value"));var c,u=/ \[(-)?\d{1,}\]/,l=_createForOfIteratorHelper(i.situationalModifiers);try{for(l.s();!(c=l.n()).done;){var p=c.value;null!=p.dmmalus&&0!=p.dmmalus?t.push({name:"".concat(game.i18n.localize("MODS.defenseMalus")," - ").concat(p.name.replace(u,"")),value:p.dmmalus,selected:!0}):"defenseMalus"==p.type&&0!=p.value&&t.push({name:p.name.replace(u,""),value:p.value,selected:!0})}}catch(t){l.e(t)}finally{l.f()}o.flags.data.postData.halfDefense&&t.push({name:"".concat(game.i18n.localize("MODS.defenseMalus")," - ").concat(game.i18n.localize("halfDefenseShort")),value:.5,type:"*",selected:!0})}return a}},{key:"changeChars",value:function changeChars(t,r,a,o){t.system.characteristic1.value=r,t.system.characteristic2.value=a,t.system.characteristic3.value=o}},{key:"buildCombatSpecAbs",value:function buildCombatSpecAbs(t,r,a,o){var i;a?(a.push(game.i18n.localize("LocalizedIDs.all")),a=a.map((function(t){return t.toLowerCase()})),i=function searchFilter(t,r){return t.system.list.value.split(/;|,/).map((function(t){return t.trim().toLowerCase()})).filter((function(t){return r.includes(t.replace(/ \([a-zA-Z ]*\)/,""))})).length>0}):i=function searchFilter(){return!0};var c=t.items.filter((function(t){return"specialability"==t.type&&r.includes(t.system.category.value)&&""!=t.system.effect.value&&i(t,a)})),u=[],l=game.i18n.localize("LocalizedAbilityModifiers.at"),d=game.i18n.localize("LocalizedAbilityModifiers.tp"),h=game.i18n.localize("LocalizedAbilityModifiers.pa"),m=game.i18n.localize("LocalizedAbilityModifiers.dm");if("attack"==o){var y,g=_createForOfIteratorHelper(c);try{for(g.s();!(y=g.n()).done;){var v=y.value,_=Itemdsa5.parseEffect(v.system.effect.value,t),b=_[l]||0,w=_[d]||0,k=_[m]||0;if(0!=b||0!=w||0!=k||v.effects.size>0){var x=game.i18n.localize(p.Z.combatSkillSubCategories[v.system.category.sub]);u.push({name:v.name,atbonus:b,tpbonus:w,dmmalus:k,label:"".concat(l,": ").concat(b,", ").concat(d,": ").concat(w,", ").concat(m,": ").concat(k),steps:v.system.step.value,category:{id:v.system.category.sub,css:"ab_".concat(v.system.category.sub),name:x},id:v.id,actor:t.id})}}}catch(t){g.e(t)}finally{g.f()}}else{var S,T=_createForOfIteratorHelper(c);try{for(T.s();!(S=T.n()).done;){var A=S.value,O=Itemdsa5.parseEffect(A.system.effect.value,t)[h]||0;if(0!=O){var P=game.i18n.localize(p.Z.combatSkillSubCategories[A.system.category.sub]);u.push({name:A.name,pabonus:O,tpbonus:0,dmmalus:0,label:"".concat(h,": ").concat(O),steps:A.system.step.value,category:{id:A.system.category.sub,css:"ab_".concat(A.system.category.sub),name:P},id:A.id,actor:t.id})}}}catch(t){T.e(t)}finally{T.f()}}return u}},{key:"getCombatSkillModifier",value:function getCombatSkillModifier(t,r,a){if("trait"!=r.type){var o,i=t.items.find((function(t){return"combatskill"==t.type&&t.name==r.system.combatskill.value})),c=_createForOfIteratorHelper(i.effects);try{for(c.s();!(o=c.n()).done;){var u,l=_createForOfIteratorHelper(o.value.changes);try{for(l.s();!(u=l.n()).done;){var p=u.value;switch(p.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":a.push({name:"".concat(i.name," - ").concat(game.i18n.localize("MODS.defenseMalus")),value:-1*p.value,type:"defenseMalus",selected:!0})}}}catch(t){l.e(t)}finally{l.f()}}}catch(t){c.e(t)}finally{c.f()}}}},{key:"attackStatEffect",value:function attackStatEffect(t,r){0!=r&&t.push({name:game.i18n.localize("statuseffects"),value:r,selected:!0})}},{key:"prepareRangeAttack",value:function prepareRangeAttack(t,r,a,o,i,c){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:void 0;t.push.apply(t,_toConsumableArray(l.Z.getVantageAsModifier(r,game.i18n.localize("LocalizedIDs.restrictedSenseSight"),-2))),this.getCombatSkillModifier(r,o,t);var d="average";game.user.targets.size&&game.user.targets.forEach((function(a){if(a.actor){var i=getProperty(a.actor,"system.status.size");i&&(d=i.value),y.Z.addCreatureTypeModifiers(a.actor,o,t,r)}}));var h=-1*Number(r.system.rangeStats.defenseMalus);0!=h&&t.push({name:"".concat(game.i18n.localize("statuseffects")," - ").concat(game.i18n.localize("MODS.defenseMalus")),value:h,type:"defenseMalus",selected:!0});var m=_objectSpread({},p.Z.rangeWeaponModifiers);delete m[l.Z.hasVantage(r,game.i18n.localize("LocalizedIDs.senseOfRange"))?"long":"rangesense"],_.Z.hasAbility(r,game.i18n.localize("LocalizedIDs.extremeShot"))||delete m.extreme;var v=_.Z.hasAbility(r,game.i18n.localize("LocalizedIDs.drivingArcher")),b=v?duplicate(p.Z.drivingArcherOptions):duplicate(p.Z.mountedRangeOptions);mergeObject(a,{rangeOptions:m,rangeDistance:Object.keys(m)[g.Z.distanceModifier(game.canvas.tokens.get(i),o,u)],sizeOptions:p.Z.rangeSizeCategories,visionOptions:p.Z.rangeVision,mountedOptions:b,shooterMovementOptions:p.Z.shooterMovementOptions,targetMovementOptions:p.Z.targetMomevementOptions,targetSize:d,combatSpecAbs:c,aimOptions:p.Z.aimOptions})}},{key:"prepareMeleeAttack",value:function prepareMeleeAttack(t,r,a,o,i,c){var u="short";game.user.targets.size&&game.user.targets.forEach((function(a){if(a.actor){var i=a.actor.items.filter((function(t){return"meleeweapon"==t.type&&t.system.worn.value||"trait"==t.type&&"meleeAttack"==t.system.traitType.value&&t.system.pa}));i.length>0&&(u=i[0].system.reach.value),y.Z.addCreatureTypeModifiers(a.actor,o,t,r)}})),this.getCombatSkillModifier(r,o,t);var l=-1*Number(r.system.meleeStats.defenseMalus);0!=l&&t.push({name:"".concat(game.i18n.localize("statuseffects")," - ").concat(game.i18n.localize("MODS.defenseMalus")),value:l,type:"defenseMalus",selected:!0}),mergeObject(a,{visionOptions:p.Z.meleeRangeVision(a.mode),weaponSizes:p.Z.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:u,combatSpecAbs:i,constricted:r.hasCondition("constricted"),wrongHandDisabled:c,offHand:!c&&getProperty(o,"system.worn.offHand")})}},{key:"prepareMeleeParry",value:function prepareMeleeParry(t,r,a,o,i,c){var u=Itemdsa5.getDefenseMalus(t,r);mergeObject(a,{visionOptions:p.Z.meleeRangeVision(a.mode),showDefense:!0,isRangeDefense:u,wrongHandDisabled:c&&getProperty(o,"system.worn.offHand"),offHand:!c&&getProperty(o,"system.worn.offHand")&&getProperty(o,"system.combatskill.value")!=game.i18n.localize("LocalizedIDs.Shields"),melee:!0,combatSpecAbs:i,constricted:r.hasCondition("constricted")})}},{key:"_chatLineHelper",value:function _chatLineHelper(t,r){return"<b>".concat(game.i18n.localize(t),"</b>: ").concat(r||"-")}},{key:"setupDialog",value:function setupDialog(t,r,a,o,i){return null}},{key:"checkEquality",value:function checkEquality(t,r){return r.type==t.type&&t.name==r.name&&t.system.description.value==r.system.description.value}},{key:"combineItem",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t,r,a){return _regeneratorRuntime().wrap((function _callee7$(o){for(;;)switch(o.prev=o.next){case 0:return(t=duplicate(t)).system.quantity.value+=r.system.quantity.value,o.next=4,a.updateEmbeddedDocuments("Item",[t]);case 4:return o.abrupt("return",o.sent);case 5:case"end":return o.stop()}}),_callee7)}))),function combineItem(t,r,a){return c.apply(this,arguments)})},{key:"areEquals",value:function areEquals(t,r){return t.type==r.type&&Itemdsa5.getSubClass(t.type).checkEquality(t,r)}},{key:"stackItems",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t,r,a){return _regeneratorRuntime().wrap((function _callee8$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,Itemdsa5.getSubClass(t.type).combineItem(t,r,a);case 2:return o.abrupt("return",o.sent);case 3:case"end":return o.stop()}}),_callee8)}))),function stackItems(t,r,o){return a.apply(this,arguments)})},{key:"chatData",value:function chatData(t,r){return[]}},{key:"getSubClass",value:function getSubClass(t){return game.dsa5.config.ItemSubclasses[t]?game.dsa5.config.ItemSubclasses[t]:Itemdsa5}},{key:"_postItem",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(t){var r,a,i,c,u,l;return _regeneratorRuntime().wrap((function _callee9$(p){for(;;)switch(p.prev=p.next){case 0:return r=duplicate(t),a=Itemdsa5.getSubClass(t.type).chatData(duplicate(r.system),t.name),r.properties=a,r.hasPrice="price"in r.system,r.hasPrice&&(i=r.system.price.value,r.system.QL&&(i*=r.system.QL),r.system.price.D=Math.floor(i/10),i-=10*r.system.price.D,r.system.price.S=Math.floor(i),i-=r.system.price.S,r.system.price.H=Math.floor(i/.1),i-=.1*r.system.price.H,r.system.price.K=Math.round(i/.01),c=["D","S","H","K"].map((function(t){return"".concat(r.system.price[t],' <div data-tooltip="').concat(game.i18n.localize("Money-".concat(t)),'" class="chatmoney money-').concat(t,'"></div>')})).join(","),a.push("<b>".concat(game.i18n.localize("price"),"</b>: ").concat(c))),t.pack&&(r.itemLink=t.link),r.img.includes("/blank.webp")&&(r.img=null),p.next=9,renderTemplate("systems/dsa5/templates/chat/post-item.html",r);case 9:u=p.sent,l=o.Z.chatDataSetup(u),ChatMessage.create(l);case 12:case"end":return p.stop()}}),_callee9)}))),function _postItem(t){return r.apply(this,arguments)})}]),Itemdsa5}();_defineProperty(w,"defaultImages",{advantage:"systems/dsa5/icons/categories/Vorteil.webp",disadvantage:"systems/dsa5/icons/categories/Nachteil.webp",armor:"systems/dsa5/icons/categories/Armor.webp",meleeweapon:"systems/dsa5/icons/categories/Meleeweapon.webp",rangeweapon:"systems/dsa5/icons/categories/Rangeweapon.webp",equipment:"systems/dsa5/icons/categories/Equipment.webp",consumable:"systems/dsa5/icons/categories/consumable.webp",liturgy:"systems/dsa5/icons/categories/Liturgy.webp",spell:"systems/dsa5/icons/categories/Spell.webp",ammunition:"systems/dsa5/icons/categories/Munition.webp",career:"systems/dsa5/icons/categories/Career.webp",magictrick:"systems/dsa5/icons/categories/Spelltrick.webp",blessing:"systems/dsa5/icons/categories/Blessing.webp",combatskill:"systems/dsa5/icons/categories/Combat_Skill.webp",skill:"systems/dsa5/icons/categories/Skill.webp",Geweihte:"systems/dsa5/icons/categories/Geweihte.webp",Weltliche:"systems/dsa5/icons/categories/Weltliche.webp",Zauberer:"systems/dsa5/icons/categories/Zauberer.webp",ritual:"systems/dsa5/icons/categories/ritual.webp",ceremony:"systems/dsa5/icons/categories/ceremony.webp",abilityclerical:"systems/dsa5/icons/categories/ability_clerical.webp",abilityCombat:"systems/dsa5/icons/categories/ability_combat.webp",abilityfatePoints:"systems/dsa5/icons/categories/ability_fate_points.webp",abilitygeneral:"systems/dsa5/icons/categories/ability_general.webp",specialability:"systems/dsa5/icons/categories/ability_general.webp",abilitymagical:"systems/dsa5/icons/categories/ability_magical.webp",abilitylanguage:"systems/dsa5/icons/categories/Ability_Language.webp",abilitystaff:"systems/dsa5/icons/categories/ability_staff.webp",abilityceremonial:"systems/dsa5/icons/categories/ability_ceremonial.webp",abilityanimal:"systems/dsa5/icons/categories/ability_animal.webp",trait:"systems/dsa5/icons/categories/trait.webp",Tiere:"systems/dsa5/icons/categories/Tiere.webp",aggregatedTest:"systems/dsa5/icons/categories/aggregated_test.webp",poison:"systems/dsa5/icons/categories/poison.webp",disease:"systems/dsa5/icons/categories/disease.webp",spellextension:"systems/dsa5/icons/categories/Spellextension.webp",species:"icons/environment/people/group.webp",application:"systems/dsa5/icons/categories/Skill.webp",trick:"systems/dsa5/icons/categories/Tiere.webp",disadvantageanimal:"systems/dsa5/icons/categories/NachteilAnimal.webp",advantageanimal:"systems/dsa5/icons/categories/VorteilAnimal.webp",diseaseanimal:"systems/dsa5/icons/categories/diseaseAnimal.webp",effectwrapper:"icons/svg/aura.svg",liturgyTalisman:"systems/dsa5/icons/categories/LiturgieTalisman.webp",plant:"systems/dsa5/icons/categories/plant.webp",magicalsign:"systems/dsa5/icons/categories/magicalsign.webp",abilitypact:"systems/dsa5/icons/categories/ability_pact.webp",demonmark:"systems/dsa5/icons/categories/ability_pact.webp",patron:"systems/dsa5/icons/categories/ability_pact.webp",information:"systems/dsa5/icons/categories/DSA-Auge.webp"});var k=function(t){_inherits(PlantItemDSA5,t);var r=_createSuper(PlantItemDSA5);function PlantItemDSA5(){return _classCallCheck(this,PlantItemDSA5),r.apply(this,arguments)}return _createClass(PlantItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("effect",t.effect),this._chatLineHelper("PLANT.recipes",t.recipes),this._chatLineHelper("PLANT.usages",t.usages)]}}]),PlantItemDSA5}(w),x=function(t){_inherits(MagicalSignItemDSA5,t);var r=_createSuper(MagicalSignItemDSA5);function MagicalSignItemDSA5(){return _classCallCheck(this,MagicalSignItemDSA5),r.apply(this,arguments)}return _createClass(MagicalSignItemDSA5,null,[{key:"chatData",value:function chatData(t,r){var a=[this._chatLineHelper("AsPCost",t.asp)];return 2==t.category&&a.push(this._chatLineHelper("feature",t.feature)),a}}]),MagicalSignItemDSA5}(w),S=function(t){_inherits(DemonmarkItemDSA5,t);var r=_createSuper(DemonmarkItemDSA5);function DemonmarkItemDSA5(){return _classCallCheck(this,DemonmarkItemDSA5),r.apply(this,arguments)}return _createClass(DemonmarkItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("attributes",t.attribute),this._chatLineHelper("skills",t.skills),this._chatLineHelper("domains",t.domain)]}}]),DemonmarkItemDSA5}(w),T=function(t){_inherits(PatronItemDSA5,t);var r=_createSuper(PatronItemDSA5);function PatronItemDSA5(){return _classCallCheck(this,PatronItemDSA5),r.apply(this,arguments)}return _createClass(PatronItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("skills",t.talents),this._chatLineHelper("culture",t.culture),this._chatLineHelper("Category",game.i18n.localize("PATRON.".concat(t.category)))]}}]),PatronItemDSA5}(w),A=function(t){_inherits(aggregatedTestItemDSA5,t);var r=_createSuper(aggregatedTestItemDSA5);function aggregatedTestItemDSA5(){return _classCallCheck(this,aggregatedTestItemDSA5),r.apply(this,arguments)}return _createClass(aggregatedTestItemDSA5,null,[{key:"chatData",value:function chatData(t,r){var a=game.i18n.localize("Ongoing");return t.cummulatedQS.value>=10?a=game.i18n.localize("Success"):t.cummulatedQS.value>=6?a=game.i18n.localize("PartSuccess"):t.allowedTestCount.value-t.usedTestCount.value<=0&&(a=game.i18n.localize("Failure")),[this._chatLineHelper("cummulatedQS","".concat(t.cummulatedQS.value," / 10")),this._chatLineHelper("interval",t.interval.value),this._chatLineHelper("probes","".concat(t.usedTestCount.value," / ").concat(t.allowedTestCount.value)),this._chatLineHelper("result",a)]}}]),aggregatedTestItemDSA5}(w),O=function(t){_inherits(AmmunitionItemDSA5,t);var r=_createSuper(AmmunitionItemDSA5);function AmmunitionItemDSA5(){return _classCallCheck(this,AmmunitionItemDSA5),r.apply(this,arguments)}return _createClass(AmmunitionItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("ammunitiongroup",game.i18n.localize(t.ammunitiongroup.value))]}}]),AmmunitionItemDSA5}(w),P=function(t){_inherits(EffectWrapperItemDSA5,t);var r=_createSuper(EffectWrapperItemDSA5);function EffectWrapperItemDSA5(){return _classCallCheck(this,EffectWrapperItemDSA5),r.apply(this,arguments)}return _createClass(EffectWrapperItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[]}}]),EffectWrapperItemDSA5}(w),E=function(t){_inherits(ArmorItemDSA5,t);var r=_createSuper(ArmorItemDSA5);function ArmorItemDSA5(){return _classCallCheck(this,ArmorItemDSA5),r.apply(this,arguments)}return _createClass(ArmorItemDSA5,null,[{key:"chatData",value:function chatData(t,r){var a=[this._chatLineHelper("protection",t.protection.value),this._chatLineHelper("encumbrance",t.encumbrance.value)];return""!=t.effect.value&&a.push(this._chatLineHelper("effect",t.effect.value)),a}}]),ArmorItemDSA5}(w),C=function(t){_inherits(CantripItemDSA5,t);var r=_createSuper(CantripItemDSA5);function CantripItemDSA5(){return _classCallCheck(this,CantripItemDSA5),r.apply(this,arguments)}return _createClass(CantripItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("duration",t.duration.value),this._chatLineHelper("targetCategory",t.targetCategory.value),this._chatLineHelper("feature",t.feature.value)]}}]),CantripItemDSA5}(w),D=function(t){_inherits(BlessingItemDSA5,t);var r=_createSuper(BlessingItemDSA5);function BlessingItemDSA5(){return _classCallCheck(this,BlessingItemDSA5),r.apply(this,arguments)}return _createClass(BlessingItemDSA5)}(C),I=function(t){_inherits(SpellItemDSA5,t);var r,a,p=_createSuper(SpellItemDSA5);function SpellItemDSA5(){return _classCallCheck(this,SpellItemDSA5),p.apply(this,arguments)}return _createClass(SpellItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("castingTime",t.castingTime.value),this._chatLineHelper("AsPCost",t.AsPCost.value),this._chatLineHelper("distribution",t.distribution.value),this._chatLineHelper("duration",t.duration.value),this._chatLineHelper("reach",t.range.value),this._chatLineHelper("targetCategory",t.targetCategory.value),this._chatLineHelper("effect",o.Z.replaceConditions(o.Z.replaceDies(t.effect.value)))]}},{key:"getCallbackData",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t,r,a){var o;return _regeneratorRuntime().wrap((function _callee10$(i){for(;;)switch(i.prev=i.next){case 0:return t.testDifficulty=0,t.situationalModifiers=c.Z._parseModifiers(r),o=new FormDataExtended(r.find("form")[0]).object,t.calculatedSpellModifiers={castingTime:r.find(".castingTime").text(),cost:r.find(".aspcost").text(),reach:r.find(".reach").text(),maintainCost:r.find(".maintainCost").text()},t.situationalModifiers.push({name:game.i18n.localize("removeGesture"),value:Number(o.removeGesture)||0},{name:game.i18n.localize("removeFormula"),value:Number(o.removeFormula)||0},{name:game.i18n.localize("castingTime"),value:r.find(".castingTime").data("mod")},{name:game.i18n.localize("cost"),value:r.find(".aspcost").data("mod")},{name:game.i18n.localize("reach"),value:r.find(".reach").data("mod")},{name:game.i18n.localize("zkModifier"),value:o.zkModifier||0},{name:game.i18n.localize("skModifier"),value:o.skModifier||0},{name:game.i18n.localize("maintainedSpells"),value:-1*o.maintainedSpells}),t.extensions=SpellItemDSA5.getSpecAbModifiers(r),t.advancedModifiers={chars:[0,1,2].map((function(t){return o["ch".concat(t)]})),fws:o.fw,qls:o.qs},w.changeChars.apply(w,[t.source].concat(_toConsumableArray([0,1,2].map((function(t){return o["characteristics".concat(t)]}))))),i.next=10,this.applyExtensions(t.source,t.extensions,a);case 10:case"end":return i.stop()}}),_callee10,this)}))),function getCallbackData(t,r,o){return a.apply(this,arguments)})},{key:"applyExtensions",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(t,r,a){var i,c,u,l,p,d,h,y,g,v;return _regeneratorRuntime().wrap((function _callee11$(a){for(;;)switch(a.prev=a.next){case 0:m.Z.ensureNumber(t),i=_createForOfIteratorHelper(r),a.prev=2,i.s();case 4:if((c=i.n()).done){a.next=49;break}if(u=c.value,l=fromUuidSync(u.uuid)){a.next=9;break}return a.abrupt("continue",47);case 9:p=_createForOfIteratorHelper(l.effects),a.prev=10,p.s();case 12:if((d=p.n()).done){a.next=39;break}h=d.value,y=_createForOfIteratorHelper(h.changes),a.prev=15,y.s();case 17:if((g=y.n()).done){a.next=29;break}if(v=g.value,!b.Z.rollChanges.includes(v.key)){a.next=21;break}return a.abrupt("continue",27);case 21:if("macro.transform"!=v.key){a.next=26;break}return a.next=24,o.Z.callItemTransformationMacro(v.value,t,h);case 24:a.next=27;break;case 26:h.apply(t,v);case 27:a.next=17;break;case 29:a.next=34;break;case 31:a.prev=31,a.t0=a.catch(15),y.e(a.t0);case 34:return a.prev=34,y.f(),a.finish(34);case 37:a.next=12;break;case 39:a.next=44;break;case 41:a.prev=41,a.t1=a.catch(10),p.e(a.t1);case 44:return a.prev=44,p.f(),a.finish(44);case 47:a.next=4;break;case 49:a.next=54;break;case 51:a.prev=51,a.t2=a.catch(2),i.e(a.t2);case 54:return a.prev=54,i.f(),a.finish(54);case 57:case"end":return a.stop()}}),_callee11,null,[[2,51,54,57],[10,41,44,47],[15,31,34,37]])}))),function applyExtensions(t,a,o){return r.apply(this,arguments)})},{key:"getSpecAbModifiers",value:function getSpecAbModifiers(t){var r,a=[],o=_createForOfIteratorHelper(t.find(".specAbs.active"));try{for(o.s();!(r=o.n()).done;){var i=r.value;a.push({name:i.dataset.name,title:i.getAttribute("title"),uuid:i.dataset.uuid})}}catch(t){o.e(t)}finally{o.f()}return a}},{key:"attackSpellMalus",value:function attackSpellMalus(t){var r=[];return t.system.effectFormula.value&&r.push({name:game.i18n.localize("MODS.defenseMalus"),value:-4,type:"defenseMalus",selected:!0,source:t.name}),r}},{key:"getPropertyModifiers",value:function getPropertyModifiers(t,r){for(var a=["ceremony","liturgy"].includes(r.type),o=(getProperty(r,"system.feature")||"").replace(/\(a-z \-\)/gi,"").split(",").map((function(t){return t.trim()})),i=[],c=a?"KaPCost":"AsPCost",u=function _loop(){var r=p[l],a="step"==r?"":r,c=getProperty(t.system.skillModifiers,"feature.".concat(r));i.push.apply(i,_toConsumableArray(c.filter((function(t){return o.includes(t.target)})).map((function(t){return{name:t.source,value:t.value,type:a,source:t.source}}))))},l=0,p=["FP","step","QL","TPM","FW",c];l<p.length;l++)u();var d=getProperty(t.system.skillModifiers,"conditional.".concat(c));return i.push.apply(i,_toConsumableArray(d.map((function(t){return{name:t.target,value:t.value,type:c}})))),i}},{key:"foreignSpellModifier",value:function foreignSpellModifier(t,r,a,o){if(game.settings.get("dsa5","enableForeignSpellModifer")&&["npc","character"].includes(t.type)&&["spell","ritual"].includes(r.type)){var i=r.system.distribution.value.split(",").map((function(t){return t.trim().toLowerCase()})),c=new RegExp("(".concat(game.i18n.localize("tradition"),"|\\)|\\()"),"g"),u=t.system.tradition.magical.replace(c,"").split(",").map((function(t){return t.trim().toLowerCase()}));u.push(game.i18n.localize("general").toLowerCase()),o.isForeign=!i.some((function(t){return u.includes(t)})),o.isForeign&&a.push({name:game.i18n.localize("DSASETTINGS.enableForeignSpellModifer"),value:-2,selected:!0})}}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,o){t.push.apply(t,_toConsumableArray(d.Z.getTalentBonus(r,o.name,["advantage","disadvantage","specialability","equipment"])).concat(_toConsumableArray(l.Z.getVantageAsModifier(r,game.i18n.localize("LocalizedIDs.magicalAttunement"),1,!0)),_toConsumableArray(l.Z.getVantageAsModifier(r,game.i18n.localize("LocalizedIDs.magicalRestriction"),-1,!0)),_toConsumableArray(l.Z.getVantageAsModifier(r,game.i18n.localize("LocalizedIDs.boundToArtifact"),-1,!0)),_toConsumableArray(this.getPropertyModifiers(r,o)),_toConsumableArray(this.attackSpellMalus(o)))),this.foreignSpellModifier(r,o,t,a),game.user.targets.size&&game.user.targets.forEach((function(a){a.actor&&y.Z.addCreatureTypeModifiers(a.actor,o,t,r)})),t.push.apply(t,_toConsumableArray(r.getSkillModifier(o.name,o.type)));var i,c=_createForOfIteratorHelper(r.system.skillModifiers.global);try{for(c.s();!(i=c.n()).done;){var u=i.value;t.push({name:u.source,value:u.value})}}catch(t){c.e(t)}finally{c.f()}this.getSkZkModifier(a,o)}},{key:"setupDialog",value:function setupDialog(t,r,a,o,c){var l=this,p="spell";"ceremony"!=a.type&&"liturgy"!=a.type||(p="liturgy");var d=a.name+" "+game.i18n.localize("".concat(a.type,"Test"))+(r.subtitle||""),h={opposable:a.system.effectFormula.value.length>0,source:a,extra:{actor:o.toObject(!1),options:r,speaker:w.buildSpeaker(o,c)},advancedModifiers:{chars:[0,0,0],fws:0,qls:0},calculatedSpellModifiers:{castingTime:0,cost:0,reach:0,maintainCost:0}},m={rollMode:r.rollMode,spellCost:a.system.AsPCost.value,maintainCost:a.system.maintainCost.value,spellCastingTime:a.system.castingTime.value,spellReach:a.system.range.value,canChangeCost:"true"==a.system.canChangeCost.value,canChangeRange:"true"==a.system.canChangeRange.value,canChangeCastingTime:"true"==a.system.canChangeCastingTime.value,hasSKModifier:"SK"==a.system.resistanceModifier.value,hasZKModifier:"ZK"==a.system.resistanceModifier.value,maxMods:Math.floor(Number(a.system.talentValue.value)/4),extensions:this.prepareExtensions(o,a),variableBaseCost:"true"==a.system.variableBaseCost,characteristics:[1,2,3].map((function(t){return a.system["characteristic".concat(t)].value}))},y=o?u.Z.getRollModifiers(o,a):[];this.getSituationalModifiers(y,o,m,a),m.situationalModifiers=y;var g,v={title:d,template:"/systems/dsa5/templates/dialog/".concat(p,"-enhanced-dialog.html"),data:m,callback:(g=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(t){var r,a=arguments;return _regeneratorRuntime().wrap((function _callee12$(i){for(;;)switch(i.prev=i.next){case 0:return r=a.length>1&&void 0!==a[1]?a[1]:{},_.rollMode=t.find('[name="rollMode"]').val(),i.next=4,l.getCallbackData(h,t,o);case 4:return mergeObject(h.extra.options,r),i.abrupt("return",{testData:h,cardOptions:_});case 6:case"end":return i.stop()}}),_callee12)}))),function callback(t){return g.apply(this,arguments)})},_=o._setupCardOptions("systems/dsa5/templates/chat/roll/spell-card.html",d,c);return i.Z.setupDialog({dialogOptions:v,testData:h,cardOptions:_})}},{key:"prepareExtensions",value:function prepareExtensions(t,r){return t.items.filter((function(t){return"spellextension"==t.type&&t.system.source==r.name&&t.system.category==r.type})).map((function(t){return t.shortName=t.name.split(" - ").length>1?t.name.split(" - ")[1]:t.name,t.descr=$(t.system.description.value).text()||"",t}))}}]),SpellItemDSA5}(w),R=function(t){_inherits(LiturgyItemDSA5,t);var r=_createSuper(LiturgyItemDSA5);function LiturgyItemDSA5(){return _classCallCheck(this,LiturgyItemDSA5),r.apply(this,arguments)}return _createClass(LiturgyItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("castingTime",t.castingTime.value),this._chatLineHelper("KaPCost",t.AsPCost.value),this._chatLineHelper("distribution",t.distribution.value),this._chatLineHelper("duration",t.duration.value),this._chatLineHelper("reach",t.range.value),this._chatLineHelper("targetCategory",t.targetCategory.value),this._chatLineHelper("effect",o.Z.replaceConditions(o.Z.replaceDies(t.effect.value)))]}}]),LiturgyItemDSA5}(I),L=function(t){_inherits(CeremonyItemDSA5,t);var r=_createSuper(CeremonyItemDSA5);function CeremonyItemDSA5(){return _classCallCheck(this,CeremonyItemDSA5),r.apply(this,arguments)}return _createClass(CeremonyItemDSA5,null,[{key:"getCallbackData",value:function getCallbackData(t,r,a){_get(_getPrototypeOf(CeremonyItemDSA5),"getCallbackData",this).call(this,t,r,a),t.situationalModifiers.push({name:game.i18n.localize("CEREMONYMODIFIER.artefact"),value:r.find('[name="artefactUsage"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:r.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:r.find('[name="timeModifier"]').val()})}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,o){_get(_getPrototypeOf(CeremonyItemDSA5),"getSituationalModifiers",this).call(this,t,r,a,o),mergeObject(a,{isCeremony:!0,locationModifiers:p.Z.ceremonyLocationModifiers,timeModifiers:p.Z.ceremonyTimeModifiers})}}]),CeremonyItemDSA5}(R),G=function(t){_inherits(CombatskillDSA5,t);var r=_createSuper(CombatskillDSA5);function CombatskillDSA5(){return _classCallCheck(this,CombatskillDSA5),r.apply(this,arguments)}return _createClass(CombatskillDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("Description",game.i18n.localize("Combatskilldescr.".concat(r)))]}},{key:"setupDialog",value:function setupDialog(t,r,a,o,u){var l=r.mode,p=game.i18n.localize(a.name)+" "+game.i18n.localize(l+"test"),d={opposable:!0,source:a,mode:l,extra:{actor:o.toObject(!1),options:r,speaker:w.buildSpeaker(o,u)}},h={title:p,template:"systems/dsa5/templates/dialog/combatskill-dialog.html",data:{rollMode:r.rollMode},callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return m.rollMode=t.find('[name="rollMode"]').val(),d.situationalModifiers=c.Z._parseModifiers(t),mergeObject(d.extra.options,r),{testData:d,cardOptions:m}}},m=o._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",p,u);return i.Z.setupDialog({dialogOptions:h,testData:d,cardOptions:m})}}]),CombatskillDSA5}(w),M=function(t){_inherits(ConsumableItemDSA,t);var r,a,i,c=_createSuper(ConsumableItemDSA);function ConsumableItemDSA(){return _classCallCheck(this,ConsumableItemDSA),c.apply(this,arguments)}return _createClass(ConsumableItemDSA,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("qualityStep",t.QL),this._chatLineHelper("effect",o.Z.replaceDies(t.QLList.split("\n")[t.QL-1])),this._chatLineHelper("charges",t.charges)]}},{key:"checkEquality",value:function checkEquality(t,r){return r.type==t.type&&t.name==r.name&&t.system.description.value==r.system.description.value&&t.system.QL==r.system.QL}},{key:"setupDialog",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee13(t,r,a,i){var c,u,l,p,d;return _regeneratorRuntime().wrap((function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:if(c=game.i18n.format("CHATNOTIFICATION.usesItem",{actor:a.actor.name,item:a.name}),a.isOwned){t.next=3;break}return t.abrupt("return");case 3:if(!((a.system.quantity.value-1)*a.system.maxCharges+a.system.charges<=0)){t.next=7;break}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges")),t.abrupt("return");case 7:if(u=a.system.charges<=1?a.system.maxCharges:a.system.charges-1,l=a.system.charges<=1?a.system.quantity.value-1:a.system.quantity.value,p=o.Z.replaceDies(a.system.QLList.split("\n")[a.system.QL-1],!1),d="<div><b>".concat(c,"</b></div><div>").concat(a.system.description.value,"</div><div><b>").concat(game.i18n.localize("effect"),"</b>: ").concat(p,"</div>"),0!=l){t.next=16;break}return t.next=14,a.actor.deleteEmbeddedDocuments("Item",[a.id]);case 14:t.next=18;break;case 16:return t.next=18,a.update({"system.quantity.value":l,"system.charges":u});case 18:return t.next=20,ChatMessage.create(o.Z.chatDataSetup(d));case 20:return t.next=22,this._applyActiveEffect(a);case 22:case"end":return t.stop()}}),_callee13,this)}))),function setupDialog(t,r,a,o){return i.apply(this,arguments)})},{key:"_applyActiveEffect",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee14(t){var r,a,i,c,u;return _regeneratorRuntime().wrap((function _callee14$(l){for(;;)switch(l.prev=l.next){case 0:if(!((r=t.effects.toObject()).length>0)){l.next=10;break}return l.next=4,h.Z.applyAdvancedFunction(t.actor,r,t,{qualityStep:t.system.QL},t.actor);case 4:a=l.sent,i=a.msg,a.resistRolls,c=a.effectNames,u="".concat(game.i18n.format("ActiveEffects.appliedEffect",{target:t.actor.name,source:c.join(", ")})," ").concat(i||""),ChatMessage.create(o.Z.chatDataSetup(u));case 10:case"end":return l.stop()}}),_callee14)}))),function _applyActiveEffect(t){return a.apply(this,arguments)})},{key:"combineItem",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee15(t,r,a){var o,i,c,u;return _regeneratorRuntime().wrap((function _callee15$(l){for(;;)switch(l.prev=l.next){case 0:return t=duplicate(t),o=(t.system.quantity.value-1)*t.system.maxCharges+t.system.charges,i=(r.system.quantity.value-1)*r.system.maxCharges+r.system.charges,c=Math.floor((o+i)/t.system.maxCharges)+1,0==(u=(o+i)%t.system.maxCharges)&&(c-=1,u=t.system.maxCharges),t.system.quantity.value=c,t.system.charges=u,l.next=10,a.updateEmbeddedDocuments("Item",[t]);case 10:return l.abrupt("return",l.sent);case 11:case"end":return l.stop()}}),_callee15)}))),function combineItem(t,a,o){return r.apply(this,arguments)})}]),ConsumableItemDSA}(w),j=function(t){_inherits(InformationItemDSA5,t);var r,a=_createSuper(InformationItemDSA5);function InformationItemDSA5(){return _classCallCheck(this,InformationItemDSA5),a.apply(this,arguments)}return _createClass(InformationItemDSA5,null,[{key:"_postItem",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee16(t){var r,a;return _regeneratorRuntime().wrap((function _callee16$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,renderTemplate("systems/dsa5/templates/chat/informationRequestRoll.html",{item:t});case 2:r=i.sent,a=o.Z.chatDataSetup(r),ChatMessage.create(a);case 5:case"end":return i.stop()}}),_callee16)}))),function _postItem(t){return r.apply(this,arguments)})}]),InformationItemDSA5}(w),z=function(t){_inherits(DiseaseItemDSA5,t);var r=_createSuper(DiseaseItemDSA5);function DiseaseItemDSA5(){return _classCallCheck(this,DiseaseItemDSA5),r.apply(this,arguments)}return _createClass(DiseaseItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("stepValue",t.step.value),this._chatLineHelper("incubation",t.incubation.value),this._chatLineHelper("damage",o.Z.replaceConditions(o.Z.replaceDies(t.damage.value))),this._chatLineHelper("duration",t.duration.value),this._chatLineHelper("source",o.Z.replaceDies(t.source.value)),this._chatLineHelper("treatment",t.treatment.value),this._chatLineHelper("antidot",t.antidot.value),this._chatLineHelper("resistanceModifier",t.resistance.value)]}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,i){i=o.Z.toObjectIfPossible(i),game.user.targets.size&&game.user.targets.forEach((function(r){r.actor&&t.push.apply(t,_toConsumableArray(l.Z.getVantageAsModifier(r.actor,game.i18n.localize("LocalizedIDs.ResistanttoDisease"),-1,!1,!0)))})),this.getSkZkModifier(a,i),mergeObject(a,{hasSKModifier:"SK"==i.system.resistance.value,hasZKModifier:"ZK"==i.system.resistance.value})}},{key:"setupDialog",value:function setupDialog(t,r,a,o,u){var l=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),p={opposable:!1,source:a,extra:{options:r,speaker:w.buildSpeaker(o,u)}},d={rollMode:r.rollMode},h=[];this.getSituationalModifiers(h,o,d,a),d.situationalModifiers=h,r.manualResistance&&mergeObject(d,r.manualResistance);var m={title:l,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:d,callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return y.rollMode=t.find('[name="rollMode"]').val(),p.situationalModifiers=c.Z._parseModifiers(t),p.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:t.find('[name="zkModifier"]').val()||0},{name:game.i18n.localize("skModifier"),value:t.find('[name="skModifier"]').val()||0}),mergeObject(p.extra.options,r),{testData:p,cardOptions:y}}},y=a._setupCardOptions("systems/dsa5/templates/chat/roll/".concat(a.type,"-card.html"),l,u);return i.Z.setupDialog({dialogOptions:m,testData:p,cardOptions:y})}}]),DiseaseItemDSA5}(w),N=function(t){_inherits(EquipmentItemDSA5,t);var r=_createSuper(EquipmentItemDSA5);function EquipmentItemDSA5(){return _classCallCheck(this,EquipmentItemDSA5),r.apply(this,arguments)}return _createClass(EquipmentItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("equipmentType",game.i18n.localize("Equipment.".concat(t.equipmentType.value)))]}}]),EquipmentItemDSA5}(w),H=function(t){_inherits(MeleeweaponDSA5,t);var r=_createSuper(MeleeweaponDSA5);function MeleeweaponDSA5(){return _classCallCheck(this,MeleeweaponDSA5),r.apply(this,arguments)}return _createClass(MeleeweaponDSA5,null,[{key:"chatData",value:function chatData(t,r){var a=[this._chatLineHelper("damage",t.damage.value),this._chatLineHelper("atmod",t.atmod.value),this._chatLineHelper("pamod",t.pamod.value),this._chatLineHelper("combatskill",t.combatskill.value)];return""!=t.effect.value&&a.push(this._chatLineHelper(o.Z.replaceConditions("effect",t.effect.value))),a}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,i){var c=l.Z.hasVantage(r,game.i18n.localize("LocalizedIDs.ambidextrous")),u=[(i=o.Z.toObjectIfPossible(i)).system.combatskill.value],p=w.buildCombatSpecAbs(r,["Combat"],u,a.mode);"attack"==a.mode?this.prepareMeleeAttack(t,r,a,i,p,c):"parry"==a.mode&&this.prepareMeleeParry(t,r,a,i,p,c),this.attackStatEffect(t,Number(r.system.meleeStats[a.mode])),["attack","parry"].includes(a.mode)&&t.push.apply(t,_toConsumableArray(MeleeweaponDSA5.getMiracleModifiers(r,{name:i.system.combatskill.value},"",a.mode)))}},{key:"setupDialog",value:function setupDialog(t,r,a,o,c){var l=r.mode,p=game.i18n.localize(a.name)+" "+game.i18n.localize(l+"test"),d={opposable:!0,source:a,mode:l,extra:{actor:o.toObject(!1),options:r,speaker:w.buildSpeaker(o,c)}},h=m.Z.multipleDefenseValue(o,"function"==typeof a.toObject?a.toObject():a),y={rollMode:r.rollMode,mode:l,defenseCountString:game.i18n.format("defenseCount",{malus:h})},g=o?u.Z.getRollModifiers(o,a,{mode:l}):[];this.getSituationalModifiers(g,o,y,a),y.situationalModifiers=g;var _={title:p,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:y,callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return v.Z.resolveMeleeDialog(d,b,t,o,r,h,l),Hooks.call("callbackDialogCombatDSA5",d,o,t,a,c),d.isRangeDefense=y.isRangeDefense,{testData:d,cardOptions:b}}},b=o._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",p,c);return i.Z.setupDialog({dialogOptions:_,testData:d,cardOptions:b})}}]),MeleeweaponDSA5}(w),W=function(t){_inherits(PoisonItemDSA5,t);var r=_createSuper(PoisonItemDSA5);function PoisonItemDSA5(){return _classCallCheck(this,PoisonItemDSA5),r.apply(this,arguments)}return _createClass(PoisonItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("stepValue",t.step.value),this._chatLineHelper("poisonType",t.poisonType.value),this._chatLineHelper("start",t.start.value),this._chatLineHelper("duration",t.duration.value),this._chatLineHelper("resistanceModifier",t.resistance.value),this._chatLineHelper("effect",o.Z.replaceConditions(o.Z.replaceDies(t.effect.value)))]}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,i){i=o.Z.toObjectIfPossible(i),game.user.targets.size&&game.user.targets.forEach((function(r){r.actor&&t.push.apply(t,_toConsumableArray(l.Z.getVantageAsModifier(r.actor,game.i18n.localize("LocalizedIDs.poisonResistance"),-1,!1,!0)))})),this.getSkZkModifier(a,i),mergeObject(a,{hasSKModifier:"SK"==i.system.resistance.value,hasZKModifier:"ZK"==i.system.resistance.value})}},{key:"setupDialog",value:function setupDialog(t,r,a,o,u){var l=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),p={opposable:!1,source:a,extra:{options:r,speaker:w.buildSpeaker(o,u)}},d={rollMode:r.rollMode},h=[];this.getSituationalModifiers(h,o,d,a),d.situationalModifiers=h;var m={title:l,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:d,callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return y.rollMode=t.find('[name="rollMode"]').val(),p.situationalModifiers=c.Z._parseModifiers(t),p.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:t.find('[name="zkModifier"]').val()||0}),p.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:t.find('[name="skModifier"]').val()||0}),mergeObject(p.extra.options,r),{testData:p,cardOptions:y}}},y=a._setupCardOptions("systems/dsa5/templates/chat/roll/".concat(a.type,"-card.html"),l,u);return i.Z.setupDialog({dialogOptions:m,testData:p,cardOptions:y})}}]),PoisonItemDSA5}(w),B=function(t){_inherits(RangeweaponItemDSA5,t);var r,a,c=_createSuper(RangeweaponItemDSA5);function RangeweaponItemDSA5(){return _classCallCheck(this,RangeweaponItemDSA5),c.apply(this,arguments)}return _createClass(RangeweaponItemDSA5,null,[{key:"chatData",value:function chatData(t,r){var a=[this._chatLineHelper("damage",t.damage.value),this._chatLineHelper("combatskill",t.combatskill.value),this._chatLineHelper("reach",t.reach.value)];return""!=t.effect.value&&a.push(this._chatLineHelper(o.Z.replaceConditions("effect",t.effect.value))),a}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,i,c){if("attack"==a.mode){var u=o.Z.toObjectIfPossible(i),l=[u.system.combatskill.value],p=w.buildCombatSpecAbs(r,["Combat"],l,a.mode),d=r.items.get(u.system.currentAmmo.value);if(d){d=d.toObject(!1),u.system.effect.attributes=(u.system.effect.attributes||"").split(",").concat((d.system.effect.attributes||"").split(",")).filter((function(t){return""!=t})).join(",");var h=getProperty(d.flags,"dsa5.poison");h&&mergeObject(i.flags,{dsa5:{poison:h}})}if(this.prepareRangeAttack(t,r,a,u,c,p,d),d){if(d.system.atmod&&t.push({name:"".concat(d.name," - ").concat(game.i18n.localize("atmod")),value:d.system.atmod,selected:!0,specAbId:u.system.currentAmmo.value}),d.system.damageMod||d.system.armorMod){var m={name:"".concat(d.name," - ").concat(game.i18n.localize("MODS.damage")),value:d.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:u.system.currentAmmo.value};d.system.armorMod&&(m.armorPen=d.system.armorMod),t.push(m)}d.effects.length&&t.push({name:"".concat(d.name," - ").concat(game.i18n.localize("effect")),value:1,type:game.i18n.localize("effect"),selected:!0,specAbId:u.system.currentAmmo.value})}t.push.apply(t,_toConsumableArray(RangeweaponItemDSA5.getMiracleModifiers(r,{name:u.system.combatskill.value},"",a.mode)))}this.attackStatEffect(t,Number(r.system.rangeStats[a.mode]))}},{key:"checkAmmunitionState",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee17(t,r,a,o){var i,c,u;return _regeneratorRuntime().wrap((function _callee17$(l){for(;;)switch(l.prev=l.next){case 0:return i=!0,"damage"!=o&&("infinite"==(c=t.system).ammunitiongroup.value||("-"==c.ammunitiongroup.value?(r.extra.ammo=duplicate(t),i=r.extra.ammo.system.quantity.value>0):(u=a.items.get(c.currentAmmo.value))?(r.extra.ammo=u.toObject(),i="mag"==c.ammunitiongroup.value?r.extra.ammo.system.quantity.value>1||r.extra.ammo.system.mag.value>0&&r.extra.ammo.system.quantity.value>0:r.extra.ammo.system.quantity.value>0):i=!1),i||"creature"!=a.type||(i=!0)),i||ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),l.abrupt("return",i);case 4:case"end":return l.stop()}}),_callee17)}))),function checkAmmunitionState(t,r,o,i){return a.apply(this,arguments)})},{key:"setupDialog",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee18(t,r,a,o,c){var l,p,d,h,m,y,g;return _regeneratorRuntime().wrap((function _callee18$(t){for(;;)switch(t.prev=t.next){case 0:return l=r.mode,p=game.i18n.localize(a.name)+" "+game.i18n.localize(l+"test"),d={opposable:!0,source:a,mode:l,extra:{actor:o.toObject(!1),options:r,speaker:w.buildSpeaker(o,c)}},t.next=5,this.checkAmmunitionState(a,d,o,l);case 5:if(t.sent){t.next=7;break}return t.abrupt("return");case 7:return h={rollMode:r.rollMode,mode:l},m=o?u.Z.getRollModifiers(o,a,{mode:l}):[],this.getSituationalModifiers(m,o,h,a,c),h.situationalModifiers=m,y={title:p,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:h,callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return v.Z.resolveRangeDialog(d,g,t,o,r),Hooks.call("callbackDialogCombatDSA5",d,o,t,a,c),{testData:d,cardOptions:g}}},g=o._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",p,c),t.abrupt("return",i.Z.setupDialog({dialogOptions:y,testData:d,cardOptions:g}));case 14:case"end":return t.stop()}}),_callee18,this)}))),function setupDialog(t,a,o,i,c){return r.apply(this,arguments)})}]),RangeweaponItemDSA5}(w),Z=function(t){_inherits(RitualItemDSA5,t);var r=_createSuper(RitualItemDSA5);function RitualItemDSA5(){return _classCallCheck(this,RitualItemDSA5),r.apply(this,arguments)}return _createClass(RitualItemDSA5,null,[{key:"getCallbackData",value:function getCallbackData(t,r,a){_get(_getPrototypeOf(RitualItemDSA5),"getCallbackData",this).call(this,t,r,a),t.situationalModifiers.push({name:game.i18n.localize("RITUALMODIFIER.rightClothes"),value:r.find('[name="rightClothes"]').is(":checked")?1:0},{name:game.i18n.localize("RITUALMODIFIER.rightEquipment"),value:r.find('[name="rightEquipment"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:r.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:r.find('[name="timeModifier"]').val()})}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,o){_get(_getPrototypeOf(RitualItemDSA5),"getSituationalModifiers",this).call(this,t,r,a,o),mergeObject(a,{isRitual:!0,locationModifiers:p.Z.ritualLocationModifiers,timeModifiers:p.Z.ritualTimeModifiers})}}]),RitualItemDSA5}(I),q=function(t){_inherits(SkillItemDSA5,t);var r=_createSuper(SkillItemDSA5);function SkillItemDSA5(){return _classCallCheck(this,SkillItemDSA5),r.apply(this,arguments)}return _createClass(SkillItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("Description",game.i18n.localize("SKILLdescr.".concat(r)))]}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,o){t.push.apply(t,_toConsumableArray(d.Z.getTalentBonus(r,o.name,["advantage","disadvantage","specialability","equipment"])).concat(_toConsumableArray(r.getSkillModifier(o.name,o.type)),_toConsumableArray(SkillItemDSA5.getMiracleModifiers(r,o,"FW","skill"))));var i,c=_createForOfIteratorHelper(r.system.skillModifiers.global);try{for(c.s();!(i=c.n()).done;){var u=i.value;t.push({name:u.source,value:u.value})}}catch(t){c.e(t)}finally{c.f()}}},{key:"setupDialog",value:function setupDialog(t,r,a,o,l){var d,h=a.name+" "+game.i18n.localize("Test")+(r.subtitle||""),m={opposable:!0,source:a,extra:{actor:o.toObject(!1),options:r,speaker:w.buildSpeaker(o,l)}},y={rollMode:r.rollMode,difficultyLabels:p.Z.skillDifficultyLabels,modifier:r.modifier||0,characteristics:[1,2,3].map((function(t){return a.system["characteristic".concat(t)].value})),situationalModifiers:o?u.Z.getRollModifiers(o,a):[]};r.situationalModifiers&&(d=y.situationalModifiers).push.apply(d,_toConsumableArray(r.situationalModifiers)),this.getSituationalModifiers(y.situationalModifiers,o,y,a);var g={title:h,template:"/systems/dsa5/templates/dialog/skill-dialog.html",data:y,callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return v.rollMode=t.find('[name="rollMode"]').val(),m.testDifficulty=p.Z.skillDifficultyModifiers[t.find('[name="testDifficulty"]').val()],m.situationalModifiers=c.Z._parseModifiers(t),m.advancedModifiers={chars:[0,1,2].map((function(r){return Number(t.find('[name="ch'.concat(r,'"]')).val())})),fws:Number(t.find('[name="fw"]').val()),qls:Number(t.find('[name="qs"]').val())},w.changeChars.apply(w,[m.source].concat(_toConsumableArray([0,1,2].map((function(r){return t.find('[name="characteristics'.concat(r,'"]')).val()}))))),mergeObject(m.extra.options,r),{testData:m,cardOptions:v}}},v=o._setupCardOptions("systems/dsa5/templates/chat/roll/skill-card.html",h,l);return i.Z.setupDialog({dialogOptions:g,testData:m,cardOptions:v})}}]),SkillItemDSA5}(w),U=function(t){_inherits(SpecialAbilityItemDSA5,t);var r=_createSuper(SpecialAbilityItemDSA5);function SpecialAbilityItemDSA5(){return _classCallCheck(this,SpecialAbilityItemDSA5),r.apply(this,arguments)}return _createClass(SpecialAbilityItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("rule",t.rule.value)]}}]),SpecialAbilityItemDSA5}(w),Y=function(t){_inherits(SpeciesItemDSA5,t);var r=_createSuper(SpeciesItemDSA5);function SpeciesItemDSA5(){return _classCallCheck(this,SpeciesItemDSA5),r.apply(this,arguments)}return _createClass(SpeciesItemDSA5)}(w),V=function(t){_inherits(SpellextensionItemDSA5,t);var r=_createSuper(SpellextensionItemDSA5);function SpellextensionItemDSA5(){return _classCallCheck(this,SpellextensionItemDSA5),r.apply(this,arguments)}return _createClass(SpellextensionItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("source",t.source),this._chatLineHelper("Category",game.i18n.localize(t.category))]}}]),SpellextensionItemDSA5}(w),K=function(t){_inherits(TraitItemDSA5,t);var r=_createSuper(TraitItemDSA5);function TraitItemDSA5(){return _classCallCheck(this,TraitItemDSA5),r.apply(this,arguments)}return _createClass(TraitItemDSA5,null,[{key:"chatData",value:function chatData(t,r){var a=[];switch(t.traitType.value){case"meleeAttack":a=[this._chatLineHelper("attack",t.at.value),this._chatLineHelper("damage",t.damage.value),this._chatLineHelper("reach",t.reach.value)];break;case"rangeAttack":a=[this._chatLineHelper("attack",t.at.value),this._chatLineHelper("damage",t.damage.value),this._chatLineHelper("reach",t.reach.value),this._chatLineHelper("reloadTime",t.reloadTime.value)];break;case"armor":a=[this._chatLineHelper("protection",t.damage.value)];break;case"general":a=[];break;case"familiar":a=[this._chatLineHelper("APValue",t.APValue.value),this._chatLineHelper("AsPCost",t.AsPCost.value),this._chatLineHelper("duration",t.duration.value),this._chatLineHelper("aspect",t.aspect.value)];break;case"trick":a=[this._chatLineHelper("APValue",t.APValue.value)];break;case"entity":a=[this._chatLineHelper("distribution",t.distribution),this._chatLineHelper("CHARAbbrev.QL",t.AsPCost.value)];break;case"summoning":a=[this._chatLineHelper("distribution",t.distribution),this._chatLineHelper("conjuringDifficulty",t.at.value)]}return""!=t.effect.value&&a.push(this._chatLineHelper("effect",t.effect.value)),a}},{key:"getSituationalModifiers",value:function getSituationalModifiers(t,r,a,i,c){var u=(i=o.Z.toObjectIfPossible(i)).system.traitType.value,l=w.buildCombatSpecAbs(r,["Combat","animal"],void 0,a.mode);"attack"==a.mode&&"meleeAttack"==u?this.prepareMeleeAttack(t,r,a,i,l,!1):"attack"==a.mode&&"rangeAttack"==u?this.prepareRangeAttack(t,r,a,i,c,l):"parry"==a.mode&&this.prepareMeleeParry(t,r,a,i,l,!1),this.attackStatEffect(t,Number(r.system["meleeAttack"==u?"meleeStats":"rangeStats"][a.mode]))}},{key:"setupDialog",value:function setupDialog(t,r,a,o,c){var l=r.mode,p=game.i18n.localize(a.name)+" "+game.i18n.localize(l+"test"),d={opposable:!0,source:a,mode:l,extra:{actor:o.toObject(!1),options:r,speaker:w.buildSpeaker(o,c)}},h=m.Z.multipleDefenseValue(o,a.toObject()),y={rollMode:r.rollMode,mode:l,defenseCountString:game.i18n.format("defenseCount",{malus:h})},g=getProperty(a,"system.traitType.value")||getProperty(a.data,"system.traitType.value"),_=o?u.Z.getRollModifiers(o,a,{mode:l}):[];this.getSituationalModifiers(_,o,y,a,c),y.situationalModifiers=_;var b={title:p,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:y,callback:function callback(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"meleeAttack"==g?v.Z.resolveMeleeDialog(d,k,t,o,r,h,l):v.Z.resolveRangeDialog(d,k,t,o,r),d.isRangeDefense=y.isRangeDefense,Hooks.call("callbackDialogCombatDSA5",d,o,t,a,c),{testData:d,cardOptions:k}}},k=o._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",p,c);return i.Z.setupDialog({dialogOptions:b,testData:d,cardOptions:k})}}]),TraitItemDSA5}(w),J=function(t){_inherits(VantageItemDSA5,t);var r=_createSuper(VantageItemDSA5);function VantageItemDSA5(){return _classCallCheck(this,VantageItemDSA5),r.apply(this,arguments)}return _createClass(VantageItemDSA5,null,[{key:"chatData",value:function chatData(t,r){return[this._chatLineHelper("effect",t.effect.value)]}}]),VantageItemDSA5}(w)},61:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DSAActiveEffectConfig});var _system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(577),_system_dice_dsa5_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(562),_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=_isNativeReflectConstruct();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function automatedAnimation(t){_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}function callMacro(t,r,a,o,i){return _callMacro.apply(this,arguments)}function _callMacro(){return _callMacro=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(t,r,a,o,i){var c,u,l,p,d,h,m,y,g,v,_=arguments;return _regeneratorRuntime().wrap((function _callee11$(b){for(;;)switch(b.prev=b.next){case 0:if(c=_.length>5&&void 0!==_[5]?_[5]:{},u={},game.user.can("MACRO_SCRIPT")){b.next=6;break}ui.notifications.warn("You are not allowed to use JavaScript macros."),b.next=49;break;case 6:return l=game.packs.get(t),b.next=9,l.getDocuments({name:r});case 9:if((p=b.sent).length){b.next=31;break}d=_createForOfIteratorHelper(game.packs.filter((function(t){return"Macro"==t.documentName&&/\(internal\)/.test(t.metadata.label)}))),b.prev=12,d.s();case 14:if((h=d.n()).done){b.next=23;break}return m=h.value,b.next=18,m.getDocuments({name:r});case 18:if(!(p=b.sent).length){b.next=21;break}return b.abrupt("break",23);case 21:b.next=14;break;case 23:b.next=28;break;case 25:b.prev=25,b.t0=b.catch(12),d.e(b.t0);case 28:return b.prev=28,d.f(),b.finish(28);case 31:if(!p.length){b.next=48;break}return y="(async () => {".concat(p[0].command,"})()"),g=Function("actor","item","qs","automatedAnimation","args",y),b.prev=34,c.result=u,v=mergeObject({automatedAnimation},this),b.next=39,g.call(v,a,o,i,automatedAnimation,c);case 39:b.next=46;break;case 41:b.prev=41,b.t1=b.catch(34),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(b.t1),u.error=!0;case 46:b.next=49;break;case 48:ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:r}));case 49:return b.abrupt("return",u);case 50:case"end":return b.stop()}}),_callee11,this,[[12,25,28,31],[34,41]])}))),_callMacro.apply(this,arguments)}var DSAActiveEffectConfig=function(_ActiveEffectConfig){_inherits(DSAActiveEffectConfig,_ActiveEffectConfig);var _super=_createSuper(DSAActiveEffectConfig),_parseEffectDuration2,_createResistRollMessage,_applyEffect,_resistEffect,_onSubmit2,_render2,_checkTimesUpInstalled;function DSAActiveEffectConfig(){return _classCallCheck(this,DSAActiveEffectConfig),_super.apply(this,arguments)}return _createClass(DSAActiveEffectConfig,[{key:"checkTimesUpInstalled",value:(_checkTimesUpInstalled=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(){var t;return _regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return!(t=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.moduleEnabled("times-up"))&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("DSAError.shouldTimesUp")),r.abrupt("return",t);case 3:case"end":return r.stop()}}),_callee)}))),function checkTimesUpInstalled(){return _checkTimesUpInstalled.apply(this,arguments)})},{key:"_render",value:(_render2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var t,r,a,o,i,c,u,l,p,d=this,h=arguments;return _regeneratorRuntime().wrap((function _callee2$(m){for(;;)switch(m.prev=m.next){case 0:return t=h.length>0&&void 0!==h[0]&&h[0],r=h.length>1&&void 0!==h[1]?h[1]:{},m.next=4,_get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"_render",this).call(this,t,r);case 4:if(a=-1,o=["none","systemEffect","macro","creature"].map((function(t){return{name:"ActiveEffects.advancedFunctions.".concat(t),index:a+=1}})),i=getProperty(this.object,"parent.type"),(c={hasSpellEffects:["spell","liturgy","ritual","ceremony","consumable","poison","disease","ammunition","meleeweapon","rangeweapon"].includes(i)||["specialability"].includes(i)&&"Combat"==getProperty(this.object,"parent.system.category.value"),hasDamageTransformation:["ammunition"].includes(i)}).hasDamageTransformation&&o.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5}),m.t0=this.getStatusEffects(),m.t1=game.user.isGM,m.t1){m.next=15;break}return m.next=14,game.settings.get("dsa5","playerCanEditSpellMacro");case 14:m.t1=m.sent;case 15:return m.t2=m.t1,u={systemEffects:m.t0,canEditMacros:m.t2},(l=$(this._element)).find(".tabs").append('<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>'.concat(game.i18n.localize("advanced"),"</a>")),m.next=21,renderTemplate("systems/dsa5/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:o,effectConfigs:c,config:u});case 21:p=m.sent,l.find('.tab[data-tab="effects"]').after($(p)),l.find(".advancedSelector").change((function(t){var r=d.object;r.flags.dsa5.advancedFunction=$(t.currentTarget).val(),renderTemplate("systems/dsa5/templates/status/advanced_functions.html",{effect:r,config:u}).then((function(t){l.find(".advancedFunctions").html(t)}))})),this.checkTimesUpInstalled();case 25:case"end":return m.stop()}}),_callee2,this)}))),function _render(){return _render2.apply(this,arguments)})},{key:"_onSubmit",value:(_onSubmit2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r,a,o,i,c,u,l,p=arguments;return _regeneratorRuntime().wrap((function _callee3$(d){for(;;)switch(d.prev=d.next){case 0:return r=p.length>1&&void 0!==p[1]?p[1]:{},a=r.updateData,o=void 0===a?null:a,i=r.preventClose,c=void 0!==i&&i,u=r.preventRender,l=void 0!==u&&u,"Actor"!=getProperty(this.object,"system.document.parent.documentName")&&getProperty(this.object,"system.document.parent.parent")&&ui.notifications.error(game.i18n.localize("DSAError.nestedEffectNotSupported")),d.next=5,_get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"_onSubmit",this).call(this,t,{updateData:o,preventClose:c,preventRender:l});case 5:return d.abrupt("return",d.sent);case 6:case"end":return d.stop()}}),_callee3,this)}))),function _onSubmit(t){return _onSubmit2.apply(this,arguments)})},{key:"getStatusEffects",value:function getStatusEffects(){return duplicate(CONFIG.statusEffects).map((function(t){return{id:t.id,label:game.i18n.localize(t.label)}})).sort((function(t,r){return t.label.localeCompare(r.label)}))}},{key:"getData",value:function getData(t){return _get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"getData",this).call(this,t)}},{key:"dropDownMenu",value:function dropDownMenu(){for(var t=game.i18n.localize("MODS.FW"),r=game.i18n.localize("skill"),a=game.i18n.localize("MODS.FP"),o=game.i18n.localize("stepValue"),i=game.i18n.localize("MODS.QS"),c=game.i18n.localize("MODS.partChecks"),u="".concat(game.i18n.localize("LocalizedIDs.perception")," 1"),l="".concat(game.i18n.localize("LocalizedIDs.wrestle")," 1"),p=game.i18n.localize("closeCombatAttacks"),d=game.i18n.localize("rangeCombatAttacks"),h="".concat(game.i18n.localize("regenerate")," (").concat(game.i18n.localize("CHARAbbrev.CR"),")"),m=game.i18n.localize("AsPCost"),y=game.i18n.localize("KaPCost"),g=game.i18n.localize("regenerate"),v="".concat(game.i18n.localize("Healing")," 1"),_="".concat(game.i18n.localize("Description")," 1"),b="".concat(game.i18n.localize("LocalizedIDs.miracle")),w=[{name:game.i18n.localize("protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:game.i18n.localize("liturgyArmor"),val:"system.liturgyArmor",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("resistanceModifier")," (").concat(game.i18n.localize("condition"),")"),val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("spellArmor"),val:"system.spellArmor",mode:2,ph:"1"},{name:game.i18n.localize("carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:"".concat(p," - ").concat(game.i18n.localize("CHARAbbrev.AT")),val:"system.meleeStats.attack",mode:2,ph:"1"},{name:"".concat(p," - ").concat(game.i18n.localize("CHARAbbrev.PA")),val:"system.meleeStats.parry",mode:2,ph:"1"},{name:"".concat(b," - ").concat(game.i18n.localize("CHARAbbrev.AT")),val:"system.miracle.attack",mode:2,ph:"1"},{name:"".concat(b," - ").concat(game.i18n.localize("CHARAbbrev.PA")),val:"system.miracle.parry",mode:2,ph:"1"},{name:"".concat(p," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:"".concat(p," - ").concat(game.i18n.localize("MODS.defenseMalus")),val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:"".concat(game.i18n.localize("CONJURATION.elemental")," 1")},{name:"".concat(d," - ").concat(game.i18n.localize("CHARAbbrev.AT")),val:"system.rangeStats.attack",mode:2,ph:"1"},{name:"".concat(d," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:"".concat(d," - ").concat(game.i18n.localize("MODS.defenseMalus")),val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("spell")," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.spellStats.damage",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("liturgy")," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.liturgyStats.damage",mode:2,ph:"1"},{name:y,val:"system.kapModifier",mode:2,ph:"1"},{name:m,val:"system.aspModifier",mode:2,ph:"1"},{name:"".concat(r," - ").concat(t),val:"system.skillModifiers.FW",mode:0,ph:u},{name:"".concat(r," - ").concat(a),val:"system.skillModifiers.FP",mode:0,ph:u},{name:"".concat(r," - ").concat(o),val:"system.skillModifiers.step",mode:0,ph:u},{name:"".concat(r," - ").concat(i),val:"system.skillModifiers.QL",mode:0,ph:u},{name:"".concat(r," - ").concat(c),val:"system.skillModifiers.TPM",mode:0,ph:u},{name:"".concat(game.i18n.localize("vulnerability")," - ").concat(game.i18n.localize("combatskill")),val:"system.vulnerabilities.combatskill",mode:0,ph:l},{name:"".concat(r," - ").concat(game.i18n.localize("MODS.global")),val:"system.skillModifiers.global",mode:0,ph:"1"},{name:"".concat(h," - ").concat(game.i18n.localize("wounds")),val:"system.repeatingEffects.startOfRound.wounds",mode:0,ph:"1d6"},{name:"".concat(h," - ").concat(game.i18n.localize("astralenergy")),val:"system.repeatingEffects.startOfRound.astralenergy",mode:0,ph:"1d6"},{name:"".concat(h," - ").concat(game.i18n.localize("karmaenergy")),val:"system.repeatingEffects.startOfRound.karmaenergy",mode:0,ph:"1d6"},{name:"".concat(g," - ").concat(game.i18n.localize("wounds")),val:"system.status.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:"".concat(g," - ").concat(game.i18n.localize("astralenergy")),val:"system.status.regeneration.AsPgearmodifier",mode:2,ph:"1"},{name:"".concat(g," - ").concat(game.i18n.localize("karmaenergy")),val:"system.status.regeneration.KaPgearmodifier",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("feature")," - ").concat(m),val:"data.skillModifiers.feature.AsPCost",mode:0,ph:v},{name:"".concat(game.i18n.localize("advanced")," - ").concat(m),val:"data.skillModifiers.conditional.AsPCost",mode:0,ph:_},{name:"".concat(game.i18n.localize("feature")," - ").concat(y),val:"data.skillModifiers.feature.KaPCost",mode:0,ph:v},{name:"".concat(game.i18n.localize("advanced")," - ").concat(y),val:"data.skillModifiers.conditional.KaPCost",mode:0,ph:_}],k=0,x=["liturgy","ceremony","spell","ritual","skill","feature"];k<x.length;k++){var S=x[k],T="skill"==S?"skillglobal":S,A=game.i18n.localize(T);w.push({name:"".concat(A," - ").concat(t),val:"data.skillModifiers.".concat(S,".FW"),mode:0,ph:u},{name:"".concat(A," - ").concat(a),val:"data.skillModifiers.".concat(S,".FP"),mode:0,ph:u},{name:"".concat(A," - ").concat(o),val:"data.skillModifiers.".concat(S,".step"),mode:0,ph:u},{name:"".concat(A," - ").concat(i),val:"data.skillModifiers.".concat(S,".QL"),mode:0,ph:u},{name:"".concat(A," - ").concat(c),val:"data.skillModifiers.".concat(S,".TPM"),mode:0,ph:u})}for(var O=0,P=["mu","kl","in","ch","ff","ge","ko","kk"];O<P.length;O++){var E=P[O];w.push({name:game.i18n.localize("CHAR.".concat(E.toUpperCase())),val:"data.characteristics.".concat(E,".gearmodifier"),mode:2,ph:"1"})}var C,D=_createForOfIteratorHelper(_system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z.gearModifyableCalculatedAttributes);try{for(D.s();!(C=D.n()).done;){var I=C.value;w.push({name:game.i18n.localize(I),val:"data.status.".concat(I,".gearmodifier"),mode:2,ph:"1"})}}catch(t){D.e(t)}finally{D.f()}var R,L=_createForOfIteratorHelper(w=w.sort((function(t,r){return t.name.localeCompare(r.name)})));try{for(L.s();!(R=L.n()).done;){var G=R.value;G.ph&&null!=G.mode||console.warn(G)}}catch(t){L.e(t)}finally{L.f()}return w=w.map((function(t){return'<option value="'.concat(t.val,'" data-mode="').concat(t.mode,'" data-ph="').concat(t.ph,'">').concat(t.name,"</option>")})).join("\n"),'<select class="selMenu">'.concat(w,"</select>")}},{key:"activateListeners",value:function activateListeners(t){_get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"activateListeners",this).call(this,t);var r=this.dropDownMenu();t.find(".changes-list .effect-change .key").append(r),t.find(".selMenu").change((function(t){var r=$(t.currentTarget);r.siblings("input").val(r.val());var a=r.closest(".effect-change"),o=r.find("option:selected");a.find(".mode select").val(o.attr("data-mode")),a.find(".value input").attr("placeholder",o.attr("data-ph")),r.blur()}))}}],[{key:"defaultOptions",get:function get(){return mergeObject(_get(_getPrototypeOf(DSAActiveEffectConfig),"defaultOptions",this),{resizable:!0})}},{key:"onEffectRemove",value:function(){var _onEffectRemove=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(actor,effect){var onRemoveMacro;return _regeneratorRuntime().wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(onRemoveMacro=getProperty(effect,"flags.dsa5.onRemove"),!onRemoveMacro){_context4.next=8;break}if(game.user.can("MACRO_SCRIPT")){_context4.next=6;break}ui.notifications.warn("You are not allowed to use JavaScript macros."),_context4.next=8;break;case 6:return _context4.next=8,eval("(async () => {".concat(onRemoveMacro,"})()"));case 8:case"end":return _context4.stop()}}),_callee4)})));function onEffectRemove(t,r){return _onEffectRemove.apply(this,arguments)}return onEffectRemove}()},{key:"applyRollTransformation",value:function applyRollTransformation(actor,options,functionID){var msg="",source=options.origin,_iterator3=_createForOfIteratorHelper(source.effects),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var ef=_step3.value;try{Number(getProperty(ef,"flags.dsa5.advancedFunction"))==functionID&&eval(getProperty(ef,"flags.dsa5.args3"))}catch(t){console.warn("Unable to apply advanced effect",t,ef)}}}catch(t){_iterator3.e(t)}finally{_iterator3.f()}return options.origin=source,{msg,options}}},{key:"applyAdvancedFunction",value:function(){var _applyAdvancedFunction=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(actor,effects,source,testData,sourceActor){var skipResistRolls,msg,resistRolls,effectApplied,effectsWithChanges,effectNames,_iterator4,_step4,_loop,_args6=arguments;return _regeneratorRuntime().wrap((function _callee5$(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:skipResistRolls=!(_args6.length>5&&void 0!==_args6[5])||_args6[5],msg="",resistRolls=[],effectApplied=!1,effectsWithChanges=[],effectNames=new Set,_iterator4=_createForOfIteratorHelper(effects),_context6.prev=7,_loop=_regeneratorRuntime().mark((function _loop(){var ef,specStep,customEf,qs,resistRoll,skills,mod,effect,value,creatures;return _regeneratorRuntime().wrap((function _loop$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(ef=_step4.value,ef.origin&&delete ef.origin,specStep=Number(getProperty(ef,"flags.dsa5.specStep"))||0,_context5.prev=3,customEf=Number(getProperty(ef,"flags.dsa5.advancedFunction")),qs=Math.min(testData.qualityStep||0,6),resistRoll=getProperty(ef,"flags.dsa5.resistRoll"),!resistRoll||skipResistRolls){_context5.next=13;break}skills=resistRoll.split(" "),mod="".concat(skills.pop()),resistRolls.push({skill:skills.join(" "),mod:Math.round(Roll.safeEval("".concat(mod).replace(/q(l|s)/i,qs).replace("step",specStep)))||0,effect:ef,target:actor,token:actor.token?actor.token.id:void 0}),_context5.next=37;break;case 13:if(effectApplied=!0,effectNames.has(ef.label)||effectNames.add(ef.label),ef.changes&&ef.changes.length>0&&effectsWithChanges.push(ef),!customEf){_context5.next=37;break}_context5.t0=customEf,_context5.next=1===_context5.t0?20:2===_context5.t0?27:3===_context5.t0?34:37;break;case 20:return effect=duplicate(CONFIG.statusEffects.find((function(t){return t.id==getProperty(ef,"flags.dsa5.args0")}))),value="".concat(getProperty(ef,"flags.dsa5.args1"))||"1",effect.duration=ef.duration,value=/,/.test(value)?Number(value.split(",")[qs-1]):Number(value.replace(game.i18n.localize("CHARAbbrev.QS"),qs)),_context5.next=26,actor.addCondition(effect,value,!1,!1);case 26:return _context5.abrupt("break",37);case 27:if(game.user.can("MACRO_SCRIPT")){_context5.next=31;break}ui.notifications.warn("You are not allowed to use JavaScript macros."),_context5.next=33;break;case 31:return _context5.next=33,eval("(async () => {".concat(getProperty(ef,"flags.dsa5.args3"),"})()"));case 33:return _context5.abrupt("break",37);case 34:return creatures=(getProperty(ef,"flags.dsa5.args4")||"").split(",").map((function(t){return"@Compendium[".concat(t.trim().replace(/(@Compendium\[|\])/),"]")})).join(" "),msg+="<p><b>".concat(game.i18n.localize("ActiveEffects.advancedFunctions.creature"),"</b>:</p><p>").concat(creatures,"</p>"),_context5.abrupt("break",37);case 37:_context5.next=44;break;case 39:_context5.prev=39,_context5.t1=_context5.catch(3),console.warn("Unable to apply advanced effect"),console.warn(_context5.t1),console.warn(ef);case 44:case"end":return _context5.stop()}}),_loop,null,[[3,39]])})),_iterator4.s();case 10:if((_step4=_iterator4.n()).done){_context6.next=14;break}return _context6.delegateYield(_loop(),"t0",12);case 12:_context6.next=10;break;case 14:_context6.next=19;break;case 16:_context6.prev=16,_context6.t1=_context6.catch(7),_iterator4.e(_context6.t1);case 19:return _context6.prev=19,_iterator4.f(),_context6.finish(19);case 22:return _context6.next=24,actor.createEmbeddedDocuments("ActiveEffect",effectsWithChanges.map((function(t){return t.origin=actor.uuid,t})));case 24:return _context6.abrupt("return",{msg,resistRolls,effectApplied,effectNames:Array.from(effectNames)});case 25:case"end":return _context6.stop()}}),_callee5,null,[[7,16,19,22]])})));function applyAdvancedFunction(t,r,a,o,i){return _applyAdvancedFunction.apply(this,arguments)}return applyAdvancedFunction}()},{key:"resistEffect",value:(_resistEffect=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){var r,a,o,i,c=this;return _regeneratorRuntime().wrap((function _callee7$(u){for(;;)switch(u.prev=u.next){case 0:r=t.currentTarget.dataset,a={token:r.token,actor:r.actor,scene:canvas.id},(o=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getSpeaker(a))?(i=o.items.find((function(t){return"skill"==t.type&&t.name==r.skill})),o.setupSkill(i,{modifier:r.mod},r.token).then(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t){return _regeneratorRuntime().wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return t.testData.opposable=!1,i.next=3,o.basicTest(t);case 3:if(!((i.sent.result.qualityStep||0)<=0)){i.next=8;break}return i.next=8,c.applyEffect(r.message,r.mode,[a],{effectIds:[r.effect],skipResistRolls:!0});case 8:case"end":return i.stop()}}),_callee6)})));return function(r){return t.apply(this,arguments)}}())):console.warn("Actor not found for resist roll.");case 4:case"end":return u.stop()}}),_callee7)}))),function resistEffect(t){return _resistEffect.apply(this,arguments)})},{key:"applyEffect",value:(_applyEffect=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t,r,a){var o,i,c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T,A=arguments;return _regeneratorRuntime().wrap((function _callee8$(O){for(;;)switch(O.prev=O.next){case 0:return o=A.length>3&&void 0!==A[3]?A[3]:{},i=game.messages.get(t),c=i.flags.data.preData.source,u=i.flags.data.postData,l=i.speaker,["poison","disease"].includes(c.type)&&(u.qualityStep=u.successLevel>0?2:1),(p=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getSpeaker(l))||(p=game.actors.get(getProperty(i.flags,"data.preData.extra.actor.id"))),d=p,O.next=11,this._parseEffectDuration(c,u,i.flags.data.preData,p);case 11:if(h=O.sent,o.effectIds&&(h=h.filter((function(t){return o.effectIds.includes(t._id)}))),m=[],"self"==r?p&&m.push(p):a?m=a.map((function(t){return _system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getSpeaker(t)})):game.user.targets.size&&game.user.targets.forEach((function(t){t.actor&&m.push(t.actor)})),!game.user.isGM){O.next=48;break}y=_createForOfIteratorHelper(m),O.prev=17,y.s();case 19:if((g=y.n()).done){O.next=38;break}return v=g.value,O.next=23,DSAActiveEffectConfig.applyAdvancedFunction(v,h,c,u,d,o.skipResistRolls||!1);case 23:if(_=O.sent,b=_.msg,w=_.resistRolls,k=_.effectApplied,x=_.effectNames,!k){O.next=33;break}return S=game.i18n.format("ActiveEffects.appliedEffect",{target:v.name,source:x.join(", ")}),T="".concat(S).concat(b||""),O.next=33,ChatMessage.create(_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.chatDataSetup(T));case 33:if(!w.length){O.next=36;break}return O.next=36,this.createResistRollMessage(w,t,r);case 36:O.next=19;break;case 38:O.next=43;break;case 40:O.prev=40,O.t0=O.catch(17),y.e(O.t0);case 43:return O.prev=43,y.f(),O.finish(43);case 46:O.next=49;break;case 48:game.socket.emit("system.dsa5",{type:"addEffect",payload:{mode:r,id:t,actors:m.map((function(t){return{token:t.token?t.token.id:void 0,actor:t.id,scene:canvas.scene.id}}))}});case 49:case"end":return O.stop()}}),_callee8,this,[[17,40,43,46]])}))),function applyEffect(t,r,a){return _applyEffect.apply(this,arguments)})},{key:"createResistRollMessage",value:(_createResistRollMessage=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(t,r,a){var o,i,c,u;return _regeneratorRuntime().wrap((function _callee9$(l){for(;;)switch(l.prev=l.next){case 0:o=_createForOfIteratorHelper(t),l.prev=1,o.s();case 3:if((i=o.n()).done){l.next=12;break}return c=i.value,l.next=7,renderTemplate("systems/dsa5/templates/chat/roll/resist-roll.html",{resist:c,id:r,mode:a});case 7:return u=l.sent,l.next=10,ChatMessage.create(_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.chatDataSetup(u));case 10:l.next=3;break;case 12:l.next=17;break;case 14:l.prev=14,l.t0=l.catch(1),o.e(l.t0);case 17:return l.prev=17,o.f(),l.finish(17);case 20:case"end":return l.stop()}}),_callee9,null,[[1,14,17,20]])}))),function createResistRollMessage(t,r,a){return _createResistRollMessage.apply(this,arguments)})},{key:"_parseEffectDuration",value:(_parseEffectDuration2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t,r,a,o){var i,c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T,A,O,P,E,C,D,I,R,L;return _regeneratorRuntime().wrap((function _callee10$(G){for(;;)switch(G.prev=G.next){case 0:i={},c=_createForOfIteratorHelper(a.situationalModifiers.filter((function(t){return t.specAbId})));try{for(c.s();!(u=c.n()).done;)l=u.value,i[l.specAbId]=l.step}catch(t){c.e(t)}finally{c.f()}p=Object.keys(i),d=o?o.items.filter((function(t){return p.includes(t.id)})):[],h=t.effects?duplicate(t.effects):[],m=_createForOfIteratorHelper(d);try{for(m.s();!(y=m.n()).done;){g=y.value,v=duplicate(g).effects,_=_createForOfIteratorHelper(v);try{for(_.s();!(b=_.n()).done;)w=b.value,setProperty(w,"flags.dsa5.specStep",i[g.id])}catch(t){_.e(t)}finally{_.f()}h.push.apply(h,_toConsumableArray(v))}}catch(t){m.e(t)}finally{m.f()}k=(k=getProperty(t,"system.duration.value")||"").replace(" x "," * ").replace(game.i18n.localize("CHARAbbrev.QS"),r.qualityStep),G.prev=10,x=[{regEx:new RegExp(game.i18n.localize("DSAREGEX.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEX.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEX.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEX.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.years"),"gi"),seconds:3024e4}],S=0,T=x;case 13:if(!(S<T.length)){G.next=25;break}if(!(A=T[S]).regEx.test(k)){G.next=22;break}return O=k.replace(A.regEx,"").trim(),G.next=19,_system_dice_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z._stringToRoll(O);case 19:if(P=G.sent,!isNaN(P)){E=_createForOfIteratorHelper(h);try{for(E.s();!(C=E.n()).done;)D=C.value,I=P*A.seconds,(R=getProperty(D,"flags.dsa5.customDuration"))&&(L=R.split(",")[r.qualityStep-1])&&"-"!=L&&(I=Number(L)),D.duration.seconds=I,D.duration.rounds=D.duration.seconds/5}catch(t){E.e(t)}finally{E.f()}}return G.abrupt("break",25);case 22:S++,G.next=13;break;case 25:G.next=30;break;case 27:G.prev=27,G.t0=G.catch(10),console.error("Could not parse duration '".concat(k,"' of '").concat(t.name,"'"));case 30:return G.abrupt("return",h);case 31:case"end":return G.stop()}}),_callee10,null,[[10,27]])}))),function _parseEffectDuration(t,r,a,o){return _parseEffectDuration2.apply(this,arguments)})}]),DSAActiveEffectConfig}(ActiveEffectConfig)},973:(t,r,a)=>{a.d(r,{Z:()=>i});var o=a(577);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}var i=function(){function DSA5StatusEffects(){_classCallCheck(this,DSA5StatusEffects)}var t,r,a,o,i;return _createClass(DSA5StatusEffects,null,[{key:"bindButtons",value:function bindButtons(t){t.find(".chat-condition").each((function(t,r){r.setAttribute("draggable",!0),r.addEventListener("dragstart",(function(t){var r={data:{type:"condition",payload:{id:$(t.currentTarget).attr("data-id")}}};t.dataTransfer.setData("text/plain",JSON.stringify(r))}))}))}},{key:"createCustomEffect",value:function createCustomEffect(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2?arguments[2]:void 0;a=a||game.i18n.localize("CONDITION.custom"),""==r&&(r=a),t.addCondition({label:a,icon:"icons/svg/aura.svg",origin:t.uuid,flags:{dsa5:{value:null,editable:!0,description:r,custom:!0}}})}},{key:"prepareActiveEffects",value:function prepareActiveEffects(t,r){var a=duplicate(CONFIG.statusEffects),o=[];r.conditions=[],r.transferedConditions=[];var i,c=_createForOfIteratorHelper(t.effects.filter((function(r){return game.user.isGM||"Item"==t.documentName||!r.getFlag("dsa5","hidePlayers")})));try{for(c.s();!(i=c.n()).done;){var u=i.value;u.disabled=u.disabled,u.boolean=null==u.getFlag("dsa5","value"),u.label=u.label,u.icon=u.icon;var l=u.getFlag("core","statusId");l&&(u.value=u.getFlag("dsa5","value"),u.editable=u.getFlag("dsa5","editable"),u.descriptor=l,u.manual=u.getFlag("dsa5","manual"),o.push(l)),u.origin!=t.uuid&&u.origin||u.notApplicable?u.notApplicable||r.transferedConditions.push(u):r.conditions.push(u)}}catch(t){c.e(t)}finally{c.f()}r.manualConditions=a.filter((function(t){return!o.includes(t.id)}))}},{key:"addCondition",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){var a,o,i,c,u=arguments;return _regeneratorRuntime().wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:if(a=u.length>2&&void 0!==u[2]?u[2]:1,o=u.length>3&&void 0!==u[3]&&u[3],i=!(u.length>4&&void 0!==u[4])||u[4],t.isOwner){l.next=5;break}return l.abrupt("return","Not owned");case 5:if(!t.compendium){l.next=7;break}return l.abrupt("return","Can not add in compendium");case 7:if(!(o&&a<=0)){l.next=9;break}return l.abrupt("return",this.removeCondition(t,r,a,i,o));case 9:if("string"==typeof r&&(r=duplicate(CONFIG.statusEffects.find((function(t){return t.id==r})))),r){l.next=12;break}return l.abrupt("return","No Effect Found");case 12:if(!(c=this.hasCondition(t,r.id))||null!=c.flags.dsa5.value){l.next=17;break}return l.abrupt("return",c);case 17:if(!c){l.next=21;break}return l.next=20,DSA5StatusEffects.updateEffect(t,c,a,o,i,r);case 20:case 23:return l.abrupt("return",l.sent);case 21:return l.next=23,DSA5StatusEffects.createEffect(t,r,a,i);case 24:case"end":return l.stop()}}),_callee,this)}))),function addCondition(t,r){return i.apply(this,arguments)})},{key:"hasCondition",value:function hasCondition(t,r){return!(null==t||!r)&&(!!t.effects&&t.effects.find((function(t){return getProperty(t,"flags.core.statusId")==r})))}},{key:"removeCondition",value:(o=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a,o,i,c,u,l=arguments;return _regeneratorRuntime().wrap((function _callee2$(p){for(;;)switch(p.prev=p.next){case 0:if(a=l.length>2&&void 0!==l[2]?l[2]:1,o=!(l.length>3&&void 0!==l[3])||l[3],i=l.length>4&&void 0!==l[4]&&l[4],t.isOwner){p.next=5;break}return p.abrupt("return","Not owned");case 5:if("string"==typeof r&&(r=duplicate(CONFIG.statusEffects.find((function(t){return t.id==r})))),r){p.next=8;break}return p.abrupt("return","No Effect Found");case 8:if(!(c=this.hasCondition(t,r.id))||null!=c.flags.dsa5.value){p.next=17;break}return t.token&&(t=t.token.actor),p.next=13,t.deleteEmbeddedDocuments("ActiveEffect",[c.id]);case 13:return u=p.sent,p.abrupt("return",u);case 17:if(!c){p.next=21;break}return p.next=20,DSA5StatusEffects.removeEffect(t,c,a,i,o);case 20:return p.abrupt("return",p.sent);case 21:case"end":return p.stop()}}),_callee2,this)}))),function removeCondition(t,r){return o.apply(this,arguments)})},{key:"immuneToEffect",value:function immuneToEffect(t,r){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=getProperty(t,"system.immunities")||[];if(o.includes(r.id)){var i=game.i18n.format("DSAError.immuneTo",{name:t.name,condition:game.i18n.localize("CONDITION.".concat(r.id))});return ui.notifications&&!a&&ui.notifications.warn(i),i}return!1}},{key:"resistantToEffect",value:function resistantToEffect(t,r){var a=getProperty(r,"flags.core.statusId");return a?(getProperty(t,"system.resistances.effects")||[]).reduce((function(t,r){return r.target==a&&(t+=Number(r.value)),t}),0):0}},{key:"createEffect",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a,o){var i,c;return _regeneratorRuntime().wrap((function _callee3$(u){for(;;)switch(u.prev=u.next){case 0:if(!(i=this.immuneToEffect(t,r))){u.next=3;break}return u.abrupt("return",i);case 3:return r.label=game.i18n.localize(r.label),o?(r.flags.dsa5.auto=Math.min(r.flags.dsa5.max,a),r.flags.dsa5.manual=0):(r.flags.dsa5.manual=Math.min(r.flags.dsa5.max,a),r.flags.dsa5.auto=0),r.flags.dsa5.value=Math.min(4,r.flags.dsa5.manual+r.flags.dsa5.auto),r["flags.core.statusId"]=r.id,"dead"==r.id&&(r["flags.core.overlay"]=!0),u.next=10,t.createEmbeddedDocuments("ActiveEffect",[duplicate(r)]);case 10:return c=u.sent,u.next=13,t._dependentEffects(r.id,r,1);case 13:return delete r.id,u.abrupt("return",c);case 15:case"end":return u.stop()}}),_callee3,this)}))),function createEffect(t,r,o,i){return a.apply(this,arguments)})},{key:"removeEffect",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r,a,o,i){var c,u,l;return _regeneratorRuntime().wrap((function _callee4$(p){for(;;)switch(p.prev=p.next){case 0:if(c=i?o?a:Math.max(0,r.flags.dsa5.auto-a):r.flags.dsa5.auto,u=i?r.flags.dsa5.manual:o?a:r.flags.dsa5.manual-a,!((l={flags:{dsa5:{auto:c,manual:u,value:Math.max(0,Math.min(r.flags.dsa5.max,u+c))}}}).flags.dsa5.auto<=0&&0==l.flags.dsa5.manual)){p.next=9;break}return p.next=6,t.deleteEmbeddedDocuments("ActiveEffect",[r.id]);case 6:case 11:return p.abrupt("return",p.sent);case 9:return p.next=11,r.update(l);case 12:case"end":return p.stop()}}),_callee4)}))),function removeEffect(t,a,o,i,c){return r.apply(this,arguments)})},{key:"updateEffect",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t,r,a,o,i){var c,u,l,p,d,h=arguments;return _regeneratorRuntime().wrap((function _callee5$(m){for(;;)switch(m.prev=m.next){case 0:if(c=h.length>5&&void 0!==h[5]?h[5]:void 0,!(u=this.immuneToEffect(t,r,!0))){m.next=4;break}return m.abrupt("return",u);case 4:if(i?(p=Math.min(r.flags.dsa5.max,o?a:r.flags.dsa5.auto+a),l=p-r.flags.dsa5.auto,d={flags:{dsa5:{auto:p,manual:r.flags.dsa5.manual}}}):(p=o?a:r.flags.dsa5.manual+a,l=p-r.flags.dsa5.manual,d={flags:{dsa5:{manual:p,auto:r.flags.dsa5.auto}}}),0!=l){m.next=7;break}return m.abrupt("return",r);case 7:return d.flags.dsa5.value=Math.max(0,Math.min(r.flags.dsa5.max,d.flags.dsa5.manual+d.flags.dsa5.auto)),c.duration&&(d.duration=c.duration,d.duration.startTime=game.time.worldTime),m.next=11,r.update(d);case 11:return m.next=13,t._dependentEffects(r.flags.core.statusId,r,l);case 13:return m.abrupt("return",r);case 14:case"end":return m.stop()}}),_callee5,this)}))),function updateEffect(r,a,o,i,c){return t.apply(this,arguments)})},{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return null==t.flags.dsa5.value||"regenerate"==a.type?0:Math.max(-1*t.flags.dsa5.max,Math.min(0,-1*t.flags.dsa5.value+this.resistantToEffect(r,t)))}},{key:"ModifierIsSelected",value:function ModifierIsSelected(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"damage"!=r.mode}},{key:"getDamageBonus",value:function getDamageBonus(){return 0}},{key:"getRollModifiers",value:function getRollModifiers(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.effects.filter((function(t){return!t.disabled})).map((function(o){var i=duplicate(o),c=game.dsa5.config.statusEffectClasses[getProperty(i,"flags.core.statusId")]||DSA5StatusEffects;return{name:i.label,value:c.calculateRollModifier(i,t,r,a),selected:c.ModifierIsSelected(r,a,t),source:game.i18n.localize("status")+"/"+game.i18n.localize("condition")}})).filter((function(t){return 0!=t.value}))}}]),DSA5StatusEffects}(),c=function(t){_inherits(EncumberedEffect,t);var r=_createSuper(EncumberedEffect);function EncumberedEffect(){return _classCallCheck(this,EncumberedEffect),r.apply(this,arguments)}return _createClass(EncumberedEffect,null,[{key:"ModifierIsSelected",value:function ModifierIsSelected(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a="skill"==t.type&&"yes"==t.system.burden.value,o=["rangeweapon"].includes(t.type)&&"damage"!=r.mode&&game.settings.get("dsa5","encumbranceForRange"),i=!["skill","spell","ritual","ceremony","liturgy","rangeweapon"].includes(t.type)&&"damage"!=r.mode;return a||i||o}},{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return"regenerate"==a.type||"skill"==a.type&&"no"==a.system.burden.value?0:_get(_getPrototypeOf(EncumberedEffect),"calculateRollModifier",this).call(this,t,r,a,o)}}]),EncumberedEffect}(i),u=function(t){_inherits(ProneEffect,t);var r=_createSuper(ProneEffect);function ProneEffect(){return _classCallCheck(this,ProneEffect),r.apply(this,arguments)}return _createClass(ProneEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return"regenerate"==a.type?0:"dodge"==a.type?-2:o.mode?"attack"==o.mode?-4:-2:0}}]),ProneEffect}(i),l=function(t){_inherits(RaptureEffect,t);var r=_createSuper(RaptureEffect);function RaptureEffect(){return _classCallCheck(this,RaptureEffect),r.apply(this,arguments)}return _createClass(RaptureEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){var o=new RegExp("".concat(game.i18n.localize("combatskill")," "),"gi"),i=r.system.happyTalents.value.split(/;|,/).map((function(t){return t.replace(o,"").trim()}));return i.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&i.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type)?t.flags.dsa5.value-1:["ritual","spell","skill","combatskill"].includes(a.type)?-1*t.flags.dsa5.value:(a.type,0)}}]),RaptureEffect}(i),p=function(t){_inherits(DeafEffect,t);var r=_createSuper(DeafEffect);function DeafEffect(){return _classCallCheck(this,DeafEffect),r.apply(this,arguments)}return _createClass(DeafEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return"regenerate"==a.type?0:"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.perception")?-3:0}}]),DeafEffect}(i),d=function(t){_inherits(BloodrushEffect,t);var r=_createSuper(BloodrushEffect);function BloodrushEffect(){return _classCallCheck(this,BloodrushEffect),r.apply(this,arguments)}return _createClass(BloodrushEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return"regenerate"==a.type?0:"skill"==a.type?a.name==game.i18n.localize("LocalizedIDs.featOfStrength")?2:0:"attack"==o.mode?4:0}}]),BloodrushEffect}(i),h=function(t){_inherits(PainEffect,t);var r=_createSuper(PainEffect);function PainEffect(){return _classCallCheck(this,PainEffect),r.apply(this,arguments)}return _createClass(PainEffect,null,[{key:"ModifierIsSelected",value:function ModifierIsSelected(t){var r=arguments.length>2?arguments[2]:void 0;return null==r.effects.find((function(t){return"bloodrush"==getProperty(t,"flags.core.statusId")}))}}]),PainEffect}(i),m=function(t){_inherits(TranceEffect,t);var r=_createSuper(TranceEffect);function TranceEffect(){return _classCallCheck(this,TranceEffect),r.apply(this,arguments)}return _createClass(TranceEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){if("regenerate"==a.type)return 0;switch(Number(t.flags.dsa5.value)){case 2:var o=new RegExp("".concat(game.i18n.localize("combatskill")," "),"gi"),i=r.system.happyTalents.value.split(/;|,/).map((function(t){return t.replace(o,"").trim()}));if(i.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&i.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type))return-2;case 3:return-3}return 0}}]),TranceEffect}(i),y=function(t){_inherits(DrunkenEffect,t);var r=_createSuper(DrunkenEffect);function DrunkenEffect(){return _classCallCheck(this,DrunkenEffect),r.apply(this,arguments)}return _createClass(DrunkenEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return"regenerate"==a.type?0:"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.gambling")?Math.max(-3,Math.min(-1*t.flags.dsa5.value+this.resistantToEffect(r,t))):0}}]),DrunkenEffect}(i),g=function(t){_inherits(BurningEffect,t);var r=_createSuper(BurningEffect);function BurningEffect(){return _classCallCheck(this,BurningEffect),r.apply(this,arguments)}return _createClass(BurningEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return"regenerate"==a.type?0:"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.bodyControl")?Math.max(-2,Math.min(0,-1*(t.flags.dsa5.value-1)+this.resistantToEffect(r,t))):0}}]),BurningEffect}(i),v=function(t){_inherits(ArousalEffect,t);var r=_createSuper(ArousalEffect);function ArousalEffect(){return _classCallCheck(this,ArousalEffect),r.apply(this,arguments)}return _createClass(ArousalEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return 0}}]),ArousalEffect}(i),_=function(t){_inherits(SikaryanlossEffect,t);var r=_createSuper(SikaryanlossEffect);function SikaryanlossEffect(){return _classCallCheck(this,SikaryanlossEffect),r.apply(this,arguments)}return _createClass(SikaryanlossEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.willpower")?-2*(t.flags.dsa5.value-1):"regenerate"==a.type?-1*t.flags.dsa5.value:0}}]),SikaryanlossEffect}(i),b=function(t){_inherits(DesireEffect,t);var r=_createSuper(DesireEffect);function DesireEffect(){return _classCallCheck(this,DesireEffect),r.apply(this,arguments)}return _createClass(DesireEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.willpower")?Math.max(-3,Math.min(0,-1*t.flags.dsa5.value+this.resistantToEffect(r,t))):0}}]),DesireEffect}(i),w=function(t){_inherits(TheriakEffect,t);var r=_createSuper(TheriakEffect);function TheriakEffect(){return _classCallCheck(this,TheriakEffect),r.apply(this,arguments)}return _createClass(TheriakEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return"regenerate"==a.type?1*t.flags.dsa5.value:0}}]),TheriakEffect}(i),k=function(t){_inherits(NoModifierEffect,t);var r=_createSuper(NoModifierEffect);function NoModifierEffect(){return _classCallCheck(this,NoModifierEffect),r.apply(this,arguments)}return _createClass(NoModifierEffect,null,[{key:"calculateRollModifier",value:function calculateRollModifier(t,r,a){return 0}}]),NoModifierEffect}(i);o.Z.statusEffectClasses={inpain:h,encumbered:c,stunned:i,raptured:l,feared:i,paralysed:i,confused:i,prone:u,deaf:p,bloodrush:d,trance:m,drunken:y,arousal:v,burning:g,sikaryanloss:_,desire:b,theriak:w,services:k}},272:(t,r,a)=>{a.d(r,{Z:()=>c});var o=a(577),i=a(794);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var c=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(AdvantageRulesDSA5,t);var r,a,i,c,u=_createSuper(AdvantageRulesDSA5);function AdvantageRulesDSA5(){return _classCallCheck(this,AdvantageRulesDSA5),u.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(AdvantageRulesDSA5,null,[{key:"setupFunctions",value:function setupFunctions(){}},{key:"vantageAdded",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:game.dsa5.config.addvantageRules[r.name]&&game.dsa5.config.addvantageRules[r.name](t,r);case 1:case"end":return a.stop()}}),_callee)}))),function vantageAdded(t,r){return c.apply(this,arguments)})},{key:"vantageRemoved",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){return _regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:game.dsa5.config.removevantageRules[r.name]&&game.dsa5.config.removevantageRules[r.name](t,r);case 1:case"end":return a.stop()}}),_callee2)}))),function vantageRemoved(t,r){return i.apply(this,arguments)})},{key:"_vantageReturnFunction",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a,i){var c,u,l,p;return _regeneratorRuntime().wrap((function _callee3$(d){for(;;)switch(d.prev=d.next){case 0:if(null!=r){d.next=2;break}return d.abrupt("return");case 2:if(r=duplicate(r),/,/.test(r.system.APValue.value)&&(c=r.name.replace(" ()",""),r.system.APValue.value=r.system.APValue.value.split(",")[t.items.filter((function(t){return t.type==r.type&&t.name.includes(c)})).length].trim()),null!=i&&(AdvantageRulesDSA5.simpleAdoption(r,i,r.name,o.Z.vantagesNeedingAdaption),r.name="".concat(r.name.replace(" ()","")," (").concat(i.name,")"),i.data&&(r.system.APValue.value=r.system.APValue.value.split("/")[i.system.StF.value.charCodeAt(0)-65].trim())),!(u=t.items.find((function(t){return t.type==a&&t.name==r.name})))){d.next=24;break}if(l=duplicate(u),p=/;/.test(l.system.APValue.value)?l.system.APValue.value.split(";").map((function(t){return Number(t.trim())}))[l.system.step.value]:l.system.APValue.value,d.t0=l.system.step.value+1<=l.system.max.value,!d.t0){d.next=14;break}return d.next=13,t.checkEnoughXP(p);case 13:d.t0=d.sent;case 14:if(!d.t0){d.next=22;break}return l.system.step.value+=1,d.next=18,t._updateAPs(p);case 18:return d.next=20,t.updateEmbeddedDocuments("Item",[l]);case 20:return d.next=22,AdvantageRulesDSA5.vantageAdded(t,l);case 22:d.next=33;break;case 24:return d.next=26,t.checkEnoughXP(r.system.APValue.value.split(";").map((function(t){return t.trim()}))[0]);case 26:if(!d.sent){d.next=33;break}return d.next=29,AdvantageRulesDSA5.vantageAdded(t,r);case 29:return d.next=31,t._updateAPs(r.system.APValue.value.split(";").map((function(t){return t.trim()}))[0]);case 31:return d.next=33,t.createEmbeddedDocuments("Item",[r]);case 33:case"end":return d.stop()}}),_callee3)}))),function _vantageReturnFunction(t,r,o,i){return a.apply(this,arguments)})},{key:"needsAdoption",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r,a){var i,c,u;return _regeneratorRuntime().wrap((function _callee4$(l){for(;;)switch(l.prev=l.next){case 0:if(!o.Z.vantagesNeedingAdaption[r.name]){l.next=17;break}if("text"!=o.Z.vantagesNeedingAdaption[r.name].items){l.next=8;break}return l.next=4,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:r});case 4:i=l.sent,c=function callback(o){var i={name:o.find('[name="entryselection"]').val()};AdvantageRulesDSA5._vantageReturnFunction(t,r,a,i)},l.next=13;break;case 8:return u=t.items.filter((function(t){return o.Z.vantagesNeedingAdaption[r.name].items.includes(t.type)})),l.next=11,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:u,original:r});case 11:i=l.sent,c=function callback(o){var i=u.find((function(t){return t.name==o.find('[name="entryselection"]').val()}));AdvantageRulesDSA5._vantageReturnFunction(t,r,a,i)};case 13:return l.next=15,new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:c},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 15:l.next=18;break;case 17:AdvantageRulesDSA5._vantageReturnFunction(t,r,a,null);case 18:case"end":return l.stop()}}),_callee4)}))),function needsAdoption(t,a,o){return r.apply(this,arguments)})},{key:"hasVantage",value:function hasVantage(t,r){return _get(_getPrototypeOf(AdvantageRulesDSA5),"hasItem",this).call(this,t,r,["advantage","disadvantage"])}},{key:"vantageStep",value:function vantageStep(t,r){return _get(_getPrototypeOf(AdvantageRulesDSA5),"itemStep",this).call(this,t,r,["advantage","disadvantage"])}},{key:"getVantageAsModifier",value:function getVantageAsModifier(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return _get(_getPrototypeOf(AdvantageRulesDSA5),"itemAsModifier",this).call(this,t,r,a,["advantage","disadvantage"],o,i)}}]),AdvantageRulesDSA5}(i.Z);i.Z.children.AdvantageRulesDSA5=c},231:(t,r,a)=>{a.d(r,{Z:()=>u});var o=a(947),i=a(903),c=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var u=function(){function DSA5ChatAutoCompletion(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSA5ChatAutoCompletion),0==DSA5ChatAutoCompletion.skills.length&&c.Z.allSkills().then((function(t){DSA5ChatAutoCompletion.skills=t.map((function(t){return{name:t.name,type:"skill"}})).concat(Object.values(game.dsa5.config.characteristics).map((function(t){return{name:game.i18n.localize(t),type:"attribute"}})).concat({name:game.i18n.localize("regenerate"),type:"regeneration"}))})),this.regex,this.filtering=!1,this.constants={dodge:game.i18n.localize("dodge"),parryWeaponless:game.i18n.localize("parryWeaponless"),attackWeaponless:game.i18n.localize("attackWeaponless")}}var t,r;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5ChatAutoCompletion,[{key:"regex",get:function get(){return new RegExp("^/(".concat(DSA5ChatAutoCompletion.cmds.join(" |"),")"))}},{key:"chatListeners",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r;return _regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:r=this,this.anchor=$("#chat-message").parent(),$("#chat-message").off("keydown",ui.chat._onChatKeyDownBinding),t.on("keyup","#chat-message",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:r._parseInput(t);case 1:case"end":return a.stop()}}),_callee)})));return function(r){return t.apply(this,arguments)}}()),t.on("click",".quick-item",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){return _regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:r._quickSelect($(t.currentTarget));case 1:case"end":return a.stop()}}),_callee2)})));return function(r){return t.apply(this,arguments)}}()),t.on("keydown","#chat-message",(function(t){r._navigateQuickFind(t)}));case 6:case"end":return a.stop()}}),_callee3,this)}))),function chatListeners(t){return r.apply(this,arguments)})},{key:"_parseInput",value:function _parseInput(t){var r=t.target.value;if(this.regex.test(r)){if([38,40,13,9].includes(t.which))return!1;if(27==t.which)return this._closeQuickfind(),!1;var a=this._getCmd(r),o=r.substring(1+a.length).toLowerCase().trim();this["_filter".concat(a)](o),this.filtering=!0}else this._closeQuickfind()}},{key:"_getCmd",value:function _getCmd(t){return t.substring(1,3).toUpperCase().trim()}},{key:"_completeCurrentEntry",value:function _completeCurrentEntry(t){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+t.text())}},{key:"_closeQuickfind",value:function _closeQuickfind(){this.filtering=!1,this.anchor.find(".quickfind").remove()}},{key:"_filterW",value:function _filterW(t){var r=game.users.contents.filter((function(r){return r.active&&-1!=r.name.toLowerCase().trim().indexOf(t)})).map((function(t){return{name:t.name,type:"user"}}));this._checkEmpty(r),this._setList(r,"W")}},{key:"_filterAT",value:function _filterAT(t){var r=DSA5ChatAutoCompletion._getActor(),a=r.actor;r.tokenId;if(a){var o=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],c=a.items.filter((function(r){return(o.includes(r.type)&&1==r.system.worn.value||"trait"==r.type&&i.includes(r.system.traitType.value))&&-1!=r.name.toLowerCase().trim().indexOf(t)})).slice(0,5).map((function(t){return{name:t.name,type:"item"}})).concat([{name:this.constants.attackWeaponless,type:"item"}].filter((function(r){return-1!=r.name.toLowerCase().trim().indexOf(t)})));this._checkEmpty(c),this._setList(c,"AT")}}},{key:"_filterPA",value:function _filterPA(t){var r=DSA5ChatAutoCompletion._getActor(),a=r.actor;r.tokenId;if(a){var o=["meleeweapon"],i=a.items.filter((function(r){return o.includes(r.type)&&-1!=r.name.toLowerCase().trim().indexOf(t)&&1==r.system.worn.value})).slice(0,5).map((function(t){return{name:t.name,type:"item"}})).concat([{name:this.constants.dodge,type:"item"},{name:this.constants.parryWeaponless,type:"item"}].filter((function(r){return-1!=r.name.toLowerCase().trim().indexOf(t)})));this._checkEmpty(i),this._setList(i,"PA")}}},{key:"_filterSP",value:function _filterSP(t){var r=DSA5ChatAutoCompletion._getActor(),a=r.actor;r.tokenId;if(a){var o=["spell","ritual"],i=a.items.filter((function(r){return o.includes(r.type)&&-1!=r.name.toLowerCase().trim().indexOf(t)})).slice(0,5).map((function(t){return{name:t.name,type:"item"}}));this._checkEmpty(i),this._setList(i,"SP")}}},{key:"_checkEmpty",value:function _checkEmpty(t){t.length||t.push({name:game.i18n.localize("DSAError.noMatch"),type:"none"})}},{key:"_filterLI",value:function _filterLI(t){var r=DSA5ChatAutoCompletion._getActor(),a=r.actor;r.tokenId;if(a){var o=["liturgy","ceremony"],i=a.items.filter((function(r){return o.includes(r.type)&&-1!=r.name.toLowerCase().trim().indexOf(t)})).slice(0,5).map((function(t){return{name:t.name,type:"item"}}));this._checkEmpty(i),this._setList(i,"LI")}}},{key:"_getSkills",value:function _getSkills(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;t=t.replace(/(-|\+)?\d+/g,"").trim();var a=DSA5ChatAutoCompletion.skills.filter((function(a){return-1!=a.name.toLowerCase().trim().indexOf(t)&&(null==r||r==a.type)})).slice(0,5);return this._checkEmpty(a),a}},{key:"_filterCH",value:function _filterCH(t){this._setList(this._getSkills(t),"CH")}},{key:"_filterSK",value:function _filterSK(t){this._setList(this._getSkills(t),"SK")}},{key:"_filterRQ",value:function _filterRQ(t){this._setList(this._getSkills(t),"RQ")}},{key:"_filterGC",value:function _filterGC(t){this._setList(this._getSkills(t,"skill"),"GC")}},{key:"_setList",value:function _setList(t,r){var a=$('<div class="quickfind dsalist"><ul>'.concat(t.map((function(t){return'<li data-type="'.concat(t.type,'" data-category="').concat(r,'" class="quick-item">').concat(t.name,"</li>")})).join(""),"</ul></div>"));a.find(".quick-item:first").addClass("focus");var o=this.anchor.find(".quickfind");o.length?o.replaceWith(a):this.anchor.append(a)}},{key:"_navigateQuickFind",value:function _navigateQuickFind(t){if(this.filtering){var r=this.anchor.find(".focus");switch(t.which){case 38:return r.prev(".quick-item").length&&r.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return r.next(".quick-item").length&&r.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if("W"==r.attr("data-category"))break;return t.stopPropagation(),t.preventDefault(),this._quickSelect(r),!1;case 9:return t.stopPropagation(),t.preventDefault(),this._completeCurrentEntry(r),!1}}ui.chat._onChatKeyDown(t)}},{key:"_quickSelect",value:function _quickSelect(t){var r=t.attr("data-category");switch(r){case"NM":case"GC":case"RQ":case"CH":this["_quick".concat(r)](t);break;case"W":this._completeCurrentEntry(t);break;default:var a=DSA5ChatAutoCompletion._getActor(),o=a.actor,i=a.tokenId;o&&(this._resetChatAutoCompletion(),this["_quick".concat(r)](t,o,i))}}},{key:"_quickW",value:function _quickW(t,r,a){}},{key:"_quickCH",value:function _quickCH(t){o.Z.check3D20(t),this._resetChatAutoCompletion()}},{key:"_quickSK",value:function _quickSK(t,r,a){switch(t.attr("data-type")){case"skill":var o=r.items.find((function(r){return r.name==t.text()&&"skill"==r.type}));o&&r.setupSkill(o,{},a).then((function(t){r.basicTest(t)}));break;case"attribute":var i=Object.keys(game.dsa5.config.characteristics).find((function(r){return game.i18n.localize(game.dsa5.config.characteristics[r])==t.text()}));r.setupCharacteristic(i,{},a).then((function(t){r.basicTest(t)}));break;case"regeneration":r.setupRegeneration("regenerate",{},a).then((function(t){r.basicTest(t)}))}}},{key:"_resetChatAutoCompletion",value:function _resetChatAutoCompletion(){$("#chat-message").val(""),this.anchor.find(".quickfind").remove()}},{key:"_quickGC",value:function _quickGC(t){var r=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),i.Z.showGCMessage(t.text(),r)}},{key:"_quickRQ",value:function _quickRQ(t){var r=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),i.Z.showRQMessage(t.text(),r)}},{key:"_quickPA",value:function _quickPA(t,r,a){var o=t.text();if(this.constants.dodge==o)r.setupDodge({},a).then((function(t){r.basicTest(t)}));else if(this.constants.parryWeaponless==o)r.setupWeaponless("parry",{},a).then((function(t){r.basicTest(t)}));else{var i=["meleeweapon"],c=r.items.find((function(r){return i.includes(r.type)&&r.name==t.text()}));c&&r.setupWeapon(c,"parry",{},a).then((function(t){r.basicTest(t)}))}}},{key:"_quickAT",value:function _quickAT(t,r,a){var o=t.text();if(this.constants.attackWeaponless==o)r.setupWeaponless("attack",{},a).then((function(t){r.basicTest(t)}));else{var i=["meleeweapon","rangeweapon"],c=["meleeAttack","rangeAttack"],u=r.items.find((function(r){return i.includes(r.type)&&r.name==t.text()}));u||(u=r.items.find((function(r){return"trait"==r.type&&r.name==t.text()&&c.includes(r.system.traitType.value)}))),u&&r.setupWeapon(u,"attack",{},a).then((function(t){r.basicTest(t)}))}}},{key:"_quickSP",value:function _quickSP(t,r,a){var o=["ritual","spell"],i=r.items.find((function(r){return o.includes(r.type)&&r.name==t.text()}));i&&r.setupSpell(i,{},a).then((function(t){r.basicTest(t)}))}},{key:"_quickLI",value:function _quickLI(t,r,a){var o=["liturgy","ceremony"],i=r.items.find((function(r){return o.includes(r.type)&&r.name==t.text()}));i&&r.setupSpell(i,{},a).then((function(t){r.basicTest(t)}))}}],[{key:"_getActor",value:function _getActor(){var t,r=ChatMessage.getSpeaker();return r.token&&(t=game.actors.tokens[r.token]),t||(t=game.actors.get(r.actor)),t?{actor:t,tokenId:r.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}},{key:"infoItemAsync",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){return _regeneratorRuntime().wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,fromUuid(t);case 2:r.sent.postItem();case 4:case"end":return r.stop()}}),_callee4)}))),function infoItemAsync(r){return t.apply(this,arguments)})},{key:"bindRollCommands",value:function bindRollCommands(t){var r=this;t.on("click",".request-roll",(function(t){return i.Z.showRQMessage(t.currentTarget.dataset.name,Number(t.currentTarget.dataset.modifier)||0),t.stopPropagation(),!1})),t.on("click",".postInfo",(function(t){var a=fromUuidSync(t.currentTarget.dataset.uuid);return a&&("function"==typeof a.postItem?a.postItem():r.infoItemAsync(t.currentTarget.dataset.uuid)),t.stopPropagation(),!1})),t.on("click",".request-GC",(function(t){return i.Z.showGCMessage(t.currentTarget.dataset.name,Number(t.currentTarget.dataset.modifier)||0),t.stopPropagation(),!1})),t.on("click",".request-CH",(function(t){return o.Z.check3D20(void 0,t.currentTarget.dataset.name,{modifier:Number(t.currentTarget.dataset.modifier)||0}),t.stopPropagation(),!1}))}}]),DSA5ChatAutoCompletion}();_defineProperty(u,"skills",[]),_defineProperty(u,"cmds",["sk","at","pa","sp","li","rq","gc","w","ch"])},947:(t,r,a)=>{a.d(r,{Z:()=>l});var o=a(577),i=a(491),c=a(586),u=a(122);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var l=function(){function DSA5ChatListeners(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSA5ChatListeners)}var t,r,a;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5ChatListeners,null,[{key:"chatListeners",value:function chatListeners(t){t.on("click",".chat-condition",(function(t){DSA5ChatListeners.postStatus($(t.currentTarget).attr("data-id"))})),t.on("click",".openJournalBrowser",(function(){return game.dsa5.apps.journalBrowser.render(!0)}));var r=$('<a class="button showHelp" data-tooltip="'.concat(game.i18n.localize("HELP.showHelp"),'"><i class="fas fa-question"></i></a>'));r.click((function(){DSA5ChatListeners.getHelp()})),$(t.find(".control-buttons")).prepend(r),t.on("click",".showPatchViewer",(function(){return(0,c.j)()})),t.on("click",".functionswitch",(function(t){return u.Z[t.currentTarget.dataset.function](t)})),t.on("click",".panToToken",(function(t){return DSA5ChatListeners.panToToken(t)}))}},{key:"panToToken",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r;return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,fromUuid(t.currentTarget.dataset.uuid);case 2:if(r=a.sent){a.next=5;break}return a.abrupt("return");case 5:if(canvas.animatePan({x:r.x,y:r.y}),r.isOwner){a.next=8;break}return a.abrupt("return");case 8:r.object.control({releaseOthers:!0});case 9:case"end":return a.stop()}}),_callee)}))),function panToToken(t){return a.apply(this,arguments)})},{key:"postStatus",value:function postStatus(t){var r=CONFIG.statusEffects.find((function(r){return r.id==t})),a='<h2><a class="chat-condition chatButton" data-id="'.concat(t,'"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="').concat(r.icon,'"/>').concat(game.i18n.localize(r.label),"</h2></a><p>").concat(game.i18n.localize(r.description),"</p>");ChatMessage.create(i.Z.chatDataSetup(a,"roll"))}},{key:"getHelp",value:function getHelp(){var t=o.Z.helpContent.map((function(t){return"<h2>".concat(game.i18n.localize("HELP.".concat(t.name)),"</h2>\n            <p><b>").concat(game.i18n.localize("HELP.command"),"</b>: ").concat(t.command,"</p>\n            <p><b>").concat(game.i18n.localize("HELP.example"),"</b>: ").concat(t.example,"</p>\n            <p><b>").concat(game.i18n.localize("Description"),"</b>: ").concat(game.i18n.localize("HELP.descr".concat(t.name)))})).join("")+"<br>\n            <p>".concat(game.i18n.localize("HELP.default"),"</p>");ChatMessage.create(i.Z.chatDataSetup(t,"roll"))}},{key:"showConditions",value:function showConditions(){var t=duplicate(CONFIG.statusEffects).map((function(t){return t.label=game.i18n.localize(t.label),t})).sort((function(t,r){return t.label.localeCompare(r.label)})).map((function(t){return'<a class="chat-condition chatButton" data-id="'.concat(t.id,'"><img src="').concat(t.icon,'"/>').concat(t.label,"</a>")})).join(" ");ChatMessage.create(i.Z.chatDataSetup(t,"roll"))}},{key:"check3D20",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a,o,c,u=arguments;return _regeneratorRuntime().wrap((function _callee2$(l){for(;;)switch(l.prev=l.next){case 0:if(a=u.length>2&&void 0!==u[2]?u[2]:{},o=12,!t){l.next=10;break}return t=t.get(0),l.next=6,i.Z.skillByName(t.textContent);case 6:r=l.sent,t.dataset.attrs&&(o=t.dataset.attrs.split("|")),l.next=14;break;case 10:if(!r){l.next=14;break}return l.next=13,i.Z.skillByName(r);case 13:r=l.sent;case 14:return r&&(r=r.toObject()),r||(r={name:"3d20",type:"skill",system:{talentValue:{value:0},characteristic1:{value:"mu"},characteristic2:{value:"kl"},characteristic3:{value:"in"},RPr:{value:"no"},burden:{value:"no"}}}),l.next=18,i.Z.emptyActor(o);case 18:(c=l.sent).setupSkill(r,a,"emptyActor").then((function(t){c.basicTest(t)}));case 20:case"end":return l.stop()}}),_callee2)}))),function check3D20(t,a){return r.apply(this,arguments)})},{key:"showTables",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(){var t;return _regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,renderTemplate("systems/dsa5/templates/tables/systemtables.html",{tables:o.Z.systemTables});case 2:t=r.sent,ChatMessage.create(i.Z.chatDataSetup(t,"roll"));case 4:case"end":return r.stop()}}),_callee3)}))),function showTables(){return t.apply(this,arguments)})}]),DSA5ChatListeners}()},577:(t,r,a)=>{a.d(r,{Z:()=>i});var o={statusEffects:[{icon:"icons/svg/skull.svg",id:"dead",label:"CONDITION.defeated",description:"CONDITIONDESCRIPTION.defeated",flags:{dsa5:{value:null,editable:!0}}},{id:"inpain",label:"CONDITION.inpain",icon:"icons/svg/blood.svg",description:"CONDITIONDESCRIPTION.inpain",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"prone",label:"CONDITION.prone",icon:"icons/svg/falling.svg",description:"CONDITIONDESCRIPTION.prone",flags:{dsa5:{value:null,editable:!0}}},{id:"unconscious",label:"CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"CONDITIONDESCRIPTION.unconscious",flags:{dsa5:{value:null,editable:!0}}},{id:"rooted",label:"CONDITION.rooted",icon:"icons/svg/net.svg",description:"CONDITIONDESCRIPTION.rooted",flags:{dsa5:{value:null,editable:!0}}},{id:"fixated",label:"CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"CONDITIONDESCRIPTION.fixated",flags:{dsa5:{value:null,editable:!0}}},{id:"surprised",label:"CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"CONDITIONDESCRIPTION.surprised",flags:{dsa5:{value:null,editable:!0}}},{id:"blind",label:"CONDITION.blind",icon:"icons/svg/blind.svg",description:"CONDITIONDESCRIPTION.blind",flags:{dsa5:{value:null,editable:!0}}},{id:"poisoned",label:"CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"CONDITIONDESCRIPTION.poisoned",flags:{dsa5:{value:null,editable:!0}}},{id:"sick",label:"CONDITION.sick",icon:"icons/svg/biohazard.svg",description:"CONDITIONDESCRIPTION.sick",flags:{dsa5:{value:null,editable:!0}}},{id:"deaf",label:"CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"CONDITIONDESCRIPTION.deaf",flags:{dsa5:{value:null,editable:!0}}},{id:"burning",label:"CONDITION.burning",icon:"icons/svg/fire.svg",description:"CONDITIONDESCRIPTION.burning",flags:{dsa5:{value:1,editable:!0,max:3}}},{id:"invisible",label:"CONDITION.invisible",icon:"icons/svg/circle.svg",description:"CONDITIONDESCRIPTION.invisible",flags:{dsa5:{value:null,editable:!0}}},{id:"constricted",label:"CONDITION.constricted",icon:"icons/svg/cave.svg",description:"CONDITIONDESCRIPTION.constricted",flags:{dsa5:{value:null,editable:!0}}},{id:"bloodrush",label:"CONDITION.bloodrush",icon:"icons/svg/bones.svg",description:"CONDITIONDESCRIPTION.bloodrush",changes:[{key:"system.skillModifiers.step",mode:0,value:"Kraftakt 2;Feat of Strength 2"}],flags:{dsa5:{value:null,editable:!0}}},{id:"mute",label:"CONDITION.mute",icon:"icons/svg/silenced.svg",description:"CONDITIONDESCRIPTION.mute",flags:{dsa5:{value:null,editable:!0}}},{id:"incapacitated",label:"CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"CONDITIONDESCRIPTION.incapacitated",flags:{dsa5:{value:null,editable:!0}}},{id:"encumbered",label:"CONDITION.encumbered",icon:"icons/svg/anchor.svg",description:"CONDITIONDESCRIPTION.encumbered",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"stunned",label:"CONDITION.stunned",icon:"icons/svg/daze.svg",description:"CONDITIONDESCRIPTION.stunned",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"raptured",label:"CONDITION.raptured",icon:"icons/svg/ice-aura.svg",description:"CONDITIONDESCRIPTION.raptured",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"feared",label:"CONDITION.feared",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.feared",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"paralysed",label:"CONDITION.paralysed",icon:"icons/svg/paralysis.svg",description:"CONDITIONDESCRIPTION.paralysed",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"confused",label:"CONDITION.confused",icon:"icons/svg/stoned.svg",description:"CONDITIONDESCRIPTION.confused",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"minorSpirits",label:"CONDITION.minorSpirits",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.minorSpirits",changes:[{key:"system.skillModifiers.global",mode:0,value:-1}],duration:{seconds:600},flags:{dsa5:{value:null,editable:!0}}},{id:"services",label:"PLAYER.services",icon:"icons/svg/aura.svg",description:"CONDITIONDESCRIPTION.services",flags:{dsa5:{value:1,editable:!0,max:500,hideOnToken:!0}}}],armorSubcategories:{0:4,1:5,2:6,3:8,4:9,5:13,6:12,7:11,8:10},weaponStabilities:{Blowpipes:10,Bows:4,Brawling:12,"Chain Weapons":10,Crossbows:6,Daggers:14,Discuses:12,Fans:13,"Fencing Weapons":8,"Impact Weapons":12,Lances:6,Pikes:12,Polearms:12,Shields:10,Slingshots:4,Swords:13,"Throwing Weapons":10,"Two-Handed Impact Weapons":11,"Two-Handed Swords":12,Whips:4},combatSkillSubCategories:{0:"COMBATSKILLCATEGORY.0",1:"COMBATSKILLCATEGORY.1",2:"COMBATSKILLCATEGORY.2",3:"COMBATSKILLCATEGORY.3",4:"COMBATSKILLCATEGORY.4"}};o.effectTextStyle=CONFIG.canvasTextStyle.clone(),o.effectTextStyle.fontSize="30",o.effectTextStyle.fontFamily="GentiumBasic",o.knownShortcuts={},o.gearModifyableCalculatedAttributes=["fatePoints","initiative","speed","astralenergy","karmaenergy","wounds","dodge","soulpower","toughness"],o.defaultWeapon={name:"default",type:"meleeweapon",effects:[],system:{type:"meleeweapon",crit:1,botch:20,reach:{value:"short"},damage:{value:"1d6"},atmod:{value:0,offHandMod:0},pamod:{value:0,offHandMod:0},guidevalue:{value:"ge/kk"},damageThreshold:{value:"5000"},worn:{offhand:!1}}},o.characteristics={mu:"CHAR.MU",kl:"CHAR.KL",in:"CHAR.IN",ch:"CHAR.CH",ff:"CHAR.FF",ge:"CHAR.GE",ko:"CHAR.KO",kk:"CHAR.KK"},o.equipmentTypes={misc:"Equipment.misc",clothes:"Equipment.clothes",tools:"Equipment.tools",light:"Equipment.light",healing:"Equipment.healing",bags:"Equipment.bags",wealth:"Equipment.wealth",writing:"Equipment.writing",alchemy:"Equipment.alchemy",service:"Equipment.service",luxus:"Equipment.luxus",blessed:"Equipment.blessed"},o.equipmentCategories=["meleeweapon","rangeweapon","equipment","ammunition","armor","poison","consumable","plant"],o.systemTables=[{name:"Defense",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"defenseBotchTableEnabled"}},{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"meleeBotchTableEnabled"}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"rangeBotchTableEnabled"}},{name:"Liturgy",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}},{name:"Spell",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}}],o.morePackages={packages:{},names:{de:[],en:[]}},o.narrowSpaceModifiers={weaponshort:{attack:0,parry:0,label:"NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:-4,parry:-4,label:"NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-8,parry:-8,label:"NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:-2,parry:-2,label:"NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:-4,parry:-3,label:"NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-6,parry:-4,label:"NarrowSpaceModifiers.shield.long"}},o.traditionArtifacts={Animistenwaffe:15,Bannschwert:15,Druidendolch:15,Druidensichel:12,Zauberkleidung:15,Magierkugel:12,Zauberinstrument:15,Narrenkappe:15,Hexenkessel:15,Krallenkette:12,Lebensring:12,Alchimistenschale:15,"Scharlatanische Zauberkugel":15,Sippenchronik:15,Schelmenspielzeug:12,Zauberstecken:0,Magierstab:18,Trinkhorn:0},o.moneyNames={D:"Money-D",S:"Money-S",H:"Money-H",K:"Money-K"},o.areaTargetTypes={cube:"rect",line:"ray",sphere:"circle",cone:"cone"},o.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}},o.regnerationCampLocations={0:"regnerationCampLocations.normal","-1":"regnerationCampLocations.bad",1:"regnerationCampLocations.good"},o.regenerationInterruptOptions={0:"regenerationInterruptOptions.none","-1":"regenerationInterruptOptions.small","-2":"regenerationInterruptOptions.big"},o.targetMomevementOptions={0:"rangeMovementOptions.SLOW","-2":"rangeMovementOptions.FAST",2:"rangeMovementOptions.STATIONARY"},o.shooterMovementOptions={0:"rangeMovementOptions.SHOOTERSTATIONARY","-2":"rangeMovementOptions.SHOOTERMOVING","-4":"rangeMovementOptions.SHOOTERRUNNING"},o.mountedRangeOptions={0:"mountedRangeOptions.STATIONARY","-4":"mountedRangeOptions.SCHRITT","-8":"mountedRangeOptions.GALOPP"},o.drivingArcherOptions={0:"mountedRangeOptions.STATIONARY","-2":"mountedRangeOptions.SCHRITT","-4":"mountedRangeOptions.GALOPP"},o.aimOptions={0:"aimOptions.0",2:"aimOptions.1",4:"aimOptions.2"},o.traitCategories={meleeAttack:"closeCombatAttacks",rangeAttack:"rangeCombatAttacks",armor:"armor",general:"general",familiar:"familiar",trick:"trick",training:"training",entity:"entityAbility",summoning:"summoningPackage"},o.ritualLocationModifiers={0:"-",1:"RITUALMODIFIER.holysite","-3":"RITUALMODIFIER.wrongsite"},o.ritualTimeModifiers={0:"-",1:"RITUALMODIFIER.matchingConstellation","-1":"RITUALMODIFIER.wrongConstellation"},o.ceremonyLocationModifiers={0:"-",2:"CEREMONYMODIFIER.holysite",1:"CEREMONYMODIFIER.temple","-1":"CEREMONYMODIFIER.otherTemple","-2":"CEREMONYMODIFIER.enemyGod","-3":"CEREMONYMODIFIER.archDemon","-4":"CEREMONYMODIFIER.nameless","-5":"CEREMONYMODIFIER.nemesis"},o.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,30,45,60,75,90,105,120,135,150,165,180]},o.hooks={},o.startXP={900:"EXP.inexperienced",1e3:"EXP.average",1100:"EXP.experienced",1200:"EXP.competent",1400:"EXP.masterful",1700:"EXP.brillant",2100:"EXP.legendary"},o.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /sp [a-z]*, /li [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk betren"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq betren"},{name:"threeD20Check",command:"/ch",example:"/ch"},{name:"groupcheck",command:"/gc",example:"/gc"}],o.ceremonyTimeModifiers={0:"-",1:"CEREMONYMODIFIER.monthGod",2:"CEREMONYMODIFIER.celebration","-5":"CEREMONYMODIFIER.namelessDays"},o.mageLevels={mundane:"mundane",clerical:"clerical",magical:"magical"},o.specialAbilityCategories={general:"general",Combat:"Combat",fatePoints:"fatePoints",magical:"magical",clerical:"clerical",language:"language",animal:"animal",staff:"traditionArtifact",ceremonial:"ceremonialItem",pact:"pactgift"},o.addvantageRules={},o.removevantageRules={},o.vantagesNeedingAdaption={},o.addAbilityRules={},o.removeAbilityRules={},o.AbilitiesNeedingAdaption={},o.addTraitRules={},o.rangeWeaponModifiers={short:"RangeMod.short",medium:"RangeMod.medium",long:"RangeMod.long",rangesense:"RangeMod.rangesense",extreme:"RangeMod.extreme"},o.meleeRangesArray=["short","medium","long"],o.meleeRanges={short:"Range-short",medium:"Range-medium",long:"Range-long"},o.weapontypes={melee:"meleeweapon",range:"rangeweapon"},o.ammunitiongroups={"-":"-",arrow:"arrow",bolt:"bolt",bullet:"bullet",stone:"stone",dart:"dart",mag:"mag",infinite:"infinite"},o.combatskillsGuidevalues={ff:"CHAR.FF",ge:"CHAR.GE",kk:"CHAR.KK","ge/kk":"CHAR.GEKK"},o.skillDifficultyModifiers={eeasy:5,veasy:3,easy:1,challenging:0,difficult:-1,hard:-3,vhard:-5},o.magicResistanceModifiers={"-":"-",SK:"soulpower",ZK:"toughness"},o.sizeCategories={tiny:"SIZE.tiny",small:"SIZE.small",average:"SIZE.average",big:"SIZE.big",giant:"SIZE.giant"},o.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4},o.rangeSizeCategories={tiny:"RANGESIZE.tiny",small:"RANGESIZE.small",average:"RANGESIZE.average",big:"RANGESIZE.big",giant:"RANGESIZE.giant"},o.shieldSizes={short:"SIZE.small",medium:"SIZE.average",long:"SIZE.big"},o.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8},o.rangeVision={0:"VisionDisruption.step0","-2":"VisionDisruption.step1","-4":"VisionDisruption.step2","-6":"VisionDisruption.step3","-5000":"VisionDisruption.step4"},o.meleeRangeVision=function(t){return function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}({"+0":"meleeVisionDisruption.0","-1":"meleeVisionDisruption.1","-2":"meleeVisionDisruption.2","-3":"meleeVisionDisruption.3"},"attack"==t?"*0,5":"-5000","meleeVisionDisruption.4")},o.attributeDifficultyModifiers={eeasy:6,veasy:4,easy:2,challenging:0,difficult:-2,hard:-4,vhard:-6},o.skillDifficultyLabels={eeasy:"Skill-eeasy",veasy:"Skill-veasy",easy:"Skill-easy",challenging:"Skill-challenging",difficult:"Skill-difficult",hard:"Skill-hard",vhard:"Skill-vhard"},o.attributeDifficultyLabels={eeasy:"Attribute-eeasy",veasy:"Attribute-veasy",easy:"Attribute-easy",challenging:"Attribute-challenging",difficult:"Attribute-difficult",hard:"Attribute-hard",vhard:"Attribute-vhard"},o.skillGroups={body:"SKILL.body",social:"SKILL.social",knowledge:"SKILL.knowledge",trade:"SKILL.trade",nature:"SKILL.nature"},o.features=["Object","Spheres","Influence","Clairvoyance","Healing","Transformation","Telekinesis","Elemental","Illusion","Anti-Magic","Demonic","Temporal"],o.skillBurdens={yes:"yes",no:"no",maybe:"maybe"},o.StFs={A:"A",B:"B",C:"C",D:"D"},o.noteIcons={"Griffin Shield":"systems/dsa5/icons/thirdparty/griffinshield.svg","At Sea":"systems/dsa5/icons/thirdparty/at-sea.svg","Medieval Gate":"systems/dsa5/icons/thirdparty/medieval-gate.svg","Position Marker":"systems/dsa5/icons/thirdparty/position-marker.svg",River:"systems/dsa5/icons/thirdparty/river.svg",Trail:"systems/dsa5/icons/thirdparty/trail.svg"},CONFIG.time.roundTime=5,CONFIG.time.turnTime=0;const i=o},472:(t,r,a)=>{a.d(r,{Z:()=>i});var o=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}Hooks.once("ready",_asyncToGenerator(_regeneratorRuntime().mark((function _callee(){var t;return _regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:if(i.creatureData){r.next=11;break}return r.next=3,fetch("systems/dsa5/lazy/creaturetype/".concat(game.i18n.lang,".json"));case 3:return t=r.sent,r.next=6,t.json();case 6:i.creatureData=r.sent,i.magical=game.i18n.localize("WEAPON.magical"),i.clerical=game.i18n.localize("WEAPON.clerical"),i.silverPlated=game.i18n.localize("WEAPON.silverPlated"),game.dsa5.apps.CreatureType=i;case 11:case"end":return r.stop()}}),_callee)}))));var i=function(){function CreatureType(t){_classCallCheck(this,CreatureType),this.creatureClass=t,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}return _createClass(CreatureType,[{key:"ignoredCondition",value:function ignoredCondition(t){return!1}},{key:"damageModifier",value:function damageModifier(t){return[]}},{key:"spellImmunity",value:function spellImmunity(t){return this.spellImmunities.some((function(r){return t.includes(r)}))}},{key:"spellArmorModifier",value:function spellArmorModifier(t){return 0}},{key:"poisonImmunity",value:function poisonImmunity(){return this.poisonImmunity}},{key:"diseaseImmunity",value:function diseaseImmunity(){return this.diseaseImmunity}},{key:"spellResistanceModifier",value:function spellResistanceModifier(t){return 0}},{key:"weaponAttributes",value:function weaponAttributes(t){return getProperty(t,"system.effect.attributes")||""}},{key:"getTypeByClass",value:function getTypeByClass(t){return Object.keys(CreatureType.creatureData.types).find((function(r){return CreatureType.creatureData.types[r]===t}))}},{key:"isAttackItem",value:function isAttackItem(t){return["meleeweapon","trait","rangeweapon"].includes(t.type)&&function isNotEmpty(t){return!(!t||0===t.length)}(this.weaponAttributes(t))}},{key:"attributesRegex",value:function attributesRegex(t){var r=this.weaponAttributes(t);return new RegExp("(".concat(r.split(",").map((function(t){return o.Z.escapeRegex(t.split("(")[0].trim())})).join("|"),")"),"i")}}],[{key:"detectCreatureType",value:function detectCreatureType(t){var r=this,a="creature"==t.type?t.system.creatureClass.value:t.system.details.species.value;return Object.keys(CreatureType.creatureData.types).filter((function(t){return a.indexOf(t)>=0})).map((function(t){return r.getClass(CreatureType.creatureData.types[t],a)}))}},{key:"getClass",value:function getClass(t,r){return new(0,{DemonType:d,ChimeraType:u,DaimonidType:l,DragonType:p,ElementalType:h,FairyType:m,GhostType:y,GolemType:g,HomunculiType:v,IntelligentCreatureType:_,PlantType:b,AnimalType:w,UndeadType:k,SupernaturalType:x,MagicalConstructType:S,WerCreatureType:T,VampireType:A}[t])(r)}},{key:"creatureTypeName",value:function creatureTypeName(t){if("creature"==t.type){var r=t.system.creatureClass.value;return Object.keys(CreatureType.creatureData.types).filter((function(t){return r.indexOf(t)>=0}))[0]}return t.system.details.species.value}},{key:"addCreatureTypeModifiers",value:function addCreatureTypeModifiers(t,r,a,o){var i,c=CreatureType.detectCreatureType(t),u=["spell","ceremony","liturgy","ritual"].includes(r.type),l=_createForOfIteratorHelper(c);try{for(l.s();!(i=l.n()).done;){var p=i.value,d=p.damageModifier(r);if(u){var h,m=_createForOfIteratorHelper(d);try{for(m.s();!(h=m.n()).done;){h.value.armorPen=p.spellResistanceModifier(t)}}catch(t){m.e(t)}finally{m.f()}}a.push.apply(a,_toConsumableArray(d))}}catch(t){l.e(t)}finally{l.f()}a.push.apply(a,_toConsumableArray(this.creatureBonusDamage(t,o))),CreatureType.addVulnerabilitiesToSource(t,r,a)}},{key:"addVulnerabilitiesToSource",value:function addVulnerabilitiesToSource(t,r,a){var o=getProperty(t,"system.vulnerabilities");o&&(["meleeweapon","rangeweapon"].includes(r.type)&&getProperty(o,"combatskill").reduce((function(t,o){if(o.target==r.system.combatskill.value){var i=(/\*/.test(o.value)?Number(o.value.replace("*",""))>1:Number(o.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";a.push.apply(a,_toConsumableArray(CreatureType.buildDamageMod("".concat(game.i18n.format(i,{name:r.system.combatskill.value})," (").concat(o.source,")"),o.value)))}}),a))}},{key:"creatureBonusDamage",value:function creatureBonusDamage(t,r){var a,o=[],i="creature"==t.type?t.system.creatureClass.value:t.system.details.species.value,c=_createForOfIteratorHelper(getProperty(r,"system.creatureBonus"));try{for(c.s();!(a=c.n()).done;){var u=a.value;i.indexOf(u.target)>=0&&o.push.apply(o,_toConsumableArray(this.buildDamageMod(u.source,u.value,!0)))}}catch(t){c.e(t)}finally{c.f()}return o}},{key:"buildDamageMod",value:function buildDamageMod(t,r){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return[{name:t,value:r,selected:a,type:"dmg",source:game.i18n.localize("target")}]}}]),CreatureType}();_defineProperty(i,"creatureData",void 0),_defineProperty(i,"magical",void 0),_defineProperty(i,"clerical",void 0);var c=function(t){_inherits(VulnerableToLifeGods,t);var r=_createSuper(VulnerableToLifeGods);function VulnerableToLifeGods(){return _classCallCheck(this,VulnerableToLifeGods),r.apply(this,arguments)}return _createClass(VulnerableToLifeGods,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)){var r,a=this.attributesRegex(t),o=_createForOfIteratorHelper(i.creatureData.godOfLife);try{for(o.s();!(r=o.n()).done;){var c=r.value,u="".concat(i.clerical," (").concat(c,")");if(a.test(u))return i.buildDamageMod(u,"*2")}}catch(t){o.e(t)}finally{o.f()}}return _get(_getPrototypeOf(VulnerableToLifeGods.prototype),"damageModifier",this).call(this,t)}}]),VulnerableToLifeGods}(i),u=function(t){_inherits(ChimeraType,t);var r=_createSuper(ChimeraType);function ChimeraType(){return _classCallCheck(this,ChimeraType),r.apply(this,arguments)}return _createClass(ChimeraType)}(c),l=function(t){_inherits(DaimonidType,t);var r=_createSuper(DaimonidType);function DaimonidType(t){var a;return _classCallCheck(this,DaimonidType),(a=r.call(this,t)).spellImmunities=["Influence","Transformation"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a}return _createClass(DaimonidType,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)&&this.attributesRegex(t).test(i.clerical))return i.buildDamageMod(i.clerical,"*2");return _get(_getPrototypeOf(DaimonidType.prototype),"damageModifier",this).call(this,t)}}]),DaimonidType}(i),p=function(t){_inherits(DragonType,t);var r=_createSuper(DragonType);function DragonType(){return _classCallCheck(this,DragonType),r.apply(this,arguments)}return _createClass(DragonType)}(i),d=function(t){_inherits(DemonType,t);var r=_createSuper(DemonType);function DemonType(t){var a;return _classCallCheck(this,DemonType),(a=r.call(this,t)).spellImmunities=["Influence","Transformation","Healing","Illusion"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a.poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(DemonType,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)){var r=this.attributesRegex(t);if(r.test(i.clerical))return i.buildDamageMod("".concat(i.clerical," (").concat(i.creatureData.opposingGod,")"),"*2",!1);if(r.test(i.magical))return _get(_getPrototypeOf(DemonType.prototype),"damageModifier",this).call(this,t)}else if(["spell","ceremony","liturgy","ritual"].includes(t.type))return _get(_getPrototypeOf(DemonType.prototype),"damageModifier",this).call(this,t);return i.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}},{key:"spellArmorModifier",value:function spellArmorModifier(t){return Number(t.system.status.soulpower.max)}},{key:"spellResistanceModifier",value:function spellResistanceModifier(t){return Number(t.system.status.soulpower.max)}},{key:"ignoredCondition",value:function ignoredCondition(t){return!0}}]),DemonType}(i),h=function(t){_inherits(ElementalType,t);var r=_createSuper(ElementalType);function ElementalType(t){var a;return _classCallCheck(this,ElementalType),(a=r.call(this,t)).poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(ElementalType,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)){if(this.attributesRegex(t).test(i.magical))return _get(_getPrototypeOf(ElementalType.prototype),"damageModifier",this).call(this,t)}else if(["spell","ceremony","liturgy","ritual"].includes(t.type))return i.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return i.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}},{key:"spellArmorModifier",value:function spellArmorModifier(t){return Number(t.system.status.soulpower.max)}},{key:"spellResistanceModifier",value:function spellResistanceModifier(t){return Number(t.system.status.soulpower.max)}},{key:"ignoredCondition",value:function ignoredCondition(t){return!0}}]),ElementalType}(i),m=function(t){_inherits(FairyType,t);var r=_createSuper(FairyType);function FairyType(t){var a;return _classCallCheck(this,FairyType),(a=r.call(this,t)).spellImmunities=["Illusion"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a.poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(FairyType)}(i),y=function(t){_inherits(GhostType,t);var r=_createSuper(GhostType);function GhostType(t){var a;return _classCallCheck(this,GhostType),(a=r.call(this,t)).spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a.poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(GhostType,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)){var r,a=this.attributesRegex(t),o=_createForOfIteratorHelper(i.creatureData.godOfDeath);try{for(o.s();!(r=o.n()).done;){var c=r.value,u="".concat(i.clerical," (").concat(c,")");if(a.test(u))return[]}}catch(t){o.e(t)}finally{o.f()}if((a=this.attributesRegex(t)).test(i.clerical))return i.buildDamageMod(i.clerical,"*0.5");if(a.test(i.magical))return i.buildDamageMod(i.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(t.type))return i.buildDamageMod(i.magical,"*0.5");return i.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}},{key:"ignoredCondition",value:function ignoredCondition(t){return!["feared","inpain","confused"].includes(t)}}]),GhostType}(i),g=function(t){_inherits(GolemType,t);var r=_createSuper(GolemType);function GolemType(t){var a;return _classCallCheck(this,GolemType),(a=r.call(this,t)).spellImmunities=["Transformation"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a.poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(GolemType,[{key:"ignoredCondition",value:function ignoredCondition(t){return!["confused","paralysed"].includes(t)}}]),GolemType}(c),v=function(t){_inherits(HomunculiType,t);var r=_createSuper(HomunculiType);function HomunculiType(t){var a;return _classCallCheck(this,HomunculiType),(a=r.call(this,t)).spellImmunities=["Healing"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a}return _createClass(HomunculiType,[{key:"ignoredCondition",value:function ignoredCondition(t){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(t)}}]),HomunculiType}(c),_=function(t){_inherits(IntelligentCreatureType,t);var r=_createSuper(IntelligentCreatureType);function IntelligentCreatureType(){return _classCallCheck(this,IntelligentCreatureType),r.apply(this,arguments)}return _createClass(IntelligentCreatureType)}(i),b=function(t){_inherits(PlantType,t);var r=_createSuper(PlantType);function PlantType(){return _classCallCheck(this,PlantType),r.apply(this,arguments)}return _createClass(PlantType)}(i),w=function(t){_inherits(AnimalType,t);var r=_createSuper(AnimalType);function AnimalType(){return _classCallCheck(this,AnimalType),r.apply(this,arguments)}return _createClass(AnimalType)}(i),k=function(t){_inherits(UndeadType,t);var r=_createSuper(UndeadType);function UndeadType(t){var a;return _classCallCheck(this,UndeadType),(a=r.call(this,t)).spellImmunities=["Influence","Healing","Illusion"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a.poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(UndeadType,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)){var r,a=this.attributesRegex(t),o=_createForOfIteratorHelper(i.creatureData.godOfDeath);try{for(o.s();!(r=o.n()).done;){var c=r.value,u="".concat(i.clerical," (").concat(c,")");if(a.test(u))return i.buildDamageMod(u,"*2")}}catch(t){o.e(t)}finally{o.f()}}return _get(_getPrototypeOf(UndeadType.prototype),"damageModifier",this).call(this,t)}},{key:"ignoredCondition",value:function ignoredCondition(t){return!["paralysed"].includes(t)}}]),UndeadType}(i),x=function(t){_inherits(SupernaturalType,t);var r=_createSuper(SupernaturalType);function SupernaturalType(){return _classCallCheck(this,SupernaturalType),r.apply(this,arguments)}return _createClass(SupernaturalType)}(i),S=function(t){_inherits(MagicalConstructType,t);var r=_createSuper(MagicalConstructType);function MagicalConstructType(t){var a;return _classCallCheck(this,MagicalConstructType),(a=r.call(this,t)).spellImmunities=["Transformation"].map((function(t){return game.i18n.localize("Features.".concat(t))})),a.poisonImmunity=!0,a.diseaseImmunity=!0,a}return _createClass(MagicalConstructType,[{key:"ignoredCondition",value:function ignoredCondition(t){return!["stunned","feared","paralysed","confused"].includes(t)}}]),MagicalConstructType}(i),T=function(t){_inherits(WerCreatureType,t);var r=_createSuper(WerCreatureType);function WerCreatureType(){return _classCallCheck(this,WerCreatureType),r.apply(this,arguments)}return _createClass(WerCreatureType,[{key:"damageModifier",value:function damageModifier(t){if(this.isAttackItem(t)){if(this.attributesRegex(t).test(i.silverPlated))return i.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(t.type))return _get(_getPrototypeOf(WerCreatureType.prototype),"damageModifier",this).call(this,t);return i.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}}]),WerCreatureType}(i),A=function(t){_inherits(VampireType,t);var r=_createSuper(VampireType);function VampireType(){return _classCallCheck(this,VampireType),r.apply(this,arguments)}return _createClass(VampireType,[{key:"damageModifier",value:function damageModifier(t){return["spell","ceremony","liturgy","ritual"].includes(t.type)?_get(_getPrototypeOf(VampireType.prototype),"damageModifier",this).call(this,t):i.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}}]),VampireType}(i)},565:(t,r,a)=>{function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}a.d(r,{Z:()=>o});var o=function(){function DPS(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DPS)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DPS,null,[{key:"rangeFinder",value:function rangeFinder(t,r){var a=canvas.scene.grid.size,o=new Ray(t,r).distance/a,i=o*canvas.scene.grid.distance,c=Math.abs((getProperty(t,"system.elevation")||0)-(getProperty(r,"system.elevation")||0));return{elevation:c,distance:i,distanceSum:Math.hypot(i,c),tileDistance:o,unit:canvas.scene.grid.units}}},{key:"inDistance",value:function inDistance(t){var r,a=_createForOfIteratorHelper(canvas.scene.tokens);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o.isOwner&&this.rangeFinder(t,o.object).tileDistance<=2)return!0}}catch(t){a.e(t)}finally{a.f()}return!1}},{key:"distanceModifier",value:function distanceModifier(t,r,a){if(!game.settings.get("dsa5","enableDPS")||!t)return 1;var o,i={},c=_createForOfIteratorHelper(game.user.targets);try{for(c.s();!(o=c.n()).done;){var u=o.value,l=DPS.rangeFinder(t,u);(i.distanceSum||0)<l.distanceSum&&(i=l)}}catch(t){c.e(t)}finally{c.f()}if(i.unit==game.i18n.localize("gridUnits")){for(var p=Number(getProperty(a,"system.rangeMultiplier"))||1,d=r.system.reach.value.split("/").map((function(t){return Number(t)*p})),h=0;h<2&&d[h]<i.distanceSum;)h++;return h}return 1}},{key:"initDoorMinDistance",value:function initDoorMinDistance(){var t=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(r){return game.user.isGM||!game.settings.get("dsa5","enableDPS")||DPS.inDistance(this)?t.apply(this,arguments):ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"))}}}]),DPS}()},562:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DiceDSA5});var _actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(369),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(577),_dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(538),_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(491),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(272),_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(173),_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(101),_item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(839),_status_status_effects_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(973),_opposed_dsa5_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(600),_status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(61),_dsa_soundeffect_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(803),_equipment_damage_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(702),_dialog_dialog_equipmentdamage_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(266),_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(430),_request_roll_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(903),_measuretemplate_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(174);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function _slicedToArray(t,r){return _arrayWithHoles(t)||_iterableToArrayLimit(t,r)||_unsupportedIterableToArray(t,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=a){var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}var DiceDSA5=function(){function DiceDSA5(){_classCallCheck(this,DiceDSA5)}var _chatListeners,_rollResistPain,_gearDamaged,_rollEdit2,_itemRoll2,_showDiceSoNice,_rollDices,_updateDefenseCount,_rollTest,_rollItem,_rollTalent,_rollThreeD,_rollSpell,_manualRolls,_rollCombatskill,_addRollDiceSoNice2,_detailedWeaponResult,_rollWeapon,_evaluateDamage,_stringToRoll2,_rollCombatTrait,_rollDamage,_damageFormula,_rollAttribute,_rollStatus,_rollRegeneration,_rollSingleD,_getDefenseCount,_setupDialog;return _createClass(DiceDSA5,null,[{key:"setupDialog",value:(_setupDialog=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a,o,i,c,u,l,p,d;return _regeneratorRuntime().wrap((function _callee$(h){for(;;)switch(h.prev=h.next){case 0:return r=t.dialogOptions,a=t.testData,o=t.cardOptions,h.next=3,game.settings.get("core","rollMode");case 3:return i=h.sent,c="challenging","function"==typeof a.source.toObject&&(a.source=a.source.toObject(!1)),mergeObject(a,{testDifficulty:c}),mergeObject(r.data,{testDifficulty:c,testModifier:r.data.modifier||0}),u=r.data.situationalModifiers?r.data.situationalModifiers:a.extra.actor?_status_status_effects_js__WEBPACK_IMPORTED_MODULE_8__.Z.getRollModifiers(a.extra.actor,a.source):[],null!=a.extra.options.moreModifiers&&(l=u).push.apply(l,_toConsumableArray(a.extra.options.moreModifiers)),p=[],game.user.targets.forEach((function(t){t.actor&&p.push({name:t.actor.name,id:t.id,img:t.actor.img})})),h.t0=mergeObject,h.t1=r.data,h.t2=u.length>0,h.t3=u,h.t4=r.data.rollMode||i,h.t5=CONFIG.Dice.rollModes?CONFIG.Dice.rollModes:CONFIG.rollModes,h.next=20,this.getDefenseCount(a);case 20:if(h.t6=h.sent,h.t7=p,h.t8={hasSituationalModifiers:h.t2,situationalModifiers:h.t3,rollMode:h.t4,rollModes:h.t5,defenseCount:h.t6,targets:h.t7},(0,h.t0)(h.t1,h.t8),mergeObject(o,{user:game.user.id}),a.extra.options.bypass){h.next=32;break}return h.next=28,renderTemplate(r.template,r.data);case 28:return d=h.sent,h.abrupt("return",new Promise((function(t,o){var i=_dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getDialogForItem(a.source.type);new i({title:r.title,content:d,buttons:i.getRollButtons(a,r,t,o),default:"rollButton"}).recallSettings(a.extra.speaker,a.source,a.mode).render(!0)})));case 32:return o.rollMode=a.extra.options.rollMode||i,a.situationalModifiers||(a.situationalModifiers=[]),h.abrupt("return",{testData:a,cardOptions:o});case 35:case"end":return h.stop()}}),_callee,this)}))),function setupDialog(t){return _setupDialog.apply(this,arguments)})},{key:"getDefenseCount",value:(_getDefenseCount=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){return _regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:if(!game.combat){r.next=4;break}return r.next=3,game.combat.getDefenseCount(t.extra.speaker);case 3:return r.abrupt("return",r.sent);case 4:return r.abrupt("return",0);case 5:case"end":return r.stop()}}),_callee2)}))),function getDefenseCount(t){return _getDefenseCount.apply(this,arguments)})},{key:"_rollSingleD20",value:(_rollSingleD=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a,o,i){var c,u,l,p,d,h,m,y,g,v,_,b,w,k,x=arguments;return _regeneratorRuntime().wrap((function _callee3$(S){for(;;)switch(S.prev=S.next){case 0:return c=x.length>5&&void 0!==x[5]?x[5]:"",u=x.length>6&&void 0!==x[6]?x[6]:1,l="",p=[],r+=o,r=Math.round(r*u),d=r-t.terms[0].results[0].result,h=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration(a),p.push({char:a,res:t.terms[0].results[0].result,suc:d>=0,tar:r}),S.next=11,new Roll("1d20").evaluate({async:!0});case 11:if(m=S.sent,y=d>=0?1:-1,g=20,v=1,"meleeweapon"==i.source.type&&(g=Math.min(i.extra.actor.system.meleeStats.botch,i.source.system.botch),v=Math.max(i.extra.actor.system.meleeStats.crit,i.source.system.crit)),"rangeweapon"==i.source.type&&(g=Math.min(i.extra.actor.system.rangeStats.botch,i.source.system.botch),v=Math.max(i.extra.actor.system.rangeStats.crit,i.source.system.crit)),/(\(|,)( )?i\)$/.test(i.source.name)&&(_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.hasAbility(i.extra.actor,game.i18n.localize("LocalizedIDs.improvisedWeaponMaster"))||(g=Math.min(19,g)),this._appendSituationalModifiers(i,"".concat(game.i18n.localize("CHAR.ATTACK")," - ").concat(game.i18n.localize("WEAPON.improvised")),2,"defenseMalus")),i.situationalModifiers.find((function(t){return t.name==game.i18n.localize("opportunityAttack")&&0!=t.value}))&&(g=50,v=-50),1!=t.terms[0].results.filter((function(t){return t.result<=v})).length){S.next=41;break}if(l=game.i18n.localize("CriticalSuccess"),!game.settings.get("dsa5","noConfirmationRoll")){S.next=25;break}y=3,S.next=39;break;case 25:return S.next=27,DiceDSA5.manualRolls(m,"confirmationRoll",i.extra.options);case 27:if(m=S.sent,_=r-m.terms[0].results[0].result,!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(i.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.weaponAptitude")," (").concat(c,")"))||_>=0){S.next=36;break}return b=m.terms[0].results[0].result,S.next=33,new Roll("1d20").evaluate({async:!0});case 33:m=S.sent,_=r-m.terms[0].results[0].result,l+=", "+game.i18n.format("usedWeaponExpertise",{a:b,b:m.terms[0].results[0].result});case 36:this._addRollDiceSoNice(i,m,h),p.push({char:a,res:m.terms[0].results[0].result,suc:_>=0,tar:r}),y=_>=0?3:2;case 39:S.next=61;break;case 41:if(1!=t.terms[0].results.filter((function(t){return t.result>=g})).length){S.next=61;break}if(l=game.i18n.localize("CriticalFailure"),!game.settings.get("dsa5","noConfirmationRoll")){S.next=47;break}y=-3,S.next=61;break;case 47:return S.next=49,DiceDSA5.manualRolls(m,"confirmationRoll",i.extra.options);case 49:if(m=S.sent,w=r-m.terms[0].results[0].result,!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(i.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.weaponAptitude")," (").concat(c,")"))||w>=0){S.next=58;break}return k=m.terms[0].results[0].result,S.next=55,new Roll("1d20").evaluate({async:!0});case 55:m=S.sent,w=r-m.terms[0].results[0].result,l+=", "+game.i18n.format("usedWeaponExpertise",{a:k,b:m.terms[0].results[0].result});case 58:this._addRollDiceSoNice(i,m,h),p.push({char:a,res:m.terms[0].results[0].result,suc:w>=0,tar:r}),y=w>=0?-2:-3;case 61:return""==l?l=game.i18n.localize(d>=0?"Success":"Failure"):game.settings.get("dsa5","noConfirmationRoll")||(3==Math.abs(y)?l="".concat(game.i18n.localize("confirmed")," ").concat(l):2==Math.abs(y)&&(l="".concat(game.i18n.localize("unconfirmed")," ").concat(l))),S.abrupt("return",{successLevel:y,characteristics:p,description:l,preData:i,modifiers:o,extra:{}});case 63:case"end":return S.stop()}}),_callee3,this)}))),function _rollSingleD20(t,r,a,o,i){return _rollSingleD.apply(this,arguments)})},{key:"rollRegeneration",value:(_rollRegeneration=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){var r,a,o,i,c,u,l,p,d,h,m,y;return _regeneratorRuntime().wrap((function _callee4$(g){for(;;)switch(g.prev=g.next){case 0:if(r=this._situationalModifiers(t),a=t.roll,o=[],i={rollType:"regenerate",preData:t,modifiers:r,extra:{}},c=[],t.regenerateLeP&&c.push("LeP"),t.extra.actor.system.isMage&&t.regenerateAsP&&c.push("AsP"),t.extra.actor.system.isPriest&&t.regenerateKaP&&c.push("KaP"),u=0,t.extra.actor.effects.some((function(t){return"sick"==getProperty(t,"flags.core.statusId")}))){this._appendSituationalModifiers(t,game.i18n.localize("CONDITION.sick"),"*0"),l=_createForOfIteratorHelper(c);try{for(l.s();!(p=l.n()).done;)d=p.value,o.push({char:d,res:0,die:"d6"}),i[d]=0,u+=2}catch(t){l.e(t)}finally{l.f()}}else{h=_createForOfIteratorHelper(c);try{for(h.s();!(m=h.n()).done;)y=m.value,this._appendSituationalModifiers(t,game.i18n.localize("LocalizedIDs.regeneration".concat(y)),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(t.extra.actor,game.i18n.localize("LocalizedIDs.regeneration".concat(y))),y),this._appendSituationalModifiers(t,game.i18n.localize("LocalizedIDs.weakRegeneration".concat(y)),-1*_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(t.extra.actor,game.i18n.localize("LocalizedIDs.weakRegeneration".concat(y))),y),this._appendSituationalModifiers(t,game.i18n.localize("LocalizedIDs.advancedRegeneration".concat(y)),_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.abilityStep(t.extra.actor,game.i18n.localize("LocalizedIDs.advancedRegeneration".concat(y))),y),this._appendSituationalModifiers(t,"".concat(game.i18n.localize("CHARAbbrev.".concat(y))," ").concat(game.i18n.localize("Modifier")),t["".concat(y,"Modifier")],y),this._appendSituationalModifiers(t,"".concat(game.i18n.localize("CHARAbbrev.".concat(y))," ").concat(game.i18n.localize("regenerate")),t["regeneration".concat(y)],y),o.push({char:y,res:a.terms[u].results[0].result,die:"d6"}),i[y]=Math.round(Math.max(0,Number(a.terms[u].results[0].result)+Number(r)+this._situationalModifiers(t,y))*Number(t.regenerationFactor)),u+=2}catch(t){h.e(t)}finally{h.f()}}return i.characteristics=o,g.abrupt("return",i);case 13:case"end":return g.stop()}}),_callee4,this)}))),function rollRegeneration(t){return _rollRegeneration.apply(this,arguments)})},{key:"rollStatus",value:(_rollStatus=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:if(i.t0=t.roll,i.t0){i.next=5;break}return i.next=4,new Roll("1d20").evaluate({async:!0});case 4:i.t0=i.sent;case 5:return r=i.t0,i.next=8,this._rollSingleD20(r,t.source.system.max,t.extra.statusId,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 8:if((a=i.sent).rollType="dodge",!(o="dodge"==t.extra.statusId)||3!=a.successLevel){i.next=21;break}return i.next=14,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalMeleeDefense");case 14:if(!i.sent){i.next=18;break}a.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalMeleeDefense",!1),i.next=19;break;case 18:a.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultParryCrit();case 19:i.next=32;break;case 21:if(!o||-3!=a.successLevel){i.next=32;break}return i.next=24,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Defense");case 24:if(!i.sent){i.next=28;break}a.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Defense",!0),i.next=32;break;case 28:return i.t1=a.description,i.next=31,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultBotch();case 31:a.description=i.t1+=i.sent;case 32:return i.abrupt("return",a);case 33:case"end":return i.stop()}}),_callee5,this)}))),function rollStatus(t){return _rollStatus.apply(this,arguments)})},{key:"rollAttribute",value:(_rollAttribute=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t){var r,a;return _regeneratorRuntime().wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:if(!t.roll){o.next=4;break}o.t0=t.roll,o.next=7;break;case 4:return o.next=6,new Roll("1d20").evaluate({async:!0});case 6:o.t0=o.sent;case 7:return r=o.t0,this._appendSituationalModifiers(t,game.i18n.localize("Difficulty"),t.testDifficulty),o.next=11,this._rollSingleD20(r,t.source.system.value,t.extra.characteristicId,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 11:return(a=o.sent).rollType="attribute",o.abrupt("return",a);case 14:case"end":return o.stop()}}),_callee6,this)}))),function rollAttribute(t){return _rollAttribute.apply(this,arguments)})},{key:"damageFormula",value:(_damageFormula=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:return"meleeweapon"==t.source.type?(a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.extra.actor.items.find((function(r){return"combatskill"==r.type&&r.name==t.source.system.combatskill.value})),t.extra.actor.system),r=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareMeleeWeapon(t.source,[a],t.extra.actor)):"rangeweapon"==t.source.type?(o=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.extra.actor.items.find((function(r){return"combatskill"==r.type&&r.name==t.source.system.combatskill.value})),t.extra.actor.system),r=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareRangeWeapon(t.source,[],[o],t.extra.actor)):r=t.source.system,i.abrupt("return",t.source.system.damage.value.replace(/[Ww]/g,"d")+"+".concat(r.extraDamage||0));case 2:case"end":return i.stop()}}),_callee7)}))),function damageFormula(t){return _damageFormula.apply(this,arguments)})},{key:"rollDamage",value:(_rollDamage=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t){var r,a,o,i,c,u,l,p,d,h;return _regeneratorRuntime().wrap((function _callee8$(m){for(;;)switch(m.prev=m.next){case 0:r=this._situationalModifiers(t),a=[],o=t.roll,i=o.total+r,c=_createForOfIteratorHelper(o.terms);try{for(c.s();!(u=c.n()).done;)if((l=u.value)instanceof Die||"Die"==l.class){p=_createForOfIteratorHelper(l.results);try{for(p.s();!(d=p.n()).done;)h=d.value,a.push({char:t.mode,res:h.result,die:"d"+l.faces})}catch(t){p.e(t)}finally{p.f()}}}catch(t){c.e(t)}finally{c.f()}return m.abrupt("return",{rollType:"damage",damage:i,characteristics:a,preData:t,modifiers:r,extra:{}});case 7:case"end":return m.stop()}}),_callee8,this)}))),function rollDamage(t){return _rollDamage.apply(this,arguments)})},{key:"_situationalModifiers",value:function _situationalModifiers(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return t.situationalModifiers.reduce((function(t,a){return t+((a.type==r||""==r&&null==a.type)&&Number(a.value)||0)}),0)}},{key:"_situationalPartCheckModifiers",value:function _situationalPartCheckModifiers(t){return t.situationalModifiers.reduce((function(t,r){if("TPM"==r.type){var a=r.value.split("|");return 3!=a.length||(t[0]=t[0]+Number(a[0]),t[1]=t[1]+Number(a[1]),t[2]=t[2]+Number(a[2])),t}return t}),[0,0,0])}},{key:"_situationalMultipliers",value:function _situationalMultipliers(t){return t.situationalModifiers.reduce((function(t,r){return t*("*"==r.type&&Number("".concat(r.value).replace(/,/,"."))||1)}),1)}},{key:"_appendSituationalModifiers",value:function _appendSituationalModifiers(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",i=t.situationalModifiers.find((function(t){return t.name==r}));i?i.value=a:t.situationalModifiers.push({name:r,value:a,type:o})}},{key:"_getNarrowSpaceModifier",value:function _getNarrowSpaceModifier(t,r){return r.narrowSpace?game.i18n.localize("LocalizedIDs.Shields")==t.system.combatskill.value?_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.narrowSpaceModifiers["shield"+t.system.reach.shieldSize][r.mode]:_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.narrowSpaceModifiers["weapon"+t.system.reach.value][r.mode]:0}},{key:"rollCombatTrait",value:(_rollCombatTrait=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(t){var r,a,o,i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee9$(d){for(;;)switch(d.prev=d.next){case 0:if(d.t0=t.roll,d.t0){d.next=5;break}return d.next=4,new Roll("1d20").evaluate({async:!0});case 4:d.t0=d.sent;case 5:return r=d.t0,a=t.source,o="meleeAttack"==a.system.traitType.value,i="attack"==t.mode,o?(c={system:{combatskill:{value:"-"},reach:{value:a.system.reach.value}}},this._appendSituationalModifiers(t,game.i18n.localize("narrowSpace"),this._getNarrowSpaceModifier(c,t)),this._appendSituationalModifiers(t,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(c,t))):this._appendSituationalModifiers(t,game.i18n.localize("distance"),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.rangeMods[t.rangeModifier||"medium"].attack),d.next=12,this._rollSingleD20(r,Number(i?a.system.at.value:a.system.pa),t.mode,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 12:return u=d.sent,l=u.successLevel>0,d.next=16,this.detailedWeaponResult(u,t,a);case 16:if(!i||!l){d.next=19;break}return d.next=19,DiceDSA5.evaluateDamage(t,u,a,!o,u.doubleDamage);case 19:return u.rollType="weapon",(p=DiceDSA5.parseEffect(a))&&(u.parsedEffect=p),d.abrupt("return",u);case 23:case"end":return d.stop()}}),_callee9,this)}))),function rollCombatTrait(t){return _rollCombatTrait.apply(this,arguments)})},{key:"_stringToRoll",value:(_stringToRoll2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t,r){var a,o,i,c,u;return _regeneratorRuntime().wrap((function _callee10$(l){for(;;)switch(l.prev=l.next){case 0:return a=[],o=/\d{1}[dDwW]\d/g,(i="".concat(t)).replace(o,(function(t){a.push(new Roll(t.replace(/[Ww]/,"d")).evaluate({async:!0}))})),l.next=6,Promise.all(a);case 6:return c=l.sent,u=i.replace(o,(function(){var t=c.shift();return r&&DiceDSA5._addRollDiceSoNice(r,t,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),t.total})),l.next=10,Roll.safeEval(u);case 10:return l.abrupt("return",l.sent);case 11:case"end":return l.stop()}}),_callee10)}))),function _stringToRoll(t,r){return _stringToRoll2.apply(this,arguments)})},{key:"evaluateDamage",value:(_evaluateDamage=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(t,r,a,o,i){var c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T,A,O,P,E,C,D,I,R,L,G,M,j;return _regeneratorRuntime().wrap((function _callee11$(z){for(;;)switch(z.prev=z.next){case 0:c=a.system.damage.value.replace(/[Ww]/g,"d"),u=[],l=a.dmgMultipliers||[],p=l.map((function(t){return"".concat(t.name," *").concat(t.val)})),d=[],h=0,m=_createForOfIteratorHelper(t.situationalModifiers),z.prev=7,m.s();case 9:if((y=m.n()).done){z.next=33;break}if(g=y.value,v=0,g.armorPen&&d.push(g.armorPen),!g.damageBonus){z.next=31;break}if(!/^\*/.test(g.damageBonus)){z.next=17;break}return l.push({name:g.name,val:Number(g.damageBonus.replace("*",""))}),z.abrupt("continue",31);case 17:return _=/^=/.test(g.damageBonus),b="".concat(g.damageBonus).replace(/^=/,""),z.next=21,DiceDSA5._stringToRoll(b,t);case 21:if(w=z.sent,v=w*(g.step||1),!_){z.next=29;break}return c=b.replace(/[Ww]/,"d"),u.push({name:g.name,roll:w}),z.abrupt("continue",31);case 29:g.damageBonus=w,h+=v;case 31:z.next=9;break;case 33:z.next=38;break;case 35:z.prev=35,z.t0=z.catch(7),m.e(z.t0);case 38:return z.prev=38,m.f(),z.finish(38);case 41:if(!t.damageRoll){z.next=47;break}return z.next=44,t.damageRoll;case 44:z.t1=z.sent,z.next=55;break;case 47:return z.t2=DiceDSA5,z.next=50,new Roll(c).evaluate({async:!0});case 50:return z.t3=z.sent,z.t4=t.extra.options,z.next=54,z.t2.manualRolls.call(z.t2,z.t3,"CHAR.DAMAGE",z.t4);case 54:z.t1=z.sent;case 55:k=z.t1,x=k.total,S=0,T=_createForOfIteratorHelper(k.terms);try{for(T.s();!(A=T.n()).done;)if((O=A.value)instanceof Die||"Die"==O.class){P=_createForOfIteratorHelper(O.results);try{for(P.s();!(E=P.n()).done;)C=E.value,S+=Number(C.result),r.characteristics.push({char:"damage",res:C.result,die:"d"+O.faces})}catch(t){P.e(t)}finally{P.f()}}}catch(t){T.e(t)}finally{T.f()}if(D=x-S,!(u.length>0)){z.next=65;break}p.push(u[0].name+" "+x),z.next=76;break;case 65:return x+=h,p.push(game.i18n.localize("Roll")+" "+S),0!=D&&p.push(game.i18n.localize("weaponModifier")+" "+D),t.situationalModifiers.reduce((function(t,r){if(r.damageBonus){var a=/^\*/.test(r.damageBonus)?r.damageBonus:Number(r.damageBonus)*(r.step||1);p.push("".concat(r.name," ").concat(a))}}),p),t.situationalModifiers.find((function(t){return t.name.indexOf(game.i18n.localize("CONDITION.bloodrush"))>-1}))&&(x+=2,p.push(game.i18n.localize("CONDITION.bloodrush")+" 2")),a.extraDamage&&(x=Number(a.extraDamage)+Number(x),p.push(game.i18n.localize("damageThreshold")+" "+a.extraDamage)),o?(R=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.rangeMods[t.rangeModifier||"medium"].damage,x+=R,0!=R&&p.push(game.i18n.localize("distance")+" "+R),I=t.extra.actor.system.rangeStats.damage):I=t.extra.actor.system.meleeStats.damage,z.next=74,DiceDSA5._stringToRoll(I,t);case 74:0!=(L=z.sent)&&(x+=L,p.push(game.i18n.localize("statuseffects")+" "+L));case 76:i&&(x*=2,p.push(game.i18n.localize("doubleDamage"))),G=_createForOfIteratorHelper(l);try{for(G.s();!(M=G.n()).done;)j=M.value,x*=j.val}catch(t){G.e(t)}finally{G.f()}r.armorPen=d,r.damagedescription=p.join(", "),r.damage=Math.round(x),r.damageRoll=duplicate(k);case 83:case"end":return z.stop()}}),_callee11,null,[[7,35,38,41]])}))),function evaluateDamage(t,r,a,o,i){return _evaluateDamage.apply(this,arguments)})},{key:"rollWeapon",value:(_rollWeapon=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(t){var r,a,o,i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee12$(d){for(;;)switch(d.prev=d.next){case 0:if(d.t0=t.roll,d.t0){d.next=5;break}return d.next=4,new Roll("1d20").evaluate({async:!0});case 4:d.t0=d.sent;case 5:return r=d.t0,o=t.source,i=o.system.combatskill.value,c=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.extra.actor.items.find((function(t){return"combatskill"==t.type&&t.name==i})),t.extra.actor.system),(u="meleeweapon"==o.type)?(a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareMeleeWeapon(o,[c],t.extra.actor),this._appendSituationalModifiers(t,game.i18n.localize("narrowSpace"),this._getNarrowSpaceModifier(a,t)),"attack"==t.mode&&this._appendSituationalModifiers(t,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(a,t))):(a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareRangeWeapon(o,[],[c],t.extra.actor),this._appendSituationalModifiers(t,game.i18n.localize("distance"),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.rangeMods[t.rangeModifier||"medium"].attack)),d.next=13,this._rollSingleD20(r,a[t.mode],t.mode,this._situationalModifiers(t),t,i,this._situationalMultipliers(t));case 13:return l=d.sent,d.next=16,this.detailedWeaponResult(l,t,o);case 16:if(!("attack"==t.mode&&l.successLevel>0)){d.next=19;break}return d.next=19,DiceDSA5.evaluateDamage(t,l,a,!u,l.doubleDamage);case 19:return l.rollType="weapon",(p=DiceDSA5.parseEffect(a))&&(l.parsedEffect=p),d.abrupt("return",l);case 23:case"end":return d.stop()}}),_callee12,this)}))),function rollWeapon(t){return _rollWeapon.apply(this,arguments)})},{key:"detailedWeaponResult",value:(_detailedWeaponResult=_asyncToGenerator(_regeneratorRuntime().mark((function _callee13(t,r,a){var o,i,c;return _regeneratorRuntime().wrap((function _callee13$(u){for(;;)switch(u.prev=u.next){case 0:o="attack"==r.mode,i="meleeweapon"==a.type||"meleeAttack"==getProperty(a,"system.traitType.value"),u.t0=t.successLevel,u.next=3===u.t0?5:-3===u.t0?34:2===u.t0?67:-2===u.t0?69:70;break;case 5:if(!o){u.next=17;break}return u.next=8,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalAttack");case 8:if(!u.sent){u.next=12;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalAttack",!1),u.next=14;break;case 12:t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultAttackCrit(!0),t.doubleDamage=!0;case 14:t.halfDefense=!0,u.next=33;break;case 17:if(u.t1=r.isRangeDefense,!u.t1){u.next=22;break}return u.next=21,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalRangeDefense");case 21:u.t1=u.sent;case 22:if(!u.t1){u.next=26;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalRangeDefense",!1),u.next=33;break;case 26:return u.next=28,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalMeleeDefense");case 28:if(!u.sent){u.next=32;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalMeleeDefense",!1),u.next=33;break;case 32:t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultParryCrit();case 33:return u.abrupt("break",70);case 34:if(c=getProperty(a,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle")||"trait"==a.type,u.t2=o&&i,!u.t2){u.next=40;break}return u.next=39,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Melee");case 39:u.t2=u.sent;case 40:if(!u.t2){u.next=44;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Melee",c),u.next=66;break;case 44:if(u.t3=o,!u.t3){u.next=49;break}return u.next=48,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Range");case 48:u.t3=u.sent;case 49:if(!u.t3){u.next=53;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Range",!1),u.next=66;break;case 53:if(u.t4=!o,!u.t4){u.next=58;break}return u.next=57,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Defense");case 57:u.t4=u.sent;case 58:if(!u.t4){u.next=62;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Defense",c),u.next=66;break;case 62:return u.t5=t.description,u.next=65,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultBotch();case 65:t.description=u.t5+=u.sent;case 66:return u.abrupt("break",70);case 67:return o&&(t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultAttackCrit(!1),t.halfDefense=!0),u.abrupt("break",70);case 69:return u.abrupt("break",70);case 70:case"end":return u.stop()}}),_callee13)}))),function detailedWeaponResult(t,r,a){return _detailedWeaponResult.apply(this,arguments)})},{key:"_addRollDiceSoNice",value:(_addRollDiceSoNice2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee14(t,r,a){var o;return _regeneratorRuntime().wrap((function _callee14$(i){for(;;)switch(i.prev=i.next){case 0:if(!t.rollMode){i.next=4;break}for(o=0;o<r.dice.length;o++)mergeObject(r.dice[o].options,a);return i.next=4,this.showDiceSoNice(r,t.rollMode);case 4:case"end":return i.stop()}}),_callee14,this)}))),function _addRollDiceSoNice(t,r,a){return _addRollDiceSoNice2.apply(this,arguments)})},{key:"rollCombatskill",value:(_rollCombatskill=_asyncToGenerator(_regeneratorRuntime().mark((function _callee15(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee15$(i){for(;;)switch(i.prev=i.next){case 0:if(!t.roll){i.next=4;break}i.t0=t.roll,i.next=7;break;case 4:return i.next=6,new Roll("1d20").evaluate({async:!0});case 6:i.t0=i.sent;case 7:return r=i.t0,a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.source,t.extra.actor.system),i.next=11,this._rollSingleD20(r,a.system[t.mode].value,t.mode,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 11:return o=i.sent,i.next=14,this.detailedWeaponResult(o,t,a);case 14:return o.rollType="combatskill",i.abrupt("return",o);case 16:case"end":return i.stop()}}),_callee15,this)}))),function rollCombatskill(t){return _rollCombatskill.apply(this,arguments)})},{key:"manualRolls",value:(_manualRolls=_asyncToGenerator(_regeneratorRuntime().mark((function _callee16(t){var r,a,o,i,c,u,l,p,d,h,m,y,g,v,_,b=arguments;return _regeneratorRuntime().wrap((function _callee16$(w){for(;;)switch(w.prev=w.next){case 0:if(r=b.length>1&&void 0!==b[1]?b[1]:"",!(a=b.length>2&&void 0!==b[2]?b[2]:{}).cheat&&!game.settings.get("dsa5","allowPhysicalDice")){w.next=21;break}if(a.predefinedResult){w.next=20;break}o=!1,c=[],u=_createForOfIteratorHelper(t.terms);try{for(u.s();!(l=u.n()).done;)if((p=l.value)instanceof Die||"Die"==p.class){d=_createForOfIteratorHelper(p.results);try{for(d.s();!(h=d.n()).done;)m=h.value,c.push({faces:p.faces,val:m.result})}catch(t){d.e(t)}finally{d.f()}}}catch(t){u.e(t)}finally{u.f()}return w.next=10,renderTemplate("systems/dsa5/templates/dialog/manualroll-dialog.html",{dice:c,description:r});case 10:return y=w.sent,w.next=13,new Promise((function(t,r){new _dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z({title:game.i18n.localize(a.cheat?"DIALOG.cheat":"DSASETTINGS.allowPhysicalDice"),content:y,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(r){t([!0,r])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function callback(){t([!1,0])}}}}).render(!0)}));case 13:g=w.sent,v=_slicedToArray(g,2),o=v[0],i=v[1],o&&(_=[],i.find(".dieInput").each((function(t){var r=Number($(this).val());r>0&&_.push({val:r,index:t}),t++})),t.editRollAtIndex(_)),w.next=21;break;case 20:t.editRollAtIndex(a.predefinedResult);case 21:return w.abrupt("return",t);case 22:case"end":return w.stop()}}),_callee16)}))),function manualRolls(t){return _manualRolls.apply(this,arguments)})},{key:"parseEffect",value:function parseEffect(t){var r=t.system.effect?t.system.effect.value:void 0,a=[];if(r){var o,i=/^[a-z]+\|[a-zA-z ]+$/,c=_createForOfIteratorHelper(r.split(";"));try{for(c.s();!(o=c.n()).done;){var u=o.value;i.test(u.trim())&&function(){var t=u.split("|").map((function(t){return t.trim()}));if("condition"==t[0]){var r=CONFIG.statusEffects.find((function(r){return r.id==t[1]}));a.push('<a class="chat-condition chatButton" data-id="'.concat(r.id,'">\n                            <img src="').concat(r.icon,'"/>').concat(game.i18n.localize(r.label),"\n                            </a>"))}else a.push('<a class="roll-button roll-item" data-name="'.concat(t[1],'" data-type="').concat(t[0],'"><i class="fas fa-dice"></i>').concat(game.i18n.localize(t[0]),": ").concat(t[1],"</a>"))}()}}catch(t){c.e(t)}finally{c.f()}}var l=getProperty(t,"flags.dsa5.poison");return l&&a.push('<a class="roll-button roll-item" data-removecharge="'.concat(!l.permanent,'" data-name="').concat(l.name,'" data-type="poison"><i class="fas fa-dice"></i>').concat(game.i18n.localize("poison"),": ").concat(l.name,"</a>")),a.join(", ")}},{key:"calculateEnergyCost",value:function calculateEnergyCost(t,r,a){var o,i,c,u,l=[];if(r.successLevel<0){var p=["traditionWitch","traditionFjarning","braniborian"].map((function(t){return game.i18n.localize("LocalizedIDs.".concat(t))})),d=a.extra.actor.items.some((function(t){return"specialability"==t.type&&p.includes(t.name)}))?3:2;r.preData.calculatedSpellModifiers.finalcost=Math.round(r.preData.calculatedSpellModifiers.finalcost/d)}t?(u="KaPCost",o=game.i18n.localize("LocalizedIDs.weakKarmicBody"),i=game.i18n.localize("LocalizedIDs.".concat(r.successLevel>0?"mightyKarmaControl":"karmaControl")),c={val:"kapModifier",name:"KaP"}):(u="AsPCost",o=game.i18n.localize("LocalizedIDs.weakAstralBody"),i=game.i18n.localize("LocalizedIDs.".concat(r.successLevel>0?"energyControl":"smallEnergyControl")),c={val:"aspModifier",name:"AsP"}),l.push({name:o,value:_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(a.extra.actor,o)},{name:i,value:-1*_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.abilityStep(a.extra.actor,i)},{name:"".concat(game.i18n.localize("statuseffects")," (").concat(game.i18n.localize("CHARAbbrev."+c.name),")"),value:a.extra.actor.system[c.val]+this._situationalModifiers(a,u)}),l=l.filter((function(t){return 0!=t.value})),r.preData.calculatedSpellModifiers.description=l.map((function(t){return"".concat(t.name," ").concat(t.value)})).join("\n"),r.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(r.preData.calculatedSpellModifiers.finalcost)+l.reduce((function(t,r){return t+r.value}),0)),r.successLevel>0&&0!=r.preData.calculatedSpellModifiers.maintainCost&&(r.preData.calculatedSpellModifiers.finalcost+=Number(r.preData.calculatedSpellModifiers.maintainCost.split(" ")[0]))}},{key:"rollSpell",value:(_rollSpell=_asyncToGenerator(_regeneratorRuntime().mark((function _callee17(t){var r,a,o,i,c,u,l,p,d,h,m,y,g,v,_,b,w;return _regeneratorRuntime().wrap((function _callee17$(k){for(;;)switch(k.prev=k.next){case 0:return k.next=2,this._rollThreeD20(t);case 2:if(r=k.sent,a=["ceremony","liturgy"].includes(t.source.type),r.rollType=t.source.type,r.preData.calculatedSpellModifiers.finalcost=r.preData.calculatedSpellModifiers.cost,!(r.successLevel>=2)){k.next=16;break}return k.next=9,new Roll("1d6").evaluate({async:!0});case 9:o=k.sent.total,r.description=r.description+", "+game.i18n.localize("additionalFPs")+" "+o,r.result+=o,r.qualityStep=Math.min(game.settings.get("dsa5","capQSat"),Math.ceil(r.result/3)),r.preData.calculatedSpellModifiers.finalcost=Math.round(r.preData.calculatedSpellModifiers.cost/2),k.next=17;break;case 16:r.successLevel<=-2&&(r.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton(a?"Liturgy":"Spell",!1));case 17:if(!(r.successLevel>0)){k.next=50;break}if(""==t.source.system.effectFormula.value){k.next=50;break}i=t.source.system.effectFormula.value.replace(game.i18n.localize("CHARAbbrev.QS"),r.qualityStep).replace(/[Ww]/g,"d"),c=[],u=_createForOfIteratorHelper(t.situationalModifiers);try{for(u.s();!(l=u.n()).done;)(p=l.value).armorPen&&c.push(p.armorPen)}catch(t){u.e(t)}finally{u.f()}if(/(,|;)/.test(i)&&(i=i.split(/[,;]/)[r.qualityStep-1]),!t.damageRoll){k.next=28;break}k.t0=t.damageRoll,k.next=36;break;case 28:return k.t1=DiceDSA5,k.next=31,new Roll(i).evaluate({async:!0});case 31:return k.t2=k.sent,k.t3=t.extra.options,k.next=35,k.t1.manualRolls.call(k.t1,k.t2,"CHAR.DAMAGE",k.t3);case 35:k.t0=k.sent;case 36:d=k.t0,this._addRollDiceSoNice(t,d,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),r.calculatedEffectFormula=i,h=_createForOfIteratorHelper(d.terms);try{for(h.s();!(m=h.n()).done;)if((y=m.value)instanceof Die||"Die"==y.class){g=_createForOfIteratorHelper(y.results);try{for(g.s();!(v=g.n()).done;)_=v.value,r.characteristics.push({char:"effect",res:_.result,die:"d"+y.faces})}catch(t){g.e(t)}finally{g.f()}}}catch(t){h.e(t)}finally{h.f()}return b=[],k.next=44,DiceDSA5._stringToRoll(t.extra.actor.system[a?"liturgyStats":"spellStats"].damage,t);case 44:0!=(w=k.sent)&&b.push(game.i18n.localize("statuseffects")+" "+w),r.armorPen=c,r.damageRoll=d,r.damage=d.total+w,r.damagedescription=b.join("\n");case 50:if(this.calculateEnergyCost(a,r,t),!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(t.extra.actor,game.i18n.localize("CONDITION.minorSpirits"))||t.extra.actor.effects.find((function(t){return t.label==game.i18n.localize("CONDITION.minorSpirits")}))){k.next=56;break}return k.next=54,new Roll("1d20").evaluate({async:!0});case 54:k.sent.total<=r.preData.calculatedSpellModifiers.finalcost&&(r.description+=", "+game.i18n.localize("minorghostsappear"),_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(t.extra.speaker).addCondition("minorSpirits"));case 56:return k.abrupt("return",r);case 57:case"end":return k.stop()}}),_callee17,this)}))),function rollSpell(t){return _rollSpell.apply(this,arguments)})},{key:"_rollThreeD20",value:(_rollThreeD=_asyncToGenerator(_regeneratorRuntime().mark((function _callee18(t){var r,a,o,i,c,u,l,p,d,h,m,y,g,v,_,b,w,k;return _regeneratorRuntime().wrap((function _callee18$(x){for(;;)switch(x.prev=x.next){case 0:if(!t.roll){x.next=4;break}x.t0=Roll.fromData(t.roll),x.next=7;break;case 4:return x.next=6,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 6:x.t0=x.sent;case 7:if(r=x.t0,a=[],o=0,this._appendSituationalModifiers(t,game.i18n.localize("Difficulty"),t.testDifficulty),i=this._situationalModifiers(t),c=t.source.system.talentValue.value+t.advancedModifiers.fws+this._situationalModifiers(t,"FW"),u=this._situationalPartCheckModifiers(t,"TPM"),l=[1,2,3].map((function(r){return t.extra.actor.system.characteristics[t.source.system["characteristic".concat(r)].value].value+i+t.advancedModifiers.chars[r-1]+u[r-1]})),p=[0,1,2].map((function(t){return r.terms[2*t].results[0].result-l[t]})),t.routine)c=Math.round(c/2);else{d=_createForOfIteratorHelper(p);try{for(d.s();!(h=d.n()).done;)(m=h.value)>0&&(c-=m)}catch(t){d.e(t)}finally{d.f()}}if(y=t.extra.actor.system.skillModifiers.crit,g=t.extra.actor.system.skillModifiers.botch,"spell"!=t.source.type&&"ritual"!=t.source.type||!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(t.extra.actor,game.i18n.localize("LocalizedIDs.wildMagic"))||(g=19),"skill"!=t.source.type||!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(t.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.incompetent")," (").concat(t.source.name,")"))){x.next=31;break}return x.next=23,new Roll("1d20").evaluate({async:!0});case 23:v=x.sent,_=p.reduce((function(t,r,a,o){return r<o[t]?a:t}),0),b=r.terms[2*_].total,c+=Math.max(p[_],0),c-=Math.max(0,v.total-l[_]),r.editRollAtIndex([{index:_,val:v.total}]),this._addRollDiceSoNice(t,v,r.terms[2*_].options),a.push(game.i18n.format("CHATNOTIFICATION.unableReroll",{die:_+1,oldVal:b,newVal:v.total}));case 31:return w=0,"skill"==t.source.type&&_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__.Z.hasTrait(t.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.automaticSuccess")," (").concat(t.source.name,")"))?(a.push(game.i18n.localize("LocalizedIDs.automaticSuccess")),o=1,w=1):"skill"==t.source.type&&_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__.Z.hasTrait(t.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.automaticFail")," (").concat(t.source.name,")"))?(a.push(game.i18n.localize("LocalizedIDs.automaticFail")),o=-1):(o=DiceDSA5.get3D20SuccessLevel(r,c,g,y),t.routine&&(o=1),a.push(DiceDSA5.getSuccessDescription(o))),a=a.join(", "),k=0,o>0&&(c+=this._situationalModifiers(t,"FP"),k=Math.max(1,(0==c?1:c>0?Math.ceil(c/3):0)+(null!=t.qualityStep?Number(t.qualityStep):0))+(t.advancedModifiers.qls||0)+this._situationalModifiers(t,"QL")),(k=Math.min(game.settings.get("dsa5","capQSat"),k))<w&&(k=w),x.abrupt("return",{result:c,characteristics:[0,1,2].map((function(a){return{char:t.source.system["characteristic".concat(a+1)].value,res:r.terms[2*a].results[0].result,suc:p[a]<=0,tar:l[a]}})),qualityStep:k,description:a,preData:t,successLevel:o,modifiers:i,extra:{}});case 39:case"end":return x.stop()}}),_callee18,this)}))),function _rollThreeD20(t){return _rollThreeD.apply(this,arguments)})},{key:"rollTalent",value:(_rollTalent=_asyncToGenerator(_regeneratorRuntime().mark((function _callee19(t){var r;return _regeneratorRuntime().wrap((function _callee19$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this._rollThreeD20(t);case 2:return(r=a.sent).rollType="talent",a.abrupt("return",r);case 5:case"end":return a.stop()}}),_callee19,this)}))),function rollTalent(t){return _rollTalent.apply(this,arguments)})},{key:"get3D20SuccessLevel",value:function get3D20SuccessLevel(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=t.terms.filter((function(t){return t.results&&t.results[0].result<=o})).length,c=t.terms.filter((function(t){return t.results&&t.results[0].result>=a})).length;return i>=2?i:c>=2?-1*c:r>=0?1:-1}},{key:"getSuccessDescription",value:function getSuccessDescription(t){return game.i18n.localize(["AstoundingFailure","CriticalFailure","Failure","","Success","CriticalSuccess","AstoundingSuccess"][t+3])}},{key:"rollItem",value:(_rollItem=_asyncToGenerator(_regeneratorRuntime().mark((function _callee20(t){var r,a,o,i,c,u,l,p,d,h,m,y,g,v,_;return _regeneratorRuntime().wrap((function _callee20$(b){for(;;)switch(b.prev=b.next){case 0:if(b.t0=t.roll,b.t0){b.next=5;break}return b.next=4,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 4:b.t0=b.sent;case 5:r=b.t0,a=[],o=this._situationalModifiers(t),i=Number(t.source.system.step.value),c=[1,2,3].map((function(r){return 10+Number(t.source.system.step.value)+o})),u=[0,1,2].map((function(t){return r.terms[2*t].results[0].result-c[t]})),l=_createForOfIteratorHelper(u);try{for(l.s();!(p=l.n()).done;)(d=p.value)>0&&(i-=d)}catch(t){l.e(t)}finally{l.f()}h=DiceDSA5.get3D20SuccessLevel(r,i,20),a.push(DiceDSA5.getSuccessDescription(h)),a=a.join(", "),m={result:i,characteristics:[0,1,2].map((function(a){return{char:t.source.type,res:r.terms[2*a].results[0].result,suc:u[a]<=0,tar:c[a]}})),qualityStep:Math.min(game.settings.get("dsa5","capQSat"),(0==i?1:i>0?Math.ceil(i/3):0)+(null!=t.qualityStep?Number(t.qualityStep):0)),description:a,preData:t,successLevel:h,modifiers:o,extra:{}},b.t1=t.source.type,b.next="poison"===b.t1?21:"disease"===b.t1?26:31;break;case 21:return y=t.source.system.duration.value.split(" / ").map((function(t){return t.trim()})),g=t.source.system.effect.value.split(" / ").map((function(t){return t.trim()})),m.duration=y.length>1?m.successLevel>0?y[0]:y[1]:y[0],m.effect=g.length>1?m.successLevel>0?g[0]:g[1]:g[0],b.abrupt("break",31);case 26:return v=t.source.system.damage.value.split(" / ").map((function(t){return t.trim()})),_=t.source.system.duration.value.split(" / ").map((function(t){return t.trim()})),m.damageeffect=v.length>1?m.successLevel>0?v[0]:v[1]:v[0],m.duration=_.length>1?m.successLevel>0?_[0]:_[1]:_[0],b.abrupt("break",31);case 31:return b.abrupt("return",m);case 32:case"end":return b.stop()}}),_callee20,this)}))),function rollItem(t){return _rollItem.apply(this,arguments)})},{key:"rollTest",value:(_rollTest=_asyncToGenerator(_regeneratorRuntime().mark((function _callee21(t){var r;return _regeneratorRuntime().wrap((function _callee21$(a){for(;;)switch(a.prev=a.next){case 0:a.t0=t.source.type,a.next="ceremony"===a.t0||"ritual"===a.t0||"liturgy"===a.t0||"spell"===a.t0?3:"skill"===a.t0?7:"combatskill"===a.t0?11:"trait"===a.t0?15:"regenerate"===a.t0?29:"meleeweapon"===a.t0||"rangeweapon"===a.t0?33:"dodge"===a.t0?47:"poison"===a.t0||"disease"===a.t0?53:57;break;case 3:return a.next=5,this.rollSpell(t);case 5:return r=a.sent,a.abrupt("break",60);case 7:return a.next=9,this.rollTalent(t);case 9:return r=a.sent,a.abrupt("break",60);case 11:return a.next=13,this.rollCombatskill(t);case 13:return r=a.sent,a.abrupt("break",60);case 15:if("parry"!=t.mode){a.next=18;break}return a.next=18,this.updateDefenseCount(t);case 18:if("damage"!=t.mode){a.next=24;break}return a.next=21,this.rollDamage(t);case 21:a.t1=a.sent,a.next=27;break;case 24:return a.next=26,this.rollCombatTrait(t);case 26:a.t1=a.sent;case 27:return r=a.t1,a.abrupt("break",60);case 29:return a.next=31,this.rollRegeneration(t);case 31:return r=a.sent,a.abrupt("break",60);case 33:if("parry"!=t.mode){a.next=36;break}return a.next=36,this.updateDefenseCount(t);case 36:if("damage"!=t.mode){a.next=42;break}return a.next=39,this.rollDamage(t);case 39:a.t2=a.sent,a.next=45;break;case 42:return a.next=44,this.rollWeapon(t);case 44:a.t2=a.sent;case 45:return r=a.t2,a.abrupt("break",60);case 47:return a.next=49,this.updateDefenseCount(t);case 49:return a.next=51,this.rollStatus(t);case 51:return r=a.sent,a.abrupt("break",60);case 53:return a.next=55,this.rollItem(t);case 55:return r=a.sent,a.abrupt("break",60);case 57:return a.next=59,this.rollAttribute(t);case 59:r=a.sent;case 60:return mergeObject(r,deepClone(t.extra)),a.abrupt("return",r);case 62:case"end":return a.stop()}}),_callee21,this)}))),function rollTest(t){return _rollTest.apply(this,arguments)})},{key:"updateDefenseCount",value:(_updateDefenseCount=_asyncToGenerator(_regeneratorRuntime().mark((function _callee22(t){return _regeneratorRuntime().wrap((function _callee22$(r){for(;;)switch(r.prev=r.next){case 0:if(!game.combat){r.next=3;break}return r.next=3,game.combat.updateDefenseCount(t.extra.speaker);case 3:case"end":return r.stop()}}),_callee22)}))),function updateDefenseCount(t){return _updateDefenseCount.apply(this,arguments)})},{key:"_compareWeaponReach",value:function _compareWeaponReach(t,r){var a=r.situationalModifiers.find((function(t){return t.name==game.i18n.localize("LocalizedIDs.circumvent")})),o=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.meleeRangesArray.indexOf(t.system.reach.value),i=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.meleeRangesArray.indexOf(r.opposingWeaponSize);return a&&i>o&&(a.value=2*Math.min(a.step,i-o)),2*Math.min(0,o-i)}},{key:"rollDices",value:(_rollDices=_asyncToGenerator(_regeneratorRuntime().mark((function _callee23(t,r){var a,o,i,c,u,l;return _regeneratorRuntime().wrap((function _callee23$(p){for(;;)switch(p.prev=p.next){case 0:if(t.roll){p.next=63;break}a=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration,p.t0=t.source.type,p.next="liturgy"===p.t0||"spell"===p.t0||"ceremony"===p.t0||"ritual"===p.t0||"skill"===p.t0?5:"regenerate"===p.t0?12:"meleeweapon"===p.t0||"rangeweapon"===p.t0||"weaponless"===p.t0||"combatskill"===p.t0||"trait"===p.t0?24:"dodge"===p.t0?39:"poison"===p.t0||"disease"===p.t0?44:52;break;case 5:return p.next=7,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 7:return o=p.sent,mergeObject(o.dice[0].options,a(t.source.system.characteristic1.value)),mergeObject(o.dice[1].options,a(t.source.system.characteristic2.value)),mergeObject(o.dice[2].options,a(t.source.system.characteristic3.value)),p.abrupt("break",56);case 12:return i=[],t.regenerateLeP&&i.push([game.settings.get("dsa5","lessRegeneration")?"1d3":"1d6"]),t.extra.actor.isMage&&t.regenerateAsP&&i.push("1d6"),t.extra.actor.isPriest&&t.regenerateKaP&&i.push("1d6"),p.next=18,new Roll(i.join("+")).evaluate({async:!0});case 18:return o=p.sent,t.regenerateLeP&&mergeObject(o.dice[0].options,a("mu")),t.extra.actor.isMage&&t.regenerateAsP&&mergeObject(o.dice[i.length-1].options,a("ge")),t.extra.actor.isPriest&&t.regenerateKaP&&mergeObject(o.dice[i.length-1].options,a("in")),t.extra.actor.isMage&&t.regenerateAsP&&t.extra.actor.isPriest&&t.regenerateKaP&&mergeObject(o.dice[i.length-2].options,a("ge")),p.abrupt("break",56);case 24:if("damage"!=t.mode){p.next=34;break}return p.next=27,this.damageFormula(t);case 27:return c=p.sent,p.next=30,new Roll(c).evaluate({async:!0});case 30:for(o=p.sent,u=0;u<o.dice.length;u++)mergeObject(o.dice[u].options,a("damage"));p.next=38;break;case 34:return p.next=36,new Roll("1d20").evaluate({async:!0});case 36:o=p.sent,mergeObject(o.dice[0].options,a(t.mode));case 38:return p.abrupt("break",56);case 39:return p.next=41,new Roll("1d20").evaluate({async:!0});case 41:return o=p.sent,mergeObject(o.dice[0].options,a("dodge")),p.abrupt("break",56);case 44:return l=a("in"),p.next=47,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 47:return o=p.sent,mergeObject(o.dice[0].options,l),mergeObject(o.dice[1].options,l),mergeObject(o.dice[2].options,l),p.abrupt("break",56);case 52:return p.next=54,new Roll("1d20").evaluate({async:!0});case 54:o=p.sent,mergeObject(o.dice[0].options,a(t.source.system.label.split(".")[1].toLowerCase()));case 56:return p.next=58,DiceDSA5.manualRolls(o,t.source.type,t.extra.options);case 58:return o=p.sent,p.next=61,this.showDiceSoNice(o,r.rollMode);case 61:t.roll=o,t.rollMode=r.rollMode;case 63:return p.abrupt("return",t);case 64:case"end":return p.stop()}}),_callee23,this)}))),function rollDices(t,r){return _rollDices.apply(this,arguments)})},{key:"showDiceSoNice",value:(_showDiceSoNice=_asyncToGenerator(_regeneratorRuntime().mark((function _callee24(t,r){var a,o,i;return _regeneratorRuntime().wrap((function _callee24$(c){for(;;)switch(c.prev=c.next){case 0:if(!_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.moduleEnabled("dice-so-nice")){c.next=17;break}a=null,o=!1,c.t0=r,c.next="blindroll"===c.t0?6:"gmroll"===c.t0?9:"selfroll"===c.t0?11:13;break;case 6:return o=!0,a=game.users.filter((function(t){return t.isGM})).map((function(t){return t.id})),c.abrupt("break",13);case 9:return a=game.users.filter((function(t){return t.isGM})).map((function(t){return t.id})),c.abrupt("break",13);case 11:return a=[],c.abrupt("break",13);case 13:if(i=game.dice3d.showForRoll(t,game.user,!0,a,o),game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")){c.next=17;break}return c.next=17,i;case 17:case"end":return c.stop()}}),_callee24)}))),function showDiceSoNice(t,r){return _showDiceSoNice.apply(this,arguments)})},{key:"addApplyEffectData",value:function addApplyEffectData(t){var r=t.preData.source;if(["spell","liturgy","ritual","ceremony","meleeweapon","rangeweapon"].includes(r.type)){if(t.successLevel>0&&r.effects.length>0)return!0}else if(["disease","poison"].includes(r.type))return r.effects.length>0;var a=t.preData.situationalModifiers.filter((function(t){return t.specAbId})).map((function(t){return t.specAbId}));if(a.length>0){var o,i=_createForOfIteratorHelper(t.preData.extra.actor.items.filter((function(t){return a.includes(t._id)})));try{for(i.s();!(o=i.n()).done;){if(o.value.effects.length>0)return!0}}catch(t){i.e(t)}finally{i.f()}}return!1}},{key:"renderRollCard",value:function(){var _renderRollCard=_asyncToGenerator(_regeneratorRuntime().mark((function _callee25(chatOptions,testData,rerenderMessage){var applyEffect,preData,hideDamage,hasAreaTemplate,chatData,html,actor,rollData,enriched,postFunction,newMsg;return _regeneratorRuntime().wrap((function _callee25$(_context25){for(;;)switch(_context25.prev=_context25.next){case 0:return applyEffect=this.addApplyEffectData(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:"attack"==preData.mode,_context25.next=5,Hooks.call("postProcessDSARoll",chatOptions,testData,rerenderMessage,hideDamage);case 5:return delete preData.extra.actor,delete testData.actor,delete testData.preData,hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsa5.config.areaTargetTypes,_context25.t0=chatOptions.title,_context25.t1=testData,_context25.t2=game.user.isGM,_context25.t3=preData,_context25.t4=hideDamage,_context25.t5=preData.situationalModifiers.filter((function(t){return 0!=t.value})),_context25.t6=applyEffect,_context25.t7=hasAreaTemplate,_context25.next=19,_equipment_damage_js__WEBPACK_IMPORTED_MODULE_12__.Z.showDamageToGear(preData,testData);case 19:if(_context25.t8=_context25.sent,chatData={title:_context25.t0,testData:_context25.t1,hideData:_context25.t2,preData:_context25.t3,hideDamage:_context25.t4,modifierList:_context25.t5,applyEffect:_context25.t6,hasAreaTemplate:_context25.t7,showDamageToGear:_context25.t8},preData.advancedModifiers&&(preData.advancedModifiers.chars.some((function(t){return 0!=t}))&&chatData.modifierList.push({name:game.i18n.localize("MODS.partChecks"),value:preData.advancedModifiers.chars}),0!=preData.advancedModifiers.fws&&chatData.modifierList.push({name:game.i18n.localize("MODS.FW"),value:preData.advancedModifiers.fws}),0!=preData.advancedModifiers.qls&&chatData.modifierList.push({name:game.i18n.localize("MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter((function(t){return t.isGM})).map((function(t){return t.id}))),"blindroll"===chatOptions.rollMode?chatOptions.blind=!0:"selfroll"===chatOptions.rollMode&&(chatOptions.whisper=[game.user.id]),_dsa_soundeffect_js__WEBPACK_IMPORTED_MODULE_11__.Z.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSARoll:!0},rerenderMessage){_context25.next=35;break}return _context25.next=29,renderTemplate(chatOptions.template,chatData);case 29:return chatOptions.content=_context25.sent,_context25.next=32,ChatMessage.create(chatOptions,!1);case 32:return _context25.abrupt("return",_context25.sent);case 35:return _context25.next=37,renderTemplate(chatOptions.template,chatData);case 37:return html=_context25.sent,actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{},_context25.next=42,TextEditor.enrichHTML(html,{rollData,async:!0});case 42:return enriched=_context25.sent,chatOptions.content=enriched,postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction"),postFunction&&(testData.messageId=rerenderMessage.id,eval(postFunction.functionName)(postFunction,{result:testData},preData.source)),_context25.next=48,rerenderMessage.update(_defineProperty({content:chatOptions.content},"flags.data",chatOptions["flags.data"]));case 48:return newMsg=_context25.sent,ui.chat.updateMessage(newMsg),_context25.abrupt("return",newMsg);case 51:case"end":return _context25.stop()}}),_callee25,this)})));function renderRollCard(t,r,a){return _renderRollCard.apply(this,arguments)}return renderRollCard}()},{key:"_itemRoll",value:(_itemRoll2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee27(t){var r,a,o,i,c,u,l,p,d,h;return _regeneratorRuntime().wrap((function _callee27$(m){for(;;)switch(m.prev=m.next){case 0:if(r=$(t.currentTarget),a=r.parents(".message").attr("data-message-id"),o=game.messages.get(a),i=o.speaker,c=r.attr("data-type"),u=r.attr("data-name"),!(l=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(i))){m.next=15;break}if(!(p=l.items.find((function(t){return t.name==u&&t.type==c})))){m.next=14;break}if(d=new _item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__.Z(p.toObject(),{temporary:!0}),!(h=!!r.attr("data-removecharge")&&"true"==r.attr("data-removecharge"))){m.next=11;break}if(!(d.system.quantity.value<1)){m.next=11;break}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges")),m.abrupt("return");case 11:d.setupEffect().then(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee26(t){return _regeneratorRuntime().wrap((function _callee26$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,d.itemTest(t);case 2:if(!h){r.next=5;break}return r.next=5,p.update({"system.quantity.value":p.system.quantity.value-1});case 5:case"end":return r.stop()}}),_callee26)})));return function(r){return t.apply(this,arguments)}}()),m.next=15;break;case 14:ui.notifications.error(game.i18n.format("DSAError.notFound",{category:c,name:u}));case 15:case"end":return m.stop()}}),_callee27)}))),function _itemRoll(t){return _itemRoll2.apply(this,arguments)})},{key:"_rollEdit",value:(_rollEdit2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee28(t){var r,a,o,i,c,u,l,p,d,h,m;return _regeneratorRuntime().wrap((function _callee28$(y){for(;;)switch(y.prev=y.next){case 0:r=$(t.currentTarget),a=r.parents(".message").attr("data-message-id"),o=game.messages.get(a),i=o.flags.data,(c=i.preData).extra.actor=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(c.extra.speaker).toObject(!1),c.extra.options.cheat&&delete c.extra.options.cheat,y.t0=r.attr("data-edit-type"),y.next="roll"===y.t0?8:"mod"===y.t0?12:17;break;case 8:return u=r.attr("data-edit-id"),l=Number(r.val()),c.roll.terms.length>2*u?((p=Roll.fromData(c.roll)).editRollAtIndex([{index:u,val:l}]),c.roll=p):(d=Roll.fromData(i.postData.damageRoll),u-=c.roll.terms.filter((function(t){return t.results})).length,d.editRollAtIndex([{index:u,val:l}]),c.damageRoll=d),y.abrupt("break",17);case 12:return(u=c.situationalModifiers.findIndex((function(t){return t.name==game.i18n.localize("chatEdit")})))>0&&c.situationalModifiers.splice(u,1),h={name:game.i18n.localize("chatEdit"),value:Number(r.val())-this._situationalModifiers(c)},c.situationalModifiers.push(h),y.abrupt("break",17);case 17:m={template:i.template,rollMode:i.rollMode,title:i.title,speaker:o.speaker,user:o.user.id},["gmroll","blindroll"].includes(m.rollMode)&&(m.whisper=game.users.filter((function(t){return t.isGM})).map((function(t){return t.id}))),"blindroll"===m.rollMode&&(m.blind=!0),["poison","disease"].includes(c.source.type)?new _item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__.Z(c.source,{temporary:!0})["".concat(i.postData.postFunction)]({testData:c,cardOptions:m},{rerenderMessage:o}):_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(o.speaker)["".concat(i.postData.postFunction)]({testData:c,cardOptions:m},{rerenderMessage:o});case 21:case"end":return y.stop()}}),_callee28,this)}))),function _rollEdit(t){return _rollEdit2.apply(this,arguments)})},{key:"gearDamaged",value:(_gearDamaged=_asyncToGenerator(_regeneratorRuntime().mark((function _callee29(t){var r,a;return _regeneratorRuntime().wrap((function _callee29$(o){for(;;)switch(o.prev=o.next){case 0:if(!((r=t.currentTarget.dataset.uuid.split(";")).length>1)){o.next=8;break}return o.next=4,Promise.all(r.map((function(t){return fromUuid(t)})));case 4:a=o.sent,_dialog_dialog_equipmentdamage_js__WEBPACK_IMPORTED_MODULE_13__.Z.showDialog(a),o.next=13;break;case 8:return o.t0=_equipment_damage_js__WEBPACK_IMPORTED_MODULE_12__.Z,o.next=11,fromUuid(r[0]);case 11:o.t1=o.sent,o.t0.breakingTest.call(o.t0,o.t1);case 13:case"end":return o.stop()}}),_callee29)}))),function gearDamaged(t){return _gearDamaged.apply(this,arguments)})},{key:"rollResistPain",value:(_rollResistPain=_asyncToGenerator(_regeneratorRuntime().mark((function _callee30(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee30$(i){for(;;)switch(i.prev=i.next){case 0:r=t.currentTarget.dataset,a={token:r.token,actor:r.actor,scene:canvas.id},(o=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(a))&&o.finishResistPainRoll();case 4:case"end":return i.stop()}}),_callee30)}))),function rollResistPain(t){return _rollResistPain.apply(this,arguments)})},{key:"chatListeners",value:(_chatListeners=_asyncToGenerator(_regeneratorRuntime().mark((function _callee34(t){return _regeneratorRuntime().wrap((function _callee34$(r){for(;;)switch(r.prev=r.next){case 0:t.on("click",".expand-mods",(function(t){t.preventDefault();var r=$(t.currentTarget);r.find("i").toggleClass("fa-minus fa-plus"),r.siblings("ul,div").fadeToggle()})),t.on("click",".edit-toggle",(function(t){t.preventDefault(),$(t.currentTarget).parents(".chat-card").find(".display-toggle").toggle()})),t.on("click",".botch-roll",(function(t){return _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.showBotchCard(t.currentTarget.dataset)})),t.on("click",".roll-item",(function(t){return DiceDSA5._itemRoll(t)})),t.on("click",".gearDamaged",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee31(t){return _regeneratorRuntime().wrap((function _callee31$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",DiceDSA5.gearDamaged(t));case 1:case"end":return r.stop()}}),_callee31)})));return function(r){return t.apply(this,arguments)}}()),t.on("change",".roll-edit",(function(t){return DiceDSA5._rollEdit(t)})),t.on("click",".applyEffect",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee32(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee32$(i){for(;;)switch(i.prev=i.next){case 0:if(!(r=$(t.currentTarget)).hasClass("locked")){i.next=3;break}return i.abrupt("return");case 3:return r.addClass("locked"),r.prepend('<i class="fas fa-spinner fa-spin"></i>'),a=r.parents(".message").attr("data-message-id"),o=t.currentTarget.dataset.target,i.next=9,_status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__.Z.applyEffect(a,o);case 9:setTimeout((function(){r.removeClass("locked"),r.find("i").remove()}),2e3);case 10:case"end":return i.stop()}}),_callee32)})));return function(r){return t.apply(this,arguments)}}()),t.on("click",".placeTemplate",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee33(t){return _regeneratorRuntime().wrap((function _callee33$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",_measuretemplate_js__WEBPACK_IMPORTED_MODULE_16__.c.placeTemplateFromChat(t));case 1:case"end":return r.stop()}}),_callee33)})));return function(r){return t.apply(this,arguments)}}()),t.on("click",".message-delete",(function(t){var r=game.messages.get($(t.currentTarget).parents(".message").attr("data-message-id"));if(r.flags.unopposeData){var a=canvas.tokens.get(r.flags.unopposeData.targetSpeaker.token);_opposed_dsa5_js__WEBPACK_IMPORTED_MODULE_9__.Z.clearOpposed(a.actor)}})),t.on("click",".resistEffect",(function(t){return _status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__.Z.resistEffect(t)})),t.on("click",".resistPain",(function(t){return DiceDSA5.rollResistPain(t)})),_request_roll_js__WEBPACK_IMPORTED_MODULE_15__.Z.chatListeners(t);case 12:case"end":return r.stop()}}),_callee34)}))),function chatListeners(t){return _chatListeners.apply(this,arguments)})}]),DiceDSA5}()},803:(t,r,a)=>{function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}a.d(r,{Z:()=>o});var o=function(){function DSA5SoundEffect(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSA5SoundEffect)}var t,r,a,o,i,c;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5SoundEffect,null,[{key:"playEffect",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r,a){var o,i,c,u=arguments;return _regeneratorRuntime().wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:return o=u.length>3&&void 0!==u[3]?u[3]:void 0,i=u.length>4&&void 0!==u[4]&&u[4],l.next=4,this.getSound(t,r,a);case 4:if(c=l.sent)try{o?(game.socket.emit("system.dsa5",{type:"playWhisperSound",payload:{whisper:o,soundPath:c}}),i||AudioHelper.play({src:c,volume:.8,loop:!1},!1)):AudioHelper.play({src:c,volume:.8,loop:!1},!0)}catch(t){console.warn("Could not play item sound effect ".concat(c))}case 6:case"end":return l.stop()}}),_callee,this)}))),function playEffect(t,r,a){return c.apply(this,arguments)})},{key:"loadSoundConfig",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var t,r,a;return _regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,game.settings.get("dsa5","soundConfig");case 2:if(!(t=o.sent)){o.next=18;break}return o.prev=4,o.next=7,fetch(t);case 7:return r=o.sent,o.next=10,r.json();case 10:a=o.sent,this.sounds=a,console.log("DSA5 | Sound Config Loaded"),o.next=18;break;case 15:o.prev=15,o.t0=o.catch(4),console.warn(o.t0);case 18:case"end":return o.stop()}}),_callee2,this,[[4,15]])}))),function loadSoundConfig(){return i.apply(this,arguments)})},{key:"successLevelToString",value:function successLevelToString(t){switch(t){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}},{key:"getSound",value:(o=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a){var o,i,c,u,l,p,d;return _regeneratorRuntime().wrap((function _callee3$(h){for(;;)switch(h.prev=h.next){case 0:if(this.sounds||this.triedInit){h.next=4;break}return h.next=3,this.loadSoundConfig();case 3:this.triedInit=!0;case 4:if(this.sounds){h.next=6;break}return h.abrupt("return",void 0);case 6:i=this.successLevelToString(a),c=[],h.t0=r.type,h.next="meleeweapon"===h.t0||"rangeweapon"===h.t0?11:"skill"===h.t0?13:"liturgy"===h.t0||"spell"===h.t0||"ceremony"===h.t0||"ritual"===h.t0?15:17;break;case 11:return c=[].concat(_toConsumableArray(i.map((function(a){return"".concat(r.type,".manual.").concat(r.name,".").concat(t,"_").concat(a)}))),["".concat(r.type,".manual.").concat(r.name,".").concat(t),"".concat(r.type,".manual.").concat(r.name,".default.").concat(t),"".concat(r.type,".manual.").concat(r.name,".default")],_toConsumableArray(i.map((function(a){return"".concat(r.type,".").concat(r.system.combatskill.value,".").concat(t,"_").concat(a)}))),["".concat(r.type,".").concat(r.system.combatskill.value,".").concat(t)],_toConsumableArray(i.map((function(t){return"".concat(r.type,".").concat(r.system.combatskill.value,".default_").concat(t)}))),["".concat(r.type,".").concat(r.system.combatskill.value,".default")]),h.abrupt("break",17);case 13:case 15:return c=[].concat(_toConsumableArray(i.map((function(a){return"".concat(r.type,".").concat(r.name,".").concat(t,"_").concat(a)}))),["".concat(r.type,".").concat(r.name,".").concat(t)],_toConsumableArray(i.map((function(t){return"".concat(r.type,".").concat(r.name,".default_").concat(t)}))),["".concat(r.type,".").concat(r.name,".default")]),h.abrupt("break",17);case 17:(o=c).push.apply(o,_toConsumableArray(i.map((function(t){return"".concat(r.type,".default_").concat(t)}))).concat(["".concat(r.type,".default")])),l=_createForOfIteratorHelper(c),h.prev=19,l.s();case 21:if((p=l.n()).done){h.next=30;break}if(d=p.value,hasProperty(this.sounds,d)){h.next=25;break}return h.abrupt("continue",28);case 25:if(!(u=getProperty(this.sounds,d))||!("string"==typeof u||u instanceof String)){h.next=28;break}return h.abrupt("break",30);case 28:h.next=21;break;case 30:h.next=35;break;case 32:h.prev=32,h.t1=h.catch(19),l.e(h.t1);case 35:return h.prev=35,l.f(),h.finish(35);case 38:return h.abrupt("return",u);case 39:case"end":return h.stop()}}),_callee3,this,[[19,32,35,38]])}))),function getSound(t,r,a){return o.apply(this,arguments)})},{key:"playMoneySound",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(){var t,r,a,o=arguments;return _regeneratorRuntime().wrap((function _callee4$(i){for(;;)switch(i.prev=i.next){case 0:if(t=o.length>0&&void 0!==o[0]&&o[0],game.modules.get("gAudioBundle-3")){i.next=3;break}return i.abrupt("return");case 3:return a=(r=["modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"])[Math.floor(Math.random()*r.length)],i.next=7,this.playSoundPath(a,t);case 7:case"end":return i.stop()}}),_callee4,this)}))),function playMoneySound(){return a.apply(this,arguments)})},{key:"playEquipmentWearStatusChange",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t){var r,a,o,i,c,u,l=arguments;return _regeneratorRuntime().wrap((function _callee5$(p){for(;;)switch(p.prev=p.next){case 0:r=l.length>1&&void 0!==l[1]&&l[1],a=[],o=game.modules.get("gAudioBundle-2"),i=game.modules.get("gAudioBundle-3"),c=game.modules.get("gAudioBundle-4"),p.t0=t.type,p.next="armor"===p.t0?8:"meleeweapon"===p.t0?10:"rangeweapon"===p.t0?13:15;break;case 8:return o&&a.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg"),p.abrupt("break",15);case 10:return o&&a.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),i&&a.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg"),p.abrupt("break",15);case 13:return c&&a.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg"),p.abrupt("break",15);case 15:if(0==a.length&&o&&a.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg"),!(a.length>0)){p.next=20;break}return u=a[Math.floor(Math.random()*a.length)],p.next=20,this.playSoundPath(u,r,.5);case 20:case"end":return p.stop()}}),_callee5,this)}))),function playEquipmentWearStatusChange(t){return r.apply(this,arguments)})},{key:"playSoundPath",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t){var r,a,o=arguments;return _regeneratorRuntime().wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:if(r=o.length>1&&void 0!==o[1]&&o[1],a=o.length>2&&void 0!==o[2]?o[2]:.8,game.settings.get("dsa5","inventorySound")){i.next=4;break}return i.abrupt("return");case 4:try{AudioHelper.play({src:t,volume:a,loop:!1},r)}catch(r){console.warn("Could not play item sound effect ".concat(t))}case 5:case"end":return i.stop()}}),_callee6)}))),function playSoundPath(r){return t.apply(this,arguments)})}]),DSA5SoundEffect}();_defineProperty(o,"sounds",void 0),_defineProperty(o,"triedInit",!1)},702:(t,r,a)=>{a.d(r,{Z:()=>p});var o=a(5),i=a(577),c=a(472),u=a(562),l=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var p=function(){function EquipmentDamage(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,EquipmentDamage)}var t,r,a;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(EquipmentDamage,null,[{key:"armorWearModifier",value:function armorWearModifier(t,r){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(EquipmentDamage.calculateWear(t)){case 1:case 2:r-=1;break;case 3:case 4:r=0}return Math.max(0,Number(r))}},{key:"armorGetsDamage",value:function armorGetsDamage(t,r){return(t>14||r.successLevel>2)&&game.settings.get("dsa5","armorAndWeaponDamage")}},{key:"armorEncumbranceModifier",value:function armorEncumbranceModifier(t){return game.settings.get("dsa5","armorAndWeaponDamage")&&EquipmentDamage.calculateWear(t)>1?1:0}},{key:"showDamageToGear",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){var a,o,i,c,u;return _regeneratorRuntime().wrap((function _callee$(p){for(;;)switch(p.prev=p.next){case 0:if(!game.settings.get("dsa5","armorAndWeaponDamage")){p.next=11;break}if(a=l.Z.getSpeaker(t.extra.speaker),o=0,(i=getProperty(a,"flags.oppose.messageId"))&&(c=game.messages.get(i))&&(o=getProperty(c,"flags.data.postData.successLevel")||0),!((u=t.source)._id&&u.system.structure&&(r.successLevel<-2||o>2)&&["meleeweapon","rangeweapon","armor"].includes(u.type))){p.next=11;break}return p.next=9,l.Z.getSpeaker(r.speaker);case 9:return a=p.sent,p.abrupt("return",a.items.get(u._id).uuid);case 11:return p.abrupt("return",void 0);case 12:case"end":return p.stop()}}),_callee)}))),function showDamageToGear(t,r){return a.apply(this,arguments)})},{key:"breakingTest",value:function breakingTest(t){if(!t)return ui.notifications.warn(game.i18n.format("DSAError.notfound",{category:"",name:game.i18n.localize("equipment")}));if(t.system.structure.max<=0)return ui.notifications.warn(game.i18n.format("DSAError.noBreakingStructure",{name:t.name}));var r,a=0;if("armor"==t.type?(r=game.i18n.localize("ARMORSUBCATEGORIES.".concat(t.system.subcategory)),a=getProperty(t,"structure.breakPointRating")||i.Z.armorSubcategories[t.system.subcategory]):(r=t.system.combatskill.value,a=getProperty(t,"structure.breakPointRating")||i.Z.weaponStabilities[game.i18n.localize("LocalizedCTs.".concat(r))]),a){var u="",l=getProperty(t,"effect.attributes")||"";l.includes(c.Z.clerical)?u="".concat(game.i18n.format("WEAPON.attributeWarning",{domain:c.Z.clerical}),"<br/>"):l.includes(c.Z.magical)&&(u="".concat(game.i18n.format("WEAPON.attributeWarning",{domain:c.Z.magical}),"<br/>")),new o.Z({title:game.i18n.localize("DSASETTINGS.armorAndWeaponDamage"),content:"".concat(u,'<label for="threshold">').concat(game.i18n.format("WEAR.check",{category:r}),'</label>: <input class="quantity-click" style="width:80px" dtype="number" name="threshold" type="number" value="').concat(a,'"/>'),buttons:{Yes:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:function callback(a){EquipmentDamage.resolveBreakingTest(t,Number(a.find('[name="threshold"]').val()),r)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else ui.notifications.error(game.i18n.format("DSAError.noBreakingResistance",{item:t.name}))}},{key:"applyDamageLevelToItem",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a;return _regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return a=Math.ceil(.25*t.system.structure.max)*r,o.next=3,t.update({"system.structure.value":Math.max(0,t.system.structure.value-a)});case 3:case"end":return o.stop()}}),_callee2)}))),function applyDamageLevelToItem(t,a){return r.apply(this,arguments)})},{key:"resolveBreakingTest",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a){var o,i,c,p;return _regeneratorRuntime().wrap((function _callee3$(d){for(;;)switch(d.prev=d.next){case 0:return d.t0=u.Z,d.next=3,new Roll("1d20").evaluate({async:!0});case 3:return d.t1=d.sent,d.t2=game.i18n.format("WEAR.check",{category:a}),d.next=7,d.t0.manualRolls.call(d.t0,d.t1,d.t2);case 7:return o=d.sent,d.t3=u.Z,d.t4=o,d.next=12,game.settings.get("core","rollMode");case 12:return d.t5=d.sent,d.next=15,d.t3.showDiceSoNice.call(d.t3,d.t4,d.t5);case 15:return i=o.total>r?1:0,d.next=18,this.applyDamageLevelToItem(t,i);case 18:return c=EquipmentDamage.calculateWear(t.data),d.next=21,renderTemplate("systems/dsa5/templates/system/breakingtest.html",{wear:c,item:t,threshold:r,category:a,roll:o,result:game.i18n.localize("WEAR.".concat(t.type,".").concat(c))});case 21:p=d.sent,ChatMessage.create(l.Z.chatDataSetup(p));case 23:case"end":return d.stop()}}),_callee3,this)}))),function resolveBreakingTest(r,a,o){return t.apply(this,arguments)})},{key:"damageTooltip",value:function damageTooltip(t){if(game.settings.get("dsa5","armorAndWeaponDamage")){var r=this.calculateWear(t);return{msg:game.i18n.localize("WEAR.".concat(t.type,".").concat(r)),css:"gearD damaged".concat(r)}}return{msg:"",css:""}}},{key:"weaponWearModifier",value:function weaponWearModifier(t){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(EquipmentDamage.calculateWear(t)){case 1:t.attack-=1,t.parry&&(t.parry-=1);break;case 2:t.attack-=2,t.parry&&(t.parry-=2);break;case 3:case 4:t.attack=0,t.parry&&(t.parry=0)}}},{key:"calculateWear",value:function calculateWear(t){return!t.system.structure||Number(t.system.structure.max<=0)?0:Math.floor(4*(1-t.system.structure.value/t.system.structure.max))}}]),EquipmentDamage}()},794:(t,r,a)=>{a.d(r,{Z:()=>c});var o=a(577),i=a(491);function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var c=function(){function ItemRulesDSA5(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,ItemRulesDSA5)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(ItemRulesDSA5,null,[{key:"getTalentBonus",value:function getTalentBonus(t,r,a){var o,c=[],u=game.settings.get("dsa5","talentModifierEnabled"),l=_createForOfIteratorHelper(t.items.filter((function(t){return a.includes(t.type)&&t.system.effect.value.includes(r)})));try{for(l.s();!(o=l.n()).done;){var p,d=o.value,h=_createForOfIteratorHelper(d.system.effect.value.split(/;|,/));try{for(h.s();!(p=h.n()).done;){var m=p.value;if(m.includes(r)){var y=i.Z.parseAbilityString(m.trim());y.name==r&&c.push({name:d.name,value:y.step*(d.system.step?d.system.step.value:1),type:y.type,selected:u,source:d.name})}}}catch(t){h.e(t)}finally{h.f()}}}catch(t){l.e(t)}finally{l.f()}return c}},{key:"simpleAdoption",value:function simpleAdoption(t,r,a,o){if(o[a].effect&&(t.system.effect.value="".concat(r.name," ").concat(o[a].effect)),o[a].activeEffect){var i=duplicate(o[a].activeEffect);i.value="".concat(r.name," ").concat(i.value);var c={changes:[i],duration:{},icon:"icons/svg/aura.svg",label:"".concat(a," (").concat(r.name,")"),transfer:!0,flags:{dsa5:{value:null,editable:!0,description:"".concat(a," (").concat(r.name,")"),custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}},tint:""};t.effects.push(c)}}},{key:"reverseAdoptionCalculation",value:function reverseAdoptionCalculation(t,r,a){for(var i=[o.Z.vantagesNeedingAdaption,o.Z.AbilitiesNeedingAdaption],c=function _loop(){var o=l[u];if(o[r.name]){var i=t.items.find((function(t){return o[r.name].items.includes(t.type)&&t.name==r.special}));return i&&(a.system.APValue.value=a.system.APValue.value.split("/")[i.system.StF.value.charCodeAt(0)-65],ItemRulesDSA5.simpleAdoption(a,i,r.name,o)),"break"}},u=0,l=i;u<l.length;u++){if("break"===c())break}return a}},{key:"hasItem",value:function hasItem(t,r,a){return null!=t.items.find((function(t){return a.includes(t.type)&&t.name==r}))}},{key:"itemStep",value:function itemStep(t,r,a){var o=t.items.find((function(t){return a.includes(t.type)&&t.name==r}));return o?Number((o.system,o.system.step.value)):0}},{key:"itemAsModifier",value:function itemAsModifier(t,r,a,o){var c=arguments.length>4&&void 0!==arguments[4]&&arguments[4],u=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=[],p=c?new RegExp("^".concat(i.Z.escapeRegex("".concat(r," (")))):new RegExp("^".concat(i.Z.escapeRegex(r),"$")),d=t.items.find((function(t){return o.includes(t.type)&&p.test(t.name)}));return d&&l.push({name:d.name,value:Number((d.system,d.system.step.value))*a,selected:u,source:d.name}),l}}]),ItemRulesDSA5}();!function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}(c,"children",{})},174:(t,r,a)=>{function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _classPrivateFieldInitSpec(t,r,a){!function _checkPrivateRedeclaration(t,r){if(r.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}(t,r),r.set(t,a)}function _classPrivateFieldGet(t,r){return function _classApplyDescriptorGet(t,r){if(r.get)return r.get.call(t);return r.value}(t,_classExtractFieldDescriptor(t,r,"get"))}function _classPrivateFieldSet(t,r,a){return function _classApplyDescriptorSet(t,r,a){if(r.set)r.set.call(t,a);else{if(!r.writable)throw new TypeError("attempted to set read only private field");r.value=a}}(t,_classExtractFieldDescriptor(t,r,"set"),a),a}function _classExtractFieldDescriptor(t,r,a){if(!r.has(t))throw new TypeError("attempted to "+a+" private field on non-instance");return r.get(t)}a.d(r,{c:()=>u});var o=new WeakMap,i=new WeakMap,c=new WeakMap,u=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(MeasuredTemplateDSA,MeasuredTemplate);var r,a,u,l,p=_createSuper(MeasuredTemplateDSA);function MeasuredTemplateDSA(){var t;_classCallCheck(this,MeasuredTemplateDSA);for(var r=arguments.length,a=new Array(r),u=0;u<r;u++)a[u]=arguments[u];return _classPrivateFieldInitSpec(_assertThisInitialized(t=p.call.apply(p,[this].concat(a))),o,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(_assertThisInitialized(t),i,{writable:!0,value:0}),_classPrivateFieldInitSpec(_assertThisInitialized(t),c,{writable:!0,value:void 0}),t}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(MeasuredTemplateDSA,[{key:"drawPreview",value:function drawPreview(){var t=canvas.activeLayer;return this.draw(),this.layer.activate(),this.layer.preview.addChild(this),this.activatePreviewListeners(t)}},{key:"activatePreviewListeners",value:function activatePreviewListeners(t){var r=this;return new Promise((function(a,i){_classPrivateFieldSet(r,o,t),_classPrivateFieldSet(r,c,{cancel:r._onCancelPlacement.bind(r),confirm:r._onConfirmPlacement.bind(r),move:r._onMovePlacement.bind(r),resolve:a,reject:i,rotate:r._onRotatePlacement.bind(r)}),canvas.stage.on("mousemove",_classPrivateFieldGet(r,c).move),canvas.stage.on("mousedown",_classPrivateFieldGet(r,c).confirm),canvas.app.view.oncontextmenu=_classPrivateFieldGet(r,c).cancel,canvas.app.view.onwheel=_classPrivateFieldGet(r,c).rotate}))}},{key:"_finishPlacement",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r;return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return this.layer._onDragLeftCancel(t),canvas.stage.off("mousemove",_classPrivateFieldGet(this,c).move),canvas.stage.off("mousedown",_classPrivateFieldGet(this,c).confirm),canvas.app.view.oncontextmenu=null,canvas.app.view.onwheel=null,_classPrivateFieldGet(this,o).activate(),a.next=8,null===(r=this.actorSheet)||void 0===r?void 0:r.maximize();case 8:case"end":return a.stop()}}),_callee,this)}))),function _finishPlacement(t){return l.apply(this,arguments)})},{key:"_onMovePlacement",value:function _onMovePlacement(t){t.stopPropagation();var r=Date.now();if(!(r-_classPrivateFieldGet(this,i)<=20)){var a=t.data.getLocalPosition(this.layer),o=canvas.grid.getSnappedPosition(a.x,a.y,2);this.document.updateSource({x:o.x,y:o.y}),this.refresh(),_classPrivateFieldSet(this,i,r)}}},{key:"_onRotatePlacement",value:function _onRotatePlacement(t){t.ctrlKey&&t.preventDefault(),t.stopPropagation();var r=canvas.grid.type>CONST.GRID_TYPES.SQUARE?30:15,a=t.shiftKey?r:5,o={direction:this.document.direction+a*Math.sign(t.deltaY)};this.document.updateSource(o),this.refresh()}},{key:"_onConfirmPlacement",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r;return _regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this._finishPlacement(t);case 2:r=canvas.grid.getSnappedPosition(this.document.x,this.document.y,2),this.document.updateSource(r),_classPrivateFieldGet(this,c).resolve(canvas.scene.createEmbeddedDocuments("MeasuredTemplate",[this.document.toObject()]));case 5:case"end":return a.stop()}}),_callee2,this)}))),function _onConfirmPlacement(t){return u.apply(this,arguments)})},{key:"_onCancelPlacement",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){return _regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this._finishPlacement(t);case 2:_classPrivateFieldGet(this,c).reject();case 3:case"end":return r.stop()}}),_callee3,this)}))),function _onCancelPlacement(t){return a.apply(this,arguments)})}],[{key:"placeTemplateFromChat",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){var r,a,o,i,c;return _regeneratorRuntime().wrap((function _callee4$(u){for(;;)switch(u.prev=u.next){case 0:r=$(t.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(r),o=a.flags.data.preData.source,i=a.flags.data.postData,(c=this.fromItem(o,i.successLevel))&&c.drawPreview();case 6:case"end":return u.stop()}}),_callee4,this)}))),function placeTemplateFromChat(t){return r.apply(this,arguments)})},{key:"fromItem",value:function fromItem(t,r){var a,o=t.system.target||{},i=game.dsa5.config.areaTargetTypes[o.type];if(!i||!o.value)return null;var c=Number(Roll.safeEval("".concat(o.value).replace(/(qs|ql)/gi,r)))||1,u={t:i,user:game.user.id,distance:c,direction:0,x:0,y:0,fillColor:game.user.color,flags:{dsa5:{origin:t.uuid}}};switch(i){case"cone":u.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":u.distance=Math.hypot(c,c),u.width=c,u.direction=45;break;case"ray":u.width=o.width&&Number(Roll.safeEval("".concat(o.width).replace(/(qs|ql)/gi,r)))||canvas.dimensions.distance}var l=new this(new(0,CONFIG.MeasuredTemplate.documentClass)(u,{parent:canvas.scene}));return l.item=t,l.actorSheet=(null===(a=t.actor)||void 0===a?void 0:a.sheet)||null,l}}]),MeasuredTemplateDSA}()},586:(t,r,a)=>{a.d(r,{Z:()=>migrateWorld,j:()=>showPatchViewer});var o=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function setupDefaulTokenConfig(){return _setupDefaulTokenConfig.apply(this,arguments)}function _setupDefaulTokenConfig(){return(_setupDefaulTokenConfig=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(){var t;return _regeneratorRuntime().wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:if(game.settings.get("dsa5","defaultConfigFinished")){r.next=13;break}return console.log("Configuring default token settings"),(t=game.settings.get("core","defaultToken")).displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,t.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,t.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,t.bar1={attribute:"status.wounds"},r.next=9,game.settings.set("core","defaultToken",t);case 9:return r.next=11,game.settings.set("core","leftClickRelease",!0);case 11:return r.next=13,game.settings.set("dsa5","defaultConfigFinished",!0);case 13:case"end":return r.stop()}}),_callee5)})))).apply(this,arguments)}function migrateDSA(t,r){return _migrateDSA.apply(this,arguments)}function _migrateDSA(){return(_migrateDSA=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r){return _regeneratorRuntime().wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,showPatchViewer();case 2:return t.next=4,game.settings.set("dsa5","migrationVersion",r);case 4:case"end":return t.stop()}}),_callee6)})))).apply(this,arguments)}function showPatchViewer(){return _showPatchViewer.apply(this,arguments)}function _showPatchViewer(){return(_showPatchViewer=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(){var t,r;return _regeneratorRuntime().wrap((function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,fetch("systems/dsa5/lazy/updatenotes.json");case 2:return t=a.sent,a.next=5,t.json();case 5:r=a.sent,new i(r).render(!0);case 8:case"end":return a.stop()}}),_callee7)})))).apply(this,arguments)}function migrateWorld(){Hooks.once("ready",_asyncToGenerator(_regeneratorRuntime().mark((function _callee(){var t,r;return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:if(game.user.isGM){a.next=2;break}return a.abrupt("return");case 2:return a.next=4,setupDefaulTokenConfig();case 4:return a.next=6,game.settings.get("dsa5","migrationVersion");case 6:if(t=a.sent,t<(r=21)){a.next=11;break}return a.abrupt("return");case 11:migrateDSA(t,r);case 12:case"end":return a.stop()}}),_callee)}))))}var i=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(PatchViewer,Application);var r,a=_createSuper(PatchViewer);function PatchViewer(t,r){var o;return function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,PatchViewer),(o=a.call(this,r)).json=t,o}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(PatchViewer,[{key:"getData",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(){var t,r,a,i,c,u,l,p,d,h;return _regeneratorRuntime().wrap((function _callee4$(m){for(;;)switch(m.prev=m.next){case 0:return t=this.json.notes[this.json.notes.length-1],r=this.json.default.replace(/VERSION/g,t.version),a="<h1>CHANGELOG</h1><p>".concat(r,". </br><b>Important updates</b>: ").concat(t.text,'</p><p>For details or proposals visit our wiki page at <a href="https://github.com/Plushtoast/dsa5-foundryVTT/wiki" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>'),m.next=5,ChatMessage.create(o.Z.chatDataSetup(a,"roll"));case 5:return i=game.i18n.lang,m.next=8,renderTemplate("systems/dsa5/lazy/patchhtml/changelog_".concat(i,"_").concat(t.version,".html"));case 8:return c=m.sent,m.next=11,renderTemplate("systems/dsa5/lazy/patchhtml/news_".concat(i,"_").concat(t.version,".html"));case 11:return u=m.sent,l=[this.json.notes[this.json.notes.length-2]],m.next=15,Promise.all(l.map(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){return _regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,renderTemplate("systems/dsa5/lazy/patchhtml/changelog_".concat(i,"_").concat(t.version,".html"));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),_callee2)})));return function(r){return t.apply(this,arguments)}}()));case 15:return p=m.sent,m.next=18,Promise.all(l.map(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){return _regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,renderTemplate("systems/dsa5/lazy/patchhtml/news_".concat(i,"_").concat(t.version,".html"));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),_callee3)})));return function(r){return t.apply(this,arguments)}}()));case 18:return d=m.sent,m.next=21,renderTemplate("systems/dsa5/lazy/patchhtml/modules_".concat(i,".html"));case 21:return h=m.sent,m.abrupt("return",{patchName:r,changelog:c,news:u,prevVersions:l,prevChangeLogs:p,prevNews:d,modules:h});case 23:case"end":return m.stop()}}),_callee4,this)}))),function getData(){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=_get(_getPrototypeOf(PatchViewer),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(t,{classes:t.classes.concat(["dsa5","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),t.template="systems/dsa5/templates/system/patchviewer.html",t.resizable=!0,t}}]),PatchViewer}()},604:(t,r,a)=>{a.d(r,{Z:()=>i});var o=a(491);a(122),a(803);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var i=function(){function OnUseEffect(t){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,OnUseEffect),this.item=t}var t,r,a,i,c,u,l,p;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(OnUseEffect,[{key:"callMacro",value:(p=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){var a,o,i,c,u,l,p,d,h,m=arguments;return _regeneratorRuntime().wrap((function _callee$(y){for(;;)switch(y.prev=y.next){case 0:return a=m.length>2&&void 0!==m[2]?m[2]:{},o=game.packs.get(t),y.next=4,o.getDocuments({name:r});case 4:if((i=y.sent).length){y.next=26;break}c=_createForOfIteratorHelper(game.packs.filter((function(t){return"Macro"==t.documentName&&/\(internal\)/.test(t.metadata.label)}))),y.prev=7,c.s();case 9:if((u=c.n()).done){y.next=18;break}return l=u.value,y.next=13,l.getDocuments({name:r});case 13:if(!(i=y.sent).length){y.next=16;break}return y.abrupt("break",18);case 16:y.next=9;break;case 18:y.next=23;break;case 20:y.prev=20,y.t0=y.catch(7),c.e(y.t0);case 23:return y.prev=23,c.f(),y.finish(23);case 26:if(p={},!i.length){y.next=43;break}return d="(async () => {".concat(i[0].command,"})()"),h=Function("args","actor","item",d),y.prev=30,a.result=p,y.next=34,h.call(this,a,this.item.actor,this.item);case 34:y.next=41;break;case 36:y.prev=36,y.t1=y.catch(30),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(y.t1),p.error=!0;case 41:y.next=44;break;case 43:ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:r}));case 44:return y.abrupt("return",p);case 45:case"end":return y.stop()}}),_callee,this,[[7,20,23,26],[30,36]])}))),function callMacro(t,r){return p.apply(this,arguments)})},{key:"executeOnUseEffect",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var t,r,a;return _regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:if(game.user.can("MACRO_SCRIPT")){o.next=2;break}return o.abrupt("return",ui.notifications.warn("You are not allowed to use JavaScript macros."));case 2:if(this.item.actor){o.next=4;break}return o.abrupt("return");case 4:return t=OnUseEffect.getOnUseEffect(this.item),r="(async () => {".concat(t,"})()"),a=Function("item","actor",r),o.prev=7,o.next=10,a.call(this,this.item,this.item.actor);case 10:o.next=17;break;case 12:o.prev=12,o.t0=o.catch(7),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(o.t0),console.warn(o.t0.stack);case 17:case"end":return o.stop()}}),_callee2,this,[[7,12]])}))),function executeOnUseEffect(){return l.apply(this,arguments)})},{key:"automatedAnimation",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r=arguments;return _regeneratorRuntime().wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:r.length>1&&void 0!==r[1]&&r[1],o.Z.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet");case 2:case"end":return t.stop()}}),_callee3)}))),function automatedAnimation(t){return u.apply(this,arguments)})},{key:"effectDummy",value:function effectDummy(t,r,a){return{label:t,icon:"icons/svg/aura.svg",changes:r,duration:a,flags:{dsa5:{value:null,editable:!0,customizable:!0,description:t,custom:!0}}}}},{key:"socketedConditionAddActor",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r){var a,o,i,c,u,l;return _regeneratorRuntime().wrap((function _callee4$(p){for(;;)switch(p.prev=p.next){case 0:if(!game.user.isGM){p.next=31;break}(a="string"==typeof r)&&((r=duplicate(CONFIG.statusEffects.find((function(t){return t.id==r})))).label=game.i18n.localize(r.label)),o=[],i=_createForOfIteratorHelper(t),p.prev=5,i.s();case 7:if((c=i.n()).done){p.next=19;break}if(u=c.value,!a){p.next=14;break}return p.next=12,u.addCondition(r,1,!1,!1);case 12:p.next=16;break;case 14:return p.next=16,u.addCondition(r);case 16:o.push(u.name);case 17:p.next=7;break;case 19:p.next=24;break;case 21:p.prev=21,p.t0=p.catch(5),i.e(p.t0);case 24:return p.prev=24,i.f(),p.finish(24);case 27:return p.next=29,this.createInfoMessage(r,o);case 29:p.next=33;break;case 31:l={id:this.item.uuid,data:r,actors:t.map((function(t){return t.id}))},game.socket.emit("system.dsa5",{type:"socketedConditionAddActor",payload:l});case 33:case"end":return p.stop()}}),_callee4,this,[[5,21,24,27]])}))),function socketedConditionAddActor(t,r){return c.apply(this,arguments)})},{key:"createInfoMessage",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t,r){var a,i,c,u=arguments;return _regeneratorRuntime().wrap((function _callee5$(l){for(;;)switch(l.prev=l.next){case 0:if(a=!(u.length>2&&void 0!==u[2])||u[2],!r.length){l.next=6;break}return i=a?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",c=game.i18n.format(i,{source:t.label,target:r.join(", ")}),l.next=6,ChatMessage.create(o.Z.chatDataSetup(c));case 6:case"end":return l.stop()}}),_callee5)}))),function createInfoMessage(t,r){return i.apply(this,arguments)})},{key:"socketedRemoveCondition",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r){var a,o,i,c,u,l,p,d,h=arguments;return _regeneratorRuntime().wrap((function _callee6$(m){for(;;)switch(m.prev=m.next){case 0:if(a=h.length>2&&void 0!==h[2]?h[2]:1,!game.user.isGM){m.next=29;break}o=[],i=_createForOfIteratorHelper(t),m.prev=4,i.s();case 6:if((c=i.n()).done){m.next=15;break}if(u=c.value,!(l=canvas.tokens.get(u)).actor){m.next=13;break}return m.next=12,l.actor.removeCondition(r,a,!1);case 12:o.push(l.name);case 13:m.next=6;break;case 15:m.next=20;break;case 17:m.prev=17,m.t0=m.catch(4),i.e(m.t0);case 20:return m.prev=20,i.f(),m.finish(20);case 23:return(p=CONFIG.statusEffects.find((function(t){return t.id==r}))).label=game.i18n.localize(p.label),m.next=27,this.createInfoMessage(p,o,!1);case 27:m.next=31;break;case 29:d={id:this.item.uuid,coreId:r,targets:t},game.socket.emit("system.dsa5",{type:"socketedRemoveCondition",payload:d});case 31:case"end":return m.stop()}}),_callee6,this,[[4,17,20,23]])}))),function socketedRemoveCondition(t,r){return a.apply(this,arguments)})},{key:"socketedActorTransformation",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t,r){var a,o,i,c,u;return _regeneratorRuntime().wrap((function _callee7$(l){for(;;)switch(l.prev=l.next){case 0:if(!game.user.isGM){l.next=22;break}a=_createForOfIteratorHelper(t),l.prev=2,a.s();case 4:if((o=a.n()).done){l.next=12;break}if(i=o.value,!(c=canvas.tokens.get(i)).actor){l.next=10;break}return l.next=10,c.actor.update(r);case 10:l.next=4;break;case 12:l.next=17;break;case 14:l.prev=14,l.t0=l.catch(2),a.e(l.t0);case 17:return l.prev=17,a.f(),l.finish(17);case 20:l.next=24;break;case 22:u={id:this.item.uuid,targets:t,update:r},game.socket.emit("system.dsa5",{type:"socketedActorTransformation",payload:u});case 24:case"end":return l.stop()}}),_callee7,this,[[2,14,17,20]])}))),function socketedActorTransformation(t,a){return r.apply(this,arguments)})},{key:"socketedConditionAdd",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t,r){var a,o,i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee8$(d){for(;;)switch(d.prev=d.next){case 0:if(!game.user.isGM){d.next=33;break}(a="string"==typeof r)&&((r=duplicate(CONFIG.statusEffects.find((function(t){return t.id==r})))).label=game.i18n.localize(r.label)),o=[],i=_createForOfIteratorHelper(t),d.prev=5,i.s();case 7:if((c=i.n()).done){d.next=21;break}if(u=c.value,!(l=canvas.tokens.get(u)).actor){d.next=19;break}if(!a){d.next=16;break}return d.next=14,l.actor.addCondition(r,1,!1,!1);case 14:d.next=18;break;case 16:return d.next=18,l.actor.addCondition(r);case 18:o.push(l.name);case 19:d.next=7;break;case 21:d.next=26;break;case 23:d.prev=23,d.t0=d.catch(5),i.e(d.t0);case 26:return d.prev=26,i.f(),d.finish(26);case 29:return d.next=31,this.createInfoMessage(r,o);case 31:d.next=35;break;case 33:p={id:this.item.uuid,data:r,targets:t},game.socket.emit("system.dsa5",{type:"socketedConditionAdd",payload:p});case 35:case"end":return d.stop()}}),_callee8,this,[[5,23,26,29]])}))),function socketedConditionAdd(r,a){return t.apply(this,arguments)})}],[{key:"getOnUseEffect",value:function getOnUseEffect(t){return t.getFlag("dsa5","onUseEffect")}}]),OnUseEffect}()},600:(t,r,a)=>{a.d(r,{Z:()=>h});var o=a(491),i=a(562),c=a(118),u=a(369),l=a(702),p=a(61),d=a(839);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var h=function(){function OpposedDsa5(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,OpposedDsa5)}var t,r,a,h,m,y,g,v,_,b,w,k,x,S,T,A,O;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(OpposedDsa5,null,[{key:"handleOpposedTarget",value:(O=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a,i;return _regeneratorRuntime().wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:if(t){c.next=2;break}return c.abrupt("return");case 2:if(r=o.Z.getSpeaker(t.speaker)){c.next=5;break}return c.abrupt("return");case 5:if(a=t.flags.data.postData,i=t.flags.data.preData,!r.flags.oppose){c.next=12;break}console.log("answering opposed"),OpposedDsa5.answerOpposedTest(r,t,a,i),c.next=37;break;case 12:if(!game.user.targets.size||!t.flags.data.isOpposedTest||t.flags.data.defenderMessage||t.flags.data.attackerMessage){c.next=17;break}console.log("start opposed"),OpposedDsa5.createOpposedTest(r,t,a,i),c.next=37;break;case 17:if(!t.flags.data.defenderMessage&&!t.flags.data.attackerMessage){c.next=22;break}console.log("end opposed"),OpposedDsa5.resolveFinalMessage(t),c.next=37;break;case 22:if(!t.flags.data.unopposedStartMessage){c.next=27;break}console.log("repeat"),OpposedDsa5.redoUndefended(t),c.next=37;break;case 27:if(!t.flags.data.startMessagesList){c.next=32;break}console.log("change start"),OpposedDsa5.changeStartMessage(t),c.next=37;break;case 32:return console.log("show dmg"),c.next=35,this.showDamage(t);case 35:return c.next=37,this.showSpellWithoutTarget(t);case 37:case"end":return c.stop()}}),_callee,this)}))),function handleOpposedTarget(t){return O.apply(this,arguments)})},{key:"redoUndefended",value:(A=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r;return _regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:r=game.messages.get(t.flags.data.unopposedStartMessage),startmessage.flags.unopposeData.attackMessageId=t.id,this.resolveUndefended(r);case 3:case"end":return a.stop()}}),_callee2,this)}))),function redoUndefended(t){return A.apply(this,arguments)})},{key:"answerOpposedTest",value:(T=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a,i){var c,u,l,p,d;return _regeneratorRuntime().wrap((function _callee3$(h){for(;;)switch(h.prev=h.next){case 0:if(u=game.messages.get(t.flags.oppose.messageId)){h.next=6;break}return ui.notifications.error(game.i18n.localize("DSAError.staleData")),h.next=5,OpposedDsa5.clearOpposed(t);case 5:return h.abrupt("return",OpposedDsa5.createOpposedTest(t,r,a,i));case 6:if((l={speaker:t.flags.oppose.speaker,testResult:u.flags.data.postData,messageId:u.id,img:o.Z.getSpeaker(t.flags.oppose.speaker).img}).testResult.source=u.flags.data.preData.source,l.testResult.ammo&&(c=l.testResult.source.effects).push.apply(c,_toConsumableArray(l.testResult.ammo.effects)),p={speaker:r.speaker,testResult:a,messageId:r.id,img:t.msg},(d=u.flags.data.defenderMessage?Array.from(u.flags.data.defenderMessage):[]).push(r.id),!game.user.isGM){h.next=15;break}return h.next=15,u.update({"flags.data.defenderMessage":d});case 15:return h.next=17,r.update({"flags.data.attackerMessage":u.id});case 17:return h.next=19,this.completeOpposedProcess(l,p,{target:!0,startMessageId:t.flags.oppose.startMessageId,whisper:r.whisper,blind:r.blind});case 19:return h.next=21,OpposedDsa5.clearOpposed(t);case 21:case"end":return h.stop()}}),_callee3,this)}))),function answerOpposedTest(t,r,a,o){return T.apply(this,arguments)})},{key:"videoOrImgTag",value:function videoOrImgTag(t){return/\.webm$/.test(t)?'<video loop autoplay src="'.concat(t,'" width="50" height="50"></video>'):'<img src="'.concat(t,'" width="50" height="50"/>')}},{key:"createOpposedTest",value:(S=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r,a,o){var i,c,u,l;return _regeneratorRuntime().wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:i=r.speaker.token?canvas.tokens.get(r.speaker.token).document:t.prototypeToken,a.successLevel>0?(c=r.flags.data.preData.attackOfOpportunity,u=c?"":'<div><button class="unopposed-button small-button chat-button-target" data-target="true">'.concat(game.i18n.localize("Unopposed"),"</button></div>"),l=[],game.user.targets.forEach(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){var a,o;return _regeneratorRuntime().wrap((function _callee4$(p){for(;;)switch(p.prev=p.next){case 0:if(!t.actor){p.next=15;break}return a="".concat(OpposedDsa5.opposeMessage(i,t,!1)," ").concat(u),p.next=4,ChatMessage.create(_defineProperty({user:game.user.id,content:a,speaker:r.speaker},"flags.unopposeData",{attackMessageId:r.id,targetSpeaker:{scene:t.scene.id,token:t.id,alias:t.document.name}}));case 4:if(o=p.sent,game.user.isGM){p.next=9;break}game.socket.emit("system.dsa5",{type:"target",payload:{target:t.id,scene:canvas.scene.id,opposeFlag:{speaker:r.speaker,messageId:r.id,startMessageId:o.id}}}),p.next=11;break;case 9:return p.next=11,t.actor.update({"flags.oppose":{speaker:r.speaker,messageId:r.id,startMessageId:o.id}});case 11:if(l.push(o.id),!c){p.next=15;break}return p.next=15,OpposedDsa5.resolveUndefended(o,game.i18n.localize("OPPOSED.attackOfOpportunity"));case 15:case"end":return p.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()),r.flags.data.startMessagesList=l):game.user.targets.forEach(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t){return _regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:if(!t.actor){a.next=3;break}return a.next=3,ChatMessage.create({user:game.user.id,content:OpposedDsa5.opposeMessage(i,t,!0),speaker:r.speaker});case 3:case"end":return a.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}());case 2:case"end":return o.stop()}}),_callee6)}))),function createOpposedTest(t,r,a,o){return S.apply(this,arguments)})},{key:"opposeMessage",value:function opposeMessage(t,r,a){return'<div class ="opposed-message">\n            <b>'.concat(t.name,"</b> ").concat(game.i18n.localize("ROLL.Targeting")," <b>").concat(r.document.name,"</b> ").concat(a?game.i18n.localize("ROLL.failed"):"",'\n            </div>\n            <div class = "opposed-tokens row-section">\n                <div class="col two attacker">').concat(OpposedDsa5.videoOrImgTag(t.texture.src),'</div>\n                <div class="col two defender">').concat(OpposedDsa5.videoOrImgTag(r.document.texture.src),"</div>\n            </div>\n             ")}},{key:"changeStartMessage",value:(x=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){var r,a,o,i,c;return _regeneratorRuntime().wrap((function _callee7$(u){for(;;)switch(u.prev=u.next){case 0:r=_createForOfIteratorHelper(t.flags.data.startMessagesList),u.prev=1,r.s();case 3:if((a=r.n()).done){u.next=12;break}return o=a.value,i=game.messages.get(o),c=i.flags.unopposeData,game.socket.emit("system.dsa5",{type:"target",payload:{target:c.targetSpeaker.token,scene:canvas.scene.id,opposeFlag:{speaker:t.speaker,messageId:t.id,startMessageId:i.id}}}),u.next=10,i.update({"flags.unopposeData.attackMessageId":t.id});case 10:u.next=3;break;case 12:u.next=17;break;case 14:u.prev=14,u.t0=u.catch(1),r.e(u.t0);case 17:return u.prev=17,r.f(),u.finish(17);case 20:case"end":return u.stop()}}),_callee7,null,[[1,14,17,20]])}))),function changeStartMessage(t){return x.apply(this,arguments)})},{key:"resolveFinalMessage",value:function resolveFinalMessage(t){var r,a;if(t.flags.data.defenderMessage){var o,i=_createForOfIteratorHelper(t.flags.data.defenderMessage);try{for(i.s();!(o=i.n()).done;){var c=o.value;r=OpposedDsa5.getMessageDude(t);var u=game.messages.get(c);a=OpposedDsa5.getMessageDude(u),this.completeOpposedProcess(r,a,{blind:t.blind,whisper:t.whisper})}}catch(t){i.e(t)}finally{i.f()}}else{a=OpposedDsa5.getMessageDude(t);var l=game.messages.get(t.flags.data.attackerMessage);r=OpposedDsa5.getMessageDude(l),this.completeOpposedProcess(r,a,{blind:t.blind,whisper:t.whisper})}}},{key:"getMessageDude",value:function getMessageDude(t){var r,a={speaker:t.speaker,testResult:mergeObject(t.flags.data.postData,{source:t.flags.data.preData.source}),img:o.Z.getSpeaker(t.speaker).img,messageId:t.id};return a.testResult.ammo&&(r=a.testResult.source.effects).push.apply(r,_toConsumableArray(a.testResult.ammo.effects)),a}},{key:"showDamage",value:(k=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t){var r,a=arguments;return _regeneratorRuntime().wrap((function _callee8$(o){for(;;)switch(o.prev=o.next){case 0:if(r=a.length>1&&void 0!==a[1]&&a[1],!game.user.isGM){o.next=8;break}if(r&&t.flags.data.hideDamage||!t.flags.data.postData.damageRoll){o.next=6;break}return o.next=5,t.update({content:t.content.replace('data-hide-damage="'.concat(!r,'"'),'data-hide-damage="'.concat(r,'"')),"flags.data.hideDamage":r});case 5:r||i.Z._addRollDiceSoNice(t.flags.data.preData,Roll.fromData(t.flags.data.postData.damageRoll),game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"));case 6:o.next=9;break;case 8:game.socket.emit("system.dsa5",{type:"showDamage",payload:{id:t.id,hide:r}});case 9:case"end":return o.stop()}}),_callee8)}))),function showDamage(t){return k.apply(this,arguments)})},{key:"playAutomatedJBA2",value:(w=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(t,r,a){var i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee9$(h){for(;;)switch(h.prev=h.next){case 0:if(!o.Z.moduleEnabled("autoanimations")){h.next=12;break}if(i=o.Z.getSpeaker(t.speaker).getActiveTokens()[0],c=o.Z.getSpeaker(r.speaker).getActiveTokens()[0],i&&i.actor&&c&&c.actor){h.next=5;break}return h.abrupt("return");case 5:if((u=i.actor.items.get(t.testResult.source._id))||(u=new d.Z(t.testResult.source,{temporary:!0})),u){h.next=9;break}return h.abrupt("return");case 9:l=[c],p="attacker"==a.winner?l:[],AutoAnimations.playAnimation(i,l,u,{hitTargets:p,playOnMiss:!0});case 12:case"end":return h.stop()}}),_callee9)}))),function playAutomatedJBA2(t,r,a){return w.apply(this,arguments)})},{key:"showSpellWithoutTarget",value:(b=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t){var r,a,i,c;return _regeneratorRuntime().wrap((function _callee10$(u){for(;;)switch(u.prev=u.next){case 0:if(!o.Z.moduleEnabled("autoanimations")){u.next=13;break}if((r=getProperty(t,"flags.data"))&&!r.isOpposedTest){u.next=4;break}return u.abrupt("return");case 4:if(!((getProperty(r,"postData.result")||-1)>0)){u.next=13;break}if((a=o.Z.getSpeaker(r.postData.speaker).getActiveTokens()[0])&&a.actor){u.next=9;break}return u.abrupt("return");case 9:i=Array.from(game.user.targets),c=a.actor.items.get(r.preData.source._id),i.length||(i=[a]),AutoAnimations.playAnimation(a,i,c);case 13:case"end":return u.stop()}}),_callee10)}))),function showSpellWithoutTarget(t){return b.apply(this,arguments)})},{key:"clearOpposed",value:(_=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(t){return _regeneratorRuntime().wrap((function _callee11$(r){for(;;)switch(r.prev=r.next){case 0:if(!game.user.isGM){r.next=5;break}return r.next=3,t.update(_defineProperty({},"flags.-=oppose",null));case 3:r.next=6;break;case 5:game.socket.emit("system.dsa5",{type:"clearOpposed",payload:{actorId:t.id}});case 6:case"end":return r.stop()}}),_callee11)}))),function clearOpposed(t){return _.apply(this,arguments)})},{key:"_handleReaction",value:(v=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(t){var r,a,o,i;return _regeneratorRuntime().wrap((function _callee12$(u){for(;;)switch(u.prev=u.next){case 0:r=$(t.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(r),o=game.messages.get(a.flags.unopposeData.attackMessageId),i=o.flags.data.preData.source,u.t0=i.type,u.next="skill"===u.t0?7:9;break;case 7:return c.$G.showDialog(a),u.abrupt("break",10);case 9:c.MN.showDialog(a);case 10:case"end":return u.stop()}}),_callee12)}))),function _handleReaction(t){return v.apply(this,arguments)})},{key:"chatListeners",value:(g=_asyncToGenerator(_regeneratorRuntime().mark((function _callee13(t){var r=this;return _regeneratorRuntime().wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:t.on("click",".unopposed-button",(function(t){t.preventDefault(),r._handleReaction(t)}));case 1:case"end":return a.stop()}}),_callee13)}))),function chatListeners(t){return g.apply(this,arguments)})},{key:"hideReactionButton",value:(y=_asyncToGenerator(_regeneratorRuntime().mark((function _callee14(t){var r,a;return _regeneratorRuntime().wrap((function _callee14$(o){for(;;)switch(o.prev=o.next){case 0:if(!t){o.next=11;break}if(!game.user.isGM){o.next=10;break}return r=game.messages.get(t),(a=$(r.content)).find("button.unopposed-button").remove(),a=$("<div></div>").append(a),o.next=8,r.update({content:a.html()});case 8:o.next=11;break;case 10:game.socket.emit("system.dsa5",{type:"hideQueryButton",payload:{id:t}});case 11:case"end":return o.stop()}}),_callee14)}))),function hideReactionButton(t){return y.apply(this,arguments)})},{key:"completeOpposedProcess",value:(m=_asyncToGenerator(_regeneratorRuntime().mark((function _callee15(t,r,a){var o;return _regeneratorRuntime().wrap((function _callee15$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.evaluateOpposedTest(t.testResult,r.testResult,a);case 2:return o=i.sent,this.formatOpposedResult(o,t.speaker,r.speaker),this.rerenderMessagesWithModifiers(o,t,r),Hooks.call("finishOpposedTest",t,r,o,a),i.next=8,this.finishOpposedTestHookAsync(t,r,o,a);case 8:return this.playAutomatedJBA2(t,r,o),i.next=11,this.renderOpposedResult(o,a);case 11:return i.next=13,this.hideReactionButton(a.startMessageId);case 13:return i.abrupt("return",o);case 14:case"end":return i.stop()}}),_callee15,this)}))),function completeOpposedProcess(t,r,a){return m.apply(this,arguments)})},{key:"finishOpposedTestHookAsync",value:(h=_asyncToGenerator(_regeneratorRuntime().mark((function _callee16(t,r,a,o){return _regeneratorRuntime().wrap((function _callee16$(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),_callee16)}))),function finishOpposedTestHookAsync(t,r,a,o){return h.apply(this,arguments)})},{key:"evaluateOpposedTest",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee17(t,r){var a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee17$(c){for(;;)switch(c.prev=c.next){case 0:if(a=i.length>2&&void 0!==i[2]?i[2]:{},(o={}).other=[],a.additionalInfo&&o.other.push(a.additionalInfo),o.winner="attacker",["weapon","spell","liturgy","ceremony","ritual","combatskill"].includes(t.rollType)&&null==r.successLevel&&(r.successLevel=-5),null==r.successLevel){c.next=16;break}c.t0=t.rollType,c.next="combatskill"===c.t0||"talent"===c.t0?10:"ceremony"===c.t0||"ritual"===c.t0||"spell"===c.t0||"liturgy"===c.t0||"weapon"===c.t0?12:14;break;case 10:return this._evaluateTalentOpposedRoll(t,r,o,a),c.abrupt("break",16);case 12:return this._evaluateWeaponOpposedRoll(t,r,o,a),c.abrupt("break",16);case 14:ui.notifications.error("Can not oppose "+t.rollType),console.warn("Can not oppose "+t.rollType);case 16:return c.abrupt("return",o);case 17:case"end":return c.stop()}}),_callee17,this)}))),function evaluateOpposedTest(t,r){return a.apply(this,arguments)})},{key:"_evaluateWeaponOpposedRoll",value:function _evaluateWeaponOpposedRoll(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(t.successLevel>0&&r.successLevel<0){var i=this._calculateOpposedDamage(t,r,o);i.armorDamaged.damaged&&i.armorDamaged.ids.length&&a.other.push('<div class="center"><button class="gearDamaged onlyTarget" data-uuid="'.concat(i.armorDamaged.ids.join(";"),'">').concat(game.i18n.localize("WEAR.checkShort"),"</button></div>")),a.winner="attacker";var c=[0!=i.armorMod?"".concat(i.armorMod+" "+game.i18n.localize("Modifier")):"",1!=i.armorMultiplier?"*"+i.armorMultiplier+" "+game.i18n.localize("Modifier"):"",0!=i.spellArmor?"".concat(i.spellArmor," ").concat(game.i18n.localize("spellArmor")):"",0!=i.liturgyArmor?"".concat(i.liturgyArmor," ").concat(game.i18n.localize("liturgyArmor")):""],u="<b>".concat(game.i18n.localize("damage"),"</b>: ").concat(i.damage,' - <span data-tooltip="').concat(c.join(""),'">').concat(i.armor," (").concat(game.i18n.localize("protection"),")</span> = ").concat(i.sum);a.damage={description:u,value:i.sum,sp:i.damage}}else a.winner="defender"}},{key:"_calculateOpposedDamage",value:function _calculateOpposedDamage(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=o.Z.getSpeaker(r.speaker);a.origin=t.source,a.damage=t.damage;var c,d=p.Z.applyRollTransformation(i,a,5).options.damage,h=u.Z.armorValue(i,a),m=h.wornArmor,y=h.armor,g=[],v=0,_=t.armorPen||[],b=_createForOfIteratorHelper(_);try{for(b.s();!(c=b.n()).done;){var w=c.value;/^\*/.test(w)?g.push(Number(w.replace("*",""))):v+=Number(w)}}catch(t){b.e(t)}finally{b.f()}var k=0,x=0;["spell","ritual"].includes(t.source.type)?k+=i.system.spellArmor||0:["liturgy","ceremony"].includes(t.source.type)&&(k+=i.system.liturgyArmor||0),y+=v;var S=g.reduce((function(t,r){return t*r}),1);y=Math.max(Math.round(y*S),0),y+=k+x;var T=l.Z.armorGetsDamage(d,t),A=m.map((function(t){return t.uuid}));return{damage:d,armor:y,armorDamaged:{damaged:T,ids:A},armorMod:v,spellArmor:k,liturgyArmor:x,armorMultiplier:S,sum:d-y}}},{key:"_evaluateTalentOpposedRoll",value:function _evaluateTalentOpposedRoll(t,r,a){t.successLevel>0&&t.successLevel>r.successLevel?a.winner="attacker":t.qualityStep>r.qualityStep||t.result>=0&&r.result<0?(a.winner="attacker",a.differenceSL=t.qualityStep-r.qualityStep):(a.winner="defender",a.differenceSL=r.qualityStep-t.qualityStep)}},{key:"formatOpposedResult",value:function formatOpposedResult(t,r,a){var o=t.differenceSL?"winsFP":"wins";return"attacker"==t.winner?(t.result=game.i18n.format("OPPOSED."+o,{winner:r.alias,loser:a.alias,SL:t.differenceSL}),t.img=r.img):"defender"==t.winner&&(t.result=game.i18n.format("OPPOSED."+o,{winner:a.alias,loser:r.alias,SL:t.differenceSL}),t.img=a.img),t.speakerAttack=r,t.speakerDefend=a,t.swapped&&(t.speakerAttack=a,t.speakerDefend=r),t}},{key:"rerenderMessagesWithModifiers",value:function rerenderMessagesWithModifiers(t,r,a){var o=game.messages.get(r.messageId);this.showDamage(o,"attacker"!=t.winner)}},{key:"renderOpposedResult",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee18(t){var r,a,o,i=arguments;return _regeneratorRuntime().wrap((function _callee18$(c){for(;;)switch(c.prev=c.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:{},c.next=3,game.settings.get("dsa5","hideOpposedDamage");case 3:return t.hideData=c.sent,c.next=6,renderTemplate("systems/dsa5/templates/chat/roll/opposed-result.html",t);case 6:if(a=c.sent,o={user:game.user.id,content:a,"flags.opposeData":t,"flags.hideData":t.hideData,whisper:r.whisper,blind:r.blind},!r.target){c.next=14;break}return o["flags.startMessageId"]=r.startMessageId,c.next=12,ChatMessage.create(o);case 12:case 17:c.next=23;break;case 14:return c.prev=14,c.next=17,this.startMessage.update(o).then((function(t){ui.chat.updateMessage(t)}));case 19:return c.prev=19,c.t0=c.catch(14),c.next=23,ChatMessage.create(o);case 23:case"end":return c.stop()}}),_callee18,this,[[14,19]])}))),function renderOpposedResult(t){return r.apply(this,arguments)})},{key:"resolveUndefended",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee19(t){var r,a,o,i,c,u,l,p=arguments;return _regeneratorRuntime().wrap((function _callee19$(d){for(;;)switch(d.prev=d.next){case 0:return a=p.length>1&&void 0!==p[1]?p[1]:"",o=t.flags.unopposeData,i=game.messages.get(o.attackMessageId),(c={speaker:i.speaker,testResult:i.flags.data.postData,messageId:o.attackMessageId}).testResult.source=i.flags.data.preData.source,c.testResult.ammo&&(r=c.testResult.source.effects).push.apply(r,_toConsumableArray(c.testResult.ammo.effects)),u=canvas.tokens.get(o.targetSpeaker.token),l={speaker:o.targetSpeaker,testResult:{actor:u.actor,speaker:{token:o.targetSpeaker.token}}},d.next=10,this.clearOpposed(u.actor);case 10:return d.next=12,this.completeOpposedProcess(c,l,{target:!0,startMessageId:t.id,additionalInfo:a});case 12:if(!game.user.isGM){d.next=17;break}return d.next=15,i.update({"flags.data.unopposedStartMessage":t.id});case 15:d.next=19;break;case 17:return d.next=19,game.socket.emit("system.dsa5",{type:"updateAttackMessage",payload:{messageId:i.id,startMessageId:t.id}});case 19:case"end":return d.stop()}}),_callee19,this)}))),function resolveUndefended(r){return t.apply(this,arguments)})}]),OpposedDsa5}()},903:(t,r,a)=>{a.d(r,{Z:()=>u});var o=a(538),i=a(231),c=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var u=function(){function RequestRoll(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,RequestRoll)}var t,r,a,u,l,p,d,h,m,y,g;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(RequestRoll,null,[{key:"requestGC",value:(g=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r,a){var o,c,u,l,p,d,h=arguments;return _regeneratorRuntime().wrap((function _callee2$(m){for(;;)switch(m.prev=m.next){case 0:if(o=h.length>3&&void 0!==h[3]?h[3]:0,c=i.Z._getActor(),u=c.actor,l=c.tokenId,u){m.next=4;break}return m.abrupt("return");case 4:game.user.updateTokenTargets([]),p={modifier:o,postFunction:{cummulative:a,functionName:"game.dsa5.apps.RequestRoll.autoEditGroupCheckRoll"}},m.t0=t,m.next="attribute"===m.t0?9:10;break;case 9:return m.abrupt("break",12);case 10:d=u.items.find((function(a){return a.name==r&&a.type==t})),u.setupSkill(d,p,l).then(function(){var o=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(o){var i;return _regeneratorRuntime().wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,u.basicTest(o);case 2:return i=c.sent,c.next=5,RequestRoll.editGroupCheckRoll(a,i,r,t);case 5:case"end":return c.stop()}}),_callee)})));return function(t){return o.apply(this,arguments)}}());case 12:case"end":return m.stop()}}),_callee2)}))),function requestGC(t,r,a){return g.apply(this,arguments)})},{key:"autoEditGroupCheckRoll",value:(y=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a){return _regeneratorRuntime().wrap((function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,RequestRoll.editGroupCheckRoll(t.cummulative,r,a.name,a.type);case 2:case"end":return o.stop()}}),_callee3)}))),function autoEditGroupCheckRoll(t,r,a){return y.apply(this,arguments)})},{key:"editGroupCheckRoll",value:(m=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r,a,o){var i,u,l,p,d,h,m;return _regeneratorRuntime().wrap((function _callee4$(y){for(;;)switch(y.prev=y.next){case 0:return y.next=2,game.messages.get(t);case 2:i=y.sent,u=i.flags,l=r.result.successLevel>1,p=l?2:1,u.botched=u.botched||r.result.successLevel<-1,d=c.Z.getSpeaker(r.result.speaker),h={messageId:r.result.messageId,actor:d.name,qs:(r.result.qualityStep||0)*p,success:r.result.successLevel,target:a,type:o},(m=u.results.findIndex((function(t){return t.messageId==h.messageId})))>=0?u.results[m]=h:u.results.push(h),RequestRoll.rerenderGC(i,u);case 12:case"end":return y.stop()}}),_callee4)}))),function editGroupCheckRoll(t,r,a,o){return m.apply(this,arguments)})},{key:"requestRoll",value:(h=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t,r){var a,o,c,u,l,p,d,h=arguments;return _regeneratorRuntime().wrap((function _callee5$(m){for(;;)switch(m.prev=m.next){case 0:if(a=h.length>2&&void 0!==h[2]?h[2]:0,o=i.Z._getActor(),c=o.actor,u=o.tokenId,!c){m.next=15;break}game.user.updateTokenTargets([]),l={modifier:a},m.t0=t,m.next="attribute"===m.t0?8:"regeneration"===m.t0?11:13;break;case 8:return p=Object.keys(game.dsa5.config.characteristics).find((function(t){return game.i18n.localize(game.dsa5.config.characteristics[t])==r})),c.setupCharacteristic(p,l,u).then((function(t){c.basicTest(t)})),m.abrupt("break",15);case 11:return c.setupRegeneration("regenerate",l,u).then((function(t){c.basicTest(t)})),m.abrupt("break",15);case 13:d=c.items.find((function(a){return a.name==r&&a.type==t})),c.setupSkill(d,l,u).then((function(t){c.basicTest(t)}));case 15:case"end":return m.stop()}}),_callee5)}))),function requestRoll(t,r){return h.apply(this,arguments)})},{key:"rerenderGC",value:(d=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r){var a,o,i,c,u;return _regeneratorRuntime().wrap((function _callee6$(l){for(;;)switch(l.prev=l.next){case 0:if(!game.user.isGM){l.next=14;break}a=0,r.qs=r.results.reduce((function(t,r){return a+=r.success<0?1:0,r.success>1&&(a=0),t+r.qs}),0),r.failed=a,o=_createForOfIteratorHelper(r.rollOptions);try{for(o.s();!(i=o.n()).done;)(c=i.value).calculatedModifier=c.modifier-a}catch(t){o.e(t)}finally{o.f()}return r.openRolls=r.maxRolls-r.results.length,r.doneRolls=r.results.length,l.next=10,renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",r);case 10:u=l.sent,t.update({content:u,flags:r}),l.next=15;break;case 14:game.socket.emit("system.dsa5",{type:"updateGroupCheck",payload:{messageId:t.id,data:r}});case 15:$("#chat-log").find('[data-message-id="'.concat(t.id,'"')).appendTo("#chat-log");case 16:case"end":return l.stop()}}),_callee6)}))),function rerenderGC(t,r){return d.apply(this,arguments)})},{key:"showRQMessage",value:function showRQMessage(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=r<0?" ".concat(r):r>0?" +".concat(r):"",o=i.Z.skills.find((function(r){return r.name==t})).type,u=game.i18n.format("CHATNOTIFICATION.requestRoll",{user:game.user.name,item:'<a class="roll-button request-roll" data-type="'.concat(o,'" data-modifier="').concat(r,'" data-name="').concat(t,'"><i class="fas fa-dice"></i> ').concat(t).concat(a,"</a>")});ChatMessage.create(c.Z.chatDataSetup(u))}},{key:"showGCMessage",value:(p=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){var r,a,o,u,l,p,d=arguments;return _regeneratorRuntime().wrap((function _callee7$(h){for(;;)switch(h.prev=h.next){case 0:return r=d.length>1&&void 0!==d[1]?d[1]:0,a=d.length>2&&void 0!==d[2]?d[2]:{},o=i.Z.skills.find((function(r){return r.name==t})).type,u={results:[],qs:0,failed:0,modifier:r,name:game.user.name,maxRolls:7,openRolls:7,doneRolls:0,targetQs:10,rollOptions:[{type:o,modifier:r,calculatedModifier:r,target:t}]},mergeObject(u,a),h.next=7,renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",u);case 7:l=h.sent,(p=c.Z.chatDataSetup(l)).flags=u,ChatMessage.create(p);case 11:case"end":return h.stop()}}),_callee7)}))),function showGCMessage(t){return p.apply(this,arguments)})},{key:"addSkillToGC",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(t){var r,a,c;return _regeneratorRuntime().wrap((function _callee9$(u){for(;;)switch(u.prev=u.next){case 0:return r=$(t.currentTarget).parents(".message").attr("data-message-id"),u.next=3,renderTemplate("systems/dsa5/templates/dialog/addgroupcheckskill.html",{skills:i.Z.skills.filter((function(t){return"skill"==t.type})).sort((function(t,r){return t.name.localeCompare(r.name)}))});case 3:a=u.sent,c={title:game.i18n.localize("HELP.groupcheck"),content:a,buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t){var a,o;return _regeneratorRuntime().wrap((function _callee8$(i){for(;;)switch(i.prev=i.next){case 0:a=game.messages.get(r),(o=a.flags).rollOptions.push({type:"skill",modifier:t.find('[name="modifier"]').val(),target:t.find('[name="skill"]').val()}),RequestRoll.rerenderGC(a,o);case 4:case"end":return i.stop()}}),_callee8)})));return function callback(r){return t.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}},new o.Z(c).render(!0);case 6:case"end":return u.stop()}}),_callee9)}))),function addSkillToGC(t){return l.apply(this,arguments)})},{key:"removeGCEntry",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t){var r,a,o,i;return _regeneratorRuntime().wrap((function _callee10$(c){for(;;)switch(c.prev=c.next){case 0:r=$(t.currentTarget),a=Number(t.currentTarget.dataset.index),o=game.messages.get(r.parents(".message").attr("data-message-id")),(i=o.flags).results.splice(a,1),RequestRoll.rerenderGC(o,i);case 6:case"end":return c.stop()}}),_callee10)}))),function removeGCEntry(t){return u.apply(this,arguments)})},{key:"removeSkillFromGC",value:function removeSkillFromGC(t){var r=$(t.currentTarget),a=game.messages.get(r.parents(".message").attr("data-message-id")),o=a.flags;o.rollOptions=o.rollOptions.filter((function(r){return!(r.type==t.currentTarget.dataset.type&&r.target==t.currentTarget.dataset.name)})),o.results=o.results.filter((function(r){return!(r.type==t.currentTarget.dataset.type&&r.target==t.currentTarget.dataset.name)})),RequestRoll.rerenderGC(a,o)}},{key:"editGC",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(t){var r,a,o,i;return _regeneratorRuntime().wrap((function _callee11$(c){for(;;)switch(c.prev=c.next){case 0:r=$(t.currentTarget),a=Number(t.currentTarget.dataset.index),o=game.messages.get(r.parents(".message").attr("data-message-id")),i=o.flags,a?i.results[a].qs=Number(r.val()):t.currentTarget.dataset.name?i.rollOptions.find((function(r){return r.target==t.currentTarget.dataset.name&&t.currentTarget.dataset.type==r.type}))[t.currentTarget.dataset.field]=Number(r.val()):i[t.currentTarget.dataset.field]=Number(r.val()),RequestRoll.rerenderGC(o,i);case 6:case"end":return c.stop()}}),_callee11)}))),function editGC(t){return a.apply(this,arguments)})},{key:"updateInformationRoll",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(t,r,a){var o,i,u,l,p,d;return _regeneratorRuntime().wrap((function _callee12$(a){for(;;)switch(a.prev=a.next){case 0:if(!((o=r.result.qualityStep||0)>0)){a.next=10;break}return a.next=4,fromUuid(t.uuid);case 4:for(i=a.sent,u=["<p><b>".concat(i.name,"</b></p>")],l=1;l<=o;l++)p="qs".concat(l),i.system[p]&&u.push("<p>".concat(i.system[p],"</p>"));d=c.Z.chatDataSetup(u.join("")),t.recipients.length&&(d.whisper=t.recipients),ChatMessage.create(d);case 10:case"end":return a.stop()}}),_callee12)}))),function updateInformationRoll(t,a,o){return r.apply(this,arguments)})},{key:"informationRequestRoll",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee14(t){var r,a,o,c,u,l,p,d,h,m=this;return _regeneratorRuntime().wrap((function _callee14$(y){for(;;)switch(y.prev=y.next){case 0:if(r=t.currentTarget.dataset.mod,a=t.currentTarget.dataset.uuid,o=i.Z._getActor(),c=o.actor,u=o.tokenId,c){y.next=5;break}return y.abrupt("return");case 5:l=game.settings.get("dsa5","informationDistribution"),p=[],1==l?(p=game.users.filter((function(t){return t.isGM})).map((function(t){return t.id}))).push(game.user.id):2==l&&(p=game.users.filter((function(t){return t.isGM})).map((function(t){return t.id}))),d={modifier:r,postFunction:{functionName:"game.dsa5.apps.RequestRoll.updateInformationRoll",uuid:a,recipients:p}},h=c.items.find((function(r){return r.name==t.currentTarget.dataset.skill&&"skill"==r.type})),c.setupSkill(h,d,u).then(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee13(t){var r;return _regeneratorRuntime().wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:return t.testData.opposable=!1,a.next=3,c.basicTest(t);case 3:r=a.sent,m.updateInformationRoll(d.postFunction,r);case 5:case"end":return a.stop()}}),_callee13)})));return function(r){return t.apply(this,arguments)}}());case 11:case"end":return y.stop()}}),_callee14)}))),function informationRequestRoll(r){return t.apply(this,arguments)})},{key:"chatListeners",value:function chatListeners(t){t.on("change",".editGC",(function(t){return RequestRoll.editGC(t)})),t.on("click",".request-roll",(function(t){var r=t.currentTarget.dataset;RequestRoll.requestRoll(r.type,r.name,Number(r.modifier)||0)})),t.on("click",".request-gc",(function(t){var r=t.currentTarget.dataset;RequestRoll.requestGC(r.type,r.name,$(t.currentTarget).parents(".message").attr("data-message-id"),Number(r.modifier)||0)})),t.on("click",".removeGC",(function(t){return RequestRoll.removeGCEntry(t)})),t.on("click",".removeSkillFromGC",(function(t){return RequestRoll.removeSkillFromGC(t)})),t.on("click",".addSkillToGC",(function(t){return RequestRoll.addSkillToGC(t)})),t.on("click",".informationRequestRoll",(function(t){return RequestRoll.informationRequestRoll(t)}))}}]),RequestRoll}()},122:(t,r,a)=>{a.d(r,{Z:()=>u});a(839);var o=a(973),i=a(173),c=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var u=function(){function RuleChaos(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,RuleChaos)}var t,r;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(RuleChaos,null,[{key:"multipleDefenseValue",value:function multipleDefenseValue(t,r){var a=-3;return"dodge"!=r.type&&getProperty(r,"system.combatskill.value")!=game.i18n.localize("LocalizedIDs.wrestle")||!i.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.masterfulDodge"))?i.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.mightyMasterfulParry"))?a=-1:i.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.masterfulParry"))&&(a=-2):a=-2,i.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.vinsaltStyle"))&&(a-=1),Math.min(0,a)}},{key:"isFamiliar",value:function isFamiliar(t){return null!=t.items.find((function(t){return"trait"==t.type&&game.i18n.localize("LocalizedIDs.familiar")==t.name}))}},{key:"isPet",value:function isPet(t){return null!=t.items.find((function(t){return"trait"==t.type&&game.i18n.localize("LocalizedIDs.companion")==t.name}))}},{key:"bleedingMessage",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){return _regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,ChatMessage.create(c.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.applyBleeding",{actor:t.name,actorId:t.id,tokenId:t.token?t.token.id:""})));case 2:case"end":return r.stop()}}),_callee)}))),function bleedingMessage(t){return r.apply(this,arguments)})},{key:"_getFunctionData",value:function _getFunctionData(t){return{data:t.currentTarget.dataset,actor:c.Z.getSpeaker({token:t.currentTarget.dataset.token,actor:t.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}},{key:"ensureNumber",value:function ensureNumber(t){t.system.AsPCost.value=Number(t.system.AsPCost.value)||t.system.AsPCost.value}},{key:"isYieldedTwohanded",value:function isYieldedTwohanded(t){var r=this.regex2h.test(t.name),a=t.system.worn.wrongGrip;return r&&!a||!r&&a}},{key:"obfuscateDropData",value:function obfuscateDropData(t,r){if(r){var a,o=_createForOfIteratorHelper(r);try{for(o.s();!(a=o.n()).done;){var i=a.value;mergeObject(t,{system:{obfuscation:_defineProperty({},i,!0)}})}}catch(t){o.e(t)}finally{o.f()}}}},{key:"_buildDuration",value:function _buildDuration(t){var r={duration:{startTime:game.time.worldTime,rounds:t,seconds:5*t}};return game.combat&&mergeObject(r,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),r}},{key:"calcBleeding",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r,a,i,u;return _regeneratorRuntime().wrap((function _callee3$(l){for(;;)switch(l.prev=l.next){case 0:if(r=RuleChaos._getFunctionData(t),a=r.data,i=r.actor){l.next=3;break}return l.abrupt("return");case 3:u=i.items.find((function(t){return t.name==game.i18n.localize("LocalizedIDs.selfControl")&&"skill"==t.type})),i.setupSkill(u,{},a.token).then(function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r,a,u,l,p,d,h;return _regeneratorRuntime().wrap((function _callee2$(m){for(;;)switch(m.prev=m.next){case 0:return m.next=2,i.basicTest(t);case 2:if(!((r=m.sent).result.successLevel<2)){m.next=22;break}if(a=r.result.qualityStep||0,u=7,1==r.result.successLevel?u-=Number(a):r.successLevel<1&&(u+=u),l=i.hasCondition("bleeding"),p=RuleChaos._buildDuration(u),!l){m.next=16;break}if(d=game.combat?(l.data.duration.startRound||1)+l.data.duration.rounds-game.combat.round:l.data.duration.rounds,!(u>d)){m.next=14;break}return m.next=14,l.update(p);case 14:m.next=22;break;case 16:return h=duplicate(CONFIG.statusEffects.find((function(t){return"bleeding"==t.id}))),mergeObject(h,p),m.next=20,o.Z.addCondition(i,h,1,!1,!0);case 20:return m.next=22,ChatMessage.create(c.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.gotBleeding",{actor:i.name})));case 22:case"end":return m.stop()}}),_callee2)})));return function(r){return t.apply(this,arguments)}}());case 5:case"end":return l.stop()}}),_callee3)}))),function calcBleeding(r){return t.apply(this,arguments)})},{key:"increment",value:function increment(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,i=t.ctrlKey?10:1,c=2==t.button?-1:1,u=getProperty(r,a)+i*c;null!=o&&(u=Math.max(o,u)),setProperty(r,a,u)}},{key:"magicalImprovement",value:function magicalImprovement(t,r){var a,o=_createForOfIteratorHelper(t.items);try{for(o.s();!(a=o.n()).done;){var i=a.value;["ritual","spell"].includes(i.type)&&(i.system.talentValue.value+=4)}}catch(t){o.e(t)}finally{o.f()}}}]),RuleChaos}();_defineProperty(u,"regex2h",/\(2H/)},173:(t,r,a)=>{a.d(r,{Z:()=>c});var o=a(577),i=a(794);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var c=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(SpecialabilityRulesDSA5,t);var r,a,i,c,u,l,p=_createSuper(SpecialabilityRulesDSA5);function SpecialabilityRulesDSA5(){return _classCallCheck(this,SpecialabilityRulesDSA5),p.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(SpecialabilityRulesDSA5,null,[{key:"setupFunctions",value:function setupFunctions(){}},{key:"abilityAdded",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:o.Z.addAbilityRules[r.name]&&o.Z.addAbilityRules[r.name](t,r);case 1:case"end":return a.stop()}}),_callee)}))),function abilityAdded(t,r){return l.apply(this,arguments)})},{key:"abilityRemoved",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a,i,c;return _regeneratorRuntime().wrap((function _callee2$(u){for(;;)switch(u.prev=u.next){case 0:if(o.Z.removeAbilityRules[r.name]&&o.Z.removeAbilityRules[r.name](t,r),a=r.system.APValue.value*r.system.step.value,/;/.test(r.system.APValue.value))for(i=r.system.APValue.value.split(";").map((function(t){return Number(t.trim())})),a=0,c=0;c<r.system.step.value;c++)a+=i[c];return u.next=5,SpecialabilityRulesDSA5.refundFreelanguage(r,t,a);case 5:return a=u.sent,u.next=8,t._updateAPs(-1*a);case 8:case"end":return u.stop()}}),_callee2)}))),function abilityRemoved(t,r){return u.apply(this,arguments)})},{key:"_specialabilityReturnFunction",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a,i){var c,u,l,p,d,h;return _regeneratorRuntime().wrap((function _callee3$(m){for(;;)switch(m.prev=m.next){case 0:if(null!=r){m.next=2;break}return m.abrupt("return");case 2:if(r=duplicate(r),null!=i&&(/,/.test(r.system.APValue.value)&&(u="".concat(r.name.replace(" ()","")," (").concat(i.name),r.system.APValue.value=r.system.APValue.value.split(",")[t.items.filter((function(t){return t.type==r.type&&t.name.includes(u)})).length].trim()),SpecialabilityRulesDSA5.simpleAdoption(r,i,r.name,o.Z.AbilitiesNeedingAdaption),r.name="".concat(r.name.replace(" ()","")," (").concat(i.name).concat(i.customEntry?", "+i.customEntry:"",")"),i.data&&null!==(c=i.system.StF)&&void 0!==c&&c.value&&/\//.test(r.system.APValue.value)&&(r.system.APValue.value=r.system.APValue.value.split("/")[i.system.StF.value.charCodeAt(0)-65].trim())),!(l=t.items.find((function(t){return t.type==a&&t.name==r.name})))){m.next=25;break}return p=duplicate(l),m.next=9,SpecialabilityRulesDSA5.isFreeLanguage(r,t,/;/.test(p.system.APValue.value)?p.system.APValue.value.split(";").map((function(t){return Number(t.trim())}))[p.system.step.value]:p.system.APValue.value);case 9:if(d=m.sent,m.t0=p.system.step.value+1<=p.system.maxRank.value,!m.t0){m.next=15;break}return m.next=14,t.checkEnoughXP(d);case 14:m.t0=m.sent;case 15:if(!m.t0){m.next=23;break}return p.system.step.value+=1,m.next=19,t._updateAPs(d);case 19:return m.next=21,t.updateEmbeddedDocuments("Item",[p]);case 21:return m.next=23,SpecialabilityRulesDSA5.abilityAdded(t,p);case 23:m.next=37;break;case 25:return m.next=27,SpecialabilityRulesDSA5.isFreeLanguage(r,t,r.system.APValue.value.split(";").map((function(t){return t.trim()}))[0]);case 27:return h=m.sent,m.next=30,t.checkEnoughXP(h);case 30:if(!m.sent){m.next=37;break}return m.next=33,SpecialabilityRulesDSA5.abilityAdded(t,r);case 33:return m.next=35,t._updateAPs(h);case 35:return m.next=37,t.createEmbeddedDocuments("Item",[r]);case 37:case"end":return m.stop()}}),_callee3)}))),function _specialabilityReturnFunction(t,r,a,o){return c.apply(this,arguments)})},{key:"refundFreelanguage",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r,a){var o,i,c,u;return _regeneratorRuntime().wrap((function _callee4$(l){for(;;)switch(l.prev=l.next){case 0:if("language"!=t.system.category.value||!r.system.freeLanguagePoints){l.next=8;break}return o=Number(r.system.freeLanguagePoints.value),i=r.items.filter((function(t){return"specialability"==t.type&&"language"==t.system.category.value})).reduce((function(t,r){return t+Number(r.system.step.value)*Number(r.system.APValue.value)}),0),c=Math.min(o,i-Number(a)),u=Math.max(0,o-c),l.next=7,r.update({"system.freeLanguagePoints.used":Math.min(o,Number(c))});case 7:a=Math.max(0,a-u);case 8:return l.abrupt("return",a);case 9:case"end":return l.stop()}}),_callee4)}))),function refundFreelanguage(t,r,a){return i.apply(this,arguments)})},{key:"isFreeLanguage",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t,r,a){var o,i,c,u;return _regeneratorRuntime().wrap((function _callee5$(l){for(;;)switch(l.prev=l.next){case 0:if("language"!=t.system.category.value||!r.system.freeLanguagePoints){l.next=8;break}return o=Number(r.system.freeLanguagePoints.value),i=r.items.filter((function(t){return"specialability"==t.type&&"language"==t.system.category.value})).reduce((function(t,r){return t+Number(r.system.step.value)*Number(r.system.APValue.value)}),0),c=Math.min(o,i),u=Math.max(0,o-c),l.next=7,r.update({"system.freeLanguagePoints.used":Math.min(o,Number(c)+Number(a))});case 7:a=Math.max(0,a-u);case 8:return l.abrupt("return",a);case 9:case"end":return l.stop()}}),_callee5)}))),function isFreeLanguage(t,r,o){return a.apply(this,arguments)})},{key:"needsAdoption",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t,r,a){var i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee6$(d){for(;;)switch(d.prev=d.next){case 0:if(!(i=o.Z.AbilitiesNeedingAdaption[r.name])){d.next=26;break}if("text"!=i.items){d.next=9;break}return d.next=5,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:r});case 5:c=d.sent,u=function callback(o){var i={name:o.find('[name="entryselection"]').val()};SpecialabilityRulesDSA5._specialabilityReturnFunction(t,r,a,i)},d.next=22;break;case 9:if("array"!=i.items){d.next=17;break}return l=i.elems.map((function(t){return{name:t}})),d.next=13,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:l,original:r,area:i.area});case 13:c=d.sent,u=function callback(o){var i=l.find((function(t){return t.name==o.find('[name="entryselection"]').val()}));SpecialabilityRulesDSA5._specialabilityReturnFunction(t,r,a,i)},d.next=22;break;case 17:return p=t.items.filter((function(t){return i.items.includes(t.type)})).sort((function(t,r){return t.name.localeCompare(r.name)})),d.next=20,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:p,original:r,area:i.area});case 20:c=d.sent,u=function callback(o){var i=p.find((function(t){return t.name==o.find('[name="entryselection"]').val()}));i.customEntry=o.find('[name="custom"]').val(),SpecialabilityRulesDSA5._specialabilityReturnFunction(t,r,a,i)};case 22:return d.next=24,new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:c,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:u},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 24:d.next=27;break;case 26:SpecialabilityRulesDSA5._specialabilityReturnFunction(t,r,a,null);case 27:case"end":return d.stop()}}),_callee6)}))),function needsAdoption(t,a,o){return r.apply(this,arguments)})},{key:"hasAbility",value:function hasAbility(t,r){return _get(_getPrototypeOf(SpecialabilityRulesDSA5),"hasItem",this).call(this,t,r,["specialability"])}},{key:"abilityStep",value:function abilityStep(t,r){return _get(_getPrototypeOf(SpecialabilityRulesDSA5),"itemStep",this).call(this,t,r,["specialability"])}},{key:"abilityAsModifier",value:function abilityAsModifier(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return _get(_getPrototypeOf(SpecialabilityRulesDSA5),"itemAsModifier",this).call(this,t,r,a,["specialability"],o)}}]),SpecialabilityRulesDSA5}(i.Z);i.Z.children.SpecialabilityRulesDSA5=c},101:(t,r,a)=>{a.d(r,{Z:()=>u});var o=a(577),i=a(794),c=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var u=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(TraitRulesDSA5,t);var r,a=_createSuper(TraitRulesDSA5);function TraitRulesDSA5(){return _classCallCheck(this,TraitRulesDSA5),a.apply(this,arguments)}return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(TraitRulesDSA5,null,[{key:"traitAdded",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t,r){return _regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:if(!o.Z.addTraitRules[r.name]){a.next=3;break}return a.next=3,o.Z.addTraitRules[r.name](t,r);case 3:case"end":return a.stop()}}),_callee)}))),function traitAdded(t,a){return r.apply(this,arguments)})},{key:"hasTrait",value:function hasTrait(t,r){return _get(_getPrototypeOf(TraitRulesDSA5),"hasItem",this).call(this,t,r,["trait"])}}]),TraitRulesDSA5}(i.Z);Hooks.on("setup",(function(){var t=game.i18n.localize("LocalizedIDs.familiar");o.Z.addTraitRules[t]=function(){var r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(r,a){var o,u;return _regeneratorRuntime().wrap((function _callee2$(l){for(;;)switch(l.prev=l.next){case 0:if(0==a.effects.length&&(a.effects=[{changes:[{key:"system.status.wounds.gearmodifier",mode:2,value:10},{key:"system.status.soulpower.gearmodifier",mode:2,value:1},{key:"system.status.toughness.gearmodifier",mode:2,value:1},{key:"system.status.astralenergy.gearmodifier",mode:2,value:15},{key:"system.characteristics.mu.gearmodifier",mode:2,value:1},{key:"system.characteristics.kl.gearmodifier",mode:2,value:1},{key:"system.characteristics.in.gearmodifier",mode:2,value:1},{key:"system.characteristics.ch.gearmodifier",mode:2,value:1},{key:"system.characteristics.ff.gearmodifier",mode:2,value:1},{key:"system.characteristics.ge.gearmodifier",mode:2,value:1},{key:"system.characteristics.ko.gearmodifier",mode:2,value:1},{key:"system.characteristics.kk.gearmodifier",mode:2,value:1},{key:"system.totalArmor",mode:2,value:1}],duration:{},icon:"icons/svg/aura.svg",label:t,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:t,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}}}]),o=game.i18n.localize("LocalizedIDs.witchSense"),i.Z.hasItem(r,o,["trait"])){l.next=8;break}return l.next=5,c.Z.findAnyItem([{name:o,type:"trait"}]);case 5:return u=l.sent,l.next=8,r.createEmbeddedDocuments("Item",u);case 8:case"end":return l.stop()}}),_callee2)})));return function(t,a){return r.apply(this,arguments)}}()}))},491:(t,r,a)=>{a.d(r,{Z:()=>u});var o=a(369),i=a(846),c=a(577);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var u=function(){function DSA5_Utility(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSA5_Utility)}var t,r,a,u,l,p,d,h,m,y,g,v;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5_Utility,null,[{key:"skillByName",value:(v=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a;return _regeneratorRuntime().wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return r=game.packs.get("de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen"),o.next=3,r.getIndex();case 3:return a=r.index.find((function(r){return r.name===t})),o.next=6,r.getDocument(a._id);case 6:return o.abrupt("return",o.sent);case 7:case"end":return o.stop()}}),_callee)}))),function skillByName(t){return v.apply(this,arguments)})},{key:"allSkills",value:(g=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var t;return _regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return t="de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen",r.next=3,this.getCompendiumEntries(t,"skill");case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}),_callee2,this)}))),function allSkills(){return g.apply(this,arguments)})},{key:"moduleEnabled",value:function moduleEnabled(t){return game.modules.get(t)&&game.modules.get(t).active}},{key:"allCombatSkills",value:(y=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(){var t;return _regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return t="de"==game.i18n.lang?"dsa5.combatskills":"dsa5.combatskillsen",r.next=3,this.getCompendiumEntries(t,"combatskill");case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}),_callee3,this)}))),function allCombatSkills(){return y.apply(this,arguments)})},{key:"getCompendiumEntries",value:(m=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t,r){var a,o,i,c,u,l;return _regeneratorRuntime().wrap((function _callee4$(p){for(;;)switch(p.prev=p.next){case 0:return p.next=2,game.packs.get(t);case 2:if(a=p.sent){p.next=5;break}return p.abrupt("return",ui.notifications.error("No content found"));case 5:return o=[],p.next=8,a.getDocuments().then((function(t){return i=t.filter((function(t){return t.type==r}))}));case 8:c=_createForOfIteratorHelper(i);try{for(c.s();!(u=c.n()).done;)l=u.value,o.push(l.toObject())}catch(t){c.e(t)}finally{c.f()}return p.abrupt("return",o);case 11:case"end":return p.stop()}}),_callee4)}))),function getCompendiumEntries(t,r){return m.apply(this,arguments)})},{key:"renderToggle",value:function renderToggle(t){t.rendered?t._minimized?t.maximize():t.close():t.render(!0)}},{key:"calcTokenSize",value:function calcTokenSize(t,r){var a=game.dsa5.config.tokenSizeCategories[t.system.status.size.value];if(a)if(a<1)mergeObject(r,{texture:{scaleX:a,scaleY:a},width:1,height:1});else{var o=Math.floor(a),i=Math.max(a/o,.25);mergeObject(r,{width:o,height:o,texture:{scaleX:i,scaleY:i}})}}},{key:"allMoneyItems",value:(h=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(){var t;return _regeneratorRuntime().wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.getCompendiumEntries("dsa5.money","money");case 2:return t=r.sent.map((function(t){return t.system.quantity.value=0,t})),r.abrupt("return",t.filter((function(t){return Object.values(c.Z.moneyNames).map((function(t){return t.toLowerCase()})).includes(t.name.toLowerCase())})).sort((function(t,r){return t.system.price.value>r.system.price.value?-1:1})));case 4:case"end":return r.stop()}}),_callee5,this)}))),function allMoneyItems(){return h.apply(this,arguments)})},{key:"allSkillsList",value:(d=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(){return _regeneratorRuntime().wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.allSkills();case 2:if(t.t0=t.sent,t.t0){t.next=5;break}t.t0=[];case 5:return t.abrupt("return",t.t0.map((function(t){return t.name})).sort((function(t,r){return t.localeCompare(r)})));case 6:case"end":return t.stop()}}),_callee6,this)}))),function allSkillsList(){return d.apply(this,arguments)})},{key:"allCombatSkillsList",value:(p=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){return _regeneratorRuntime().wrap((function _callee7$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.allCombatSkills();case 2:if(r.t0=r.sent.filter((function(r){return r.system.weapontype.value==t})),r.t0){r.next=5;break}r.t0=[];case 5:return r.abrupt("return",r.t0.map((function(t){return t.name})).sort((function(t,r){return t.localeCompare(r)})));case 6:case"end":return r.stop()}}),_callee7,this)}))),function allCombatSkillsList(t){return p.apply(this,arguments)})},{key:"callItemTransformationMacro",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t,r,a){var o,i,c,u,l,p,d,h,m=arguments;return _regeneratorRuntime().wrap((function _callee8$(y){for(;;)switch(y.prev=y.next){case 0:if(o=m.length>3&&void 0!==m[3]?m[3]:{},i=t.split("."),c=game.packs.get("".concat(i[0],".").concat(i[1]))){y.next=6;break}return console.warn("Pack ".concat(c," not found")),y.abrupt("return",{});case 6:return y.next=8,c.getDocuments({name:i[2]});case 8:if(u=y.sent,l={},!u.length){y.next=27;break}return p=u[0],d="(async () => {".concat(p.command,"})()"),h=Function("args","source","effect",d),y.prev=14,o.result=l,y.next=18,h.call(this,o,r,a);case 18:y.next=25;break;case 20:y.prev=20,y.t0=y.catch(14),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(y.t0),l.error=!0;case 25:y.next=28;break;case 27:ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:t}));case 28:return y.abrupt("return",l);case 29:case"end":return y.stop()}}),_callee8,this,[[14,20]])}))),function callItemTransformationMacro(t,r,a){return l.apply(this,arguments)})},{key:"isActiveGM",value:function isActiveGM(){var t=game.users.find((function(t){return t.active&&t.isGM}));return t&&game.user.id==t.id}},{key:"parseAbilityString",value:function parseAbilityString(t){return{original:t.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:t.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((t.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(t.match(/\(([^()]+)\)/)||["",""])[1],type:t.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":t.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:null!=t.match(/[-+]\d{1,2}$/)}}},{key:"chatDataSetup",value:function chatDataSetup(t,r,a){var o={user:game.user.id,rollMode:r||game.settings.get("core","rollMode"),content:t};return["gmroll","blindroll"].includes(o.rollMode)&&(o.whisper=ChatMessage.getWhisperRecipients("GM").map((function(t){return t.id}))),"blindroll"===o.rollMode?o.blind=!0:"selfroll"===o.rollMode&&(o.whisper=[game.user]),a&&(o.speaker=ChatMessage.getSpeaker(),o.whisper=ChatMessage.getWhisperRecipients(a)),o}},{key:"getSpeaker",value:function getSpeaker(t){var r=ChatMessage.getSpeakerActor(t);if(!r&&canvas.tokens){var a=canvas.tokens.get(t.token);a&&(r=a.actor)}if(!r){var o=game.scenes.get(t.scene);try{o&&(r=new Token(o.getEmbeddedDocument("Token",t.token)).actor)}catch(t){}}return r}},{key:"fateAvailable",value:function fateAvailable(t,r){return r?game.settings.get("dsa5","groupschips").split("/").map((function(t){return Number(t)}))[0]>0:t.system.status.fatePoints.value>0}},{key:"_calculateAdvCost",value:function _calculateAdvCost(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return c.Z.advancementCosts[r][Number(t)+a]}},{key:"getFolderForType",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee9(t){var r,a,o,i,c,u,l=arguments;return _regeneratorRuntime().wrap((function _callee9$(p){for(;;)switch(p.prev=p.next){case 0:return r=l.length>1&&void 0!==l[1]?l[1]:null,a=l.length>2&&void 0!==l[2]?l[2]:null,o=l.length>3&&void 0!==l[3]?l[3]:0,i=l.length>4&&void 0!==l[4]?l[4]:"",c=l.length>5&&void 0!==l[5]?l[5]:void 0,p.next=7,game.folders.contents.find((function(o){var i;return o.name==a&&o.type==t&&(null===(i=o.folder)||void 0===i?void 0:i.id)==r}));case 7:if(u=p.sent){p.next=12;break}return p.next=11,Folder.create({name:a,type:t,sorting:c||("JournalEntry"==t?"a":"m"),color:i,sort:o,parent:r});case 11:u=p.sent;case 12:return p.abrupt("return",u);case 13:case"end":return p.stop()}}),_callee9)}))),function getFolderForType(t){return u.apply(this,arguments)})},{key:"toObjectIfPossible",value:function toObjectIfPossible(t){return"function"==typeof t.toObject?t.toObject(!1):duplicate(t)}},{key:"showArtwork",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee10(t){var r,a,o,i,c,u=arguments;return _regeneratorRuntime().wrap((function _callee10$(l){for(;;)switch(l.prev=l.next){case 0:r=t.img,a=t.name,o=t.uuid,i=t.isOwner,c=u.length>1&&void 0!==u[1]&&u[1],new ImagePopout(r,{title:c?i?a:"-":a,shareable:!0,uuid:o}).render(!0);case 3:case"end":return l.stop()}}),_callee10)}))),function showArtwork(t){return a.apply(this,arguments)})},{key:"findAnyItem",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee11(t){var r,a,o,i,c,u,l,p,d,h,m,y,g;return _regeneratorRuntime().wrap((function _callee11$(v){for(;;)switch(v.prev=v.next){case 0:r=[],a=t.map((function(t){return t.name})),o=t.map((function(t){return t.type})),i=_createForOfIteratorHelper(game.items.contents),v.prev=4,i.s();case 6:if((c=i.n()).done){v.next=14;break}if(u=c.value,(l=a.indexOf(u.name))>=0&&o[l]==u.type&&(a.splice(l,1),o.splice(l,1),r.push(u)),!(a.length<=0)){v.next=12;break}return v.abrupt("break",14);case 12:v.next=6;break;case 14:v.next=19;break;case 16:v.prev=16,v.t0=v.catch(4),i.e(v.t0);case 19:return v.prev=19,i.f(),v.finish(19);case 22:if(!(a.length>0)){v.next=46;break}p=/^dsa5-core/,d=Array.from(game.packs.keys()).sort((function(t,r){return p.test(t)&&p.test(r)&&t.localeCompare(r),p.test(r)?-1:p.test(t)?1:t.localeCompare(r)})),h=_createForOfIteratorHelper(d),v.prev=26,h.s();case 28:if((m=h.n()).done){v.next=38;break}if(y=m.value,"Item"!=(g=game.packs.get(y)).documentName||!game.user.isGM&&g.private){v.next=36;break}return v.next=34,g.getDocuments({name:{$in:a},type:{$in:o}}).then((function(t){var i,c=_createForOfIteratorHelper(t);try{for(c.s();!(i=c.n()).done;){var u=i.value,l=a.indexOf(u.name);l>=0&&o[l]==u.type&&(a.splice(l,1),o.splice(l,1),r.push(u.toObject()))}}catch(t){c.e(t)}finally{c.f()}}));case 34:if(!(a.length<=0)){v.next=36;break}return v.abrupt("break",38);case 36:v.next=28;break;case 38:v.next=43;break;case 40:v.prev=40,v.t1=v.catch(26),h.e(v.t1);case 43:return v.prev=43,h.f(),v.finish(43);case 46:return v.abrupt("return",r);case 47:case"end":return v.stop()}}),_callee11,null,[[4,16,19,22],[26,40,43,46]])}))),function findAnyItem(t){return r.apply(this,arguments)})},{key:"replaceDies",value:function replaceDies(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,o=r?"":"/roll ";return t.replace(a,(function(t){return" [[".concat(o).concat(t.replace(/[DwW]/,"d"),"]]")}))}},{key:"escapeRegex",value:function escapeRegex(t){return("string"==typeof t||t instanceof String?t:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}},{key:"replaceConditions",value:function replaceConditions(t){return t?t.replace(c.Z.statusRegex.regex,(function(t){return(0,i.q)([t])})):t}},{key:"experienceDescription",value:function experienceDescription(t){for(var r=["EXP.legendary","EXP.brillant","EXP.masterful","EXP.competent","EXP.experienced","EXP.average"],a=0,o=0,i=[2100,1700,1400,1200,1100,1e3];o<i.length;o++){var c=i[o];if(Number(t)>=Number(c))return r[a];a++}return"EXP.inexperienced"}},{key:"emptyActor",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee12(){var t,r,a=arguments;return _regeneratorRuntime().wrap((function _callee12$(i){for(;;)switch(i.prev=i.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:12,Array.isArray(t)||(t=[t,t,t,t,t,t,t,t]),i.next=4,o.Z.create({name:"Alrik",type:"npc",items:[],system:{status:{wounds:{value:50},fatePoints:{}},characteristics:{mu:{initial:t[0]},kl:{initial:t[1]},in:{initial:t[2]},ch:{initial:t[3]},ff:{initial:t[4]},ge:{initial:t[5]},ko:{initial:t[6]},kk:{initial:t[7]}}}},{temporary:!0,noHook:!0});case 4:return(r=i.sent).prepareData(),i.abrupt("return",r);case 7:case"end":return i.stop()}}),_callee12)}))),function emptyActor(){return t.apply(this,arguments)})}]),DSA5_Utility}()},707:(t,r,a)=>{a.d(r,{Jp:()=>slist,p0:()=>tinyNotification,x8:()=>itemFromDrop,zJ:()=>svgAutoFit});a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function _unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function svgAutoFit(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:320,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:40;t.attr({width:.8*r,viewBox:"0 0 ".concat(r," ").concat(a)});var o=t.find("text"),i=o.get(0).getBBox(),c=r/i.width,u=a/i.height,l=c<u,p=l?c:u;isFinite(p)&&o.attr({transform:"matrix("+p+", 0, 0, "+p+", 0,0)",x:Math.max(0,(r-i.width)/2),y:.75*a/(l?1:p)})}function itemFromDrop(t,r){return _itemFromDrop.apply(this,arguments)}function _itemFromDrop(){return _itemFromDrop=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a,o,i,c,u,l,p=arguments;return _regeneratorRuntime().wrap((function _callee2$(d){for(;;)switch(d.prev=d.next){case 0:if(o=!(p.length>2&&void 0!==p[2])||p[2],"Actor"!=t.type){d.next=8;break}return d.next=4,Actor.implementation.fromDropData(t);case 4:i=d.sent,c=r===i.id,d.next=12;break;case 8:return d.next=10,Item.implementation.fromDropData(t);case 10:i=d.sent,c=r===(null===(u=i.parent)||void 0===u?void 0:u.uuid);case 12:return l=null===(a=i)||void 0===a?void 0:a.type,o&&(i=i.toObject()),t.amount&&(i.system.quantity.value=Number(t.amount)),d.abrupt("return",{item:i,typeClass:l,selfTarget:c});case 16:case"end":return d.stop()}}),_callee2)}))),_itemFromDrop.apply(this,arguments)}function slist(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"div";if(r=t.find(r)[0]){r.classList.add("slist");var i,c=r.querySelectorAll(o),u=null,l=_createForOfIteratorHelper(c);try{for(l.s();!(i=l.n()).done;){var p=i.value;p.draggable=!0,p.addEventListener("dragstart",(function(t){u=this})),p.addEventListener("dragover",(function(t){t.preventDefault()})),p.addEventListener("drop",function(){var t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var o,i,l;return _regeneratorRuntime().wrap((function _callee$(p){for(;;)switch(p.prev=p.next){case 0:if(t.preventDefault(),this==u){p.next=7;break}for(o=0,i=0,l=0;l<c.length;l++)u==c[l]&&(o=l),this==c[l]&&(i=l);return o<i?this.parentNode.insertBefore(u,this.nextSibling):this.parentNode.insertBefore(u,this),p.next=7,a(r);case 7:case"end":return p.stop()}}),_callee,this)})));return function(r){return t.apply(this,arguments)}}())}}catch(t){l.e(t)}finally{l.f()}}}function tinyNotification(t){var r=$(".tinyNotifications");r.length||($("body").append('<ul class="tinyNotifications"></ul>'),r=$(".tinyNotifications"));var a=$("<li>".concat(t,"</li>"));r.prepend(a),setTimeout((function(){a.remove()}),1500)}},430:(t,r,a)=>{a.d(r,{Z:()=>c});var o=a(577),i=a(491);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var c=function(){function DSATables(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSATables)}var t,r,a,c;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSATables,null,[{key:"showBotchCard",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a,c,u,l,p,d=arguments;return _regeneratorRuntime().wrap((function _callee$(h){for(;;)switch(h.prev=h.next){case 0:return r=d.length>1&&void 0!==d[1]?d[1]:{},a=o.Z.systemTables.find((function(r){return r.name==t.table})),h.next=4,DSATables.getRollTable(a.pack[game.i18n.lang],game.i18n.localize("TABLENAMES.".concat(t.table)),t);case 4:return c=h.sent,u=i.Z.replaceDies(i.Z.replaceConditions(c.results[0].text)),l="".concat(game.i18n.localize("TABLENAMES."+t.table)),h.next=9,renderTemplate("systems/dsa5/templates/tables/tableCard.html",{result:u,title:l});case 9:p=h.sent,ChatMessage.create({user:game.user.id,content:p,whisper:r.whisper,blind:r.blind});case 11:case"end":return h.stop()}}),_callee)}))),function showBotchCard(t){return c.apply(this,arguments)})},{key:"getRollTable",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t,r){var a,o,i,c,u=arguments;return _regeneratorRuntime().wrap((function _callee2$(l){for(;;)switch(l.prev=l.next){case 0:return a=u.length>2&&void 0!==u[2]?u[2]:{},o=game.packs.get(t),l.next=4,o.getDocuments({name:{$in:[r]}});case 4:return i=l.sent[0],l.next=7,i.draw({displayChat:!1});case 7:if(c=l.sent,!("true"==a.weaponless&&c.roll.total<7)){l.next=13;break}return c.roll.editRollAtIndex([{index:0,val:c.roll.total+5}]),l.next=12,i.draw({displayChat:!1,roll:c.roll});case 12:c=l.sent;case 13:return l.abrupt("return",c);case 14:case"end":return l.stop()}}),_callee2)}))),function getRollTable(t,r){return a.apply(this,arguments)})},{key:"tableEnabledFor",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t){var r;return _regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return r=o.Z.systemTables.find((function(r){return r.name==t})),a.abrupt("return",!!r&&game.settings.get(r.setting.module,r.setting.key));case 2:case"end":return a.stop()}}),_callee3)}))),function tableEnabledFor(t){return r.apply(this,arguments)})},{key:"rollCritBotchButton",value:function rollCritBotchButton(t,r){var a=game.i18n.localize("TABLENAMES.".concat(t));return', <a class="roll-button botch-roll" data-table="'.concat(t,'" data-weaponless="').concat(r,'}"><i class="fas fa-dice"></i>').concat(a,"</a>")}},{key:"defaultBotch",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(){return _regeneratorRuntime().wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=", "+game.i18n.localize("selfDamage"),t.next=3,new Roll("1d6+2").evaluate({async:!0});case 3:return t.t1=t.sent.total,t.abrupt("return",t.t0+t.t1);case 5:case"end":return t.stop()}}),_callee4)}))),function defaultBotch(){return t.apply(this,arguments)})},{key:"defaultAttackCrit",value:function defaultAttackCrit(t){var r=", "+game.i18n.localize("halfDefense");return t&&(r+=", "+game.i18n.localize("doubleDamage")),r}},{key:"defaultParryCrit",value:function defaultParryCrit(){return", "+game.i18n.localize("attackOfOpportunity")}}]),DSATables}()},93:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=_isNativeReflectConstruct();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}__webpack_require__.d(__webpack_exports__,{Z:()=>DSATour});var DSATour=function(_Tour){_inherits(DSATour,_Tour);var _super=_createSuper(DSATour),_travelAgency,_preStep2;function DSATour(){return _classCallCheck(this,DSATour),_super.apply(this,arguments)}return _createClass(DSATour,[{key:"_preStep",value:(_preStep2=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(){return _regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(!this.currentStep.activateTab){t.next=4;break}ui.sidebar.activateTab(this.currentStep.activateTab),t.next=12;break;case 4:if(!this.currentStep.activateLayer||canvas.activeLayer.options.name==this.currentStep.activateLayer){t.next=11;break}return t.next=7,canvas[this.currentStep.activateLayer].activate();case 7:return t.next=9,delay(100);case 9:t.next=12;break;case 11:this.currentStep.appTab&&this.app.activateTab(this.currentStep.appTab);case 12:case"end":return t.stop()}}),_callee,this)}))),function _preStep(){return _preStep2.apply(this,arguments)})},{key:"exit",value:function exit(){_get(_getPrototypeOf(DSATour.prototype),"exit",this).call(this)}},{key:"start",value:function(){var _start=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var fn,res;return _regeneratorRuntime().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(!this.config.preCommand){_context2.next=6;break}return _context2.next=3,eval("(async() => { ".concat(this.config.preCommand," })"));case 3:return fn=_context2.sent,_context2.next=6,fn();case 6:if(!this.app){_context2.next=14;break}return _context2.next=9,this.app.render(!0,{focus:!0});case 9:if(this.app.rendered){_context2.next=14;break}return _context2.next=12,delay(50);case 12:_context2.next=9;break;case 14:if(!this.app&&!this.config.preCommand){_context2.next=20;break}case 15:if($(this.steps[this.stepIndex+1].selector+":visible").length){_context2.next=20;break}return _context2.next=18,delay(50);case 18:_context2.next=15;break;case 20:return _context2.next=22,_get(_getPrototypeOf(DSATour.prototype),"start",this).call(this);case 22:return res=_context2.sent,$("#tooltip").show(),_context2.abrupt("return",res);case 25:case"end":return _context2.stop()}}),_callee2,this)})));function start(){return _start.apply(this,arguments)}return start}()}],[{key:"travelAgency",value:(_travelAgency=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(){var t,r,a,o,i,c,u,l,p;return _regeneratorRuntime().wrap((function _callee3$(d){for(;;)switch(d.prev=d.next){case 0:t="de"==game.i18n.lang?"de":"en",console.log("Adding DSA/TDE Tours"),r=_createForOfIteratorHelper(this.tours),d.prev=3,r.s();case 5:if((a=r.n()).done){d.next=13;break}return o=a.value,d.next=9,game.dsa5.apps.DSATour.fromJSON("".concat(o.replace("/lang/","/".concat(t,"/")),".json"));case 9:i=d.sent,game.tours.register(i.config.module,i.id,i);case 11:d.next=5;break;case 13:d.next=18;break;case 15:d.prev=15,d.t0=d.catch(3),r.e(d.t0);case 18:return d.prev=18,r.f(),d.finish(18);case 21:if(game.user.isGM){d.next=23;break}return d.abrupt("return");case 23:c=_createForOfIteratorHelper(this.gmTours),d.prev=24,c.s();case 26:if((u=c.n()).done){d.next=34;break}return l=u.value,d.next=30,game.dsa5.apps.DSATour.fromJSON("".concat(l.replace("/lang/","/".concat(t,"/")),".json"));case 30:p=d.sent,game.tours.register(p.config.module,p.id,p);case 32:d.next=26;break;case 34:d.next=39;break;case 36:d.prev=36,d.t1=d.catch(24),c.e(d.t1);case 39:return d.prev=39,c.f(),d.finish(39);case 42:case"end":return d.stop()}}),_callee3,this,[[3,15,18,21],[24,36,39,42]])}))),function travelAgency(){return _travelAgency.apply(this,arguments)})}]),DSATour}(Tour);function delay(t){return new Promise((function(r){return setTimeout(r,t)}))}_defineProperty(DSATour,"tours",["systems/dsa5/modules/tours/lang/initial","systems/dsa5/modules/tours/lang/library","systems/dsa5/modules/tours/lang/actor"]),_defineProperty(DSATour,"gmTours",["systems/dsa5/modules/tours/lang/mastermenu"])}},__webpack_module_cache__={};function __webpack_require__(t){var r=__webpack_module_cache__[t];if(void 0!==r)return r.exports;var a=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](a,a.exports,__webpack_require__),a.exports}__webpack_require__.d=(t,r)=>{for(var a in r)__webpack_require__.o(r,a)&&!__webpack_require__.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},__webpack_require__.o=(t,r)=>Object.prototype.hasOwnProperty.call(t,r);var __webpack_exports__={};(()=>{var t=__webpack_require__(491),r=__webpack_require__(577),a=__webpack_require__(272),o=__webpack_require__(839),i=__webpack_require__(173),c=__webpack_require__(947),u=__webpack_require__(973);function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function _regeneratorRuntime(){_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function _slicedToArray(t,r){return function _arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function _iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||_unsupportedIterableToArray(t,r)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return _arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,r):void 0}}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function _asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function _defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var l=function(){function Migrakel(){!function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,Migrakel)}var t,r,a,o,i,c,u,l;return function _createClass(t,r,a){return r&&_defineProperties(t.prototype,r),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(Migrakel,null,[{key:"showDialog",value:(l=_asyncToGenerator(_regeneratorRuntime().mark((function _callee(t){var r,a,o;return _regeneratorRuntime().wrap((function _callee$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,new Promise((function(r,a){new Dialog({title:game.i18n.localize("Migrakel.Migration"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(){r([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function callback(){r([!1])}}},close:function close(){r([!1])}}).render(!0)}));case 2:return r=i.sent,a=_slicedToArray(r,1),o=a[0],i.abrupt("return",o);case 6:case"end":return i.stop()}}),_callee)}))),function showDialog(t){return l.apply(this,arguments)})},{key:"refreshStatusEffects",value:(u=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(t){var r,a,o,i,c;return _regeneratorRuntime().wrap((function _callee2$(u){for(;;)switch(u.prev=u.next){case 0:r=[],a=_createForOfIteratorHelper(t.effects),u.prev=2,a.s();case 4:if((o=a.n()).done){u.next=19;break}if(!(i=o.value).origin){u.next=17;break}return c=void 0,u.prev=8,u.next=11,fromUuid(i.origin);case 11:c=u.sent,u.next=16;break;case 14:u.prev=14,u.t0=u.catch(8);case 16:c||r.push(i.id);case 17:u.next=4;break;case 19:u.next=24;break;case 21:u.prev=21,u.t1=u.catch(2),a.e(u.t1);case 24:return u.prev=24,a.f(),u.finish(24);case 27:return u.next=29,t.deleteEmbeddedDocuments("ActiveEffect",r);case 29:case"end":return u.stop()}}),_callee2,null,[[2,21,24,27],[8,14]])}))),function refreshStatusEffects(t){return u.apply(this,arguments)})},{key:"updateVals",value:(c=_asyncToGenerator(_regeneratorRuntime().mark((function _callee3(t,r,a){var o,i,c,u,l,p,d,h,m,y,g,v,_,b;return _regeneratorRuntime().wrap((function _callee3$(w){for(;;)switch(w.prev=w.next){case 0:return o=game.dsa5.itemLibrary,i=[],c=[],u=new Map,w.next=6,this.refreshStatusEffects(t);case 6:if(!r({type:"equipment"})){w.next=34;break}l=[],p=[],d=_createForOfIteratorHelper(t.items.filter((function(t){return"equipment"==t.type&&"bags"==t.system.equipmentType.value}))),w.prev=10,m=_regeneratorRuntime().mark((function _loop(){var t,r,i;return _regeneratorRuntime().wrap((function _loop$(c){for(;;)switch(c.prev=c.next){case 0:return t=h.value,c.next=3,o.findCompendiumItem(t.name,t.type);case 3:if(!((r=c.sent).length>0)){c.next=12;break}if(r=r.find((function(r){return r.name==t.name&&r.type==t.type}))){c.next=8;break}return c.abrupt("return","continue");case 8:console.log("MIGRATION - Updated ".concat(t.name)),i=mergeObject(t.toObject(),a(r)),p.push(i),l.push(t.id);case 12:case"end":return c.stop()}}),_loop)})),d.s();case 13:if((h=d.n()).done){w.next=20;break}return w.delegateYield(m(),"t0",15);case 15:if("continue"!==w.t0){w.next=18;break}return w.abrupt("continue",18);case 18:w.next=13;break;case 20:w.next=25;break;case 22:w.prev=22,w.t1=w.catch(10),d.e(w.t1);case 25:return w.prev=25,d.f(),w.finish(25);case 28:return w.next=30,t.createEmbeddedDocuments("Item",p);case 30:for(y=w.sent,g=0;g<y.length;g++)u.set(l[g],y[g].id);return w.next=34,t.deleteEmbeddedDocuments("Item",l);case 34:v=_createForOfIteratorHelper(t.items.filter((function(t){return r(t)&&!("equipment"==t.type&&"bags"==t.system.equipmentType.value)}))),w.prev=35,b=_regeneratorRuntime().mark((function _loop2(){var t,r,l;return _regeneratorRuntime().wrap((function _loop2$(p){for(;;)switch(p.prev=p.next){case 0:return t=_.value,p.next=3,o.findCompendiumItem(t.name,t.type);case 3:if(!((r=p.sent).length>0)){p.next=13;break}if(r=r.find((function(r){return r.name==t.name&&r.type==t.type}))){p.next=8;break}return p.abrupt("return","continue");case 8:console.log("MIGRATION - Updated ".concat(t.name)),(l=mergeObject(t.toObject(),a(r))).system.parent_id&&u.has(l.system.parent_id)&&(l.system.parent_id=u.get(l.system.parent_id)),c.push(l),i.push(t.id);case 13:case"end":return p.stop()}}),_loop2)})),v.s();case 38:if((_=v.n()).done){w.next=45;break}return w.delegateYield(b(),"t2",40);case 40:if("continue"!==w.t2){w.next=43;break}return w.abrupt("continue",43);case 43:w.next=38;break;case 45:w.next=50;break;case 47:w.prev=47,w.t3=w.catch(35),v.e(w.t3);case 50:return w.prev=50,v.f(),w.finish(50);case 53:return w.next=55,t.createEmbeddedDocuments("Item",c);case 55:return w.next=57,t.deleteEmbeddedDocuments("Item",i);case 57:ui.notifications.notify(game.i18n.localize("Migrakel.migrationDone"));case 58:case"end":return w.stop()}}),_callee3,this,[[10,22,25,28],[35,47,50,53]])}))),function updateVals(t,r,a){return c.apply(this,arguments)})},{key:"updateSpellsAndLiturgies",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(t){var r,a;return _regeneratorRuntime().wrap((function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.showDialog(game.i18n.localize("Migrakel.spells"));case 2:if(!o.sent){o.next=7;break}return r=function condition(t){return["spell","liturgy","ritual","ceremony","spellextension"].includes(t.type)},a=function updator(t){var r={effects:t.effects.toObject()};return"spellextension"!=t.type&&(r.system={effectFormula:{value:t.system.effectFormula.value}}),r},o.next=7,this.updateVals(t,r,a);case 7:case"end":return o.stop()}}),_callee4,this)}))),function updateSpellsAndLiturgies(t){return i.apply(this,arguments)})},{key:"updateSpecialAbilities",value:(o=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(t){var r,a,o=this;return _regeneratorRuntime().wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.showDialog(game.i18n.localize("Migrakel.abilities"));case 2:if(!i.sent){i.next=7;break}return r=function updator(t){var r={system:{effect:{value:t.system.effect.value}},effects:t.effects.toObject()};return"specialability"==t.type&&(mergeObject(r,{system:{category:{sub:t.system.category.sub||0},list:{value:t.system.list.value}}}),"staff"==t.system.category.value&&mergeObject(r,{system:{feature:getProperty(t,"system.feature")||"",AsPCost:getProperty(t,"system.AsPCost")||"",volume:Number(getProperty(t,"system.volume"))||0,artifact:getProperty(t,"system.artifact")||""}})),o.updateMacro(r,t),r},a=function condition(t){return["specialability","advantage","disadvantage","trait"].includes(t.type)},i.next=7,this.updateVals(t,a,r);case 7:case"end":return i.stop()}}),_callee5,this)}))),function updateSpecialAbilities(t){return o.apply(this,arguments)})},{key:"updateCombatskills",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function _callee6(t){var r,a;return _regeneratorRuntime().wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.showDialog(game.i18n.localize("Migrakel.cskills"));case 2:if(!o.sent){o.next=7;break}return r=function updator(t){return{effects:t.effects.toObject()}},a=function condition(t){return["combatskill"].includes(t.type)},o.next=7,this.updateVals(t,a,r);case 7:case"end":return o.stop()}}),_callee6,this)}))),function updateCombatskills(t){return a.apply(this,arguments)})},{key:"updateSkills",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function _callee7(t){var r,a;return _regeneratorRuntime().wrap((function _callee7$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.showDialog(game.i18n.localize("Migrakel.skills"));case 2:if(!o.sent){o.next=7;break}return r=function condition(t){return["skill"].includes(t.type)},a=function updator(t){return{img:t.img}},o.next=7,this.updateVals(t,r,a);case 7:case"end":return o.stop()}}),_callee7,this)}))),function updateSkills(t){return r.apply(this,arguments)})},{key:"updateMacro",value:function updateMacro(t,r){var a=r.getFlag("dsa5","onUseEffect");a&&mergeObject(t,{flags:{dsa5:{onUseEffect:a}}})}},{key:"updateGear",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function _callee8(t){var r,a,o=this;return _regeneratorRuntime().wrap((function _callee8$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.showDialog(game.i18n.localize("Migrakel.gear"));case 2:if(!i.sent){i.next=7;break}return r=function condition(t){return["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(t.type)},a=function updator(t){var r={img:t.img,effects:t.effects.toObject()};return["poison","consumable"].includes(t.type)||mergeObject(r,{system:{effect:{value:t.system.effect.value}}}),["armor"].includes(t.type)&&mergeObject(r,{system:{subcategory:t.system.subcategory}}),["meleeweapon","rangeweapon","armor"].includes(t.type)&&mergeObject(r,{system:{structure:{max:t.system.structure.max,value:t.system.structure.value}}}),o.updateMacro(r,t),r},i.next=7,this.updateVals(t,r,a);case 7:case"end":return i.stop()}}),_callee8,this)}))),function updateGear(r){return t.apply(this,arguments)})}]),Migrakel}();function dialog_actorConfig_typeof(t){return dialog_actorConfig_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dialog_actorConfig_typeof(t)}function dialog_actorConfig_regeneratorRuntime(){dialog_actorConfig_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==dialog_actorConfig_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function dialog_actorConfig_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function dialog_actorConfig_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){dialog_actorConfig_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){dialog_actorConfig_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function dialog_actorConfig_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},_get.apply(this,arguments)}function _superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=_getPrototypeOf(t)););return t}function _setPrototypeOf(t,r){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},_setPrototypeOf(t,r)}function _createSuper(t){var r=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=_getPrototypeOf(t);if(r){var i=_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return _possibleConstructorReturn(this,a)}}function _possibleConstructorReturn(t,r){if(r&&("object"===dialog_actorConfig_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}var p=function(t){!function _inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&_setPrototypeOf(t,r)}(DialogActorConfig,Dialog);var r,a,o=_createSuper(DialogActorConfig);function DialogActorConfig(t,r){var a;return function dialog_actorConfig_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DialogActorConfig),(a=o.call(this,r)).actor=t,a.lock=!1,a}return function dialog_actorConfig_createClass(t,r,a){return r&&dialog_actorConfig_defineProperties(t.prototype,r),a&&dialog_actorConfig_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DialogActorConfig,[{key:"updateWrapper",value:(a=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee2(t,r){var a,o=this;return dialog_actorConfig_regeneratorRuntime().wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:if(!this.lock){i.next=2;break}return i.abrupt("return");case 2:a=function(){var a=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee(){return dialog_actorConfig_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return o.lock=!0,$(r.currentTarget).prepend('<i class="fas fa-spinner fa-spin"></i>'),a.next=4,l[t](o.actor);case 4:$(r.currentTarget).find("i").remove(),o.lock=!1;case 6:case"end":return a.stop()}}),_callee)})));return function upd(){return a.apply(this,arguments)}}(),a();case 4:case"end":return i.stop()}}),_callee2,this)}))),function updateWrapper(t,r){return a.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;_get(_getPrototypeOf(DialogActorConfig.prototype),"activateListeners",this).call(this,t),t.find(".updateSpells").click(function(){var t=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee3(t){return dialog_actorConfig_regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.updateWrapper("updateSpellsAndLiturgies",t));case 1:case"end":return a.stop()}}),_callee3)})));return function(r){return t.apply(this,arguments)}}()),t.find(".updateAbilities").click(function(){var t=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee4(t){return dialog_actorConfig_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.updateWrapper("updateSpecialAbilities",t));case 1:case"end":return a.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()),t.find(".updatecSkills").click(function(){var t=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee5(t){return dialog_actorConfig_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.updateWrapper("updateCombatskills",t));case 1:case"end":return a.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}()),t.find(".updateSkills").click(function(){var t=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee6(t){return dialog_actorConfig_regeneratorRuntime().wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.updateWrapper("updateSkills",t));case 1:case"end":return a.stop()}}),_callee6)})));return function(r){return t.apply(this,arguments)}}()),t.find(".updateGear").click(function(){var t=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee7(t){return dialog_actorConfig_regeneratorRuntime().wrap((function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.updateWrapper("updateGear",t));case 1:case"end":return a.stop()}}),_callee7)})));return function(r){return t.apply(this,arguments)}}())}}],[{key:"buildDialog",value:(r=dialog_actorConfig_asyncToGenerator(dialog_actorConfig_regeneratorRuntime().mark((function _callee8(t){var r;return dialog_actorConfig_regeneratorRuntime().wrap((function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,renderTemplate("systems/dsa5/templates/actors/parts/actorConfig.html",{actor:t});case 2:r=a.sent,new DialogActorConfig(t,{title:game.i18n.localize("SHEET.actorConfig"),content:r,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Save"),callback:function callback(r){var a={"system.config.autoBar":r.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":r.find('[name="autoSize"]').is(":checked")};t.update(a)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 4:case"end":return a.stop()}}),_callee8)}))),function buildDialog(t){return r.apply(this,arguments)})}]),DialogActorConfig}(),d=__webpack_require__(369),h=__webpack_require__(707),m=__webpack_require__(803),y=__webpack_require__(122),g=__webpack_require__(604);function bindImgToCanvasDragStart(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"img";game.user.isGM&&t.find(r).each((function(t,r){r.setAttribute("draggable",!0),r.addEventListener("dragstart",(function(t){return v(t)}))}))}var v=function dragTileImg(t){canvas.tiles.activate();var r=t.currentTarget.src,a=t.currentTarget,o=canvas.dimensions.sceneHeight/a.naturalHeight,i=canvas.dimensions.sceneWidth/a.naturalWidth,c=Math.min(1,i,o),u={type:"Tile",texture:{src:r},tileSize:Math.round(canvas.dimensions.size/c)};t.dataTransfer.setData("text/plain",JSON.stringify(u));var l=a.naturalWidth*c*canvas.stage.scale.x,p=a.naturalHeight*c*canvas.stage.scale.y,d=DragDrop.createDragImage(a,l,p);t.dataTransfer.setDragImage(d,l/2,p/2)},_=__webpack_require__(231);function actor_sheet_typeof(t){return actor_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},actor_sheet_typeof(t)}function _toConsumableArray(t){return function _arrayWithoutHoles(t){if(Array.isArray(t))return actor_sheet_arrayLikeToArray(t)}(t)||function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||actor_sheet_unsupportedIterableToArray(t)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function actor_sheet_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=actor_sheet_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function actor_sheet_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return actor_sheet_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?actor_sheet_arrayLikeToArray(t,r):void 0}}function actor_sheet_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function actor_sheet_regeneratorRuntime(){actor_sheet_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==actor_sheet_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function actor_sheet_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function actor_sheet_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){actor_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){actor_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function actor_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function actor_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function actor_sheet_createClass(t,r,a){return r&&actor_sheet_defineProperties(t.prototype,r),a&&actor_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function actor_sheet_get(){return actor_sheet_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=actor_sheet_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},actor_sheet_get.apply(this,arguments)}function actor_sheet_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=actor_sheet_getPrototypeOf(t)););return t}function actor_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&actor_sheet_setPrototypeOf(t,r)}function actor_sheet_setPrototypeOf(t,r){return actor_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},actor_sheet_setPrototypeOf(t,r)}function actor_sheet_createSuper(t){var r=function actor_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=actor_sheet_getPrototypeOf(t);if(r){var i=actor_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return actor_sheet_possibleConstructorReturn(this,a)}}function actor_sheet_possibleConstructorReturn(t,r){if(r&&("object"===actor_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function actor_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function actor_sheet_getPrototypeOf(t){return actor_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},actor_sheet_getPrototypeOf(t)}var b=function(l){actor_sheet_inherits(ActorSheetDsa5,ActorSheet);var v,b,k,x,S,T,A,O,P,E,C,D,I,R,L,G,M,j,z,N,H,W,B,Z,q,U,Y,V,K,J,Q,X,ee,te,re,ne,ae,oe,ie,ce=actor_sheet_createSuper(ActorSheetDsa5);function ActorSheetDsa5(){return actor_sheet_classCallCheck(this,ActorSheetDsa5),ce.apply(this,arguments)}return actor_sheet_createClass(ActorSheetDsa5,[{key:"actorType",get:function get(){return this.actor.type}},{key:"_render",value:(ie=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee(){var t,r,a,o=arguments;return actor_sheet_regeneratorRuntime().wrap((function _callee$(i){for(;;)switch(i.prev=i.next){case 0:return t=o.length>0&&void 0!==o[0]&&o[0],r=o.length>1&&void 0!==o[1]?o[1]:{},this._saveSearchFields(),this._saveCollapsed(),i.next=6,actor_sheet_get(actor_sheet_getPrototypeOf(ActorSheetDsa5.prototype),"_render",this).call(this,t,r);case 6:this._setCollapsed(),this._restoreSeachFields(),(a=$(this._element)).find(".close").attr("data-tooltip",game.i18n.localize("SHEET.Close")),a.find(".configure-sheet").attr("data-tooltip",game.i18n.localize("SHEET.Configure")),a.find(".configure-token").attr("data-tooltip",game.i18n.localize("SHEET.Token")),a.find(".import").attr("data-tooltip",game.i18n.localize("SHEET.Import")),a.find(".locksheet").attr("data-tooltip",game.i18n.localize("SHEET.Lock")),a.find(".library").attr("data-tooltip",game.i18n.localize("SHEET.Library")),a.find(".playerview").attr("data-tooltip",game.i18n.localize("SHEET.switchLimited")),a.find(".actorConfig").attr("data-tooltip",game.i18n.localize("SHEET.actorConfig")),this.currentFocus&&(a.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null);case 18:case"end":return i.stop()}}),_callee,this)}))),function _render(){return ie.apply(this,arguments)})},{key:"_saveSearchFields",value:function _saveSearchFields(){if(null!==this.form){var t=$(this.form).parent();this.searchFields={talentFiltered:$(t.find(".filterTalents")).hasClass("filtered"),searchText:$(t.find(".talentSearch")).val(),gearSearch:$(t.find(".gearSearch")).val()}}}},{key:"_restoreSeachFields",value:function _restoreSeachFields(){if(null!=this.searchFields){var t=$(this.form).parent();this.searchFields.talentFiltered&&($(t.find(".filterTalents")).addClass("filtered"),$(t.find(".allTalents")).removeClass("showAll"));var r=$(t.find(".talentSearch"));r.val(this.searchFields.searchText),""!=this.searchFields.searchText&&this._filterTalents(r);var a=$(t.find(".gearSearch"));a.val(this.searchFields.gearSearch),""!=this.searchFields.searchText&&this._filterGear(a)}}},{key:"_saveCollapsed",value:function _saveCollapsed(){if(null!==this.form){var t=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];var r,a=actor_sheet_createForOfIteratorHelper(t.find(".ch-collapse i"));try{for(a.s();!(r=a.n()).done;){var o=r.value;this.collapsedBoxes.push($(o).attr("class"))}}catch(t){a.e(t)}finally{a.f()}var i,c=actor_sheet_createForOfIteratorHelper($(t.find(".expandDetails.shown")));try{for(c.s();!(i=c.n()).done;){var u=i.value;this.openDetails.push($(u).closest(".item").attr("data-item-id"))}}catch(t){c.e(t)}finally{c.f()}}}},{key:"_setCollapsed",value:function _setCollapsed(){var t=$(this.form).parent();if(this.collapsedBoxes)for(var r=t.find(".ch-collapse i"),a=0;a<r.length;a++)$(r[a]).attr("class",this.collapsedBoxes[a]),this.collapsedBoxes[a]&&-1!=this.collapsedBoxes[a].indexOf("fa-angle-down")&&$(r[a]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}},{key:"getData",value:(oe=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee2(t){var a,o,i;return actor_sheet_regeneratorRuntime().wrap((function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,actor_sheet_get(actor_sheet_getPrototypeOf(ActorSheetDsa5.prototype),"getData",this).call(this,t);case 2:return a=c.sent,o={actor:a.actor,editable:a.editable,limited:a.limited,owner:a.owner},i=this.actor.prepareSheet({details:this.openDetails}),mergeObject(o.actor,i),o.sizeCategories=r.Z.sizeCategories,o.isGM=game.user.isGM,o.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},u.Z.prepareActiveEffects(this.actor,o),c.next=12,TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.ownerdescription"),{secrets:!0,async:!0});case 12:return o.enrichedOwnerdescription=c.sent,c.next=15,TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.gmdescription"),{secrets:!0,async:!0});case 15:return o.enrichedGmdescription=c.sent,c.next=18,TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.value"),{secrets:!0,async:!0});case 18:return o.enrichedNotes=c.sent,c.next=21,TextEditor.enrichHTML(getProperty(this.actor.system,"details.biography.value"),{secrets:!0,async:!0});case 21:return o.enrichedBiography=c.sent,c.abrupt("return",o);case 23:case"end":return c.stop()}}),_callee2,this)}))),function getData(t){return oe.apply(this,arguments)})},{key:"_onItemCreate",value:function _onItemCreate(t){t.preventDefault();var a=t.currentTarget,i=duplicate(a.dataset);r.Z.equipmentTypes[i.type]&&(i.type="equipment",i=mergeObject(i,{"system.equipmentType.value":t.currentTarget.attributes["item-section"].value,"system.effect.value":""})),"aggregatedTest"==i.type||"spell"==i.type||"liturgy"==i.type||(i["system.weight.value"]=0,i["system.quantity.value"]=0),o.Z.defaultIcon(i),i.name=game.i18n.localize(i.type),this.actor.createEmbeddedDocuments("Item",[i])}},{key:"_handleAggregatedProbe",value:function _handleAggregatedProbe(r){var a=this,o=this._getItemId(r),i=this.actor.items.get(o).toObject(),c=this.actor.items.find((function(t){return t.name==i.system.talent.value&&"skill"==t.type})),u='<h3 class="center"><b>'.concat(game.i18n.localize("aggregatedTest"),"</b></h3>");i.system.usedTestCount.value>=i.system.allowedTestCount.value?(u+="".concat(game.i18n.localize("Aggregated.noMoreAllowed")),ChatMessage.create(t.Z.chatDataSetup(u))):this.actor.setupSkill(c,{moreModifiers:[{name:game.i18n.localize("failedTests"),value:-1*i.system.previousFailedTests.value,selected:!0},{name:game.i18n.localize("Modifier"),value:i.system.baseModifier,selected:!0}]},this.getTokenId()).then((function(t){a.actor.basicTest(t).then((function(t){t.result.successLevel>0?(i.system.cummulatedQS.value=t.result.qualityStep+i.system.cummulatedQS.value,i.system.cummulatedQS.value=Math.min(10,i.system.cummulatedQS.value)):i.system.previousFailedTests.value+=1,i.system.usedTestCount.value+=1,a.actor.updateEmbeddedDocuments("Item",[i]).then((function(t){return a.actor.items.get(o).postItem()}))}))}))}},{key:"consumeItem",value:(ae=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee3(t){var r=this;return actor_sheet_regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+t.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+t.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(){t.setupEffect(null,{},r.getTokenId())}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 1:case"end":return a.stop()}}),_callee3)}))),function consumeItem(t){return ae.apply(this,arguments)})},{key:"_advanceAttribute",value:(ne=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee4(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee4$(i){for(;;)switch(i.prev=i.next){case 0:return a=Number(this.actor.system.characteristics[r].advances)+Number(this.actor.system.characteristics[r].initial),o=t.Z._calculateAdvCost(a,"E"),i.next=4,this._checkEnoughXP(o);case 4:if(!i.sent){i.next=7;break}return i.next=7,this._updateAPs(o,_defineProperty({},"system.characteristics.".concat(r,".advances"),Number(this.actor.system.characteristics[r].advances)+1));case 7:case"end":return i.stop()}}),_callee4,this)}))),function _advanceAttribute(t){return ne.apply(this,arguments)})},{key:"_refundAttributeAdvance",value:(re=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee5(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:if(a=Number(this.actor.system.characteristics[r].advances)+Number(this.actor.system.characteristics[r].initial),!(Number(this.actor.system.characteristics[r].advances)>0)){i.next=5;break}return o=-1*t.Z._calculateAdvCost(a,"E",0),i.next=5,this._updateAPs(o,_defineProperty({},"system.characteristics.".concat(r,".advances"),Number(this.actor.system.characteristics[r].advances)-1));case 5:case"end":return i.stop()}}),_callee5,this)}))),function _refundAttributeAdvance(t){return re.apply(this,arguments)})},{key:"_advancePoints",value:(te=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee6(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return a=Number(this.actor.system.status[r].advances),o=t.Z._calculateAdvCost(a,"D"),i.next=4,this._checkEnoughXP(o);case 4:if(i.t0=i.sent,!i.t0){i.next=7;break}i.t0=this._checkMaximumPointAdvancement(r,a+1);case 7:if(!i.t0){i.next=10;break}return i.next=10,this._updateAPs(o,_defineProperty({},"system.status.".concat(r,".advances"),Number(this.actor.system.status[r].advances)+1));case 10:case"end":return i.stop()}}),_callee6,this)}))),function _advancePoints(t){return te.apply(this,arguments)})},{key:"_refundPointsAdvance",value:(ee=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee7(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:if(!((a=Number(this.actor.system.status[r].advances))>0)){i.next=5;break}return o=-1*t.Z._calculateAdvCost(a,"D",0),i.next=5,this._updateAPs(o,_defineProperty({},"system.status.".concat(r,".advances"),Number(this.actor.system.status[r].advances)-1));case 5:case"end":return i.stop()}}),_callee7,this)}))),function _refundPointsAdvance(t){return ee.apply(this,arguments)})},{key:"_advanceItem",value:(X=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee8(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee8$(i){for(;;)switch(i.prev=i.next){case 0:return a=this.actor.items.get(r).toObject(),o=t.Z._calculateAdvCost(Number(a.system.talentValue.value),a.system.StF.value),i.next=4,this._checkEnoughXP(o);case 4:if(i.t0=i.sent,!i.t0){i.next=7;break}i.t0=this._checkMaximumItemAdvancement(a,Number(a.system.talentValue.value)+1);case 7:if(!i.t0){i.next=12;break}return i.next=10,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.talentValue.value":a.system.talentValue.value+1}]);case 10:return i.next=12,this._updateAPs(o);case 12:case"end":return i.stop()}}),_callee8,this)}))),function _advanceItem(t){return X.apply(this,arguments)})},{key:"_refundItemAdvance",value:(Q=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee9(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee9$(i){for(;;)switch(i.prev=i.next){case 0:if(!((a=this.actor.items.get(r).toObject()).system.talentValue.value>0)){i.next=7;break}return o=-1*t.Z._calculateAdvCost(Number(a.system.talentValue.value),a.system.StF.value,0),i.next=5,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.talentValue.value":a.system.talentValue.value-1}]);case 5:return i.next=7,this._updateAPs(o);case 7:case"end":return i.stop()}}),_callee9,this)}))),function _refundItemAdvance(t){return Q.apply(this,arguments)})},{key:"_checkMaximumPointAdvancement",value:function _checkMaximumPointAdvancement(t,r){var a=!1;switch(t){case"wounds":a=r<=this.actor.system.characteristics.ko.value;break;case"astralenergy":a=r<=(null==this.actor.system.characteristics[this.actor.system.guidevalue.magical]?0:this.actor.system.characteristics[this.actor.system.guidevalue.magical].value*this.actor.system.energyfactor.magical);break;case"karmaenergy":a=r<=(null==this.actor.system.characteristics[this.actor.system.guidevalue.clerical]?0:this.actor.system.characteristics[this.actor.system.guidevalue.clerical].value*this.actor.system.energyfactor.clerical)}return a||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),a}},{key:"_checkMaximumItemAdvancement",value:function _checkMaximumItemAdvancement(t,r){var o=this,c=!1;switch(t.type){case"combatskill":c=r<=Math.max.apply(Math,_toConsumableArray(t.system.guidevalue.value.split("/").map((function(t){return o.actor.system.characteristics[t].value}))))+2+a.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalCombatTechnique")," (").concat(t.name,")"));break;case"spell":case"ritual":var u,l=0,p=actor_sheet_createForOfIteratorHelper(t.system.feature.replace(/\(a-z \-\)/gi,"").split(",").map((function(t){return t.trim()})));try{for(p.s();!(u=p.n()).done;){var d=u.value;if(i.Z.hasAbility(this.actor,"".concat(game.i18n.localize("LocalizedIDs.propertyKnowledge")," (").concat(d,")"))){l=this.maxByAttr(t);break}}}catch(t){p.e(t)}finally{p.f()}c=r<=Math.max(14+a.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalSkill")," (").concat(t.name,")")),l);break;case"liturgy":case"ceremony":var h=new RegExp("^".concat(game.i18n.localize("LocalizedIDs.aspectKnowledge"))),m=0;this.actor.items.filter((function(t){return"specialability"==t.type&&h.test(t.name)})).some((function(r){return t.system.distribution.value.includes(r.name.split("(")[1].split(")")[0])}))&&(m=this.maxByAttr(t)),c=r<=Math.max(14+a.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalSkill")," (").concat(t.name,")")),m);break;case"skill":c=r<=this.maxByAttr(t)}return c||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),c}},{key:"maxByAttr",value:function maxByAttr(t){return Math.max.apply(Math,[this.actor.system.characteristics[t.system.characteristic1.value].value,this.actor.system.characteristics[t.system.characteristic2.value].value,this.actor.system.characteristics[t.system.characteristic3.value].value])+2+a.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalSkill")," (").concat(t.name,")"))}},{key:"_openLibrary",value:(J=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee10(){return actor_sheet_regeneratorRuntime().wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:game.dsa5.itemLibrary.render(!0);case 1:case"end":return t.stop()}}),_callee10)}))),function _openLibrary(){return J.apply(this,arguments)})},{key:"_configActor",value:(K=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee11(){return actor_sheet_regeneratorRuntime().wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:p.buildDialog(this.actor);case 1:case"end":return t.stop()}}),_callee11,this)}))),function _configActor(){return K.apply(this,arguments)})},{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r,a,o=this,i=actor_sheet_get(actor_sheet_getPrototypeOf(ActorSheetDsa5.prototype),"_getHeaderButtons",this).call(this);return i.unshift({class:"library",icon:"fas fa-university",onclick:(t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee12(){return actor_sheet_regeneratorRuntime().wrap((function _callee12$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",o._openLibrary());case 1:case"end":return t.stop()}}),_callee12)}))),function onclick(){return t.apply(this,arguments)})}),this.actor.isOwner&&i.unshift({class:"actorConfig",icon:"fas fa-link",onclick:(r=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee13(){return actor_sheet_regeneratorRuntime().wrap((function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",o._configActor());case 1:case"end":return t.stop()}}),_callee13)}))),function onclick(){return r.apply(this,arguments)})}),this.actor.system.canAdvance&&i.unshift({class:"locksheet",icon:"fas fa-".concat(this.actor.system.sheetLocked.value?"":"un","lock"),onclick:(a=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee14(t){return actor_sheet_regeneratorRuntime().wrap((function _callee14$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",o._changeAdvanceLock(t));case 1:case"end":return r.stop()}}),_callee14)}))),function onclick(t){return a.apply(this,arguments)})}),i}},{key:"_changeAdvanceLock",value:(V=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee15(t){return actor_sheet_regeneratorRuntime().wrap((function _callee15$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.actor.update({"system.sheetLocked.value":!this.actor.system.sheetLocked.value});case 2:$(t.currentTarget).find("i").toggleClass("fa-unlock fa-lock");case 3:case"end":return r.stop()}}),_callee15,this)}))),function _changeAdvanceLock(t){return V.apply(this,arguments)})},{key:"_checkEnoughXP",value:(Y=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee16(t){return actor_sheet_regeneratorRuntime().wrap((function _callee16$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.actor.checkEnoughXP(t);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),_callee16,this)}))),function _checkEnoughXP(t){return Y.apply(this,arguments)})},{key:"advanceWrapper",value:(U=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee17(t,r,a){var o,i;return actor_sheet_regeneratorRuntime().wrap((function _callee17$(c){for(;;)switch(c.prev=c.next){case 0:if(o=$(t.currentTarget),(i=o.find("i")).hasClass("fa-spin")){c.next=7;break}return i.addClass("fa-spin fa-spinner"),c.next=6,this[r](a);case 6:i.removeClass("fa-spin fa-spinner");case 7:case"end":return c.stop()}}),_callee17,this)}))),function advanceWrapper(t,r,a){return U.apply(this,arguments)})},{key:"showLimited",value:function showLimited(){return!game.user.isGM&&this.actor.limited}},{key:"getTokenId",value:function getTokenId(){return this.token?this.token.id:void 0}},{key:"rollDisease",value:function rollDisease(t){var r=this,a=this.actor.items.get(t),o=-1*this.actor.system.status.soulpower.max,i=-1*this.actor.system.status.toughness.max;a.setupEffect(void 0,{rollMode:"gmroll",manualResistance:{SKModifier:o,ZKModifier:i}}).then(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee18(t){var o;return actor_sheet_regeneratorRuntime().wrap((function _callee18$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,a.itemTest(t);case 2:return o=i.sent,i.next=5,r.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.duration.resolved":o.result.duration}]);case 5:case"end":return i.stop()}}),_callee18)})));return function(r){return t.apply(this,arguments)}}())}},{key:"swapWeaponHand",value:(q=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee19(t){var r,a;return actor_sheet_regeneratorRuntime().wrap((function _callee19$(o){for(;;)switch(o.prev=o.next){case 0:if(r=this._getItemId(t),a=this.actor.items.get(r),["Daggers","Fencing Weapons"].includes(game.i18n.localize("LocalizedCTs.".concat(a.system.combatskill.value)))){o.next=5;break}return o.next=5,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.worn.wrongGrip":!a.system.worn.wrongGrip}]);case 5:case"end":return o.stop()}}),_callee19,this)}))),function swapWeaponHand(t){return q.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(r){var a=this;actor_sheet_get(actor_sheet_getPrototypeOf(ActorSheetDsa5.prototype),"activateListeners",this).call(this,r);var o=function posthand(t){a.actor.items.get(a._getItemId(t)).postItem()};r.find(".roll-disease").click((function(t){return a.rollDisease(a._getItemId(t))})),r.find(".schip").click((function(t){t.preventDefault();var r=Number(t.currentTarget.getAttribute("data-val")),o=$(a.form).parent().find('[name="system.status.fatePoints.value"]');1==r&&1==$(a.form).find(".fullSchip").length&&(r=0),o.val(r),o.trigger("change")})),r.find(".swapWeaponHand").click((function(t){return a.swapWeaponHand(t)})),r.find(".defenseToggle").click((function(){return a.actor.update({"system.config.defense":!a.actor.system.config.defense})})),r.find(".loadWeapon").mousedown(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee20(t){var r,o,i,c;return actor_sheet_regeneratorRuntime().wrap((function _callee20$(u){for(;;)switch(u.prev=u.next){case 0:if(r=a._getItemId(t),o=a.actor.items.get(r).toObject(),""!==getProperty(o,"system.currentAmmo.value")){u.next=4;break}return u.abrupt("return");case 4:return i={_id:r},0==t.button?(c="trait"==o.type?o.system.reloadTime.value:d.Z.calcLZ(o,a.actor),i["system.reloadTime.progress"]=Math.min(o.system.reloadTime.progress+1,c)):2==t.button&&(i["system.reloadTime.progress"]=0),u.next=8,a.actor.updateEmbeddedDocuments("Item",[i]);case 8:case"end":return u.stop()}}),_callee20)})));return function(r){return t.apply(this,arguments)}}()),r.find(".chargeSpell").mousedown(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee21(t){var r,o,i;return actor_sheet_regeneratorRuntime().wrap((function _callee21$(c){for(;;)switch(c.prev=c.next){case 0:return r=a._getItemId(t),o=a.actor.items.get(r).toObject(),i=Number(o.system.castingTime.modified),0==t.button?o.system.castingTime.progress=Math.min(o.system.castingTime.progress+1,i):2==t.button&&(o.system.castingTime.progress=0,o.system.castingTime.modified=0),c.next=6,a.actor.updateEmbeddedDocuments("Item",[o]);case 6:case"end":return c.stop()}}),_callee21)})));return function(r){return t.apply(this,arguments)}}()),r.find(".item-swapMag").click(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee22(t){return actor_sheet_regeneratorRuntime().wrap((function _callee22$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a.actor.swapMag(a._getItemId(t));case 2:case"end":return r.stop()}}),_callee22)})));return function(r){return t.apply(this,arguments)}}()),r.find(".ammo-selector").change(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee23(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee23$(o){for(;;)switch(o.prev=o.next){case 0:return t.preventDefault(),r=a._getItemId(t),o.next=4,a.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.currentAmmo.value":$(t.currentTarget).val()}]);case 4:case"end":return o.stop()}}),_callee23)})));return function(r){return t.apply(this,arguments)}}()),r.find(".condition-edit").click((function(t){a.actor.effects.get($(t.currentTarget).attr("data-id")).sheet.render(!0)})),r.find(".ch-collapse").click((function(t){$(t.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(t.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()})),r.find(".item-toggle").click((function(t){var r=a._getItemId(t),o=a.actor.items.get(r).toObject();switch(o.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":a.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.worn.value":!o.system.worn.value}]),m.Z.playEquipmentWearStatusChange(o)}})),r.find(".status-create").click((function(t){var r=$(t.currentTarget).closest(".statusEffectMenu").find("ul");r.fadeIn("fast",(function(){r.find("input").focus()}))})),r.find(".statusEffectMenu ul").mouseleave((function(t){return $(t.currentTarget).fadeOut()})),r.find(".status-add").click(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee24(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee24$(o){for(;;)switch(o.prev=o.next){case 0:if("custom"!=(r=$(t.currentTarget).attr("data-id"))){o.next=5;break}u.Z.createCustomEffect(a.actor),o.next=7;break;case 5:return o.next=7,a.actor.addCondition(r,1,!1,!1);case 7:case"end":return o.stop()}}),_callee24)})));return function(r){return t.apply(this,arguments)}}()),r.find(".roll-aggregated").mousedown((function(t){return a._handleAggregatedProbe(t)})),r.find(".skill-select").mousedown((function(t){var r=a._getItemId(t),o=a.actor.items.get(r);0==t.button?a.actor.setupSkill(o,{},a.getTokenId()).then((function(t){a.actor.basicTest(t)})):2==t.button&&o.sheet.render(!0)})),r.find(".advance-attribute").mousedown((function(t){return a.advanceWrapper(t,"_advanceAttribute",$(t.currentTarget).attr("data-attr"))})),r.find(".refund-attribute").mousedown((function(t){return a.advanceWrapper(t,"_refundAttributeAdvance",$(t.currentTarget).attr("data-attr"))})),r.find(".advance-item").mousedown((function(t){return a.advanceWrapper(t,"_advanceItem",a._getItemId(t))})),r.find(".refund-item").mousedown((function(t){return a.advanceWrapper(t,"_refundItemAdvance",a._getItemId(t))})),r.find(".advance-points").mousedown((function(t){return a.advanceWrapper(t,"_advancePoints",$(t.currentTarget).attr("data-attr"))})),r.find(".refund-points").mousedown((function(t){return a.advanceWrapper(t,"_refundPointsAdvance",$(t.currentTarget).attr("data-attr"))})),r.find(".spell-select").mousedown((function(t){var r=a._getItemId(t),o=a.actor.items.get(r);0==t.button?a.actor.setupSpell(o,{},a.getTokenId()).then((function(t){return a.actor.basicTest(t)})):2==t.button&&o.sheet.render(!0)})),r.find(".quantity-click").mousedown((function(t){var r=a._getItemId(t),o=a.actor.items.get(r).toObject();y.Z.increment(t,o,"system.quantity.value",0),a.actor.updateEmbeddedDocuments("Item",[o])})),r.find(".item-post").click((function(t){return o(t)})),r.find(".item-dropdown").click((function(t){t.preventDefault(),$(t.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")})),r.find(".condition-show").mousedown((function(t){t.preventDefault();var r=t.currentTarget.dataset.id,o=$(t.currentTarget).parents(".statusEffect").attr("data-descriptor");if(0==t.button){var i=$(t.currentTarget).parents(".statusEffect").attr("data-origin");if(i)fromUuid(i).then((function(t){return t.sheet.render(!0)}));else{var c,u;o?(c=CONFIG.statusEffects.find((function(t){return t.id==o})),u=$('<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="'.concat(c.id,'"><img src="').concat(c.icon,'"/>').concat(game.i18n.localize(c.label),"</a></b>: ").concat(game.i18n.localize(c.description),"</div>"))):(c=a.actor.effects.find((function(t){return t.id==r})))&&(u=$('<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="'.concat(c.id,'"><img src="').concat(c.icon,'"/>').concat(game.i18n.localize(c.label),"</a></b>: ").concat(game.i18n.localize(c.flags.dsa5.description),"</div>")));var l=$(t.currentTarget).closest(".groupbox").find(".effectDescription");l.fadeOut("fast",(function(){l.html(u).fadeIn("fast")}))}}else 2!=t.button||t.currentTarget.dataset.locked||a._deleteActiveEffect(r)})),r.on("click",".chat-condition",(function(t){return c.Z.postStatus($(t.currentTarget).attr("data-id"))})),r.find(".money-change, .skill-advances").focusin((function(t){a.currentFocus=$(t.currentTarget).closest("[data-item-id]").attr("data-item-id")})),r.find(".money-change").change(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee25(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee25$(o){for(;;)switch(o.prev=o.next){case 0:return r=a._getItemId(t),o.next=3,a.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.quantity.value":Number(t.target.value)}]);case 3:case"end":return o.stop()}}),_callee25)})));return function(r){return t.apply(this,arguments)}}()),r.find(".skill-advances").change(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee26(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee26$(o){for(;;)switch(o.prev=o.next){case 0:return r=a._getItemId(t),o.next=3,a.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.talentValue.value":Number(t.target.value)}]);case 3:case"end":return o.stop()}}),_callee26)})));return function(r){return t.apply(this,arguments)}}()),r.find(".item-edit").click((function(t){t.preventDefault();var r=a._getItemId(t);a.actor.items.get(r).sheet.render(!0)})),r.find(".showApplication").mousedown((function(t){if(t.preventDefault(),2==t.button)a._deleteItem(t);else{var r=a._getItemId(t);a.actor.items.get(r).sheet.render(!0)}})),r.find(".disableRegeneration").click((function(t){var r=t.currentTarget.dataset.type,o="system.repeatingEffects.disabled.".concat(r);a.actor.update(_defineProperty({},o,!getProperty(a.actor,o)))})),r.find(".consume-item").mousedown((function(t){if(2==t.button){var r=a._getItemId(t),o=a.actor.items.get(r);a.consumeItem(o)}})),r.find(".ch-value").click((function(t){t.preventDefault();var r=t.currentTarget.attributes["data-char"].value;a.actor.setupCharacteristic(r,{},a.getTokenId()).then((function(t){return a.actor.basicTest(t)}))})),r.find(".ch-status").click((function(t){t.preventDefault(),a.actor.setupDodge({},a.getTokenId()).then((function(t){a.actor.basicTest(t)}))})),r.find(".ch-regenerate").click((function(t){t.preventDefault(),a.actor.setupRegeneration("regenerate",{},a.getTokenId()).then((function(t){return a.actor.basicTest(t)}))})),r.find(".ch-weaponless").click((function(t){t.preventDefault();var r=t.currentTarget.attributes["data-char"].value;a.actor.setupWeaponless(r,{},a.getTokenId()).then((function(t){return a.actor.basicTest(t)}))})),r.find(".item-create").click((function(t){return a._onItemCreate(t)})),r.find(".ch-rollCombat").click((function(t){t.preventDefault();var r=a._getItemId(t),o=$(t.currentTarget).attr("data-mode"),i=a.actor.items.get(r);a.actor.setupWeapon(i,o,{},a.getTokenId()).then((function(t){return a.actor.basicTest(t)}))}));var i=function deletehand(t){return a._deleteItem(t)};r.find(".onUseItem").click((function(t){return a._onMacroUseItem(t)})),r.find(".cards .item").mouseenter((function(t){if(0==t.currentTarget.getElementsByClassName("hovermenu").length){var r=document.createElement("div");r.classList.add("hovermenu");var a=document.createElement("i");a.classList.add("fas","fa-times"),a.title=game.i18n.localize("SHEET.DeleteItem"),a.addEventListener("click",i,!1);var c=document.createElement("i");c.classList.add("fas","fa-comment"),c.title=game.i18n.localize("SHEET.PostItem"),c.addEventListener("click",o,!1),r.appendChild(c),r.appendChild(a),t.currentTarget.appendChild(r)}})),r.find(".cards .item").mouseleave((function(t){var r=t.toElement||t.relatedTarget;r&&r.parentNode!=a&&r!=a&&t.currentTarget.querySelectorAll(".hovermenu").forEach((function(t){return t.remove()}))}));var l=this.actor.uuid;r.find(".actorDrag").each((function(t,r){r.setAttribute("draggable",!0),r.addEventListener("dragstart",(function(t){var r={type:"Actor",uuid:l};t.dataTransfer.setData("text/plain",JSON.stringify(r))}))})),r.find(".item-delete").click((function(t){return a._deleteItem(t)})),r.find(".tradition-delete").click((function(t){return a._deleteTraditionArtifact(t)})),r.find(".selectTraditionartifact").click((function(){return a.selectTraditionartifact()})),r.find(".filterTalents").click((function(t){$(t.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(t.currentTarget).toggleClass("filtered")})),r.find(".condition-value").mousedown(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee27(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee27$(o){for(;;)switch(o.prev=o.next){case 0:if(r=$(t.currentTarget).parents(".statusEffect").attr("data-descriptor"),0!=t.button){o.next=6;break}return o.next=4,a.actor.addCondition(r,1,!1,!1);case 4:o.next=9;break;case 6:if(2!=t.button){o.next=9;break}return o.next=9,a.actor.removeCondition(r,1,!1);case 9:case"end":return o.stop()}}),_callee27)})));return function(r){return t.apply(this,arguments)}}()),r.find(".condition-toggle").mousedown(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee28(t){var r,o;return actor_sheet_regeneratorRuntime().wrap((function _callee28$(i){for(;;)switch(i.prev=i.next){case 0:return r=$(t.currentTarget).parents(".statusEffect").attr("data-id"),o=a.actor.effects.get(r),i.next=4,o.update({disabled:!o.disabled});case 4:case"end":return i.stop()}}),_callee28)})));return function(r){return t.apply(this,arguments)}}()),r.find(".charimg").mousedown((function(r){2==r.button&&t.Z.showArtwork(a.actor,!0)})),_.Z.bindRollCommands(r);var p=r.find(".talentSearch");p.keyup((function(t){return a._filterTalents($(t.currentTarget))})),p[0]&&p[0].addEventListener("search",(function filterTalents(t){return a._filterTalents($(t.currentTarget))}),!1);var h=r.find(".conditionSearch");h.keyup((function(t){return a._filterConditions($(t.currentTarget))})),h[0]&&h[0].addEventListener("search",(function filterConditions(t){return a._filterConditions($(t.currentTarget))}),!1);var g=r.find(".gearSearch");g.keyup((function(t){return a._filterGear($(t.currentTarget))})),g[0]&&g[0].addEventListener("search",(function filterGear(t){return a._filterGear($(t.currentTarget))}),!1),bindImgToCanvasDragStart(r,"img.charimg")}},{key:"_onMacroUseItem",value:function _onMacroUseItem(t){var r=this.actor.items.get(this._getItemId(t));new g.Z(r).executeOnUseEffect()}},{key:"_filterGear",value:function _filterGear(t){if(null!=t.val()){var r=t.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter((function(){return-1==$(this).find("a.item-edit").text().toLowerCase().trim().indexOf(r)})).addClass("filterHide")}}},{key:"selectTraditionartifact",value:(Z=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee29(){return actor_sheet_regeneratorRuntime().wrap((function _callee29$(t){for(;;)switch(t.prev=t.next){case 0:if(this.isEditable){t.next=2;break}return t.abrupt("return");case 2:new w(this.actor).render(!0);case 3:case"end":return t.stop()}}),_callee29,this)}))),function selectTraditionartifact(){return Z.apply(this,arguments)})},{key:"_deleteTraditionArtifact",value:function _deleteTraditionArtifact(t){this.isEditable&&this.actor.items.get(this._getItemId(t)).update({"system.isArtifact":!1})}},{key:"_filterTalents",value:function _filterTalents(t){if(null!=t.val()){var r=t.val().toLowerCase().trim(),a=$(this.form).parent().find(".allTalents");a.find(".item, .table-header, .table-title").removeClass("filterHide"),a.addClass("showAll").find(".item").filter((function(){return-1==$(this).find(".talentName").text().toLowerCase().trim().indexOf(r)})).addClass("filterHide"),r.length>0?(a.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),a.addClass("filterfull")):a.removeClass("filterfull")}}},{key:"_filterConditions",value:function _filterConditions(t){if(null!=t.val()){var r=t.val().toLowerCase().trim(),a=$(this.form).find(".statusEffectMenu li:not(.search)");a.removeClass("filterHide"),a.filter((function(){return-1==$(this).find("a").attr("data-tooltip").toLowerCase().trim().indexOf(r)})).addClass("filterHide")}}},{key:"_deleteActiveEffect",value:(B=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee30(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee30$(a){for(;;)switch(a.prev=a.next){case 0:if(this.isEditable){a.next=2;break}return a.abrupt("return");case 2:if(!(r=this.actor.effects.find((function(r){return r.id==t})))){a.next=8;break}if(!(this.token?this.token.actor:this.actor)){a.next=8;break}return a.next=8,this.actor.deleteEmbeddedDocuments("ActiveEffect",[r.id]);case 8:case"end":return a.stop()}}),_callee30,this)}))),function _deleteActiveEffect(t){return B.apply(this,arguments)})},{key:"_deleteItem",value:function _deleteItem(t){var r=this;if(this.isEditable){var a=this._getItemId(t),o=this.actor.items.get(a),i=game.i18n.format("DIALOG.DeleteItemDetail",{item:o.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:i}).then((function(t){new Dialog({title:game.i18n.localize("Delete Confirmation"),content:t,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(){return r._cleverDeleteItem(a)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}))}}},{key:"_cleverDeleteItem",value:(W=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee31(r){var o,c,u,l,p,d,h,m;return actor_sheet_regeneratorRuntime().wrap((function _callee31$(y){for(;;)switch(y.prev=y.next){case 0:o=this.actor.items.get(r),c=[r],y.t0=o.type,y.next="advantage"===y.t0||"disadvantage"===y.t0?5:"specialability"===y.t0?12:"blessing"===y.t0||"magictrick"===y.t0?15:"ritual"===y.t0||"ceremony"===y.t0||"liturgy"===y.t0||"spell"===y.t0?18:25;break;case 5:return y.next=7,a.Z.vantageRemoved(this.actor,o);case 7:if(u=o.system.APValue.value*o.system.step.value,/;/.test(o.system.APValue.value))for(l=o.system.APValue.value.split(";").map((function(t){return Number(t.trim())})),u=0,p=0;p<o.system.step.value;p++)u+=l[p];return y.next=11,this._updateAPs(-1*u);case 11:case 14:case 17:case 24:return y.abrupt("break",25);case 12:return y.next=14,i.Z.abilityRemoved(this.actor,o);case 15:return y.next=17,this._updateAPs(-1);case 18:for(d=0,h=0;h<=o.system.talentValue.value;h++)d+=t.Z._calculateAdvCost(h,o.system.StF.value,0);return m=this.actor.items.filter((function(t){return"spellextension"==t.type&&o.type==t.system.category&&o.name==t.system.source})),m&&(d+=m.reduce((function(t,r){return t+r.system.APValue.value}),0),c.push.apply(c,_toConsumableArray(m.map((function(t){return t.id}))))),y.next=24,this._updateAPs(-1*d);case 25:return y.next=27,this.actor.deleteEmbeddedDocuments("Item",c);case 27:case"end":return y.stop()}}),_callee31,this)}))),function _cleverDeleteItem(t){return W.apply(this,arguments)})},{key:"_getItemId",value:function _getItemId(t){return $(t.currentTarget).parents(".item").attr("data-item-id")}},{key:"_addMoney",value:(H=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee32(t){var r,a;return actor_sheet_regeneratorRuntime().wrap((function _callee32$(o){for(;;)switch(o.prev=o.next){case 0:if(r=duplicate(this.actor.items.filter((function(t){return"money"==t.type}))),!(a=r.find((function(r){return r.name==t.name})))){o.next=8;break}return a.system.quantity.value+=t.system.quantity.value,o.next=6,this.actor.updateEmbeddedDocuments("Item",[a]);case 6:o.next=10;break;case 8:return o.next=10,this.actor.createEmbeddedDocuments("Item",[t]);case 10:case"end":return o.stop()}}),_callee32,this)}))),function _addMoney(t){return H.apply(this,arguments)})},{key:"_updateAPs",value:(N=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee33(t){var r,a=arguments;return actor_sheet_regeneratorRuntime().wrap((function _callee33$(o){for(;;)switch(o.prev=o.next){case 0:return r=a.length>1&&void 0!==a[1]?a[1]:{},o.next=3,this.actor._updateAPs(t,r);case 3:case"end":return o.stop()}}),_callee33,this)}))),function _updateAPs(t){return N.apply(this,arguments)})},{key:"_addVantage",value:(z=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee34(t,r){return actor_sheet_regeneratorRuntime().wrap((function _callee34$(o){for(;;)switch(o.prev=o.next){case 0:a.Z.needsAdoption(this.actor,t,r);case 1:case"end":return o.stop()}}),_callee34,this)}))),function _addVantage(t,r){return z.apply(this,arguments)})},{key:"_addSpecialAbility",value:(j=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee35(t,r){return actor_sheet_regeneratorRuntime().wrap((function _callee35$(a){for(;;)switch(a.prev=a.next){case 0:i.Z.needsAdoption(this.actor,t,r);case 1:case"end":return a.stop()}}),_callee35,this)}))),function _addSpecialAbility(t,r){return j.apply(this,arguments)})},{key:"_onDragStart",value:function _onDragStart(t){var r=t.currentTarget;if(!t.target.classList.contains("content-link")){var a;if(r.dataset.itemId)a=this.actor.items.get(r.dataset.itemId).toDragData(),r.dataset.mod&&(a.mod=r.dataset.mod);if(r.dataset.id)a=this.actor.effects.get(r.dataset.id).toDragData();a&&t.dataTransfer.setData("text/plain",JSON.stringify(a))}}},{key:"_handleSpellExtension",value:(M=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee36(t){var r,a;return actor_sheet_regeneratorRuntime().wrap((function _callee36$(o){for(;;)switch(o.prev=o.next){case 0:if(this.actor.items.find((function(r){return r.type==t.type&&r.name==t.name}))){o.next=19;break}if(t=duplicate(t),r=this.actor.items.find((function(r){return r.type==t.system.category&&r.name==t.system.source}))){o.next=8;break}ui.notifications.error(game.i18n.localize("DSAError.noSpellForExtension")),o.next=19;break;case 8:if(!(r.system.talentValue.value<t.system.talentValue)){o.next=11;break}return ui.notifications.error(game.i18n.localize("DSAError.talentValueTooLow")),o.abrupt("return");case 11:return a=t.system.APValue.value,o.next=14,this.actor.checkEnoughXP(a);case 14:if(!o.sent){o.next=19;break}return o.next=17,this._updateAPs(a);case 17:return o.next=19,this.actor.createEmbeddedDocuments("Item",[t]);case 19:case"end":return o.stop()}}),_callee36,this)}))),function _handleSpellExtension(t){return M.apply(this,arguments)})},{key:"_addSpellOrLiturgy",value:(G=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee37(r){var a,o;return actor_sheet_regeneratorRuntime().wrap((function _callee37$(i){for(;;)switch(i.prev=i.next){case 0:if(a=this.actor.items.find((function(t){return t.type==r.type&&t.name==r.name})),r=duplicate(r),a){i.next=20;break}i.t0=r.type,i.next="spell"===i.t0||"liturgy"===i.t0||"ceremony"===i.t0||"ritual"===i.t0?6:"blessing"===i.t0||"magictrick"===i.t0?8:"magicalsign"===i.t0?10:12;break;case 6:return o=t.Z._calculateAdvCost(0,r.system.StF.value,0),i.abrupt("break",13);case 8:return o=1,i.abrupt("break",13);case 10:return o=r.system.APValue.value,i.abrupt("break",13);case 12:return i.abrupt("return");case 13:return i.next=15,this.actor.checkEnoughXP(o);case 15:if(!i.sent){i.next=20;break}return i.next=18,this._updateAPs(o);case 18:return i.next=20,this.actor.createEmbeddedDocuments("Item",[r]);case 20:case"end":return i.stop()}}),_callee37,this)}))),function _addSpellOrLiturgy(t){return G.apply(this,arguments)})},{key:"_addLoot",value:(L=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee38(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee38$(a){for(;;)switch(a.prev=a.next){case 0:if(t=duplicate(t),r=this.actor.items.find((function(r){return o.Z.areEquals(t,r)}))){a.next=9;break}return"combat"==this._tabs[0].active&&t.system.worn&&(t.system.worn.value=!0),a.next=6,this.actor.createEmbeddedDocuments("Item",[t]);case 6:case 11:return a.abrupt("return",a.sent[0]);case 9:return a.next=11,o.Z.stackItems(r,t,this.actor);case 12:case"end":return a.stop()}}),_callee38,this)}))),function _addLoot(t){return L.apply(this,arguments)})},{key:"_addUniqueItem",value:(R=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee39(t){return actor_sheet_regeneratorRuntime().wrap((function _callee39$(r){for(;;)switch(r.prev=r.next){case 0:if(t=duplicate(t),this.actor.items.some((function(r){return o.Z.areEquals(t,r)}))){r.next=5;break}return r.next=4,this.actor.createEmbeddedDocuments("Item",[t]);case 4:return r.abrupt("return",r.sent[0]);case 5:case"end":return r.stop()}}),_callee39,this)}))),function _addUniqueItem(t){return R.apply(this,arguments)})},{key:"_addDemonMarkOrPatron",value:(I=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee40(t){return actor_sheet_regeneratorRuntime().wrap((function _callee40$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this._addUniqueItem(t);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),_callee40,this)}))),function _addDemonMarkOrPatron(t){return I.apply(this,arguments)})},{key:"_addDisease",value:(D=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee41(t){return actor_sheet_regeneratorRuntime().wrap((function _callee41$(r){for(;;)switch(r.prev=r.next){case 0:return t.system.duration.resolved="?",r.next=3,this._addUniqueItem(t);case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}}),_callee41,this)}))),function _addDisease(t){return D.apply(this,arguments)})},{key:"_addSkill",value:(C=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee42(t){return actor_sheet_regeneratorRuntime().wrap((function _callee42$(r){for(;;)switch(r.prev=r.next){case 0:if(t=duplicate(t),this.actor.items.find((function(r){return r.type==t.type&&r.name==t.name&&r.system.description.value==t.system.description.value}))){r.next=5;break}return r.next=5,this.actor.createEmbeddedDocuments("Item",[t]);case 5:case"end":return r.stop()}}),_callee42,this)}))),function _addSkill(t){return C.apply(this,arguments)})},{key:"handleItemCopy",value:(E=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee43(t,a){return actor_sheet_regeneratorRuntime().wrap((function _callee43$(o){for(;;)switch(o.prev=o.next){case 0:if(!r.Z.equipmentCategories.includes(a)){o.next=5;break}return t.name+=" (Copy)",o.next=4,this._addLoot(t);case 4:return o.abrupt("return",o.sent);case 5:case"end":return o.stop()}}),_callee43,this)}))),function handleItemCopy(t,r){return E.apply(this,arguments)})},{key:"_addFullPack",value:(P=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee44(t){var r,a,o=this;return actor_sheet_regeneratorRuntime().wrap((function _callee44$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,game.packs.get(t.name).getDocuments();case 2:return r=i.sent,a=r.filter((function(t){return!o.actor.items.find((function(r){return r.type==t.type&&r.name==t.name}))})),i.next=6,this.actor.createEmbeddedDocuments("Item",a.map((function(t){return t.toObject()})));case 6:case"end":return i.stop()}}),_callee44,this)}))),function _addFullPack(t){return P.apply(this,arguments)})},{key:"_manageDragItems",value:(O=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee45(t,r){var a;return actor_sheet_regeneratorRuntime().wrap((function _callee45$(o){for(;;)switch(o.prev=o.next){case 0:o.t0=r,o.next="disease"===o.t0?3:"meleeweapon"===o.t0||"rangeweapon"===o.t0||"equipment"===o.t0||"ammunition"===o.t0||"armor"===o.t0||"poison"===o.t0||"consumable"===o.t0||"plant"===o.t0?6:"disadvantage"===o.t0||"advantage"===o.t0?9:"specialability"===o.t0?12:"money"===o.t0?15:"skill"===o.t0?18:"ritual"===o.t0||"ceremony"===o.t0||"blessing"===o.t0||"magictrick"===o.t0||"liturgy"===o.t0||"spell"===o.t0||"magicalsign"===o.t0?21:"effectwrapper"===o.t0?24:"lookup"===o.t0?27:"fullpack"===o.t0?30:"application"===o.t0?33:"spellextension"===o.t0?36:"condition"===o.t0?39:"creature"===o.t0?42:"information"===o.t0?45:"patron"===o.t0||"demonmark"===o.t0?48:51;break;case 3:return o.next=5,this._addDisease(t);case 5:return o.abrupt("break",52);case 6:return o.next=8,this._addLoot(t);case 8:return o.abrupt("return",o.sent);case 9:return o.next=11,this._addVantage(t,r);case 11:return o.abrupt("break",52);case 12:return o.next=14,this._addSpecialAbility(t,r);case 14:return o.abrupt("break",52);case 15:return o.next=17,this._addMoney(t);case 17:return o.abrupt("break",52);case 18:return o.next=20,this._addSkill(t);case 20:return o.abrupt("break",52);case 21:return o.next=23,this._addSpellOrLiturgy(t);case 23:return o.abrupt("break",52);case 24:return o.next=26,this._handleEffectWrapper(t);case 26:return o.abrupt("break",52);case 27:return o.next=29,this._handleLookup(t);case 29:return o.abrupt("break",52);case 30:return o.next=32,this._addFullPack(t);case 32:return o.abrupt("break",52);case 33:return o.next=35,this._handleApplication(t);case 35:return o.abrupt("break",52);case 36:return o.next=38,this._handleSpellExtension(t);case 38:return o.abrupt("break",52);case 39:return o.next=41,this.actor.addCondition(t.payload.id,1,!1,!1);case 41:return o.abrupt("break",52);case 42:return(a=game.dsa5.config.hooks.shapeshift)&&(a.setShapeshift(this.actor,t),a.render(!0)),o.abrupt("break",52);case 45:return o.next=47,this._addUniqueItem(t);case 47:return o.abrupt("break",52);case 48:return o.next=50,this._addDemonMarkOrPatron(t);case 50:return o.abrupt("break",52);case 51:ui.notifications.error(game.i18n.format("DSAError.canNotBeAdded",{item:t.name,category:game.i18n.localize(t.type)}));case 52:case"end":return o.stop()}}),_callee45,this)}))),function _manageDragItems(t,r){return O.apply(this,arguments)})},{key:"_handleEffectWrapper",value:(A=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee46(t){return actor_sheet_regeneratorRuntime().wrap((function _callee46$(r){for(;;)switch(r.prev=r.next){case 0:this.actor.createEmbeddedDocuments("ActiveEffect",t.effects.map((function(t){return t.origin=null,t})));case 1:case"end":return r.stop()}}),_callee46,this)}))),function _handleEffectWrapper(t){return A.apply(this,arguments)})},{key:"_handleLookup",value:(T=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee47(r){var a,o,i,c;return actor_sheet_regeneratorRuntime().wrap((function _callee47$(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,t.Z.findAnyItem(r.items);case 2:if(!(a=u.sent)){u.next=10;break}o=actor_sheet_createForOfIteratorHelper(r.items);try{for(c=function _loop(){var t=i.value;if(t.count){var r=a.find((function(r){return r.name==t.name&&r.type==t.type}));r?(r.system.quantity.value=t.count,t.qs&&"equipment"==t.type&&(r.system.QL=t.qs)):ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:t.type,name:t.name}))}},o.s();!(i=o.n()).done;)c()}catch(t){o.e(t)}finally{o.f()}return u.next=8,this.actor.createEmbeddedDocuments("Item",a);case 8:u.next=11;break;case 10:ui.notifications.error(game.i18n.format("DSAError.notFound",{category:thing.type,name:thing.name}));case 11:case"end":return u.stop()}}),_callee47,this)}))),function _handleLookup(t){return T.apply(this,arguments)})},{key:"_handleApplication",value:(S=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee48(t){return actor_sheet_regeneratorRuntime().wrap((function _callee48$(r){for(;;)switch(r.prev=r.next){case 0:if(t=duplicate(t),this.actor.items.find((function(r){return r.type==t.type&&r.name==t.name}))){r.next=5;break}return r.next=5,this.actor.createEmbeddedDocuments("Item",[t]);case 5:case"end":return r.stop()}}),_callee48,this)}))),function _handleApplication(t){return S.apply(this,arguments)})},{key:"_handleRemoveSourceOnDrop",value:(x=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee49(t){var r;return actor_sheet_regeneratorRuntime().wrap((function _callee49$(a){for(;;)switch(a.prev=a.next){case 0:if(!(r=t.parent)||!r.isOwner){a.next=4;break}return a.next=4,r.deleteEmbeddedDocuments("Item",[t._id]);case 4:case"end":return a.stop()}}),_callee49)}))),function _handleRemoveSourceOnDrop(t){return x.apply(this,arguments)})},{key:"_onDropItemCreate",value:(k=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee50(t){return actor_sheet_regeneratorRuntime().wrap((function _callee50$(r){for(;;)switch(r.prev=r.next){case 0:if(!(t instanceof Array)){r.next=2;break}return r.abrupt("return",this.actor.createEmbeddedDocuments("Item",t));case 2:return r.next=4,this._manageDragItems(t,t.type);case 4:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),_callee50,this)}))),function _onDropItemCreate(t){return k.apply(this,arguments)})},{key:"_onDropActor",value:(b=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee51(t,r){var a,o,i;return actor_sheet_regeneratorRuntime().wrap((function _callee51$(t){for(;;)switch(t.prev=t.next){case 0:if(this.actor.isOwner){t.next=2;break}return t.abrupt("return",!1);case 2:return t.next=4,(0,h.x8)(r,this.id,!1);case 4:if(a=t.sent,o=a.item,i=a.typeClass,!a.selfTarget){t.next=10;break}return t.abrupt("return");case 10:return t.next=12,this._manageDragItems(o,i);case 12:return t.abrupt("return",t.sent);case 13:case"end":return t.stop()}}),_callee51,this)}))),function _onDropActor(t,r){return b.apply(this,arguments)})},{key:"_onDropItem",value:(v=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee52(t,a){var o,i,c,u,l,p,d;return actor_sheet_regeneratorRuntime().wrap((function _callee52$(h){for(;;)switch(h.prev=h.next){case 0:if(this.actor.isOwner){h.next=2;break}return h.abrupt("return",!1);case 2:return h.next=4,Item.implementation.fromDropData(a);case 4:if(i=h.sent,c=i.toObject(),y.Z.obfuscateDropData(c,a.tabsinvisible),(l=$(t.target).parents(".item"))&&"bags"==l.attr("data-category")&&r.Z.equipmentCategories.includes(i.type)&&l.attr("data-item-id")!=i.id&&(u=l.attr("data-item-id")),!(p=this.actor.uuid===(null===(o=i.parent)||void 0===o?void 0:o.uuid))){h.next=28;break}if(!t.ctrlKey){h.next=16;break}return h.next=14,this.handleItemCopy(c,i.type);case 14:case 21:h.next=26;break;case 16:if(!u){h.next=23;break}return d={_id:i.id,"system.parent_id":u},i.system.worn&&i.system.worn.value&&(d["system.worn.value"]=!1),h.next=21,this.actor.updateEmbeddedDocuments("Item",[d]);case 23:if(!r.Z.equipmentCategories.includes(i.type)){h.next=26;break}return h.next=26,this.actor.updateEmbeddedDocuments("Item",[{_id:i.id,system:{parent_id:0}}]);case 26:h.next=30;break;case 28:return h.next=30,this._onDropItemCreate(c);case 30:if(!t.altKey||p||!r.Z.equipmentCategories.includes(i.type)){h.next=33;break}return h.next=33,this._handleRemoveSourceOnDrop(i);case 33:case"end":return h.stop()}}),_callee52,this)}))),function _onDropItem(t,r){return v.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=actor_sheet_get(actor_sheet_getPrototypeOf(ActorSheetDsa5),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(t,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),t}}]),ActorSheetDsa5}(),w=function(t){actor_sheet_inherits(TraditionArtifactpicker,Application);var r,a=actor_sheet_createSuper(TraditionArtifactpicker);function TraditionArtifactpicker(t){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return actor_sheet_classCallCheck(this,TraditionArtifactpicker),(r=a.call(this,o)).actor=t,r}return actor_sheet_createClass(TraditionArtifactpicker,[{key:"template",get:function get(){return"systems/dsa5/templates/actors/traditionPicker.html"}},{key:"getData",value:(r=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee53(t){var r,a;return actor_sheet_regeneratorRuntime().wrap((function _callee53$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,actor_sheet_get(actor_sheet_getPrototypeOf(TraditionArtifactpicker.prototype),"getData",this).call(this,t);case 2:return r=o.sent,a=this.actor.items.filter((function(t){return["equipment","armor","rangeweapon","meleeweapon"].includes(t.type)})),mergeObject(r,{items:a}),o.abrupt("return",r);case 6:case"end":return o.stop()}}),_callee53,this)}))),function getData(t){return r.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;actor_sheet_get(actor_sheet_getPrototypeOf(TraditionArtifactpicker.prototype),"activateListeners",this).call(this,t),t.find(".slot").click(function(){var t=actor_sheet_asyncToGenerator(actor_sheet_regeneratorRuntime().mark((function _callee54(t){var a;return actor_sheet_regeneratorRuntime().wrap((function _callee54$(o){for(;;)switch(o.prev=o.next){case 0:return a=r.actor.items.get(t.currentTarget.dataset.itemId),o.next=3,a.update({"system.isArtifact":!a.system.isArtifact});case 3:case"end":return o.stop()}}),_callee54)})));return function(r){return t.apply(this,arguments)}}())}}],[{key:"defaultOptions",get:function get(){var t=actor_sheet_get(actor_sheet_getPrototypeOf(TraditionArtifactpicker),"defaultOptions",this);return mergeObject(t,{width:440,resizable:!0}),t}}]),TraditionArtifactpicker}(),k=__webpack_require__(794);function dsa5_wizard_typeof(t){return dsa5_wizard_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dsa5_wizard_typeof(t)}function dsa5_wizard_toConsumableArray(t){return function dsa5_wizard_arrayWithoutHoles(t){if(Array.isArray(t))return dsa5_wizard_arrayLikeToArray(t)}(t)||function dsa5_wizard_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||dsa5_wizard_unsupportedIterableToArray(t)||function dsa5_wizard_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function dsa5_wizard_regeneratorRuntime(){dsa5_wizard_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==dsa5_wizard_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function dsa5_wizard_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=dsa5_wizard_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function dsa5_wizard_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return dsa5_wizard_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?dsa5_wizard_arrayLikeToArray(t,r):void 0}}function dsa5_wizard_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function dsa5_wizard_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function dsa5_wizard_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){dsa5_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){dsa5_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function dsa5_wizard_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function dsa5_wizard_get(){return dsa5_wizard_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=dsa5_wizard_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},dsa5_wizard_get.apply(this,arguments)}function dsa5_wizard_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=dsa5_wizard_getPrototypeOf(t)););return t}function dsa5_wizard_setPrototypeOf(t,r){return dsa5_wizard_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},dsa5_wizard_setPrototypeOf(t,r)}function dsa5_wizard_createSuper(t){var r=function dsa5_wizard_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=dsa5_wizard_getPrototypeOf(t);if(r){var i=dsa5_wizard_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return dsa5_wizard_possibleConstructorReturn(this,a)}}function dsa5_wizard_possibleConstructorReturn(t,r){if(r&&("object"===dsa5_wizard_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function dsa5_wizard_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function dsa5_wizard_getPrototypeOf(t){return dsa5_wizard_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},dsa5_wizard_getPrototypeOf(t)}var x=function(o){!function dsa5_wizard_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&dsa5_wizard_setPrototypeOf(t,r)}(WizardDSA5,Application);var c,u,l,p,d=dsa5_wizard_createSuper(WizardDSA5);function WizardDSA5(t){var r;return function dsa5_wizard_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,WizardDSA5),(r=d.call(this,t)).items=[],r.actor=null,r.errors=[],r.dataTypes=[],r.attributes=[],r.updating=!1,r}return function dsa5_wizard_createClass(t,r,a){return r&&dsa5_wizard_defineProperties(t.prototype,r),a&&dsa5_wizard_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(WizardDSA5,[{key:"parseToItem",value:function parseToItem(a,o){var i=this;return""==a.trim()?[]:a.split(", ").map((function(a){var c=t.Z.parseAbilityString(a.trim()),u=i.items.find((function(t){return t.name==c.original&&o.includes(t.type)}));if(u||(u=i.items.find((function(t){return t.name==c.name&&o.includes(t.type)}))),u)(u=duplicate(u)).tooltip=game.i18n.localize("Details"),(u=k.Z.reverseAdoptionCalculation(i.actor,c,u)).system.APValue&&(u.APunparseable=isNaN(u.system.APValue.value),u.apCost=u.APunparseable?u.system.APValue.value:c.step*Number(u.system.APValue.value));else if(i.attributes.includes(c.name)){for(var l=0,p=i.actor.system.characteristics[game.dsa5.config.knownShortcuts[c.name.toLowerCase()][1]].value+1;p<c.step+1;p++)l+=r.Z.advancementCosts.E[p];u={name:c.name,step:c.step,attributeRequirement:!0,system:{APValue:{value:l}}}}else console.warn("Not found <".concat(a,">")),i.errors.push("".concat(o.map((function(t){return game.i18n.localize(t)})).join("/"),": ").concat(a)),u={name:a.trim(),notFound:!0,tooltip:game.i18n.localize("DSAError.itemNotFound"),apCost:"?"};u.replaceName=c.original,u.step=c.step;var d=null!=i.actor.items.find((function(t){return o.includes(t.type)&&t.name==c.original}));return u.disabled=d||u.notFound||u.APunparseable,d&&(u.tooltip=game.i18n.localize("YouAlreadyHaveit")),u}))}},{key:"mergeLevels",value:function mergeLevels(t,r){var a=!1,o=t.find((function(t){return t.name==r.name&&t.type==r.type}));if(o){a=!0;var i=Number(getProperty(r,"system.step.value"));i&&(o.system.step.value+=i)}else t.push(r);return a}},{key:"addSelections",value:(p=dsa5_wizard_asyncToGenerator(dsa5_wizard_regeneratorRuntime().mark((function _callee(r){var o,c,u,l,p=this;return dsa5_wizard_regeneratorRuntime().wrap((function _callee$(d){for(;;)switch(d.prev=d.next){case 0:o=[],c=dsa5_wizard_createForOfIteratorHelper(r),d.prev=2,l=function _loop(){var r=u.value;if(""==$(r).val())return"continue";var c=duplicate(p.items.find((function(t){return t.id==$(r).val()}))),l=t.Z.parseAbilityString(c.name);switch(c.name=$(r).attr("name"),c.type){case"advantage":case"disadvantage":c.system.step.value=Number($(r).attr("data-step")),c=k.Z.reverseAdoptionCalculation(p.actor,l,c),p.mergeLevels(o,c)||a.Z.vantageAdded(p.actor,c);break;case"specialability":c.system.step.value=Number($(r).attr("data-step")),$(r).attr("data-free")&&(c.system.APValue.value=0),c=k.Z.reverseAdoptionCalculation(p.actor,l,c),p.mergeLevels(o,c)||i.Z.abilityAdded(p.actor,c);break;case"magictrick":p.mergeLevels(o,c)}},c.s();case 5:if((u=c.n()).done){d.next=11;break}if("continue"!==l()){d.next=9;break}return d.abrupt("continue",9);case 9:d.next=5;break;case 11:d.next=16;break;case 13:d.prev=13,d.t0=d.catch(2),c.e(d.t0);case 16:return d.prev=16,c.f(),d.finish(16);case 19:return d.next=21,this.actor.createEmbeddedDocuments("Item",o);case 21:case"end":return d.stop()}}),_callee,this,[[2,13,16,19]])}))),function addSelections(t){return p.apply(this,arguments)})},{key:"alreadyAdded",value:(l=dsa5_wizard_asyncToGenerator(dsa5_wizard_regeneratorRuntime().mark((function _callee2(t,r){var a;return dsa5_wizard_regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:if(""!=t){o.next=2;break}return o.abrupt("return",!1);case 2:return a=!1,o.next=5,new Promise((function(t,a){new Dialog({title:game.i18n.localize("DIALOG.warning"),content:game.i18n.format("DIALOG.alreadyAddedCharacterpart",{category:game.i18n.localize(r)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Ok"),default:!0,callback:function callback(){t(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("Cancel"),default:!0,callback:function callback(){t(!0)}}}}).render(!0)}));case 5:return a=o.sent,o.abrupt("return",a);case 7:case"end":return o.stop()}}),_callee2)}))),function alreadyAdded(t,r){return l.apply(this,arguments)})},{key:"updateSkill",value:(u=dsa5_wizard_asyncToGenerator(dsa5_wizard_regeneratorRuntime().mark((function _callee3(r,a){var o,i,c,u,l,p,d=this,h=arguments;return dsa5_wizard_regeneratorRuntime().wrap((function _callee3$(m){for(;;)switch(m.prev=m.next){case 0:o=h.length>2&&void 0!==h[2]?h[2]:1,i=!(h.length>3&&void 0!==h[3])||h[3],c=[],u=dsa5_wizard_createForOfIteratorHelper(r);try{for(p=function _loop2(){var r=l.value,u=t.Z.parseAbilityString(r.trim()),p=d.actor.items.find((function(t){return t.type==a&&t.name==u.name}));if(p){var h=duplicate(p);h.system.talentValue.value=Math.max(0,o*u.step+(i?Number(h.system.talentValue.value):0)),c.push(h)}else console.warn("Could not find ".concat(a," ").concat(r)),d.errors.push("".concat(game.i18n.localize(a),": ").concat(r))},u.s();!(l=u.n()).done;)p()}catch(t){u.e(t)}finally{u.f()}return m.next=7,this.actor.updateEmbeddedDocuments("Item",c);case 7:case"end":return m.stop()}}),_callee3,this)}))),function updateSkill(t,r){return u.apply(this,arguments)})},{key:"_loadCompendiae",value:(c=dsa5_wizard_asyncToGenerator(dsa5_wizard_regeneratorRuntime().mark((function _callee4(){var t,r,a,o,i=this;return dsa5_wizard_regeneratorRuntime().wrap((function _callee4$(c){for(;;)switch(c.prev=c.next){case 0:this.items=[],r=dsa5_wizard_createForOfIteratorHelper(game.packs),c.prev=2,r.s();case 4:if((a=r.n()).done){c.next=11;break}if("Item"!=(o=a.value).documentName||!game.user.isGM&&o.private){c.next=9;break}return c.next=9,o.getDocuments().then((function(t){var r;(r=i.items).push.apply(r,dsa5_wizard_toConsumableArray(t.filter((function(t){return i.dataTypes.includes(t.type)}))))}));case 9:c.next=4;break;case 11:c.next=16;break;case 13:c.prev=13,c.t0=c.catch(2),r.e(c.t0);case 16:return c.prev=16,r.f(),c.finish(16);case 19:(t=this.items).push.apply(t,dsa5_wizard_toConsumableArray(game.items.contents.filter((function(t){return t.permission>1&&i.dataTypes.includes(t.type)}))));case 20:case"end":return c.stop()}}),_callee4,this,[[2,13,16,19]])}))),function _loadCompendiae(){return c.apply(this,arguments)})},{key:"_validateInput",value:function _validateInput(t){var r,a=new Set,o=/^exclusive_/,i=dsa5_wizard_createForOfIteratorHelper(t.find(".exclusive"));try{for(i.s();!(r=i.n()).done;){var c=r.value;a.add(c.className.split(/\s+/).filter((function(t){return o.test(t)}))[0])}}catch(t){i.e(t)}finally{i.f()}var u,l=dsa5_wizard_createForOfIteratorHelper(a);try{for(l.s();!(u=l.n()).done;){var p=u.value,d=t.find(".allowedCount_"+p.split("_")[1]),h=Number(d.attr("data-count"));if(t.find(".".concat(p,":checked")).length!=h){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),WizardDSA5.flashElem(d);var m=d.closest(".tab").attr("data-tab");return WizardDSA5.flashElem(t.find(".tabs a[data-tab='".concat(m,"']"))),!1}}}catch(t){l.e(t)}finally{l.f()}return!0}},{key:"activateListeners",value:function activateListeners(t){var r=this;dsa5_wizard_get(dsa5_wizard_getPrototypeOf(WizardDSA5.prototype),"activateListeners",this).call(this,t),t.find("button.ok").click((function(){r.updating||(r.updating=!0,r.updateCharacter().then((function(){return r.updating=!1})))})),t.find("button.cancel").click((function(){r.close()})),t.find(".show-item").click((function(t){var a=$(t.currentTarget).attr("data-id");r.items.find((function(t){return t.id==a})).sheet.render(!0)})),t.find(".exclusive").change((function(t){var r=$(t.currentTarget).closest(".content"),a=$(t.currentTarget).attr("data-sel"),o=r.find(".allowedCount_".concat(a)),i=Number(o.attr("data-count"));if(r.find(".exclusive_".concat(a,":checked")).length>i)return t.currentTarget.checked=!1,void WizardDSA5.flashElem(o)}))}},{key:"finalizeUpdate",value:function finalizeUpdate(){0==this.errors.length?this.close():$(this._element).find(".dialog-buttons").html('<div class="error"><p>'.concat(game.i18n.localize("DSAError.notUnderstood"),"</p><ul><li>").concat(this.errors.join("</li><li>"),"</li></ul></div>"))}}],[{key:"defaultOptions",get:function get(){var t=dsa5_wizard_get(dsa5_wizard_getPrototypeOf(WizardDSA5),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(t,{classes:t.classes.concat(["dsa5","largeDialog"]),width:770,height:740}),t.resizable=!0,t}},{key:"flashElem",value:function flashElem(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"emphasize";t.addClass(r),setTimeout((function(){t.removeClass(r)}),600)}}]),WizardDSA5}();function culture_wizard_typeof(t){return culture_wizard_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},culture_wizard_typeof(t)}function culture_wizard_regeneratorRuntime(){culture_wizard_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==culture_wizard_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function culture_wizard_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function culture_wizard_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){culture_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){culture_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function culture_wizard_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function culture_wizard_get(){return culture_wizard_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=culture_wizard_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},culture_wizard_get.apply(this,arguments)}function culture_wizard_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=culture_wizard_getPrototypeOf(t)););return t}function culture_wizard_setPrototypeOf(t,r){return culture_wizard_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},culture_wizard_setPrototypeOf(t,r)}function culture_wizard_createSuper(t){var r=function culture_wizard_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=culture_wizard_getPrototypeOf(t);if(r){var i=culture_wizard_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return culture_wizard_possibleConstructorReturn(this,a)}}function culture_wizard_possibleConstructorReturn(t,r){if(r&&("object"===culture_wizard_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function culture_wizard_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function culture_wizard_getPrototypeOf(t){return culture_wizard_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},culture_wizard_getPrototypeOf(t)}var S=function(t){!function culture_wizard_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&culture_wizard_setPrototypeOf(t,r)}(CultureWizard,t);var r,a,o=culture_wizard_createSuper(CultureWizard);function CultureWizard(t){var r;return function culture_wizard_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,CultureWizard),(r=o.call(this,t)).actor=null,r.culture=null,r.dataTypes=["advantage","disadvantage","specialability","combatskill"],r}return function culture_wizard_createClass(t,r,a){return r&&culture_wizard_defineProperties(t.prototype,r),a&&culture_wizard_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(CultureWizard,[{key:"activateListeners",value:function activateListeners(t){culture_wizard_get(culture_wizard_getPrototypeOf(CultureWizard.prototype),"activateListeners",this).call(this,t),t.find(".optional").change((function(t){var r=$(t.currentTarget).closest(".content"),a=Number(r.attr("data-cost"));r.find(".optional:checked").each((function(){a+=Number($(this).attr("data-cost"))}));var o=r.find(".apCost");o.text(a),x.flashElem(o,"emphasize2")}))}},{key:"getData",value:function getData(t){var r=culture_wizard_get(culture_wizard_getPrototypeOf(CultureWizard.prototype),"getData",this).call(this,t),a=this.parseToItem(this.culture.system.recommendedAdvantages.value,["advantage"]),o=this.parseToItem(this.culture.system.recommendedDisadvantages.value,["disadvantage"]),i=""==this.culture.system.writing.value?[]:this.parseToItem(this.culture.system.writing.value.split(",").map((function(t){return"".concat(game.i18n.localize("LocalizedIDs.literacy")," (").concat(t.trim(),")")})).join(", "),["specialability"]),c=""==this.culture.system.language.value?[]:this.parseToItem(this.culture.system.language.value.split(",").map((function(t){return"".concat(game.i18n.localize("LocalizedIDs.language")," (").concat(t.trim(),") 3")})).join(", "),["specialability"]),u=Number(this.culture.system.APValue.value);return mergeObject(r,{title:game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("culture")," ").concat(this.culture.name)}),culture:this.culture,description:game.i18n.format("WIZARD.culturedescr",{culture:this.culture.name,cost:u}),advantages:a,disadvantages:o,writings:i,languages:c,advantagesToChose:a.length>0,disadvantagesToChose:o.length>0,writingsToChose:i.length>0,languagesToChose:c.length>0,languagesToSelect:c.length>1,vantagesToChose:a.length>0||o.length>0,generalToChose:i.length>0||c.length>0}),r}},{key:"addCulture",value:(a=culture_wizard_asyncToGenerator(culture_wizard_regeneratorRuntime().mark((function _callee(t,r){return culture_wizard_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return this.actor=t,this.culture=duplicate(r),a.next=4,this._loadCompendiae();case 4:case"end":return a.stop()}}),_callee,this)}))),function addCulture(t,r){return a.apply(this,arguments)})},{key:"_validateInput",value:function _validateInput(t){var r=t.find(".localKnowledge");if(""==r.val()){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),x.flashElem(r);var a=r.closest(".tab").attr("data-tab");return x.flashElem(t.find(".tabs a[data-tab='".concat(a,"']"))),!1}var o=t.find(".selectOnlyOne");if(o.length&&1!=o.find(".optional:checked").length){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),x.flashElem(o);var i=o.closest(".tab").attr("data-tab");return x.flashElem(t.find(".tabs a[data-tab='".concat(i,"']"))),!1}return culture_wizard_get(culture_wizard_getPrototypeOf(CultureWizard.prototype),"_validateInput",this).call(this,t)}},{key:"updateCharacter",value:(r=culture_wizard_asyncToGenerator(culture_wizard_regeneratorRuntime().mark((function _callee2(){var t,r,a,o;return culture_wizard_regeneratorRuntime().wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:if((t=$(this._element)).find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),r=Number(t.find(".apCost").text()),i.t1=!this._validateInput($(this._element)),i.t1){i.next=8;break}return i.next=7,this.actor.checkEnoughXP(r);case 7:i.t1=!i.sent;case 8:if(i.t0=i.t1,i.t0){i.next=13;break}return i.next=12,this.alreadyAdded(this.actor.system.details.culture.value,"culture");case 12:i.t0=i.sent;case 13:if(!i.t0){i.next=16;break}return t.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),i.abrupt("return");case 16:if(a={"system.details.culture.value":this.culture.name},!(o=this.items.find((function(t){return t.name=="".concat(game.i18n.localize("LocalizedIDs.localKnowledge")," ()")&&"specialability"==t.type})))){i.next=24;break}return(o=duplicate(o)).name="".concat(game.i18n.localize("LocalizedIDs.localKnowledge")," (").concat(t.find(".localKnowledge").val(),")"),o.system.APValue.value=0,i.next=24,this.actor.createEmbeddedDocuments("Item",[o]);case 24:return i.next=26,this.addSelections(t.find(".optional:checked"));case 26:return i.next=28,this.actor.update(a);case 28:return i.next=30,this.actor._updateAPs(r);case 30:return i.next=32,this.updateSkill(this.culture.system.skills.value.split(","),"skill");case 32:this.finalizeUpdate();case 33:case"end":return i.stop()}}),_callee2,this)}))),function updateCharacter(){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=culture_wizard_get(culture_wizard_getPrototypeOf(CultureWizard),"defaultOptions",this);return t.title=game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("culture"))}),t.template="systems/dsa5/templates/wizard/add-culture-wizard.html",t}}]),CultureWizard}(x);function career_wizard_typeof(t){return career_wizard_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},career_wizard_typeof(t)}function career_wizard_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function career_wizard_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return career_wizard_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return career_wizard_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function career_wizard_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function career_wizard_regeneratorRuntime(){career_wizard_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==career_wizard_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function career_wizard_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function career_wizard_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){career_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){career_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function career_wizard_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function career_wizard_get(){return career_wizard_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=career_wizard_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},career_wizard_get.apply(this,arguments)}function career_wizard_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=career_wizard_getPrototypeOf(t)););return t}function career_wizard_setPrototypeOf(t,r){return career_wizard_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},career_wizard_setPrototypeOf(t,r)}function career_wizard_createSuper(t){var r=function career_wizard_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=career_wizard_getPrototypeOf(t);if(r){var i=career_wizard_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return career_wizard_possibleConstructorReturn(this,a)}}function career_wizard_possibleConstructorReturn(t,r){if(r&&("object"===career_wizard_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function career_wizard_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function career_wizard_getPrototypeOf(t){return career_wizard_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},career_wizard_getPrototypeOf(t)}var T=function(r){!function career_wizard_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&career_wizard_setPrototypeOf(t,r)}(CareerWizard,r);var a,o,i,c,u=career_wizard_createSuper(CareerWizard);function CareerWizard(t){var r;!function career_wizard_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,CareerWizard),(r=u.call(this,t)).items=[],r.career=null,r.dataTypes=["magictrick","blessing","spell","ritual","liturgy","ceremony","advantage","disadvantage","specialability"];return r.attributes={de:["MU","KL","IN","CH","FF","GE","KO","KK"],en:["COU","SGC","INT","CHA","DEX","AGI","CON","STR"]}[game.i18n.lang],r}return function career_wizard_createClass(t,r,a){return r&&career_wizard_defineProperties(t.prototype,r),a&&career_wizard_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(CareerWizard,[{key:"activateListeners",value:function activateListeners(t){career_wizard_get(career_wizard_getPrototypeOf(CareerWizard.prototype),"activateListeners",this).call(this,t),t.find(".optional").change((function(t){var r=$(t.currentTarget).closest(".content");if($(t.currentTarget).hasClass("exclusiveTricks")){var a=Number(r.find(".maxTricks").attr("data-spelltricklimit"));if(r.find(".exclusiveTricks:checked").length>a)return t.currentTarget.checked=!1,void x.flashElem(r.find(".maxTricks"))}var o=Number(r.attr("data-cost"));r.find(".optional:checked").each((function(){o+=Number($(this).attr("data-cost"))})),r.find(".attributes:checked").each((function(){o+=Number($(this).attr("data-cost"))}));var i=r.find(".apCost");i.text(o),x.flashElem(i,"emphasize2")}))}},{key:"_validateInput",value:function _validateInput(t){var r=t.find(".maxTricks"),a=Number(r.attr("data-spelltricklimit"))||0;if(t.find(".exclusiveTricks:checked").length!=a){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),x.flashElem(r);var o=r.closest(".tab").attr("data-tab");return x.flashElem(t.find(".tabs a[data-tab='".concat(o,"']"))),!1}return career_wizard_get(career_wizard_getPrototypeOf(CareerWizard.prototype),"_validateInput",this).call(this,t)}},{key:"getData",value:function getData(t){var r=career_wizard_get(career_wizard_getPrototypeOf(CareerWizard.prototype),"getData",this).call(this,t),a=this.parseToItem(this.career.system.recommendedAdvantages.value,["advantage"]),o=this.parseToItem(this.career.system.recommendedDisadvantages.value,["disadvantage"]),i=this.parseToItem(this.career.system.requirements.value,["disadvantage","advantage","specialability"]),c=i.filter((function(t){return["advantage","disadvantage"].includes(t.type)&&!t.disabled})),u=i.filter((function(t){return t.attributeRequirement})),l=this.parseCombatskills(this.career.system.combatSkills.value),p=Number(this.career.system.APValue.value),d=i.reduce((function(t,r){return t+(r.disabled?0:Number(r.system.APValue.value)||0)}),0),h=i.filter((function(t){return"specialability"==t.type&&!t.disabled}));return mergeObject(r,{title:game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("career")," ").concat(this.career.name)}),career:this.career,description:game.i18n.format("WIZARD.careerdescr",{career:this.career.name,cost:p+d}),baseCost:p,advantages:a,disadvantages:o,missingVantages:c,missingSpecialabilities:h,combatskillchoices:l,spelltricks:this.parseToItem(this.career.system.spelltricks.value,["magictrick"]),attributeRequirements:u,advantagesToChose:a.length>0,disadvantagesToChose:o.length>0,vantagesToChose:a.length>0||o.length>0||c.length>0,missingVantagesToChose:c.length>0,missingSpecialabiltiesToChose:h.length>0,combatToChose:l.length>0,magicToChose:this.career.system.spelltrickCount.value>0,religionToChose:!1,anyAttributeRequirements:u.length>0,generalToChose:h.length>0||u.length>0}),r}},{key:"addCareer",value:(c=career_wizard_asyncToGenerator(career_wizard_regeneratorRuntime().mark((function _callee(t,r){return career_wizard_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return this.actor=t,this.career=duplicate(r),a.next=4,this._loadCompendiae();case 4:case"end":return a.stop()}}),_callee,this)}))),function addCareer(t,r){return c.apply(this,arguments)})},{key:"parseCombatskills",value:function parseCombatskills(t){var r,a=[],o=career_wizard_createForOfIteratorHelper(t.split(/,|;/));try{for(o.s();!(r=o.n()).done;){var i=r.value;if(i.includes(game.i18n.localize("combatskillcountdivider")+":")){var c=i.split(":");a.push({choices:c[1].split("/").map((function(t){return t.trim()})),allowedCount:Number(c[0].match(/\d/g))})}}}catch(t){o.e(t)}finally{o.f()}return a}},{key:"setAbility",value:(i=career_wizard_asyncToGenerator(career_wizard_regeneratorRuntime().mark((function _callee2(r,a){var o,i,c,u,l,p=this;return career_wizard_regeneratorRuntime().wrap((function _callee2$(d){for(;;)switch(d.prev=d.next){case 0:if(""!=r.trim()){d.next=2;break}return d.abrupt("return");case 2:o=[],i=[],c=career_wizard_createForOfIteratorHelper(r.split(","));try{for(l=function _loop(){var r=u.value,c=t.Z.parseAbilityString(r.trim()),l=p.actor.items.find((function(t){return a.includes(t.type)&&t.name==c.original}));l?((l=duplicate(l)).system.talentValue&&(l.system.talentValue.value=c.step),l.system.step&&(l.system.step.value=c.step),l=k.Z.reverseAdoptionCalculation(p.actor,c,l),i.push(l)):((l=p.items.find((function(t){return a.includes(t.type)&&t.name==c.original})))||(l=p.items.find((function(t){return a.includes(t.type)&&t.name==c.name}))),l?((l=duplicate(l)).name=c.original,l.system.talentValue&&(l.system.talentValue.value=c.step),l.system.step&&(l.system.step.value=c.step),l=k.Z.reverseAdoptionCalculation(p.actor,c,l),o.push(l)):(p.errors.push("".concat(a.map((function(t){return game.i18n.localize(t)})).join("/"),": ").concat(r)),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(a[0]),name:r}))))},c.s();!(u=c.n()).done;)l()}catch(t){c.e(t)}finally{c.f()}return d.next=8,this.actor.updateEmbeddedDocuments("Item",i);case 8:return d.next=10,this.actor.createEmbeddedDocuments("Item",o);case 10:case"end":return d.stop()}}),_callee2,this)}))),function setAbility(t,r){return i.apply(this,arguments)})},{key:"addBlessing",value:(o=career_wizard_asyncToGenerator(career_wizard_regeneratorRuntime().mark((function _callee3(t,r){var a,o,i,c,u=this;return career_wizard_regeneratorRuntime().wrap((function _callee3$(l){for(;;)switch(l.prev=l.next){case 0:a=[],o=career_wizard_createForOfIteratorHelper(t),l.prev=2,c=function _loop2(){var t=i.value,o=t.trim();if(""==o)return"continue";var c=u.actor.items.find((function(t){return r==t.type&&t.name==o}));c||((c=u.items.find((function(t){return r==t.type&&t.name==o})))?(c=duplicate(c),a.push(c)):(u.errors.push("".concat(game.i18n.localize(r),": ").concat(t)),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(r),name:o}))))},o.s();case 5:if((i=o.n()).done){l.next=11;break}if("continue"!==c()){l.next=9;break}return l.abrupt("continue",9);case 9:l.next=5;break;case 11:l.next=16;break;case 13:l.prev=13,l.t0=l.catch(2),o.e(l.t0);case 16:return l.prev=16,o.f(),l.finish(16);case 19:return l.next=21,this.actor.createEmbeddedDocuments("Item",a);case 21:case"end":return l.stop()}}),_callee3,this,[[2,13,16,19]])}))),function addBlessing(t,r){return o.apply(this,arguments)})},{key:"updateCharacter",value:(a=career_wizard_asyncToGenerator(career_wizard_regeneratorRuntime().mark((function _callee4(){var t,r,a,o,i,c,u,l,p,d,h,m;return career_wizard_regeneratorRuntime().wrap((function _callee4$(y){for(;;)switch(y.prev=y.next){case 0:if((t=$(this._element)).find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),r=Number(t.find(".apCost").text()),y.t1=!this._validateInput($(this._element)),y.t1){y.next=8;break}return y.next=7,this.actor.checkEnoughXP(r);case 7:y.t1=!y.sent;case 8:if(y.t0=y.t1,y.t0){y.next=13;break}return y.next=12,this.alreadyAdded(this.actor.system.details.career.value,"career");case 12:y.t0=y.sent;case 13:if(!y.t0){y.next=16;break}return t.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),y.abrupt("return");case 16:a={"system.details.career.value":this.career.name,"system.freeLanguagePoints.value":this.career.system.languagePoints.value},o=career_wizard_createForOfIteratorHelper(t.find(".attributes"));try{for(o.s();!(i=o.n()).done;)c=i.value,u=$(c).attr("data-attribute").toLowerCase(),u=game.dsa5.config.knownShortcuts[u.toLowerCase()][1],Number(this.actor.system.characteristics[u].initial)+Number(this.actor.system.characteristics[u].advances)<Number($(c).val())&&(this.actor.system.canAdvance?a["system.characteristics.".concat(u,".advances")]=Number($(c).val())-Number(this.actor.system.characteristics[u].initial):a["system.characteristics.".concat(u,".initial")]=Number($(c).val()))}catch(t){o.e(t)}finally{o.f()}if("mundane"!=this.career.system.mageLevel.value&&(a["system.guidevalue.".concat(this.career.system.mageLevel.value)]=this.career.system.guidevalue.value,a["system.energyfactor.".concat(this.career.system.mageLevel.value)]=this.career.system.guidevalue.factor,a["system.tradition.".concat(this.career.system.mageLevel.value)]=this.career.system.tradition.value,a["system.feature.".concat(this.career.system.mageLevel.value)]=this.career.system.feature.value),"clerical"!=this.career.system.mageLevel.value){y.next=26;break}return a["system.happyTalents.value"]=this.career.system.happyTalents.value,y.next=24,this.setAbility(this.career.system.liturgies.value,["liturgy","ceremony"]);case 24:return y.next=26,this.addBlessing(this.career.system.blessings.value.split(","),"blessing");case 26:if("magical"!=this.career.system.mageLevel.value){y.next=29;break}return y.next=29,this.setAbility(this.career.system.spells.value,["spell","ritual"]);case 29:return y.next=31,this.setAbility(this.career.system.specialAbilities.value,["specialability"]);case 31:return y.next=33,this.actor.update(a);case 33:return y.next=35,this.actor._updateAPs(r);case 35:return y.next=37,this.addSelections(t.find(".optional:checked"));case 37:return y.next=39,this.updateSkill(this.career.system.skills.value.split(","),"skill");case 39:l=[],p=career_wizard_createForOfIteratorHelper(t.find(".exclusive:checked"));try{for(p.s();!(d=p.n()).done;)h=d.value,l.push($(h).val())}catch(t){p.e(t)}finally{p.f()}return m=this.career.system.combatSkills.value.split(",").concat(l).filter((function(t){return!(t.includes(game.i18n.localize("combatskillcountdivider")+":")||""==t)})),y.next=45,this.updateSkill(m,"combatskill",1,!1);case 45:this.finalizeUpdate();case 46:case"end":return y.stop()}}),_callee4,this)}))),function updateCharacter(){return a.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=career_wizard_get(career_wizard_getPrototypeOf(CareerWizard),"defaultOptions",this);return t.title=game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("career"))}),t.template="systems/dsa5/templates/wizard/add-career-wizard.html",t}}]),CareerWizard}(x);function species_wizard_typeof(t){return species_wizard_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},species_wizard_typeof(t)}function species_wizard_regeneratorRuntime(){species_wizard_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==species_wizard_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function species_wizard_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function species_wizard_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){species_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){species_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function species_wizard_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function species_wizard_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return species_wizard_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return species_wizard_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function species_wizard_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function species_wizard_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function species_wizard_get(){return species_wizard_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=species_wizard_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},species_wizard_get.apply(this,arguments)}function species_wizard_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=species_wizard_getPrototypeOf(t)););return t}function species_wizard_setPrototypeOf(t,r){return species_wizard_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},species_wizard_setPrototypeOf(t,r)}function species_wizard_createSuper(t){var r=function species_wizard_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=species_wizard_getPrototypeOf(t);if(r){var i=species_wizard_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return species_wizard_possibleConstructorReturn(this,a)}}function species_wizard_possibleConstructorReturn(t,r){if(r&&("object"===species_wizard_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function species_wizard_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function species_wizard_getPrototypeOf(t){return species_wizard_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},species_wizard_getPrototypeOf(t)}var A=function(t){!function species_wizard_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&species_wizard_setPrototypeOf(t,r)}(SpeciesWizard,t);var r,a,o=species_wizard_createSuper(SpeciesWizard);function SpeciesWizard(t){var r;return function species_wizard_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,SpeciesWizard),(r=o.call(this,t)).actor=null,r.culture=null,r.dataTypes=["advantage","disadvantage"],r.attributes=[],r}return function species_wizard_createClass(t,r,a){return r&&species_wizard_defineProperties(t.prototype,r),a&&species_wizard_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(SpeciesWizard,[{key:"activateListeners",value:function activateListeners(t){species_wizard_get(species_wizard_getPrototypeOf(SpeciesWizard.prototype),"activateListeners",this).call(this,t),t.find(".optional").change((function(t){var r=$(t.currentTarget).closest(".content"),a=Number(r.attr("data-cost"));r.find(".optional:checked").each((function(){a+=Number($(this).attr("data-cost"))}));var o=r.find(".apCost");o.text(a),x.flashElem(o,"emphasize2")}))}},{key:"_toGroups",value:function _toGroups(t,r){var a=this;return t.split("\n").map((function(t){var o=t.split(":");return o.length>1?{name:o[0].trim(),res:a.parseToItem(o[1].trim(),r)}:{name:"",res:a.parseToItem(t,r)}}))}},{key:"_parseAttributes",value:function _parseAttributes(t){var r,a=[],o=species_wizard_createForOfIteratorHelper(t.split(","));try{for(o.s();!(r=o.n()).done;){var i=r.value;if(i.includes(game.i18n.localize("combatskillcountdivider")+":")){var c=i.split(":");a.push({choices:c[1].split("/").map((function(t){return t.trim()})),allowedCount:Number(c[0].match(/\d/g))})}}}catch(t){o.e(t)}finally{o.f()}return a}},{key:"getData",value:function getData(t){var r=species_wizard_get(species_wizard_getPrototypeOf(SpeciesWizard.prototype),"getData",this).call(this,t),a=this._toGroups(this.species.system.recommendedAdvantages.value,["advantage"]),o=this._toGroups(this.species.system.recommendedDisadvantages.value,["disadvantage"]),i=this.parseToItem(this.species.system.requirements.value,["disadvantage","advantage"]),c=i.filter((function(t){return["advantage","disadvantage"].includes(t.type)&&!t.disabled})),u=this._parseAttributes(this.species.system.attributeChange.value),l=Number(this.species.system.APValue.value),p=i.reduce((function(t,r){return t+(r.disabled?0:Number(r.system.APValue.value)||0)}),0);return mergeObject(r,{title:game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("species")," ").concat(this.species.name)}),species:this.species,description:game.i18n.format("WIZARD.speciesdescr",{species:this.species.name,cost:l+p}),advantagegroups:a,baseCost:l,speciesDescription:game.i18n.has("Racedescr.".concat(this.species.name))?game.i18n.localize("Racedescr.".concat(this.species.name)):this.species.system.description.value,disadvantagegroups:o,missingVantages:c,attributeRequirements:u,anyAttributeRequirements:u.length>0,advantagesToChose:a.length>0,missingVantagesToChose:c.length>0,disadvantagesToChose:o.length>0,vantagesToChose:a.length>0||o.length>0||c.length>0,generalToChose:u.length>0}),r}},{key:"addSpecies",value:(a=species_wizard_asyncToGenerator(species_wizard_regeneratorRuntime().mark((function _callee(t,r){return species_wizard_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return this.actor=t,this.species=duplicate(r),a.next=4,this._loadCompendiae();case 4:case"end":return a.stop()}}),_callee,this)}))),function addSpecies(t,r){return a.apply(this,arguments)})},{key:"updateCharacter",value:(r=species_wizard_asyncToGenerator(species_wizard_regeneratorRuntime().mark((function _callee2(){var t,r,a,o,i,c,u,l,p,d,h,m;return species_wizard_regeneratorRuntime().wrap((function _callee2$(y){for(;;)switch(y.prev=y.next){case 0:if((t=$(this._element)).find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),r=Number(t.find(".apCost").text()),y.t1=!this._validateInput($(this._element)),y.t1){y.next=8;break}return y.next=7,this.actor.checkEnoughXP(r);case 7:y.t1=!y.sent;case 8:if(y.t0=y.t1,y.t0){y.next=13;break}return y.next=12,this.alreadyAdded(this.actor.system.details.species.value,"species");case 12:y.t0=y.sent;case 13:if(!y.t0){y.next=16;break}return t.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),y.abrupt("return");case 16:a={"system.details.species.value":this.species.name,"system.status.speed.initial":this.species.system.baseValues.speed.value,"system.status.soulpower.initial":this.species.system.baseValues.soulpower.value,"system.status.toughness.initial":this.species.system.baseValues.toughness.value,"system.status.wounds.initial":this.species.system.baseValues.wounds.value,"system.status.wounds.value":this.species.system.baseValues.wounds.value+2*this.actor.system.characteristics.ko.value},o=[],i=species_wizard_createForOfIteratorHelper(t.find(".exclusive:checked"));try{for(i.s();!(c=i.n()).done;)u=c.value,o.push($(u).val())}catch(t){i.e(t)}finally{i.f()}["mu","kl","in","ch","ff","ge","ko","kk"].forEach((function(t){a["data.characteristics.".concat(t,".species")]=0})),l=species_wizard_createForOfIteratorHelper(this.species.system.attributeChange.value.split(",").concat(o)),y.prev=22,l.s();case 24:if((p=l.n()).done){y.next=34;break}if(!(d=p.value).includes(game.i18n.localize("combatskillcountdivider")+":")&&""!=d){y.next=28;break}return y.abrupt("continue",32);case 28:h=d.trim().split(" "),(m=game.dsa5.config.knownShortcuts[h[0].toLowerCase().trim()].slice(0))[m.length-1]="species",a["data.".concat(m.join("."))]=Number(h[1]);case 32:y.next=24;break;case 34:y.next=39;break;case 36:y.prev=36,y.t2=y.catch(22),l.e(y.t2);case 39:return y.prev=39,l.f(),y.finish(39);case 42:return y.next=44,this.actor.update(a);case 44:return y.next=46,this.actor._updateAPs(r);case 46:return y.next=48,this.addSelections(t.find(".optional:checked"));case 48:return y.next=50,this.actor.removeCondition("incapacitated");case 50:this.finalizeUpdate();case 51:case"end":return y.stop()}}),_callee2,this,[[22,36,39,42]])}))),function updateCharacter(){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=species_wizard_get(species_wizard_getPrototypeOf(SpeciesWizard),"defaultOptions",this);return t.title=game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("species"))}),t.template="systems/dsa5/templates/wizard/add-species-wizard.html",t}}]),SpeciesWizard}(x);function character_sheet_typeof(t){return character_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},character_sheet_typeof(t)}function character_sheet_regeneratorRuntime(){character_sheet_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==character_sheet_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function character_sheet_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function character_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function character_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function character_sheet_get(){return character_sheet_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=character_sheet_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},character_sheet_get.apply(this,arguments)}function character_sheet_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=character_sheet_getPrototypeOf(t)););return t}function character_sheet_setPrototypeOf(t,r){return character_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},character_sheet_setPrototypeOf(t,r)}function character_sheet_createSuper(t){var r=function character_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=character_sheet_getPrototypeOf(t);if(r){var i=character_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return character_sheet_possibleConstructorReturn(this,a)}}function character_sheet_possibleConstructorReturn(t,r){if(r&&("object"===character_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function character_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function character_sheet_getPrototypeOf(t){return character_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},character_sheet_getPrototypeOf(t)}var O=function(t){!function character_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&character_sheet_setPrototypeOf(t,r)}(ActorSheetdsa5Character,t);var r,a=character_sheet_createSuper(ActorSheetdsa5Character);function ActorSheetdsa5Character(){return character_sheet_classCallCheck(this,ActorSheetdsa5Character),a.apply(this,arguments)}return function character_sheet_createClass(t,r,a){return r&&character_sheet_defineProperties(t.prototype,r),a&&character_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(ActorSheetdsa5Character,[{key:"template",get:function get(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/actor-sheet.html"}},{key:"_manageDragItems",value:(r=function character_sheet_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){character_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){character_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(character_sheet_regeneratorRuntime().mark((function _callee(t,r){var a,o,i;return character_sheet_regeneratorRuntime().wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:c.t0=r,c.next="aggregatedTest"===c.t0?3:"species"===c.t0?6:"culture"===c.t0?11:"career"===c.t0?16:21;break;case 3:return c.next=5,this.actor.createEmbeddedDocuments("Item",[t]);case 5:return c.abrupt("break",22);case 6:return a=new A,c.next=9,a.addSpecies(this.actor,t);case 9:return a.render(!0),c.abrupt("break",22);case 11:return o=new S,c.next=14,o.addCulture(this.actor,t);case 14:return o.render(!0),c.abrupt("break",22);case 16:return i=new T,c.next=19,i.addCareer(this.actor,t);case 19:return i.render(!0),c.abrupt("break",22);case 21:return c.abrupt("return",character_sheet_get(character_sheet_getPrototypeOf(ActorSheetdsa5Character.prototype),"_manageDragItems",this).call(this,t,r));case 22:case"end":return c.stop()}}),_callee,this)}))),function _manageDragItems(t,a){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=character_sheet_get(character_sheet_getPrototypeOf(ActorSheetdsa5Character),"defaultOptions",this);return mergeObject(t,{classes:t.classes.concat(["dsa5","actor","character-sheet"]),width:784}),t}}]),ActorSheetdsa5Character}(b),P=__webpack_require__(101);function creature_sheet_typeof(t){return creature_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},creature_sheet_typeof(t)}function creature_sheet_regeneratorRuntime(){creature_sheet_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==creature_sheet_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function creature_sheet_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function creature_sheet_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){creature_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){creature_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function creature_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function creature_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function creature_sheet_get(){return creature_sheet_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=creature_sheet_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},creature_sheet_get.apply(this,arguments)}function creature_sheet_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=creature_sheet_getPrototypeOf(t)););return t}function creature_sheet_setPrototypeOf(t,r){return creature_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},creature_sheet_setPrototypeOf(t,r)}function creature_sheet_createSuper(t){var r=function creature_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=creature_sheet_getPrototypeOf(t);if(r){var i=creature_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return creature_sheet_possibleConstructorReturn(this,a)}}function creature_sheet_possibleConstructorReturn(t,r){if(r&&("object"===creature_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function creature_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function creature_sheet_getPrototypeOf(t){return creature_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},creature_sheet_getPrototypeOf(t)}var E=function(t){!function creature_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&creature_sheet_setPrototypeOf(t,r)}(ActorSheetdsa5Creature,t);var r,a,o,i,c=creature_sheet_createSuper(ActorSheetdsa5Creature);function ActorSheetdsa5Creature(){return creature_sheet_classCallCheck(this,ActorSheetdsa5Creature),c.apply(this,arguments)}return function creature_sheet_createClass(t,r,a){return r&&creature_sheet_defineProperties(t.prototype,r),a&&creature_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(ActorSheetdsa5Creature,[{key:"template",get:function get(){return this.showLimited()?"systems/dsa5/templates/actors/creature-limited.html":"systems/dsa5/templates/actors/creature-sheet.html"}},{key:"getData",value:(i=creature_sheet_asyncToGenerator(creature_sheet_regeneratorRuntime().mark((function _callee(t){var r;return creature_sheet_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,creature_sheet_get(creature_sheet_getPrototypeOf(ActorSheetdsa5Creature.prototype),"getData",this).call(this,t);case 2:return r=a.sent,a.next=5,TextEditor.enrichHTML(getProperty(this.actor.system,"description.value"),{secrets:!0,async:!0});case 5:return r.enrichedDescription=a.sent,a.next=8,TextEditor.enrichHTML(getProperty(this.actor.system,"behaviour.value"),{secrets:!0,async:!0});case 8:return r.enrichedBehaviour=a.sent,a.next=11,TextEditor.enrichHTML(getProperty(this.actor.system,"flight.value"),{secrets:!0,async:!0});case 11:return r.enrichedFlight=a.sent,a.next=14,TextEditor.enrichHTML(getProperty(this.actor.system,"specialRules.value"),{secrets:!0,async:!0});case 14:return r.enrichedSpecialrules=a.sent,a.abrupt("return",r);case 16:case"end":return a.stop()}}),_callee,this)}))),function getData(t){return i.apply(this,arguments)})},{key:"_cleverDeleteItem",value:(o=creature_sheet_asyncToGenerator(creature_sheet_regeneratorRuntime().mark((function _callee2(t){var r;return creature_sheet_regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:r=this.actor.items.find((function(r){return r.id==t})),a.t0=r.type,a.next="trait"===a.t0?4:7;break;case 4:return a.next=6,this._updateAPs(-1*r.system.APValue.value);case 6:return a.abrupt("break",7);case 7:return a.next=9,creature_sheet_get(creature_sheet_getPrototypeOf(ActorSheetdsa5Creature.prototype),"_cleverDeleteItem",this).call(this,t);case 9:case"end":return a.stop()}}),_callee2,this)}))),function _cleverDeleteItem(t){return o.apply(this,arguments)})},{key:"_addTrait",value:(a=creature_sheet_asyncToGenerator(creature_sheet_regeneratorRuntime().mark((function _callee3(t){return creature_sheet_regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:if(this.actor.items.find((function(r){return"trait"==r.type&&r.name==t.name}))){r.next=8;break}return r.next=4,this._updateAPs(t.system.APValue.value);case 4:return r.next=6,P.Z.traitAdded(this.actor,t);case 6:return r.next=8,this.actor.createEmbeddedDocuments("Item",[t]);case 8:case"end":return r.stop()}}),_callee3,this)}))),function _addTrait(t){return a.apply(this,arguments)})},{key:"_onDropItemCreate",value:(r=creature_sheet_asyncToGenerator(creature_sheet_regeneratorRuntime().mark((function _callee4(t){return creature_sheet_regeneratorRuntime().wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:if("trait"!=t.type){r.next=2;break}return r.abrupt("return",this._addTrait(t));case 2:return r.abrupt("return",creature_sheet_get(creature_sheet_getPrototypeOf(ActorSheetdsa5Creature.prototype),"_onDropItemCreate",this).call(this,t));case 3:case"end":return r.stop()}}),_callee4,this)}))),function _onDropItemCreate(t){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=creature_sheet_get(creature_sheet_getPrototypeOf(ActorSheetdsa5Creature),"defaultOptions",this);return mergeObject(t,{classes:t.classes.concat(["dsa5","actor","creature-sheet"])}),t}}]),ActorSheetdsa5Creature}(b);function npc_sheet_typeof(t){return npc_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},npc_sheet_typeof(t)}function npc_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function npc_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function npc_sheet_get(){return npc_sheet_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=npc_sheet_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},npc_sheet_get.apply(this,arguments)}function npc_sheet_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=npc_sheet_getPrototypeOf(t)););return t}function npc_sheet_setPrototypeOf(t,r){return npc_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},npc_sheet_setPrototypeOf(t,r)}function npc_sheet_createSuper(t){var r=function npc_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=npc_sheet_getPrototypeOf(t);if(r){var i=npc_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return npc_sheet_possibleConstructorReturn(this,a)}}function npc_sheet_possibleConstructorReturn(t,r){if(r&&("object"===npc_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function npc_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function npc_sheet_getPrototypeOf(t){return npc_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},npc_sheet_getPrototypeOf(t)}var C=function(t){!function npc_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&npc_sheet_setPrototypeOf(t,r)}(ActorSheetdsa5NPC,t);var r=npc_sheet_createSuper(ActorSheetdsa5NPC);function ActorSheetdsa5NPC(){return npc_sheet_classCallCheck(this,ActorSheetdsa5NPC),r.apply(this,arguments)}return function npc_sheet_createClass(t,r,a){return r&&npc_sheet_defineProperties(t.prototype,r),a&&npc_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(ActorSheetdsa5NPC,[{key:"template",get:function get(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/npc-sheet.html"}}],[{key:"defaultOptions",get:function get(){var t=npc_sheet_get(npc_sheet_getPrototypeOf(ActorSheetdsa5NPC),"defaultOptions",this);return mergeObject(t,{classes:t.classes.concat(["dsa5","actor","npc-sheet"])}),t}}]),ActorSheetdsa5NPC}(O),D=__webpack_require__(702),I=__webpack_require__(562);function obfuscatemixin_typeof(t){return obfuscatemixin_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},obfuscatemixin_typeof(t)}function obfuscatemixin_regeneratorRuntime(){obfuscatemixin_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==obfuscatemixin_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function obfuscatemixin_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function obfuscatemixin_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){obfuscatemixin_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){obfuscatemixin_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function obfuscatemixin_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function obfuscatemixin_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function obfuscatemixin_get(){return obfuscatemixin_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=obfuscatemixin_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},obfuscatemixin_get.apply(this,arguments)}function obfuscatemixin_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=obfuscatemixin_getPrototypeOf(t)););return t}function obfuscatemixin_setPrototypeOf(t,r){return obfuscatemixin_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},obfuscatemixin_setPrototypeOf(t,r)}function obfuscatemixin_createSuper(t){var r=function obfuscatemixin_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=obfuscatemixin_getPrototypeOf(t);if(r){var i=obfuscatemixin_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return obfuscatemixin_possibleConstructorReturn(this,a)}}function obfuscatemixin_possibleConstructorReturn(t,r){if(r&&("object"===obfuscatemixin_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function obfuscatemixin_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function obfuscatemixin_getPrototypeOf(t){return obfuscatemixin_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},obfuscatemixin_getPrototypeOf(t)}var R=function ItemSheetObfuscation(t){return function(t){!function obfuscatemixin_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&obfuscatemixin_setPrototypeOf(t,r)}(_class,t);var r,a,o=obfuscatemixin_createSuper(_class);function _class(){return obfuscatemixin_classCallCheck(this,_class),o.apply(this,arguments)}return function obfuscatemixin_createClass(t,r,a){return r&&obfuscatemixin_defineProperties(t.prototype,r),a&&obfuscatemixin_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(_class,[{key:"obfuscateItem",value:(a=obfuscatemixin_asyncToGenerator(obfuscatemixin_regeneratorRuntime().mark((function _callee(t){var r;return obfuscatemixin_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return t.stopPropagation(),t.preventDefault(),r=t.currentTarget.dataset.obfuscate,a.next=5,this.item.update((o={},i="system.obfuscation.".concat(r),c=!this.isObfuscated(r),i in o?Object.defineProperty(o,i,{value:c,enumerable:!0,configurable:!0,writable:!0}):o[i]=c,o));case 5:case"end":return a.stop()}var o,i,c}),_callee,this)}))),function obfuscateItem(t){return a.apply(this,arguments)})},{key:"isObfuscated",value:function isObfuscated(t){return getProperty(this.item,"system.obfuscation.".concat(t))}},{key:"activateListeners",value:function activateListeners(t){var r=this;obfuscatemixin_get(obfuscatemixin_getPrototypeOf(_class.prototype),"activateListeners",this).call(this,t),t.on("click",".obfuscateSection",(function(t){return r.obfuscateItem(t)}))}},{key:"obfuscationCss",value:function obfuscationCss(t){return this.isObfuscated(t)?"":" pale"}},{key:"_render",value:(r=obfuscatemixin_asyncToGenerator(obfuscatemixin_regeneratorRuntime().mark((function _callee2(){var t,r,a,o,i,c,u,l,p,d,h,m=arguments;return obfuscatemixin_regeneratorRuntime().wrap((function _callee2$(y){for(;;)switch(y.prev=y.next){case 0:return t=m.length>0&&void 0!==m[0]&&m[0],r=m.length>1&&void 0!==m[1]?m[1]:{},y.next=4,obfuscatemixin_get(obfuscatemixin_getPrototypeOf(_class.prototype),"_render",this).call(this,t,r);case 4:a=!1,o=0,i=["details","effects","description","enchantment"];case 7:if(!(o<i.length)){y.next=18;break}if(c=i[o],(u=$(this._element).find('nav [data-tab="'.concat(c,'"]'))).length){y.next=12;break}return y.abrupt("continue",15);case 12:l=r.tabsinvisible||this.isObfuscated(c),p=game.i18n.localize("SHEET.".concat(l?"deobfuscateItem":"obfuscateItem")),game.user.isGM?u.append(' <a data-tooltip="'.concat(p,'" class="obfuscateSection').concat(this.obfuscationCss(c),'" data-obfuscate="').concat(c,'"><i class="fas fa-mask"></i></a>')):l&&(u.hasClass("active")&&(a=!0),u.remove(),"details"==c&&$(this._element).find('[name="system.price.value"],[name="system.price.raw"]').replaceWith("<label>?</label>"));case 15:o++,y.next=7;break;case 18:if(!a){y.next=28;break}if(!(d=$(this._element).find("nav .item:first-child")).length){y.next=24;break}this.activateTab(d.attr("data-tab")),y.next=28;break;case 24:return y.next=26,renderTemplate("systems/dsa5/templates/items/obfuscatedItem.html",{item:this.item});case 26:h=y.sent,$(this._element).find(".content").html(h);case 28:case"end":return y.stop()}}),_callee2,this)}))),function _render(){return r.apply(this,arguments)})}]),_class}(t)};function item_sheet_typeof(t){return item_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},item_sheet_typeof(t)}function item_sheet_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function item_sheet_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function item_sheet_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return item_sheet_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return item_sheet_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function item_sheet_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function item_sheet_regeneratorRuntime(){item_sheet_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==item_sheet_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function item_sheet_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function item_sheet_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){item_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){item_sheet_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function item_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function item_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function item_sheet_createClass(t,r,a){return r&&item_sheet_defineProperties(t.prototype,r),a&&item_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function item_sheet_get(){return item_sheet_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=item_sheet_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},item_sheet_get.apply(this,arguments)}function item_sheet_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=item_sheet_getPrototypeOf(t)););return t}function item_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&item_sheet_setPrototypeOf(t,r)}function item_sheet_setPrototypeOf(t,r){return item_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},item_sheet_setPrototypeOf(t,r)}function item_sheet_createSuper(t){var r=function item_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=item_sheet_getPrototypeOf(t);if(r){var i=item_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return item_sheet_possibleConstructorReturn(this,a)}}function item_sheet_possibleConstructorReturn(t,r){if(r&&("object"===item_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function item_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function item_sheet_getPrototypeOf(t){return item_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},item_sheet_getPrototypeOf(t)}var L=function(a){item_sheet_inherits(ItemSheetdsa5,ItemSheet);var o,i,l,p=item_sheet_createSuper(ItemSheetdsa5);function ItemSheetdsa5(t,r){var a;return item_sheet_classCallCheck(this,ItemSheetdsa5),(a=p.call(this,t,r)).mce=null,a}return item_sheet_createClass(ItemSheetdsa5,[{key:"_getSubmitData",value:function _getSubmitData(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=item_sheet_get(item_sheet_getPrototypeOf(ItemSheetdsa5.prototype),"_getSubmitData",this).call(this,t),a=foundry.utils.flattenObject(this.item.overrides||{});return Object.keys(a).forEach((function(t){return delete r[t]})),r}},{key:"_render",value:(l=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee(){var t,r,a=arguments;return item_sheet_regeneratorRuntime().wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},o.next=4,item_sheet_get(item_sheet_getPrototypeOf(ItemSheetdsa5.prototype),"_render",this).call(this,t,r);case 4:$(this._element).find(".close").attr("data-tooltip",game.i18n.localize("SHEET.Close")),$(this._element).find(".configure-sheet").attr("data-tooltip",game.i18n.localize("SHEET.Configure")),$(this._element).find(".import").attr("data-tooltip",game.i18n.localize("SHEET.Import")),$(this._element).find(".rolleffect").attr("data-tooltip",game.i18n.localize("SHEET.RollEffect")),$(this._element).find(".showItemHead").attr("data-tooltip",game.i18n.localize("SHEET.PostItem")),$(this._element).find(".consumeItem").attr("data-tooltip",game.i18n.localize("SHEET.ConsumeItem")),$(this._element).find(".rollDamaged").attr("data-tooltip",game.i18n.localize("DSASETTINGS.armorAndWeaponDamage")),$(this._element).find(".onUseEffect").attr("data-tooltip",game.i18n.localize("SHEET.onUseEffect"));case 12:case"end":return o.stop()}}),_callee,this)}))),function _render(){return l.apply(this,arguments)})},{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r,a=this,o=item_sheet_get(item_sheet_getPrototypeOf(ItemSheetdsa5.prototype),"_getHeaderButtons",this).call(this);return o.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee2(){return item_sheet_regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",a.item.postItem());case 1:case"end":return t.stop()}}),_callee2)}))),function onclick(){return t.apply(this,arguments)})}),this.item.actor&&g.Z.getOnUseEffect(this.item)&&o.unshift({class:"onUseEffect",icon:"fas fa-dice-six",onclick:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee3(){return item_sheet_regeneratorRuntime().wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:new g.Z(a.item).executeOnUseEffect();case 2:case"end":return t.stop()}}),_callee3)}))),function onclick(){return r.apply(this,arguments)})}),o}},{key:"setupEffect",value:function setupEffect(t){var r=this;this.item.setupEffect().then((function(t){return r.item.itemTest(t)}))}},{key:"template",get:function get(){var t=this.item.type;return"systems/dsa5/templates/items/item-".concat(t,"-sheet.html")}},{key:"_getItemId",value:function _getItemId(t){return $(t.currentTarget).parents(".item").attr("data-item-id")}},{key:"_advanceStep",value:function _advanceStep(){}},{key:"_refundStep",value:function _refundStep(){}},{key:"advanceWrapper",value:(i=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee4(t,r){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee4$(i){for(;;)switch(i.prev=i.next){case 0:if(a=$(t.currentTarget),(o=a.find("i")).hasClass("fa-spin")){i.next=7;break}return o.addClass("fa-spin fa-spinner"),i.next=6,this[r]();case 6:o.removeClass("fa-spin fa-spinner");case 7:case"end":return i.stop()}}),_callee4,this)}))),function advanceWrapper(t,r){return i.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(r){var a=this;item_sheet_get(item_sheet_getPrototypeOf(ItemSheetdsa5.prototype),"activateListeners",this).call(this,r),r.find(".advance-step").mousedown((function(t){return a.advanceWrapper(t,"_advanceStep")})),r.find(".refund-step").mousedown((function(t){return a.advanceWrapper(t,"_refundStep")})),r.find(".domainsPretty").click((function(t){$(t.currentTarget).hide(),$(t.currentTarget).next(".domainToggle").show()})),r.find('[data-edit="img"]').mousedown((function(r){2==r.button&&t.Z.showArtwork(a.item)})),r.find(".status-add").click((function(){a.item.actor?ui.notifications.error(game.i18n.localize("DSAError.nestedEffectNotSupported")):u.Z.createCustomEffect(a.item,"",a.item.name)})),r.find(".condition-show").mousedown((function(t){t.preventDefault();var r=$(t.currentTarget).attr("data-id");0==t.button?a.item.effects.get(r).sheet.render(!0):2==t.button&&a.item.deleteEmbeddedDocuments("ActiveEffect",[r])})),r.find(".condition-toggle").mousedown((function(t){var r=$(t.currentTarget).parents(".statusEffect").attr("data-id"),o=a.item.effects.get(r);o.update({disabled:!o.system.disabled})})),r.find(".condition-edit").click((function(t){a.item.effects.get($(t.currentTarget).attr("data-id")).sheet.render(!0)})),_.Z.bindRollCommands(r),u.Z.bindButtons(r),r.on("click",".chat-condition",(function(t){c.Z.postStatus($(t.currentTarget).attr("data-id"))}));var o=r.find(".item-header");if(o.length){var i=o.find("svg");if(i){new ResizeObserver((function(t){var r=t[0];(0,h.zJ)(i,r.contentRect.width)})).observe(o.get(0));var l=o.find("input");l.get(0).disabled||(i.click((function(){i.hide(),l.show(),l.focus()})),l.blur((function(){i.show(),l.hide()})))}}}},{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee5(a){var o;return item_sheet_regeneratorRuntime().wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:o=item_sheet_get(item_sheet_getPrototypeOf(ItemSheetdsa5.prototype),"getData",this).call(this,a).data,i.t0=this.item.type,i.next="skill"===i.t0?4:"application"===i.t0?10:"combatskill"===i.t0?16:"trait"===i.t0?21:"aggregatedTest"===i.t0?24:28;break;case 4:return o.characteristics=r.Z.characteristics,o.skillGroups=r.Z.skillGroups,o.skillBurdens=r.Z.skillBurdens,o.hasLocalization=game.i18n.has("SKILLdescr.".concat(this.item.name)),o.StFs=r.Z.StFs,i.abrupt("break",28);case 10:return o.hasLocalization=game.i18n.has("APPLICATION.".concat(this.item.system.skill," - ").concat(this.item.name)),o.localization=game.i18n.localize("APPLICATION.".concat(this.item.system.skill," - ").concat(this.item.name)),i.next=14,t.Z.allSkillsList();case 14:case 26:return o.allSkills=i.sent,i.abrupt("break",28);case 16:return o.weapontypes=r.Z.weapontypes,o.guidevalues=r.Z.combatskillsGuidevalues,o.hasLocalization=game.i18n.has("Combatskilldescr.".concat(this.item.name)),o.StFs=r.Z.StFs,i.abrupt("break",28);case 21:return o.traitCategories=r.Z.traitCategories,o.ranges=r.Z.meleeRanges,i.abrupt("break",28);case 24:return i.next=26,t.Z.allSkillsList();case 28:return o.isOwned=this.item.actor,o.editable=this.isEditable,o.isOwned&&(o.canAdvance=this.item.actor.system.canAdvance&&this._advancable()),u.Z.prepareActiveEffects(this.item,o),o.item=this.item,o.armorAndWeaponDamage=game.settings.get("dsa5","armorAndWeaponDamage"),o.isGM=game.user.isGM,i.next=37,TextEditor.enrichHTML(getProperty(this.item.system,"description.value"),{secrets:!0,async:!0});case 37:return o.enrichedDescription=i.sent,i.next=40,TextEditor.enrichHTML(getProperty(this.item.system,"gmdescription.value"),{secrets:!0,async:!0});case 40:return o.enrichedGmdescription=i.sent,i.abrupt("return",o);case 42:case"end":return i.stop()}}),_callee5,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"_advancable",value:function _advancable(){return!1}}],[{key:"defaultOptions",get:function get(){var t=item_sheet_get(item_sheet_getPrototypeOf(ItemSheetdsa5),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content"}],mergeObject(t,{classes:t.classes.concat(["dsa5","item"]),width:450,height:500}),t}},{key:"setupSheets",value:function setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsa5",ItemSheetdsa5,{makeDefault:!0}),Items.registerSheet("dsa5",te,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsa5",U,{makeDefault:!0,types:["career"]}),Items.registerSheet("dsa5",V,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsa5",ae,{makeDefault:!0,types:["advantage","disadvantage"]}),Items.registerSheet("dsa5",re,{makeDefault:!0,types:["ritual","ceremony","liturgy","spell"]}),Items.registerSheet("dsa5",ee,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsa5",Q,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsa5",X,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsa5",K,{makeDefault:!0,types:["disease"]}),Items.registerSheet("dsa5",Y,{makeDefault:!0,types:["consumable"]}),Items.registerSheet("dsa5",ne,{makeDefault:!0,types:["spellextension"]}),Items.registerSheet("dsa5",J,{makeDefault:!0,types:["magictrick"]}),Items.registerSheet("dsa5",q,{makeDefault:!0,types:["blessing"]}),Items.registerSheet("dsa5",Z,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsa5",z,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsa5",N,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsa5",j,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsa5",H,{makeDefault:!0,types:["plant"]}),Items.registerSheet("dsa5",B,{makeDefault:!0,types:["magicalsign"]}),Items.registerSheet("dsa5",W,{makeDefault:!0,types:["patron"]}),Items.registerSheet("dsa5",M,{makeDefault:!0,types:["information"]}),Items.unregisterSheet("dsa5",ItemSheetdsa5,{types:["armor","equipment","rangeweapon","blessing","magictrick","spellextension","consumable","species","career","culture","advantage","specialability","disadvantage","ritual","information","ceremony","liturgy","spell","disease","poison","meleeweapon","ammunition","plant","magicalsign","patron"]})}}]),ItemSheetdsa5}(),G=function(a){item_sheet_inherits(Enchantable,a);var o,i,c,u,l,p,d=item_sheet_createSuper(Enchantable);function Enchantable(){return item_sheet_classCallCheck(this,Enchantable),d.apply(this,arguments)}return item_sheet_createClass(Enchantable,[{key:"_onDrop",value:(p=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee6(t){return item_sheet_regeneratorRuntime().wrap((function _callee6$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.enchant(t);case 2:if(!this.isPoisonable){r.next=5;break}return r.next=5,this.poison(t);case 5:case"end":return r.stop()}}),_callee6,this)}))),function _onDrop(t){return p.apply(this,arguments)})},{key:"enchant",value:(l=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee7(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:return r=JSON.parse(t.dataTransfer.getData("text/plain")),a.next=3,this._enchant([r]);case 3:case"end":return a.stop()}}),_callee7,this)}))),function enchant(t){return l.apply(this,arguments)})},{key:"_enchant",value:(u=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee8(t){var r,a,o,i,c,u,l,p,d;return item_sheet_regeneratorRuntime().wrap((function _callee8$(m){for(;;)switch(m.prev=m.next){case 0:if(!((r=this.item.getFlag("dsa5","enchantments")||[]).length+t.length>7)){m.next=3;break}return m.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.tooManyEnchants")));case 3:a=item_sheet_createForOfIteratorHelper(t),m.prev=4,a.s();case 6:if((o=a.n()).done){m.next=21;break}return i=o.value,m.next=10,(0,h.x8)(i,void 0,!1);case 10:if(c=m.sent,u=c.item,l=c.typeClass,c.selfTarget,!["spell","liturgy","ceremony","ritual"].includes(l)){m.next=19;break}if(u.pack){m.next=17;break}return m.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.onlyCompendiumSpells")));case 17:p={name:u.name,pack:u.pack,id:r.length,itemId:u.id,permanent:["liturgy","ceremony"].includes(l)||i.permanent,actorId:i.actorId,charged:!0,talisman:["liturgy","ceremony"].includes(l),fw:["liturgy","ceremony"].includes(l)?18:i.fw||0},r.push(p);case 19:m.next=6;break;case 21:m.next=26;break;case 23:m.prev=23,m.t0=m.catch(4),a.e(m.t0);case 26:return m.prev=26,a.f(),m.finish(26);case 29:if(!r.length){m.next=33;break}return d={flags:{dsa5:{enchantments:r}}},m.next=33,this.item.update(d);case 33:case"end":return m.stop()}}),_callee8,this,[[4,23,26,29]])}))),function _enchant(t){return u.apply(this,arguments)})},{key:"poison",value:(c=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee9(t){var r,a,o,i,c,u;return item_sheet_regeneratorRuntime().wrap((function _callee9$(l){for(;;)switch(l.prev=l.next){case 0:return r=JSON.parse(t.dataTransfer.getData("text/plain")),l.next=3,(0,h.x8)(r,void 0,!1);case 3:if(a=l.sent,o=a.item,i=a.typeClass,a.selfTarget,"poison"!=i){l.next=12;break}return c={name:o.name,pack:o.pack,itemId:o._id,permanent:!1,actorId:r.actorId},u={flags:{dsa5:{poison:c}}},l.next=12,this.item.update(u);case 12:case"end":return l.stop()}}),_callee9,this)}))),function poison(t){return c.apply(this,arguments)})},{key:"toggleChargedState",value:function toggleChargedState(t,r){var a,o=item_sheet_createForOfIteratorHelper(r);try{for(o.s();!(a=o.n()).done;){var i=a.value;if(i.id==t){i.charged=!(!i.talisman||!i.permanent)||!i.charged;break}}}catch(t){o.e(t)}finally{o.f()}this.item.update({flags:{dsa5:{enchantments:r}}})}},{key:"activateListeners",value:function activateListeners(r){var a=this;item_sheet_get(item_sheet_getPrototypeOf(Enchantable.prototype),"activateListeners",this).call(this,r),r.find(".ench-toggle-permanent").click((function(t){var r,o=a.enchantMentId(t),i=o.id,c=o.enchantments,u=item_sheet_createForOfIteratorHelper(c);try{for(u.s();!(r=u.n()).done;){var l=r.value;if(l.id==i){l.permanent=!l.permanent;break}}}catch(t){u.e(t)}finally{u.f()}a.item.update({flags:{dsa5:{enchantments:c}}})})),r.find(".ench-toggle-charge").click((function(t){var r=a.enchantMentId(t),o=r.id,i=r.enchantments;a.toggleChargedState(o,i)})),r.find(".ench-roll").click(function(){var r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee11(r){var o,i,c,u,l,p;return item_sheet_regeneratorRuntime().wrap((function _callee11$(d){for(;;)switch(d.prev=d.next){case 0:if(o=a.enchantMentId(r),i=o.id,c=o.enchantments,(u=c.find((function(t){return t.id==i}))).charged){d.next=4;break}return d.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges")));case 4:return d.next=6,a.getSpell(u);case 6:if(!(l=d.sent)){d.next=14;break}return(l=l.toObject()).system.talentValue.value=u.fw,d.next=12,t.Z.emptyActor(14);case 12:(p=d.sent).setupSpell(l,{},"emptyActor").then(function(){var r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee10(r){var o;return item_sheet_regeneratorRuntime().wrap((function _callee10$(d){for(;;)switch(d.prev=d.next){case 0:return o=game.i18n.format("CHATNOTIFICATION.enchantmentUsed",{item:a.item.name,spell:l.name}),d.next=3,ChatMessage.create(t.Z.chatDataSetup(o));case 3:return d.next=5,p.basicTest(r);case 5:u.permanent?a.toggleChargedState(i,c):a.deleteEnchantment(i,c);case 6:case"end":return d.stop()}}),_callee10)})));return function(t){return r.apply(this,arguments)}}());case 14:case"end":return d.stop()}}),_callee11)})));return function(t){return r.apply(this,arguments)}}()),r.find(".ench-fw").change((function(t){var r=a.enchantMentId(t),o=r.id,i=r.enchantments,c=Number($(t.currentTarget).val());if(c){var u,l=item_sheet_createForOfIteratorHelper(i);try{for(l.s();!(u=l.n()).done;){var p=u.value;if(p.id==o){p.fw=c;break}}}catch(t){l.e(t)}finally{l.f()}a.item.update({flags:{dsa5:{enchantments:i}}})}})),r.find(".ench-delete").click((function(t){var r=a.enchantMentId(t),o=r.id,i=r.enchantments;a.deleteEnchantment(o,i)})),r.find(".ench-show").click(function(){var t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee12(t){var r,o,i,c,u;return item_sheet_regeneratorRuntime().wrap((function _callee12$(l){for(;;)switch(l.prev=l.next){case 0:return r=a.enchantMentId(t),o=r.id,i=r.enchantments,c=i.find((function(t){return t.id==o})),l.next=4,a.getSpell(c);case 4:(u=l.sent)&&u.sheet.render(!0);case 6:case"end":return l.stop()}}),_callee12)})));return function(r){return t.apply(this,arguments)}}()),r.find(".poison-toggle-permanent").click((function(t){a.item.update({flags:{dsa5:{poison:{permanent:!a.item.flags.dsa5.poison.permanent}}}})})),r.find(".poison-delete").click((function(t){a.deletePoison()})),r.find(".poison-show").click(item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee13(){var t;return item_sheet_regeneratorRuntime().wrap((function _callee13$(r){for(;;)switch(r.prev=r.next){case 0:if(a.item.actor&&(t=a.item.actor.items.find((function(t){return"poison"==t.type&&t.name==a.item.flags.dsa5.poison.name}))),t){r.next=5;break}return r.next=4,a.getSpell(a.item.flags.dsa5.poison);case 4:t=r.sent;case 5:t&&t.sheet.render(!0);case 6:case"end":return r.stop()}}),_callee13)}))))}},{key:"deletePoison",value:function deletePoison(){this.item.update(item_sheet_defineProperty({},"flags.dsa5.-=poison",null))}},{key:"deleteEnchantment",value:function deleteEnchantment(t,r){var a=r.findIndex((function(r){return r.id==t}));r.splice(a,1),this.item.update({flags:{dsa5:{enchantments:r}}})}},{key:"getSpell",value:(i=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee14(t){var r,a,o;return item_sheet_regeneratorRuntime().wrap((function _callee14$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,game.packs.get(t.pack);case 2:if(r=i.sent){i.next=6;break}return ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),i.abrupt("return");case 6:return i.next=8,r.getDocument(t.itemId);case 8:if(a=i.sent){i.next=17;break}return i.next=12,r.index.getName(t.name);case 12:if(!(o=i.sent)){i.next=17;break}return i.next=16,r.getDocument(o._id);case 16:a=i.sent;case 17:return a||ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),i.abrupt("return",a);case 19:case"end":return i.stop()}}),_callee14)}))),function getSpell(t){return i.apply(this,arguments)})},{key:"enchantMentId",value:function enchantMentId(t){return{id:$(t.currentTarget).parents(".statusEffect").attr("data-id"),enchantments:this.item.getFlag("dsa5","enchantments")}}},{key:"prepareDomains",value:function prepareDomains(){var t=getProperty(this.item.system,"effect.attributes");if(t){var r=new RegExp(game.i18n.localize("WEAPON.magical"),"i"),a=new RegExp(game.i18n.localize("WEAPON.clerical"),"i");t=t.split(",").map((function(t){var o="";return r.test(t)?o="magical":a.test(t)&&(o="blessed"),'<li class="'.concat(o,'">').concat(t,"</li>")})).join("")}return t}},{key:"_canDragDrop",value:function _canDragDrop(t){return this.isEditable}},{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee15(t){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee15$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,item_sheet_get(item_sheet_getPrototypeOf(Enchantable.prototype),"getData",this).call(this,t);case 2:return(a=i.sent).enchantments=this.item.getFlag("dsa5","enchantments"),o=[],a.poison=this.item.getFlag("dsa5","poison"),a.poison&&o.push("poison"),a.enchantments&&a.enchantments.some((function(t){return!t.talisman}))&&o.push("enchantment"),a.enchantments&&a.enchantments.some((function(t){return t.talisman}))&&o.push("talisman"),a.enchantmentLabel=o.map((function(t){return game.i18n.localize(t)})).join("/"),a.traditionArtifacts=r.Z.traditionArtifacts,a.hasEnchantments=a.poison||a.enchantments&&a.enchantments.length>0,i.abrupt("return",a);case 13:case"end":return i.stop()}}),_callee15,this)}))),function getData(t){return o.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){var t=item_sheet_get(item_sheet_getPrototypeOf(Enchantable),"defaultOptions",this);return mergeObject(t,{dragDrop:[{dragSelector:".item-list .item",dropSelector:".content"}]}),t}}]),Enchantable}(L),M=function(r){item_sheet_inherits(InformationSheet,r);var a,o=item_sheet_createSuper(InformationSheet);function InformationSheet(){return item_sheet_classCallCheck(this,InformationSheet),o.apply(this,arguments)}return item_sheet_createClass(InformationSheet,[{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee16(r){var a;return item_sheet_regeneratorRuntime().wrap((function _callee16$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(InformationSheet.prototype),"getData",this).call(this,r);case 2:return a=o.sent,o.next=5,t.Z.allSkillsList();case 5:return a.allSkills=o.sent,o.abrupt("return",a);case 7:case"end":return o.stop()}}),_callee16,this)}))),function getData(t){return a.apply(this,arguments)})}]),InformationSheet}(L),j=function(t){item_sheet_inherits(AmmunitionSheet,t);var a,o=item_sheet_createSuper(AmmunitionSheet);function AmmunitionSheet(t,r){var a;return item_sheet_classCallCheck(this,AmmunitionSheet),(a=o.call(this,t,r)).mce=null,a.isPoisonable=!0,a}return item_sheet_createClass(AmmunitionSheet,[{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee17(t){var a;return item_sheet_regeneratorRuntime().wrap((function _callee17$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(AmmunitionSheet.prototype),"getData",this).call(this,t);case 2:return(a=o.sent).ammunitiongroups=r.Z.ammunitiongroups,a.domains=this.prepareDomains(),o.abrupt("return",a);case 6:case"end":return o.stop()}}),_callee17,this)}))),function getData(t){return a.apply(this,arguments)})}]),AmmunitionSheet}(G),z=function(t){item_sheet_inherits(EquipmentSheet,t);var a,o,i,c=item_sheet_createSuper(EquipmentSheet);function EquipmentSheet(){return item_sheet_classCallCheck(this,EquipmentSheet),c.apply(this,arguments)}return item_sheet_createClass(EquipmentSheet,[{key:"getData",value:(i=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee18(t){var a,o,i=this;return item_sheet_regeneratorRuntime().wrap((function _callee18$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,item_sheet_get(item_sheet_getPrototypeOf(EquipmentSheet.prototype),"getData",this).call(this,t);case 2:if((a=c.sent).equipmentTypes=r.Z.equipmentTypes,a.domains=this.prepareDomains(),c.t0=game.user.isGM,c.t0){c.next=10;break}return c.next=9,game.settings.get("dsa5","playerCanEditSpellMacro");case 9:c.t0=c.sent;case 10:return a.canOnUseEffect=c.t0,this.isBagWithContents()&&(o=0,a.containerContent=this.item.actor.items.filter((function(t){return r.Z.equipmentCategories.includes(t.type)&&t.system.parent_id==i.item.id})).map((function(t){t.weight=parseFloat((t.system.weight.value*t.system.quantity.value).toFixed(3)),o+=Number(t.weight);var r=getProperty(t,"flags.dsa5.enchantments");return r&&r.length>0?t.enchantClass="rar":(t.system.effect&&""!=t.system.effect.value||t.effects.length>0)&&(t.enchantClass="common"),t})),a.weightSum=parseFloat(o.toFixed(3)),a.weightWidth='style="width: '.concat(Math.min(this.item.system.capacity?o/this.item.system.capacity*100:0,100),'%"'),a.weightExceeded=o>Number(this.item.system.capacity)?"exceeded":""),c.abrupt("return",a);case 13:case"end":return c.stop()}}),_callee18,this)}))),function getData(t){return i.apply(this,arguments)})},{key:"breakOverflow",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee19(t,r){var a,o,i;return item_sheet_regeneratorRuntime().wrap((function _callee19$(c){for(;;)switch(c.prev=c.next){case 0:return c.t0=$,c.next=3,renderTemplate("systems/dsa5/templates/items/baghover.html",t);case 3:return c.t1=c.sent,a=(0,c.t0)(c.t1),o=r.offset().top+52,i=r.offset().left-75,a.appendTo($("body")),a.css({position:"absolute",left:i+"px",top:o+"px",bottom:"auto",right:"auto","z-index":1e4}),c.abrupt("return",a);case 10:case"end":return c.stop()}}),_callee19)}))),function breakOverflow(t,r){return o.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;item_sheet_get(item_sheet_getPrototypeOf(EquipmentSheet.prototype),"activateListeners",this).call(this,t);var a=t.find(".slot");a.mouseenter(function(){var t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee20(t){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee20$(i){for(;;)switch(i.prev=i.next){case 0:return a=$(t.currentTarget),i.next=3,r.breakOverflow({name:a.attr("data-name"),weight:a.attr("data-weight"),quantity:a.attr("data-quantity")},a);case 3:(o=i.sent).fadeIn(),a.mouseleave((function(){o.remove(),a.off("mouseleave")}));case 6:case"end":return i.stop()}}),_callee20)})));return function(r){return t.apply(this,arguments)}}()),a.mousedown(function(){var t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee21(t){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee21$(i){for(;;)switch(i.prev=i.next){case 0:if(a=$(t.currentTarget).attr("data-item-id"),o=r.actor.items.get(a),0!=t.button){i.next=6;break}o.sheet.render(!0),i.next=11;break;case 6:if(2!=t.button){i.next=11;break}return $(".itemInfo").remove(),i.next=10,o.update({"system.parent_id":0});case 10:r.render(!0);case 11:case"end":return i.stop()}}),_callee21)})));return function(r){return t.apply(this,arguments)}}())}},{key:"isBagWithContents",value:function isBagWithContents(){return this.item.actor&&"bags"==getProperty(this.item,"system.equipmentType.value")}},{key:"_onDrop",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee22(t){var a,o,i,c,u,l;return item_sheet_regeneratorRuntime().wrap((function _callee22$(p){for(;;)switch(p.prev=p.next){case 0:if(!this.isBagWithContents()){p.next=22;break}return a=JSON.parse(t.dataTransfer.getData("text/plain")),p.next=4,(0,h.x8)(a,void 0);case 4:if(o=p.sent,i=o.item,c=o.typeClass,o.selfTarget,u=this.item.id==i.id,l=this.item.parent.id==a.actorId,!r.Z.equipmentCategories.includes(c)||u){p.next=22;break}if(i.system.parent_id=this.item.id,i.system.worn&&i.system.worn.value&&(i.system.worn.value=!1),!l){p.next=18;break}return p.next=16,this.item.actor.updateEmbeddedDocuments("Item",[i]);case 16:p.next=20;break;case 18:return p.next=20,this.item.actor.sheet._addLoot(i);case 20:return this.render(!0),p.abrupt("return");case 22:return p.next=24,item_sheet_get(item_sheet_getPrototypeOf(EquipmentSheet.prototype),"_onDrop",this).call(this,t);case 24:case"end":return p.stop()}}),_callee22,this)}))),function _onDrop(t){return a.apply(this,arguments)})}]),EquipmentSheet}(R(G)),N=function(t){item_sheet_inherits(ArmorSheet,t);var a,o=item_sheet_createSuper(ArmorSheet);function ArmorSheet(){return item_sheet_classCallCheck(this,ArmorSheet),o.apply(this,arguments)}return item_sheet_createClass(ArmorSheet,[{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee23(t){var a;return item_sheet_regeneratorRuntime().wrap((function _callee23$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(ArmorSheet.prototype),"getData",this).call(this,t);case 2:if(a=o.sent,mergeObject(a,{domains:this.prepareDomains(),armorSubcategories:Object.keys(r.Z.armorSubcategories),breakPointRating:r.Z.armorSubcategories[this.item.system.subcategory]}),o.t0=game.user.isGM,o.t0){o.next=9;break}return o.next=8,game.settings.get("dsa5","playerCanEditSpellMacro");case 8:o.t0=o.sent;case 9:return a.canOnUseEffect=o.t0,o.abrupt("return",a);case 11:case"end":return o.stop()}}),_callee23,this)}))),function getData(t){return a.apply(this,arguments)})},{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(ArmorSheet.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&a.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee24(){return item_sheet_regeneratorRuntime().wrap((function _callee24$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",D.Z.breakingTest(r.item));case 1:case"end":return t.stop()}}),_callee24)}))),function onclick(){return t.apply(this,arguments)})}),a}}]),ArmorSheet}(R(G)),H=function(t){item_sheet_inherits(PlantSheet,t);var r,a=item_sheet_createSuper(PlantSheet);function PlantSheet(){return item_sheet_classCallCheck(this,PlantSheet),a.apply(this,arguments)}return item_sheet_createClass(PlantSheet,[{key:"getData",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee25(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee25$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(PlantSheet.prototype),"getData",this).call(this,t);case 2:return(r=a.sent).attributes=Object.keys(r.system.planttype).map((function(t){return{name:t,checked:r.system.planttype[t]}})),a.next=6,TextEditor.enrichHTML(getProperty(this.item.system,"effect"),{secrets:!0,async:!0});case 6:return r.enrichedEffect=a.sent,a.next=9,TextEditor.enrichHTML(getProperty(this.item.system,"recipes"),{secrets:!0,async:!0});case 9:return r.enrichedRecipes=a.sent,a.next=12,TextEditor.enrichHTML(getProperty(this.item.system,"infos"),{secrets:!0,async:!0});case 12:return r.enrichedInformation=a.sent,a.abrupt("return",r);case 14:case"end":return a.stop()}}),_callee25,this)}))),function getData(t){return r.apply(this,arguments)})}]),PlantSheet}(R(L)),W=function(t){item_sheet_inherits(PatronSheet,t);var r,a=item_sheet_createSuper(PatronSheet);function PatronSheet(){return item_sheet_classCallCheck(this,PatronSheet),a.apply(this,arguments)}return item_sheet_createClass(PatronSheet,[{key:"getData",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee26(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee26$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(PatronSheet.prototype),"getData",this).call(this,t);case 2:return(r=a.sent).patronCategories=[0,1,2,3].map((function(t){return{name:game.i18n.localize("PATRON.".concat(t)),val:t}})),r.priorities={0:game.i18n.localize("PATRON.primary"),1:game.i18n.localize("PATRON.secondary")},a.abrupt("return",r);case 6:case"end":return a.stop()}}),_callee26,this)}))),function getData(t){return r.apply(this,arguments)})}]),PatronSheet}(L),B=function(t){item_sheet_inherits(MagicalSignSheet,t);var r,a,o=item_sheet_createSuper(MagicalSignSheet);function MagicalSignSheet(){return item_sheet_classCallCheck(this,MagicalSignSheet),o.apply(this,arguments)}return item_sheet_createClass(MagicalSignSheet,[{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee27(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee27$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(MagicalSignSheet.prototype),"getData",this).call(this,t);case 2:if((r=a.sent).categories={1:game.i18n.localize("magicalsign"),2:game.i18n.localize("additionalsign")},a.t0=game.user.isGM,a.t0){a.next=9;break}return a.next=8,game.settings.get("dsa5","playerCanEditSpellMacro");case 8:a.t0=a.sent;case 9:return r.canOnUseEffect=a.t0,a.abrupt("return",r);case 11:case"end":return a.stop()}}),_callee27,this)}))),function getData(t){return a.apply(this,arguments)})},{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(MagicalSignSheet.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&a.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee28(t){return item_sheet_regeneratorRuntime().wrap((function _callee28$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setupEffect(t));case 1:case"end":return a.stop()}}),_callee28)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"setupEffect",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee30(t){var r,a,o,i,c;return item_sheet_regeneratorRuntime().wrap((function _callee30$(t){for(;;)switch(t.prev=t.next){case 0:if(r=Number(this.item.system.asp)||0,!(this.item.actor.system.status.astralenergy.value<r)){t.next=3;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP")));case 3:a=this.item.actor,o=game.dsa5.config.ItemSubclasses.magicalsign,i=a.items.find((function(t){return"skill"==t.type&&t.name==game.i18n.localize("LocalizedIDs.artisticAbility")})),c="<hr/><p><b>".concat(this.item.name,"</b></p><p>").concat(this.item.system.description.value,"</p><p>").concat(o.chatData(this.item.system,"").join("</br>"),' <span class="costCheck"></span></p>'),a.setupSkill(i,{other:[c],subtitle:" (".concat(game.i18n.localize("magicalsign"),")")},void 0).then(function(){var t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee29(t){var o;return item_sheet_regeneratorRuntime().wrap((function _callee29$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,a.basicTest(t,{suppressMessage:!0});case 2:return(o=i.sent).result.preData.calculatedSpellModifiers={finalcost:r,costsMana:!0},i.next=6,I.Z.renderRollCard(o.cardOptions,o.result,o.options.rerenderMessage);case 6:case"end":return i.stop()}}),_callee29)})));return function(r){return t.apply(this,arguments)}}());case 8:case"end":return t.stop()}}),_callee30,this)}))),function setupEffect(t){return r.apply(this,arguments)})}]),MagicalSignSheet}(L),Z=function(a){item_sheet_inherits(RangeweaponSheet,a);var o,i=item_sheet_createSuper(RangeweaponSheet);function RangeweaponSheet(){return item_sheet_classCallCheck(this,RangeweaponSheet),i.apply(this,arguments)}return item_sheet_createClass(RangeweaponSheet,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(RangeweaponSheet.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&a.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee31(){return item_sheet_regeneratorRuntime().wrap((function _callee31$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",D.Z.breakingTest(r.item));case 1:case"end":return t.stop()}}),_callee31)}))),function onclick(){return t.apply(this,arguments)})}),a}},{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee32(a){var o;return item_sheet_regeneratorRuntime().wrap((function _callee32$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,item_sheet_get(item_sheet_getPrototypeOf(RangeweaponSheet.prototype),"getData",this).call(this,a);case 2:if(o=i.sent,i.t0=game.user.isGM,i.t0){i.next=8;break}return i.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:i.t0=i.sent;case 8:return o.canOnUseEffect=i.t0,i.t1=mergeObject,i.t2=o,i.t3=r.Z.ammunitiongroups,i.next=14,t.Z.allCombatSkillsList("range");case 14:return i.t4=i.sent,i.t5=this.prepareDomains(),i.t6=r.Z.weaponStabilities[game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value))],i.t7={ammunitiongroups:i.t3,combatskills:i.t4,domains:i.t5,breakPointRating:i.t6},(0,i.t1)(i.t2,i.t7),i.abrupt("return",o);case 20:case"end":return i.stop()}}),_callee32,this)}))),function getData(t){return o.apply(this,arguments)})}]),RangeweaponSheet}(R(G)),q=function(r){item_sheet_inherits(BlessingSheetDSA5,r);var a,o,i=item_sheet_createSuper(BlessingSheetDSA5);function BlessingSheetDSA5(){return item_sheet_classCallCheck(this,BlessingSheetDSA5),i.apply(this,arguments)}return item_sheet_createClass(BlessingSheetDSA5,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(BlessingSheetDSA5.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&a.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee33(t){return item_sheet_regeneratorRuntime().wrap((function _callee33$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setupEffect(t));case 1:case"end":return a.stop()}}),_callee33)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee34(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee34$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(BlessingSheetDSA5.prototype),"getData",this).call(this,t);case 2:if(r=a.sent,a.t0=game.user.isGM,a.t0){a.next=8;break}return a.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:a.t0=a.sent;case 8:return r.canOnUseEffect=a.t0,a.abrupt("return",r);case 10:case"end":return a.stop()}}),_callee34,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"setupEffect",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee35(r){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee35$(r){for(;;)switch(r.prev=r.next){case 0:if(!(this.item.actor.system.status.karmaenergy.value<1)){r.next=2;break}return r.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughKaP")));case 2:return a=game.dsa5.config.ItemSubclasses.magictrick,r.next=5,this.item.actor.update({"system.status.karmaenergy.value":this.item.actor.system.status.karmaenergy.value-=1});case 5:return o="<p><b>".concat(this.item.name," - ").concat(game.i18n.localize("blessing")," ").concat(game.i18n.localize("probe"),"</b></p><p>").concat(this.item.system.description.value,"</p><p>").concat(a.chatData(this.item.system,"").join("</br>"),"</p>"),r.next=8,ChatMessage.create(t.Z.chatDataSetup(o));case 8:case"end":return r.stop()}}),_callee35,this)}))),function setupEffect(t){return a.apply(this,arguments)})}]),BlessingSheetDSA5}(L),U=function(t){item_sheet_inherits(ItemCareerDSA5,t);var a,o=item_sheet_createSuper(ItemCareerDSA5);function ItemCareerDSA5(t,r){var a;return item_sheet_classCallCheck(this,ItemCareerDSA5),r.width=700,r.height=700,(a=o.call(this,t,r)).mce=null,a}return item_sheet_createClass(ItemCareerDSA5,[{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee36(t){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee36$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,item_sheet_get(item_sheet_getPrototypeOf(ItemCareerDSA5.prototype),"getData",this).call(this,t);case 2:return a=i.sent,(o=duplicate(r.Z.characteristics))["-"]="-",a.mageLevels=r.Z.mageLevels,a.guidevalues=o,i.next=9,TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:!0,async:!0});case 9:return a.enrichedClothing=i.sent,i.abrupt("return",a);case 11:case"end":return i.stop()}}),_callee36,this)}))),function getData(t){return a.apply(this,arguments)})}]),ItemCareerDSA5}(L),Y=function(t){item_sheet_inherits(ConsumableSheetDSA5,t);var a,o=item_sheet_createSuper(ConsumableSheetDSA5);function ConsumableSheetDSA5(t,r){var a;return item_sheet_classCallCheck(this,ConsumableSheetDSA5),r.width=480,(a=o.call(this,t,r)).mce=null,a}return item_sheet_createClass(ConsumableSheetDSA5,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(ConsumableSheetDSA5.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&a.unshift({class:"consumeItem",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee37(t){return item_sheet_regeneratorRuntime().wrap((function _callee37$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setupEffect(t));case 1:case"end":return a.stop()}}),_callee37)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee38(t){var a;return item_sheet_regeneratorRuntime().wrap((function _callee38$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(ConsumableSheetDSA5.prototype),"getData",this).call(this,t);case 2:return(a=o.sent).calculatedPrice=a.system.price.value*a.system.QL||0,a.availableSteps=a.system.QLList.split("\n").map((function(t,r){return r+1})),a.equipmentTypes=r.Z.equipmentTypes,o.next=8,TextEditor.enrichHTML(getProperty(this.item.system,"ingredients"),{secrets:!0,async:!0});case 8:return a.enrichedIngredients=o.sent,o.abrupt("return",a);case 10:case"end":return o.stop()}}),_callee38,this)}))),function getData(t){return a.apply(this,arguments)})},{key:"setupEffect",value:function setupEffect(t){this.item.setupEffect()}}]),ConsumableSheetDSA5}(L),V=function(t){item_sheet_inherits(ItemCultureDSA5,t);var r,a=item_sheet_createSuper(ItemCultureDSA5);function ItemCultureDSA5(t,r){var o;return item_sheet_classCallCheck(this,ItemCultureDSA5),r.width=700,r.height=700,(o=a.call(this,t,r)).mce=null,o}return item_sheet_createClass(ItemCultureDSA5,[{key:"getData",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee39(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee39$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(ItemCultureDSA5.prototype),"getData",this).call(this,t);case 2:return r=a.sent,a.next=5,TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:!0,async:!0});case 5:return r.enrichedClothing=a.sent,a.abrupt("return",r);case 7:case"end":return a.stop()}}),_callee39,this)}))),function getData(t){return r.apply(this,arguments)})}]),ItemCultureDSA5}(L),K=function(t){item_sheet_inherits(DiseaseSheetDSA5,t);var a,o=item_sheet_createSuper(DiseaseSheetDSA5);function DiseaseSheetDSA5(){return item_sheet_classCallCheck(this,DiseaseSheetDSA5),o.apply(this,arguments)}return item_sheet_createClass(DiseaseSheetDSA5,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(DiseaseSheetDSA5.prototype),"_getHeaderButtons",this).call(this);return a.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee40(t){return item_sheet_regeneratorRuntime().wrap((function _callee40$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setupEffect(t));case 1:case"end":return a.stop()}}),_callee40)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee41(t){var a;return item_sheet_regeneratorRuntime().wrap((function _callee41$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(DiseaseSheetDSA5.prototype),"getData",this).call(this,t);case 2:return(a=o.sent).resistances=r.Z.magicResistanceModifiers,o.abrupt("return",a);case 5:case"end":return o.stop()}}),_callee41,this)}))),function getData(t){return a.apply(this,arguments)})}]),DiseaseSheetDSA5}(L),J=function(r){item_sheet_inherits(MagictrickSheetDSA5,r);var a,o,i=item_sheet_createSuper(MagictrickSheetDSA5);function MagictrickSheetDSA5(){return item_sheet_classCallCheck(this,MagictrickSheetDSA5),i.apply(this,arguments)}return item_sheet_createClass(MagictrickSheetDSA5,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(MagictrickSheetDSA5.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&a.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee42(t){return item_sheet_regeneratorRuntime().wrap((function _callee42$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setupEffect(t));case 1:case"end":return a.stop()}}),_callee42)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee43(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee43$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(MagictrickSheetDSA5.prototype),"getData",this).call(this,t);case 2:if(r=a.sent,a.t0=game.user.isGM,a.t0){a.next=8;break}return a.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:a.t0=a.sent;case 8:return r.canOnUseEffect=a.t0,a.abrupt("return",r);case 10:case"end":return a.stop()}}),_callee43,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"setupEffect",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee44(r){var a,o;return item_sheet_regeneratorRuntime().wrap((function _callee44$(r){for(;;)switch(r.prev=r.next){case 0:if(!(this.item.actor.system.status.astralenergy.value<1)){r.next=2;break}return r.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP")));case 2:return a=game.dsa5.config.ItemSubclasses.magictrick,r.next=5,this.item.actor.update({"system.status.astralenergy.value":this.item.actor.system.status.astralenergy.value-=1});case 5:return o="<p><b>".concat(this.item.name," - ").concat(game.i18n.localize("magictrick")," ").concat(game.i18n.localize("probe"),"</b></p><p>").concat(this.item.system.description.value,"</p><p>").concat(a.chatData(this.item.system,"").join("</br>"),"</p>"),r.next=8,ChatMessage.create(t.Z.chatDataSetup(o));case 8:case"end":return r.stop()}}),_callee44,this)}))),function setupEffect(t){return a.apply(this,arguments)})}]),MagictrickSheetDSA5}(L),Q=function(a){item_sheet_inherits(MeleeweaponSheetDSA5,a);var o,i=item_sheet_createSuper(MeleeweaponSheetDSA5);function MeleeweaponSheetDSA5(t,r){var a;return item_sheet_classCallCheck(this,MeleeweaponSheetDSA5),(a=i.call(this,t,r)).mce=null,a.isPoisonable=!0,a}return item_sheet_createClass(MeleeweaponSheetDSA5,[{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee45(a){var o,i,c,u,l,p,d,h=this;return item_sheet_regeneratorRuntime().wrap((function _callee45$(m){for(;;)switch(m.prev=m.next){case 0:return m.next=2,item_sheet_get(item_sheet_getPrototypeOf(MeleeweaponSheetDSA5.prototype),"getData",this).call(this,a);case 2:if(o=m.sent,i=mergeObject(duplicate(r.Z.characteristics),item_sheet_defineProperty({"ge/kk":game.i18n.localize("CHAR.GEKK")},"-","-")),c=y.Z.regex2h.test(this.item.name),u="",c){m.next=10;break}u="wrongGrip.yieldTwo",m.next=18;break;case 10:l=game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value)),m.t0=l,m.next="Two-Handed Impact Weapons"===m.t0||"Two-Handed Swords"===m.t0?14:17;break;case 14:return p=new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")),u=p.test(this.item.name)?"wrongGrip.yieldOneBastard":"wrongGrip.yieldOneSwordBlunt",m.abrupt("break",18);case 17:u="wrongGrip.yieldOnePolearms";case 18:return m.t1=mergeObject,m.t2=o,m.t3=i,m.t4=c,m.t5=c?"wrongGrip.oneHanded":"wrongGrip.twoHanded",m.t6=u,m.next=26,t.Z.allCombatSkillsList("melee");case 26:if(m.t7=m.sent,m.t8=r.Z.meleeRanges,m.t9=r.Z.shieldSizes,m.t10=this.item.system.combatskill.value==game.i18n.localize("LocalizedIDs.Shields"),m.t11=this.prepareDomains(),m.t12=r.Z.weaponStabilities[game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value))],m.t13={characteristics:m.t3,twoHanded:m.t4,wrongGripLabel:m.t5,wrongGripHint:m.t6,combatskills:m.t7,ranges:m.t8,shieldSizes:m.t9,isShield:m.t10,domains:m.t11,breakPointRating:m.t12},(0,m.t1)(m.t2,m.t13),this.item.actor&&(d=this.item.actor.items.find((function(t){return"combatskill"==t.type&&t.name==h.item.system.combatskill.value})),o.canBeOffHand=d&&!d.system.weapontype.twoHanded&&this.item.system.worn.value,o.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value)))),m.t14=game.user.isGM,m.t14){m.next=40;break}return m.next=39,game.settings.get("dsa5","playerCanEditSpellMacro");case 39:m.t14=m.sent;case 40:return o.canOnUseEffect=m.t14,m.abrupt("return",o);case 42:case"end":return m.stop()}}),_callee45,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(MeleeweaponSheetDSA5.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&a.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee46(){return item_sheet_regeneratorRuntime().wrap((function _callee46$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",D.Z.breakingTest(r.item));case 1:case"end":return t.stop()}}),_callee46)}))),function onclick(){return t.apply(this,arguments)})}),a}}]),MeleeweaponSheetDSA5}(R(G)),X=function(t){item_sheet_inherits(PoisonSheetDSA5,t);var a,o=item_sheet_createSuper(PoisonSheetDSA5);function PoisonSheetDSA5(){return item_sheet_classCallCheck(this,PoisonSheetDSA5),o.apply(this,arguments)}return item_sheet_createClass(PoisonSheetDSA5,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=item_sheet_get(item_sheet_getPrototypeOf(PoisonSheetDSA5.prototype),"_getHeaderButtons",this).call(this);return a.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(t=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee47(t){return item_sheet_regeneratorRuntime().wrap((function _callee47$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setupEffect(t));case 1:case"end":return a.stop()}}),_callee47)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee48(t){var a;return item_sheet_regeneratorRuntime().wrap((function _callee48$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(PoisonSheetDSA5.prototype),"getData",this).call(this,t);case 2:return(a=o.sent).resistances=r.Z.magicResistanceModifiers,o.abrupt("return",a);case 5:case"end":return o.stop()}}),_callee48,this)}))),function getData(t){return a.apply(this,arguments)})}]),PoisonSheetDSA5}(L),ee=function(t){item_sheet_inherits(SpecialAbilitySheetDSA5,t);var a,o,c,u=item_sheet_createSuper(SpecialAbilitySheetDSA5);function SpecialAbilitySheetDSA5(){return item_sheet_classCallCheck(this,SpecialAbilitySheetDSA5),u.apply(this,arguments)}return item_sheet_createClass(SpecialAbilitySheetDSA5,[{key:"_refundStep",value:(c=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee49(){var t,r;return item_sheet_regeneratorRuntime().wrap((function _callee49$(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.item.system.step.value>1)){a.next=10;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(t){return Number(t.trim())})),t=r[this.item.system.step.value-1]),a.next=5,i.Z.refundFreelanguage(this.item,this.item.actor,t);case 5:return t=a.sent,a.next=8,this.item.actor._updateAPs(-1*t);case 8:return a.next=10,this.item.update({"system.step.value":this.item.system.step.value-1});case 10:case"end":return a.stop()}}),_callee49,this)}))),function _refundStep(){return c.apply(this,arguments)})},{key:"_advanceStep",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee50(){var t,r;return item_sheet_regeneratorRuntime().wrap((function _callee50$(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.item.system.step.value<this.item.system.maxRank.value)){a.next=13;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(t){return Number(t.trim())})),t=r[this.item.system.step.value]),a.next=5,i.Z.isFreeLanguage(this.item,this.item.actor,t);case 5:return t=a.sent,a.next=8,this.item.actor.checkEnoughXP(t);case 8:if(!a.sent){a.next=13;break}return a.next=11,this.item.actor._updateAPs(t);case 11:return a.next=13,this.item.update({"system.step.value":this.item.system.step.value+1});case 13:case"end":return a.stop()}}),_callee50,this)}))),function _advanceStep(){return o.apply(this,arguments)})},{key:"_advancable",value:function _advancable(){return this.item.system.maxRank.value>0}},{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee51(t){var a;return item_sheet_regeneratorRuntime().wrap((function _callee51$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,item_sheet_get(item_sheet_getPrototypeOf(SpecialAbilitySheetDSA5.prototype),"getData",this).call(this,t);case 2:if((a=o.sent).categories=r.Z.specialAbilityCategories,a.subCategories=r.Z.combatSkillSubCategories,a.traditionArtifacts=r.Z.traditionArtifacts,o.t0=game.user.isGM,o.t0){o.next=11;break}return o.next=10,game.settings.get("dsa5","playerCanEditSpellMacro");case 10:o.t0=o.sent;case 11:return a.canOnUseEffect=o.t0,o.abrupt("return",a);case 13:case"end":return o.stop()}}),_callee51,this)}))),function getData(t){return a.apply(this,arguments)})}]),SpecialAbilitySheetDSA5}(L),te=function(t){item_sheet_inherits(ItemSpeciesDSA5,t);var r,a=item_sheet_createSuper(ItemSpeciesDSA5);function ItemSpeciesDSA5(t,r){var o;return item_sheet_classCallCheck(this,ItemSpeciesDSA5),r.width=530,r.height=570,(o=a.call(this,t,r)).mce=null,o}return item_sheet_createClass(ItemSpeciesDSA5,[{key:"getData",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee52(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee52$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(ItemSpeciesDSA5.prototype),"getData",this).call(this,t);case 2:return(r=a.sent).hasLocalization=game.i18n.has("Racedescr.".concat(this.item.name)),a.abrupt("return",r);case 5:case"end":return a.stop()}}),_callee52,this)}))),function getData(t){return r.apply(this,arguments)})}]),ItemSpeciesDSA5}(L),re=function(t){item_sheet_inherits(SpellSheetDSA5,t);var a,o,i=item_sheet_createSuper(SpellSheetDSA5);function SpellSheetDSA5(){return item_sheet_classCallCheck(this,SpellSheetDSA5),i.apply(this,arguments)}return item_sheet_createClass(SpellSheetDSA5,[{key:"getData",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee53(t){var a,o=this;return item_sheet_regeneratorRuntime().wrap((function _callee53$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,item_sheet_get(item_sheet_getPrototypeOf(SpellSheetDSA5.prototype),"getData",this).call(this,t);case 2:return(a=i.sent).characteristics=r.Z.characteristics,a.StFs=r.Z.StFs,a.resistances=r.Z.magicResistanceModifiers,a.targetTypes=r.Z.areaTargetTypes,a.isOwned&&(a.extensions=this.item.actor.items.filter((function(t){return"spellextension"==t.type&&t.system.source==o.item.name&&o.item.type==t.system.category}))),i.abrupt("return",a);case 9:case"end":return i.stop()}}),_callee53,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;item_sheet_get(item_sheet_getPrototypeOf(SpellSheetDSA5.prototype),"activateListeners",this).call(this,t),t.find(".item-edit").click((function(t){t.preventDefault();var a=r._getItemId(t);r.item.actor.items.get(a).sheet.render(!0)})),t.find(".item-delete").click((function(t){r._deleteItem(t)}))}},{key:"_deleteItem",value:function _deleteItem(t){var r=this,a=this._getItemId(t),o=this.actor.items.find((function(t){return t.id==a})),i=game.i18n.format("DIALOG.DeleteItemDetail",{item:o.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:i}).then((function(o){new Dialog({title:game.i18n.localize("Delete Confirmation"),content:o,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(){r._cleverDeleteItem(a),$(t.currentTarget).closest(".item").remove()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}))}},{key:"_cleverDeleteItem",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee54(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee54$(a){for(;;)switch(a.prev=a.next){case 0:return r=this.item.actor.items.find((function(r){return r.id==t})),a.next=3,this.item.actor._updateAPs(-1*r.system.APValue.value);case 3:return a.next=5,this.item.actor.deleteEmbeddedDocuments("Item",[t]);case 5:case"end":return a.stop()}}),_callee54,this)}))),function _cleverDeleteItem(t){return a.apply(this,arguments)})}]),SpellSheetDSA5}(L),ne=function(t){item_sheet_inherits(SpellExtensionSheetDSA5,t);var r,a=item_sheet_createSuper(SpellExtensionSheetDSA5);function SpellExtensionSheetDSA5(){return item_sheet_classCallCheck(this,SpellExtensionSheetDSA5),a.apply(this,arguments)}return item_sheet_createClass(SpellExtensionSheetDSA5,[{key:"getData",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee55(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee55$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(SpellExtensionSheetDSA5.prototype),"getData",this).call(this,t);case 2:return r=a.sent,mergeObject(r,{categories:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}),a.abrupt("return",r);case 5:case"end":return a.stop()}}),_callee55,this)}))),function getData(t){return r.apply(this,arguments)})}]),SpellExtensionSheetDSA5}(L),ae=function(t){item_sheet_inherits(VantageSheetDSA5,t);var r,a,o,i=item_sheet_createSuper(VantageSheetDSA5);function VantageSheetDSA5(){return item_sheet_classCallCheck(this,VantageSheetDSA5),i.apply(this,arguments)}return item_sheet_createClass(VantageSheetDSA5,[{key:"_advancable",value:function _advancable(){return this.item.system.max.value>0}},{key:"_refundStep",value:(o=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee56(){var t,r;return item_sheet_regeneratorRuntime().wrap((function _callee56$(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.item.system.step.value>1)){a.next=7;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(t){return Number(t.trim())})),t=r[this.item.system.step.value-1]),a.next=5,this.item.actor._updateAPs(-1*t);case 5:return a.next=7,this.item.update({"system.step.value":this.item.system.step.value-1});case 7:case"end":return a.stop()}}),_callee56,this)}))),function _refundStep(){return o.apply(this,arguments)})},{key:"getData",value:(a=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee57(t){var r;return item_sheet_regeneratorRuntime().wrap((function _callee57$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,item_sheet_get(item_sheet_getPrototypeOf(VantageSheetDSA5.prototype),"getData",this).call(this,t);case 2:if(r=a.sent,a.t0=game.user.isGM,a.t0){a.next=8;break}return a.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:a.t0=a.sent;case 8:return r.canOnUseEffect=a.t0,a.abrupt("return",r);case 10:case"end":return a.stop()}}),_callee57,this)}))),function getData(t){return a.apply(this,arguments)})},{key:"_advanceStep",value:(r=item_sheet_asyncToGenerator(item_sheet_regeneratorRuntime().mark((function _callee58(){var t,r;return item_sheet_regeneratorRuntime().wrap((function _callee58$(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.item.system.step.value<this.item.system.max.value)){a.next=10;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(t){return Number(t.trim())})),t=r[this.item.system.step.value]),a.next=5,this.item.actor.checkEnoughXP(t);case 5:if(!a.sent){a.next=10;break}return a.next=8,this.item.actor._updateAPs(t);case 8:return a.next=10,this.item.update({"system.step.value":this.item.system.step.value+1});case 10:case"end":return a.stop()}}),_callee58,this)}))),function _advanceStep(){return r.apply(this,arguments)})}]),VantageSheetDSA5}(L),oe={"":"Modifier",defenseMalus:"MODS.defenseMalus",FW:"MODS.FW",KaPCost:"CHAR.AsPCost",AsPCost:"CHAR.KapCost",FP:"MODS.FP",QL:"MODS.QS",dmg:"MODS.damage",damageBonus:"MODS.damage",armorPen:"MODS.armorPen",TPM:"MODS.partChecks"};function dicesonice_typeof(t){return dicesonice_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dicesonice_typeof(t)}function dicesonice_regeneratorRuntime(){dicesonice_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==dicesonice_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function dicesonice_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function dicesonice_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){dicesonice_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){dicesonice_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function dicesonice_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=dicesonice_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function dicesonice_slicedToArray(t,r){return function dicesonice_arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function dicesonice_iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||dicesonice_unsupportedIterableToArray(t,r)||function dicesonice_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function dicesonice_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return dicesonice_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?dicesonice_arrayLikeToArray(t,r):void 0}}function dicesonice_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function dicesonice_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function dicesonice_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function dicesonice_createClass(t,r,a){return r&&dicesonice_defineProperties(t.prototype,r),a&&dicesonice_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function dicesonice_get(){return dicesonice_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=dicesonice_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},dicesonice_get.apply(this,arguments)}function dicesonice_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=dicesonice_getPrototypeOf(t)););return t}function dicesonice_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&dicesonice_setPrototypeOf(t,r)}function dicesonice_setPrototypeOf(t,r){return dicesonice_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},dicesonice_setPrototypeOf(t,r)}function dicesonice_createSuper(t){var r=function dicesonice_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=dicesonice_getPrototypeOf(t);if(r){var i=dicesonice_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return dicesonice_possibleConstructorReturn(this,a)}}function dicesonice_possibleConstructorReturn(t,r){if(r&&("object"===dicesonice_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function dicesonice_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function dicesonice_getPrototypeOf(t){return dicesonice_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},dicesonice_getPrototypeOf(t)}var ie=function(r){dicesonice_inherits(DiceSoNiceCustomization,Application);var a,o,i=dicesonice_createSuper(DiceSoNiceCustomization);function DiceSoNiceCustomization(){return dicesonice_classCallCheck(this,DiceSoNiceCustomization),i.apply(this,arguments)}return dicesonice_createClass(DiceSoNiceCustomization,[{key:"initConfigs",value:function initConfigs(){var t=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(var r=0,a=Object.entries(t);r<a.length;r++){var o=dicesonice_slicedToArray(a[r],2),i=(o[0],o[1]);mergeObject(this.choices,i)}var c={damage:"black"};game.settings.registerMenu("dsa5","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("DSASETTINGS.dicesonicesettings"),type:ce,restricted:!1});var u,l=dicesonice_createForOfIteratorHelper(DiceSoNiceCustomization.attrs);try{for(l.s();!(u=l.n()).done;){var p=u.value;game.settings.register("dsa5","dice3d_".concat(p),{name:"CHAR.".concat(p.toUpperCase()),scope:"client",config:!1,default:c[p]||p,type:String}),game.settings.register("dsa5","dice3d_system_".concat(p),{name:"CHAR.".concat(p.toUpperCase()),scope:"client",config:!1,default:"standard",type:String})}}catch(t){l.e(t)}finally{l.f()}}},{key:"getAttributeConfiguration",value:function getAttributeConfiguration(r){return t.Z.moduleEnabled("dice-so-nice")?{colorset:game.settings.get("dsa5","dice3d_".concat(r)),appearance:{colorset:game.settings.get("dsa5","dice3d_".concat(r)),system:game.settings.get("dsa5","dice3d_system_".concat(r))}}:{colorset:r}}},{key:"activateListeners",value:function activateListeners(t){dicesonice_get(dicesonice_getPrototypeOf(DiceSoNiceCustomization.prototype),"activateListeners",this).call(this),t.find('[name="entryselection"]').change(function(){var t=dicesonice_asyncToGenerator(dicesonice_regeneratorRuntime().mark((function _callee(t){return dicesonice_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,game.settings.set("dsa5","dice3d_".concat(t.currentTarget.dataset.attr),t.currentTarget.value);case 2:case"end":return r.stop()}}),_callee)})));return function(r){return t.apply(this,arguments)}}()),t.find('[name="systemselection"]').change(function(){var t=dicesonice_asyncToGenerator(dicesonice_regeneratorRuntime().mark((function _callee2(t){return dicesonice_regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,game.settings.set("dsa5","dice3d_system_".concat(t.currentTarget.dataset.attr),t.currentTarget.value);case 2:DiceSoNiceCustomization.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}});case 4:case"end":return r.stop()}}),_callee2)})));return function(r){return t.apply(this,arguments)}}())}},{key:"getData",value:(o=dicesonice_asyncToGenerator(dicesonice_regeneratorRuntime().mark((function _callee3(t){var r,a,o,i;return dicesonice_regeneratorRuntime().wrap((function _callee3$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,dicesonice_get(dicesonice_getPrototypeOf(DiceSoNiceCustomization.prototype),"getData",this).call(this,t);case 2:(r=c.sent).choices=this.choices,r.systems=game.dice3d.DiceFactory.systems,r.selections={},a=dicesonice_createForOfIteratorHelper(DiceSoNiceCustomization.attrs);try{for(a.s();!(o=a.n()).done;)i=o.value,r.selections[i]={color:game.settings.get("dsa5","dice3d_".concat(i)),system:game.settings.get("dsa5","dice3d_system_".concat(i))}}catch(t){a.e(t)}finally{a.f()}return c.abrupt("return",r);case 9:case"end":return c.stop()}}),_callee3,this)}))),function getData(t){return o.apply(this,arguments)})}],[{key:"onConnect",value:function onConnect(){game.socket.on("system.dsa5",(function(t){switch(t.type){case"preloadDice3d":console.warn("Preloading forced DSA dice assets"),DiceSoNiceCustomization.preloadDiceAssets(t.payload);break;case"getPreloadDice3d":DiceSoNiceCustomization.requestDicePreloads()}})),this.collectPreloads(),game.socket.emit("system.dsa5",{type:"getPreloadDice3d"})}},{key:"collectPreloads",value:function collectPreloads(){var t,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],a=new Set,o=dicesonice_createForOfIteratorHelper(DiceSoNiceCustomization.attrs);try{for(o.s();!(t=o.n()).done;){var i=t.value;a.add(game.settings.get("dsa5","dice3d_system_".concat(i)))}}catch(t){o.e(t)}finally{o.f()}a=Array.from(a),r&&this.preloadDiceAssets(a),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:a})}},{key:"requestDicePreloads",value:function requestDicePreloads(){this.collectPreloads(!1)}},{key:"preloadDiceAssets",value:(a=dicesonice_asyncToGenerator(dicesonice_regeneratorRuntime().mark((function _callee4(t){var r,a,o,i,c,u,l,p,d,h=arguments;return dicesonice_regeneratorRuntime().wrap((function _callee4$(m){for(;;)switch(m.prev=m.next){case 0:r=h.length>1&&void 0!==h[1]?h[1]:[],console.warn("loading",t),a=dicesonice_createForOfIteratorHelper(t),m.prev=3,a.s();case 5:if((o=a.n()).done){m.next=41;break}if(i=o.value,c=game.dice3d.DiceFactory.systems[i]){m.next=10;break}return m.abrupt("continue",39);case 10:u=c.dice.filter((function(t){return 0==r.length||r.includes(t.type)})),l=dicesonice_createForOfIteratorHelper(u),m.prev=12,l.s();case 14:if((p=l.n()).done){m.next=31;break}if(d=p.value,m.prev=16,!d.modelFile){m.next=22;break}return m.next=20,d.loadModel(game.dice3d.DiceFactory.loaderGLTF);case 20:m.next=24;break;case 22:return m.next=24,d.loadTextures();case 24:m.next=29;break;case 26:m.prev=26,m.t0=m.catch(16),console.warn("Unable to load dice model",i,d);case 29:m.next=14;break;case 31:m.next=36;break;case 33:m.prev=33,m.t1=m.catch(12),l.e(m.t1);case 36:return m.prev=36,l.f(),m.finish(36);case 39:m.next=5;break;case 41:m.next=46;break;case 43:m.prev=43,m.t2=m.catch(3),a.e(m.t2);case 46:return m.prev=46,a.f(),m.finish(46);case 49:case"end":return m.stop()}}),_callee4,null,[[3,43,46,49],[12,33,36,39],[16,26]])}))),function preloadDiceAssets(t){return a.apply(this,arguments)})},{key:"defaultOptions",get:function get(){var t=dicesonice_get(dicesonice_getPrototypeOf(DiceSoNiceCustomization),"defaultOptions",this);return mergeObject(t,{template:"systems/dsa5/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("DSASETTINGS.dicesonicesettings"),width:600}),t}}]),DiceSoNiceCustomization}();!function dicesonice_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}(ie,"attrs",["mu","kl","in","ch","ff","ge","ko","kk","attack","dodge","parry","damage"]);var ce=function(t){dicesonice_inherits(DiceSoNiceForm,FormApplication);var r=dicesonice_createSuper(DiceSoNiceForm);function DiceSoNiceForm(){return dicesonice_classCallCheck(this,DiceSoNiceForm),r.apply(this,arguments)}return dicesonice_createClass(DiceSoNiceForm,[{key:"render",value:function render(){game.dsa5.apps.DiceSoNiceCustomization.render(!0)}}]),DiceSoNiceForm}(),se=__webpack_require__(61);function actor_typeof(t){return actor_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},actor_typeof(t)}function actor_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function actor_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function actor_setPrototypeOf(t,r){return actor_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},actor_setPrototypeOf(t,r)}function actor_createSuper(t){var r=function actor_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=actor_getPrototypeOf(t);if(r){var i=actor_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return actor_possibleConstructorReturn(this,a)}}function actor_possibleConstructorReturn(t,r){if(r&&("object"===actor_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function actor_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function actor_getPrototypeOf(t){return actor_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},actor_getPrototypeOf(t)}function actor_regeneratorRuntime(){actor_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==actor_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function actor_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function actor_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){actor_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){actor_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}var ue=function(t){!function actor_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&actor_setPrototypeOf(t,r)}(AskForNameDialog,Dialog);var r,a=actor_createSuper(AskForNameDialog);function AskForNameDialog(){return actor_classCallCheck(this,AskForNameDialog),a.apply(this,arguments)}return function actor_createClass(t,r,a){return r&&actor_defineProperties(t.prototype,r),a&&actor_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(AskForNameDialog,null,[{key:"getDialog",value:(r=actor_asyncToGenerator(actor_regeneratorRuntime().mark((function _callee5(t,r){return actor_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:new Dialog({title:game.i18n.localize("DSASETTINGS.obfuscateTokenNames"),content:'<label for="name">'.concat(game.i18n.localize("DSASETTINGS.rename"),'</label> <input dtype="string" name="name" type="text" value="').concat(t.actor.name,'"/>'),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){var a=actor_asyncToGenerator(actor_regeneratorRuntime().mark((function _callee4(a){var o,i,c,u;return actor_regeneratorRuntime().wrap((function _callee4$(l){for(;;)switch(l.prev=l.next){case 0:return o=t.id||t._id,i=a.find('[name="name"]').val(),2==r&&(c=canvas.scene.tokens.filter((function(t){return t.name===i}))).length>0&&(i="".concat(i.replace(/ \d{1,}$/)," ").concat(c.length+1)),u=canvas.scene.tokens.get(o),l.next=6,u.update({name:i});case 6:case"end":return l.stop()}}),_callee4)})));return function callback(t){return a.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 1:case"end":return a.stop()}}),_callee5)}))),function getDialog(t,a){return r.apply(this,arguments)})}]),AskForNameDialog}();function createHotBarMacro(t,r,a,o){var i=game.macros.contents.find((function(a){return a.name===r&&a.command===t}));return i?game.user.assignHotbarMacro(i,o):Macro.create({name:r,type:"script",img:a,command:t},{displaySheet:!1}).then((function(t){return game.user.assignHotbarMacro(t,o)})),!1}var le=__webpack_require__(600);function payment_typeof(t){return payment_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},payment_typeof(t)}function payment_regeneratorRuntime(){payment_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==payment_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function payment_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function payment_slicedToArray(t,r){return function payment_arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function payment_iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||payment_unsupportedIterableToArray(t,r)||function payment_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function payment_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function payment_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return payment_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?payment_arrayLikeToArray(t,r):void 0}}function payment_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function payment_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var fe=function(){function DSA5Payment(){!function payment_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSA5Payment)}var r;return function payment_createClass(t,r,a){return r&&payment_defineProperties(t.prototype,r),a&&payment_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5Payment,null,[{key:"payMoney",value:function payMoney(r,a){var o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=DSA5Payment.canPay(r,a,o);return i.success&&DSA5Payment._updateMoney(r,i.actorsMoney.money,i.actorsMoney.sum-i.money),o||""==i.msg||ChatMessage.create(t.Z.chatDataSetup("<p>".concat(i.msg,"</p>"),"roll")),i.success}},{key:"canPay",value:function canPay(t,r,a){var o=this._getPaymoney(r),i={success:!1,msg:"",money:o};return o&&(i.actorsMoney=this._actorsMoney(t),i.actorsMoney.sum>=o?(i.msg=game.i18n.format("PAYMENT.pay",{actor:t.name,amount:DSA5Payment._moneyToString(o)}),i.success=!0):(i.msg=game.i18n.format("PAYMENT.cannotpay",{actor:t.name,amount:DSA5Payment._moneyToString(o)}),a&&ui.notifications.notify(i.msg))),i}},{key:"getMoney",value:function getMoney(r,a){var o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this._getPaidmoney(a);if(i){var c=this._actorsMoney(r);DSA5Payment._updateMoney(r,c.money,c.sum+i);var u="<p>".concat(game.i18n.format("PAYMENT.getPaid",{actor:r.name,amount:DSA5Payment._moneyToString(i)}),"</p>");return o||ChatMessage.create(t.Z.chatDataSetup(u,"roll")),!0}}},{key:"_updateMoney",value:function _updateMoney(t,r,a){var o,i=DSA5Payment._moneyToCoins(a),c=function payment_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=payment_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}(r);try{for(c.s();!(o=c.n()).done;){var u=o.value;switch(u.name){case"Money-D":u.system.quantity.value=i.D;break;case"Money-S":u.system.quantity.value=i.S;break;case"Money-H":u.system.quantity.value=i.H;break;case"Money-K":u.system.quantity.value=i.K}}}catch(t){c.e(t)}finally{c.f()}t.updateEmbeddedDocuments("Item",r)}},{key:"createGetPaidChatMessage",value:function createGetPaidChatMessage(r){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,o=this._getPaidmoney(r);if(o){var i=a?" (".concat(a,")"):"",c="<p><b>".concat(game.i18n.localize("PAYMENT.wage"),"</b></p><p>").concat(game.i18n.format("PAYMENT.getPaidSum",{amount:DSA5Payment._moneyToString(o)})).concat(i,'</p><button class="payButton" data-pay="1" data-amount="').concat(o,'">').concat(game.i18n.localize("PAYMENT.getPaidButton"),"</button>");ChatMessage.create(t.Z.chatDataSetup(c,"roll"))}}},{key:"createPayChatMessage",value:function createPayChatMessage(r){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,o=this._getPaymoney(r);if(o){var i=a?" (".concat(a,")"):"",c="<p><b>".concat(game.i18n.localize("PAYMENT.bill"),"</b></p>").concat(game.i18n.format("PAYMENT.paySum",{amount:DSA5Payment._moneyToString(o)})).concat(i,'</p><button class="payButton" data-pay="0" data-amount="').concat(o,'">').concat(game.i18n.localize("PAYMENT.payButton"),"</button>");ChatMessage.create(t.Z.chatDataSetup(c,"roll"))}}},{key:"_getPaidmoney",value:function _getPaidmoney(r){var a=this._parseMoneyString(r);if(!a){var o="<p><b>".concat(game.i18n.localize("PAYMENT.error"),"</b></p><p><i>").concat(game.i18n.localize("PAYMENT.getPaidexample"),"</i></p>");return ChatMessage.create(t.Z.chatDataSetup(o,"roll")),!1}return a}},{key:"_getPaymoney",value:function _getPaymoney(r){var a=this._parseMoneyString(r);if(!a){var o="<p><b>".concat(game.i18n.localize("PAYMENT.error"),"</b></p><p><i>").concat(game.i18n.localize("PAYMENT.payexample"),"</i></p>");return ChatMessage.create(t.Z.chatDataSetup(o,"roll")),!1}return a}},{key:"_parseMoneyString",value:function _parseMoneyString(t){var r=t.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return!!r&&Number(r[0])}},{key:"_actorsMoney",value:function _actorsMoney(t){var r=duplicate(t.items.filter((function(t){return"money"==t.type})));return{money:r,sum:r.reduce((function(t,r){return t+Number(r.system.quantity.value)*Number(r.system.price.value)}),0)}}},{key:"handlePayAction",value:function handlePayAction(t,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;if(!game.user.isGM||o){o?m.Z.playMoneySound(!0):o=game.user.character;var i=!1;o&&r?i=DSA5Payment.payMoney(o,a):o&&!r?i=DSA5Payment.getMoney(o,a):ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors")),i&&t&&(t.fadeOut(),game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:t.closest(".message").attr("data-message-id"),updateData:payment_defineProperty({},"flags.dsa5.userHidden.".concat(game.user.id),!0)}}))}else ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors"))}},{key:"_moneyToCoins",value:function _moneyToCoins(t){var r=Math.round(100*t),a=Math.floor(r/1e3),o=Math.floor((r-1e3*a)/100),i=Math.floor((r-1e3*a-100*o)/10);return{D:a,S:o,H:i,K:Math.round(r-1e3*a-100*o-10*i)}}},{key:"_moneyToString",value:function _moneyToString(t){for(var r=DSA5Payment._moneyToCoins(t),a=[],o=0,i=Object.entries(r);o<i.length;o++){var c=payment_slicedToArray(i[o],2),u=c[0],l=c[1];l>0&&a.push('<span class="nobr">'.concat(l,' <span data-tooltip="').concat(game.i18n.localize("Money-".concat(u)),'" class="chatmoney money-').concat(u,'"></span></span>'))}return a.join(", ")}},{key:"chatListeners",value:(r=function payment_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){payment_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){payment_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(payment_regeneratorRuntime().mark((function _callee(t){return payment_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:t.on("click",".payButton",(function(t){var r=$(t.currentTarget);DSA5Payment.handlePayAction(r,1!=Number(r.attr("data-pay")),r.attr("data-amount")),m.Z.playMoneySound()}));case 1:case"end":return r.stop()}}),_callee)}))),function chatListeners(t){return r.apply(this,arguments)})}]),DSA5Payment}(),pe=__webpack_require__(118);function tutorial_typeof(t){return tutorial_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tutorial_typeof(t)}function tutorial_regeneratorRuntime(){tutorial_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==tutorial_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function tutorial_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function tutorial_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){tutorial_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){tutorial_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function tutorial_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var de=function(){function DSA5Tutorial(){!function tutorial_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DSA5Tutorial)}var r,a,o;return function tutorial_createClass(t,r,a){return r&&tutorial_defineProperties(t.prototype,r),a&&tutorial_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5Tutorial,null,[{key:"firstTimeMessage",value:(o=tutorial_asyncToGenerator(tutorial_regeneratorRuntime().mark((function _callee(){var r;return tutorial_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,game.settings.get("dsa5","firstTimeStart");case 2:if(a.sent){a.next=10;break}return a.next=5,DSA5Tutorial.setupDefaultOptions();case 5:return r=game.i18n.localize("WELCOME"),ChatMessage.create(t.Z.chatDataSetup(r)),DSA5Tutorial.firstTimeLanguage(),a.next=10,game.settings.set("dsa5","firstTimeStart",!0);case 10:case"end":return a.stop()}}),_callee)}))),function firstTimeMessage(){return o.apply(this,arguments)})},{key:"firstTimeLanguage",value:function firstTimeLanguage(){for(var t={title:game.i18n.localize("DIALOG.firstTime"),content:game.i18n.localize("DIALOG.firstTimeWarning"),default:"de",buttons:{}},r=function _loop(){var r=o[a];t.buttons[r]={label:game.i18n.localize(r),callback:function callback(){return DSA5Tutorial.setLanguage(r)}}},a=0,o=["de","en"];a<o.length;a++)r();new Dialog(t).render(!0)}},{key:"setLanguage",value:(a=tutorial_asyncToGenerator(tutorial_regeneratorRuntime().mark((function _callee2(t){return tutorial_regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,game.settings.set("dsa5","firstTimeStart",!0);case 2:return r.next=4,game.settings.set("dsa5","forceLanguage",t);case 4:return r.next=6,game.settings.set("core","language",t);case 6:foundry.utils.debouncedReload();case 7:case"end":return r.stop()}}),_callee2)}))),function setLanguage(t){return a.apply(this,arguments)})},{key:"setupDefaultOptions",value:(r=tutorial_asyncToGenerator(tutorial_regeneratorRuntime().mark((function _callee3(){var t;return tutorial_regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return(t=game.settings.get("core",Combat.CONFIG_SETTING)).skipDefeated=!0,r.next=4,game.settings.set("core",Combat.CONFIG_SETTING,t);case 4:return r.next=6,game.settings.set("core","leftClickRelease",!0);case 6:case"end":return r.stop()}}),_callee3)}))),function setupDefaultOptions(){return r.apply(this,arguments)})}]),DSA5Tutorial}();function merchantmixin_slicedToArray(t,r){return function merchantmixin_arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function merchantmixin_iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||merchantmixin_unsupportedIterableToArray(t,r)||function merchantmixin_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function merchantmixin_typeof(t){return merchantmixin_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},merchantmixin_typeof(t)}function merchantmixin_toConsumableArray(t){return function merchantmixin_arrayWithoutHoles(t){if(Array.isArray(t))return merchantmixin_arrayLikeToArray(t)}(t)||function merchantmixin_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||merchantmixin_unsupportedIterableToArray(t)||function merchantmixin_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function merchantmixin_regeneratorRuntime(){merchantmixin_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==merchantmixin_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function merchantmixin_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=merchantmixin_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function merchantmixin_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return merchantmixin_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?merchantmixin_arrayLikeToArray(t,r):void 0}}function merchantmixin_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function merchantmixin_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function merchantmixin_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){merchantmixin_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){merchantmixin_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function merchantmixin_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function merchantmixin_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function merchantmixin_createClass(t,r,a){return r&&merchantmixin_defineProperties(t.prototype,r),a&&merchantmixin_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function merchantmixin_get(){return merchantmixin_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=merchantmixin_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},merchantmixin_get.apply(this,arguments)}function merchantmixin_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=merchantmixin_getPrototypeOf(t)););return t}function merchantmixin_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&merchantmixin_setPrototypeOf(t,r)}function merchantmixin_setPrototypeOf(t,r){return merchantmixin_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},merchantmixin_setPrototypeOf(t,r)}function merchantmixin_createSuper(t){var r=function merchantmixin_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=merchantmixin_getPrototypeOf(t);if(r){var i=merchantmixin_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return merchantmixin_possibleConstructorReturn(this,a)}}function merchantmixin_possibleConstructorReturn(t,r){if(r&&("object"===merchantmixin_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function merchantmixin_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function merchantmixin_getPrototypeOf(t){return merchantmixin_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},merchantmixin_getPrototypeOf(t)}var he=function MerchantSheetMixin(a){return function(a){merchantmixin_inherits(_class,a);var i,c,u,l,p,d,h,g,v,_,b,w,k,x,S,T,A,O,P,E,C,D,I=merchantmixin_createSuper(_class);function _class(){return merchantmixin_classCallCheck(this,_class),I.apply(this,arguments)}return merchantmixin_createClass(_class,[{key:"template",get:function get(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsa5/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsa5/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsa5/templates/actors/merchant/merchant-epic.html";default:return merchantmixin_get(merchantmixin_getPrototypeOf(_class.prototype),"template",this)}return this.constructor.merchantTemplate}},{key:"merchantSheetActivated",value:function merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}},{key:"allowMerchant",value:(D=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee(t,r){var a,o,i,c,u;return merchantmixin_regeneratorRuntime().wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:a=duplicate(this.actor.ownership),o=r?1:0,i=merchantmixin_createForOfIteratorHelper(t);try{for(i.s();!(c=i.n()).done;)u=c.value,a[u]=o}catch(t){i.e(t)}finally{i.f()}return l.next=6,this.actor.update({ownership:a},{diff:!1,recursive:!1,noHook:!0});case 6:case"end":return l.stop()}}),_callee,this)}))),function allowMerchant(t,r){return D.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;merchantmixin_get(merchantmixin_getPrototypeOf(_class.prototype),"activateListeners",this).call(this,t),t.find(".allowMerchant").click(function(){var t=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee2(t){var a,o;return merchantmixin_regeneratorRuntime().wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:return a=$(t.currentTarget).attr("data-user-id"),o=$(t.currentTarget).find("i"),i.next=4,r.allowMerchant([a],!o.hasClass("fa-check-circle"));case 4:o.toggleClass("fa-circle fa-check-circle");case 5:case"end":return i.stop()}}),_callee2)})));return function(r){return t.apply(this,arguments)}}()),t.find(".toggleAllAllowMerchant").click(function(){var t=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee3(t){var a,o;return merchantmixin_regeneratorRuntime().wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:return a=game.users.filter((function(t){return!t.isGM})).map((function(t){return t.id})),o="true"==t.currentTarget.dataset.lock,i.next=4,r.allowMerchant(a,o);case 4:r.render();case 5:case"end":return i.stop()}}),_callee3)})));return function(r){return t.apply(this,arguments)}}()),t.find(".lockTradeSection").click((function(t){return r.lockTradeSection(t)})),t.find(".item-tradeLock").click((function(t){return r.toggleTradeLock(t)})),t.find(".randomGoods").click((function(t){return r.randomGoods(t)})),t.find(".clearInventory").click((function(t){return r.clearInventory(t)})),t.find(".removeOtherTradeFriend").click((function(){return r.removeOtherTradeFriend()})),t.find(".choseTradefriend").click((function(){return r.choseTradefriend()})),t.find(".setCustomPrice").click((function(t){return $(t.currentTarget).addClass("edit")})),t.find(".customPriceTag").change(function(){var t=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee4(t){return merchantmixin_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r.setCustomPrice(t));case 1:case"end":return a.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()).blur((function(t){return $(t.currentTarget).closest(".setCustomPrice").removeClass("edit")})),t.find(".buy-item").click((function(t){r.advanceWrapper(t,"buyItem",t),m.Z.playMoneySound()})),t.find(".sell-item").click((function(t){r.advanceWrapper(t,"sellItem",t),m.Z.playMoneySound()})),t.find(".item-external-edit").click((function(t){t.preventDefault();var a=r._getItemId(t);r.getTradeFriend().items.get(a).sheet.render(!0)})),t.find(".changeAmountAllItems").mousedown((function(t){return r.changeAmountAllItems(t)})),t.find(".gearSearch").prop("disabled",!1)}},{key:"_canDragStart",value:function _canDragStart(t){return!this.merchantSheetActivated()&&this.isEditable}},{key:"toggleTradeLock",value:(C=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee5(t){var r,a;return merchantmixin_regeneratorRuntime().wrap((function _callee5$(o){for(;;)switch(o.prev=o.next){case 0:r=this._getItemId(t),a=this.actor.items.get(r),this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.tradeLocked":!a.system.tradeLocked}]);case 3:case"end":return o.stop()}}),_callee5,this)}))),function toggleTradeLock(t){return C.apply(this,arguments)})},{key:"setCustomPrice",value:(E=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee6(t){var r;return merchantmixin_regeneratorRuntime().wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return t.stopPropagation(),t.preventDefault(),r=this._getItemId(t),a.next=5,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"flags.dsa5.customPriceTag":Number(t.target.value)}]);case 5:case"end":return a.stop()}}),_callee6,this)}))),function setCustomPrice(t){return E.apply(this,arguments)})},{key:"removeOtherTradeFriend",value:function removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}},{key:"choseTradefriend",value:(P=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee7(){return merchantmixin_regeneratorRuntime().wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,me.getDialog(this);case 2:t.sent.render(!0);case 3:case"end":return t.stop()}}),_callee7,this)}))),function choseTradefriend(){return P.apply(this,arguments)})},{key:"lockTradeSection",value:(O=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee8(t){var r,a,o,i,c,u,l;return merchantmixin_regeneratorRuntime().wrap((function _callee8$(p){for(;;)switch(p.prev=p.next){case 0:r=[],a=this.filterRule(t),i=merchantmixin_createForOfIteratorHelper(this.actor.items);try{for(i.s();!(c=i.n()).done;)u=c.value,a(u)&&(l=u.toObject(),void 0===o&&(o=!l.system.tradeLocked),l.system.tradeLocked=o,r.push(l))}catch(t){i.e(t)}finally{i.f()}this.actor.updateEmbeddedDocuments("Item",r);case 5:case"end":return p.stop()}}),_callee8,this)}))),function lockTradeSection(t){return O.apply(this,arguments)})},{key:"filterRule",value:function filterRule(t){var a=t.currentTarget.dataset.type;return r.Z.equipmentTypes[a]?function(t){return"equipment"==t.type&&t.system.equipmentType.value==a}:function(t){return t.type==a&&r.Z.equipmentCategories.includes(t.type)}}},{key:"changeAmountAllItems",value:(A=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee9(t){var r,a,o,i,c,u;return merchantmixin_regeneratorRuntime().wrap((function _callee9$(l){for(;;)switch(l.prev=l.next){case 0:r=[],a=this.filterRule(t),o=merchantmixin_createForOfIteratorHelper(this.actor.items);try{for(o.s();!(i=o.n()).done;)c=i.value,a(c)&&(u=c.toObject(),y.Z.increment(t,u,"system.quantity.value",0),r.push(u))}catch(t){o.e(t)}finally{o.f()}this.actor.updateEmbeddedDocuments("Item",r);case 5:case"end":return l.stop()}}),_callee9,this)}))),function changeAmountAllItems(t){return A.apply(this,arguments)})},{key:"playerViewEnabled",value:function playerViewEnabled(){return getProperty(this.actor.system,"merchant.playerView")}},{key:"buyItem",value:(T=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee10(t){return merchantmixin_regeneratorRuntime().wrap((function _callee10$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.transferItem(this.actor,this.getTradeFriend(),t,!0);case 2:case"end":return r.stop()}}),_callee10,this)}))),function buyItem(t){return T.apply(this,arguments)})},{key:"sellItem",value:(S=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee11(t){return merchantmixin_regeneratorRuntime().wrap((function _callee11$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.transferItem(this.getTradeFriend(),this.actor,t,!1);case 2:case"end":return r.stop()}}),_callee11,this)}))),function sellItem(t){return S.apply(this,arguments)})},{key:"transferItem",value:(x=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee12(t,r,a){var o,i,c,u,l=arguments;return merchantmixin_regeneratorRuntime().wrap((function _callee12$(p){for(;;)switch(p.prev=p.next){case 0:if(o=!(l.length>3&&void 0!==l[3])||l[3],i=this._getItemId(a),c=$(a.currentTarget).attr("data-price"),u=a.ctrlKey?10:1,!game.user.isGM){p.next=9;break}return p.next=7,this.constructor.finishTransaction(t,r,c,i,o,u);case 7:p.next=10;break;case 9:(this.constructor.noNeedToPay(r,t,c)||fe.canPay(r,c,!0))&&game.socket.emit("system.dsa5",{type:"trade",payload:{target:this.constructor.transferTokenData(r),source:this.constructor.transferTokenData(t),price:c,itemId:i,buy:o,amount:u}});case 10:case"end":return p.stop()}}),_callee12,this)}))),function transferItem(t,r,a){return x.apply(this,arguments)})},{key:"getTradeFriend",value:function getTradeFriend(){return this.otherTradeFriend||game.user.character}},{key:"_manageDragItems",value:(k=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee13(t,r){return merchantmixin_regeneratorRuntime().wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:a.t0=r,a.next="creature"===a.t0||"npc"===a.t0||"character"===a.t0?3:5;break;case 3:return this.setTradeFriend(t),a.abrupt("break",6);case 5:return a.abrupt("return",merchantmixin_get(merchantmixin_getPrototypeOf(_class.prototype),"_manageDragItems",this).call(this,t,r));case 6:case"end":return a.stop()}}),_callee13,this)}))),function _manageDragItems(t,r){return k.apply(this,arguments)})},{key:"setTradeFriend",value:function setTradeFriend(t){var r=game.actors.get(t._id);r.isOwner&&(this.otherTradeFriend=r,this.render(!0))}},{key:"_render",value:(w=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee14(){var t,r,a=arguments;return merchantmixin_regeneratorRuntime().wrap((function _callee14$(o){for(;;)switch(o.prev=o.next){case 0:if(t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},game.user.isGM||"loot"!=getProperty(this.actor.system,"merchant.merchantType")||!getProperty(this.actor.system,"merchant.locked")){o.next=5;break}return AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1),o.abrupt("return");case 5:return o.next=7,merchantmixin_get(merchantmixin_getPrototypeOf(_class.prototype),"_render",this).call(this,t,r);case 7:case"end":return o.stop()}}),_callee14,this)}))),function _render(){return w.apply(this,arguments)})},{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=merchantmixin_get(merchantmixin_getPrototypeOf(_class.prototype),"_getHeaderButtons",this).call(this);return this.actor.isOwner&&a.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:(t=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee15(t){return merchantmixin_regeneratorRuntime().wrap((function _callee15$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",r._togglePlayerview(t));case 1:case"end":return a.stop()}}),_callee15)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"_togglePlayerview",value:function _togglePlayerview(t){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}},{key:"randomGoods",value:(b=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee16(t){var a,o=this;return merchantmixin_regeneratorRuntime().wrap((function _callee16$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,renderTemplate("systems/dsa5/templates/dialog/randomGoods-dialog.html",{categories:r.Z.equipmentCategories});case 2:a=i.sent,new Dialog({title:game.i18n.localize("MERCHANT.randomGoods"),content:a,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(r){return o.addRandomGoods(o.actor,r,t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 4:case"end":return i.stop()}}),_callee16)}))),function randomGoods(t){return b.apply(this,arguments)})},{key:"clearInventory",value:(_=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee17(t){var r=this;return merchantmixin_regeneratorRuntime().wrap((function _callee17$(a){for(;;)switch(a.prev=a.next){case 0:new Dialog({title:game.i18n.localize("MERCHANT.clearInventory"),content:game.i18n.localize("MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(){r.removeAllGoods(r.actor,t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 1:case"end":return a.stop()}}),_callee17)}))),function clearInventory(t){return _.apply(this,arguments)})},{key:"addRandomGoods",value:(v=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee18(t,r,a){var o,i,c,u,l,p,d,h;return merchantmixin_regeneratorRuntime().wrap((function _callee18$(m){for(;;)switch(m.prev=m.next){case 0:if(o=$(a.currentTarget).text(),$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>'),i=[],r.find('input[type="checkbox"]:checked').each((function(){var t=$(this).val();i.push({name:t,count:Number(r.find('input[name="each_'.concat(t,'"]')).val()),number:Number(r.find('input[name="number_'.concat(t,'"]')).val())})})),(c=game.dsa5.itemLibrary).equipmentBuild){m.next=8;break}return m.next=8,c.buildEquipmentIndex();case 8:u=[],l=merchantmixin_regeneratorRuntime().mark((function _loop(){var t,r,a;return merchantmixin_regeneratorRuntime().wrap((function _loop$(o){for(;;)switch(o.prev=o.next){case 0:return r=d[p],o.next=3,c.getRandomItems(r.name,r.number);case 3:a=o.sent.map((function(t){var a=t.toObject();return a.system.quantity.value=r.count,a})),(t=u).push.apply(t,merchantmixin_toConsumableArray(a));case 5:case"end":return o.stop()}}),_loop)})),p=0,d=i;case 11:if(!(p<d.length)){m.next=16;break}return m.delegateYield(l(),"t0",13);case 13:p++,m.next=11;break;case 16:return h={},u=u.filter((function(r){var a=getProperty(r,"system.effect");a="object"===merchantmixin_typeof(a)&&null!==a&&getProperty(a,"attributes")||"";var o=Number(getProperty(r,"system.price.value"))||0;if(""!=a||o>1e4)return!1;var i="".concat(r.type,"_").concat(r.name);return!h.hasOwnProperty(i)&&(h[i]=!0)&&0==t.items.filter((function(t){return t.type==r.type&&t.name==r.name})).length})),m.next=20,t.createEmbeddedDocuments("Item",u);case 20:$(a.currentTarget).text(o);case 21:case"end":return m.stop()}}),_callee18)}))),function addRandomGoods(t,r,a){return v.apply(this,arguments)})},{key:"removeAllGoods",value:(g=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee19(t,a){var o,i;return merchantmixin_regeneratorRuntime().wrap((function _callee19$(c){for(;;)switch(c.prev=c.next){case 0:return o=$(a.currentTarget).text(),$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>'),i=t.items.filter((function(t){return r.Z.equipmentCategories.includes(t.type)&&!getProperty(t,"worn.value")})).map((function(t){return t.id})),c.next=5,t.deleteEmbeddedDocuments("Item",i);case 5:$(a.currentTarget).text(o);case 6:case"end":return c.stop()}}),_callee19)}))),function removeAllGoods(t,r){return g.apply(this,arguments)})},{key:"getData",value:(h=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee20(t){var r,a=this;return merchantmixin_regeneratorRuntime().wrap((function _callee20$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,merchantmixin_get(merchantmixin_getPrototypeOf(_class.prototype),"getData",this).call(this,t);case 2:return(r=o.sent).merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",r.merchantTypes={none:game.i18n.localize("MERCHANT.typeNone"),merchant:game.i18n.localize("MERCHANT.typeMerchant"),loot:game.i18n.localize("MERCHANT.typeLoot"),epic:game.i18n.localize("MERCHANT.typeEpic")},r.invName=r.merchantTypes[r.merchantType],r.players=game.users.filter((function(t){return!t.isGM})).map((function(t){return t.allowedMerchant=a.actor.testUserPermission(t,"LIMITED",!1),t.buyingFactor=getProperty(a.actor.system,"merchant.factors.buyingFactor.".concat(t.id)),t.sellingFactor=getProperty(a.actor.system,"merchant.factors.sellingFactor.".concat(t.id)),t})),"epic"!=r.merchantType?(this.prepareStorage(r),this.merchantSheetActivated()&&(this.filterWornEquipment(r),this.prepareTradeFriend(r),0==r.actor.inventory.misc.items.length&&(r.actor.inventory.misc.show=!1))):(this.prepareStorage(r),r.garadanOptions={1:game.i18n.localize("GARADAN.1"),2:game.i18n.localize("GARADAN.2"),3:game.i18n.localize("GARADAN.3"),4:game.i18n.localize("GARADAN.4"),6:game.i18n.localize("GARADAN.6")}),r.hasOtherTradeFriend=!!this.otherTradeFriend,o.abrupt("return",r);case 10:case"end":return o.stop()}}),_callee20,this)}))),function getData(t){return h.apply(this,arguments)})},{key:"filterWornEquipment",value:function filterWornEquipment(t){for(var r=0,a=Object.entries(t.actor.inventory);r<a.length;r++){var o=merchantmixin_slicedToArray(a[r],2),i=(o[0],o[1]);i.items=i.items.filter((function(t){return!getProperty(t,"system.worn.value")}))}}},{key:"prepareStorage",value:function prepareStorage(t){if("merchant"==t.merchantType)for(var r=0,a=Object.entries(t.actor.inventory);r<a.length;r++){var o,i=merchantmixin_slicedToArray(a[r],2),c=(i[0],merchantmixin_createForOfIteratorHelper(i[1].items));try{for(c.s();!(o=c.n()).done;){var u=o.value;u.defaultPrice=this.getItemPrice(u),u.calculatedPrice=Number(parseFloat("".concat(u.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1))).toFixed(2))*(getProperty(this.actor.system,"merchant.factors.sellingFactor.".concat(game.user.id))||1),u.priceTag=" / ".concat(u.calculatedPrice)}}catch(t){c.e(t)}finally{c.f()}}else if("loot"==t.merchantType){for(var l=0,p=Object.entries(t.actor.inventory);l<p.length;l++){var d,h=merchantmixin_slicedToArray(p[l],2),m=(h[0],merchantmixin_createForOfIteratorHelper(h[1].items));try{for(m.s();!(d=m.n()).done;){var y=d.value;y.calculatedPrice=this.getItemPrice(y)}}catch(t){m.e(t)}finally{m.f()}}var g={items:t.actor.money.coins.map((function(t){return t.name=game.i18n.localize(t.name),t})),show:!0,dataType:"money"};g.items.length&&(t.actor.inventory.money=g)}}},{key:"getItemPrice",value:function getItemPrice(t){return Number(getProperty(t,"flags.dsa5.customPriceTag"))||Number(t.system.price.value)*("consumable"==t.type?Number(t.system.QL)||0:1)}},{key:"prepareTradeFriend",value:function prepareTradeFriend(t){var r=this.getTradeFriend();if(r){var a=r.prepareItems({details:[]}),o="loot"==getProperty(this.actor.system,"merchant.merchantType")?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,"merchant.factors.buyingFactor.".concat(game.user.id))||1),i=this.prepareSellPrices(a.inventory,o);0==i.misc.items.length&&(i.misc.show=!1),"loot"==t.merchantType&&(i.money={items:a.money.coins.map((function(t){return t.name=game.i18n.localize(t.name),t})),show:!0,dataType:"money"}),mergeObject(t,{tradeFriend:{img:r.img,name:r.name,inventory:i,money:a.money}})}else mergeObject(t,{tradeFriend:{inventory:[],money:{coins:[]}}})}},{key:"prepareSellPrices",value:function prepareSellPrices(t,r){for(var a=0,o=Object.entries(t);a<o.length;a++){var i,c=merchantmixin_slicedToArray(o[a],2),u=(c[0],merchantmixin_createForOfIteratorHelper(c[1].items));try{for(u.s();!(i=u.n()).done;){var l=i.value;l.calculatedPrice=Number(parseFloat("".concat(this.getItemPrice(l)*r)).toFixed(2))}}catch(t){u.e(t)}finally{u.f()}}return t}}],[{key:"defaultOptions",get:function get(){var t=merchantmixin_get(merchantmixin_getPrototypeOf(_class),"defaultOptions",this);return mergeObject(t,{classes:t.classes.concat(["merchant-sheet"])}),t}},{key:"merchantTemplate",get:function get(){return"systems/dsa5/templates/actors/merchant/merchant-sheet.html"}},{key:"transferTokenData",value:function transferTokenData(t){var r={actor:t.id};return t.token&&(r.token=t.token.id),r}},{key:"finishTransaction",value:(d=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee21(t,r,a,o,i,c){var u,l;return merchantmixin_regeneratorRuntime().wrap((function _callee21$(p){for(;;)switch(p.prev=p.next){case 0:if(u=t.items.get(o).toObject(),c=Math.min(Number(u.system.quantity.value),c),!(Number(u.system.quantity.value)>0)){p.next=24;break}if(!(l=this.noNeedToPay(r,t,a))&&!fe.payMoney(r,a,!0)){p.next=24;break}if(getProperty(u,"system.worn.value")&&(u.system.worn.value=!1),!i){p.next=18;break}return p.next=10,this.updateTargetTransaction(r,u,c,t,a);case 10:return p.next=12,this.updateSourceTransaction(t,r,u,a,o,c);case 12:return p.next=14,this.transferNotification(u,r,t,i,a,c,l);case 14:return p.next=16,this.selfDestruction(t);case 16:p.next=24;break;case 18:return p.next=20,this.updateSourceTransaction(t,r,u,a,o,c);case 20:return p.next=22,this.updateTargetTransaction(r,u,c,t,a);case 22:return p.next=24,this.transferNotification(u,t,r,i,a,c,l);case 24:case"end":return p.stop()}}),_callee21,this)}))),function finishTransaction(t,r,a,o,i,c){return d.apply(this,arguments)})},{key:"isTemporaryToken",value:function isTemporaryToken(t){return"loot"==getProperty(t.system,"merchant.merchantType")&&getProperty(t.system,"merchant.temporary")}},{key:"selfDestruction",value:(p=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee22(t){var a;return merchantmixin_regeneratorRuntime().wrap((function _callee22$(o){for(;;)switch(o.prev=o.next){case 0:if(!this.isTemporaryToken(t)){o.next=10;break}if(t.items.some((function(t){return r.Z.equipmentCategories.includes(t.type)||"money"==t.type&&t.system.quantity.value>0}))){o.next=10;break}return game.socket.emit("system.dsa5",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(t)}}),a=t.getActiveTokens().map((function(t){return t.id})),o.next=7,canvas.scene.deleteEmbeddedDocuments("Token",a);case 7:return o.next=9,game.actors.get(t.id).delete();case 9:this.hideDeletedSheet(t);case 10:case"end":return o.stop()}}),_callee22,this)}))),function selfDestruction(t){return p.apply(this,arguments)})},{key:"hideDeletedSheet",value:(l=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee23(t){return merchantmixin_regeneratorRuntime().wrap((function _callee23$(r){for(;;)switch(r.prev=r.next){case 0:t.sheet.close(!0);case 1:case"end":return r.stop()}}),_callee23)}))),function hideDeletedSheet(t){return l.apply(this,arguments)})},{key:"transferNotification",value:(u=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee24(r,a,o,i,c,u,l){var p,d,h,m;return merchantmixin_regeneratorRuntime().wrap((function _callee24$(y){for(;;)switch(y.prev=y.next){case 0:if(0!=(p=game.settings.get("dsa5","merchantNotification"))&&"service"!=getProperty(r,"system.equipmentType.value")){y.next=3;break}return y.abrupt("return");case 3:return d="MERCHANT."+(i?"buy":"sell")+(l?"Loot":"")+"Notification",h=game.i18n.format(d,{item:r.name,source:a.name,target:o.name,amount:u,price:c,buy:i}),m=t.Z.chatDataSetup(h),2==p&&(m.whisper=ChatMessage.getWhisperRecipients("GM").map((function(t){return t.id}))),y.next=9,ChatMessage.create(m);case 9:case"end":return y.stop()}}),_callee24)}))),function transferNotification(t,r,a,o,i,c,l){return u.apply(this,arguments)})},{key:"noNeedToPay",value:function noNeedToPay(t,r,a){return 0==a||"loot"==getProperty(t.system,"merchant.merchantType")||"loot"==getProperty(r.system,"merchant.merchantType")}},{key:"updateSourceTransaction",value:(c=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee25(t,r,a,o,i,c){var u;return merchantmixin_regeneratorRuntime().wrap((function _callee25$(l){for(;;)switch(l.prev=l.next){case 0:if(u=duplicate(a),!(Number(u.system.quantity.value)>c||"money"==u.type)){l.next=7;break}return u.system.quantity.value=Number(u.system.quantity.value)-c,l.next=5,t.updateEmbeddedDocuments("Item",[u]);case 5:l.next=9;break;case 7:return l.next=9,t.deleteEmbeddedDocuments("Item",[i]);case 9:if(this.noNeedToPay(t,r,o)){l.next=12;break}return l.next=12,fe.getMoney(t,o,!0);case 12:case"end":return l.stop()}}),_callee25,this)}))),function updateSourceTransaction(t,r,a,o,i,u){return c.apply(this,arguments)})},{key:"updateTargetTransaction",value:(i=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee26(r,a,i,c,u){var l,p,d;return merchantmixin_regeneratorRuntime().wrap((function _callee26$(h){for(;;)switch(h.prev=h.next){case 0:if(l=duplicate(a),"service"!=getProperty(l,"system.equipmentType.value")){h.next=7;break}p=game.i18n.format("MERCHANT.buyNotification",{item:l.name,amount:i,source:r.name,target:c.name,price:u}),ChatMessage.create(t.Z.chatDataSetup(p)),h.next=16;break;case 7:if(d=r.items.find((function(t){return o.Z.areEquals(l,t)})),l.system.quantity.value=i,d){h.next=14;break}return h.next=12,r.createEmbeddedDocuments("Item",[l]);case 12:h.next=16;break;case 14:return h.next=16,o.Z.stackItems(d,l,r);case 16:case"end":return h.stop()}}),_callee26)}))),function updateTargetTransaction(t,r,a,o,c){return i.apply(this,arguments)})}]),_class}(a)},me=function(t){merchantmixin_inherits(SelectTradefriendDialog,Dialog);var r,a=merchantmixin_createSuper(SelectTradefriendDialog);function SelectTradefriendDialog(){return merchantmixin_classCallCheck(this,SelectTradefriendDialog),a.apply(this,arguments)}return merchantmixin_createClass(SelectTradefriendDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;merchantmixin_get(merchantmixin_getPrototypeOf(SelectTradefriendDialog.prototype),"activateListeners",this).call(this,t),t.find(".combatant").click((function(t){return r.setTargetToUser(t)}))}},{key:"setTargetToUser",value:function setTargetToUser(t){this.actor.setTradeFriend({_id:t.currentTarget.dataset.id}),this.close()}}],[{key:"defaultOptions",get:function get(){var t=merchantmixin_get(merchantmixin_getPrototypeOf(SelectTradefriendDialog),"defaultOptions",this);return mergeObject(t,{}),t}},{key:"getDialog",value:(r=merchantmixin_asyncToGenerator(merchantmixin_regeneratorRuntime().mark((function _callee27(t){var r,a;return merchantmixin_regeneratorRuntime().wrap((function _callee27$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,game.dsa5.apps.gameMasterMenu.getTrackedHeros();case 2:return r=o.sent,o.t0=SelectTradefriendDialog,o.t1=game.i18n.localize("DIALOG.setTargetToUser"),o.next=7,renderTemplate("systems/dsa5/templates/dialog/selectTradeFriend.html",{users:r});case 7:return o.t2=o.sent,o.t3={},o.t4={title:o.t1,content:o.t2,default:"yes",buttons:o.t3},(a=new o.t0(o.t4)).actor=t,o.abrupt("return",a);case 13:case"end":return o.stop()}}),_callee27)}))),function getDialog(t){return r.apply(this,arguments)})}]),SelectTradefriendDialog}();function merchant_sheet_typeof(t){return merchant_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},merchant_sheet_typeof(t)}function merchant_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function merchant_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function merchant_sheet_setPrototypeOf(t,r){return merchant_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},merchant_sheet_setPrototypeOf(t,r)}function merchant_sheet_createSuper(t){var r=function merchant_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=merchant_sheet_getPrototypeOf(t);if(r){var i=merchant_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return merchant_sheet_possibleConstructorReturn(this,a)}}function merchant_sheet_possibleConstructorReturn(t,r){if(r&&("object"===merchant_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function merchant_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function merchant_sheet_getPrototypeOf(t){return merchant_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},merchant_sheet_getPrototypeOf(t)}var ye=function(t){!function merchant_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&merchant_sheet_setPrototypeOf(t,r)}(MerchantSheetDSA5,t);var r=merchant_sheet_createSuper(MerchantSheetDSA5);function MerchantSheetDSA5(){return merchant_sheet_classCallCheck(this,MerchantSheetDSA5),r.apply(this,arguments)}return function merchant_sheet_createClass(t,r,a){return r&&merchant_sheet_defineProperties(t.prototype,r),a&&merchant_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(MerchantSheetDSA5)}(he(C)),ge=__webpack_require__(538);function player_menu_subapps_typeof(t){return player_menu_subapps_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},player_menu_subapps_typeof(t)}function player_menu_subapps_regeneratorRuntime(){player_menu_subapps_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==player_menu_subapps_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function player_menu_subapps_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function player_menu_subapps_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){player_menu_subapps_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){player_menu_subapps_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function player_menu_subapps_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function player_menu_subapps_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function player_menu_subapps_createClass(t,r,a){return r&&player_menu_subapps_defineProperties(t.prototype,r),a&&player_menu_subapps_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function player_menu_subapps_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var ve=function(){function PlayerMenuSubApp(){player_menu_subapps_classCallCheck(this,PlayerMenuSubApp)}var t,r,a,o;return player_menu_subapps_createClass(PlayerMenuSubApp,[{key:"_getData",value:(o=player_menu_subapps_asyncToGenerator(player_menu_subapps_regeneratorRuntime().mark((function _callee(t){return player_menu_subapps_regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",{});case 1:case"end":return t.stop()}}),_callee)}))),function _getData(t){return o.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){}},{key:"_renderData",value:(a=player_menu_subapps_asyncToGenerator(player_menu_subapps_regeneratorRuntime().mark((function _callee2(t){var r,a;return player_menu_subapps_regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this._getData(t);case 2:return r=o.sent,mergeObject(r,t),o.next=6,renderTemplate(this.constructor.template,r);case 6:return a=o.sent,o.abrupt("return",a);case 8:case"end":return o.stop()}}),_callee2,this)}))),function _renderData(t){return a.apply(this,arguments)})},{key:"prepareApp",value:(r=player_menu_subapps_asyncToGenerator(player_menu_subapps_regeneratorRuntime().mark((function _callee3(t){return player_menu_subapps_regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=game.i18n.localize("PLAYER.".concat(this.constructor.name)),r.next=3,this._renderData(t);case 3:return r.t1=r.sent,r.abrupt("return",{name:r.t0,view:r.t1});case 5:case"end":return r.stop()}}),_callee3,this)}))),function prepareApp(t){return r.apply(this,arguments)})},{key:"render",value:(t=player_menu_subapps_asyncToGenerator(player_menu_subapps_regeneratorRuntime().mark((function _callee4(){return player_menu_subapps_regeneratorRuntime().wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,game.dsa5.apps.playerMenu.render(!0);case 2:case"end":return t.stop()}}),_callee4)}))),function render(){return t.apply(this,arguments)})},{key:"actor",get:function get(){return game.dsa5.apps.playerMenu.actor}}]),PlayerMenuSubApp}();player_menu_subapps_defineProperty(ve,"template",""),player_menu_subapps_defineProperty(ve,"rulePath",{});function player_menu_typeof(t){return player_menu_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},player_menu_typeof(t)}function player_menu_toConsumableArray(t){return function player_menu_arrayWithoutHoles(t){if(Array.isArray(t))return player_menu_arrayLikeToArray(t)}(t)||function player_menu_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||player_menu_unsupportedIterableToArray(t)||function player_menu_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function player_menu_regeneratorRuntime(){player_menu_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==player_menu_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function player_menu_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=player_menu_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function player_menu_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return player_menu_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?player_menu_arrayLikeToArray(t,r):void 0}}function player_menu_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function player_menu_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function player_menu_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){player_menu_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){player_menu_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function player_menu_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function player_menu_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function player_menu_createClass(t,r,a){return r&&player_menu_defineProperties(t.prototype,r),a&&player_menu_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function player_menu_get(){return player_menu_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=player_menu_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},player_menu_get.apply(this,arguments)}function player_menu_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=player_menu_getPrototypeOf(t)););return t}function player_menu_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&player_menu_setPrototypeOf(t,r)}function player_menu_setPrototypeOf(t,r){return player_menu_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},player_menu_setPrototypeOf(t,r)}function player_menu_createSuper(t){var r=function player_menu_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=player_menu_getPrototypeOf(t);if(r){var i=player_menu_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return player_menu_possibleConstructorReturn(this,a)}}function player_menu_possibleConstructorReturn(t,r){if(r&&("object"===player_menu_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function player_menu_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function player_menu_getPrototypeOf(t){return player_menu_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},player_menu_getPrototypeOf(t)}var _e=function(t){player_menu_inherits(PlayerMenu,Application);var r,a,o,i,c,u,l=player_menu_createSuper(PlayerMenu);function PlayerMenu(t){var r;return player_menu_classCallCheck(this,PlayerMenu),(r=l.call(this,t)).entityAbilities=[],game.dsa5.apps.PlayerMenuSubApp=ve,r.summoningModifiers=[{id:1,name:"CONJURATION.offensiveImprovement",descr:"CONJURATION.offensiveImprovementDescr",changes:[{key:"system.meleeStats.attack",mode:2,value:2},{key:"system.meleeStats.damage",mode:2,value:4},{key:"system.rangeStats.attack",mode:2,value:2},{key:"system.rangeStats.damage",mode:2,value:4}]},{id:2,name:"CONJURATION.defensiveImprovement",descr:"CONJURATION.defensiveImprovementDescr",changes:[{key:"system.meleeStats.parry",mode:2,value:2},{key:"system.totalArmor",mode:2,value:2},{key:"system.status.wounds.gearmodifier",mode:2,value:10}]},{id:3,name:"CONJURATION.speedImprovement",descr:"CONJURATION.speedImprovementDescr",changes:[{key:"system.status.speed.gearmodifier",mode:2,value:2},{key:"system.status.dodge.gearmodifier",mode:2,value:2}]},{id:4,name:"CONJURATION.magicalImprovement",descr:"CONJURATION.magicalImprovementDescr",changes:[],fun:y.Z.magicalImprovement},{id:5,name:"CONJURATION.resistanceImprovement",descr:"CONJURATION.resistanceImprovementDescr",changes:[{key:"system.status.soulpower.gearmodifier",mode:2,value:2},{key:"system.status.toughness.gearmodifier",mode:2,value:2}]},{id:6,name:"CONJURATION.mentalImprovement",descr:"CONJURATION.mentalImprovementDescr",changes:[{key:"system.characteristics.mu.gearmodifier",mode:2,value:2},{key:"system.characteristics.kl.gearmodifier",mode:2,value:2},{key:"system.characteristics.in.gearmodifier",mode:2,value:2},{key:"system.characteristics.ch.gearmodifier",mode:2,value:2}]},{id:7,name:"CONJURATION.physicalImprovement",descr:"CONJURATION.physicalImprovementDescr",changes:[{key:"system.characteristics.ff.gearmodifier",mode:2,value:2},{key:"system.characteristics.ge.gearmodifier",mode:2,value:2},{key:"system.characteristics.ko.gearmodifier",mode:2,value:2},{key:"system.characteristics.kk.gearmodifier",mode:2,value:2}]}],r.conjurationData={qs:0,consumedQS:0,packageModifier:0,selectedIds:[],selectedEntityIds:[],selectedPackageIds:[],conjurationTypes:{1:game.i18n.localize("CONJURATION.demon"),2:game.i18n.localize("CONJURATION.elemental")},rules:{1:{de:{pack:"dsa5-core.corerules",name:"Beschwrungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}},2:{de:{pack:"dsa5-core.corerules",name:"Beschwrungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}}},conjurationType:1,skills:{1:["invocatioMinima","invocatioMinor","invocatioMaior"].map((function(t){return game.i18n.localize("LocalizedIDs.".concat(t))})),2:["manifesto","elementalServant","callDjinn"].map((function(t){return game.i18n.localize("LocalizedIDs.".concat(t))}))},modifiers:{1:r.summoningModifiers,2:r.summoningModifiers},moreModifiers:{},postFunction:{}},r.subApps=[],r}return player_menu_createClass(PlayerMenu,[{key:"registerSubApp",value:function registerSubApp(t){this.subApps.push(t)}},{key:"rollConjuration",value:(u=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee2(t){var r,a,o,i,c,u,l,p=this;return player_menu_regeneratorRuntime().wrap((function _callee2$(d){for(;;)switch(d.prev=d.next){case 0:if(this.conjuration){d.next=2;break}return d.abrupt("return",ui.notifications.warn(game.i18n.localize("CONJURATION.dragConjuration")));case 2:if(r=$(t.currentTarget).closest(".item").attr("data-item-id"),a=this.actor.items.get(r),o=[{name:game.i18n.localize("conjuringDifficulty"),value:getProperty(this.conjuration,"system.conjuringDifficulty.value")||0,selected:!0}],this.conjurationData.packageModifier&&o.push({name:game.i18n.localize("summoningPackage"),value:this.conjurationData.packageModifier,selected:!0}),this.conjurationData.moreModifiers[this.conjurationData.conjurationType]){i=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].filter((function(t){return t.selected})),c=player_menu_createForOfIteratorHelper(i);try{for(c.s();!(u=c.n()).done;)l=u.value,o.push({name:l.name,value:Number(l.selected),selected:!0})}catch(t){c.e(t)}finally{c.f()}}this.actor.setupSkill(a,{moreModifiers:o,subtitle:" (".concat(this.conjuration.name,")")},void 0).then(function(){var t=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee(t){var r;return player_menu_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,p.actor.basicTest(t);case 2:r=a.sent,p.conjurationData.qs=r.result.qualityStep||0,p.render(!0);case 5:case"end":return a.stop()}}),_callee)})));return function(r){return t.apply(this,arguments)}}());case 8:case"end":return d.stop()}}),_callee2,this)}))),function rollConjuration(t){return u.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;player_menu_get(player_menu_getPrototypeOf(PlayerMenu.prototype),"activateListeners",this).call(this,t),t.find(".conjurationData").change((function(t){var a=$(t.currentTarget);setProperty(r.conjurationData,a.attr("name"),a.val()),a.attr("data-refresh")&&r.render()})),t.find(".skill-select").click((function(t){return r.rollConjuration(t)})),t.find(".initLibrary").click(function(){var t=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee3(t){return player_menu_regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return $(t.currentTarget).html('<i class="fas fa-spin fa-spinner"></i>'),a.next=3,game.dsa5.itemLibrary.buildEquipmentIndex();case 3:r.render();case 4:case"end":return a.stop()}}),_callee3)})));return function(r){return t.apply(this,arguments)}}()),t.find(".item-edit").click((function(t){var a=$(t.currentTarget).closest(".item").attr("data-item-id");r.actor.items.get(a).sheet.render(!0)})),t.find(".selectableRow").click((function(t){return r.selectImprovement(t)})),t.find(".finalizeConjuration").click((function(){return r.finalizeConjuration()})),t.find(".ruleLink").click((function(t){return r.openRules(t)})),t.find(".showEntity").click((function(t){t.stopPropagation();var r=function(){var r=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee4(){return player_menu_regeneratorRuntime().wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,fromUuid(t.currentTarget.dataset.uuid);case 2:r.sent.sheet.render(!0);case 3:case"end":return r.stop()}}),_callee4)})));return function fun(){return r.apply(this,arguments)}}();r()})),t.find(".moreModifiers").change((function(t){r.conjurationData.moreModifiers[r.conjurationData.conjurationType].find((function(r){return r.name==t.currentTarget.dataset.name})).selected=$(t.currentTarget).val()}));var a,o=player_menu_createForOfIteratorHelper(this.subApps);try{for(o.s();!(a=o.n()).done;){a.value.activateListeners(t)}}catch(t){o.e(t)}finally{o.f()}}},{key:"openRules",value:(c=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee6(t){var r,a,o;return player_menu_regeneratorRuntime().wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:r=t.currentTarget.dataset.subapp,a=(r?this.subApps.find((function(t){return t.constructor.name==r})).constructor.rulePath:this.conjurationData.rules[this.conjurationData.conjurationType])[game.i18n.lang],o=function(){var t=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee5(){var t,r,o,i;return player_menu_regeneratorRuntime().wrap((function _callee5$(c){for(;;)switch(c.prev=c.next){case 0:return t=game.packs.get(a.pack),c.next=3,t.getDocuments({name:a.name});case 3:r=c.sent,o=player_menu_createForOfIteratorHelper(r);try{for(o.s();!(i=o.n()).done;)i.value.sheet.render(!0)}catch(t){o.e(t)}finally{o.f()}case 6:case"end":return c.stop()}}),_callee5)})));return function fun(){return t.apply(this,arguments)}}(),o();case 4:case"end":return i.stop()}}),_callee6,this)}))),function openRules(t){return c.apply(this,arguments)})},{key:"finalizeConjuration",value:function finalizeConjuration(){var t=this;if(this.conjurationData){if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("DSAError.noConjurationActive"));var r={source:this.conjuration.toObject(),creationData:{type:this.conjurationData.conjurationType,typeName:this.conjurationData.conjurationTypes[this.conjurationData.conjurationType],qs:this.conjurationData.qs,consumedQS:this.conjurationData.consumedQS,modifiers:this.conjurationData.modifiers[this.conjurationData.conjurationType].filter((function(r){return t.conjurationData.selectedIds.includes(r.id)})),entityIds:this.conjurationData.selectedEntityIds,packageIds:this.conjurationData.selectedPackageIds},summoner:{name:this.actor.name,img:this.actor.img}};game.user.isGM?PlayerMenu.createConjuration(r):(game.socket.emit("system.dsa5",{type:"summonCreature",payload:r}),ui.notifications.notify(game.i18n.localize("CONJURATION.requestSend")))}}},{key:"selectImprovement",value:function selectImprovement(t){$(t.currentTarget).toggleClass("selected");var r=[],a=[],o=[],i=0,c=0;$(this._element).find(".selectableRow.selected").each((function(t,u){u.dataset.entityid?(a.push(u.dataset.id),i+=-1*(Number(u.dataset.qs)||0)):u.dataset.packageid?(o.push(u.dataset.id),c+=Number(u.dataset.mod)||0):r.push(Number(u.dataset.id))})),this.conjurationData.selectedIds=r,this.conjurationData.selectedEntityIds=a,this.conjurationData.selectedPackageIds=o,this.conjurationData.consumedQS=r.length+i,this.conjurationData.packageModifier=c,this.render()}},{key:"_canDragDrop",value:function _canDragDrop(t){return!0}},{key:"_onDrop",value:(i=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee7(t){var r,a,o,i,c;return player_menu_regeneratorRuntime().wrap((function _callee7$(u){for(;;)switch(u.prev=u.next){case 0:return u.prev=0,r=JSON.parse(t.dataTransfer.getData("text/plain")),u.next=4,Actor.implementation.fromDropData(r);case 4:r=u.sent,u.next=10;break;case 7:return u.prev=7,u.t0=u.catch(0),u.abrupt("return",!1);case 10:if("Actor"!=r.documentName){u.next=32;break}if(!("creature"==(a=game.actors.get(r.id)).type||$(t.target).closest(".summoningArea").length>0)){u.next=29;break}if(this.conjuration=a,this.conjurationData.selectedIds=[],this.conjurationData.selectedEntityIds=[],this.conjurationData.selectedPackageIds=[],"creature"!=a.type){u.next=27;break}o=0,i=Object.keys(this.conjurationData.conjurationTypes);case 19:if(!(o<i.length)){u.next=27;break}if(c=i[o],!a.system.creatureClass.value.includes(this.conjurationData.conjurationTypes[c])){u.next=24;break}return this.conjurationData.conjurationType=c,u.abrupt("break",27);case 24:o++,u.next=19;break;case 27:u.next=31;break;case 29:this.trackedId=r.id,this.actor=a;case 31:this.render(!0);case 32:case"end":return u.stop()}}),_callee7,this,[[0,7]])}))),function _onDrop(t){return i.apply(this,arguments)})},{key:"prepareEntityAbilities",value:(o=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee8(){var t,r,a,o,i,c,u,l;return player_menu_regeneratorRuntime().wrap((function _callee8$(p){for(;;)switch(p.prev=p.next){case 0:if(t={entityAbilities:[],entityPackages:[]},!game.dsa5.itemLibrary.equipmentBuild){p.next=14;break}return r=[game.i18n.localize("all"),this.conjurationData.conjurationTypes[this.conjurationData.conjurationType]],p.t0=Promise,p.next=6,game.dsa5.itemLibrary.getCategoryItems("trait",!1);case 6:return p.t1=p.sent.map((function(t){return t.getItem()})),p.next=9,p.t0.all.call(p.t0,p.t1);case 9:a=p.sent,o=new Set,i=new Set,c=player_menu_createForOfIteratorHelper(a);try{for(l=function _loop(){var a=u.value;a.system.distribution&&r.some((function(t){return a.system.distribution.includes(t)}))&&("entity"!=a.system.traitType.value||o.has(a.name)?"summoning"!=a.system.traitType.value||i.has(a.name)||(i.add(a.name),t.entityPackages.push(a)):(o.add(a.name),t.entityAbilities.push(a)))},c.s();!(u=c.n()).done;)l()}catch(t){c.e(t)}finally{c.f()}case 14:return p.abrupt("return",t);case 15:case"end":return p.stop()}}),_callee8,this)}))),function prepareEntityAbilities(){return o.apply(this,arguments)})},{key:"getData",value:(a=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee9(t){var r,a,o,i,c,u,l,p,d=this;return player_menu_regeneratorRuntime().wrap((function _callee9$(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,player_menu_get(player_menu_getPrototypeOf(PlayerMenu.prototype),"getData",this).call(this,t);case 2:if(r=h.sent,game.user.isGM||this.actor||(this.actor=game.user.character),!this.actor){h.next=17;break}return a=this.conjurationData.qs-this.conjurationData.consumedQS+1,o=game.dsa5.itemLibrary.equipmentBuild,h.next=9,this.prepareEntityAbilities();case 9:return i=h.sent,c=i.entityAbilities,u=i.entityPackages,h.next=14,renderTemplate("systems/dsa5/templates/system/conjuration/summoning.html",{actor:this.actor,conjuration:this.conjuration||{name:game.i18n.localize("CONJURATION.dragConjuration"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,services:a,conjurationModifiers:this.conjurationData.modifiers[this.conjurationData.conjurationType],equipmentIndexLoaded:o,entityAbilities:c,entityPackages:u,moreModifiers:this.conjurationData.moreModifiers[this.conjurationData.conjurationType]});case 14:l=h.sent,p=this.actor.items.filter((function(t){return d.conjurationData.skills[d.conjurationData.conjurationType].includes(t.name)&&["liturgy","ceremony","spell","ritual"].includes(t.type)})).map((function(t){return t.toObject()})),mergeObject(r,{conjurationSheet:l,conjurationskills:p});case 17:return mergeObject(r,{actor:this.actor||{name:game.i18n.localize("CONJURATION.dragActor"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,conjurationTypes:this.conjurationData.conjurationTypes}),h.next=20,this.prepareSubApps(r);case 20:return h.abrupt("return",r);case 21:case"end":return h.stop()}}),_callee9,this)}))),function getData(t){return a.apply(this,arguments)})},{key:"prepareSubApps",value:(r=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee10(t){var r,a,o;return player_menu_regeneratorRuntime().wrap((function _callee10$(i){for(;;)switch(i.prev=i.next){case 0:t.subApps=[],r=player_menu_createForOfIteratorHelper(this.subApps),i.prev=2,r.s();case 4:if((a=r.n()).done){i.next=13;break}return o=a.value,i.t0=t.subApps,i.next=9,o.prepareApp(t);case 9:i.t1=i.sent,i.t0.push.call(i.t0,i.t1);case 11:i.next=4;break;case 13:i.next=18;break;case 15:i.prev=15,i.t2=i.catch(2),r.e(i.t2);case 18:return i.prev=18,r.f(),i.finish(18);case 21:case"end":return i.stop()}}),_callee10,this,[[2,15,18,21]])}))),function prepareSubApps(t){return r.apply(this,arguments)})}],[{key:"createConjuration",value:function createConjuration(t){var r=t.source,a=t.creationData,o=t.summoner;new be(r,o,a).render(!0)}},{key:"defaultOptions",get:function get(){var t=player_menu_get(player_menu_getPrototypeOf(PlayerMenu),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"summoning"}],mergeObject(t,{classes:t.classes.concat(["dsa5","largeDialog","playerMenu"]),width:500,height:740,title:game.i18n.localize("PLAYER.title"),dragDrop:[{dragSelector:null,dropSelector:null}]}),t.template="systems/dsa5/templates/system/playermenu.html",t.resizable=!0,t}}]),PlayerMenu}(),be=function(r){player_menu_inherits(ConjurationRequest,r);var a,o,i=player_menu_createSuper(ConjurationRequest);function ConjurationRequest(t,r,a){var o;return player_menu_classCallCheck(this,ConjurationRequest),(o=i.call(this,{title:"".concat(game.i18n.localize("CONJURATION.request")," (").concat(r.name,")"),default:"ok",buttons:{}})).conjuration=t,o.summoner=r,o.creationData=a,o.confirmed=!1,o}return player_menu_createClass(ConjurationRequest,[{key:"getData",value:(o=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee11(t){var r;return player_menu_regeneratorRuntime().wrap((function _callee11$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,player_menu_get(player_menu_getPrototypeOf(ConjurationRequest.prototype),"getData",this).call(this,t);case 2:return r=a.sent,a.t0=mergeObject,a.t1=r,a.t2=this.conjuration,a.t3=this.summoner,a.t4=this.confirmed,a.t5=this.creationData.qs-this.creationData.consumedQS+1,a.t6=this.creationData,a.t7=this.creationData.modifiers,a.next=13,Promise.all(this.creationData.entityIds.map((function(t){return fromUuid(t)})));case 13:return a.t8=a.sent,a.next=16,Promise.all(this.creationData.packageIds.map((function(t){return fromUuid(t)})));case 16:return a.t9=a.sent,a.t10=this.actor,a.t11={conjuration:a.t2,summoner:a.t3,confirmed:a.t4,services:a.t5,creationData:a.t6,conjurationModifiers:a.t7,entityModifiers:a.t8,packageModifiers:a.t9,actor:a.t10},(0,a.t0)(a.t1,a.t11),a.abrupt("return",r);case 21:case"end":return a.stop()}}),_callee11,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"createActor",value:(a=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee12(){var r,a,o,i,c,u,l,p,h,m,y,g,v,_,b,w,k=this;return player_menu_regeneratorRuntime().wrap((function _callee12$(x){for(;;)switch(x.prev=x.next){case 0:return this.confirmed=!0,x.next=3,t.Z.getFolderForType("Actor",null,game.i18n.localize("PLAYER.conjuration"));case 3:return r=x.sent,x.next=6,t.Z.getFolderForType("Actor",r.id,this.creationData.typeName);case 6:a=x.sent,o=this.creationData.qs-this.creationData.consumedQS+1,this.conjuration.folder=a.id,this.conjuration.effects||(this.conjuration.effects=[]),i=player_menu_createForOfIteratorHelper(this.creationData.modifiers);try{for(i.s();!(c=i.n()).done;)u=c.value,this.conjuration.effects.push({changes:u.changes,duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize(u.name),flags:{dsa5:{value:null,editable:!0,description:"".concat(game.i18n.localize("PLAYER.conjuration")," ").concat(game.i18n.localize("extensions")),custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}}}),u.fun&&u.fun(this.conjuration,this.creationData)}catch(t){i.e(t)}finally{i.f()}return x.next=14,Promise.all(this.creationData.entityIds.map((function(t){return fromUuid(t)})));case 14:return l=x.sent.map((function(t){return t.toObject(!1)})),x.next=17,Promise.all(this.creationData.packageIds.map((function(t){return fromUuid(t)})));case 17:if(p=x.sent.map((function(t){return t.toObject(!1)})),this.conjuration.effects.push({changes:[],duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize("PLAYER.services"),flags:{dsa5:{value:o,editable:!0,max:500,description:"".concat(game.i18n.localize("PLAYER.conjuration")," ").concat(game.i18n.localize("PLAYER.services")),manual:o,auto:0,hideOnToken:!0,hidePlayers:!1},core:{statusId:"services"}}}),!game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type]){x.next=22;break}return x.next=22,game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type](this.conjuration,this.creationData.qs-this.creationData.consumedQS,this.creationData.type);case 22:return"creature"!=this.conjuration.type||this.conjuration.system.creatureClass.value.includes(this.creationData.typeName)||(this.conjuration.system.creatureClass.value+=", ".concat(this.creationData.typeName)),x.next=25,d.Z.create(this.conjuration);case 25:return this.actor=x.sent,h=[].concat(player_menu_toConsumableArray(l),player_menu_toConsumableArray(p)).filter((function(t){return!k.conjuration.items.find((function(r){return r.type==t.type&&t.name==r.name}))})),x.next=29,this.actor.createEmbeddedDocuments("Item",h);case 29:m=player_menu_createForOfIteratorHelper(p),x.prev=30,m.s();case 32:if((y=m.n()).done){x.next=38;break}return g=y.value,x.next=36,P.Z.traitAdded(this.actor,g);case 36:x.next=32;break;case 38:x.next=43;break;case 40:x.prev=40,x.t0=x.catch(30),m.e(x.t0);case 43:return x.prev=43,m.f(),x.finish(43);case 46:v=player_menu_createForOfIteratorHelper(l),x.prev=47,v.s();case 49:if((_=v.n()).done){x.next=55;break}return b=_.value,x.next=53,P.Z.traitAdded(this.actor,b);case 53:x.next=49;break;case 55:x.next=60;break;case 57:x.prev=57,x.t1=x.catch(47),v.e(x.t1);case 60:return x.prev=60,v.f(),x.finish(60);case 63:return x.next=65,this.actor.update({"system.status.wounds.value":this.actor.system.status.wounds.max});case 65:return x.next=67,renderTemplate("systems/dsa5/templates/system/conjuration/chat.html",{actor:this.actor,modifiers:this.creationData.modifiers,summoner:this.summoner,summonerImg:le.Z.videoOrImgTag(this.summoner.img),conjureImg:le.Z.videoOrImgTag(this.actor.img),services:o});case 67:return w=x.sent,x.next=70,ChatMessage.create(t.Z.chatDataSetup(w));case 70:this.render();case 71:case"end":return x.stop()}}),_callee12,this,[[30,40,43,46],[47,57,60,63]])}))),function createActor(){return a.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;player_menu_get(player_menu_getPrototypeOf(ConjurationRequest.prototype),"activateListeners",this).call(this,t),t.find(".createActor").click((function(){r.createActor()})),t.on("mousedown",".newNPC",function(){var t=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee13(t){var r;return player_menu_regeneratorRuntime().wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:r=$(t.currentTarget).attr("data-id"),2==t.button&&(game.actors.get(r).delete(),$(t.currentTarget).remove());case 2:case"end":return a.stop()}}),_callee13)})));return function(r){return t.apply(this,arguments)}}()),t.on("click",".newNPC",function(){var t=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee14(t){var r;return player_menu_regeneratorRuntime().wrap((function _callee14$(a){for(;;)switch(a.prev=a.next){case 0:r=$(t.currentTarget).attr("data-id"),game.actors.get(r).sheet.render(!0);case 2:case"end":return a.stop()}}),_callee14)})));return function(r){return t.apply(this,arguments)}}()),t.on("dragstart",".newNPC",(function(t){t.stopPropagation();var r={type:"Actor",uuid:t.currentTarget.dataset.uuid};t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(r))})),t.find(".showEntity").click((function(t){t.stopPropagation();var r=function(){var r=player_menu_asyncToGenerator(player_menu_regeneratorRuntime().mark((function _callee15(){return player_menu_regeneratorRuntime().wrap((function _callee15$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,fromUuid(t.currentTarget.dataset.uuid);case 2:r.sent.sheet.render(!0);case 3:case"end":return r.stop()}}),_callee15)})));return function fun(){return r.apply(this,arguments)}}();r()}))}}],[{key:"defaultOptions",get:function get(){var t=player_menu_get(player_menu_getPrototypeOf(ConjurationRequest),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(t,{classes:t.classes.concat(["dsa5","largeDialog"]),width:470}),t.template="systems/dsa5/templates/system/conjuration/request.html",t}}]),ConjurationRequest}(ge.Z),we=__webpack_require__(903);function itemDrop_typeof(t){return itemDrop_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},itemDrop_typeof(t)}function itemDrop_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function itemDrop_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function itemDrop_get(){return itemDrop_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=itemDrop_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},itemDrop_get.apply(this,arguments)}function itemDrop_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=itemDrop_getPrototypeOf(t)););return t}function itemDrop_setPrototypeOf(t,r){return itemDrop_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},itemDrop_setPrototypeOf(t,r)}function itemDrop_createSuper(t){var r=function itemDrop_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=itemDrop_getPrototypeOf(t);if(r){var i=itemDrop_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return itemDrop_possibleConstructorReturn(this,a)}}function itemDrop_possibleConstructorReturn(t,r){if(r&&("object"===itemDrop_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function itemDrop_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function itemDrop_getPrototypeOf(t){return itemDrop_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},itemDrop_getPrototypeOf(t)}function itemDrop_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=itemDrop_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function itemDrop_regeneratorRuntime(){itemDrop_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==itemDrop_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function itemDrop_toConsumableArray(t){return function itemDrop_arrayWithoutHoles(t){if(Array.isArray(t))return itemDrop_arrayLikeToArray(t)}(t)||function itemDrop_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||itemDrop_unsupportedIterableToArray(t)||function itemDrop_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function itemDrop_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return itemDrop_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?itemDrop_arrayLikeToArray(t,r):void 0}}function itemDrop_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function itemDrop_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function itemDrop_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){itemDrop_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){itemDrop_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}var ke=function(){var r=itemDrop_asyncToGenerator(itemDrop_regeneratorRuntime().mark((function _callee(r,a,o,i){var c,u,l,p,d,h,m,g,v,_,b;return itemDrop_regeneratorRuntime().wrap((function _callee$(w){for(;;)switch(w.prev=w.next){case 0:if(!game.user.isGM){w.next=36;break}return w.next=3,game.dsa5.apps.DSA5_Utility.allMoneyItems();case 3:return c=w.sent,w.next=6,t.Z.getFolderForType("Actor",null,"Dropped Items");case 6:return u=w.sent,l=game.users.filter((function(t){return!t.isGM})).map((function(t){return t.id})),p=l.reduce((function(t,r){return t[r]=1,t}),{default:0}),(d=a.toObject()).system.quantity.value=i,y.Z.obfuscateDropData(d,o.tabsinvisible),getProperty(d,"system.worn.value")&&(d.system.worn.value=!1),h={type:"npc",name:a.name,img:a.img,prototypeToken:{img:a.img,width:.4,height:.4},ownership:p,items:[].concat(itemDrop_toConsumableArray(c),[d]),flags:{core:{sheetClass:"dsa5.MerchantSheetDSA5"}},folder:u,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},status:{wounds:{value:16}}}},w.next=16,game.dsa5.entities.Actordsa5.create(h);case 16:return m=w.sent,w.next=19,m.getTokenDocument({x:o.x,y:o.y,hidden:!1});case 19:if(g=w.sent,canvas.dimensions.rect.contains(g.x,g.y)){w.next=22;break}return w.abrupt("return",!1);case 22:return v=getDocumentClass("Token"),w.next=25,v.create(g,{parent:canvas.scene});case 25:if(!r){w.next=34;break}if(!((_=a.system.quantity.value-i)<=0)){w.next=32;break}return w.next=30,r.deleteEmbeddedDocuments("Item",[a.id]);case 30:w.next=34;break;case 32:return w.next=34,r.updateEmbeddedDocuments("Item",[{_id:a.id,"system.quantity.value":_}]);case 34:w.next=38;break;case 36:b={itemId:a.uuid,sourceActorId:null==r?void 0:r.id,data:o,amount:i},game.socket.emit("system.dsa5",{type:"itemDrop",payload:b});case 38:case"end":return w.stop()}}),_callee)})));return function dropToGround(t,a,o,i){return r.apply(this,arguments)}}(),xe=function(){var t=itemDrop_asyncToGenerator(itemDrop_regeneratorRuntime().mark((function _callee3(t,a){var o,i,c;return itemDrop_regeneratorRuntime().wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Item.implementation.fromDropData(a);case 2:if(o=t.sent,i=o.parent,r.Z.equipmentCategories.includes(o.type)){t.next=6;break}return t.abrupt("return");case 6:return t.next=8,renderTemplate("systems/dsa5/templates/dialog/dropToGround.html",{name:o.name,count:o.system.quantity.value});case 8:c=t.sent,new Te({title:a.name,content:c,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){var t=itemDrop_asyncToGenerator(itemDrop_regeneratorRuntime().mark((function _callee2(t){return itemDrop_regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",ke(i,o,a,Number(t.find('[name="count"]').val())));case 1:case"end":return r.stop()}}),_callee2)})));return function callback(r){return t.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 10:case"end":return t.stop()}}),_callee3)})));return function handleItemDrop(r,a){return t.apply(this,arguments)}}(),Se=function(){var t=itemDrop_asyncToGenerator(itemDrop_regeneratorRuntime().mark((function _callee4(t,r){var a,o,i,c,u,l,p,d,h,m;return itemDrop_regeneratorRuntime().wrap((function _callee4$(y){for(;;)switch(y.prev=y.next){case 0:a=r.x,o=r.y,i=0,c=t.grid.size,u=Math.ceil(Math.sqrt(r.ids.length)),l=itemDrop_createForOfIteratorHelper(r.ids),y.prev=6,l.s();case 8:if((p=l.n()).done){y.next=21;break}if(d=p.value,h=game.actors.get(d)){y.next=13;break}return y.abrupt("continue",19);case 13:return y.next=15,h.getTokenDocument({x:a,y:o,hidden:!1});case 15:(m=y.sent).constructor.create(m,{parent:t.scene}),u%i==0&&i>0?(o+=c,a=r.x):a+=c,i++;case 19:y.next=8;break;case 21:y.next=26;break;case 23:y.prev=23,y.t0=y.catch(6),l.e(y.t0);case 26:return y.prev=26,l.f(),y.finish(26);case 29:case"end":return y.stop()}}),_callee4,null,[[6,23,26,29]])})));return function handleGroupDrop(r,a){return t.apply(this,arguments)}}(),Te=function(t){!function itemDrop_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&itemDrop_setPrototypeOf(t,r)}(DropToGroundDialog,Dialog);var r=itemDrop_createSuper(DropToGroundDialog);function DropToGroundDialog(){return itemDrop_classCallCheck(this,DropToGroundDialog),r.apply(this,arguments)}return function itemDrop_createClass(t,r,a){return r&&itemDrop_defineProperties(t.prototype,r),a&&itemDrop_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DropToGroundDialog,[{key:"activateListeners",value:function activateListeners(t){itemDrop_get(itemDrop_getPrototypeOf(DropToGroundDialog.prototype),"activateListeners",this).call(this,t),t.find('input[type="range"]').change((function(t){$(t.currentTarget).closest(".row-section").find(".range-value").html($(t.currentTarget).val())}))}}]),DropToGroundDialog}();function ready_typeof(t){return ready_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ready_typeof(t)}function ready_regeneratorRuntime(){ready_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==ready_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function ready_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function ready_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){ready_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){ready_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function chat_context_typeof(t){return chat_context_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},chat_context_typeof(t)}function chat_context_regeneratorRuntime(){chat_context_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==chat_context_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function chat_context_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function chat_context_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){chat_context_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){chat_context_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}var Ae=__webpack_require__(565);function statuseffect_typeof(t){return statuseffect_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},statuseffect_typeof(t)}function statuseffect_regeneratorRuntime(){statuseffect_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==statuseffect_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function statuseffect_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function statuseffect_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return statuseffect_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return statuseffect_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function statuseffect_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function statuseffect_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function statuseffect_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){statuseffect_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){statuseffect_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function statuseffect(){Token.prototype.drawEffects=statuseffect_asyncToGenerator(statuseffect_regeneratorRuntime().mark((function _callee(){var t,r,a,o,i,c,u,l,p,d,h,m;return statuseffect_regeneratorRuntime().wrap((function _callee$(y){for(;;)switch(y.prev=y.next){case 0:if(this.effects.removeChildren().forEach((function(t){return t.destroy()})),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null,t=this.document.effects,!this.actor){y.next=10;break}return y.next=7,this.actor.actorEffects();case 7:y.t0=y.sent,y.next=11;break;case 10:y.t0=[];case 11:if(r=y.t0,a={src:this.document.overlayEffect,tint:null},!t.length&&!r.length){y.next=41;break}o=[],i=statuseffect_createForOfIteratorHelper(r),y.prev=16,i.s();case 18:if((c=i.n()).done){y.next=29;break}if((l=c.value).icon){y.next=22;break}return y.abrupt("continue",27);case 22:if(p=Color.from(null!==(u=l.tint)&&void 0!==u?u:null),!l.getFlag("core","overlay")){y.next=26;break}return a={src:l.icon,tint:p},y.abrupt("continue",27);case 26:o.push(this._drawEffect(l.icon,p,getProperty(l,"flags.dsa5.value")));case 27:y.next=18;break;case 29:y.next=34;break;case 31:y.prev=31,y.t1=y.catch(16),i.e(y.t1);case 34:return y.prev=34,i.f(),y.finish(34);case 37:d=statuseffect_createForOfIteratorHelper(t);try{for(d.s();!(h=d.n()).done;)m=h.value,o.push(this._drawEffect(m,null))}catch(t){d.e(t)}finally{d.f()}return y.next=41,Promise.all(o);case 41:return y.next=43,this._drawOverlay(a.src,a.tint);case 43:this.effects.overlay=y.sent,this._refreshEffects();case 45:case"end":return y.stop()}}),_callee,this,[[16,31,34,37]])}))),Token.prototype._refreshEffects=function(){var t,r=0,a=2*Math.round(canvas.dimensions.size/2/5),o=Math.floor(5*this.document.height),i=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0),c=statuseffect_createForOfIteratorHelper(this.effects.children);try{for(c.s();!(t=c.n()).done;){var u=t.value;if(u!==i&&!u.isCounter)if(u===this.effects.overlay){var l=Math.min(.6*this.w,.6*this.h);u.width=u.height=l,u.position.set((this.w-l)/2,(this.h-l)/2)}else{if(u.width=u.height=a,u.x=Math.floor(r/o)*a,u.y=r%o*a,i.drawRoundedRect(u.x+1,u.y+1,a-2,a-2,2),u.counter>1&&!u.counterDrawn){var p=game.dsa5.config.effectTextStyle,d=game.settings.get("dsa5","statusEffectCounterColor");p._fill=/^#[0-9A-F]+$/.test(d)?d:"#000000";var h=this.effects.addChild(new PreciseText(u.counter,p));h.x=u.x,h.y=u.y,h.isCounter=!0,u.counterDrawn=!0}r++}}}catch(t){c.e(t)}finally{c.f()}},Token.prototype._drawEffect=function(){var t=statuseffect_asyncToGenerator(statuseffect_regeneratorRuntime().mark((function _callee2(t,r,a){var o,i;return statuseffect_regeneratorRuntime().wrap((function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:if(t){c.next=2;break}return c.abrupt("return");case 2:return c.next=4,loadTexture(t,{fallback:"icons/svg/hazard.svg"});case 4:return o=c.sent,i=new PIXI.Sprite(o),r&&(i.tint=r),i.counter=a,c.abrupt("return",this.effects.addChild(i));case 9:case"end":return c.stop()}}),_callee2,this)})));return function(r,a,o){return t.apply(this,arguments)}}(),TokenHUD.prototype._onToggleEffect=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r.overlay;t.preventDefault();var a=t.currentTarget,o=a.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find((function(t){return t.id===a.dataset.statusId})):a.getAttribute("src");if(o.flags.dsa5.editable)return 0==t.button?this.object.incrementCondition(o):2==t.button?this.object.decrementCondition(o):void 0},Token.prototype.incrementCondition=function(){var t=statuseffect_asyncToGenerator(statuseffect_regeneratorRuntime().mark((function _callee3(t){var r,a,o,i,c=arguments;return statuseffect_regeneratorRuntime().wrap((function _callee3$(u){for(;;)switch(u.prev=u.next){case 0:if(r=c.length>1&&void 0!==c[1]?c[1]:{},a=r.active,o=r.overlay,void 0!==o&&o,(i=this.actor.effects.find((function(r){return r.getFlag("core","statusId")===t.id})))&&!Number.isNumeric(getProperty(i,"flags.dsa5.value"))){u.next=7;break}return u.next=5,this.actor.addCondition(t.id,1,!1,!1);case 5:u.next=10;break;case 7:if(!i){u.next=10;break}return u.next=10,this.actor.removeCondition(t.id,1,!1);case 10:return this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),u.abrupt("return",a);case 12:case"end":return u.stop()}}),_callee3,this)})));return function(r){return t.apply(this,arguments)}}(),Token.prototype.decrementCondition=function(){var t=statuseffect_asyncToGenerator(statuseffect_regeneratorRuntime().mark((function _callee4(t){var r,a,o,i=arguments;return statuseffect_regeneratorRuntime().wrap((function _callee4$(c){for(;;)switch(c.prev=c.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:{},a=r.active,o=r.overlay,void 0!==o&&o,this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),c.abrupt("return",a);case 4:case"end":return c.stop()}}),_callee4,this)})));return function(r){return t.apply(this,arguments)}}();var t=Token.prototype._onClickLeft2;Token.prototype._onClickLeft2=function(r){var a=game.user.isGM||!game.settings.get("dsa5","enableDPS")||!function isMerchant(t){return!!t&&["merchant","loot"].includes(getProperty(t.system,"merchant.merchantType"))}(this.actor)||Ae.Z.inDistance(this);if(!a)return ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"));t.call(this,r)}}function sidebar_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function sidebar_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return sidebar_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return sidebar_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function sidebar_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}var Oe=__webpack_require__(586);function configuration_typeof(t){return configuration_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},configuration_typeof(t)}function configuration_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function configuration_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function configuration_createClass(t,r,a){return r&&configuration_defineProperties(t.prototype,r),a&&configuration_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function configuration_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&configuration_setPrototypeOf(t,r)}function configuration_setPrototypeOf(t,r){return configuration_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},configuration_setPrototypeOf(t,r)}function configuration_createSuper(t){var r=function configuration_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=configuration_getPrototypeOf(t);if(r){var i=configuration_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return configuration_possibleConstructorReturn(this,a)}}function configuration_possibleConstructorReturn(t,r){if(r&&("object"===configuration_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function configuration_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function configuration_getPrototypeOf(t){return configuration_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},configuration_getPrototypeOf(t)}function configuration_regeneratorRuntime(){configuration_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==configuration_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function configuration_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function configuration_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){configuration_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){configuration_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}var Pe=function(t){configuration_inherits(ChangelogForm,FormApplication);var r=configuration_createSuper(ChangelogForm);function ChangelogForm(){return configuration_classCallCheck(this,ChangelogForm),r.apply(this,arguments)}return configuration_createClass(ChangelogForm,[{key:"render",value:function render(){(0,Oe.j)()}}]),ChangelogForm}(),Ee=function(t){configuration_inherits(ResetTokenbar,FormApplication);var r,a=configuration_createSuper(ResetTokenbar);function ResetTokenbar(){return configuration_classCallCheck(this,ResetTokenbar),a.apply(this,arguments)}return configuration_createClass(ResetTokenbar,[{key:"render",value:(r=configuration_asyncToGenerator(configuration_regeneratorRuntime().mark((function _callee5(){return configuration_regeneratorRuntime().wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,game.settings.set("dsa5","tokenhotbarPosition",{});case 2:return t.next=4,game.settings.set("dsa5","tokenhotbarLayout",0);case 4:return t.next=6,game.settings.set("dsa5","tokenhotbarSize",35);case 6:game.dsa5.apps.tokenHotbar.resetPosition(),game.dsa5.apps.tokenHotbar.render(!0);case 8:case"end":return t.stop()}}),_callee5)}))),function render(){return r.apply(this,arguments)})}]),ResetTokenbar}();function journal_typeof(t){return journal_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},journal_typeof(t)}function journal_regeneratorRuntime(){journal_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==journal_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function journal_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function journal(){Hooks.on("renderJournalSheet",(function(t,r,a){r.find(".close").attr("data-tooltip",game.i18n.localize("SHEET.Close")),r.find(".entry-image").attr("data-tooltip",game.i18n.localize("SHEET.imageView")),r.find(".entry-text").attr("data-tooltip",game.i18n.localize("SHEET.textView")),r.find(".share-image").attr("data-tooltip",game.i18n.localize("SHEET.showToPlayers")),r.find(".import").attr("data-tooltip",game.i18n.localize("SHEET.import")),r.find(".panMapNote").attr("data-tooltip",game.i18n.localize("SHEET.panMapNote")),_.Z.bindRollCommands(r),u.Z.bindButtons(r),r.on("click",".chat-condition",(function(t){c.Z.postStatus($(t.currentTarget).attr("data-id"))})),r.on("mousedown","img",(function(r){2==r.button&&game.dsa5.apps.DSA5_Utility.showArtwork({name:t.name,uuid:"",img:$(r.currentTarget).attr("src")})})),bindImgToCanvasDragStart(r)})),Hooks.on("getJournalSheetHeaderButtons",(function(t,r){var a;t.document.sceneNote&&r.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:(a=function journal_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){journal_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){journal_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(journal_regeneratorRuntime().mark((function _callee(){return journal_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.document.panToNote());case 1:case"end":return r.stop()}}),_callee)}))),function onclick(){return a.apply(this,arguments)})})}))}function tokenHUD_typeof(t){return tokenHUD_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tokenHUD_typeof(t)}function tokenHUD_regeneratorRuntime(){tokenHUD_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==tokenHUD_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function tokenHUD_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function tokenHUD_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function addThirdBarToHUD(t,r,a){if(r.system.isPriest&&r.system.isMage){var o=r.system.status.karmaenergy.value,i='<div class="attribute bar3"><input type="text" name="system.status.karmaenergy.value" value="'.concat(o,'"></div>');t.find(".col.middle").prepend(i),t.find(".bar3 input").change(function(){var t=function tokenHUD_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){tokenHUD_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){tokenHUD_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(tokenHUD_regeneratorRuntime().mark((function _callee(t){var o,i,c,u,l;return tokenHUD_regeneratorRuntime().wrap((function _callee$(p){for(;;)switch(p.prev=p.next){case 0:return o=t.currentTarget,i=o.value.trim(),c=i.startsWith("+")||i.startsWith("-"),i.startsWith("=")&&(i=i.slice(1)),u=Number(i),l=o.name.split(".").reduce((function(t,r){return t[r]}),r),p.next=8,r.update(tokenHUD_defineProperty({},o.name,c?l+u:u));case 8:a.clear();case 9:case"end":return p.stop()}}),_callee)})));return function(r){return t.apply(this,arguments)}}())}}var Ce=__webpack_require__(416);function combat_tracker_typeof(t){return combat_tracker_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},combat_tracker_typeof(t)}function combat_tracker_regeneratorRuntime(){combat_tracker_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==combat_tracker_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function combat_tracker_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function combat_tracker_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return combat_tracker_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return combat_tracker_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function combat_tracker_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function combat_tracker_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function combat_tracker_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){combat_tracker_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){combat_tracker_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function combat_tracker_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function combat_tracker_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function combat_tracker_createClass(t,r,a){return r&&combat_tracker_defineProperties(t.prototype,r),a&&combat_tracker_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function combat_tracker_get(){return combat_tracker_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=combat_tracker_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},combat_tracker_get.apply(this,arguments)}function combat_tracker_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=combat_tracker_getPrototypeOf(t)););return t}function combat_tracker_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&combat_tracker_setPrototypeOf(t,r)}function combat_tracker_setPrototypeOf(t,r){return combat_tracker_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},combat_tracker_setPrototypeOf(t,r)}function combat_tracker_createSuper(t){var r=function combat_tracker_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=combat_tracker_getPrototypeOf(t);if(r){var i=combat_tracker_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return combat_tracker_possibleConstructorReturn(this,a)}}function combat_tracker_possibleConstructorReturn(t,r){if(r&&("object"===combat_tracker_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function combat_tracker_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function combat_tracker_getPrototypeOf(t){return combat_tracker_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},combat_tracker_getPrototypeOf(t)}var De=function(t){combat_tracker_inherits(DSA5CombatTracker,CombatTracker);var r,a=combat_tracker_createSuper(DSA5CombatTracker);function DSA5CombatTracker(){return combat_tracker_classCallCheck(this,DSA5CombatTracker),a.apply(this,arguments)}return combat_tracker_createClass(DSA5CombatTracker,[{key:"activateListeners",value:function activateListeners(t){combat_tracker_get(combat_tracker_getPrototypeOf(DSA5CombatTracker.prototype),"activateListeners",this).call(this,t),t.find(".combatant.actor .aggroButton").click((function(t){t.preventDefault(),t.stopPropagation(),DSA5CombatTracker.runActAttackDialog()}))}},{key:"getData",value:(r=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee(t){var r,a,o,i;return combat_tracker_regeneratorRuntime().wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,combat_tracker_get(combat_tracker_getPrototypeOf(DSA5CombatTracker.prototype),"getData",this).call(this,t);case 2:r=c.sent,a=combat_tracker_createForOfIteratorHelper(r.turns);try{for(i=function _loop(){var t=o.value,a=r.combat.turns.find((function(r){return r.id==t.id})),i=game.user.isGM||a.actor&&a.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects");t.defenseCount=a.getFlag("dsa5","defenseCount")||0;var c=[];if(a.actor){var u,l=combat_tracker_createForOfIteratorHelper(a.actor.items);try{for(l.s();!(u=l.n()).done;){var p=u.value;if("rangeweapon"==p.type&&p.system.worn.value&&p.system.reloadTime.progress>0){var h={name:p.name,remaining:d.Z.calcLZ(p,a.actor)-p.system.reloadTime.progress};h.remaining>0&&c.push(h)}else if(["spell","liturgy"].includes(p.type)&&p.system.castingTime.modified>0){var m={name:p.name,remaining:p.system.castingTime.modified-p.system.castingTime.progress};m.remaining>0&&c.push(m)}}}catch(t){l.e(t)}finally{l.f()}}(c=c.sort((function(t,r){return t.remaining-r.remaining}))).length>0&&(t.ongoings="".concat(game.i18n.localize("COMBATTRACKER.ongoing"),"\n").concat(c.map((function(t){return"".concat(t.name," - ").concat(t.remaining)})).join("\n")),t.ongoing=c[0].remaining),t.effects=new Set,a.token&&(a.token.effects.forEach((function(r){return t.effects.add(r)})),a.token.overlayEffect&&t.effects.add(a.token.overlayEffect)),a.actor&&a.actor.temporaryEffects.forEach((function(r){r.getFlag("core","statusId")===CONFIG.Combat.defeatedStatusId?t.defeated=!0:!r.icon||!i||r.notApplicable||!game.user.isGM&&r.getFlag("dsa5","hidePlayers")||r.getFlag("dsa5","hideOnToken")||t.effects.add(r.icon)}))},a.s();!(o=a.n()).done;)i()}catch(t){a.e(t)}finally{a.f()}return c.abrupt("return",r);case 6:case"end":return c.stop()}}),_callee,this)}))),function getData(t){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function get(){return foundry.utils.mergeObject(combat_tracker_get(combat_tracker_getPrototypeOf(DSA5CombatTracker),"defaultOptions",this),{template:"/systems/dsa5/templates/system/combattracker.html"})}},{key:"runActAttackDialog",value:function runActAttackDialog(){if(game.combat){var t=game.combat.combatant;(game.user.isGM||t.isOwner)&&pe.HS.showDialog(t.actor,t.tokenId)}}}]),DSA5CombatTracker}(),Ie=function(t){combat_tracker_inherits(DSA5Combat,Combat);var r,a,o,i,c=combat_tracker_createSuper(DSA5Combat);function DSA5Combat(t,r){return combat_tracker_classCallCheck(this,DSA5Combat),c.call(this,t,r)}return combat_tracker_createClass(DSA5Combat,[{key:"refreshTokenbars",value:(i=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee2(){return combat_tracker_regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar();case 1:case"end":return t.stop()}}),_callee2)}))),function refreshTokenbars(){return i.apply(this,arguments)})},{key:"_onCreate",value:function _onCreate(t,r,a){combat_tracker_get(combat_tracker_getPrototypeOf(DSA5Combat.prototype),"_onCreate",this).call(this,t,r,a),this.refreshTokenbars()}},{key:"_onDelete",value:function _onDelete(t,r){combat_tracker_get(combat_tracker_getPrototypeOf(DSA5Combat.prototype),"_onDelete",this).call(this,t,r),this.refreshTokenbars()}},{key:"nextRound",value:(o=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee3(){var t,r,a;return combat_tracker_regeneratorRuntime().wrap((function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:if(!game.user.isGM){o.next=20;break}t=combat_tracker_createForOfIteratorHelper(this.turns),o.prev=2,t.s();case 4:if((r=t.n()).done){o.next=10;break}return a=r.value,o.next=8,a.setFlag("dsa5","defenseCount",0);case 8:o.next=4;break;case 10:o.next=15;break;case 12:o.prev=12,o.t0=o.catch(2),t.e(o.t0);case 15:return o.prev=15,t.f(),o.finish(15);case 18:o.next=22;break;case 20:return o.next=22,game.socket.emit("system.dsa5",{type:"clearCombat",payload:{}});case 22:return o.next=24,combat_tracker_get(combat_tracker_getPrototypeOf(DSA5Combat.prototype),"nextRound",this).call(this);case 24:return o.abrupt("return",o.sent);case 25:case"end":return o.stop()}}),_callee3,this,[[2,12,15,18]])}))),function nextRound(){return o.apply(this,arguments)})},{key:"getDefenseCount",value:(a=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee4(t){var r;return combat_tracker_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return r=this.getCombatantFromActor(t),a.abrupt("return",r&&r.getFlag("dsa5","defenseCount")||0);case 2:case"end":return a.stop()}}),_callee4,this)}))),function getDefenseCount(t){return a.apply(this,arguments)})},{key:"getCombatantFromActor",value:function getCombatantFromActor(t){var r;return(r=t.token?Array.from(this.combatants).find((function(r){return r.tokenId==t.token})):Array.from(this.combatants).find((function(r){return r.actorId==t.actor})))?this.combatants.get(r.id):void 0}},{key:"updateDefenseCount",value:(r=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee5(t){var r;return combat_tracker_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:if(!game.user.isGM){a.next=7;break}if(!(r=this.getCombatantFromActor(t))||getProperty(r.actor,"system.config.defense")){a.next=5;break}return a.next=5,r.setFlag("dsa5","defenseCount",(r.getFlag("dsa5","defenseCount")||0)+1);case 5:a.next=9;break;case 7:return a.next=9,game.socket.emit("system.dsa5",{type:"updateDefenseCount",payload:{speaker:t}});case 9:case"end":return a.stop()}}),_callee5,this)}))),function updateDefenseCount(t){return r.apply(this,arguments)})}]),DSA5Combat}(),Re=function(t){combat_tracker_inherits(DSA5Combatant,Combatant);var r=combat_tracker_createSuper(DSA5Combatant);function DSA5Combatant(t,a){return combat_tracker_classCallCheck(this,DSA5Combatant),null==t.flags&&(t.flags={}),mergeObject(t.flags,{dsa5:{defenseCount:0}}),r.call(this,t,a)}return combat_tracker_createClass(DSA5Combatant)}(),Le=function(){function RepeatingEffectsHelper(){combat_tracker_classCallCheck(this,RepeatingEffectsHelper)}var r,a,o,i,c;return combat_tracker_createClass(RepeatingEffectsHelper,null,[{key:"updateCombatHook",value:(c=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee6(t,r,a,o){return combat_tracker_regeneratorRuntime().wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:if(r.round||r.turn){a.next=2;break}return a.abrupt("return");case 2:if(0==t.round||!t.turns||!t.active){a.next=6;break}if(!(t.previous.round<t.current.round)){a.next=6;break}return a.next=6,RepeatingEffectsHelper.startOfRound(t);case 6:case"end":return a.stop()}}),_callee6)}))),function updateCombatHook(t,r,a,o){return c.apply(this,arguments)})},{key:"startOfRound",value:(i=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee7(t){var r,a,o,i,c,u,l,p;return combat_tracker_regeneratorRuntime().wrap((function _callee7$(d){for(;;)switch(d.prev=d.next){case 0:if((r=game.users.find((function(t){return t.active&&t.isGM})))&&game.user.id==r.id){d.next=3;break}return d.abrupt("return");case 3:a=combat_tracker_createForOfIteratorHelper(t.turns),d.prev=4,a.s();case 6:if((o=a.n()).done){d.next=37;break}if((i=o.value).defeated){d.next=35;break}c=combat_tracker_createForOfIteratorHelper(i.actor.effects),d.prev=10,c.s();case 12:if((u=c.n()).done){d.next=25;break}if(l=u.value,"bleeding"!=(p=l.getFlag("core","statusId"))){d.next=20;break}return d.next=18,this.applyBleeding(i);case 18:d.next=23;break;case 20:if("burning"!=p){d.next=23;break}return d.next=23,this.applyBurning(i,l);case 23:d.next=12;break;case 25:d.next=30;break;case 27:d.prev=27,d.t0=d.catch(10),c.e(d.t0);case 30:return d.prev=30,c.f(),d.finish(30);case 33:return d.next=35,this.startOfRoundEffects(i);case 35:d.next=6;break;case 37:d.next=42;break;case 39:d.prev=39,d.t1=d.catch(4),a.e(d.t1);case 42:return d.prev=42,a.f(),d.finish(42);case 45:case"end":return d.stop()}}),_callee7,this,[[4,39,42,45],[10,27,30,33]])}))),function startOfRound(t){return i.apply(this,arguments)})},{key:"startOfRoundEffects",value:(o=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee8(r){var a,o,i,c,u,l,p,d,h,m;return combat_tracker_regeneratorRuntime().wrap((function _callee8$(y){for(;;)switch(y.prev=y.next){case 0:a=0,o=["wounds","astralenergy","karmaenergy"];case 2:if(!(a<o.length)){y.next=41;break}i=o[a],c=combat_tracker_createForOfIteratorHelper(r.actor.system.repeatingEffects.startOfRound[i]),y.prev=5,c.s();case 7:if((u=c.n()).done){y.next=30;break}if(l=u.value,!getProperty(r.actor.system.repeatingEffects,"disabled.".concat(i))){y.next=11;break}return y.abrupt("continue",28);case 11:return y.next=13,new Roll(l.value).evaluate({async:!0});case 13:return p=y.sent,y.next=16,p.render();case 16:return d=y.sent,h=game.i18n.localize(p.total>0?"CHATNOTIFICATION.regenerates":"CHATNOTIFICATION.getsHurt"),m="".concat(r.actor.name," ").concat(h," ").concat(game.i18n.localize(i)," ").concat(d),y.next=21,ChatMessage.create(t.Z.chatDataSetup(m));case 21:if("wounds"!=i){y.next=26;break}return y.next=24,r.actor.applyDamage(-1*p.total);case 24:y.next=28;break;case 26:return y.next=28,r.actor.applyMana(-1*p.total,"astralenergy"==i?"AsP":"KaP");case 28:y.next=7;break;case 30:y.next=35;break;case 32:y.prev=32,y.t0=y.catch(5),c.e(y.t0);case 35:return y.prev=35,c.f(),y.finish(35);case 38:a++,y.next=2;break;case 41:case"end":return y.stop()}}),_callee8,null,[[5,32,35,38]])}))),function startOfRoundEffects(t){return o.apply(this,arguments)})},{key:"applyBleeding",value:(a=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee9(r){return combat_tracker_regeneratorRuntime().wrap((function _callee9$(a){for(;;)switch(a.prev=a.next){case 0:if(!(r.actor.system.status.wounds.value<=0)){a.next=2;break}return a.abrupt("return");case 2:return a.next=4,ChatMessage.create(t.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.bleeding",{actor:r.actor.name})));case 4:return a.next=6,r.actor.applyDamage(1);case 6:case"end":return a.stop()}}),_callee9)}))),function applyBleeding(t){return a.apply(this,arguments)})},{key:"applyBurning",value:(r=combat_tracker_asyncToGenerator(combat_tracker_regeneratorRuntime().mark((function _callee10(r,a){var o,i,c,l,p;return combat_tracker_regeneratorRuntime().wrap((function _callee10$(d){for(;;)switch(d.prev=d.next){case 0:if(!(r.actor.system.status.wounds.value<=0)){d.next=2;break}return d.abrupt("return");case 2:return o=Number(a.getFlag("dsa5","value")),i=u.Z.resistantToEffect(r.actor,a),c={0:"1",1:"1d3",2:"1d6",3:"2d6"}[o-i]||"1",d.next=7,new Roll(c).evaluate({async:!0});case 7:return l=d.sent,d.next=10,l.render();case 10:return p=d.sent,d.next=13,ChatMessage.create(t.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.burning.".concat(o),{actor:r.actor.name,damage:p})));case 13:return d.next=15,r.actor.applyDamage(l.total);case 15:case"end":return d.stop()}}),_callee10)}))),function applyBurning(t,a){return r.apply(this,arguments)})}]),RepeatingEffectsHelper}();function keybindings_typeof(t){return keybindings_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},keybindings_typeof(t)}function keybindings_regeneratorRuntime(){keybindings_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==keybindings_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function keybindings_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function keybindings(){var r;game.keybindings.register("dsa5","masterMenu",{name:"gmMenu",hint:game.i18n.localize("KEYBINDINGS.masterMenu"),editable:[{key:"KeyM"}],onDown:function onDown(){return t.Z.renderToggle(game.dsa5.apps.gameMasterMenu)},restricted:!0}),game.keybindings.register("dsa5","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:function onDown(){return t.Z.renderToggle(game.dsa5.apps.journalBrowser)}}),game.keybindings.register("dsa5","library",{name:"ItemLibrary",hint:game.i18n.localize("KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:function onDown(){return t.Z.renderToggle(game.dsa5.itemLibrary)}}),game.keybindings.register("dsa5","attacktest",{name:"attacktest",hint:game.i18n.localize("KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:function onDown(){return De.runActAttackDialog()}}),game.keybindings.register("dsa5","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:function onDown(){return Ge("nextTurn")}}),game.keybindings.register("dsa5","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:function onDown(){return Ge("previousTurn")}}),game.keybindings.register("dsa5","setTargetToUser",{name:"DIALOG.setTargetToUser",hint:game.i18n.localize("DIALOG.setTargetToUserHint"),editable:[],onDown:(r=function keybindings_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){keybindings_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){keybindings_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(keybindings_regeneratorRuntime().mark((function _callee(){return keybindings_regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Ce.Z.getDialog();case 2:return t.abrupt("return",t.sent.render(!0));case 3:case"end":return t.stop()}}),_callee)}))),function onDown(){return r.apply(this,arguments)}),restricted:!0})}Hooks.on("updateCombat",Le.updateCombatHook);var Ge=function combatTurn(t){var r,a;(null===(r=game.combat)||void 0===r||null===(a=r.combatant)||void 0===a?void 0:a.isOwner)&&game.combat[t]()};function dsarolls_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function dsarolls_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return dsarolls_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return dsarolls_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function dsarolls_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}var Me=__webpack_require__(846);function adventure_wizard_typeof(t){return adventure_wizard_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},adventure_wizard_typeof(t)}function adventure_wizard_toConsumableArray(t){return function adventure_wizard_arrayWithoutHoles(t){if(Array.isArray(t))return adventure_wizard_arrayLikeToArray(t)}(t)||function adventure_wizard_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||adventure_wizard_unsupportedIterableToArray(t)||function adventure_wizard_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function adventure_wizard_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=adventure_wizard_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function adventure_wizard_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return adventure_wizard_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?adventure_wizard_arrayLikeToArray(t,r):void 0}}function adventure_wizard_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function adventure_wizard_regeneratorRuntime(){adventure_wizard_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==adventure_wizard_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function adventure_wizard_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function adventure_wizard_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){adventure_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){adventure_wizard_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function adventure_wizard_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function adventure_wizard_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function adventure_wizard_createClass(t,r,a){return r&&adventure_wizard_defineProperties(t.prototype,r),a&&adventure_wizard_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function adventure_wizard_get(){return adventure_wizard_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=adventure_wizard_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},adventure_wizard_get.apply(this,arguments)}function adventure_wizard_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=adventure_wizard_getPrototypeOf(t)););return t}function adventure_wizard_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&adventure_wizard_setPrototypeOf(t,r)}function adventure_wizard_setPrototypeOf(t,r){return adventure_wizard_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},adventure_wizard_setPrototypeOf(t,r)}function adventure_wizard_createSuper(t){var r=function adventure_wizard_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=adventure_wizard_getPrototypeOf(t);if(r){var i=adventure_wizard_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return adventure_wizard_possibleConstructorReturn(this,a)}}function adventure_wizard_possibleConstructorReturn(t,r){if(r&&("object"===adventure_wizard_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function adventure_wizard_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function adventure_wizard_getPrototypeOf(t){return adventure_wizard_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},adventure_wizard_getPrototypeOf(t)}var je=function(r){adventure_wizard_inherits(BookWizard,Application);var a,o,i,l,p,d,m,y,g,v,b,w,k,x,S,T,A,O,P=adventure_wizard_createSuper(BookWizard);function BookWizard(t){var r;return adventure_wizard_classCallCheck(this,BookWizard),(r=P.call(this,t)).adventures=[],r.books=[],r.rshs=[],r}return adventure_wizard_createClass(BookWizard,[{key:"_getHeaderButtons",value:function _getHeaderButtons(){var t,r=this,a=adventure_wizard_get(adventure_wizard_getPrototypeOf(BookWizard.prototype),"_getHeaderButtons",this).call(this);return a.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:(t=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee(t){return adventure_wizard_regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",r._showBooks());case 1:case"end":return t.stop()}}),_callee)}))),function onclick(r){return t.apply(this,arguments)})}),a}},{key:"_render",value:(O=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee2(){var t,r,a=arguments;return adventure_wizard_regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},o.next=4,adventure_wizard_get(adventure_wizard_getPrototypeOf(BookWizard.prototype),"_render",this).call(this,t,r);case 4:$(this._element).find(".library").attr("data-tooltip",game.i18n.localize("Book.home"));case 5:case"end":return o.stop()}}),_callee2,this)}))),function _render(){return O.apply(this,arguments)})},{key:"_showBooks",value:function _showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!1,this.currentType=void 0,this.loadPage(this._element)}},{key:"toggleBookVisibility",value:(A=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee3(t,r,a){var o,i,c,u,l,p,d;return adventure_wizard_regeneratorRuntime().wrap((function _callee3$(h){for(;;)switch(h.prev=h.next){case 0:return(o=game.settings.get("dsa5","expansionPermissions"))[t]=a,h.next=4,game.settings.set("dsa5","expansionPermissions",o);case 4:return i=this[r].find((function(r){return r.id==t})),h.next=7,fetch(i.path);case 7:return h.next=9,h.sent.json();case 9:c=h.sent,u=0,l=["actors","journal","scenes"];case 12:if(!(u<l.length)){h.next=22;break}if(p=l[u],c[p]){h.next=16;break}return h.abrupt("continue",19);case 16:return d=game.packs.get(c[p]),h.next=19,d.configure({private:!a});case 19:u++,h.next=12;break;case 22:this.render();case 23:case"end":return h.stop()}}),_callee3,this)}))),function toggleBookVisibility(t,r,a){return A.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;adventure_wizard_get(adventure_wizard_getPrototypeOf(BookWizard.prototype),"activateListeners",this).call(this,t),t.on("click",".toggleVisibility",function(){var t=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee4(t){var a,o,i;return adventure_wizard_regeneratorRuntime().wrap((function _callee4$(c){for(;;)switch(c.prev=c.next){case 0:a=t.currentTarget.dataset.itemid,o=t.currentTarget.dataset.type,i=$(t.currentTarget).find("i").hasClass("fa-toggle-off"),r.toggleBookVisibility(a,o,i);case 4:case"end":return c.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()),t.on("click",".showMapNote",(function(t){game.journal.get(t.currentTarget.dataset.entryid).panToNote()})),t.on("search keyup",".filterJournals",(function(t){r.filterToc($(t.currentTarget).val())})),t.on("click",".loadBook",(function(a){r.selectedChapter=void 0,r.selectedType=void 0,r.content=void 0,r.loadBook($(a.currentTarget).text(),t,$(a.currentTarget).attr("data-type"))})),t.on("click",".getChapter",(function(a){r.selectedType=$(a.currentTarget).closest(".toc").attr("data-type"),r.selectedChapter=$(a.currentTarget).attr("data-id"),r.content=void 0,r.loadPage(t)})),t.on("click",".subChapter",(function(t){var a=$(t.currentTarget).text(),o=$(t.currentTarget).attr("data-jid");o?r.loadJournalById(o):($(r._element).find(".subChapter").removeClass("selected"),$(r._element).find('[data-id="'.concat(a,'"]')).addClass("selected"),r.loadJournal(a))})),_.Z.bindRollCommands(t),t.find(".tocCollapser").click((function(r){$(r.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),t.find(".tocCollapsing").toggleClass("expanded")})),t.on("mousedown",".openPin",function(){var t=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee5(t){var a;return adventure_wizard_regeneratorRuntime().wrap((function _callee5$(o){for(;;)switch(o.prev=o.next){case 0:if(a=t.currentTarget.dataset.uuid,0!=t.button){o.next=9;break}return o.t0=r,o.next=5,fromUuid(a);case 5:o.t1=o.sent,o.t0.showJournal.call(o.t0,o.t1),o.next=10;break;case 9:2==t.button&&r.unpinJournal(a);case 10:case"end":return o.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}()),t.on("click",".showJournal",(function(t){r.popJournal($(t.currentTarget).closest("h1").attr("data-uuid"))})),t.on("click",".pinJournal",(function(t){var a=$(t.currentTarget).closest("h1"),o=a.attr("data-uuid"),i=a.text();r.pinJournal(o,i)})),t.on("click",".activateScene",(function(t){r.showSzene($(t.currentTarget).attr("data-id"),$(t.currentTarget).attr("data-mode"))})),t.on("click",".fulltextsearch",(function(a){r.fulltextsearch=!r.fulltextsearch,$(a.currentTarget).toggleClass("on"),r.filterToc(t.find(".filterJournals").val())})),t.on("mousedown",".chapter img",(function(t){var a=r.book.id;2==t.button&&game.dsa5.apps.DSA5_Utility.showArtwork({name:a,uuid:"",img:$(t.currentTarget).attr("src")})})),u.Z.bindButtons(t),t.on("click",".chat-condition",(function(t){c.Z.postStatus($(t.currentTarget).attr("data-id"))})),t.on("click",".importBook",adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee6(){return adventure_wizard_regeneratorRuntime().wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",r.importBook());case 1:case"end":return t.stop()}}),_callee6)})))),bindImgToCanvasDragStart(t),(0,h.Jp)(t,".breadcrumbs",this.resaveBreadCrumbs),this.heightFix()}},{key:"heightFix",value:function heightFix(){var t=$(this._element).find(".breadcrumbs").height();$(this._element).find(".col.seventy.scrollable").css({"margin-bottom":"".concat(t,"px")})}},{key:"loadJournal",value:(T=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee7(t){var r=this;return adventure_wizard_regeneratorRuntime().wrap((function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.showJournal(this.journals.find((function(a){return a.name==t&&a.flags.dsa5.parent==r.selectedChapter})));case 2:case"end":return a.stop()}}),_callee7,this)}))),function loadJournal(t){return T.apply(this,arguments)})},{key:"loadJournalById",value:(S=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee8(t){return adventure_wizard_regeneratorRuntime().wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.showJournal(this.journals.find((function(r){return r.id==t})));case 2:case"end":return r.stop()}}),_callee8,this)}))),function loadJournalById(t){return S.apply(this,arguments)})},{key:"resaveBreadCrumbs",value:(x=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee9(t){var r,a,o,i;return adventure_wizard_regeneratorRuntime().wrap((function _callee9$(c){for(;;)switch(c.prev=c.next){case 0:r={},a=adventure_wizard_createForOfIteratorHelper(t.getElementsByTagName("div"));try{for(a.s();!(o=a.n()).done;)i=o.value,r[i.dataset.uuid]=i.innerText}catch(t){a.e(t)}finally{a.f()}return c.next=5,game.settings.set("dsa5","breadcrumbs",JSON.stringify(r));case 5:case"end":return c.stop()}}),_callee9)}))),function resaveBreadCrumbs(t){return x.apply(this,arguments)})},{key:"filterToc",value:(k=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee10(t){var r,a;return adventure_wizard_regeneratorRuntime().wrap((function _callee10$(o){for(;;)switch(o.prev=o.next){case 0:if(null==t){o.next=23;break}if(""==(t=t.toLowerCase().trim())){o.next=19;break}if(a=[],!this.fulltextsearch){o.next=14;break}if(this.journalIndex){o.next=9;break}return this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),o.next=9,this.journalIndex.add(this.journals.map((function(t){return new ze(t)})));case 9:return o.next=11,this.journalIndex.search(t);case 11:a=o.sent,o.next=15;break;case 14:a=this.journals.filter((function(r){return-1!=r.name.toLowerCase().trim().indexOf(t)}));case 15:a=a.map((function(t){return'<li class="fas fa-caret-right"><a data-jid="'.concat(t.id,'" class="subChapter">').concat(t.name,"</a></li>")})),$(this._element).find(".tocContent").html("<ul>".concat(a.join("\n"),"</ul>")),o.next=23;break;case 19:return o.next=21,this.getToc();case 21:r=o.sent,$(this._element).find(".adventureWizard > .row-section > .toc").html(r).find(".filterJournals").focus();case 23:case"end":return o.stop()}}),_callee10,this)}))),function filterToc(t){return k.apply(this,arguments)})},{key:"showJournal",value:(w=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee11(t){var r,a,o,i,c,u,l,p=this;return adventure_wizard_regeneratorRuntime().wrap((function _callee11$(d){for(;;)switch(d.prev=d.next){case 0:r="",a=adventure_wizard_createForOfIteratorHelper(t.pages);try{for(a.s();!(o=a.n()).done;)"text"==(i=o.value).type?r+=i.text.content:"image"==i.type?r+='<img src="'.concat(i.src,'"/>'):ui.notifications.warn("Page type ".concat(i.type," not supported by the journal browser yet"))}catch(t){a.e(t)}finally{a.f()}return c=this.findSceneNote(t.getFlag("dsa5","initId")),d.next=6,TextEditor.enrichHTML(r,{secrets:!0,async:!0});case 6:u=d.sent,this.content='<div><h1 class="journalHeader" data-uuid="'.concat(t.uuid,'">').concat(t.name,'<div class="jrnIcons">').concat(c,'<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>').concat(u),(l=$(this._element).find(".chapter")).html(this.content),bindImgToCanvasDragStart(l),l.find(".documentName-link, .entity-link").click((function(t){var r=$(t.currentTarget);p.bookData&&r.attr("data-pack")==p.bookData.journal&&(t.stopPropagation(),p.loadJournalById(r.attr("data-id")))}));case 12:case"end":return d.stop()}}),_callee11,this)}))),function showJournal(t){return w.apply(this,arguments)})},{key:"findSceneNote",value:function findSceneNote(t){if(t){var r=game.journal.find((function(r){return r.getFlag("dsa5","initId")==t}));if(r&&r.sceneNote)return'<a class="showMapNote" data-entryId="'.concat(r.id,'"><i class="fas fa-map-pin"></i></a>')}return""}},{key:"importBook",value:(b=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee12(){return adventure_wizard_regeneratorRuntime().wrap((function _callee12$(t){for(;;)switch(t.prev=t.next){case 0:game.user.isGM&&(new Fe).render(this.bookData.moduleName);case 1:case"end":return t.stop()}}),_callee12,this)}))),function importBook(){return b.apply(this,arguments)})},{key:"loadBook",value:(v=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee15(t,r,a){var o=this;return adventure_wizard_regeneratorRuntime().wrap((function _callee15$(i){for(;;)switch(i.prev=i.next){case 0:return a||(a=this.currentType),this.currentType=a,this.book=this[a].find((function(r){return r.id==t})),i.next=5,fetch(this.book.path).then(function(){var t=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee13(t){return adventure_wizard_regeneratorRuntime().wrap((function _callee13$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.json());case 1:case"end":return r.stop()}}),_callee13)})));return function(r){return t.apply(this,arguments)}}()).then(function(){var t=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee14(t){var a,i;return adventure_wizard_regeneratorRuntime().wrap((function _callee14$(c){for(;;)switch(c.prev=c.next){case 0:return o.bookData=t,a=game.packs.get(t.journal),c.next=4,a.getIndex();case 4:return c.sent,c.next=7,a.getDocuments();case 7:if(i=c.sent,o.journals=i,!t.actors){c.next=15;break}return a=game.packs.get(t.actors),c.next=13,a.getIndex();case 13:i=c.sent,o.actors=i;case 15:if(!t.scenes){c.next=21;break}return a=game.packs.get(t.scenes),c.next=19,a.getIndex();case 19:i=c.sent,o.scenes=i;case 21:o.loadPage(r);case 22:case"end":return c.stop()}}),_callee14)})));return function(r){return t.apply(this,arguments)}}());case 5:case"end":return i.stop()}}),_callee15,this)}))),function loadBook(t,r,a){return v.apply(this,arguments)})},{key:"prefillActors",value:(g=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee16(t){var r,a,o,i,c,u,l=this;return adventure_wizard_regeneratorRuntime().wrap((function _callee16$(p){for(;;)switch(p.prev=p.next){case 0:if(t.actors){p.next=2;break}return p.abrupt("return",[]);case 2:return r=[],p.next=5,game.folders.contents.find((function(t){return t.name==game.i18n.localize("".concat(l.bookData.moduleName,".name"))&&"Actor"==t.type&&null==t.folder}));case 5:if(!(a=p.sent)){p.next=12;break}return p.next=9,game.folders.contents.filter((function(t){var r;return"Actor"==t.type&&(null===(r=t.folder)||void 0===r?void 0:r.id)==a.id})).map((function(t){return t.id}));case 9:p.t0=p.sent,p.next=13;break;case 12:p.t0=void 0;case 13:o=p.t0,i=adventure_wizard_createForOfIteratorHelper(t.actors);try{for(u=function _loop(){var t,a,i,u=c.value,p=null!=o&&o.length?game.actors.contents.find((function(t){var r;return t.name==u&&o.includes(null===(r=t.folder)||void 0===r?void 0:r.id)})):void 0,d=void 0,h=null===(t=p)||void 0===t?void 0:t.id,m=null===(a=p)||void 0===a?void 0:a.uuid;p||(p=l.actors.find((function(t){return t.name==u})),d=l.bookData.actors,h=null===(i=p)||void 0===i?void 0:i._id,m=p?"Compendium.".concat(d,".").concat(h):void 0),r.push({name:u,actor:p,pack:d,id:h,uuid:m})},i.s();!(c=i.n()).done;)u()}catch(t){i.e(t)}finally{i.f()}return p.abrupt("return",r);case 17:case"end":return p.stop()}}),_callee16)}))),function prefillActors(t){return g.apply(this,arguments)})},{key:"popJournal",value:(y=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee17(t){return adventure_wizard_regeneratorRuntime().wrap((function _callee17$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,fromUuid(t);case 2:r.sent.sheet.render(!0);case 4:case"end":return r.stop()}}),_callee17)}))),function popJournal(t){return y.apply(this,arguments)})},{key:"showSzene",value:(m=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee18(t){var r,a,o=arguments;return adventure_wizard_regeneratorRuntime().wrap((function _callee18$(i){for(;;)switch(i.prev=i.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:"activate",a=game.scenes.contents.find((function(r){return r.name==t}))){i.next=4;break}return i.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.sceneNotInitialized")));case 4:i.t0=r,i.next="activate"===i.t0?7:"view"===i.t0?9:"toggle"===i.t0?11:13;break;case 7:return a.activate(),i.abrupt("break",13);case 9:return a.view(),i.abrupt("break",13);case 11:return a.update({navigation:!a.navigation}),i.abrupt("break",13);case 13:case"end":return i.stop()}}),_callee18)}))),function showSzene(t){return m.apply(this,arguments)})},{key:"getChapter",value:(d=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee19(){var t,r,a,o,i,c,u,l=this;return adventure_wizard_regeneratorRuntime().wrap((function _callee19$(p){for(;;)switch(p.prev=p.next){case 0:if(!this.book){p.next=41;break}if(!this.content){p.next=3;break}return p.abrupt("return",this.content);case 3:if(!this.selectedChapter){p.next=36;break}if("prep"!=this.selectedChapter){p.next=14;break}t={initDescr:game.i18n.format("".concat(this.bookData.moduleName,".importContent"),{defaultText:game.i18n.localize("importDefault")})},r=this.bookData.modules,a=adventure_wizard_createForOfIteratorHelper(r);try{for(a.s();!(o=a.n()).done;)(i=o.value).enabled=this.moduleEnabled(i.id)}catch(t){a.e(t)}finally{a.f()}return p.next=11,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_preparation.html",{modules:r,info:t});case 11:case 17:case 30:case 35:case 38:case 43:return p.abrupt("return",p.sent);case 14:if("foundryUsage"!=this.selectedChapter){p.next=18;break}return p.next=17,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_foundry.html");case 18:if(c=this.bookData.chapters.find((function(t){return t.name==l.selectedType})).content.find((function(t){return t.id==l.selectedChapter})),u=this.getSubChapters(),!c.scenes&&!c.actors&&0!=u.length){p.next=33;break}return p.t0=renderTemplate,p.t1=c,p.t2=this.getSubChapters(),p.next=26,this.prefillActors(c);case 26:return p.t3=p.sent,p.t4={chapter:p.t1,subChapters:p.t2,actors:p.t3},p.next=30,(0,p.t0)("systems/dsa5/templates/wizard/adventure/adventure_chapter.html",p.t4);case 33:return p.next=35,this.loadJournal(u[0].name);case 36:return p.next=38,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData});case 41:return p.next=43,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM});case 44:case"end":return p.stop()}}),_callee19,this)}))),function getChapter(){return d.apply(this,arguments)})},{key:"filterBooks",value:function filterBooks(t){var r,a=game.settings.get("dsa5","expansionPermissions"),o=adventure_wizard_createForOfIteratorHelper(t);try{for(o.s();!(r=o.n()).done;){var i=r.value;null!=a[i.id]&&(i.visible=a[i.id])}}catch(t){o.e(t)}finally{o.f()}return game.user.isGM?t:t.filter((function(t){return null==t.visible||t.visible})).sort((function(t,r){return t.id.localeCompare(r.id)}))}},{key:"getSubChapters",value:function getSubChapters(){var t=this;return this.journals.filter((function(r){return r.flags.dsa5.parent==t.selectedChapter})).sort((function(t,r){return t.flags.dsa5.sort>r.flags.dsa5.sort?1:-1})).map((function(t){return{name:t.name,id:t.id}}))}},{key:"getToc",value:(p=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee20(){var t,r,a,o,i,c=this;return adventure_wizard_regeneratorRuntime().wrap((function _callee20$(u){for(;;)switch(u.prev=u.next){case 0:if(t=[],!this.book){u.next=29;break}if(t.push.apply(t,adventure_wizard_toConsumableArray(duplicate(this.bookData.chapters))),!this.selectedChapter){u.next=24;break}a=adventure_wizard_createForOfIteratorHelper(t),u.prev=5,a.s();case 7:if((o=a.n()).done){u.next=14;break}if(i=o.value,!(r=i.content.find((function(t){return t.id==c.selectedChapter})))){u.next=12;break}return u.abrupt("break",14);case 12:u.next=7;break;case 14:u.next=19;break;case 16:u.prev=16,u.t0=u.catch(5),a.e(u.t0);case 19:return u.prev=19,a.f(),u.finish(19);case 22:r.cssClass="selected",r.subChapters=this.getSubChapters();case 24:return u.next=26,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_toc.html",{chapters:t,book:this.book,fulltextsearch:this.fulltextsearch?"on":""});case 26:return u.abrupt("return",u.sent);case 29:return u.abrupt("return",'<div class="libraryImg"></div>');case 30:case"end":return u.stop()}}),_callee20,this,[[5,16,19,22]])}))),function getToc(){return p.apply(this,arguments)})},{key:"loadPage",value:(l=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee21(t){var r,a;return adventure_wizard_regeneratorRuntime().wrap((function _callee21$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.getChapter();case 2:return r=o.sent,o.next=5,this.getToc();case 5:a=o.sent,t.find(".toc").html(a),t.find(".chapter").html(r);case 8:case"end":return o.stop()}}),_callee21,this)}))),function loadPage(t){return l.apply(this,arguments)})},{key:"getData",value:(i=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee22(t){var r,a,o;return adventure_wizard_regeneratorRuntime().wrap((function _callee22$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,adventure_wizard_get(adventure_wizard_getPrototypeOf(BookWizard.prototype),"getData",this).call(this,t);case 2:return r=i.sent,i.next=5,this.getChapter();case 5:return a=i.sent,i.next=8,this.getToc();case 8:return o=i.sent,mergeObject(r,{adventure:this.bookData,currentChapter:a,breadcrumbs:this.renderBreadcrumbs(),toc:o}),i.abrupt("return",r);case 11:case"end":return i.stop()}}),_callee22,this)}))),function getData(t){return i.apply(this,arguments)})},{key:"pinJournal",value:(o=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee23(t){var r,a,o,i=arguments;return adventure_wizard_regeneratorRuntime().wrap((function _callee23$(c){for(;;)switch(c.prev=c.next){case 0:if(a=i.length>1&&void 0!==i[1]?i[1]:void 0,o=this.readBreadCrumbs(),a){c.next=18;break}return c.next=5,fromUuid(t);case 5:if(c.t2=r=c.sent,c.t1=null===c.t2,c.t1){c.next=9;break}c.t1=void 0===r;case 9:if(!c.t1){c.next=13;break}c.t3=void 0,c.next=14;break;case 13:c.t3=r.name;case 14:if(c.t0=c.t3,c.t0){c.next=17;break}c.t0="";case 17:a=c.t0;case 18:o[t]=a,game.settings.set("dsa5","breadcrumbs",JSON.stringify(o)),this.render(!0);case 21:case"end":return c.stop()}}),_callee23,this)}))),function pinJournal(t){return o.apply(this,arguments)})},{key:"unpinJournal",value:function unpinJournal(t){var r=this.readBreadCrumbs();delete r[t],game.settings.set("dsa5","breadcrumbs",JSON.stringify(r)),this.render(!0)}},{key:"_canDragDrop",value:function _canDragDrop(t){return!0}},{key:"_onDrop",value:(a=adventure_wizard_asyncToGenerator(adventure_wizard_regeneratorRuntime().mark((function _callee24(t){var r;return adventure_wizard_regeneratorRuntime().wrap((function _callee24$(a){for(;;)switch(a.prev=a.next){case 0:a.prev=0,r=JSON.parse(t.dataTransfer.getData("text/plain")),a.next=7;break;case 4:return a.prev=4,a.t0=a.catch(0),a.abrupt("return",!1);case 7:"JournalEntry"==r.type&&this.pinJournal(r.pack?"Compendium.".concat(r.pack,".").concat(r.id):"JournalEntry.".concat(r.id));case 8:case"end":return a.stop()}}),_callee24,this,[[0,4]])}))),function _onDrop(t){return a.apply(this,arguments)})},{key:"readBreadCrumbs",value:function readBreadCrumbs(){var t={};try{t=JSON.parse(game.settings.get("dsa5","breadcrumbs"))}catch(t){console.log("No Journalbrowser notes found")}return t}},{key:"renderBreadcrumbs",value:function renderBreadcrumbs(){var t=this.readBreadCrumbs(),r=Object.entries(t).map((function(t){return'<div data-tooltip="'.concat(t[1],'" data-uuid="').concat(t[0],'" class="openPin item">').concat(t[1],"</div>")}));return r.length>0?'<div id"breadcrumbs" class="breadcrumbs wrap row-section">'.concat(r.join(""),"</div>"):""}},{key:"moduleEnabled",value:function moduleEnabled(r){return t.Z.moduleEnabled(r)}}],[{key:"defaultOptions",get:function get(){var t=adventure_wizard_get(adventure_wizard_getPrototypeOf(BookWizard),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(t,{classes:t.classes.concat(["dsa5","largeDialog","noscrollWizard","bookWizardsheet"]),width:800,height:880,template:"systems/dsa5/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),t}},{key:"initHook",value:function initHook(){BookWizard.wizard=new BookWizard,game.dsa5.apps.journalBrowser=BookWizard.wizard,Hooks.on("renderSidebarTab",(function(t,r){if("journal"==t.options.id){var a=$('<div class="header-actions action-buttons flexrow"></div>'),o=$('<button id="openJournalBrowser"><i class="fa fa-book"></i>'.concat(game.i18n.localize("Book.Wizard"),"</button>"));o.click((function(){BookWizard.wizard.render(!0)})),a.append(o),r.find(".header-actions:first-child").after(a)}}))}}]),BookWizard}();!function adventure_wizard_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}(je,"wizard",void 0);var Fe=function(t){adventure_wizard_inherits(InitializerForm,FormApplication);var r=adventure_wizard_createSuper(InitializerForm);function InitializerForm(){return adventure_wizard_classCallCheck(this,InitializerForm),r.apply(this,arguments)}return adventure_wizard_createClass(InitializerForm,[{key:"render",value:function render(t){new game.dsa5.apps.DSA5Initializer("DSA5 Module Initialization",game.i18n.format("".concat(t,".importContent"),{defaultText:game.i18n.localize("importDefault")}),t,game.i18n.lang).render(!0)}}]),InitializerForm}(),ze=function(){function JournalSearch(t){adventure_wizard_classCallCheck(this,JournalSearch);var r=t.pages.find((function(t){return!0})).text.content;this.document={name:t.name,data:$("<div>").html(r).text(),id:t.id}}return adventure_wizard_createClass(JournalSearch,[{key:"name",get:function get(){return this.document.name}},{key:"data",get:function get(){return this.document.data}},{key:"id",get:function get(){return this.document.id}}]),JournalSearch}();function masters_menu_typeof(t){return masters_menu_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},masters_menu_typeof(t)}function masters_menu_slicedToArray(t,r){return function masters_menu_arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function masters_menu_iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||masters_menu_unsupportedIterableToArray(t,r)||function masters_menu_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function masters_menu_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=masters_menu_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function masters_menu_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return masters_menu_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?masters_menu_arrayLikeToArray(t,r):void 0}}function masters_menu_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function masters_menu_regeneratorRuntime(){masters_menu_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==masters_menu_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function masters_menu_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function masters_menu_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){masters_menu_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){masters_menu_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function masters_menu_get(){return masters_menu_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=masters_menu_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},masters_menu_get.apply(this,arguments)}function masters_menu_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=masters_menu_getPrototypeOf(t)););return t}function masters_menu_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&masters_menu_setPrototypeOf(t,r)}function masters_menu_setPrototypeOf(t,r){return masters_menu_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},masters_menu_setPrototypeOf(t,r)}function masters_menu_createSuper(t){var r=function masters_menu_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=masters_menu_getPrototypeOf(t);if(r){var i=masters_menu_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return masters_menu_possibleConstructorReturn(this,a)}}function masters_menu_possibleConstructorReturn(t,r){if(r&&("object"===masters_menu_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function masters_menu_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function masters_menu_getPrototypeOf(t){return masters_menu_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},masters_menu_getPrototypeOf(t)}function masters_menu_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function masters_menu_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function masters_menu_createClass(t,r,a){return r&&masters_menu_defineProperties(t.prototype,r),a&&masters_menu_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}var Ne=function(){function MastersMenu(){masters_menu_classCallCheck(this,MastersMenu)}return masters_menu_createClass(MastersMenu,null,[{key:"registerButtons",value:function registerButtons(){game.dsa5.apps.playerMenu=new _e,CONFIG.Canvas.layers.dsamenu={layerClass:He,group:"interface"},Hooks.on("getSceneControlButtons",(function(r){var a=[{name:"JournalBrowser",title:game.i18n.localize("Book.Wizard"),icon:"fa fa-book",button:!0,onClick:function onClick(){t.Z.renderToggle(game.dsa5.apps.journalBrowser)}},{name:"Library",title:game.i18n.localize("SHEET.Library"),icon:"fas fa-university",button:!0,onClick:function onClick(){t.Z.renderToggle(game.dsa5.itemLibrary)}},{name:"PlayerMenu",title:game.i18n.localize("PLAYER.title"),icon:"fas fa-dsa5-player",button:!0,onClick:function onClick(){t.Z.renderToggle(game.dsa5.apps.playerMenu)}}];game.user.isGM&&(game.dsa5.apps.gameMasterMenu||(game.dsa5.apps.gameMasterMenu=new $e),a.push({name:"mastersMenu",title:game.i18n.localize("gmMenu"),icon:"fa fa-dsa5",button:!0,onClick:function onClick(){t.Z.renderToggle(game.dsa5.apps.gameMasterMenu)}})),r.push({name:"GM Menu",title:game.i18n.localize("gmMenu"),icon:"fas fa-dsa5",layer:"dsamenu",tools:a})}))}}]),MastersMenu}(),He=function(t){masters_menu_inherits(DSAMenuLayer,InteractionLayer);var r=masters_menu_createSuper(DSAMenuLayer);function DSAMenuLayer(){return masters_menu_classCallCheck(this,DSAMenuLayer),r.apply(this,arguments)}return masters_menu_createClass(DSAMenuLayer,[{key:"selectObjects",value:function selectObjects(t){canvas.tokens.selectObjects(t)}}],[{key:"layerOptions",get:function get(){return foundry.utils.mergeObject(masters_menu_get(masters_menu_getPrototypeOf(DSAMenuLayer),"layerOptions",this),{name:"dsamenu",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}}]),DSAMenuLayer}(),$e=function(r){masters_menu_inherits(GameMasterMenu,Application);var o,i,c,u,l,p,d,m,g,v,_,b,w,k,x,S=masters_menu_createSuper(GameMasterMenu);function GameMasterMenu(t){var r;return masters_menu_classCallCheck(this,GameMasterMenu),(r=S.call(this,t)).selected={},r.heros=[],r.lastSkill="".concat(game.i18n.localize("LocalizedIDs.perception"),"|skill"),r.randomCreation=[],game.user.isGM&&(Hooks.on("updateActor",function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee(t,a,o,i){var c;return masters_menu_regeneratorRuntime().wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:c=["system.status.fatePoints","system.status.wounds","system.status.karmaenergy","system.status.astralenergy"],r.heros.find((function(r){return r.id==t.id}))&&c.reduce((function(t,r){return t||hasProperty(a,r)}),!1)&&r.render();case 2:case"end":return o.stop()}}),_callee)})));return function(r,a,o,i){return t.apply(this,arguments)}}()),Hooks.on("updateScene",function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee2(t,a,o,i){var c;return masters_menu_regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:c=["darkness"],game.canvas.id==t.id&&c.reduce((function(t,r){return t||hasProperty(a,r)}),!1)&&(game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.onDarknessChange(),r.render());case 2:case"end":return o.stop()}}),_callee2)})));return function(r,a,o,i){return t.apply(this,arguments)}}()),Hooks.on("canvasInit",(function(){r.render()}))),r}return masters_menu_createClass(GameMasterMenu,[{key:"_render",value:(x=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee3(){var t,r,a=arguments;return masters_menu_regeneratorRuntime().wrap((function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:if(t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},game.user.isGM){o.next=4;break}return o.abrupt("return",ui.notifications.error("DSAError.onlyGMallowed"));case 4:return o.next=6,masters_menu_get(masters_menu_getPrototypeOf(GameMasterMenu.prototype),"_render",this).call(this,t,r);case 6:case"end":return o.stop()}}),_callee3,this)}))),function _render(){return x.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;masters_menu_get(masters_menu_getPrototypeOf(GameMasterMenu.prototype),"activateListeners",this).call(this,t),t.find("select.select2").select2(),t.find(".heroLink").click((function(t){t.stopPropagation(),game.actors.get(r.getID(t)).sheet.render(!0)})),t.find(".heroSelector").change((function(t){t.stopPropagation(),r.selected[r.getID(t)]=$(t.currentTarget).is(":checked")})),t.find(".skillSelektor").change((function(t){t.stopPropagation(),r.lastSkill=$(t.currentTarget).val()})),t.find(".rollChar").click((function(t){t.stopPropagation(),r.rollAbility([r.getID(t)])})),t.find(".rollAll").click((function(t){t.stopPropagation(),r.rollAbility(r.selectedIDs())})),t.find(".pay").click((function(t){t.stopPropagation(),r.doPayment([r.getID(t)],!0)})),t.find(".actorItem").click(function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee4(t){var r;return masters_menu_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return t.stopPropagation(),r=$(t.currentTarget).attr("data-uuid"),a.next=4,fromUuid(r);case 4:a.sent.sheet.render(!0);case 6:case"end":return a.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()),t.find(".getPaid").click((function(t){t.stopPropagation(),r.doPayment([r.getID(t)],!1)})),t.find(".payAll").click((function(t){t.stopPropagation(),r.doPayment(r.selectedIDs(t),!0)})),t.find(".getPaidAll").click((function(t){t.stopPropagation(),r.doPayment(r.selectedIDs(t),!1)})),t.find(".selectAll").change((function(r){r.stopPropagation();var a=t.find(".heroSelector");a.prop("checked",$(r.currentTarget).is(":checked")),a.change()})),t.find(".exp").click((function(t){t.stopPropagation(),r.getExp([r.getID(t)])})),t.find(".expAll").click((function(t){t.stopPropagation(),r.getExp(r.selectedIDs())})),t.find(".randomPlayer").mousedown((function(a){a.stopPropagation(),r.randomPlayer(t,a)})),t.find(".heroSelector").click((function(t){return t.stopPropagation()})),t.find(".hero").click((function(t){t.stopPropagation(t),$(t.currentTarget).find(".expandDetails").fadeToggle()}));var a=function deletehand(t){return r._deleteHero(t)};t.find(".hero").mouseenter((function(t){if(0==t.currentTarget.getElementsByClassName("hovermenu").length){var r=document.createElement("div");r.classList.add("hovermenu");var o=document.createElement("i");o.classList.add("fas","fa-times"),o.title=game.i18n.localize("SHEET.DeleteItem"),o.addEventListener("click",a,!1),r.appendChild(o),t.currentTarget.appendChild(r)}})),t.find(".hero").mouseleave((function(t){var a=t.toElement||t.relatedTarget;a&&a.parentNode!=r&&a!=r&&t.currentTarget.querySelectorAll(".hovermenu").forEach((function(t){return t.remove()}))})),t.find(".addGroupSchip").click(function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee5(t){return masters_menu_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,r.changeGroupSchipCount(Number($(t.currentTarget).attr("data-value")));case 2:case"end":return a.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}()),t.find(".groupschip").click((function(t){r.changeGroupSchip(t)})),t.find(".heroschip").click((function(t){t.stopPropagation(),t.preventDefault();var a=Number(t.currentTarget.getAttribute("data-val"));1==a&&1==$(t.currentTarget).closest(".hero").find(".fullSchip").length&&(a=0),game.actors.get(r.getID(t)).update({"system.status.fatePoints.value":a})})),t.find(".groupCheck").click((function(t){t.stopPropagation(),r.doGroupCheck()})),t.find(".changeSetting").change(function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee6(t){return masters_menu_regeneratorRuntime().wrap((function _callee6$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,game.settings.set("dsa5",t.currentTarget.name,t.currentTarget.checked);case 2:case"end":return r.stop()}}),_callee6)})));return function(r){return t.apply(this,arguments)}}()),t.find(".changeSightTreshold").change(function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee7(t){return masters_menu_regeneratorRuntime().wrap((function _callee7$(a){for(;;)switch(a.prev=a.next){case 0:$(t.currentTarget).closest(".row-section").find(".range-value").text(t.currentTarget.value),r.updateSightThreshold(t);case 2:case"end":return a.stop()}}),_callee7)})));return function(r){return t.apply(this,arguments)}}()),t.find(".updateDarkness").change(function(){var t=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee8(t){return masters_menu_regeneratorRuntime().wrap((function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:$(t.currentTarget).closest(".row-section").find(".range-value").text(t.currentTarget.value),r.updateDarkness(t);case 2:case"end":return a.stop()}}),_callee8)})));return function(r){return t.apply(this,arguments)}}());var o,i=masters_menu_createForOfIteratorHelper(this.randomCreation);try{for(i.s();!(o=i.n()).done;){o.value.activateListeners(t)}}catch(t){i.e(t)}finally{i.f()}(0,h.Jp)(t,".heros",this.updateHeroOrder,".hero"),t.on("dragstart",".hero",(function(t){t.stopPropagation();var r={type:"Actor",uuid:t.currentTarget.dataset.uuid};t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(r))})),t.find(".dragEveryone").each((function(t,r){r.setAttribute("draggable",!0)})),t.on("dragstart",".dragEveryone",(function(t){t.stopPropagation();t.currentTarget;var a={type:"GroupDrop",ids:r.selectedIDs()};t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(a))})),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.activateButtonListener(t)}},{key:"_deleteHero",value:(k=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee9(t){var r,a,o;return masters_menu_regeneratorRuntime().wrap((function _callee9$(i){for(;;)switch(i.prev=i.next){case 0:if(t.stopPropagation(),t.preventDefault(),r=$(t.currentTarget).closest(".hero").attr("data-id"),a=game.settings.get("dsa5","trackedActors").actors||[],!((o=a.indexOf(r))>-1)){i.next=10;break}return a.splice(o,1),i.next=9,game.settings.set("dsa5","trackedActors",{actors:a});case 9:this.render(!0);case 10:case"end":return i.stop()}}),_callee9,this)}))),function _deleteHero(t){return k.apply(this,arguments)})},{key:"updateHeroOrder",value:(w=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee10(t){var r,a,o,i;return masters_menu_regeneratorRuntime().wrap((function _callee10$(c){for(;;)switch(c.prev=c.next){case 0:r=[],a=masters_menu_createForOfIteratorHelper(t.querySelectorAll(".hero"));try{for(a.s();!(o=a.n()).done;)i=o.value,r.push(i.dataset.id)}catch(t){a.e(t)}finally{a.f()}return c.next=5,game.settings.set("dsa5","trackedActors",{actors:r});case 5:case"end":return c.stop()}}),_callee10)}))),function updateHeroOrder(t){return w.apply(this,arguments)})},{key:"updateDarkness",value:(b=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee11(t){return masters_menu_regeneratorRuntime().wrap((function _callee11$(r){for(;;)switch(r.prev=r.next){case 0:canvas.scene&&canvas.scene.update({darkness:Number(t.currentTarget.value)},{animateDarkness:3e3});case 1:case"end":return r.stop()}}),_callee11)}))),function updateDarkness(t){return b.apply(this,arguments)})},{key:"updateSightThreshold",value:(_=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee12(t){var r,a,o;return masters_menu_regeneratorRuntime().wrap((function _callee12$(i){for(;;)switch(i.prev=i.next){case 0:return r=Number(t.currentTarget.dataset.index),a=Number(t.currentTarget.value),(o=game.settings.get("dsa5","sightOptions").split("|"))[r]=a,i.next=6,game.settings.set("dsa5","sightOptions",o.join("|"));case 6:case"end":return i.stop()}}),_callee12)}))),function updateSightThreshold(t){return _.apply(this,arguments)})},{key:"getGroupSchipSetting",value:function getGroupSchipSetting(){return game.settings.get("dsa5","groupschips").split("/").map((function(t){return Number(t)}))}},{key:"changeGroupSchipCount",value:(v=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee13(t){var r;return masters_menu_regeneratorRuntime().wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:return(r=this.getGroupSchipSetting())[1]=Math.max(0,r[1]+t),r[0]=Math.min(r[1],r[0]),a.next=5,game.settings.set("dsa5","groupschips",r.join("/"));case 5:case"end":return a.stop()}}),_callee13,this)}))),function changeGroupSchipCount(t){return v.apply(this,arguments)})},{key:"changeGroupSchip",value:(g=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee14(t){var r,a;return masters_menu_regeneratorRuntime().wrap((function _callee14$(o){for(;;)switch(o.prev=o.next){case 0:return 1==(r=Number(t.currentTarget.getAttribute("data-val")))&&1==$(t.currentTarget).closest(".col").find(".fullSchip").length&&(r=0),(a=this.getGroupSchipSetting())[0]=r,o.next=6,game.settings.set("dsa5","groupschips",a.join("/"));case 6:case"end":return o.stop()}}),_callee14,this)}))),function changeGroupSchip(t){return g.apply(this,arguments)})},{key:"randomPlayer",value:(m=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee15(t,r){var o,i,c,u,l,p,d,h,m,y=this;return masters_menu_regeneratorRuntime().wrap((function _callee15$(g){for(;;)switch(g.prev=g.next){case 0:o=t.find(".hero"),i=2==r.button,c={},u=1,l=t.find(".heroSelector:checked").length>0,p=masters_menu_createForOfIteratorHelper(this.heros),g.prev=6,p.s();case 8:if((d=p.n()).done){g.next=17;break}if(h=d.value,this.selected[h.id]||!l){g.next=12;break}return g.abrupt("continue",15);case 12:c[u]=h.id,u++,i&&a.Z.hasVantage(h,game.i18n.localize("LocalizedIDs.misfortune"))&&(c[u]=h.id,u++);case 15:g.next=8;break;case 17:g.next=22;break;case 19:g.prev=19,g.t0=g.catch(6),p.e(g.t0);case 22:return g.prev=22,p.f(),g.finish(22);case 25:return g.next=27,new Roll("1d".concat(u-1)).evaluate({async:!0});case 27:m=g.sent.total,$(r.currentTarget).find("i").addClass("fa-spin"),o.removeClass("victim"),setTimeout((function(){$(y._element).find('.hero[data-id="'.concat(c[m],'"]')).addClass("victim"),$(r.currentTarget).find("i").removeClass("fa-spin")}),500);case 31:case"end":return g.stop()}}),_callee15,this,[[6,19,22,25]])}))),function randomPlayer(t,r){return m.apply(this,arguments)})},{key:"doPayment",value:(d=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee16(t,r){var a,o,i,c;return masters_menu_regeneratorRuntime().wrap((function _callee16$(u){for(;;)switch(u.prev=u.next){case 0:return a=game.actors.filter((function(r){return t.includes(r.id)})),o=this.getNames(a),u.next=4,renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format(r?"MASTER.payText":"MASTER.getPaidText",{heros:o}))});case 4:i=u.sent,c=function callback(t){var o,i=t.find(".input-text").val(),c=masters_menu_createForOfIteratorHelper(a);try{for(c.s();!(o=c.n()).done;){var u=o.value;fe.handlePayAction(void 0,r,i,u)}}catch(t){c.e(t)}finally{c.f()}},this.buildDialog(game.i18n.localize(r?"MASTER.payTT":"PAYMENT.payButton"),i,c);case 7:case"end":return u.stop()}}),_callee16,this)}))),function doPayment(t,r){return d.apply(this,arguments)})},{key:"getPaid",value:(p=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee17(t){return masters_menu_regeneratorRuntime().wrap((function _callee17$(r){for(;;)switch(r.prev=r.next){case 0:this.doPayment(t,!1);case 1:case"end":return r.stop()}}),_callee17,this)}))),function getPaid(t){return p.apply(this,arguments)})},{key:"getExp",value:(l=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee19(r){var a,o,i,c=this;return masters_menu_regeneratorRuntime().wrap((function _callee19$(u){for(;;)switch(u.prev=u.next){case 0:return a=game.actors.filter((function(t){return r.includes(t.id)})),u.next=3,renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.awardXPText",{heros:this.getNames(a)}))});case 3:o=u.sent,i=function(){var r=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee18(r){var o,i,u,l,p,d,h,m;return masters_menu_regeneratorRuntime().wrap((function _callee18$(g){for(;;)switch(g.prev=g.next){case 0:if(o=Number(r.find(".input-text").val()),i=Math.max(1,Math.round(.25*o)),u=[],l=[],isNaN(o)){g.next=30;break}p=masters_menu_createForOfIteratorHelper(a),g.prev=6,p.s();case 8:if((d=p.n()).done){g.next=16;break}return h=d.value,m=o,y.Z.isFamiliar(h)||y.Z.isPet(h)?(m=i,l.push(h)):u.push(h),g.next=14,h.update({"system.details.experience.total":h.system.details.experience.total+m});case 14:g.next=8;break;case 16:g.next=21;break;case 18:g.prev=18,g.t0=g.catch(6),p.e(g.t0);case 21:return g.prev=21,p.f(),g.finish(21);case 24:if(!(u.length>0)){g.next=27;break}return g.next=27,ChatMessage.create(t.Z.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:c.getNames(u),number:o})));case 27:if(!(l.length>0)){g.next=30;break}return g.next=30,ChatMessage.create(t.Z.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:c.getNames(l),number:o})));case 30:case"end":return g.stop()}}),_callee18,null,[[6,18,21,24]])})));return function callback(t){return r.apply(this,arguments)}}(),this.buildDialog(game.i18n.localize("MASTER.awardXP"),o,i);case 6:case"end":return u.stop()}}),_callee19,this)}))),function getExp(t){return l.apply(this,arguments)})},{key:"getNames",value:function getNames(t){return t.map((function(t){return t.name})).join(", ")}},{key:"buildDialog",value:function buildDialog(t,r,a){new Dialog({title:t,content:r,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(t){a(t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}},{key:"_canDragDrop",value:function _canDragDrop(t){return!0}},{key:"_onDrop",value:(u=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee20(t){var r,a;return masters_menu_regeneratorRuntime().wrap((function _callee20$(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,r=JSON.parse(t.dataTransfer.getData("text/plain")),o.next=4,Actor.implementation.fromDropData(r);case 4:r=o.sent,o.next=10;break;case 7:return o.prev=7,o.t0=o.catch(0),o.abrupt("return",!1);case 10:if("Actor"!=r.documentName){o.next=18;break}if(-1!=(a=(a=game.settings.get("dsa5","trackedActors")).actors||[]).indexOf(r.id)||r.pack){o.next=18;break}return a.push(r.id),o.next=17,game.settings.set("dsa5","trackedActors",{actors:a});case 17:this.render(!0);case 18:case"end":return o.stop()}}),_callee20,this,[[0,7]])}))),function _onDrop(t){return u.apply(this,arguments)})},{key:"selectedIDs",value:function selectedIDs(){for(var t=[],r=0,a=Object.entries(this.selected);r<a.length;r++){var o=masters_menu_slicedToArray(a[r],2),i=o[0];o[1]&&t.push(i)}return t.length?t:game.settings.get("dsa5","trackedActors").actors||[]}},{key:"doGroupCheck",value:(c=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee21(){var t,r,a,o,i,c=this;return masters_menu_regeneratorRuntime().wrap((function _callee21$(u){for(;;)switch(u.prev=u.next){case 0:if(t=this.lastSkill.split("|"),r=masters_menu_slicedToArray(t,2),a=r[0],"skill"==r[1]){u.next=3;break}return u.abrupt("return");case 3:return u.next=5,renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.doGroupCheck",{skill:a}))});case 5:o=u.sent,i=function callback(t){var r=Number(t.find(".input-text").val()),a=masters_menu_slicedToArray(c.lastSkill.split("|"),2),o=a[0];"skill"==a[1]&&we.Z.showGCMessage(o,r)},this.buildDialog(game.i18n.localize("HELP.groupcheck"),o,i);case 8:case"end":return u.stop()}}),_callee21,this)}))),function doGroupCheck(){return c.apply(this,arguments)})},{key:"rollAbility",value:function rollAbility(t){var r=masters_menu_slicedToArray(this.lastSkill.split("|"),2),a=r[0];switch(r[1]){case"skill":this.rollSkill(t,a);break;case"attribute":this.rollAttribute(t,a);break;case"regeneration":this.rollRegeneration(t)}}},{key:"rollRegeneration",value:function rollRegeneration(t){var r,a=masters_menu_createForOfIteratorHelper(game.actors.filter((function(r){return t.includes(r.id)})));try{var o=function _loop(){var t=r.value;t.setupRegeneration("regenerate",{rollMode:"blindroll",subtitle:" (".concat(t.name,")")},void 0).then((function(r){t.basicTest(r)}))};for(a.s();!(r=a.n()).done;)o()}catch(t){a.e(t)}finally{a.f()}}},{key:"rollAttribute",value:function rollAttribute(t,r){var a,o=game.actors.filter((function(r){return t.includes(r.id)})),i=Object.keys(game.dsa5.config.characteristics).find((function(t){return game.i18n.localize(game.dsa5.config.characteristics[t])==r})),c=masters_menu_createForOfIteratorHelper(o);try{var u=function _loop2(){var t=a.value;t.setupCharacteristic(i,{rollMode:"blindroll",subtitle:" (".concat(t.name,")")},void 0).then((function(r){t.basicTest(r)}))};for(c.s();!(a=c.n()).done;)u()}catch(t){c.e(t)}finally{c.f()}}},{key:"rollSkill",value:function rollSkill(t,r){var a,o=masters_menu_createForOfIteratorHelper(game.actors.filter((function(r){return t.includes(r.id)})));try{var i=function _loop3(){var t=a.value,o=t.items.find((function(t){return t.name==r&&"skill"==t.type}));t.setupSkill(o,{rollMode:"blindroll",subtitle:" (".concat(t.name,")")},void 0).then((function(r){t.basicTest(r)}))};for(o.s();!(a=o.n()).done;)i()}catch(t){o.e(t)}finally{o.f()}}},{key:"getID",value:function getID(t){return $(t.currentTarget).closest(".hero").attr("data-id")}},{key:"getTrackedHeros",value:(i=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee22(){var t,r;return masters_menu_regeneratorRuntime().wrap((function _callee22$(a){for(;;)switch(a.prev=a.next){case 0:if(t=game.settings.get("dsa5","trackedActors"),r=[],!(t.actors&&t.actors.length>0)){a.next=6;break}r=game.actors.filter((function(r){return t.actors.includes(r.id)})).sort((function(r,a){return t.actors.indexOf(r.id)-t.actors.indexOf(a.id)})),a.next=9;break;case 6:return r=game.actors.filter((function(t){return t.hasPlayerOwner})),a.next=9,game.settings.set("dsa5","trackedActors",{actors:r.map((function(t){return t.id}))});case 9:return a.abrupt("return",r);case 10:case"end":return a.stop()}}),_callee22)}))),function getTrackedHeros(){return i.apply(this,arguments)})},{key:"getData",value:(o=masters_menu_asyncToGenerator(masters_menu_regeneratorRuntime().mark((function _callee23(r){var a,o,i,c,u,l,p,d,h,m,y,g,v,_;return masters_menu_regeneratorRuntime().wrap((function _callee23$(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,masters_menu_get(masters_menu_getPrototypeOf(GameMasterMenu.prototype),"getData",this).call(this,r);case 2:return a=b.sent,b.next=5,this.getTrackedHeros();case 5:for(o=b.sent,i=this.getGroupSchipSetting(),c=[],u=1;u<=i[1];u++)c.push({value:u,cssClass:u<=i[0]?"fullSchip":"emptySchip"});l=game.settings.get("dsa5","sightOptions").split("|"),p=/ \[[a-zA-Z\d-]+\]/,d=[1,2,3,4].map((function(t){return{label:game.i18n.localize("VisionDisruption.step".concat(t)).replace(p,""),value:l[t-1]}})),a.sceneConfig={sceneAutomationEnabled:game.settings.get("dsa5","sightAutomationEnabled"),enableDPS:game.settings.get("dsa5","enableDPS"),visions:d,darkness:canvas.scene?canvas.scene.darkness:0},this.heros=o,h=masters_menu_createForOfIteratorHelper(o);try{for(h.s();!(m=h.n()).done;){for((y=m.value).gmSelected=this.selected[y.id],g=[],v=1;v<=Number(y.system.status.fatePoints.max);v++)g.push({value:v,cssClass:v<=Number(y.system.status.fatePoints.value)?"fullSchip":"emptySchip"});y.schips=g,y.purse=y.items.filter((function(t){return"money"==t.type})).sort((function(t,r){return r.system.price.value-t.system.price.value})).map((function(t){return'<span data-tooltip="'.concat(game.i18n.localize(t.name),'">').concat(t.system.quantity.value,"</span>")})).join(" - "),y.advantages=y.items.filter((function(t){return"advantage"==t.type})).map((function(t){return{name:t.name,uuid:t.uuid}})),y.disadvantages=y.items.filter((function(t){return"disadvantage"==t.type})).map((function(t){return{name:t.name,uuid:t.uuid}}))}}catch(t){h.e(t)}finally{h.f()}if(this.abilities){b.next=21;break}return b.next=19,t.Z.allSkillsList();case 19:_=b.sent,this.abilities=_.map((function(t){return{name:t,type:"skill"}})).concat(Object.values(game.dsa5.config.characteristics).map((function(t){return{name:game.i18n.localize(t),type:"attribute"}})).concat({name:game.i18n.localize("regenerate"),type:"regeneration"})).sort((function(t,r){return t.name.localeCompare(r.name)}));case 21:if(b.t0=mergeObject,b.t1=a,b.t2=o,b.t3=this.abilities,b.t4=c,b.t5=this.lastSkill,b.t6=this.randomCreation.map((function(t){return t.template})),!game.dsa5.apps.LightDialog){b.next=34;break}return b.next=31,game.dsa5.apps.LightDialog.getButtonHTML();case 31:b.t7=b.sent,b.next=35;break;case 34:b.t7="";case 35:return b.t8=b.t7,b.t9={heros:b.t2,abilities:b.t3,groupschips:b.t4,lastSkill:b.t5,randomCreation:b.t6,lightButton:b.t8},(0,b.t0)(b.t1,b.t9),b.abrupt("return",a);case 39:case"end":return b.stop()}}),_callee23,this)}))),function getData(t){return o.apply(this,arguments)})},{key:"registerRandomCreation",value:function registerRandomCreation(t){this.randomCreation.push(t)}}],[{key:"defaultOptions",get:function get(){var t=masters_menu_get(masters_menu_getPrototypeOf(GameMasterMenu),"defaultOptions",this);return t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(t,{classes:t.classes.concat(["dsa5","largeDialog","masterMenu"]),width:470,height:740,title:game.i18n.localize("gmMenu"),dragDrop:[{dragSelector:null,dropSelector:null}]}),t.template="systems/dsa5/templates/system/mastermenu.html",t.resizable=!0,t}}]),GameMasterMenu}();function didyouknow_typeof(t){return didyouknow_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},didyouknow_typeof(t)}function didyouknow_regeneratorRuntime(){didyouknow_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==didyouknow_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function didyouknow_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function didyouknow_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){didyouknow_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){didyouknow_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function didyouknow_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var We=function(){function DidYouKnow(){!function didyouknow_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,DidYouKnow)}var t,r;return function didyouknow_createClass(t,r,a){return r&&didyouknow_defineProperties(t.prototype,r),a&&didyouknow_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DidYouKnow,null,[{key:"stopFade",value:(r=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee3(t){return didyouknow_regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:t.stopPropagation(),t.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(t.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click((function(){return $(".didYouKnow").remove()}))):fetch("systems/dsa5/lazy/didyouknow/".concat(game.i18n.lang,".json")).then(function(){var t=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee(t){return didyouknow_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.json());case 1:case"end":return r.stop()}}),_callee)})));return function(r){return t.apply(this,arguments)}}()).then(function(){var t=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee2(t){var r,a;return didyouknow_regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return r=t.data[Math.floor(Math.random()*t.data.length)],o.next=3,renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:r,fadeOut:DidYouKnow.fadeOut});case 3:a=o.sent,$("body").find(".didYouKnow").replaceWith(a),DidYouKnow.activateListeners();case 6:case"end":return o.stop()}}),_callee2)})));return function(r){return t.apply(this,arguments)}}());case 3:case"end":return r.stop()}}),_callee3,this)}))),function stopFade(t){return r.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(){var t=this;$(".didYouKnow .stopFade").click(function(){var r=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee4(r){return didyouknow_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.stopFade(r);case 2:return a.abrupt("return",a.sent);case 3:case"end":return a.stop()}}),_callee4)})));return function(t){return r.apply(this,arguments)}}()),$(".didYouKnow").click((function(){return $(".didYouKnow").remove()})),$(".didYouKnow").fadeIn()}},{key:"showOneMessage",value:(t=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee7(){var t,r=this,a=arguments;return didyouknow_regeneratorRuntime().wrap((function _callee7$(o){for(;;)switch(o.prev=o.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:8e3,!game.settings.get("dsa5","disableDidYouKnow")){o.next=3;break}return o.abrupt("return");case 3:fetch("systems/dsa5/lazy/didyouknow/".concat(game.i18n.lang,".json")).then(function(){var t=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee5(t){return didyouknow_regeneratorRuntime().wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.json());case 1:case"end":return r.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}()).then(function(){var a=didyouknow_asyncToGenerator(didyouknow_regeneratorRuntime().mark((function _callee6(a){var o,i;return didyouknow_regeneratorRuntime().wrap((function _callee6$(c){for(;;)switch(c.prev=c.next){case 0:return o=a.data[Math.floor(Math.random()*a.data.length)],c.next=3,renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:o,fadeOut:DidYouKnow.fadeOut});case 3:i=c.sent,$("body").append(i),r.activateListeners(),setTimeout((function(){DidYouKnow.fadeOut&&$(".didYouKnow").fadeOut(1e3,(function(){return $(".didYouKnow").remove()}))}),t);case 7:case"end":return c.stop()}}),_callee6)})));return function(t){return a.apply(this,arguments)}}());case 4:case"end":return o.stop()}}),_callee7)}))),function showOneMessage(){return t.apply(this,arguments)})}]),DidYouKnow}();function tokenHotbar2_typeof(t){return tokenHotbar2_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tokenHotbar2_typeof(t)}function tokenHotbar2_toConsumableArray(t){return function tokenHotbar2_arrayWithoutHoles(t){if(Array.isArray(t))return tokenHotbar2_arrayLikeToArray(t)}(t)||function tokenHotbar2_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||tokenHotbar2_unsupportedIterableToArray(t)||function tokenHotbar2_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function tokenHotbar2_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=tokenHotbar2_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function tokenHotbar2_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return tokenHotbar2_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?tokenHotbar2_arrayLikeToArray(t,r):void 0}}function tokenHotbar2_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function tokenHotbar2_regeneratorRuntime(){tokenHotbar2_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==tokenHotbar2_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function tokenHotbar2_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function tokenHotbar2_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){tokenHotbar2_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){tokenHotbar2_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function tokenHotbar2_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function tokenHotbar2_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function tokenHotbar2_createClass(t,r,a){return r&&tokenHotbar2_defineProperties(t.prototype,r),a&&tokenHotbar2_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function tokenHotbar2_get(){return tokenHotbar2_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=tokenHotbar2_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},tokenHotbar2_get.apply(this,arguments)}function tokenHotbar2_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=tokenHotbar2_getPrototypeOf(t)););return t}function tokenHotbar2_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&tokenHotbar2_setPrototypeOf(t,r)}function tokenHotbar2_setPrototypeOf(t,r){return tokenHotbar2_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},tokenHotbar2_setPrototypeOf(t,r)}function tokenHotbar2_createSuper(t){var r=function tokenHotbar2_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=tokenHotbar2_getPrototypeOf(t);if(r){var i=tokenHotbar2_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return tokenHotbar2_possibleConstructorReturn(this,a)}}function tokenHotbar2_possibleConstructorReturn(t,r){if(r&&("object"===tokenHotbar2_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function tokenHotbar2_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function tokenHotbar2_getPrototypeOf(t){return tokenHotbar2_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},tokenHotbar2_getPrototypeOf(t)}!function didyouknow_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}(We,"fadeOut",!0);var Be=function(t){tokenHotbar2_inherits(TokenHotbar2,Application);var r,a,o,i,c,u,l=tokenHotbar2_createSuper(TokenHotbar2);function TokenHotbar2(t){var r;tokenHotbar2_classCallCheck(this,TokenHotbar2),(r=l.call(this,t)).combatSkills=["selfControl","featOfStrength","bodyControl","perception"].map((function(t){return game.i18n.localize("LocalizedIDs.".concat(t))})),r.defaultSkills=[game.i18n.localize("LocalizedIDs.perception")];var a=function parentUpdate(t){var r=t.parent?t.parent.id:void 0;r&&TokenHotbar2.hookUpdate(r)};return Hooks.on("controlToken",(function(t,a){r.updateDSA5Hotbar()})),Hooks.on("updateActor",(function(t,r){TokenHotbar2.hookUpdate(t.id)})),Hooks.on("updateToken",(function(t,a,o){a._id==getProperty(game.dsa5.apps.tokenHotbar,"actor.prototypeToken.id")&&r.updateDSA5Hotbar()})),Hooks.on("updateOwnedItem",(function(t,r){TokenHotbar2.hookUpdate(t.data.id)})),Hooks.on("createOwnedItem",(function(t,r){TokenHotbar2.hookUpdate(t.data.id)})),Hooks.on("deleteOwnedItem",(function(t,r){TokenHotbar2.hookUpdate(t.data.id)})),Hooks.on("updateItem",(function(t,r){a(t)})),Hooks.on("createItem",(function(t,r){a(t)})),Hooks.on("deleteItem",(function(t,r){a(t)})),r}return tokenHotbar2_createClass(TokenHotbar2,[{key:"resetPosition",value:function resetPosition(){var t=$("#hotbar").first().position(),r=game.settings.get("dsa5","tokenhotbarSize");this.position.left=t.left+8,this.position.top=t.top-r-25}},{key:"_onWheelResize",value:(u=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee(t){var r;return tokenHotbar2_regeneratorRuntime().wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return r=game.settings.get("dsa5","tokenhotbarSize"),r=t.originalEvent.deltaY>0?Math.min(100,r+5):Math.max(15,r-5),a.next=4,game.settings.set("dsa5","tokenhotbarSize",r);case 4:return a.next=6,this.render(!0);case 6:case"end":return a.stop()}}),_callee,this)}))),function _onWheelResize(t){return u.apply(this,arguments)})},{key:"_cycleLayout",value:(c=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee2(t){var r;return tokenHotbar2_regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:if(2!=t.button){a.next=7;break}return 4==(r=game.settings.get("dsa5","tokenhotbarLayout")+1)&&(r=0),a.next=5,game.settings.set("dsa5","tokenhotbarLayout",r);case 5:return a.next=7,this.render(!0);case 7:case"end":return a.stop()}}),_callee2,this)}))),function _cycleLayout(t){return c.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;tokenHotbar2_get(tokenHotbar2_getPrototypeOf(TokenHotbar2.prototype),"activateListeners",this).call(this,t);var a=t.find(".dragHandler");new Draggable(this,t,a[0],this.options.resizable),a.on("wheel",function(){var t=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee3(t){return tokenHotbar2_regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return t.stopPropagation(),t.preventDefault(),a.next=4,r._onWheelResize(t);case 4:return a.abrupt("return",!1);case 5:case"end":return a.stop()}}),_callee3)})));return function(r){return t.apply(this,arguments)}}()),a.on("mousedown",function(){var t=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee4(t){return tokenHotbar2_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,r._cycleLayout(t);case 2:case"end":return a.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()),t.on("mousedown","li",function(){var t=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee5(t){return tokenHotbar2_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:return t.stopPropagation(),a.next=3,r.executeQuickButton(t);case 3:return a.abrupt("return",!1);case 4:case"end":return a.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}()),t.on("mouseenter","li.primary",(function(a){var o=a.currentTarget.dataset.category;r.category=o,setTimeout((function(){t.find(".secondary").removeClass("shown"),o==r.category&&t.find('.secondary[data-category="'.concat(o,'"]')).addClass("shown")}),700)})),t.on("mouseleave","li.primary",(function(a){var o=a.currentTarget.dataset.category;r.category=void 0,setTimeout((function(){o!=r.category&&t.find('.secondary[data-category="'.concat(o,'"]')).removeClass("shown")}),50)}))}},{key:"executeQuickButton",value:(i=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee7(t){var r,a,o,i,c,u,l,p,d=this;return tokenHotbar2_regeneratorRuntime().wrap((function _callee7$(h){for(;;)switch(h.prev=h.next){case 0:r=canvas.tokens.controlled[0].actor,a=canvas.tokens.controlled[0].id,o=t.currentTarget.dataset.id,i=t.currentTarget.dataset.subfunction,h.t0=i,h.next="addEffect"===h.t0?7:"effect"===h.t0?9:"onUse"===h.t0?31:35;break;case 7:return Ze.showDialog(),h.abrupt("break",54);case 9:if(c=r.effects.get(o),u=c.getFlag("core","statusId"),0!=t.button){h.next=20;break}if(!u){h.next=17;break}return h.next=15,r.addCondition(u,1,!1,!1);case 15:h.next=18;break;case 17:c.sheet.render(!0);case 18:h.next=28;break;case 20:if(2!=t.button){h.next=28;break}if(!u){h.next=26;break}return h.next=24,r.removeCondition(u,1,!1);case 24:h.next=28;break;case 26:return h.next=28,r.sheet._deleteActiveEffect(o);case 28:return h.next=30,this.render(!0);case 30:return h.abrupt("break",54);case 31:return l=r.items.get(o),new g.Z(l).executeOnUseEffect(),h.abrupt("break",54);case 35:if("attackWeaponless"!=o){h.next=39;break}r.setupWeaponless("attack",{},a).then((function(t){r.basicTest(t)})),h.next=54;break;case 39:if(!(p=r.items.get(o))){h.next=54;break}if(2!=t.button){h.next=43;break}return h.abrupt("return",p.sheet.render(!0));case 43:h.t1=p.type,h.next="meleeweapon"===h.t1||"rangeweapon"===h.t1||"trait"===h.t1?46:"liturgy"===h.t1||"spell"===h.t1?48:"skill"===h.t1?50:"consumable"===h.t1?52:54;break;case 46:return r.setupWeapon(p,"attack",{},a).then((function(t){r.basicTest(t)})),h.abrupt("break",54);case 48:return r.setupSpell(p,{},a).then((function(t){r.basicTest(t)})),h.abrupt("break",54);case 50:return r.setupSkill(p,{},a).then((function(t){r.basicTest(t)})),h.abrupt("break",54);case 52:return new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+p.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+p.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){var t=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee6(){return tokenHotbar2_regeneratorRuntime().wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.setupEffect(null,{},a);case 2:return t.next=4,d.updateDSA5Hotbar();case 4:case"end":return t.stop()}}),_callee6)})));return function callback(){return t.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0),h.abrupt("break",54);case 54:case"end":return h.stop()}}),_callee7,this)}))),function executeQuickButton(t){return i.apply(this,arguments)})},{key:"subWidth",value:function subWidth(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:7;return'style="width:'.concat(200*Math.ceil(t.length/a),'px"')}},{key:"getData",value:(o=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee8(){var t,r,a,o,i,c,u,l,p,h,m,y,g,v,_,b,w,k,x,S,T,A,O,P,E,C,D,I,R,L,G,M,j;return tokenHotbar2_regeneratorRuntime().wrap((function _callee8$(z){for(;;)switch(z.prev=z.next){case 0:return z.next=2,tokenHotbar2_get(tokenHotbar2_getPrototypeOf(TokenHotbar2.prototype),"getData",this).call(this);case 2:if(t=z.sent,r=this.actor,a={attacks:[],spells:[],default:[],skills:[]},c=[],u=[],l=[],p=game.settings.get("dsa5","tokenhotbarLayout"),h=p%2,m=TokenHotbar2.defaultOptions.itemWidth,y=["liturgy","spell"],!r){z.next=25;break}return g=[],v=[],z.next=17,r.actorEffects();case 17:if(l=z.sent.map((function(t){return{name:t.label,id:t.id,icon:t.icon,cssClass:"effect",abbrev:"".concat(t.label[0]," ").concat(t.getFlag("dsa5","value")||""),subfunction:"effect"}})),game.combat){_=r.items.filter((function(t){return"combatskill"==t.type})).map((function(t){return d.Z._calculateCombatSkillValues(t.toObject(),r.system)})),b=_.find((function(t){return t.name==game.i18n.localize("LocalizedIDs.wrestle")})),b&&a.attacks.push({name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",icon:"systems/dsa5/icons/categories/attack_weaponless.webp",attack:b.system.attack.value,damage:"1d6"}),w=["meleeweapon","rangeweapon"],k=["meleeAttack","rangeAttack"],x=tokenHotbar2_createForOfIteratorHelper(r.items);try{for(x.s();!(S=x.n()).done;)"trait"==(T=S.value).type&&k.includes(T.system.traitType.value)?(A=d.Z._parseDmg(T.toObject()),a.attacks.push({name:T.name,id:T.id,icon:T.img,cssClass:"weapon ".concat(T.id),abbrev:T.name[0],attack:T.system.at.value,damage:A.damagedie,dadd:A.damageAdd})):w.includes(T.type)&&1==T.system.worn.value?(O="meleeweapon"==T.type?d.Z._prepareMeleeWeapon(T.toObject(),_,r):d.Z._prepareRangeWeapon(T.toObject(),[],_,r),a.attacks.push({name:T.name,id:T.id,icon:T.img,cssClass:"weapon ".concat(T.id),abbrev:T.name[0],attack:O.attack,damage:O.damagedie,dadd:O.damageAdd})):y.includes(T.type)?T.system.effectFormula.value?a.spells.push({name:T.name,id:T.id,icon:T.img,cssClass:"spell",abbrev:T.name[0]}):v.push({name:T.name,id:T.id,icon:T.img,cssClass:"spell",abbrev:T.name[0]}):["skill"].includes(T.type)&&this.combatSkills.includes(T.name)?a.default.push({name:"".concat(T.name," (").concat(T.system.talentValue.value,")"),id:T.id,icon:T.img,cssClass:"skill",abbrev:T.name[0]}):["skill"].includes(T.type)?(P={name:"".concat(T.name," (").concat(T.system.talentValue.value,")"),id:T.id,icon:T.img,cssClass:"skill",addClass:T.system.group.value,abbrev:T.name[0],tw:T.system.talentValue.value},g.push(P)):"consumable"==T.type&&c.push({name:T.name,id:T.id,icon:T.img,cssClass:"consumable",abbrev:T.system.quantity.value}),T.getFlag("dsa5","onUseEffect")&&u.push({name:T.name,id:T.id,icon:T.img,cssClass:"onUse",abbrev:T.name[0],subfunction:"onUse"})}catch(t){x.e(t)}finally{x.f()}o=c.pop()}else{C=[],D=tokenHotbar2_createForOfIteratorHelper(r.items);try{for(D.s();!(I=D.n()).done;)R=I.value,["skill"].includes(R.type)&&this.defaultSkills.includes(R.name)?a.default.push({name:"".concat(R.name," (").concat(R.system.talentValue.value,")"),id:R.id,icon:R.img,cssClass:"skill",abbrev:R.name[0]}):["skill"].includes(R.type)?(L={name:"".concat(R.name," (").concat(R.system.talentValue.value,")"),id:R.id,icon:R.img,cssClass:"skill",addClass:R.system.group.value,abbrev:R.name[0],tw:R.system.talentValue.value},R.system.talentValue.value>0&&C.push(L),g.push(L)):y.includes(R.type)&&(R.system.effectFormula.value?a.spells.push({name:R.name,id:R.id,icon:R.img,cssClass:"spell",abbrev:R.name[0]}):v.push({name:R.name,id:R.id,icon:R.img,cssClass:"spell",abbrev:R.name[0]})),R.getFlag("dsa5","onUseEffect")&&u.push({name:R.name,id:R.id,icon:R.img,cssClass:"onUse",abbrev:R.name[0],subfunction:"onUse"})}catch(t){D.e(t)}finally{D.f()}(E=a.skills).push.apply(E,tokenHotbar2_toConsumableArray(C.sort((function(t,r){return r.tw-t.tw})).slice(0,5)))}i=u.pop(),0==a.spells.length&&v.length>0&&a.spells.push(v.pop()),a.spells.length>0&&v.length>0&&(a.spells[0].more=v.sort((function(t,r){return t.name.localeCompare(r.name)})),a.spells[0].subwidth=this.subWidth(v,m)),a.default.length>0&&g.length>0&&(a.default[0].more=g.sort((function(t,r){return t.addClass.localeCompare(r.addClass)||t.name.localeCompare(r.name)})),a.default[0].subwidth=this.subWidth(g,m,20)),o&&(c.length>0&&(o.more=c,o.subwidth=this.subWidth(c,m)),a.consumables=[o]),i&&(u.length>0&&(i.more=u,i.subwidth=this.subWidth(u,m)),a.onUsages=[i]);case 25:return this.showEffects&&(G=game.i18n.localize("CONDITION.add"),M={name:G,id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:G[0],subfunction:"addEffect"},l.length>0&&(M.more=l,M.subwidth=this.subWidth(l,m)),a.effects=[M]),j=Object.keys(a).reduce((function(t,r){return t+a[r].length}),0),h?(this.position.width=m,this.position.height=m*j+14):(this.position.width=m*j+14,this.position.height=m),mergeObject(t,{items:a,itemWidth:m,direction:p,count:j}),z.abrupt("return",t);case 30:case"end":return z.stop()}}),_callee8,this)}))),function getData(){return o.apply(this,arguments)})},{key:"render",value:(a=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee9(t){var r,a,o=arguments;return tokenHotbar2_regeneratorRuntime().wrap((function _callee9$(i){for(;;)switch(i.prev=i.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:{},i.next=3,tokenHotbar2_get(tokenHotbar2_getPrototypeOf(TokenHotbar2.prototype),"render",this).call(this,t,r);case 3:return a=i.sent,this._element&&this._element.css({zIndex:61}),i.abrupt("return",a);case 6:case"end":return i.stop()}}),_callee9,this)}))),function render(t){return a.apply(this,arguments)})},{key:"setPosition",value:function setPosition(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.left,a=t.top,o=t.width,i=t.height,c=t.scale,u=tokenHotbar2_get(tokenHotbar2_getPrototypeOf(TokenHotbar2.prototype),"setPosition",this).call(this,{left:r,top:a,width:o,height:i,scale:c}),l=this.element[0];if(!l.style.width||o){var p=o||l.offsetWidth,d=l.style.maxWidth||window.innerWidth;u.width=o=Math.clamped(p,0,d),l.style.width=o+"px",o+u.left>window.innerWidth&&(r=u.left)}return game.settings.set("dsa5","tokenhotbarPosition",{left:u.left,top:u.top}),u}},{key:"updateDSA5Hotbar",value:(r=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee10(){var t,r;return tokenHotbar2_regeneratorRuntime().wrap((function _callee10$(a){for(;;)switch(a.prev=a.next){case 0:return t=canvas.tokens.controlled,this.actor=void 0,this.showEffects=!1,1===t.length&&(r=t[0].actor)&&r.isOwner&&(this.actor=r),t.length>=1&&(this.showEffects=!0),a.next=7,this.render(!0);case 7:case"end":return a.stop()}}),_callee10,this)}))),function updateDSA5Hotbar(){return r.apply(this,arguments)})}],[{key:"registerTokenHotbar",value:function registerTokenHotbar(){game.dsa5.apps.tokenHotbar||(game.dsa5.apps.tokenHotbar=new TokenHotbar2)}},{key:"hookUpdate",value:function hookUpdate(t){t==getProperty(game.dsa5.apps.tokenHotbar,"actor.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}},{key:"defaultOptions",get:function get(){var t=tokenHotbar2_get(tokenHotbar2_getPrototypeOf(TokenHotbar2),"defaultOptions",this),r=$("#hotbar").first().position(),a=game.settings.get("dsa5","tokenhotbarSize"),o=game.settings.get("dsa5","tokenhotbarPosition");return mergeObject(t,{classes:t.classes.concat(["dsa5","tokenQuickHot"]),itemWidth:a,resizable:!1,height:a+45,zIndex:61,left:r.left+8,top:r.top-a-25,template:"systems/dsa5/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(t,o),t}}]),TokenHotbar2}(),Ze=function(t){tokenHotbar2_inherits(AddEffectDialog,Dialog);var r,a,o=tokenHotbar2_createSuper(AddEffectDialog);function AddEffectDialog(){return tokenHotbar2_classCallCheck(this,AddEffectDialog),o.apply(this,arguments)}return tokenHotbar2_createClass(AddEffectDialog,[{key:"activateListeners",value:function activateListeners(t){var r=this;tokenHotbar2_get(tokenHotbar2_getPrototypeOf(AddEffectDialog.prototype),"activateListeners",this).call(this,t),t.find(".reactClick").click((function(t){return r.addEffect(t)}));var a=t.find(".conditionSearch");a.keyup((function(a){return r._filterConditions($(a.currentTarget),t)})),a[0]&&a[0].addEventListener("search",(function filterConditions(a){return r._filterConditions($(a.currentTarget),t)}),!1)}},{key:"_filterConditions",value:function _filterConditions(t,r){if(null!=t.val()){var a=t.val().toLowerCase().trim(),o=r.find(".filterable");r.find(".filterHide").removeClass("filterHide"),o.filter((function(){return-1==$(this).find("span").text().toLowerCase().trim().indexOf(a)})).addClass("filterHide")}}},{key:"addEffect",value:(a=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee11(t){var r,a,o;return tokenHotbar2_regeneratorRuntime().wrap((function _callee11$(i){for(;;)switch(i.prev=i.next){case 0:r=tokenHotbar2_createForOfIteratorHelper(canvas.tokens.controlled),i.prev=1,r.s();case 3:if((a=r.n()).done){i.next=9;break}return o=a.value,i.next=7,o.actor.addCondition(t.currentTarget.dataset.value,1,!1,!1);case 7:i.next=3;break;case 9:i.next=14;break;case 11:i.prev=11,i.t0=i.catch(1),r.e(i.t0);case 14:return i.prev=14,r.f(),i.finish(14);case 17:game.dsa5.apps.tokenHotbar.render(!0),this.close();case 19:case"end":return i.stop()}}),_callee11,this,[[1,11,14,17]])}))),function addEffect(t){return a.apply(this,arguments)})}],[{key:"showDialog",value:(r=tokenHotbar2_asyncToGenerator(tokenHotbar2_regeneratorRuntime().mark((function _callee12(){var t,r;return tokenHotbar2_regeneratorRuntime().wrap((function _callee12$(a){for(;;)switch(a.prev=a.next){case 0:return t=duplicate(CONFIG.statusEffects).map((function(t){return{label:game.i18n.localize(t.label),icon:t.icon,description:game.i18n.localize(t.description),id:t.id}})).sort((function(t,r){return t.label.localeCompare(r.label)})),a.t0=AddEffectDialog,a.t1=game.i18n.localize("CONDITION.add"),a.next=5,renderTemplate("systems/dsa5/templates/dialog/addstatusdialog.html",{effects:t});case 5:a.t2=a.sent,a.t3={},a.t4={title:a.t1,content:a.t2,buttons:a.t3},(r=new a.t0(a.t4)).position.height=36*Math.ceil(t.length/3)+170,r.render(!0);case 11:case"end":return a.stop()}}),_callee12)}))),function showDialog(){return r.apply(this,arguments)})},{key:"defaultOptions",get:function get(){var t=tokenHotbar2_get(tokenHotbar2_getPrototypeOf(AddEffectDialog),"defaultOptions",this),r=32*Math.ceil(CONFIG.statusEffects.length/3);return mergeObject(t,{classes:["dsa5","tokenStatusEffects"],width:700,resizable:!0,height:r}),t}}]),AddEffectDialog}();function creature_merchant_sheet_typeof(t){return creature_merchant_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},creature_merchant_sheet_typeof(t)}function creature_merchant_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function creature_merchant_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function creature_merchant_sheet_setPrototypeOf(t,r){return creature_merchant_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},creature_merchant_sheet_setPrototypeOf(t,r)}function creature_merchant_sheet_createSuper(t){var r=function creature_merchant_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=creature_merchant_sheet_getPrototypeOf(t);if(r){var i=creature_merchant_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return creature_merchant_sheet_possibleConstructorReturn(this,a)}}function creature_merchant_sheet_possibleConstructorReturn(t,r){if(r&&("object"===creature_merchant_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function creature_merchant_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function creature_merchant_sheet_getPrototypeOf(t){return creature_merchant_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},creature_merchant_sheet_getPrototypeOf(t)}var qe=function(t){!function creature_merchant_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&creature_merchant_sheet_setPrototypeOf(t,r)}(CreatureMerchantSheetDSA5,t);var r=creature_merchant_sheet_createSuper(CreatureMerchantSheetDSA5);function CreatureMerchantSheetDSA5(){return creature_merchant_sheet_classCallCheck(this,CreatureMerchantSheetDSA5),r.apply(this,arguments)}return function creature_merchant_sheet_createClass(t,r,a){return r&&creature_merchant_sheet_defineProperties(t.prototype,r),a&&creature_merchant_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(CreatureMerchantSheetDSA5,null,[{key:"merchantTemplate",get:function get(){return"systems/dsa5/templates/actors/merchant/creature-merchant-sheet.html"}}]),CreatureMerchantSheetDSA5}(he(E));function character_merchant_sheet_typeof(t){return character_merchant_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},character_merchant_sheet_typeof(t)}function character_merchant_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function character_merchant_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function character_merchant_sheet_setPrototypeOf(t,r){return character_merchant_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},character_merchant_sheet_setPrototypeOf(t,r)}function character_merchant_sheet_createSuper(t){var r=function character_merchant_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=character_merchant_sheet_getPrototypeOf(t);if(r){var i=character_merchant_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return character_merchant_sheet_possibleConstructorReturn(this,a)}}function character_merchant_sheet_possibleConstructorReturn(t,r){if(r&&("object"===character_merchant_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function character_merchant_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function character_merchant_sheet_getPrototypeOf(t){return character_merchant_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},character_merchant_sheet_getPrototypeOf(t)}var Ue=function(t){!function character_merchant_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&character_merchant_sheet_setPrototypeOf(t,r)}(CharacterMerchantSheetDSA5,t);var r=character_merchant_sheet_createSuper(CharacterMerchantSheetDSA5);function CharacterMerchantSheetDSA5(){return character_merchant_sheet_classCallCheck(this,CharacterMerchantSheetDSA5),r.apply(this,arguments)}return function character_merchant_sheet_createClass(t,r,a){return r&&character_merchant_sheet_defineProperties(t.prototype,r),a&&character_merchant_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(CharacterMerchantSheetDSA5,null,[{key:"merchantTemplate",get:function get(){return"systems/dsa5/templates/actors/merchant/character-merchant-sheet.html"}}]),CharacterMerchantSheetDSA5}(he(O));function dsa_ini_tracker_typeof(t){return dsa_ini_tracker_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dsa_ini_tracker_typeof(t)}function dsa_ini_tracker_regeneratorRuntime(){dsa_ini_tracker_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==dsa_ini_tracker_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function dsa_ini_tracker_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function dsa_ini_tracker_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){dsa_ini_tracker_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){dsa_ini_tracker_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function dsa_ini_tracker_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function dsa_ini_tracker_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function dsa_ini_tracker_get(){return dsa_ini_tracker_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=dsa_ini_tracker_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},dsa_ini_tracker_get.apply(this,arguments)}function dsa_ini_tracker_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=dsa_ini_tracker_getPrototypeOf(t)););return t}function dsa_ini_tracker_setPrototypeOf(t,r){return dsa_ini_tracker_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},dsa_ini_tracker_setPrototypeOf(t,r)}function dsa_ini_tracker_createSuper(t){var r=function dsa_ini_tracker_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=dsa_ini_tracker_getPrototypeOf(t);if(r){var i=dsa_ini_tracker_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return dsa_ini_tracker_possibleConstructorReturn(this,a)}}function dsa_ini_tracker_possibleConstructorReturn(t,r){if(r&&("object"===dsa_ini_tracker_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function dsa_ini_tracker_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function dsa_ini_tracker_getPrototypeOf(t){return dsa_ini_tracker_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},dsa_ini_tracker_getPrototypeOf(t)}var Ye=function(t){!function dsa_ini_tracker_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&dsa_ini_tracker_setPrototypeOf(t,r)}(DSAIniTracker,Application);var r,a,o,i,c=dsa_ini_tracker_createSuper(DSAIniTracker);function DSAIniTracker(){return dsa_ini_tracker_classCallCheck(this,DSAIniTracker),c.apply(this,arguments)}return function dsa_ini_tracker_createClass(t,r,a){return r&&dsa_ini_tracker_defineProperties(t.prototype,r),a&&dsa_ini_tracker_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSAIniTracker,[{key:"setPosition",value:function setPosition(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.left,a=t.top,o=t.width,i=t.height,c=t.scale,u=dsa_ini_tracker_get(dsa_ini_tracker_getPrototypeOf(DSAIniTracker.prototype),"setPosition",this).call(this,{left:r,top:a,width:o,height:i,scale:c}),l=this.element[0];if(!l.style.width||o){var p=o||l.offsetWidth,d=l.style.maxWidth||window.innerWidth;u.width=o=Math.clamped(p,0,d),l.style.width=o+"px",o+u.left>window.innerWidth&&(r=u.left)}return game.settings.set("dsa5","iniTrackerPosition",{left:u.left,top:u.top}),u}},{key:"updateTracker",value:function updateTracker(t){this.combatData=t,this.render(!0)}},{key:"getData",value:(i=dsa_ini_tracker_asyncToGenerator(dsa_ini_tracker_regeneratorRuntime().mark((function _callee(t){var r,a,o,i,c,u,l,p,d,h,m,y,g,v,_,b;return dsa_ini_tracker_regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(r=this.combatData,a=game.settings.get("dsa5","iniTrackerSize"),o=r.turns,i=[],c=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,u=r.turns.some((function(t){return t.owner&&!t.hasRolled&&(!game.user.isGM||r.combat.combatants.get(t.id).isNPC)})),o.length){for(l=[],p=5,d=!1,h=-1,m=0,y=0;0!=p&&5!=y;)v=duplicate(o[m]),_=r.combat.combatants.get(v.id),d&&m==h&&(v.css=v.css.replace("active","")),v.active&&!d?(d=!0,h=m):_.getFlag("dsa5","waitInit")!=r.round+y||_.defeated||!game.user.isGM&&_.hidden||i.push(v),!d||c&&_.defeated||!game.user.isGM&&_.hidden||(v.round=r.round+y,v.owner&&null!==(b=_.token)&&void 0!==b&&b.actor&&(v.maxLP=_.token.actor.system.status.wounds.max,v.currentLP=_.token.actor.system.status.wounds.value),g&&g!=v.round&&(v.newRound="newRound"),g=v.round,l.push(v),p--),++m>=o.length&&(m=0,y++);r.turns=l}return r.round||(a=20),this.position.width=5*a+95,this.position.height=a+10,mergeObject(r,{itemWidth:a,unRolled:u,waitingTurns:i}),this.conditionalPanToCurrentCombatant(r),t.abrupt("return",r);case 13:case"end":return t.stop()}}),_callee,this)}))),function getData(t){return i.apply(this,arguments)})},{key:"hasChangedTurn",value:function hasChangedTurn(t){var r=t.turn!=this.lastTurnUpdate||t.round!=this.lastRoundUpdate;return this.lastTurnUpdate=t.turn,this.lastRoundUpdate=t.round,r}},{key:"conditionalPanToCurrentCombatant",value:(o=dsa_ini_tracker_asyncToGenerator(dsa_ini_tracker_regeneratorRuntime().mark((function _callee2(t){var r,a;return dsa_ini_tracker_regeneratorRuntime().wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:if(game.settings.get("dsa5","enableCombatPan")){o.next=2;break}return o.abrupt("return");case 2:if(r=t.turns[0]){o.next=5;break}return o.abrupt("return");case 5:if((a=t.combat.combatants.get(r.id))&&this.hasChangedTurn(t)){o.next=8;break}return o.abrupt("return");case 8:setTimeout((function(){var t=a.token;t&&t.object&&t.object.isVisible&&(canvas.animatePan({x:t.x,y:t.y}),a.actor&&a.actor.isOwner&&t.object.control({releaseOthers:!0}))}),300);case 9:case"end":return o.stop()}}),_callee2,this)}))),function conditionalPanToCurrentCombatant(t){return o.apply(this,arguments)})},{key:"_onWheelResize",value:(a=dsa_ini_tracker_asyncToGenerator(dsa_ini_tracker_regeneratorRuntime().mark((function _callee3(t){var r;return dsa_ini_tracker_regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return r=game.settings.get("dsa5","iniTrackerSize"),r=t.originalEvent.deltaY>0?Math.min(140,r+5):Math.max(30,r-5),a.next=4,game.settings.set("dsa5","iniTrackerSize",r);case 4:return a.next=6,this.render(!0);case 6:case"end":return a.stop()}}),_callee3,this)}))),function _onWheelResize(t){return a.apply(this,arguments)})},{key:"activateListeners",value:function activateListeners(t){var r=this;dsa_ini_tracker_get(dsa_ini_tracker_getPrototypeOf(DSAIniTracker.prototype),"activateListeners",this).call(this,t);var a=t.find(".dragHandler");new Draggable(this,t,a[0],this.options.resizable),a.on("wheel",function(){var t=dsa_ini_tracker_asyncToGenerator(dsa_ini_tracker_regeneratorRuntime().mark((function _callee4(t){return dsa_ini_tracker_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return t.stopPropagation(),t.preventDefault(),a.next=4,r._onWheelResize(t);case 4:return a.abrupt("return",!1);case 5:case"end":return a.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}()),t.find(".combat-control").click((function(t){return r._onCombatControl(t)}));var o=t.find(".iniItem");o.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),o.click(this._onCombatantMouseDown.bind(this)),t.find(".waitingTackerList .iniItem").mousedown((function(t){return r._onRightClick(t)})),t.find(".combatant-control").click((function(t){return r._onCombatantControl(t)})),t.find(".combatant .aggroButton").click((function(t){t.preventDefault(),t.stopPropagation(),De.runActAttackDialog()})),t.find(".rollMine").click((function(t){return r.rollMyChars()})),game.user.isGM&&t.find(".rolledInit").click((function(t){return r.editCombatant(t)}))}},{key:"rollMyChars",value:function rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}},{key:"_onRightClick",value:function _onRightClick(t){if(2==t.button){var r=game.combat.combatants.get(t.currentTarget.dataset.combatantId);r.isOwner&&r.unsetFlag("dsa5","waitInit")}}},{key:"editCombatant",value:function editCombatant(t){this._getCombatApp()._onConfigureCombatant($(t.currentTarget))}},{key:"_onCombatantControl",value:function _onCombatantControl(t){this._getCombatApp()._onCombatantControl(t)}},{key:"_onCombatControl",value:function _onCombatControl(t){"waitInit"==t.currentTarget.dataset.control?this.waitInit(t):this._getCombatApp()._onCombatControl(t)}},{key:"waitInit",value:(r=dsa_ini_tracker_asyncToGenerator(dsa_ini_tracker_regeneratorRuntime().mark((function _callee5(t){var r;return dsa_ini_tracker_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:return r=game.combat.combatants.get(game.combat.current.combatantId),a.next=3,r.setFlag("dsa5","waitInit",game.combat.current.round);case 3:t.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(t);case 5:case"end":return a.stop()}}),_callee5,this)}))),function waitInit(t){return r.apply(this,arguments)})},{key:"_onCombatantHoverOut",value:function _onCombatantHoverOut(t){this._getCombatApp()._onCombatantHoverOut(t)}},{key:"_onCombatantHoverIn",value:function _onCombatantHoverIn(t){this._getCombatApp()._onCombatantHoverIn(t)}},{key:"_onCombatantMouseDown",value:function _onCombatantMouseDown(t){this._getCombatApp()._onCombatantMouseDown(t)}},{key:"_getCombatApp",value:function _getCombatApp(){return game.combats.apps[0]}},{key:"_canDragStart",value:function _canDragStart(t){return!1}},{key:"_canDragDrop",value:function _canDragDrop(t){return!1}},{key:"_onDragStart",value:function _onDragStart(t){var r=$(t.currentTarget).closestData("combatant-id");t.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:r}))}},{key:"_onDrop",value:function _onDrop(t){JSON.parse(t.dataTransfer.getData("text/plain")).type}}],[{key:"defaultOptions",get:function get(){var t=dsa_ini_tracker_get(dsa_ini_tracker_getPrototypeOf(DSAIniTracker),"defaultOptions",this);mergeObject(t,{classes:t.classes.concat(["dsa5","initTracker"]),template:"systems/dsa5/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"DSAIniTracker"});var r=game.settings.get("dsa5","iniTrackerPosition");return mergeObject(t,r),t}},{key:"connectHooks",value:function connectHooks(){Hooks.on("renderDSA5CombatTracker",(function(t,r,a){game.settings.get("dsa5","enableCombatFlow")&&(game.combat?(game.dsa5.apps.initTracker||(game.dsa5.apps.initTracker=new DSAIniTracker),game.dsa5.apps.initTracker.updateTracker(a)):game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0))}))}}]),DSAIniTracker}();function dsa_journal_sheet_typeof(t){return dsa_journal_sheet_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dsa_journal_sheet_typeof(t)}function dsa_journal_sheet_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function dsa_journal_sheet_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function dsa_journal_sheet_get(){return dsa_journal_sheet_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=dsa_journal_sheet_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},dsa_journal_sheet_get.apply(this,arguments)}function dsa_journal_sheet_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=dsa_journal_sheet_getPrototypeOf(t)););return t}function dsa_journal_sheet_setPrototypeOf(t,r){return dsa_journal_sheet_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},dsa_journal_sheet_setPrototypeOf(t,r)}function dsa_journal_sheet_createSuper(t){var r=function dsa_journal_sheet_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=dsa_journal_sheet_getPrototypeOf(t);if(r){var i=dsa_journal_sheet_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return dsa_journal_sheet_possibleConstructorReturn(this,a)}}function dsa_journal_sheet_possibleConstructorReturn(t,r){if(r&&("object"===dsa_journal_sheet_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function dsa_journal_sheet_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function dsa_journal_sheet_getPrototypeOf(t){return dsa_journal_sheet_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},dsa_journal_sheet_getPrototypeOf(t)}var Ve=function(t){!function dsa_journal_sheet_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&dsa_journal_sheet_setPrototypeOf(t,r)}(DSAJournalSheet,JournalSheet);var r=dsa_journal_sheet_createSuper(DSAJournalSheet);function DSAJournalSheet(){return dsa_journal_sheet_classCallCheck(this,DSAJournalSheet),r.apply(this,arguments)}return function dsa_journal_sheet_createClass(t,r,a){return r&&dsa_journal_sheet_defineProperties(t.prototype,r),a&&dsa_journal_sheet_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSAJournalSheet,null,[{key:"defaultOptions",get:function get(){var t=dsa_journal_sheet_get(dsa_journal_sheet_getPrototypeOf(DSAJournalSheet),"defaultOptions",this);return mergeObject(t,{classes:t.classes.concat(["dsa5","dsajournal"])}),t}}]),DSAJournalSheet}(),Ke=__webpack_require__(93);function init_typeof(t){return init_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},init_typeof(t)}function init_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function init_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function init_setPrototypeOf(t,r){return init_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},init_setPrototypeOf(t,r)}function init_createSuper(t){var r=function init_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=init_getPrototypeOf(t);if(r){var i=init_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return init_possibleConstructorReturn(this,a)}}function init_possibleConstructorReturn(t,r){if(r&&("object"===init_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function init_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function init_getPrototypeOf(t){return init_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},init_getPrototypeOf(t)}function init_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}function init_regeneratorRuntime(){init_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==init_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function init_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}Hooks.once("init",(function(){loadTemplates(["systems/dsa5/templates/actors/actor-main.html","systems/dsa5/templates/actors/actor-talents.html","systems/dsa5/templates/items/item-description.html","systems/dsa5/templates/dialog/default-dialog.html","systems/dsa5/templates/dialog/parts/targets.html","systems/dsa5/templates/dialog/enhanced-default-dialog.html","systems/dsa5/templates/dialog/default-combat-dialog.html","systems/dsa5/templates/chat/roll/test-card.html","systems/dsa5/templates/items/item-equipment.html","systems/dsa5/templates/items/item-enchantment.html","systems/dsa5/templates/actors/actor-combat.html","systems/dsa5/templates/actors/actor-equipment.html","systems/dsa5/templates/actors/actor-notes.html","systems/dsa5/templates/chat/post-item.html","systems/dsa5/templates/items/item-stat.html","systems/dsa5/templates/items/item-extension.html","systems/dsa5/templates/actors/creature/creature-main.html","systems/dsa5/templates/actors/creature/creature-loot.html","systems/dsa5/templates/actors/creature/creature-combat.html","systems/dsa5/templates/actors/creature/creature-notes.html","systems/dsa5/templates/actors/creature/creature-magic.html","systems/dsa5/templates/actors/creature/creature-religion.html","systems/dsa5/templates/actors/parts/characteristics-small.html","systems/dsa5/templates/actors/parts/characteristics-large.html","systems/dsa5/templates/actors/parts/gearSearch.html","systems/dsa5/templates/actors/parts/magicalSigns.html","systems/dsa5/templates/actors/parts/containerContent.html","systems/dsa5/templates/actors/npc/npc-main.html","systems/dsa5/templates/actors/character/actor-magic.html","systems/dsa5/templates/actors/character/actor-religion.html","systems/dsa5/templates/actors/character/actor-aggregatedtests.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-small.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-large.html","systems/dsa5/templates/actors/parts/status_effects.html","systems/dsa5/templates/actors/parts/purse.html","systems/dsa5/templates/actors/parts/healthbar.html","systems/dsa5/templates/actors/merchant/merchant-commerce.html","systems/dsa5/templates/items/item-header.html","systems/dsa5/templates/items/item-effects.html","systems/dsa5/templates/items/item-aoe.html","systems/dsa5/templates/items/traditionArtifact.html","systems/dsa5/templates/status/advanced_functions.html","systems/dsa5/templates/actors/parts/information.html"]),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsa5",O,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsa5",E,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsa5",C,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsa5",ye,{types:["npc"]}),Actors.registerSheet("dsa5",qe,{types:["creature"]}),Actors.registerSheet("dsa5",Ue,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsa5",se.Z,{makeDefault:!0}),Journal.registerSheet("dsa5",Ve,{makeDefault:!0}),L.setupSheets(),function configuration(){var t,r,a,o,i=function redrawMasterMenu(){game.user.isGM&&game.dsa5.apps.gameMasterMenu.render()};game.settings.register("dsa5","meleeBotchTableEnabled",{name:"DSASETTINGS.meleeBotchTableEnabled",hint:"DSASETTINGS.meleeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","rangeBotchTableEnabled",{name:"DSASETTINGS.rangeBotchTableEnabled",hint:"DSASETTINGS.rangeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","defenseBotchTableEnabled",{name:"DSASETTINGS.defenseBotchTableEnabled",hint:"DSASETTINGS.defenseBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","higherDefense",{name:"DSASETTINGS.higherDefense",hint:"DSASETTINGS.higherDefenseHint",scope:"world",config:!0,default:"0",type:String,choices:{0:"0",2:"+2",4:"+4"}}),game.settings.register("dsa5","informationDistribution",{name:"DSASETTINGS.informationDistribution",hint:"DSASETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("DSASETTINGS.information0"),1:game.i18n.localize("DSASETTINGS.information1"),2:game.i18n.localize("DSASETTINGS.information2")}}),game.settings.register("dsa5","enableItemDropToCanvas",{name:"DSASETTINGS.enableItemDropToCanvas",hint:"DSASETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","statusEffectCounterColor",{name:"DSASETTINGS.statusEffectCounterColor",hint:"DSASETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsa5","migrationVersion",{name:"migrationVersion",hint:"migrationVersion",scope:"world",config:!1,default:20,type:Number}),game.settings.register("dsa5","firstTimeStart",{name:"firstTimeStart",hint:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","defaultConfigFinished",{name:"defaultConfigFinished",hint:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","tokenizerSetup",{name:"tokenizerSetup",hint:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","capQSat",{name:"DSASETTINGS.capQSat",hint:"DSASETTINGS.capQSatHint",scope:"world",config:!0,default:6,type:Number}),game.settings.register("dsa5","hideEffects",{name:"DSASETTINGS.hideEffects",hint:"DSASETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","inventorySound",{name:"DSASETTINGS.inventorySound",hint:"DSASETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","talentModifierEnabled",{name:"DSASETTINGS.talentModifierEnabled",hint:"DSASETTINGS.talentModifierEnabledHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","noConfirmationRoll",{name:"DSASETTINGS.noConfirmationRoll",hint:"DSASETTINGS.noConfirmationRollHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","lessRegeneration",{name:"DSASETTINGS.lessRegeneration",hint:"DSASETTINGS.lessRegenerationHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","limitCombatSpecAbs",{name:"DSASETTINGS.limitCombatSpecAbs",hint:"DSASETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","allowPhysicalDice",{name:"DSASETTINGS.allowPhysicalDice",hint:"DSASETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideOpposedDamage",{name:"DSASETTINGS.hideOpposedDamage",hint:"DSASETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableForeignSpellModifer",{name:"DSASETTINGS.enableForeignSpellModifer",hint:"DSASETTINGS.enableForeignSpellModiferHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","playerCanEditSpellMacro",{name:"DSASETTINGS.playerCanEditSpellMacro",hint:"DSASETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableDPS",{name:"DSASETTINGS.enableDPS",hint:"DSASETTINGS.enableDPSHint",scope:"world",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","iniTrackerSize",{name:"DSASETTINGS.iniTrackerSize",hint:"DSASETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:(t=configuration_asyncToGenerator(configuration_regeneratorRuntime().mark((function _callee(t){return configuration_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=t;case 1:case"end":return r.stop()}}),_callee)}))),function onChange(r){return t.apply(this,arguments)})}),game.settings.register("dsa5","tokenhotbarSize",{name:"DSASETTINGS.tokenhotbarSize",hint:"DSASETTINGS.tokenhotbarSizeHint",scope:"client",config:!0,default:35,type:Number,range:{min:15,max:100,step:5},onChange:(r=configuration_asyncToGenerator(configuration_regeneratorRuntime().mark((function _callee2(t){return configuration_regeneratorRuntime().wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=t;case 1:case"end":return r.stop()}}),_callee2)}))),function onChange(t){return r.apply(this,arguments)})}),game.settings.register("dsa5","tokenhotbarLayout",{name:"DSASETTINGS.tokenhotbarLayout",hint:"DSASETTINGS.tokenhotbarLayoutHint",scope:"client",config:!0,default:0,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("DSASETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("DSASETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("DSASETTINGS.tokenhotbarLayout3")}}),game.settings.register("dsa5","selfControlOnPain",{name:"DSASETTINGS.selfControlOnPain",hint:"DSASETTINGS.selfControlOnPainHint",scope:"world",config:!0,default:1,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.selfControlOnPain0"),1:game.i18n.localize("DSASETTINGS.selfControlOnPain1"),2:game.i18n.localize("DSASETTINGS.selfControlOnPain2")}}),game.settings.register("dsa5","forceLanguage",{name:"DSASETTINGS.forceLanguage",hint:"DSASETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German",en:"English"}}),game.settings.register("dsa5","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","iniTrackerPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","soundConfig",{name:"DSASETTINGS.soundConfig",hint:"DSASETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:(a=configuration_asyncToGenerator(configuration_regeneratorRuntime().mark((function _callee3(){return configuration_regeneratorRuntime().wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:m.Z.loadSoundConfig();case 1:case"end":return t.stop()}}),_callee3)}))),function onChange(){return a.apply(this,arguments)})}),game.settings.registerMenu("dsa5","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("DSASETTINGS.changelog"),type:Pe,restricted:!1}),game.settings.registerMenu("dsa5","resetTokenbar",{name:game.i18n.localize("DSASETTINGS.resetTokenbar"),label:game.i18n.localize("DSASETTINGS.resetTokenbar"),hint:game.i18n.localize("DSASETTINGS.resetTokenbarHint"),type:Ee,restricted:!1}),game.settings.register("dsa5","breadcrumbs",{name:"DSASETTINGS.breadcrumbs",hint:"DSASETTINGS.breadcrumbsHint",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsa5","groupschips",{name:"DSASETTINGS.groupschips",hint:"DSASETTINGS.groupschips",scope:"world",config:!1,default:"0/0",type:String,onChange:(o=configuration_asyncToGenerator(configuration_regeneratorRuntime().mark((function _callee4(){return configuration_regeneratorRuntime().wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:i();case 1:case"end":return t.stop()}}),_callee4)}))),function onChange(){return o.apply(this,arguments)})}),game.settings.register("dsa5","expandChatModifierlist",{name:"DSASETTINGS.expandChatModifierlist",hint:"DSASETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexWorldItems",{name:"DSASETTINGS.indexWorldItems",hint:"DSASETTINGS.indexWorldItemsHint",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","enableCombatFlow",{name:"DSASETTINGS.enableCombatFlow",hint:"DSASETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:function onchange(t){game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0)}}),game.settings.register("dsa5","enableCombatPan",{name:"DSASETTINGS.enableCombatPan",hint:"DSASETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","disableDidYouKnow",{name:"DSASETTINGS.disableDidYouKnow",hint:"DSASETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","scrollingFontsize",{name:"DSASETTINGS.scrollingFontsize",hint:"DSASETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsa5","armorAndWeaponDamage",{name:"DSASETTINGS.armorAndWeaponDamage",hint:"DSASETTINGS.armorAndWeaponDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexDescription",{name:"DSASETTINGS.indexDescription",hint:"DSASETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","encumbranceForRange",{name:"DSASETTINGS.encumbranceForRange",hint:"DSASETTINGS.encumbranceForRangeHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","obfuscateTokenNames",{name:"DSASETTINGS.obfuscateTokenNames",hint:"DSASETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("DSASETTINGS.yesNumbered"),2:game.i18n.localize("DSASETTINGS.renameNumbered"),3:game.i18n.localize("yes"),4:game.i18n.localize("DSASETTINGS.rename")}}),game.settings.register("dsa5","merchantNotification",{name:"DSASETTINGS.merchantNotification",hint:"DSASETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("yes"),2:game.i18n.localize("MERCHANT.onlyGM")}}),game.settings.register("dsa5","sightOptions",{name:"sightOptions",scope:"world",config:!1,default:"0.5|0.7|0.85|0.95",type:String}),game.settings.register("dsa5","trackedActors",{name:"sightOptions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object})}(),Ae.Z.initDoorMinDistance(),mergeObject(CONFIG.JournalEntry.noteIcons,r.Z.noteIcons)})),Hooks.once("ready",(function(){We.showOneMessage(),Be.registerTokenHotbar(),function connectHook(){Hooks.on("dropCanvasData",function(){var t=itemDrop_asyncToGenerator(itemDrop_regeneratorRuntime().mark((function _callee5(t,r){return itemDrop_regeneratorRuntime().wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:if(game.settings.get("dsa5","enableItemDropToCanvas")||game.user.isGM||r.tokenId){a.next=2;break}return a.abrupt("return");case 2:"Item"==r.type?xe(t,r):"GroupDrop"==r.type&&Se(t,r);case 3:case"end":return a.stop()}}),_callee5)})));return function(r,a){return t.apply(this,arguments)}}())}(),Ye.connectHooks();Hooks.on("changeSidebarTab",(function hook(t){"settings"==t.tabName&&(Ke.Z.travelAgency(),Hooks.off("changeSidebarTab",hook))})),(0,Me.v)()})),Hooks.once("setup",(function(){["de","en"].includes(game.i18n.lang)||(console.warn("DSA5 - ".concat(game.i18n.lang," is not a supported language. Falling back to default language.")),game.settings.set("core","language","de").then((function(){return foundry.utils.debouncedReload()})));var t=game.settings.get("dsa5","forceLanguage");["de","en"].includes(t)&&game.i18n.lang!=t&&Je(t),function setupKnownEquipmentModifiers(){var t;game.dsa5.config.knownShortcuts=(init_defineProperty(t={},game.i18n.localize("CHARAbbrev.INI").toLowerCase(),["status","initiative","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.GS").toLowerCase(),["status","speed","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.AsP").toLowerCase(),["status","astralenergy","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.LeP").toLowerCase(),["status","wounds","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.KaP").toLowerCase(),["status","karmaenergy","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.AW").toLowerCase(),["status","dodge","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.SK").toLowerCase(),["status","soulpower","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.ZK").toLowerCase(),["status","toughness","gearmodifier"]),init_defineProperty(t,game.i18n.localize("CHARAbbrev.FtP").toLowerCase(),["status","fatePoints","gearmodifier"]),t);for(var r=0,a=["MU","KL","IN","CH","FF","GE","KO","KK"];r<a.length;r++){var o=a[r];game.dsa5.config.knownShortcuts[game.i18n.localize("CHARAbbrev.".concat(o)).toLowerCase()]=["characteristics",o.toLowerCase(),"gearmodifier"]}}(),je.initHook(),keybindings(),Ne.registerButtons(),Ce.Z.registerButtons(),CONFIG.Canvas.lightAnimations.daylight={label:"LIGHT.daylight",illuminationShader:Qe},a.Z.setupFunctions(),i.Z.setupFunctions()}));var Je=function showWrongLanguageDialog(t){var r,a={title:game.i18n.localize("DSASETTINGS.forceLanguage"),content:game.i18n.format("DSAError.wrongLanguage",{lang:t}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:(r=function init_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){init_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){init_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}(init_regeneratorRuntime().mark((function _callee(){return init_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,game.settings.set("core","language",t);case 2:foundry.utils.debouncedReload();case 3:case"end":return r.stop()}}),_callee)}))),function callback(){return r.apply(this,arguments)})},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new Dialog(a).render(!0)};var Qe=function(t){!function init_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&init_setPrototypeOf(t,r)}(DaylightIlluminationShader,AdaptiveIlluminationShader);var r=init_createSuper(DaylightIlluminationShader);function DaylightIlluminationShader(){return init_classCallCheck(this,DaylightIlluminationShader),r.apply(this,arguments)}return function init_createClass(t,r,a){return r&&init_defineProperties(t.prototype,r),a&&init_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DaylightIlluminationShader)}();function macroControl_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}init_defineProperty(Qe,"fragmentShader","\n    ".concat(Qe.SHADER_HEADER,"\n    ").concat(Qe.PERCEIVED_BRIGHTNESS,"\n\n    void main() {\n        ").concat(Qe.FRAGMENT_BEGIN,"\n        ").concat(Qe.TRANSITION,"\n       \n        // Darkness\n        framebufferColor = max(framebufferColor, colorBackground);        \n        // Elevation\n        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        \n        // Final\n        gl_FragColor = vec4(finalColor, 1.0);\n      }"));var Xe=function(){function MacroDSA5(){!function macroControl_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,MacroDSA5)}return function macroControl_createClass(t,r,a){return r&&macroControl_defineProperties(t.prototype,r),a&&macroControl_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(MacroDSA5,null,[{key:"weaponLessMacro",value:function weaponLessMacro(t){var r,a=ChatMessage.getSpeaker();a.token&&(r=game.actors.tokens[a.token]),r||(r=game.actors.get(a.actor)),this.runWeaponless(r,t,a.token)}},{key:"weaponLessMacroId",value:function weaponLessMacroId(t,r){var a=game.actors.get(r);this.runWeaponless(a,t)}},{key:"requestRoll",value:function requestRoll(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;we.Z.showRQMessage(t,r)}},{key:"requestGC",value:function requestGC(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};we.Z.showGCMessage(t,r,a)}},{key:"rollCh",value:function rollCh(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};c.Z.check3D20(void 0,t,r)}},{key:"itemMacroById",value:function itemMacroById(t,r,a,o){var i=game.actors.get(t),c=i?i.items.find((function(t){return t.name===r&&t.type==a})):null;this.runItem(i,c,r,o)}},{key:"itemMacro",value:function itemMacro(t,r,a){var o,i=ChatMessage.getSpeaker();i.token&&(o=game.actors.tokens[i.token]),o||(o=game.actors.get(i.actor));var c=o?o.items.find((function(a){return a.name===t&&a.type==r})):null;this.runItem(o,c,t,a,i.token)}},{key:"charMacroById",value:function charMacroById(t,r){var a=game.actors.get(r);this.runChar(a,t)}},{key:"charMacro",value:function charMacro(t){var r,a=ChatMessage.getSpeaker();a.token&&(r=game.actors.tokens[a.token]),r||(r=game.actors.get(a.actor)),this.runChar(r,t,a.token)}},{key:"runWeaponless",value:function runWeaponless(t,r,a){if(!t)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:r}));var o=r.split("Weaponless")[0];t.setupWeaponless(o,{},a).then((function(r){t.basicTest(r)}))}},{key:"runChar",value:function runChar(t,r,a){if(!t)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:r}));t.setupDodge({},a).then((function(r){t.basicTest(r)}))}},{key:"runItem",value:function runItem(t,r,a,o,i){if(!t)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:a}));switch(r.type){case"combatskill":case"trait":case"meleeweapon":return t.setupWeapon(r,o.mod,o,i).then((function(r){t.basicTest(r)}));case"rangeweapon":return t.setupWeapon(r,"attack",o,i).then((function(r){t.basicTest(r)}));case"skill":return t.setupSkill(r,o,i).then((function(r){t.basicTest(r)}));case"ceremony":case"ritual":case"spell":case"liturgy":return t.setupSpell(r,o,i).then((function(r){t.basicTest(r)}))}}}]),MacroDSA5}();function ownKeys(t,r){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.push.apply(a,o)}return a}function _objectSpread(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(a),!0).forEach((function(r){itemlibrary_advanced_filters_defineProperty(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(a,r))}))}return t}function itemlibrary_advanced_filters_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var et={};Hooks.once("ready",(function(){Promise.all([t.Z.allSkillsList(),t.Z.allCombatSkills()]).then((function(t){var a=t[0].reduce((function(t,r){return _objectSpread(_objectSpread({},t),{},itemlibrary_advanced_filters_defineProperty({},r,r))}),{}),o=t[1].filter((function(t){return"range"==t.system.weapontype.value})).sort((function(t,r){return t.name.localeCompare(r.name)})).reduce((function(t,r){return _objectSpread(_objectSpread({},t),{},itemlibrary_advanced_filters_defineProperty({},r.name,r.name))}),{}),i=t[1].filter((function(t){return"melee"==t.system.weapontype.value})).sort((function(t,r){return t.name.localeCompare(r.name)})).reduce((function(t,r){return _objectSpread(_objectSpread({},t),{},itemlibrary_advanced_filters_defineProperty({},r.name,r.name))}),{}),c=t[1].sort((function(t,r){return t.name.localeCompare(r.name)})).reduce((function(t,r){return _objectSpread(_objectSpread({},t),{},itemlibrary_advanced_filters_defineProperty({},r.name,r.name))}),{});mergeObject(et,{ammunition:[{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:r.Z.ammunitiongroups}],equipment:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:r.Z.equipmentTypes}],rangeweapon:[{label:"combatskill",attr:"combatskill.value",type:"select",options:o},{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:r.Z.ammunitiongroups}],meleeweapon:[{label:"combatskill",attr:"combatskill.value",type:"select",options:i},{label:"guidevalue",attr:"guidevalue.value",type:"select",options:r.Z.combatskillsGuidevalues},{label:"reach",attr:"reach.value",type:"select",options:r.Z.meleeRanges}],poison:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:r.Z.magicResistanceModifiers}],disease:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:r.Z.magicResistanceModifiers}],consumable:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:r.Z.equipmentTypes}],application:[{label:"skill",attr:"skill",type:"select",options:a}],trait:[{label:"traitType",attr:"traitType.value",type:"select",options:r.Z.traitCategories}],career:[{label:"mageLevel",attr:"mageLevel.value",type:"select",options:r.Z.mageLevels}],specialability:[{label:"Category",attr:"category.value",type:"select",options:r.Z.specialAbilityCategories},{label:"combatskill",attr:"list.value",type:"select",options:c,notStrict:!0}],liturgy:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:r.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spell:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:r.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ritual:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:r.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ceremony:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:r.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spellextension:[{label:"Category",attr:"category",type:"select",options:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}],magictrick:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],blessing:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],npc:[{label:"species",attr:"details.species.value",type:"text"},{label:"career",attr:"details.career.value",type:"text"},{label:"culture",attr:"details.culture.value",type:"text"}],character:[{label:"species",attr:"details.species.value",type:"text"},{label:"career",attr:"details.career.value",type:"text"},{label:"culture",attr:"details.culture.value",type:"text"}],creature:[{label:"creatureClass",attr:"creatureClass.value",type:"text"},{label:"sizeCategory",attr:"status.size.value",type:"select",options:r.Z.sizeCategories}],armor:[{label:"protection",attr:"protection.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}},{label:"encumbrance",attr:"encumbrance.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4"}}],plant:[{label:"PLANT.landscape",attr:"location.landscape",type:"text"},{label:"PLANT.region",attr:"location.region",type:"text"},{label:"PLANT.healing",attr:"planttype.healing",type:"checkbox"},{label:"PLANT.poison",attr:"planttype.poison",type:"checkbox"},{label:"PLANT.physical",attr:"planttype.physical",type:"checkbox"},{label:"PLANT.psychic",attr:"planttype.psychic",type:"checkbox"},{label:"PLANT.crop",attr:"planttype.crop",type:"checkbox"},{label:"PLANT.defensive",attr:"planttype.defensive",type:"checkbox"},{label:"PLANT.supernatural",attr:"planttype.supernatural",type:"checkbox"},{label:"PLANT.highNorth",attr:"availability.highNorth",type:"range"},{label:"PLANT.grasLands",attr:"availability.grasLands",type:"range"},{label:"PLANT.swamps",attr:"availability.swamps",type:"range"},{label:"PLANT.woods",attr:"availability.woods",type:"range"},{label:"PLANT.jungle",attr:"availability.jungle",type:"range"},{label:"PLANT.mountains",attr:"availability.mountains",type:"range"},{label:"PLANT.desert",attr:"availability.desert",type:"range"},{label:"PLANT.maraskan",attr:"availability.maraskan",type:"range"}],magicalsign:[],patron:[],demonmark:[]})}))}));const tt=et;function itemlibrary_typeof(t){return itemlibrary_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},itemlibrary_typeof(t)}function itemlibrary_toConsumableArray(t){return function itemlibrary_arrayWithoutHoles(t){if(Array.isArray(t))return itemlibrary_arrayLikeToArray(t)}(t)||function itemlibrary_iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||itemlibrary_unsupportedIterableToArray(t)||function itemlibrary_nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function itemlibrary_get(){return itemlibrary_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=itemlibrary_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},itemlibrary_get.apply(this,arguments)}function itemlibrary_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=itemlibrary_getPrototypeOf(t)););return t}function itemlibrary_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=itemlibrary_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function itemlibrary_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return itemlibrary_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?itemlibrary_arrayLikeToArray(t,r):void 0}}function itemlibrary_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function itemlibrary_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&itemlibrary_setPrototypeOf(t,r)}function itemlibrary_setPrototypeOf(t,r){return itemlibrary_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},itemlibrary_setPrototypeOf(t,r)}function itemlibrary_createSuper(t){var r=function itemlibrary_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=itemlibrary_getPrototypeOf(t);if(r){var i=itemlibrary_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return itemlibrary_possibleConstructorReturn(this,a)}}function itemlibrary_possibleConstructorReturn(t,r){if(r&&("object"===itemlibrary_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function itemlibrary_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function itemlibrary_getPrototypeOf(t){return itemlibrary_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},itemlibrary_getPrototypeOf(t)}function itemlibrary_regeneratorRuntime(){itemlibrary_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==itemlibrary_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function itemlibrary_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function itemlibrary_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){itemlibrary_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){itemlibrary_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function itemlibrary_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function itemlibrary_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function itemlibrary_createClass(t,r,a){return r&&itemlibrary_defineProperties(t.prototype,r),a&&itemlibrary_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}var rt=function(){function SearchDocument(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};itemlibrary_classCallCheck(this,SearchDocument);var a=t.documentName||t.type;switch(t.documentName){case"Actor":case"Item":a=t.type}var o="";if(game.settings.get("dsa5","indexDescription"))switch(a){case"creature":case"npc":case"character":o=getProperty(t,"system.description.value");break;case"JournalEntry":o=getProperty(t,"system.content");break;default:o=getProperty(t,"description.value")}this.document={name:t.name,filterType:a,data:$("<div>").html(o).text(),id:t.id||t._id,visible:!t.visible||t.visible,compendium:t.compendium?t.compendium.metadata.packageName:r.packageName||"",pack:t.pack||(r.packageName?r.id:void 0),img:t.img}}var t,r;return itemlibrary_createClass(SearchDocument,[{key:"uuid",get:function get(){if(this.document.compendium)return"Compendium.".concat(this.document.pack,".").concat(this.document.id);switch(this.itemType){case"character":case"creature":case"npc":return"Actor.".concat(this.id);case"JournalEntry":return"JournalEntry.".concat(this.id);default:return"Item.".concat(this.id)}}},{key:"name",get:function get(){return this.document.name}},{key:"data",get:function get(){return this.document.data}},{key:"id",get:function get(){return this.document.id}},{key:"itemType",get:function get(){return this.document.filterType}},{key:"getItem",value:(r=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee(){return itemlibrary_regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fromUuid(this.uuid);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee,this)}))),function getItem(){return r.apply(this,arguments)})},{key:"hasPermission",value:function hasPermission(){return this.document.visible}},{key:"render",value:(t=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee2(){return itemlibrary_regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.getItem();case 2:t.sent.sheet.render(!0);case 3:case"end":return t.stop()}}),_callee2,this)}))),function render(){return t.apply(this,arguments)})},{key:"compendium",get:function get(){return this.document.compendium}},{key:"img",get:function get(){return"JournalEntry"==this.itemType?"systems/dsa5/icons/categories/DSA-Auge.webp":this.document.img}}]),SearchDocument}(),nt=function(t){itemlibrary_inherits(AdvancedSearchDocument,t);var r=itemlibrary_createSuper(AdvancedSearchDocument);function AdvancedSearchDocument(t,a){var o;itemlibrary_classCallCheck(this,AdvancedSearchDocument),o=r.call(this,t);var i,c=itemlibrary_createForOfIteratorHelper(tt[a]||[]);try{for(c.s();!(i=c.n()).done;){var u=i.value;o[u.attr]=u.attr.split(".").reduce((function(t,r){return void 0===t[r]?{}:t[r]}),t.system)}}catch(t){c.e(t)}finally{c.f()}return o}return itemlibrary_createClass(AdvancedSearchDocument)}(rt),at=function(r){itemlibrary_inherits(DSA5ItemLibrary,Application);var a,o,i,c,u,l,p,d,h,m,y,g,v,_=itemlibrary_createSuper(DSA5ItemLibrary);function DSA5ItemLibrary(t){var r;return itemlibrary_classCallCheck(this,DSA5ItemLibrary),(r=_.call(this,t)).advancedFiltering=!1,r.journalBuild=!1,r.journalWorldBuild=!1,r.equipmentBuild=!1,r.equipmentWorldBuild,r.zooBuild=!1,r.zooWorldBuild=!1,r.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},r.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),r.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),r.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),r.detailFilter={},r.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},r.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1,disease:!1,consumable:!1,plant:!1},filterBy:{search:""}},character:{categories:{career:!1,advantage:!1,combatskill:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1,application:!1,demonmark:!1,patron:!1},filterBy:{search:""}},spell:{categories:{blessing:!1,ceremony:!1,liturgy:!1,magictrick:!1,ritual:!1,spell:!1,spellextension:!1,magicalsign:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}},r}return itemlibrary_createClass(DSA5ItemLibrary,[{key:"getData",value:(v=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee3(t){var r;return itemlibrary_regeneratorRuntime().wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,itemlibrary_get(itemlibrary_getPrototypeOf(DSA5ItemLibrary.prototype),"getData",this).call(this,t);case 2:if((r=a.sent).categories=this.translateFilters(),r.isGM=game.user.isGM,r.items=this.items,r.advancedMode=this.advancedFiltering?"on":"",r.worldIndexed=game.settings.get("dsa5","indexWorldItems")?"on":"",r.fullTextEnabled=game.settings.get("dsa5","indexDescription")?"on":"",!this.advancedFiltering){a.next=13;break}return a.next=12,this.buildDetailFilter("tbd",this.subcategory);case 12:r.advancedFilter=a.sent;case 13:return a.abrupt("return",r);case 14:case"end":return a.stop()}}),_callee3,this)}))),function getData(t){return v.apply(this,arguments)})},{key:"translateFilters",value:function translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo),journal:this.buildFilter(this.filters.journal)}}},{key:"purgeAdvancedFilters",value:function purgeAdvancedFilters(){var t=this;for(var r in this.filters)for(var a in this.filters[r].categories)this.filters[r].categories[a]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then((function(r){$(t._element).find(".advancedSearch .groupbox").html(r)}))}},{key:"buildFilter",value:function buildFilter(t){var r=[];return Object.keys(t.categories).forEach((function(a){r.push({label:game.i18n.localize(a),selected:t.categories[a],key:a})})),r=r.sort((function(t,r){return t.label.localeCompare(r.label)}))}},{key:"getRandomItems",value:(g=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee4(t,r){var a,o;return itemlibrary_regeneratorRuntime().wrap((function _callee4$(i){for(;;)switch(i.prev=i.next){case 0:return a=[],o=this.equipmentIndex,i.t0=a.push,i.t1=a,i.t2=itemlibrary_toConsumableArray,i.next=7,o.search(t,{field:["itemType"]});case 7:return i.t3=i.sent,i.t4=(0,i.t2)(i.t3),i.t0.apply.call(i.t0,i.t1,i.t4),i.next=12,Promise.all(this.shuffle(a.filter((function(t){return t.hasPermission}))).slice(0,r+5).map((function(t){return t.getItem()})));case 12:return i.abrupt("return",i.sent.filter((function(t){var r=t.getFlag("dsa5","enchantments");return!r||!r.find((function(t){return t.talisman}))})).slice(0,r));case 13:case"end":return i.stop()}}),_callee4,this)}))),function getRandomItems(t,r){return g.apply(this,arguments)})},{key:"shuffle",value:function shuffle(t){for(var r,a,o=t.length;0!==o;)a=Math.floor(Math.random()*o),r=t[o-=1],t[o]=t[a],t[a]=r;return t}},{key:"findCompendiumItem",value:(y=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee5(t,r){var a,o,i,c=arguments;return itemlibrary_regeneratorRuntime().wrap((function _callee5$(u){for(;;)switch(u.prev=u.next){case 0:if(a=!(c.length>2&&void 0!==c[2])||c[2],this.equipmentBuild){u.next=4;break}return u.next=4,this.buildEquipmentIndex();case 4:return o={field:["name"],where:{itemType:r}},u.next=7,this.equipmentIndex.search(t,o);case 7:return i=u.sent,a&&(i=i.filter((function(t){return""!=t.compendium}))),u.next=11,Promise.all(i.map((function(t){return t.getItem()})));case 11:return u.abrupt("return",u.sent);case 12:case"end":return u.stop()}}),_callee5,this)}))),function findCompendiumItem(t,r){return y.apply(this,arguments)})},{key:"getCategoryItems",value:(m=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee6(t){var r,a=arguments;return itemlibrary_regeneratorRuntime().wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:return r=a.length>1&&void 0!==a[1]&&a[1],o.next=3,this.buildEquipmentIndex();case 3:if(!r){o.next=7;break}return o.next=6,Promise.all(this.equipmentIndex.search(t,{field:["itemType"]}).map((function(t){return t.getItem()})));case 6:return o.abrupt("return",o.sent.map((function(t){return t.toObject()})));case 7:return o.abrupt("return",this.equipmentIndex.search(t,{field:["itemType"]}));case 8:case"end":return o.stop()}}),_callee6,this)}))),function getCategoryItems(t){return m.apply(this,arguments)})},{key:"executeAdvancedFilter",value:(h=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee7(t,r,a,o,i){var c,u,l,p,d,h,m,y=arguments;return itemlibrary_regeneratorRuntime().wrap((function _callee7$(g){for(;;)switch(g.prev=g.next){case 0:return c=y.length>5&&void 0!==y[5]?y[5]:[],u=function selFnct(t){var r,o=itemlibrary_createForOfIteratorHelper(a);try{for(o.s();!(r=o.n()).done;){var i=r.value;if(t[2]?t[i[0]]!=i[1]:-1==t[i[0]].indexOf(i[1]))return!1}}catch(t){o.e(t)}finally{o.f()}return!0},l=function txtFnct(t){var r,a=itemlibrary_createForOfIteratorHelper(o);try{for(a.s();!(r=a.n()).done;){var i=r.value;if(-1==t[i[0]].toLowerCase().indexOf(i[1]))return!1}}catch(t){a.e(t)}finally{a.f()}return!0},p=function cbFnct(t){var r,a=itemlibrary_createForOfIteratorHelper(i);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(t[o[0]]!=o[1])return!1}}catch(t){a.e(t)}finally{a.f()}return!0},d=function rangeFct(t){var r,a=itemlibrary_createForOfIteratorHelper(c);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(t[o[0]]<o[1]||t[o[0]]>o[2])return!1}}catch(t){a.e(t)}finally{a.f()}return!0},h=r.where((function(r){return(""==t||-1!=r.name.toLowerCase().indexOf(t))&&u(r)&&l(r)&&p(r)&&d(r)})),m=(m=h).filter((function(t){return t.hasPermission})).sort((function(t,r){return t.name.toLowerCase()>r.name.toLowerCase()?1:-1})),g.abrupt("return",m);case 9:case"end":return g.stop()}}),_callee7)}))),function executeAdvancedFilter(t,r,a,o,i){return h.apply(this,arguments)})},{key:"advancedFilterStuff",value:(d=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee8(t,r){var a,o,i,c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T;return itemlibrary_regeneratorRuntime().wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:a=$(this._element).find(".detailFilters"),o=a.attr("data-subc"),i=this.filters[t].filterBy.search.toLowerCase(),c=this.detailFilter[o],u=[],l=[],p=[],d=itemlibrary_createForOfIteratorHelper(a.find("select"));try{for(d.s();!(h=d.n()).done;)m=h.value,""!=(y=$(m).val())&&u.push([$(m).attr("name"),y,"true"!=m.dataset.notstrict])}catch(t){d.e(t)}finally{d.f()}g=itemlibrary_createForOfIteratorHelper(a.find('input[type="text"]:not(.manualFilter)'));try{for(g.s();!(v=g.n()).done;)_=v.value,""!=(b=$(_).val())&&l.push([$(_).attr("name"),b.toLowerCase()])}catch(t){g.e(t)}finally{g.f()}w=itemlibrary_createForOfIteratorHelper(a.find('input[type="checkbox"]:checked:not(.manualFilter)'));try{for(w.s();!(k=w.n()).done;)x=k.value,""!=(S=$(x).val())&&p.push([$(x).attr("name"),S.toLowerCase()])}catch(t){w.e(t)}finally{w.f()}return r.next=15,this.executeAdvancedFilter(i,c,u,l,p);case 15:return T=r.sent,this.setBGImage(T,t),r.abrupt("return",T);case 18:case"end":return r.stop()}}),_callee8,this)}))),function advancedFilterStuff(t,r){return d.apply(this,arguments)})},{key:"filterStuff",value:(p=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee9(t,r,a){var o,i,c,u,l,p,d,h;return itemlibrary_regeneratorRuntime().wrap((function _callee9$(m){for(;;)switch(m.prev=m.next){case 0:for(l in o=this.filters[t].filterBy.search,i={field:["name","data"],limit:60,page:a||!0},c=[],u=!1,this.filters[t].categories)this.filters[t].categories[l]&&(d=void 0,""==o?d=r.search(l,{field:["itemType"],limit:60,page:a||!0}):(h=duplicate(i),mergeObject(h,{where:{itemType:l}}),d=r.search(o,h)),this.pages[t].next=d.next,(p=c).push.apply(p,itemlibrary_toConsumableArray(d.result))),u=this.filters[t].categories[l]||u;return u||(c=r.search(o,i),this.pages[t].next=c.next),c=(c=c.result?c.result:c).filter((function(t){return t.hasPermission})).sort((function(t,r){return t.name.toLowerCase()>r.name.toLowerCase()?1:-1})),this.setBGImage(c,t),m.abrupt("return",c);case 10:case"end":return m.stop()}}),_callee9,this)}))),function filterStuff(t,r,a){return p.apply(this,arguments)})},{key:"setBGImage",value:function setBGImage(t,r){$(this._element).find(".".concat(r," .libcontainer"))["".concat(t.length>0?"remove":"add","Class")]("libraryImg")}},{key:"renderResult",value:function renderResult(t,r,a,o){var i=a.index,c=a.itemType,u=t.find(".searchResult .item-list");renderTemplate("systems/dsa5/templates/system/libraryItem.html",{items:r}).then((function(t){o||u.empty(),(t=$(t)).each((function(){var t=$(this);t.attr("draggable",!0).on("dragstart",(function(r){var a=i.find($(t).attr("data-item-id"));r.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:c,uuid:a.uuid}))}))})),u.append(t)}))}},{key:"filterItems",value:(l=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee10(t,r,a){var o,i,c;return itemlibrary_regeneratorRuntime().wrap((function _callee10$(u){for(;;)switch(u.prev=u.next){case 0:if(o=this.selectIndex(r),!this.advancedFiltering||"journal"==r){u.next=9;break}return u.next=4,this.advancedFilterStuff(r,a);case 4:return i=u.sent,this.renderResult(t,i,o,a),u.abrupt("return",i);case 9:return u.next=11,this.filterStuff(r,o.index,a);case 11:return c=u.sent,this.renderResult(t,c,o,a),u.abrupt("return",c);case 14:case"end":return u.stop()}}),_callee10,this)}))),function filterItems(t,r,a){return l.apply(this,arguments)})},{key:"selectIndex",value:function selectIndex(t){var r="Item",a=this.equipmentIndex;switch(t){case"zoo":r="Actor",a=this.zooIndex;break;case"journal":r="JournalEntry",a=this.journalIndex}return{index:a,itemType:r}}},{key:"_render",value:(u=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee11(){var t,r,a=arguments;return itemlibrary_regeneratorRuntime().wrap((function _callee11$(o){for(;;)switch(o.prev=o.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},o.next=4,itemlibrary_get(itemlibrary_getPrototypeOf(DSA5ItemLibrary.prototype),"_render",this).call(this,t,r);case 4:this.buildEquipmentIndex();case 5:case"end":return o.stop()}}),_callee11,this)}))),function _render(){return u.apply(this,arguments)})},{key:"buildEquipmentIndex",value:(c=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee12(){return itemlibrary_regeneratorRuntime().wrap((function _callee12$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._createIndex("equipment","Item",game.items);case 2:case"end":return t.stop()}}),_callee12,this)}))),function buildEquipmentIndex(){return c.apply(this,arguments)})},{key:"_createIndex",value:(i=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee14(t,r,a){var o,i,c,u,l,p,d,h,m=this;return itemlibrary_regeneratorRuntime().wrap((function _callee14$(y){for(;;)switch(y.prev=y.next){case 0:if(!this["".concat(t,"Build")]){y.next=2;break}return y.abrupt("return");case 2:return SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:0}),o=$(this._element).find('*[data-tab="'.concat(t,'"]')),this.showLoading(o,t),i=game.packs.filter((function(t){return t.documentName==r&&(game.user.isGM||!t.private)})),c=100/(i.length+1),u=c,l=["name","system.type","system.description.value","img"],p="Actor"==r?function func(t){return t.getIndex({actorFields:l})}:"JournalEntry"==r?function func(t){return t.getDocuments()}:function func(t){return t.getDocuments({type:{$in:game.system.documentTypes.Item}})},d=this.indexWorldItems(a,t),SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"world items"}),pct:Math.round(c)}),h=i.map(function(){var t=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee13(t){var r;return itemlibrary_regeneratorRuntime().wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,p(t);case 2:r=a.sent,u+=c,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"".concat(t.metadata.label," (").concat(t.metadata.id,")")}),pct:Math.round(u)}),d.push.apply(d,itemlibrary_toConsumableArray(r.map((function(r){return new rt(r,t.metadata)}))));case 6:case"end":return a.stop()}}),_callee13)})));return function(r){return t.apply(this,arguments)}}()),y.abrupt("return",Promise.all(h).then((function(r){m["".concat(t,"Index")].add(d),m["".concat(t,"Build")]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:100}),m.hideLoading(o,t)})));case 14:case"end":return y.stop()}}),_callee14,this)}))),function _createIndex(t,r,a){return i.apply(this,arguments)})},{key:"subcategoryFields",value:function subcategoryFields(t){var r,a=["name","itemType"],o=itemlibrary_createForOfIteratorHelper(tt[t]||[]);try{for(o.s();!(r=o.n()).done;){var i=r.value;a.push(i.attr)}}catch(t){o.e(t)}finally{o.f()}return a}},{key:"indexWorldItems",value:function indexWorldItems(t,r){var a=[];return game.settings.get("dsa5","indexWorldItems")&&(a.push.apply(a,itemlibrary_toConsumableArray(t.filter((function(t){return t.visible})).map((function(t){return new rt(t)})))),this["".concat(r,"WorldBuild")]=!0),a}},{key:"createDetailIndex",value:(o=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee15(t,r){var a,o,i,c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T;return itemlibrary_regeneratorRuntime().wrap((function _callee15$(A){for(;;)switch(A.prev=A.next){case 0:if(this.detailFilter[r]){A.next=39;break}a=this.subcategoryFields(r),(o=$(this._element).find('*[data-tab="'.concat(t,'"]'))).find(".searchResult ul").html(""),this.showLoading(o,t),this.detailFilter[r]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:a}}),i=this.selectIndex(t),c=i.index,u=i.itemType,l="Item"==u?game.items:game.actors,p=l.filter((function(t){return t.visible&&t.type==r})).map((function(t){return new nt(t,r)})),d=c.search(r,{field:["itemType"]}),h={},m=itemlibrary_createForOfIteratorHelper(d),A.prev=12,m.s();case 14:if((y=m.n()).done){A.next=22;break}if((g=y.value).document.pack){A.next=18;break}return A.abrupt("continue",20);case 18:h[g.document.pack]||(h[g.document.pack]=[]),h[g.document.pack].push(g.document.id);case 20:A.next=14;break;case 22:A.next=27;break;case 24:A.prev=24,A.t0=A.catch(12),m.e(A.t0);case 27:return A.prev=27,m.f(),A.finish(27);case 30:for(v=[],_=0,b=Object.entries(h);_<b.length;_++)w=b[_],v.push(game.packs.get(w[0]).getDocuments({_id:{$in:w[1]},type:r}));return A.next=34,Promise.all(v);case 34:k=A.sent,x=itemlibrary_createForOfIteratorHelper(k);try{for(x.s();!(S=x.n()).done;)T=S.value,p.push.apply(p,itemlibrary_toConsumableArray(T.map((function(t){return new nt(t,r)}))))}catch(t){x.e(t)}finally{x.f()}this.detailFilter[r].add(p),this.hideLoading(o,t);case 39:case"end":return A.stop()}}),_callee15,this,[[12,24,27,30]])}))),function createDetailIndex(t,r){return o.apply(this,arguments)})},{key:"buildDetailFilter",value:(a=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee16(t,r){var a,o,i;return itemlibrary_regeneratorRuntime().wrap((function _callee16$(c){for(;;)switch(c.prev=c.next){case 0:if(!(a=tt[r]||[])){c.next=11;break}return o=this.createDetailIndex(t,r),c.next=5,renderTemplate("systems/dsa5/templates/system/detailFilter.html",{fields:a,subcategory:r});case 5:return i=c.sent,c.next=8,o;case 8:return c.abrupt("return",i);case 11:return c.abrupt("return","<p>".concat(game.i18n.localize("Library.selectAdvanced"),"</p>"));case 12:case"end":return c.stop()}}),_callee16,this)}))),function buildDetailFilter(t,r){return a.apply(this,arguments)})},{key:"checkWorldStuffIndex",value:function checkWorldStuffIndex(){game.settings.get("dsa5","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}},{key:"activateListeners",value:function activateListeners(r){var a=this;itemlibrary_get(itemlibrary_getPrototypeOf(DSA5ItemLibrary.prototype),"activateListeners",this).call(this,r),r.on("click",".toggleAdvancedMode",(function(){a.advancedFiltering=!a.advancedFiltering,a.advancedFiltering?($(a._element).find(".toggleAdvancedMode").addClass("on"),$(a._element).find(".advancedSearch").fadeIn(),a.purgeAdvancedFilters()):($(a._element).find(".toggleAdvancedMode").removeClass("on"),$(a._element).find(".advancedSearch").fadeOut())})),r.on("change",".detailFilters input, .detailFilters select",(function(){var t=$(a._element).find(".tab.active"),r=t.attr("data-tab");a.filterItems(t,r)})),r.on("click",".filter",function(){var t=itemlibrary_asyncToGenerator(itemlibrary_regeneratorRuntime().mark((function _callee17(t){var r,o,i,c;return itemlibrary_regeneratorRuntime().wrap((function _callee17$(u){for(;;)switch(u.prev=u.next){case 0:if(r=$(t.currentTarget).closest(".tab"),o=r.attr("data-tab"),i=$(t.currentTarget).attr("data-category"),c=$(t.currentTarget).is(":checked"),!a.advancedFiltering||!c){u.next=13;break}return a.purgeAdvancedFilters(),a.subcategory=i,$(t.currentTarget).prop("checked",c),u.t0=$(a._element).find(".advancedSearch .groupbox"),u.next=11,a.buildDetailFilter(o,i);case 11:u.t1=u.sent,u.t0.html.call(u.t0,u.t1);case 13:a.filters[o].categories[i]=c,a.filterItems(r,o);case 15:case"end":return u.stop()}}),_callee17)})));return function(r){return t.apply(this,arguments)}}()),r.on("click",".item-name",(function(t){a.getItemFromHTML(t).render()})),r.on("mousedown",".item-name",(function(r){2==r.button&&t.Z.showArtwork(a.getItemFromHTML(r))})),r.on("keyup",".filterBy-search",(function(t){var r=$(t.currentTarget).closest(".tab"),o=r.attr("data-tab");a.filters[o].filterBy.search=$(t.currentTarget).val(),a.filterItems(r,o)})),r.find('*[data-tab="journal"]').click((function(t){a._createIndex("journal","JournalEntry",game.journal)})),r.find('*[data-tab="zoo"]').click((function(t){a._createIndex("zoo","Actor",game.actors)})),r.find(".showDetails").click((function(t){var a=$(t.currentTarget).attr("data-btn");$(t.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),r.find(".".concat(a," .detailBox")).toggleClass("dsahidden")})),r.find(".toggleWorldIndex").click((function(t){game.settings.set("dsa5","indexWorldItems",!game.settings.get("dsa5","indexWorldItems")),a.checkWorldStuffIndex(),$(t.currentTarget).toggleClass("on")})),r.find(".fulltextsearch").click((function(t){game.settings.set("dsa5","indexDescription",!game.settings.get("dsa5","indexDescription")),$(t.currentTarget).toggleClass("on")}));var o=this;$(this._element).find(".window-content").on("scroll.infinit",debounce((function(t){if(!o.advancedFiltering){var a=$(t.target),i=a.scrollTop()+a.innerHeight()>=a[0].scrollHeight-100,c=r.find(".tabs .item.active").attr("data-tab");if(i&&o.pages[c].next){var u=r.find(".tab.active");o.filterItems.call(o,u,c,o.pages[c].next)}}}),100))}},{key:"getItemFromHTML",value:function getItemFromHTML(t){var r=$(t.currentTarget).parents(".browser-item").attr("data-item-id");switch($(t.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(r);case"journal":return this.journalIndex.find(r);default:return this.equipmentIndex.find(r)}}},{key:"showLoading",value:function showLoading(t,r){this.setBGImage([1],r),$('<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>'.concat(game.i18n.localize("Library.buildingIndex"),"</div>")).appendTo(t.find(".searchResult"))}},{key:"hideLoading",value:function hideLoading(t,r){this.setBGImage([],r),t.find(".loader").remove()}}],[{key:"defaultOptions",get:function get(){var t=itemlibrary_get(itemlibrary_getPrototypeOf(DSA5ItemLibrary),"defaultOptions",this);return t.id="DSA5ItemLibrary",t.classes.push("dsa5","itemlibrary"),t.height=800,t.width=800,t.resizable=!0,t.title=game.i18n.localize("ItemLibrary"),t.template="systems/dsa5/templates/system/itemlibrary.html",t.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],t}}]),DSA5ItemLibrary}();function initializer_typeof(t){return initializer_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},initializer_typeof(t)}function initializer_slicedToArray(t,r){return function initializer_arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function initializer_iterableToArrayLimit(t,r){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==a)return;var o,i,c=[],u=!0,l=!1;try{for(a=a.call(t);!(u=(o=a.next()).done)&&(c.push(o.value),!r||c.length!==r);u=!0);}catch(t){l=!0,i=t}finally{try{u||null==a.return||a.return()}finally{if(l)throw i}}return c}(t,r)||initializer_unsupportedIterableToArray(t,r)||function initializer_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function initializer_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=initializer_unsupportedIterableToArray(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function initializer_unsupportedIterableToArray(t,r){if(t){if("string"==typeof t)return initializer_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?initializer_arrayLikeToArray(t,r):void 0}}function initializer_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function initializer_regeneratorRuntime(){initializer_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==initializer_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function initializer_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function initializer_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){initializer_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){initializer_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function initializer_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function initializer_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function initializer_setPrototypeOf(t,r){return initializer_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},initializer_setPrototypeOf(t,r)}function initializer_createSuper(t){var r=function initializer_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=initializer_getPrototypeOf(t);if(r){var i=initializer_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return initializer_possibleConstructorReturn(this,a)}}function initializer_possibleConstructorReturn(t,r){if(r&&("object"===initializer_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function initializer_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function initializer_getPrototypeOf(t){return initializer_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},initializer_getPrototypeOf(t)}var ot=function(r){!function initializer_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&initializer_setPrototypeOf(t,r)}(DSA5Initializer,Dialog);var a,i,c,u=initializer_createSuper(DSA5Initializer);function DSA5Initializer(t,r,a){var o,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";initializer_classCallCheck(this,DSA5Initializer);var c,l,p={title:t,content:r,buttons:{initialize:{label:game.i18n.localize("initialize"),callback:(l=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee(){return initializer_regeneratorRuntime().wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(!o.lock){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,o.initialize();case 4:case"end":return t.stop()}}),_callee)}))),function callback(){return l.apply(this,arguments)})},cancel:{label:game.i18n.localize("cancel"),callback:(c=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee2(){return initializer_regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:if(!o.lock){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,o.dontInitialize();case 4:case"end":return t.stop()}}),_callee2)}))),function callback(){return c.apply(this,arguments)})}}};return(o=u.call(this,p)).module=a,o.lang=i,o.folders={},o.journals={},o.scenes={},o.actors={},o.lock=!1,o}return function initializer_createClass(t,r,a){return r&&initializer_defineProperties(t.prototype,r),a&&initializer_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5Initializer,[{key:"initialize",value:(c=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee13(){var t,r,a=this;return initializer_regeneratorRuntime().wrap((function _callee13$(i){for(;;)switch(i.prev=i.next){case 0:if(this.lock=!0,(t=$(this._element).find(".initialize")).prepend('<i class="fas fa-spinner fa-spin"></i>'),r={},i.prev=4,!game.settings.settings.has("".concat(this.module,".initialized"))){i.next=8;break}return i.next=8,game.settings.set(this.module,"initialized",!0);case 8:i.next=12;break;case 10:i.prev=10,i.t0=i.catch(4);case 12:return i.prev=12,i.next=15,fetch("modules/".concat(this.module,"/adventure").concat(this.lang,".json")).then(function(){var t=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee3(t){return initializer_regeneratorRuntime().wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.json());case 1:case"end":return r.stop()}}),_callee3)})));return function(r){return t.apply(this,arguments)}}()).then(function(){var t=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee4(t){return initializer_regeneratorRuntime().wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:r=t;case 1:case"end":return a.stop()}}),_callee4)})));return function(r){return t.apply(this,arguments)}}());case 15:i.next=27;break;case 17:return i.prev=17,i.t1=i.catch(12),i.prev=19,i.next=22,fetch("modules/".concat(this.module,"/adventure.json")).then(function(){var t=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee5(t){return initializer_regeneratorRuntime().wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.json());case 1:case"end":return r.stop()}}),_callee5)})));return function(r){return t.apply(this,arguments)}}()).then(function(){var t=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee6(t){return initializer_regeneratorRuntime().wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:r=t;case 1:case"end":return a.stop()}}),_callee6)})));return function(r){return t.apply(this,arguments)}}());case 22:i.next=27;break;case 24:i.prev=24,i.t2=i.catch(19),console.warn("Could not find book data for ".concat(this.module," import."));case 27:return i.next=29,fetch("modules/".concat(this.module,"/initialization").concat(this.lang,".json")).then(function(){var t=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee7(t){return initializer_regeneratorRuntime().wrap((function _callee7$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.json());case 1:case"end":return r.stop()}}),_callee7)})));return function(r){return t.apply(this,arguments)}}()).then(function(){var t=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee12(t){var i,c,u,l,p,d,h,m,y,g,v;return initializer_regeneratorRuntime().wrap((function _callee12$(_){for(;;)switch(_.prev=_.next){case 0:if(!(i=t.folders)){_.next=17;break}return _.next=4,a.getFolderForType("JournalEntry");case 4:return c=_.sent,u=t.folders[0].name,c&&(a.folders[c.data.name]=c,t.folders.shift()),_.next=9,Folder.create(i);case 9:l=_.sent,Array.isArray(l)||(l=[l]),p=initializer_createForOfIteratorHelper(l);try{for(p.s();!(d=p.n()).done;)h=d.value,a.folders[h.data.name]=h}catch(t){p.e(t)}finally{p.f()}for(y in m=[],a.folders)g=a.folders[y].getFlag("dsa5","parent"),(v=g==u?game.i18n.localize("".concat(a.module,".name")):g)&&m.push({_id:a.folders[y].id,parent:a.folders[v].id});return _.next=17,Folder.updateDocuments(m);case 17:if(!t.items){_.next=19;break}return _.delegateYield(initializer_regeneratorRuntime().mark((function _callee8(){var r,i,c,u,l,p;return initializer_regeneratorRuntime().wrap((function _callee8$(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,a.getFolderForType("Item");case 2:r=d.sent,i=[],c=[],u=initializer_createForOfIteratorHelper(t.items);try{for(p=function _loop(){var t=l.value;t.folder=r.id;var a=game.items.find((function(a){var o;return a.name==t.name&&(null===(o=a.folder)||void 0===o?void 0:o.id)==r.id}));a?(t._id=a.id,c.push(t)):i.push(t)},u.s();!(l=u.n()).done;)p()}catch(t){u.e(t)}finally{u.f()}return d.next=9,o.Z.create(i);case 9:return d.next=11,o.Z.updateDocuments(c);case 11:case"end":return d.stop()}}),_callee8)}))(),"t0",19);case 19:if(!t.playlists){_.next=21;break}return _.delegateYield(initializer_regeneratorRuntime().mark((function _callee9(){var r,o,i,c,u,l,p,d;return initializer_regeneratorRuntime().wrap((function _callee9$(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,a.getFolderForType("Playlist");case 2:return r=h.sent,o=[],i=[],c=game.packs.get(t.playlists),h.next=8,c.getDocuments();case 8:u=h.sent.map((function(t){return t.toObject()})),l=initializer_createForOfIteratorHelper(u);try{for(d=function _loop2(){var t=p.value;t.folder=r.id;var a=game.playlists.find((function(a){var o;return a.name==t.name&&(null===(o=a.folder)||void 0===o?void 0:o.id)==r.id}));a?(t._id=a.data._id,i.push(t)):o.push(t)},l.s();!(p=l.n()).done;)d()}catch(t){l.e(t)}finally{l.f()}return h.next=13,Playlist.create(o,{keepId:!0});case 13:return h.next=15,Playlist.updateDocuments(i);case 15:case"end":return h.stop()}}),_callee9)}))(),"t1",21);case 21:if(!t.scenes){_.next=23;break}return _.delegateYield(initializer_regeneratorRuntime().mark((function _callee10(){var r,o,i,c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T,A,O,P;return initializer_regeneratorRuntime().wrap((function _callee10$(E){for(;;)switch(E.prev=E.next){case 0:return E.next=2,a.getFolderForType("Scene");case 2:return r=E.sent,o=game.packs.get(t.scenes),E.next=6,o.getDocuments();case 6:return i=E.sent.map((function(t){return t.toObject()})),c=game.packs.get(t.journal),E.next=10,c.getDocuments();case 10:return u=E.sent.map((function(t){return t.toObject()})),E.next=13,a.getFolderForType("JournalEntry");case 13:l=E.sent,p=[],d=[],h=new Map,m=!1,y=initializer_createForOfIteratorHelper(i),E.prev=19,v=initializer_regeneratorRuntime().mark((function _loop3(){var t,o,i,c,y,v,_,b;return initializer_regeneratorRuntime().wrap((function _loop3$(w){for(;;)switch(w.prev=w.next){case 0:if(t=g.value,o=m,i=game.scenes.find((function(a){var o;return a.name==t.name&&(null===(o=a.folder)||void 0===o?void 0:o.id)==r.id})),m||!i){w.next=10;break}return w.next=6,new Promise((function(r,a){new Dialog({title:game.i18n.localize("Book.sceneReset"),content:game.i18n.format("Book.sceneResetDescription",{name:t.name}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function callback(){r([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("LocalizedIDs.all"),callback:function callback(){r([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function callback(){r([!1,!1])}}},close:function close(){r([!1,!1])}}).render(!0)}));case 6:c=w.sent,y=initializer_slicedToArray(c,2),o=y[0],m=y[1];case 10:if(!i||o){w.next=13;break}return a.scenes[i.name]=i,w.abrupt("return","continue");case 13:t.folder=r.id,v=initializer_createForOfIteratorHelper(t.notes),w.prev=15,b=initializer_regeneratorRuntime().mark((function _loop4(){var r,o,i,c,p,d;return initializer_regeneratorRuntime().wrap((function _loop4$(m){for(;;)switch(m.prev=m.next){case 0:if(r=_.value,m.prev=1,o=u.find((function(t){return t.flags.dsa5.initId==r.entryId})),h.has(o._id)){m.next=26;break}if(i=getProperty(o,"flags.dsa5.parent"),c=l,!a.folders[i]){m.next=10;break}c=a.folders[i],m.next=14;break;case 10:if(!i){m.next=14;break}return m.next=13,a.getFolderForType("JournalEntry",l.id,i,0,getProperty(o,"flags.dsa5.foldercolor")||"");case 13:c=m.sent;case 14:if(o.folder=c.id,!(p=game.journal.find((function(t){var a;return t.name==o.name&&(null===(a=t.folder)||void 0===a?void 0:a.id)==c.id&&t.flags.dsa5.initId==r.entryId})))){m.next=22;break}return m.next=19,p.update(o);case 19:h.set(o._id,p.id),m.next=26;break;case 22:return m.next=24,JournalEntry.create(o);case 24:d=m.sent,h.set(o._id,d.id);case 26:r.entryId=h.get(o._id),m.next=32;break;case 29:m.prev=29,m.t0=m.catch(1),console.warn("Could not initialize Scene Notes for scene :".concat(t.name)+m.t0);case 32:case"end":return m.stop()}}),_loop4,null,[[1,29]])})),v.s();case 18:if((_=v.n()).done){w.next=22;break}return w.delegateYield(b(),"t0",20);case 20:w.next=18;break;case 22:w.next=27;break;case 24:w.prev=24,w.t1=w.catch(15),v.e(w.t1);case 27:return w.prev=27,v.f(),w.finish(27);case 30:i?(t._id=i.id,d.push(t)):p.push(t);case 31:case"end":return w.stop()}}),_loop3,null,[[15,24,27,30]])})),y.s();case 22:if((g=y.n()).done){E.next=29;break}return E.delegateYield(v(),"t0",24);case 24:if("continue"!==E.t0){E.next=27;break}return E.abrupt("continue",27);case 27:E.next=22;break;case 29:E.next=34;break;case 31:E.prev=31,E.t1=E.catch(19),y.e(E.t1);case 34:return E.prev=34,y.f(),E.finish(34);case 37:return E.next=39,Scene.create(p);case 39:_=E.sent,b=initializer_createForOfIteratorHelper(_),E.prev=41,b.s();case 43:if((w=b.n()).done){E.next=53;break}return k=w.value,a.scenes[k.name]=k,E.next=48,k.createThumbnail();case 48:return x=E.sent,E.next=51,k.update({thumb:x.thumb},{diff:!1});case 51:E.next=43;break;case 53:E.next=58;break;case 55:E.prev=55,E.t2=E.catch(41),b.e(E.t2);case 58:return E.prev=58,b.f(),E.finish(58);case 61:S=0,T=d;case 62:if(!(S<T.length)){E.next=71;break}return A=T[S],O=game.scenes.get(A._id),E.next=67,O.update(A);case 67:a.scenes[A.name]=game.scenes.get(A._id);case 68:S++,E.next=62;break;case 71:if(!t.initialScene){E.next=79;break}return P=a.scenes[t.initialScene],E.next=75,game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0);case 75:return E.next=77,P.activate();case 77:return E.next=79,P.update({navigation:!0});case 79:case"end":return E.stop()}}),_callee10,null,[[19,31,34,37],[41,55,58,61]])}))(),"t2",23);case 23:if(!t.actors){_.next=25;break}return _.delegateYield(initializer_regeneratorRuntime().mark((function _callee11(){var o,i,c,u,l,p,d,h,m,y,g,v,_,b,w,k,x,S,T,A,O,P,E,C;return initializer_regeneratorRuntime().wrap((function _callee11$(D){for(;;)switch(D.prev=D.next){case 0:return D.next=2,a.getFolderForType("Actor");case 2:return o=D.sent,i=game.packs.get(t.actors),D.next=6,i.getDocuments();case 6:if(c=D.sent.map((function(t){return t.toObject()})),u=[],l=[],p=new Map,d=0,!getProperty(r,"chapters")){D.next=50;break}h=initializer_createForOfIteratorHelper(r.chapters),D.prev=13,h.s();case 15:if((m=h.n()).done){D.next=42;break}y=m.value,g=initializer_createForOfIteratorHelper(y.content),D.prev=18,g.s();case 20:if((v=g.n()).done){D.next=32;break}if(!(_=v.value).actors){D.next=30;break}b=!1,w=initializer_createForOfIteratorHelper(_.actors);try{for(w.s();!(k=w.n()).done;)x=k.value,p.has(x)||(p.set(x,_.name),b=!0)}catch(t){w.e(t)}finally{w.f()}if(!b){D.next=30;break}return D.next=29,a.getFolderForType("Actor",o.id,_.name,d);case 29:d+=1;case 30:D.next=20;break;case 32:D.next=37;break;case 34:D.prev=34,D.t0=D.catch(18),g.e(D.t0);case 37:return D.prev=37,g.f(),D.finish(37);case 40:D.next=15;break;case 42:D.next=47;break;case 44:D.prev=44,D.t1=D.catch(13),h.e(D.t1);case 47:return D.prev=47,h.f(),D.finish(47);case 50:S=initializer_createForOfIteratorHelper(c),D.prev=51,A=initializer_regeneratorRuntime().mark((function _loop5(){var t,r,i;return initializer_regeneratorRuntime().wrap((function _loop5$(c){for(;;)switch(c.prev=c.next){case 0:if(t=T.value,!p.has(t.name)){c.next=7;break}return c.next=4,a.getFolderForType("Actor",o.id,p.get(t.name));case 4:c.t0=c.sent,c.next=8;break;case 7:c.t0=o;case 8:if(r=c.t0,t.folder=r.id,t._id&&delete t._id,!(i=game.actors.find((function(a){var i;return a.name==t.name&&[o.id,r.id].includes(null===(i=a.folder)||void 0===i?void 0:i.id)})))){c.next=19;break}return t._id=i.id,c.next=16,i.deleteEmbeddedDocuments("Item",i.items.map((function(t){return t.id})));case 16:l.push(t),c.next=20;break;case 19:u.push(t);case 20:case"end":return c.stop()}}),_loop5)})),S.s();case 54:if((T=S.n()).done){D.next=58;break}return D.delegateYield(A(),"t2",56);case 56:D.next=54;break;case 58:D.next=63;break;case 60:D.prev=60,D.t3=D.catch(51),S.e(D.t3);case 63:return D.prev=63,S.f(),D.finish(63);case 66:return D.next=68,Actor.create(u);case 68:return O=D.sent,D.next=71,Actor.updateDocuments(l);case 71:P=initializer_createForOfIteratorHelper(O);try{for(P.s();!(E=P.n()).done;)C=E.value,a.actors[C.name]=C}catch(t){P.e(t)}finally{P.f()}case 73:case"end":return D.stop()}}),_callee11,null,[[13,44,47,50],[18,34,37,40],[51,60,63,66]])}))(),"t3",25);case 25:case"end":return _.stop()}}),_callee12)})));return function(r){return t.apply(this,arguments)}}());case 29:return this.lock=!1,t.find("i").remove(),ui.notifications.notify(game.i18n.localize("initComplete")),i.next=34,this.close();case 34:case"end":return i.stop()}}),_callee13,this,[[4,10],[12,17],[19,24]])}))),function initialize(){return c.apply(this,arguments)})},{key:"dontInitialize",value:(i=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee14(){return initializer_regeneratorRuntime().wrap((function _callee14$(t){for(;;)switch(t.prev=t.next){case 0:if(!game.settings.settings.has("".concat(this.module,".initialized"))){t.next=3;break}return t.next=3,game.settings.set(this.module,"initialized",!0);case 3:return ui.notifications.notify(game.i18n.localize("initSkipped")),t.next=6,this.close();case 6:case"end":return t.stop()}}),_callee14,this)}))),function dontInitialize(){return i.apply(this,arguments)})},{key:"submit",value:function submit(t){try{t.callback&&t.callback(this.options.jQuery?this.element:this.element[0])}catch(t){throw ui.notifications.error(t),new Error(t)}}},{key:"getFolderForType",value:(a=initializer_asyncToGenerator(initializer_regeneratorRuntime().mark((function _callee15(r){var a,o,i,c,u=arguments;return initializer_regeneratorRuntime().wrap((function _callee15$(l){for(;;)switch(l.prev=l.next){case 0:return a=u.length>1&&void 0!==u[1]?u[1]:null,o=u.length>2&&void 0!==u[2]?u[2]:null,i=u.length>3&&void 0!==u[3]?u[3]:0,c=u.length>4&&void 0!==u[4]?u[4]:"",o||(o=game.i18n.localize("".concat(this.module,".name"))),l.abrupt("return",t.Z.getFolderForType(r,a,o,i,c));case 6:case"end":return l.stop()}}),_callee15,this)}))),function getFolderForType(t){return a.apply(this,arguments)})}]),DSA5Initializer}();function ChatMessageDSA5_typeof(t){return ChatMessageDSA5_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ChatMessageDSA5_typeof(t)}function ChatMessageDSA5_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function ChatMessageDSA5_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function ChatMessageDSA5_createClass(t,r,a){return r&&ChatMessageDSA5_defineProperties(t.prototype,r),a&&ChatMessageDSA5_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function ChatMessageDSA5_get(){return ChatMessageDSA5_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=ChatMessageDSA5_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},ChatMessageDSA5_get.apply(this,arguments)}function ChatMessageDSA5_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=ChatMessageDSA5_getPrototypeOf(t)););return t}function ChatMessageDSA5_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&ChatMessageDSA5_setPrototypeOf(t,r)}function ChatMessageDSA5_setPrototypeOf(t,r){return ChatMessageDSA5_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},ChatMessageDSA5_setPrototypeOf(t,r)}function ChatMessageDSA5_createSuper(t){var r=function ChatMessageDSA5_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=ChatMessageDSA5_getPrototypeOf(t);if(r){var i=ChatMessageDSA5_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return ChatMessageDSA5_possibleConstructorReturn(this,a)}}function ChatMessageDSA5_possibleConstructorReturn(t,r){if(r&&("object"===ChatMessageDSA5_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function ChatMessageDSA5_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function ChatMessageDSA5_getPrototypeOf(t){return ChatMessageDSA5_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},ChatMessageDSA5_getPrototypeOf(t)}var it=function(t){ChatMessageDSA5_inherits(ChatMessageDSA5Roll,ChatMessage);var r=ChatMessageDSA5_createSuper(ChatMessageDSA5Roll);function ChatMessageDSA5Roll(){return ChatMessageDSA5_classCallCheck(this,ChatMessageDSA5Roll),r.apply(this,arguments)}return ChatMessageDSA5_createClass(ChatMessageDSA5Roll,[{key:"isRoll",get:function get(){return this.isDSARoll||ChatMessageDSA5_get(ChatMessageDSA5_getPrototypeOf(ChatMessageDSA5Roll.prototype),"isRoll",this)}},{key:"roll",get:function get(){return this.isDSARoll?new ct(""):ChatMessageDSA5_get(ChatMessageDSA5_getPrototypeOf(ChatMessageDSA5Roll.prototype),"roll",this)}},{key:"isDSARoll",get:function get(){return!!this.flags.data&&this.flags.data.isDSARoll}}]),ChatMessageDSA5Roll}(),ct=function(t){ChatMessageDSA5_inherits(EmptyRoll,Roll);var r=ChatMessageDSA5_createSuper(EmptyRoll);function EmptyRoll(){return ChatMessageDSA5_classCallCheck(this,EmptyRoll),r.apply(this,arguments)}return ChatMessageDSA5_createClass(EmptyRoll,[{key:"render",value:function render(){return""}}]),EmptyRoll}();function hotbar_typeof(t){return hotbar_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},hotbar_typeof(t)}function hotbar_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function hotbar_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return hotbar_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return hotbar_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function hotbar_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function hotbar_regeneratorRuntime(){hotbar_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==hotbar_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function hotbar_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function hotbar_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){hotbar_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){hotbar_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function hotbar_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function hotbar_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function hotbar_get(){return hotbar_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=hotbar_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},hotbar_get.apply(this,arguments)}function hotbar_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=hotbar_getPrototypeOf(t)););return t}function hotbar_setPrototypeOf(t,r){return hotbar_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},hotbar_setPrototypeOf(t,r)}function hotbar_createSuper(t){var r=function hotbar_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=hotbar_getPrototypeOf(t);if(r){var i=hotbar_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return hotbar_possibleConstructorReturn(this,a)}}function hotbar_possibleConstructorReturn(t,r){if(r&&("object"===hotbar_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function hotbar_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function hotbar_getPrototypeOf(t){return hotbar_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},hotbar_getPrototypeOf(t)}var st=function(t){!function hotbar_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&hotbar_setPrototypeOf(t,r)}(DSA5Hotbar,Hotbar);var r,a,o,i=hotbar_createSuper(DSA5Hotbar);function DSA5Hotbar(){return hotbar_classCallCheck(this,DSA5Hotbar),i.apply(this,arguments)}return function hotbar_createClass(t,r,a){return r&&hotbar_defineProperties(t.prototype,r),a&&hotbar_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSA5Hotbar,[{key:"_render",value:(o=hotbar_asyncToGenerator(hotbar_regeneratorRuntime().mark((function _callee(){var t,r,a=arguments;return hotbar_regeneratorRuntime().wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},o.next=4,hotbar_get(hotbar_getPrototypeOf(DSA5Hotbar.prototype),"_render",this).call(this,t,r);case 4:this.addContextColor();case 5:case"end":return o.stop()}}),_callee,this)}))),function _render(){return o.apply(this,arguments)})},{key:"collapse",value:(a=hotbar_asyncToGenerator(hotbar_regeneratorRuntime().mark((function _callee2(){return hotbar_regeneratorRuntime().wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:if(!this._collapsed){t.next=2;break}return t.abrupt("return",!0);case 2:return $(this.element).addClass("collapsedHotbar"),t.abrupt("return",hotbar_get(hotbar_getPrototypeOf(DSA5Hotbar.prototype),"collapse",this).call(this));case 4:case"end":return t.stop()}}),_callee2,this)}))),function collapse(){return a.apply(this,arguments)})},{key:"expand",value:(r=hotbar_asyncToGenerator(hotbar_regeneratorRuntime().mark((function _callee3(){return hotbar_regeneratorRuntime().wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:if(this._collapsed){t.next=2;break}return t.abrupt("return",!0);case 2:return $(this.element).removeClass("collapsedHotbar"),t.abrupt("return",hotbar_get(hotbar_getPrototypeOf(DSA5Hotbar.prototype),"expand",this).call(this));case 4:case"end":return t.stop()}}),_callee3,this)}))),function expand(){return r.apply(this,arguments)})},{key:"addContextColor",value:function addContextColor(){var t,r=new RegExp(" ".concat(game.i18n.localize("CHAR.PARRY"),"$")),a=new RegExp(" ".concat(game.i18n.localize("CHAR.ATTACK"),"$")),o=$(this._element).find("#macro-list"),i=hotbar_createForOfIteratorHelper(this.macros);try{for(i.s();!(t=i.n()).done;){var c=t.value;c.macro&&(r.test(c.macro.name)?o.find('[data-macro-id="'.concat(c.macro.id,'"]')).addClass("parry"):a.test(c.macro.name)&&o.find('[data-macro-id="'.concat(c.macro.id,'"]')).addClass("attack"))}}catch(t){i.e(t)}finally{i.f()}}}]),DSA5Hotbar}();function roll_memory_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var ut=function(){function RollMemory(){!function roll_memory_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,RollMemory),this.tokens={},this.actors={}}return function roll_memory_createClass(t,r,a){return r&&roll_memory_defineProperties(t.prototype,r),a&&roll_memory_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(RollMemory,[{key:"getPath",value:function getPath(t,r,a){var o=a||"",i=r._id||r.type;return t.token?"tokens.".concat(t.token||t.actor,".").concat(i).concat(o):"actors.".concat(t.actor,".").concat(i).concat(o)}},{key:"remember",value:function remember(t,r,a,o){var i=this.formDataSerialize(o);Object.entries(i).length>0&&setProperty(this,this.getPath(t,r,a),i)}},{key:"recall",value:function recall(t,r,a){return getProperty(this,this.getPath(t,r,a))}},{key:"formDataSerialize",value:function formDataSerialize(t){var r=t.find("form"),a={};return r.find("select").each((function(){var t=$(this).attr("name");RollMemory.wantedKeys.includes(t)&&(a[t]=$(this).val())})),r.find('input[type="checkbox"]').each((function(){var t=$(this).attr("name");RollMemory.wantedKeys.includes(t)&&(a[t]=this.checked)})),r.find(".specAbs.active").each((function(){a.specAbs||(a.specAbs=[]),a.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})})),t.find('[name="situationalModifiers"] option').each((function(){a.situationalModifiers||(a.situationalModifiers=[]),a.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})})),a}}],[{key:"wantedKeys",get:function get(){var t=["vision","targetMovement","shooterMovement","quickChange","mountOptions","narrowSpace","advantageousPosition","doubleAttack","reduceCostSpell","forceSpell","increaseCastingTime","decreaseCastingTime","removeGesture","removeFormula"];return game.settings.get("dsa5","enableDPS")||t.push("distance"),t}}]),RollMemory}(),lt=__webpack_require__(430);function dsa_active_effects_typeof(t){return dsa_active_effects_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dsa_active_effects_typeof(t)}function dsa_active_effects_regeneratorRuntime(){dsa_active_effects_regeneratorRuntime=function _regeneratorRuntime(){return t};var t={},r=Object.prototype,a=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",u=o.toStringTag||"@@toStringTag";function define(t,r,a){return Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[r]}try{define({},"")}catch(t){define=function define(t,r,a){return t[r]=a}}function wrap(t,r,a,o){var i=r&&r.prototype instanceof Generator?r:Generator,c=Object.create(i.prototype),u=new Context(o||[]);return c._invoke=function(t,r,a){var o="suspendedStart";return function(i,c){if("executing"===o)throw new Error("Generator is already running");if("completed"===o){if("throw"===i)throw c;return doneResult()}for(a.method=i,a.arg=c;;){var u=a.delegate;if(u){var p=maybeInvokeDelegate(u,a);if(p){if(p===l)continue;return p}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if("suspendedStart"===o)throw o="completed",a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);o="executing";var d=tryCatch(t,r,a);if("normal"===d.type){if(o=a.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:a.done}}"throw"===d.type&&(o="completed",a.method="throw",a.arg=d.arg)}}}(t,a,u),c}function tryCatch(t,r,a){try{return{type:"normal",arg:t.call(r,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,i,(function(){return this}));var d=Object.getPrototypeOf,h=d&&d(d(values([])));h&&h!==r&&a.call(h,i)&&(p=h);var m=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(t){["next","throw","return"].forEach((function(r){define(t,r,(function(t){return this._invoke(r,t)}))}))}function AsyncIterator(t,r){function invoke(o,i,c,u){var l=tryCatch(t[o],t,i);if("throw"!==l.type){var p=l.arg,d=p.value;return d&&"object"==dsa_active_effects_typeof(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(t){invoke("next",t,c,u)}),(function(t){invoke("throw",t,c,u)})):r.resolve(d).then((function(t){p.value=t,c(p)}),(function(t){return invoke("throw",t,c,u)}))}u(l.arg)}var o;this._invoke=function(t,a){function callInvokeWithMethodAndArg(){return new r((function(r,o){invoke(t,a,r,o)}))}return o=o?o.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(t,r){var a=t.iterator[r.method];if(void 0===a){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=void 0,maybeInvokeDelegate(t,r),"throw"===r.method))return l;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var o=tryCatch(a,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function pushTryEntry(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function resetTryEntry(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function Context(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function next(){for(;++o<t.length;)if(a.call(t,o))return next.value=t[o],next.done=!1,next;return next.value=void 0,next.done=!0,next};return c.next=c}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(m,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===GeneratorFunction||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,GeneratorFunctionPrototype):(t.__proto__=GeneratorFunctionPrototype,define(t,u,"GeneratorFunction")),t.prototype=Object.create(m),t},t.awrap=function(t){return{__await:t}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,c,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(r,a,o,i,c){void 0===c&&(c=Promise);var u=new AsyncIterator(wrap(r,a,o,i),c);return t.isGeneratorFunction(a)?u:u.next().then((function(t){return t.done?t.value:u.next()}))},defineIteratorMethods(m),define(m,u,"Generator"),define(m,i,(function(){return this})),define(m,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var r=[];for(var a in t)r.push(a);return r.reverse(),function next(){for(;r.length;){var a=r.pop();if(a in t)return next.value=a,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function reset(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(resetTryEntry),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function dispatchException(t){if(this.done)throw t;var r=this;function handle(a,o){return c.type="throw",c.arg=t,r.next=a,o&&(r.method="next",r.arg=void 0),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),l=a.call(i,"finallyLoc");if(u&&l){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function abrupt(t,r){for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o];if(i.tryLoc<=this.prev&&a.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var c=i;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=r&&r<=c.finallyLoc&&(c=null);var u=c?c.completion:{};return u.type=t,u.arg=r,c?(this.method="next",this.next=c.finallyLoc,l):this.complete(u)},complete:function complete(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),l},finish:function finish(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),resetTryEntry(a),l}},catch:function _catch(t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc===t){var o=a.completion;if("throw"===o.type){var i=o.arg;resetTryEntry(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(t,r,a){return this.delegate={iterator:values(t),resultName:r,nextLoc:a},"next"===this.method&&(this.arg=void 0),l}},t}function dsa_active_effects_asyncGeneratorStep(t,r,a,o,i,c,u){try{var l=t[c](u),p=l.value}catch(t){return void a(t)}l.done?r(p):Promise.resolve(p).then(o,i)}function dsa_active_effects_asyncToGenerator(t){return function(){var r=this,a=arguments;return new Promise((function(o,i){var c=t.apply(r,a);function _next(t){dsa_active_effects_asyncGeneratorStep(c,o,i,_next,_throw,"next",t)}function _throw(t){dsa_active_effects_asyncGeneratorStep(c,o,i,_next,_throw,"throw",t)}_next(void 0)}))}}function dsa_active_effects_ownKeys(t,r){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.push.apply(a,o)}return a}function dsa_active_effects_objectSpread(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?dsa_active_effects_ownKeys(Object(a),!0).forEach((function(r){dsa_active_effects_defineProperty(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):dsa_active_effects_ownKeys(Object(a)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(a,r))}))}return t}function dsa_active_effects_createForOfIteratorHelper(t,r){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=function dsa_active_effects_unsupportedIterableToArray(t,r){if(!t)return;if("string"==typeof t)return dsa_active_effects_arrayLikeToArray(t,r);var a=Object.prototype.toString.call(t).slice(8,-1);"Object"===a&&t.constructor&&(a=t.constructor.name);if("Map"===a||"Set"===a)return Array.from(t);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return dsa_active_effects_arrayLikeToArray(t,r)}(t))||r&&t&&"number"==typeof t.length){a&&(t=a);var o=0,i=function F(){};return{s:i,n:function n(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,u=!0,l=!1;return{s:function s(){a=a.call(t)},n:function n(){var t=a.next();return u=t.done,t},e:function e(t){l=!0,c=t},f:function f(){try{u||null==a.return||a.return()}finally{if(l)throw c}}}}function dsa_active_effects_arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var a=0,o=new Array(r);a<r;a++)o[a]=t[a];return o}function dsa_active_effects_classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function dsa_active_effects_defineProperties(t,r){for(var a=0;a<r.length;a++){var o=r[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function dsa_active_effects_get(){return dsa_active_effects_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(t,r,a){var o=dsa_active_effects_superPropBase(t,r);if(o){var i=Object.getOwnPropertyDescriptor(o,r);return i.get?i.get.call(arguments.length<3?t:a):i.value}},dsa_active_effects_get.apply(this,arguments)}function dsa_active_effects_superPropBase(t,r){for(;!Object.prototype.hasOwnProperty.call(t,r)&&null!==(t=dsa_active_effects_getPrototypeOf(t)););return t}function dsa_active_effects_setPrototypeOf(t,r){return dsa_active_effects_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(t,r){return t.__proto__=r,t},dsa_active_effects_setPrototypeOf(t,r)}function dsa_active_effects_createSuper(t){var r=function dsa_active_effects_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function _createSuperInternal(){var a,o=dsa_active_effects_getPrototypeOf(t);if(r){var i=dsa_active_effects_getPrototypeOf(this).constructor;a=Reflect.construct(o,arguments,i)}else a=o.apply(this,arguments);return dsa_active_effects_possibleConstructorReturn(this,a)}}function dsa_active_effects_possibleConstructorReturn(t,r){if(r&&("object"===dsa_active_effects_typeof(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function dsa_active_effects_assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function dsa_active_effects_getPrototypeOf(t){return dsa_active_effects_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(t){return t.__proto__||Object.getPrototypeOf(t)},dsa_active_effects_getPrototypeOf(t)}function dsa_active_effects_defineProperty(t,r,a){return r in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var ft=function(t){!function dsa_active_effects_inherits(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),r&&dsa_active_effects_setPrototypeOf(t,r)}(DSAActiveEffect,ActiveEffect);var r,a,o=dsa_active_effects_createSuper(DSAActiveEffect);function DSAActiveEffect(){return dsa_active_effects_classCallCheck(this,DSAActiveEffect),o.apply(this,arguments)}return function dsa_active_effects_createClass(t,r,a){return r&&dsa_active_effects_defineProperties(t.prototype,r),a&&dsa_active_effects_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}(DSAActiveEffect,[{key:"apply",value:function apply(t,r){if(!DSAActiveEffect.itemChangeRegex.test(r.key))return dsa_active_effects_get(dsa_active_effects_getPrototypeOf(DSAActiveEffect.prototype),"apply",this).call(this,t,r);var a,o=this._getModifiedItems(t,r),i=dsa_active_effects_createForOfIteratorHelper(o.items);try{for(i.s();!(a=i.n()).done;){var c=a.value,u=foundry.utils.flattenObject(c.overrides||{});u[o.key]=Number.isNumeric(c.value)?Number(o.value):o.value;var l=dsa_active_effects_objectSpread(dsa_active_effects_objectSpread({},r),{},{key:o.key,value:o.value});dsa_active_effects_get(dsa_active_effects_getPrototypeOf(DSAActiveEffect.prototype),"apply",this).call(this,c,l),c.overrides=foundry.utils.expandObject(u)}}catch(t){i.e(t)}finally{i.f()}}},{key:"_getModifiedItems",value:function _getModifiedItems(t,r){var a,o=r.key.split("."),i=o.shift();i=i.replace("@","").toLowerCase();var c=o.shift(),u=o.join("."),l=r.value;return{items:(null==t||null===(a=t.items)||void 0===a?void 0:a.filter((function(t){return t.type==i&&(t.name==c||t.id==c)})))||[],key:u,value:l}}},{key:"_preUpdate",value:(a=dsa_active_effects_asyncToGenerator(dsa_active_effects_regeneratorRuntime().mark((function _callee(t,r,a){return dsa_active_effects_regeneratorRuntime().wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:dsa_active_effects_get(dsa_active_effects_getPrototypeOf(DSAActiveEffect.prototype),"_preUpdate",this).call(this,t,r,a),this._clearModifiedItems();case 2:case"end":return o.stop()}}),_callee,this)}))),function _preUpdate(t,r,o){return a.apply(this,arguments)})},{key:"_clearModifiedItems",value:function _clearModifiedItems(){if(!(!this.parent instanceof CONFIG.Actor.documentClass)){var t,r=dsa_active_effects_createForOfIteratorHelper(this.changes);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(DSAActiveEffect.itemChangeRegex.test(a.key)){var o,i=this._getModifiedItems(this.parent,a),c=dsa_active_effects_createForOfIteratorHelper(i.items);try{for(c.s();!(o=c.n()).done;){var u,l=o.value,p=foundry.utils.flattenObject(l.overrides||{}),d=i.key;delete p[d];var h=getProperty(l._source,d);setProperty(l,d,h),l.overrides=foundry.utils.expandObject(p),null!==(u=l.sheet)&&void 0!==u&&u.rendered&&l.sheet.render(!0)}}catch(t){c.e(t)}finally{c.f()}}}}catch(t){r.e(t)}finally{r.f()}}}},{key:"_preDelete",value:(r=dsa_active_effects_asyncToGenerator(dsa_active_effects_regeneratorRuntime().mark((function _callee2(t,r){return dsa_active_effects_regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:dsa_active_effects_get(dsa_active_effects_getPrototypeOf(DSAActiveEffect.prototype),"_preDelete",this).call(this,t,r),this._clearModifiedItems();case 2:case"end":return a.stop()}}),_callee2,this)}))),function _preDelete(t,a){return r.apply(this,arguments)})}]),DSAActiveEffect}();dsa_active_effects_defineProperty(ft,"itemChangeRegex",/^@/);Hooks.on("applyActiveEffect",(function(t,r){return function applyCustomEffect(t,r){var a=getProperty(t,r.key)||null;null==a&&/^system\.(vulnerabilities|resistances)/.test(r.key)&&(a=[],setProperty(t,r.key,a));var o=null;if("Array"===getType(a)){var i,c=[],u=r.effect.label,l=dsa_active_effects_createForOfIteratorHelper("".concat(r.value).split(/[;,]+/));try{for(l.s();!(i=l.n()).done;){var p=i.value.split(" "),d=p.pop(),h=p.join(" ");c.push({source:u,value:d,target:h})}}catch(t){l.e(t)}finally{l.f()}o=a.concat(c)}return null!==o&&setProperty(t,r.key,o),o}(t,r)}));var pt=__webpack_require__(174);Hooks.once("init",(function(){console.log("Initializing DSA5 system"),CONFIG.statusEffects=r.Z.statusEffects,game.dsa5={apps:{DSA5_Utility:t.Z,DSA5Initializer:ot,DSA5ChatListeners:c.Z,DSA5Payment:fe,SpecialabilityRulesDSA5:i.Z,AdvantageRulesDSA5:a.Z,Migrakel:l,DSA5Dialog:ge.Z,DSA5StatusEffects:u.Z,DPS:Ae.Z,DSATables:lt.Z,RequestRoll:we.Z,DiceDSA5:I.Z,DSATour:Ke.Z,OpposeDSA:le.Z,EquipmentDamage:D.Z,DidYouKnow:We,MeasuredTemplateDSA:pt.c},entities:{Actordsa5:d.Z,Itemdsa5:o.Z},sheets:{ActorSheetdsa5:b,ActorSheetdsa5Character:O,ActorSheetdsa5Creature:E,ActorSheetdsa5NPC:C,MerchantSheetMixin:he,MerchantSheetDSA5:ye,ItemSheetdsa5:L},macro:Xe,config:r.Z,memory:new ut,itemLibrary:new at},CONFIG.Actor.documentClass=d.Z,CONFIG.Item.documentClass=o.Z,CONFIG.ChatMessage.template="systems/dsa5/templates/chat/chat-message.html",CONFIG.ChatMessage.documentClass=it,CONFIG.ui.combat=De,CONFIG.ui.hotbar=st,CONFIG.Combat.documentClass=Ie,CONFIG.Combatant.documentClass=Re,CONFIG.ActiveEffect.documentClass=ft})),function init(){!function handlebars(){Handlebars.registerHelper({concat:function concat(){var t;return(t=HandlebarsHelpers).concat.apply(t,arguments).string},concatUp:function concatUp(t,r){return t+r.toUpperCase()},mod:function mod(t,r){return t%r},roman:function roman(t,r){return null!=r&&Number(r)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][t-1]},isWEBM:function isWEBM(t){return/.webm$/.test(t)},joinStr:function joinStr(t,r){return r.join(t)},diceThingsUp:function diceThingsUp(r,a){return t.Z.replaceDies(r,!1)},replaceConditions:t.Z.replaceConditions,floor:function floor(t){return Math.floor(Number(t))},hasElem:function hasElem(t,r){return t.includes(r)},situationalTooltip:function situationalTooltip(t){var r=game.i18n.localize(oe[t.type]||"Modifier"),a="".concat(t.name,"<br/>").concat(r,": ").concat(t.value);return t.source&&(a+="<br/>".concat(game.i18n.localize("source"),": ").concat(t.source)),a},grouped_each:function grouped_each(t,r,a){var o,i="",c=[];if(r&&r.length>0){for(o=0;o<r.length;o++)o>0&&o%t==0&&(i+=a.fn(c),c=[]),c.push(r[o]);i+=a.fn(c)}return i},plantify:function plantify(t){return game.i18n.localize("PLANT.avLevels.".concat(t||0))}})}(),function dicesonice(){Hooks.once("init",(function(){game.dsa5.apps.DiceSoNiceCustomization=new ie})),Hooks.once("diceSoNiceReady",(function(t,r,a,o){t.addColorset({name:"mu",description:"DSA5.mu",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"kl",description:"DSA5.kl",category:"DSA5.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"in",description:"DSA5.in",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"ch",description:"DSA5.ch",category:"DSA5.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"ff",description:"DSA5.ff",category:"DSA5.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"ge",description:"DSA5.ge",category:"DSA5.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"ko",description:"DSA5.ko",category:"DSA5.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"kk",description:"DSA5.kk",category:"DSA5.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"attack",description:"DSA5.attack",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),t.addColorset({name:"dodge",description:"DSA5.dodge",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),t.addColorset({name:"parry",description:"DSA5.parry",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),game.dsa5.apps.DiceSoNiceCustomization.initConfigs(),ie.onConnect()}))}(),function actor(){Hooks.on("preDeleteActiveEffect",(function(t,r,a){var o,i=t.parent;if(i&&"Actor"==i.documentName&&getProperty(t,"flags.dsa5.maintain"))return new Dialog({title:t.label,content:game.i18n.format("DIALOG.updateMaintainSpell",{actor:i.name}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("HELP.pay"),callback:(o=actor_asyncToGenerator(actor_regeneratorRuntime().mark((function _callee(r){var a;return actor_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,i.applyMana(Number(getProperty(t,"flags.dsa5.maintain")),getProperty(t,"flags.dsa5.payType"));case 2:r.sent&&(a={startTime:game.time.worldTime},game.combat&&(a.startRound=game.combat.round,a.startTurn=game.combat.turn),i.updateEmbeddedDocuments("ActiveEffect",[{_id:t._id,duration:a}]));case 4:case"end":return r.stop()}}),_callee)}))),function callback(t){return o.apply(this,arguments)})},delete:{icon:'<i class="fas fa-trash"></i>',label:game.i18n.localize("delete"),callback:function callback(r){i.deleteEmbeddedDocuments("ActiveEffect",[t._id],{noHook:!0})}}}}).render(!0),!1})),Hooks.on("deleteActiveEffect",(function(t){var r=t.parent;if(r&&"Actor"==r.documentName){var a=getProperty(t,"flags.core.statusId");if("bloodrush"==a)return r.addCondition("stunned",2,!1,!1),!1;if("dead"==a&&game.combat)return r.markDead(!1),!1;if(se.Z.onEffectRemove(r,t),!1===Hooks.call("deleteActorActiveEffect",r,t))return!1}}));var r=function(){var t=actor_asyncToGenerator(actor_regeneratorRuntime().mark((function _callee2(t,r){return actor_regeneratorRuntime().wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:(game.dsa5.apps.AskForNameDialog||ue).getDialog(t,r);case 2:case"end":return a.stop()}}),_callee2)})));return function askForName(r,a){return t.apply(this,arguments)}}(),a=function(){var a=actor_asyncToGenerator(actor_regeneratorRuntime().mark((function _callee3(a,o){var i,c,u,l;return actor_regeneratorRuntime().wrap((function _callee3$(p){for(;;)switch(p.prev=p.next){case 0:if(t.Z.isActiveGM()){p.next=2;break}return p.abrupt("return");case 2:if(i=a.actor,0!=(c=Number(game.settings.get("dsa5","obfuscateTokenNames")))&&"loot"!=getProperty(i,"merchant.merchantType")){p.next=6;break}return p.abrupt("return");case 6:if(u=canvas.scene.tokens.filter((function(t){return t.actor&&t.actor.id===i.id})),l=game.i18n.localize("unknown"),![2,4].includes(c)){p.next=14;break}if(a.id||a._id){p.next=12;break}return p.abrupt("return");case 12:return r(a,c),p.abrupt("return");case 14:u.length>0&&c<3&&(l="".concat(u[0].name.replace(/ \d{1,}$/)," ").concat(u.length+1)),o.name=l;case 16:case"end":return p.stop()}}),_callee3)})));return function obfuscateName(t,r){return a.apply(this,arguments)}}();Hooks.on("preCreateToken",(function(r,o,i,c){var u=r.actor;if(u){var l={};"loot"==getProperty(u,"system.merchant.merchantType")?mergeObject(l,{displayBars:0}):getProperty(u,"system.config.autoBar")&&(mergeObject(l,{bar1:{attribute:"status.wounds"}}),u.system.isMage?mergeObject(l,{bar2:{attribute:"status.astralenergy"}}):u.system.isPriest?mergeObject(l,{bar2:{attribute:"status.karmaenergy"}}):mergeObject(l,{bar2:{attribute:"tbd"}})),getProperty(u,"system.config.autoSize")&&t.Z.calcTokenSize(u,l),a(r,l),r.updateSource(l)}})),Hooks.on("createToken",(function(t,r,o){a(t,{})}))}(),function macro_support(){Hooks.on("hotbarDrop",(function(t,r,a){if("dodge"==r.mod){var o={name:game.i18n.localize(r.mod),img:"systems/dsa5/icons/categories/Dodge.webp"};return createHotBarMacro(game.user.isGM||null==r.actorId?'game.dsa5.macro.charMacro("'.concat(r.mod,'")'):'game.dsa5.macro.charMacroById("'.concat(r.mod,'", "').concat(r.actorId,'")'),o.name,o.img,a)}if("attackWeaponless"==r.mod||"parryWeaponless"==r.mod){var i={name:game.i18n.localize(r.mod),img:"systems/dsa5/icons/categories/attack_weaponless.webp"};return createHotBarMacro(game.user.isGM||null==r.actorId?'game.dsa5.macro.weaponLessMacro("'.concat(r.mod,'")'):'game.dsa5.macro.weaponLessMacroId("'.concat(r.mod,'", "').concat(r.actorId,'")'),i.name,i.img,a)}if("Item"==r.type){var c=fromUuidSync(r.uuid);if(!["ritual","ceremony","meleeweapon","rangeweapon","skill","combatskill","spell","liturgy","char","trait"].includes(c.type))return;if(!("meleeweapon"!=c.type&&"combatskill"!=c.type||["attack","parry"].includes(r.mod)))return;if(("rangeweapon"==c.type||"trait"==c.type)&&!["attack"].includes(r.mod))return;var u='{mod: "'.concat(r.mod,'"}');return createHotBarMacro(game.user.isGM||null==r.actorId?'game.dsa5.macro.itemMacro("'.concat(c.name,'", "').concat(c.type,'", ').concat(u,");"):'game.dsa5.macro.itemMacroById("'.concat(r.actorId,'", "').concat(c.name,'", "').concat(c.type,'", ').concat(u,")"),null==r.mod?c.name:"".concat(c.name," - ").concat(game.i18n.localize("CHAR."+r.mod.toUpperCase())),c.img,a)}if("Actor"==r.type||"JournalEntry"==r.type){var l=fromUuidSync(r.uuid);return createHotBarMacro("(await fromUuid('".concat(r.uuid,"')).sheet.render(true)"),l.name,l.img,a)}}))}(),function chatlog(){Hooks.on("renderChatLog",(function(t,r,a){le.Z.chatListeners(r),I.Z.chatListeners(r),fe.chatListeners(r);var o=new _.Z;Hooks.call("startDSA5ChatAutoCompletion",o),o.chatListeners(r),c.Z.chatListeners(r)})),Hooks.on("renderChatMessage",(function(r,a,o){if(game.user.isGM)a.find(".chat-button-player").remove();else{var i;a.find(".chat-button-gm").remove();var c=a.find(".chat-button-target");c.length&&(i=pe.ZP.getTargetActor(o.message))&&i.actor&&!i.actor.isOwner&&c.remove();var l=t.Z.getSpeaker(o.message.speaker);l&&!l.isOwner&&(a.find(".selfButton").remove(),a.find(".d20").data("tooltip",""));var p=a.find(".onlyTarget");p.length&&(i=t.Z.getSpeaker({token:p.attr("data-token"),actor:p.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}))&&!i.isOwner&&p.remove(),a.find(".hideData").remove(),getProperty(o.message,"flags.dsa5.userHidden.".concat(game.user.id))&&a.find(".payButton").remove()}game.settings.get("dsa5","expandChatModifierlist")&&(a.find(".expand-mods i").toggleClass("fa-minus fa-plus"),a.find(".expand-mods + ul").css({display:"block"})),u.Z.bindButtons(a)})),Hooks.on("chatMessage",(function(r,a,o){var i=a.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(i=i?i[0]:""){case"/pay":return game.user.isGM?fe.createPayChatMessage(a):fe.payMoney(t.Z.getSpeaker(o.speaker),a),!1;case"/getPaid":return game.user.isGM?fe.createGetPaidChatMessage(a):fe.getMoney(t.Z.getSpeaker(o.speaker),a),!1;case"/help":return c.Z.getHelp(),!1;case"/conditions":return c.Z.showConditions(),!1;case"/tables":return c.Z.showTables(),!1}}))}(),function ready(){Hooks.on("ready",ready_asyncToGenerator(ready_regeneratorRuntime().mark((function _callee(){return ready_regeneratorRuntime().wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:if(game.socket.on("system.dsa5",(function(t){if("hideDeletedSheet"===t.type){var r=t.payload.target.token?game.actors.tokens[t.payload.target.token]:game.actors.get(t.payload.target.actor);ye.hideDeletedSheet(r)}})),game.user.isGM&&game.socket.on("system.dsa5",(function(t){switch(t.type){case"target":var r=game.scenes.get(t.payload.scene);new Token(r.getEmbeddedDocument("Token",t.payload.target)).actor.update({"flags.oppose":t.payload.opposeFlag});break;case"addEffect":se.Z.applyEffect(t.payload.id,t.payload.mode,t.payload.actors);break;case"updateMsg":game.messages.get(t.payload.id).update(t.payload.updateData);break;case"deleteMsg":game.messages.get(t.payload.id).delete();break;case"showDamage":le.Z.showDamage(game.messages.get(t.payload.id),t.payload.hide);break;case"hideQueryButton":le.Z.hideReactionButton(t.payload.id);break;case"updateGroupCheck":we.Z.rerenderGC(game.messages.get(t.payload.messageId),t.payload.data);break;case"updateAttackMessage":game.messages.get(t.payload.messageId).update({"flags.data.unopposedStartMessage":t.payload.startMessageId});break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"clearOpposed":le.Z.clearOpposed(game.actors.get(t.payload.actorId));break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(t.payload.speaker);break;case"trade":var a=t.payload.source.token?game.actors.tokens[t.payload.source.token]:game.actors.get(t.payload.source.actor),o=t.payload.target.token?game.actors.tokens[t.payload.target.token]:game.actors.get(t.payload.target.actor);ye.finishTransaction(a,o,t.payload.price,t.payload.itemId,t.payload.buy,t.payload.amount);break;case"playWhisperSound":t.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:t.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(t.payload.id).then((function(r){new g.Z(r).socketedConditionAddActor(t.payload.actors.map((function(t){return game.actors.get(t)})),t.payload.data)}));break;case"socketedConditionAdd":fromUuid(t.payload.id).then((function(r){new g.Z(r).socketedConditionAdd(t.payload.targets,t.payload.data)}));break;case"socketedRemoveCondition":fromUuid(t.payload.id).then((function(r){new g.Z(r).socketedRemoveCondition(t.payload.targets,t.payload.coreId)}));break;case"socketedActorTransformation":fromUuid(t.payload.id).then((function(r){new g.Z(r).socketedActorTransformation(t.payload.targets,t.payload.update)}));break;case"itemDrop":var i=t.payload.sourceActorId?game.actors.get(t.payload.sourceActorId):void 0;fromUuid(t.payload.itemId).then((function(r){ke(i,r,t.payload.data,t.payload.amount)}));break;case"hideDeletedSheet":case"finalizeidentification":case"updateHits":case"hideResistButton":break;case"summonCreature":_e.createConjuration(t.payload);break;default:console.warn("Unhandled socket data type ".concat(t.type))}})),r.t1=t.Z.moduleEnabled("vtta-tokenizer"),!r.t1){r.next=7;break}return r.next=6,game.settings.get("dsa5","tokenizerSetup");case 6:r.t1=!r.sent;case 7:if(r.t0=r.t1,!r.t0){r.next=10;break}r.t0=game.user.isGM;case 10:if(!r.t0){r.next=19;break}return r.next=13,game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsa5/icons/backgrounds/token_green.webp");case 13:return r.next=15,game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsa5/icons/backgrounds/token_black.webp");case 15:return r.next=17,game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsa5/icons/backgrounds/token_blue.webp");case 17:return r.next=19,game.settings.set("dsa5","tokenizerSetup",!0);case 19:if(r.t3=t.Z.moduleEnabled("dice-so-nice"),!r.t3){r.next=24;break}return r.next=23,game.settings.get("dsa5","diceSetup");case 23:r.t3=!r.sent;case 24:if(r.t2=r.t3,!r.t2){r.next=27;break}r.t2=game.user.isGM;case 27:if(!r.t2){r.next=32;break}return r.next=30,game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0);case 30:return r.next=32,game.settings.set("dsa5","diceSetup",!0);case 32:return r.next=34,de.firstTimeMessage();case 34:o.Z.setupSubClasses();case 35:case"end":return r.stop()}}),_callee)}))))}(),function chat_context(){var r=function fateAvailable(r,a){return t.Z.fateAvailable(r,a)},a=function canHurt(t){var r=game.messages.get(t.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&t.find(".opposed-card").length||t.find(".dice-roll").length)&&(getProperty(r,"damage.value")||0)>0},o=function canHurtSP(t){var r=game.messages.get(t.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&t.find(".opposed-card").length||t.find(".dice-roll").length)&&(getProperty(r,"damage.sp")||0)>0},i=function canCostMana(t){var r=game.messages.get(t.attr("data-message-id"));return!(!r.speaker.actor||!r.flags.data||!game.actors.get(r.speaker.actor).isOwner&&!game.user.isGM)&&(["liturgy","ceremony","spell","ritual","magicalsign"].includes(r.flags.data.preData.source.type)||getProperty(r.flags.data.preData,"calculatedSpellModifiers.costsMana"))},c=function canUnhideData(t){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){var r=game.messages.get(t.attr("data-message-id"));return"hideData"in r.flags&&r.flags.hideData}return!1},u=function canHideData(t){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){var r=game.messages.get(t.attr("data-message-id"));return"hideData"in r.flags&&!r.flags.hideData}return!1},l=function canImproveRoll(t){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=game.messages.get(t.attr("data-message-id"));if(o.speaker.actor&&o.flags.data&&o.flags.data.postData.successLevel>-2){var i=game.actors.get(o.speaker.actor);if(i.isOwner&&r(i,a)){var c=o.flags.data.preData.source.type,u=o.flags.data.preData.mode||"";["skill","spell","liturgy","ritual","ceremony"].includes(c)&&(c="char");var l=game.i18n.localize("SCHIPSKILLS.".concat(c).concat(u));return!o.flags.data.fateImproved&&i.items.getName(l)}}return!1},p=function canImproveRollGroup(t){return l(t,!0)},h=function canIncreaseQS(t){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=game.messages.get(t.attr("data-message-id"));if(o.speaker.actor&&o.flags.data){var i=game.actors.get(o.speaker.actor);if(i.isOwner&&r(i,a)&&!o.flags.data.fatePointAddQSUsed)return o.flags.data.postData.successLevel>0&&null!=o.flags.data.postData.qualityStep}return!1},m=function canIncreaseQSGroup(t){return h(t,!0)},y=function isTalented(t){var r=game.messages.get(t.attr("data-message-id"));if(r.speaker.actor&&r.flags.data){var a=game.actors.get(r.speaker.actor);if(a.isOwner)return null!=a.items.find((function(t){return t.name=="".concat(game.i18n.localize("LocalizedIDs.aptitude")," (").concat(r.flags.data.preData.source.name,")")}))&&!r.flags.data.talentedRerollUsed}return!1},g=function canRerollDamage(t){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=game.messages.get(t.attr("data-message-id"));if(o.speaker.actor&&o.flags.data){var i=game.actors.get(o.speaker.actor);if(i.isOwner&&r(i,a))return null!=o.flags.data.postData.damageRoll&&!o.flags.data.fatePointDamageRerollUsed}return!1},v=function canRerollDamageGroup(t){return g(t,!0)},_=function canReroll(t){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=game.messages.get(t.attr("data-message-id"));if(o.speaker.actor&&o.flags.data){var i=game.actors.get(o.speaker.actor);if(i.isOwner&&r(i,a))return!(o.flags.data.fatePointRerollUsed||"regenerate"==o.flags.data.postData.rollType)}return!1},b=function canRerollGroup(t){return _(t,!0)},w=function canHeal(t){var r=game.messages.get(t.attr("data-message-id"));return!!(r.speaker.actor&&r.flags.data&&game.actors.get(r.speaker.actor).isOwner&&["LeP","KaP","AsP"].some((function(t){return null!=getProperty(r.flags,"data.postData.".concat(t))})))&&!r.flags.data.healApplied},k=function showHideData(t){if(game.user.isGM){var r=game.messages.get(t.attr("data-message-id"));if("hideData"in r.flags){var a=!r.flags.hideData,o=$(r.content);o.find(".hideAnchor")[a?"addClass":"removeClass"]("hideData"),o=$("<div></div>").append(o),r.update({content:o.html(),"flags.hideData":a})}}},x=function canApplyDefaultRolls(t){var r=game.messages.get(t.data("messageId"));return!(!r||!canvas.tokens)&&r.isRoll&&r.isContentVisible&&canvas.tokens.controlled.length&&t.find(".dice-roll").length},S=function useFate(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=game.messages.get(t.attr("data-message-id"));game.actors.get(o.speaker.actor).useFateOnRoll(o,r,a)},T=function(){var r=chat_context_asyncToGenerator(chat_context_regeneratorRuntime().mark((function _callee(r,a){var o,i,c,u;return chat_context_regeneratorRuntime().wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:if(o=game.messages.get(r.attr("data-message-id")),i=o.flags.opposeData,c=i.speakerDefend,(u=t.Z.getSpeaker(c)).isOwner){l.next=6;break}return l.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.DamagePermission")));case 6:return l.next=8,u.applyDamage(i.damage[a]);case 8:return l.next=10,o.update({"flags.data.damageApplied":!0,content:o.content.replace(/hideAnchor">/,'hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="'.concat(game.i18n.localize("damageApplied"),'"></i>'))});case 10:case"end":return l.stop()}}),_callee)})));return function applyDamage(t,a){return r.apply(this,arguments)}}(),A=function applyChatCardDamage(t,r){var a=game.messages.get(t.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map((function(t){var o=t.actor,i="sp"!=r?a.total-d.Z.armorValue(o).armor:a.total;return o.applyDamage(Math.max(0,i))})))},O=function(){var r=chat_context_asyncToGenerator(chat_context_regeneratorRuntime().mark((function _callee2(r){var a,o,i,c,u,l,p,d,h,m,y,g,v,_,b;return chat_context_regeneratorRuntime().wrap((function _callee2$(w){for(;;)switch(w.prev=w.next){case 0:if(a=game.messages.get(r.attr("data-message-id")),o=a.flags.data,(i=t.Z.getSpeaker(a.speaker)).isOwner){w.next=5;break}return w.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.DamagePermission")));case 5:return c=o.preData.calculatedSpellModifiers.maintainCost.trim(),u=["ritual","spell"].includes(o.preData.source.type)||getProperty(o.preData.calculatedSpellModifiers,"costsMana")?"AsP":"KaP",w.next=9,i.applyMana(o.preData.calculatedSpellModifiers.finalcost,u);case 9:if(l=w.sent,!(c&&0!=c&&l&&o.postData.successLevel>0)){w.next=36;break}p=o.preData.source.name,w.prev=12,d=c.match(/^\d{1,3}/)[0],h=(h=Number(c.replace(/^\d{1,3}/,"").match(/\d{1,3}/)))[0]||1,m={label:"".concat(p," (").concat(game.i18n.localize("maintainCost"),")"),icon:"icons/svg/daze.svg",flags:{dsa5:{value:null,editable:!0,description:c,maintain:d,payType:u,custom:!0}},changes:[],duration:{}},y=[{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.seconds"),"gi"),seconds:1},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.years"),"gi"),seconds:3024e4}],g=0,v=y;case 19:if(!(g<v.length)){w.next=29;break}if(!(_=v[g]).regEx.test(c)){w.next=26;break}return b=Number(h)*_.seconds,m.duration.seconds=b,m.duration.rounds=m.duration.seconds/5,w.abrupt("break",29);case 26:g++,w.next=19;break;case 29:return w.next=31,i.addCondition(m);case 31:w.next=36;break;case 33:w.prev=33,w.t0=w.catch(12),console.error("Could not parse duration '".concat(c,"' of '").concat(p,"'"));case 36:return w.next=38,a.update({"flags.data.manaApplied":!0,content:a.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')});case 38:case"end":return w.stop()}}),_callee2,null,[[12,33]])})));return function payMana(t){return r.apply(this,arguments)}}();Hooks.on("getChatLogEntryContext",(function(r,d){var P,E;d.push({name:game.i18n.localize("CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:u,callback:function callback(t){k(t)}},{name:game.i18n.localize("CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:c,callback:function callback(t){k(t)}},{name:game.i18n.localize("regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:w,callback:(E=chat_context_asyncToGenerator(chat_context_regeneratorRuntime().mark((function _callee3(r){var a,o;return chat_context_regeneratorRuntime().wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,game.messages.get(r.attr("data-message-id"));case 2:if(a=i.sent,(o=t.Z.getSpeaker(a.speaker)).isOwner){i.next=6;break}return i.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.DamagePermission")));case 6:return i.next=8,a.update({"flags.data.healApplied":!0,content:a.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')});case 8:return i.next=10,o.applyRegeneration(a.flags.data.postData.LeP,a.flags.data.postData.AsP,a.flags.data.postData.KaP);case 10:case"end":return i.stop()}}),_callee3)}))),function callback(t){return E.apply(this,arguments)})},{name:game.i18n.localize("CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:i,callback:(P=chat_context_asyncToGenerator(chat_context_regeneratorRuntime().mark((function _callee4(t){return chat_context_regeneratorRuntime().wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:O(t);case 1:case"end":return r.stop()}}),_callee4)}))),function callback(t){return P.apply(this,arguments)})},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:a,callback:function callback(t){T(t,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:o,callback:function callback(t){T(t,"sp")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:x,callback:function callback(t){A(t,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:x,callback:function callback(t){A(t,"sp")}},{name:game.i18n.localize("CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:_,callback:function callback(t){S(t,"reroll")}},{name:game.i18n.localize("CHATCONTEXT.RerollGroup"),icon:'<i class="fas fa-dice"></i>',condition:b,callback:function callback(t){S(t,"reroll",1)}},{name:game.i18n.localize("CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:y,callback:function callback(t){S(t,"isTalented")}},{name:game.i18n.localize("CHATCONTEXT.AddQS"),icon:'<i class="fas fa-plus-square"></i>',condition:h,callback:function callback(t){S(t,"addQS")}},{name:game.i18n.localize("CHATCONTEXT.AddQSGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:m,callback:function callback(t){S(t,"addQS",1)}},{name:game.i18n.localize("CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:g,callback:function callback(t){S(t,"rerollDamage")}},{name:game.i18n.localize("CHATCONTEXT.rerollDamageGroup"),icon:'<i class="fas fa-dice"></i>',condition:v,callback:function callback(t){S(t,"rerollDamage",1)}},{name:game.i18n.localize("CHATCONTEXT.improveFate"),icon:'<i class="fas fa-plus-square"></i>',condition:l,callback:function callback(t){S(t,"Improve")}},{name:game.i18n.localize("CHATCONTEXT.improveFateGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:p,callback:function callback(t){S(t,"Improve",1)}})}))}(),statuseffect(),function sidebar(){Hooks.on("renderSidebarTab",(function(t,r){if("settings"==t.options.id){var a=$('<button id="reportADSABug"><i class="fas fa-bug"></i> '.concat(game.i18n.localize("DSA5Error"),"</button>"));a.click((function(){window.open("https://github.com/Plushtoast/dsa5-foundryVTT/issues","_blank")})),r.find("#settings-documentation").append(a),(a=$('<button><i class="fas fa-info-circle"></i> '.concat(game.i18n.localize("DSA5Wiki"),"</button>"))).click((function(){window.open("https://github.com/Plushtoast/dsa5-foundryVTT/wiki","_blank")})),r.find("#settings-documentation").append(a),(a=$('<button class="fshopButton"><div></div> F-Shop</button>')).click((function(){window.open(game.i18n.localize("fshopLink"),"_blank")})),r.find("#settings-documentation").append(a);var o=game.system.title.split("/")["de"==game.i18n.lang?0:1],i=r.find("#game-details .system span").html();r.find("#game-details .system").html("".concat(o,"<span>").concat(i,"</span>"))}})),Hooks.on("renderCompendiumDirectory",(function(t,r,a){var o=$('<button id="openLibrary"><i class="fas fa-university"></i>'.concat(game.i18n.localize("ItemLibrary"),"</button>"));r.find(".header-actions").append(o),o.click((function(){game.dsa5.itemLibrary.render(!0)})),r.find('li[data-pack="dsa5.money"]').hide();var i,c="de"==game.i18n.lang?"en":"de",u=sidebar_createForOfIteratorHelper(game.packs.filter((function(t){return getProperty(t.metadata,"flags.dsalang")==c})));try{for(u.s();!(i=u.n()).done;){var l=i.value,p="".concat(l.metadata.packageName,".").concat(l.metadata.name);game.packs.delete(p),r.find('li[data-pack="'.concat(p,'"]')).hide()}}catch(t){u.e(t)}finally{u.f()}})),Hooks.on("renderActorDirectory",(function(t,r,a){if(!game.user.isGM){var o,i=sidebar_createForOfIteratorHelper(t.documents.filter((function(t){return t.isMerchant()&&getProperty(t,"merchant.hidePlayer")})));try{for(i.s();!(o=i.n()).done;){var c=o.value;r.find('[data-document-id="'.concat(c.id,'"]')).remove()}}catch(t){i.e(t)}finally{i.f()}}}))}(),journal(),function tokenHUD(){Hooks.on("renderTokenHUD",(function(t,r,a){var o=t.object.actor;o&&(addThirdBarToHUD(r,o,t),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.lightHud(r,o,a)),r.find('.control-icon[data-action="target"]').mousedown((function(t){2==t.button&&(game.user.updateTokenTargets([]),$(t.currentTarget).click(),t.preventDefault())})),r.find(".attribute input").off("change")}))}(),Oe.Z(),function scene(){Hooks.on("preCreateScene",(function(t,r,a,o){var i;null!==(i=r.grid)&&void 0!==i&&i.units||t.updateSource({grid:{units:game.i18n.localize("gridUnits")}})})),Hooks.on("preCreateActiveEffect",(function(t,r,a,o){if("Actor"==t.parent.documentName){var i={duration:{}};t.duration.startTime||(i.duration.startTime=game.time.worldTime),game.combat?(i.duration.combat=game.combat.id,i.duration.startRound=game.combat.round,i.duration.startTurn=game.combat.turn,!t.duration.rounds&&t.duration.seconds&&(i.duration.rounds=t.duration.seconds/5),t.updateSource(i)):t.updateSource(i)}}))}(),function dsarolls(){Roll.prototype.editRollAtIndex=function(t){var r,a=[],o=dsarolls_createForOfIteratorHelper(t);try{for(o.s();!(r=o.n()).done;){var i,c=r.value,u=c.index,l=c.val,p=0,d=dsarolls_createForOfIteratorHelper(this.terms);try{for(d.s();!(i=d.n()).done;){var h=i.value,m=h instanceof DiceTerm||"DiceTerm"==h.class||h instanceof Die||"Die"==h.class,y=h instanceof OperatorTerm;if(m||h.faces){if(h.results[u-p]){var g=h.results[u-p].result;h.results[u-p].result=l,a.push(g)}m||(h.total=h.results.reduce((function(t,r){return t+r.result}),0)),p+=h.results.length}else y||"OperatorTerm"!=h.class&&!h.operator||(h.total=h.operator)}}catch(t){d.e(t)}finally{d.f()}a.push(0)}}catch(t){o.e(t)}finally{o.f()}return this._total=this._evaluateTotal(),a}}()}()})()})();