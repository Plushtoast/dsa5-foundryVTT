/*! For license information please see dsa5.bundle.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__={369:(e,t,r)=>{r.d(t,{Z:()=>R});var n=r(491),a=r(577),o=r(562),i=r(600),s=r(15),c=r(272),u=r(173),l=r(973),f=r(839),p=r(101),d=r(122),h=r(707),m=r(702),y=r(61),v=(r(604),r(803));function g(e){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g(e)}function b(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(e,t)||T(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e){return function(e){if(Array.isArray(e))return D(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||T(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function x(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?k(Object(r),!0).forEach((function(t){_(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function O(){O=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=k(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(S([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function b(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==g(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function k(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function _(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},b(w.prototype),s(w.prototype,o,(function(){return this})),e.AsyncIterator=w,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new w(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),_(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;_(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function E(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function S(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){E(o,n,a,i,s,"next",e)}function s(e){E(o,n,a,i,s,"throw",e)}i(void 0)}))}}function L(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=T(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function T(e,t){if(e){if("string"==typeof e)return D(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?D(e,t):void 0}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function A(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function j(){return j="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=C(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},j.apply(this,arguments)}function C(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=N(e)););return e}function I(e,t){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},I(e,t)}function M(e,t){if(t&&("object"===g(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function N(e){return N=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},N(e)}var R=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&I(e,t)}(se,Actor);var t,r,g,k,E,T,D,C,R,z,F,G,Z,B,H,W,q,U,Y,V,K,J,Q,X,ee,te,re,ne,ae,oe,ie=(ae=se,oe=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=N(ae);if(oe){var r=N(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return M(this,e)});function se(){return P(this,se),ie.apply(this,arguments)}return t=se,r=[{key:"prepareDerivedData",value:function(){var e=this.system;try{var t,r={},a=u.Z.abilityStep(this,game.i18n.localize("LocalizedIDs.inuredToEncumbrance"))>this.items.reduce((function(e,t){return"armor"==t.type&&getProperty(t,"system.worn.value")?e+Number(t.system.encumbrance.value):e}),0),o=L(this.items.filter((function(e){return["meleeweapon","rangeweapon","armor","equipment"].includes(e.type)&&getProperty(e,"system.worn.value")||["advantage","specialability","disadvantage"].includes(e.type)})));try{for(o.s();!(t=o.n()).done;){var i=t.value;a=this._addGearAndAbilityModifiers(r,i,a)}}catch(e){o.e(e)}finally{o.f()}e.itemModifiers=this._applyModiferTransformations(r);for(var s=0,l=Object.values(e.characteristics);s<l.length;s++){var f=l[s];f.value=f.initial+f.advances+(f.modifier||0)+f.gearmodifier,f.cost=game.i18n.format("advancementCost",{cost:n.Z._calculateAdvCost(f.initial+f.advances,"E")}),f.refund=game.i18n.format("refundCost",{cost:n.Z._calculateAdvCost(f.initial+f.advances,"E",0)})}var h=d.Z.isFamiliar(this),m=d.Z.isPet(this);e.canAdvance=("character"==this.type||h||m)&&this.isOwner,e.isMage=h||this.items.some((function(e){return["ritual","spell","magictrick"].includes(e.type)||"specialability"==e.type&&["magical","staff","pact"].includes(e.system.category.value)})),e.isPriest=this.items.some((function(e){return["ceremony","liturgy","blessing"].includes(e.type)||"specialability"==e.type&&["ceremonial","clerical"].includes(e.system.category.value)})),e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent,e.details.experience.description=n.Z.experienceDescription(e.details.experience.total)),"character"!=this.type&&"npc"!=this.type||(e.status.wounds.current=e.status.wounds.initial+2*e.characteristics.ko.value,e.status.soulpower.value=(e.status.soulpower.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/6),e.status.toughness.value=(e.status.toughness.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/6),e.status.initiative.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.status.initiative.modifier||0)),e.status.fatePoints.max=Number(e.status.fatePoints.current)+Number(e.status.fatePoints.modifier)+e.status.fatePoints.gearmodifier,"creature"==this.type&&(e.status.wounds.current=e.status.wounds.initial,e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial,e.status.initiative.value=e.status.initiative.current+(e.status.initiative.modifier||0)),e.status.wounds.max=Math.round((e.status.wounds.current+e.status.wounds.modifier+e.status.wounds.advances)*e.status.wounds.multiplier+e.status.wounds.gearmodifier),e.status.astralenergy.max=e.status.astralenergy.current+e.status.astralenergy.modifier+e.status.astralenergy.advances+e.status.astralenergy.gearmodifier,e.status.karmaenergy.max=e.status.karmaenergy.current+e.status.karmaenergy.modifier+e.status.karmaenergy.advances+e.status.karmaenergy.gearmodifier,e.status.regeneration.LePmax=e.status.regeneration.LePTemp+e.status.regeneration.LePMod+e.status.regeneration.LePgearmodifier,e.status.regeneration.KaPmax=e.status.regeneration.KaPTemp+e.status.regeneration.KaPMod+e.status.regeneration.KaPgearmodifier,e.status.regeneration.AsPmax=e.status.regeneration.AsPTemp+e.status.regeneration.AsPMod+e.status.regeneration.AsPgearmodifier;var y=e.guidevalue;(h||y&&"creature"!=this.type)&&(e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial,e.characteristics[y.magical]&&(e.status.astralenergy.current+=Math.round(e.characteristics[y.magical].value*e.energyfactor.magical)),e.characteristics[y.clerical]&&(e.status.karmaenergy.current+=Math.round(e.characteristics[y.clerical].value*e.energyfactor.clerical)),e.status.astralenergy.max=e.status.astralenergy.current+e.status.astralenergy.modifier+e.status.astralenergy.advances+e.status.astralenergy.gearmodifier,e.status.karmaenergy.max=e.status.karmaenergy.current+e.status.karmaenergy.modifier+e.status.karmaenergy.advances+e.status.karmaenergy.gearmodifier),e.status.speed.max=e.status.speed.initial+(e.status.speed.modifier||0)+e.status.speed.gearmodifier,e.status.soulpower.max=e.status.soulpower.value+e.status.soulpower.modifier+e.status.soulpower.gearmodifier,e.status.toughness.max=e.status.toughness.value+e.status.toughness.modifier+e.status.toughness.gearmodifier,e.status.dodge.value=Math.round(e.characteristics.ge.value/2)+e.status.dodge.gearmodifier;var v=this.hasCondition("encumbered");v=v?Number(v.flags.dsa5.value):0,e.status.speed.max=Math.round(Math.max(0,e.status.speed.max-Math.min(4,v))*(e.status.speed.multiplier||1)),e.status.initiative.value+=e.status.initiative.gearmodifier-Math.min(4,v);var g=Number((.01*e.status.initiative.value).toFixed(2));e.status.initiative.value*=e.status.initiative.multiplier||1,e.status.initiative.value=Math.round(e.status.initiative.value)+g,e.status.dodge.max=Number(e.status.dodge.value)+Number(e.status.dodge.modifier)+Number(game.settings.get("dsa5","higherDefense"))/2;var b=game.users.find((function(e){return e.active&&e.isGM}));if(b&&game.user.id==b.id){var w="creature"!=this.type||e.status.wounds.max>=20,k=0;e.status.wounds.max>0&&(w?(k=Math.floor(4*(1-e.status.wounds.value/e.status.wounds.max)),e.status.wounds.value<=5&&(k=4)):k=Math.floor(5-5*e.status.wounds.value/e.status.wounds.max),k<4&&(k-=c.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedFighter"))+c.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedAnimal"))+(u.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.traditionKor"))?1:0)),k>0&&(k+=c.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.sensitiveToPain"))+c.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.fragileAnimal"))),k=Math.clamped(k,0,4));var x=e.pain!=k;e.pain=k,c.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.blind"))&&this.addCondition("blind"),c.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.mute"))&&this.addCondition("mute"),c.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.deaf"))&&this.addCondition("deaf"),x&&!p.Z.hasTrait(this,game.i18n.localize("LocalizedIDs.painImmunity"))&&this.addCondition("inpain",k,!0).then((function(){return e.pain=void 0})),this.isMerchant()&&this.prepareMerchant(),this.hasCondition("bloodrush")||(e.status.speed.max=Math.max(0,e.status.speed.max-k))}var _=this.hasCondition("paralysed");_&&(e.status.speed.max=Math.round(e.status.speed.max*(1-.25*_.flags.dsa5.value))),this.hasCondition("fixated")?(e.status.speed.max=0,e.status.dodge.max=Math.max(0,e.status.dodge.max-4)):this.hasCondition("rooted")||this.hasCondition("incapacitated")?e.status.speed.max=0:this.hasCondition("prone")&&(e.status.speed.max=Math.min(1,e.status.speed.max))}catch(e){console.error("Something went wrong with preparing actor data: "+e+e.stack),ui.notifications.error(game.i18n.localize("ACTOR.PreparationError")+e+e.stack)}}},{key:"prepareMerchant",value:(ne=S(O().mark((function e(){var t;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("loot"!=getProperty(this,"system.merchant.merchantType")){e.next=11;break}if(!getProperty(this,"system.merchant.locked")||this.hasCondition("locked")){e.next=6;break}return e.next=4,this.addCondition(se.lockedCondition());case 4:e.next=11;break;case 6:if(getProperty(this,"system.merchant.locked")){e.next=11;break}if(!(t=this.effects.find((function(e){return"locked"==getProperty(e,"flags.core.statusId")})))){e.next=11;break}return e.next=11,this.deleteEmbeddedDocuments("ActiveEffect",[t.id]);case 11:case"end":return e.stop()}}),e,this)}))),function(){return ne.apply(this,arguments)})},{key:"applyActiveEffects",value:function(){var e=this,t={},r=this.effects.reduce((function(t,r){if(r.disabled)return t;if(r.origin){var n=r.origin.match(/[^.]+$/)[0],a=e.items.get(n);if(a){var o=!0;switch(a.type){case"meleeweapon":case"rangeweapon":case"armor":o=a.system.worn.value;break;case"equipment":o=a.system.worn.wearable&&a.system.worn.value||!a.system.worn.wearable;break;case"ammunition":case"plant":case"consumable":case"combatskill":case"magicsign":case"poison":case"spell":case"liturgy":case"ceremony":case"ritual":o=!1;break;case"specialability":o="Combat"!=a.system.category.value||[2,3].includes(a.system.category.sub)}if(r.notApplicable=!o,!o)return t}}return t.concat(r.changes.map((function(e){return(e=foundry.utils.duplicate(e)).effect=r,e.priority=e.priority?e.priority:10*e.mode,e})))}),[]);r.sort((function(e,t){return e.priority-t.priority}));var n,a=L(r);try{for(a.s();!(n=a.n()).done;){var o=n.value,i=o.effect.apply(this,o);null!==i&&(t[o.key]=i)}}catch(e){a.e(e)}finally{a.f()}this.overrides=foundry.utils.expandObject(t)}},{key:"_setOnUseEffect",value:function(e){getProperty(e,"flags.dsa5.onUseEffect")&&(e.OnUseEffect=!0)}},{key:"prepareBaseData",value:function(){var e=this.system;mergeObject(e,{skillModifiers:x({FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AsPCost:[],KaPCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],KaPCost:[],AsPCost:[]}},["liturgy","ceremony","ritual","spell","skill"].reduce((function(e,t){return e[t]={FP:[],step:[],QL:[],TPM:[],FW:[]},e}),{})),status:{initiative:{multiplier:1},wounds:{multiplier:1},regeneration:{LePgearmodifier:0,KaPgearmodifier:0,AsPgearmodifier:0}},repeatingEffects:{startOfRound:{wounds:[],karmaenergy:[],astralenergy:[]}},totalArmor:0,spellArmor:0,liturgyArmor:0,carryModifier:0,aspModifier:0,kapModifier:0,immunities:[],creatureBonus:[],miracle:{attack:0,parry:0},spellStats:{damage:"0"},liturgyStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1}});var t,r=L(a.Z.gearModifyableCalculatedAttributes);try{for(r.s();!(t=r.n()).done;){var n=t.value;e.status[n]&&(e.status[n].gearmodifier=0)}}catch(e){r.e(e)}finally{r.f()}for(var o=0,i=Object.values(e.characteristics);o<i.length;o++)i[o].gearmodifier=0}},{key:"getSkillModifier",value:function(e,t){for(var r=this,n=[],a=function(){var a=i[o],s="step"==a?"":a;n.push.apply(n,w(r.system.skillModifiers[a].filter((function(t){return t.target==e})).map((function(e){return{name:e.source,value:e.value,type:s}})))),r.system.skillModifiers[t]&&n.push.apply(n,w(r.system.skillModifiers[t][a].map((function(e){return{name:e.source,value:e.value,type:s}}))))},o=0,i=["FP","step","QL","TPM","FW"];o<i.length;o++)a();return n}},{key:"prepareSheet",value:function(e){var t=duplicate(this),r={system:{}};if(mergeObject(r,this.prepareItems(e)),r.canAdvance)for(var a=0,o=["wounds","astralenergy","karmaenergy"];a<o.length;a++){var i=o[a];mergeObject(r.system,{status:_({},i,{cost:game.i18n.format("advancementCost",{cost:n.Z._calculateAdvCost(t.system.status[i].advances,"D")}),refund:game.i18n.format("refundCost",{cost:n.Z._calculateAdvCost(t.system.status[i].advances,"D",0)})})})}return r}},{key:"_perpareItemAdvancementCost",value:function(e){return e.cost=game.i18n.format("advancementCost",{cost:n.Z._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e.refund=game.i18n.format("refundCost",{cost:n.Z._calculateAdvCost(e.system.talentValue.value,e.system.StF.value,0)}),e.canAdvance=se.canAdvance(this),e}},{key:"prepareItems",value:function(e){for(var t,r,n=this,o=this.toObject(!1),i=[],s=[],c=[],u=[],l=[],f=[],p=[],h=[],y=Object.fromEntries(Object.keys(a.Z.specialAbilityCategories).map((function(e){return[e,[]]}))),v=Object.fromEntries(Object.keys(a.Z.traitCategories).map((function(e){return[e,[]]}))),g=[],k=[],x=[],_={hasSpells:this.system.isMage,hasPrayers:this.system.isPriest,liturgy:[],spell:[],ritual:[],ceremony:[],blessing:[],magictrick:[],magicalsign:[]},O={spell:{},ritual:{},ceremony:{},liturgy:{}},E=[],S=1;S<=Number(o.system.status.fatePoints.max);S++)E.push({value:S,cssClass:S<=Number(o.system.status.fatePoints.value)?"fullSchip":"emptySchip"});var T={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},plant:{items:[],show:!1,dataType:"plant"},poison:{items:[],show:!1,dataType:"poison"}};for(var D in a.Z.equipmentTypes)T[D]={items:[],show:!1,dataType:D};T.misc.show=!0;var P={coins:[],total:0,show:!0};o.items=o.items.sort((function(e,t){return e.name.localeCompare(t.name)}));var A,j=o.system.totalArmor||0,C=0,I={body:[],social:[],knowledge:[],trade:[],nature:[]},M=new Map,N=L(o.items.filter((function(e){return"equipment"==e.type&&"bags"==e.system.equipmentType.value})));try{for(N.s();!(A=N.n()).done;){var R=A.value;M.set(R._id,[])}}catch(e){N.e(e)}finally{N.f()}var z,F=new Map,G=[],Z=!1,B=L(o.items);try{for(B.s();!(z=B.n()).done;){var H=z.value;try{var W=getProperty(H,"system.parent_id");if("ammunition"==H.type&&G.push(se._prepareitemStructure(H)),W&&W!=H._id&&M.has(W)){M.get(W).push(H);continue}switch(e.details&&e.details.includes(H._id)&&(H.detailed="shown"),H.type){case"skill":I[H.system.group.value].push(this._perpareItemAdvancementCost(H));break;case"information":h.push(H);break;case"aggregatedTest":u.push(H);break;case"spellextension":O[H.system.category][H.system.source]?O[H.system.category][H.system.source].push(H.name):O[H.system.category][H.system.source]=[H.name];break;case"ritual":case"spell":case"liturgy":case"ceremony":_[H.type].push(se.buildSpellChargeProgress(this._perpareItemAdvancementCost(H)));break;case"magicalsign":case"magictrick":case"blessing":_[H.type].push(H);break;case"trait":switch(H.system.traitType.value){case"rangeAttack":H=se._prepareRangeTrait(H);break;case"meleeAttack":H=se._prepareMeleetrait(H);break;case"armor":j+=Number(H.system.at.value)}v[H.system.traitType.value].push(H),Z=!0;break;case"combatskill":i.push(se._calculateCombatSkillValues(H,this.system));break;case"ammunition":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),T.ammunition.items.push(se.prepareMag(H)),T.ammunition.show=!0,C+=Number(H.weight);break;case"meleeweapon":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),H.toggleValue=H.system.worn.value||!1,H.toggle=!0,this._setOnUseEffect(H),T.meleeweapons.items.push(se._prepareitemStructure(H)),T.meleeweapons.show=!0,H.toggleValue&&p.push(H),C+=Number(H.weight);break;case"rangeweapon":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),H.toggleValue=H.system.worn.value||!1,H.toggle=!0,this._setOnUseEffect(H),T.rangeweapons.items.push(se._prepareitemStructure(H)),T.rangeweapons.show=!0,C+=Number(H.weight);break;case"armor":H.toggleValue=H.system.worn.value||!1,T.armor.items.push(se._prepareitemStructure(H)),T.armor.show=!0,H.toggle=!0,this._setOnUseEffect(H),H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),C+=parseFloat((H.system.weight.value*(H.toggleValue?Math.max(0,H.system.quantity.value-1):H.system.quantity.value)).toFixed(3)),H.system.worn.value&&(H.system.protection.value=m.Z.armorWearModifier(H,H.system.protection.value),j+=Number(H.system.protection.value),g.push(H));break;case"plant":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),T.plant.items.push(H),T.plant.show=!0,C+=Number(H.weight);break;case"poison":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),T.poison.items.push(H),T.poison.show=!0,C+=Number(H.weight);break;case"consumable":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),T[H.system.equipmentType.value].items.push(se._prepareConsumable(H)),T[H.system.equipmentType.value].show=!0,C+=Number(H.weight);break;case"equipment":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),H.toggle=getProperty(H,"system.worn.wearable")||!1,H.toggle&&(H.toggleValue=H.system.worn.value||!1),this._setOnUseEffect(H),T[H.system.equipmentType.value].items.push(se._prepareitemStructure(H)),T[H.system.equipmentType.value].show=!0,C+=Number(H.weight);break;case"money":H.weight=parseFloat((H.system.weight.value*H.system.quantity.value).toFixed(3)),P.coins.push(H),C+=Number(H.weight),P.total+=H.system.quantity.value*H.system.price.value;break;case"advantage":this._setOnUseEffect(H),s.push(H);break;case"disadvantage":this._setOnUseEffect(H),c.push(H);break;case"specialability":this._setOnUseEffect(H),y[H.system.category.value].push(H);break;case"disease":l.push(H);break;case"patron":y.magical.push(H);break;case"demonmark":f.push(H);break;case"application":F.has(H.system.skill)?F.get(H.system.skill).push(H):F.set(H.system.skill,[H])}}catch(e){this._itemPreparationError(H,e)}}}catch(e){B.e(e)}finally{B.f()}var q,$=L(T.bags.items);try{for($.s();!(q=$.n()).done;){var U=q.value;C+=this._setBagContent(U,M)}}catch(e){$.e(e)}finally{$.f()}for(var Y=0,V=Object.entries(O);Y<V.length;Y++)for(var K=b(V[Y],2),J=K[0],Q=K[1],X=function(){var e=b(te[ee],2),t=e[0],r=e[1];_[J].find((function(e){return e.name==t})).extensions=r.join(", ")},ee=0,te=Object.entries(Q);ee<te.length;ee++)X();var re,ne=L(T.rangeweapons.items);try{for(ne.s();!(re=ne.n()).done;){var ae=re.value;try{ae.system.worn.value&&k.push(se._prepareRangeWeapon(ae,G,i,this))}catch(e){this._itemPreparationError(ae,e)}}}catch(e){ne.e(e)}finally{ne.f()}for(var oe=function(){var e=ce[ie];try{x.push(se._prepareMeleeWeapon(e,i,o,p.filter((function(t){return t._id!=e._id&&!d.Z.isYieldedTwohanded(t)}))))}catch(t){n._itemPreparationError(e,t)}},ie=0,ce=p;ie<ce.length;ie++)oe();for(var ue=0,le=Object.entries(I);ue<le.length;ue++){var fe,pe=b(le[ue],2),de=(pe[0],L(pe[1]));try{for(de.s();!(fe=de.n()).done;){var he=fe.value;he.applications=F.get(he.name)||[]}}catch(e){de.e(e)}finally{de.f()}}P.coins=P.coins.sort((function(e,t){return e.system.price.value>t.system.price.value?-1:1}));var me=2*o.system.characteristics.kk.value+o.system.carryModifier,ye=this.getArmorEncumbrance(this,g);"creature"==this.type&&!this.canAdvance||this.isMerchant()||(ye+=Math.max(0,Math.ceil((C-me-4)/4))),this.addCondition("encumbered",ye,!0),C=parseFloat(C.toFixed(3)),(t=y.magical).push.apply(t,w(y.staff).concat(w(y.pact))),(r=y.clerical).push.apply(r,w(y.ceremonial));var ve=duplicate(a.Z.characteristics);return ve["-"]="-",{totalWeight:C,armorSum:j,spellArmor:o.system.spellArmor||0,liturgyArmor:o.system.liturgyArmor||0,money:P,encumbrance:ye,carrycapacity:me,wornRangedWeapons:k,wornMeleeWeapons:x,advantages:s,disadvantages:c,specAbs:y,information:h,aggregatedtests:u,wornArmor:g,inventory:T,hasTrait:Z,demonmarks:f,diseases:l,itemModifiers:this.system.itemModifiers,languagePoints:{used:o.system.freeLanguagePoints?o.system.freeLanguagePoints.used:0,available:o.system.freeLanguagePoints?o.system.freeLanguagePoints.value:0},schips:E,guidevalues:ve,magic:_,traits:v,combatskills:i,canAdvance:this.system.canAdvance,sheetLocked:o.system.sheetLocked.value,allSkillsLeft:{body:I.body,social:I.social,nature:I.nature},allSkillsRight:{knowledge:I.knowledge,trade:I.trade}}}},{key:"getArmorEncumbrance",value:function(e,t){var r=t.reduce((function(e,t){return t.calculatedEncumbrance=Number(t.system.encumbrance.value)+m.Z.armorEncumbranceModifier(t),t.damageToolTip=m.Z.damageTooltip(t),e+t.calculatedEncumbrance}),0);return Math.max(0,r-u.Z.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance")))}},{key:"_setBagContent",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=0;if(t.has(e._id)){e.children=[];var a=0;!e.toggleValue&&r&&(n-=e.weight);var o,i=L(t.get(e._id));try{for(i.s();!(o=i.n()).done;){var s=o.value;s.weight=Number(parseFloat((s.system.weight.value*s.system.quantity.value).toFixed(3))),a+=s.weight,e.children.push(se._prepareitemStructure(se._prepareConsumable(s))),t.has(s._id)&&(a+=this._setBagContent(s,t,!1))}}catch(e){i.e(e)}finally{i.f()}!e.toggleValue&&r||(n+=a),e.bagweight="".concat(a.toFixed(3),"/").concat(e.system.capacity)}return n}},{key:"isMerchant",value:function(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}},{key:"_itemPreparationError",value:function(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}},{key:"_applyModiferTransformations",value:function(e){for(var t=0,r=Object.entries(e);t<r.length;t++){var n=b(r[t],2),a=n[0],o=n[1],i=game.dsa5.config.knownShortcuts[a.toLowerCase()];i?this.system[i[0]][i[1]][i[2]]+=o.value:delete e[a]}return e}},{key:"_addGearAndAbilityModifiers",value:function(e,t,r){var n=getProperty(t,"system.effect.value");if(!n)return r;var a,o=!0,i=L(n.split(/,|;/).map((function(e){return e.trim()})));try{for(i.s();!(a=i.n()).done;){var s=a.value.replace(/(\s+)/g," ").trim().split(" ");2==s.length&&(isNaN(s[0])||(r&&"armor"==t.type&&[game.i18n.localize("CHARAbbrev.INI").toLowerCase(),game.i18n.localize("CHARAbbrev.GS").toLowerCase()].includes(s[1].toLowerCase())?o=!1:null==e[s[1]]?e[s[1]]={value:Number(s[0])*(t.system.step&&Number(t.system.step.value)||1),sources:[t.name]}:(e[s[1]].value+=Number(s[0])*(t.system.step&&Number(t.system.step.value)||1),e[s[1]].sources.push(t.name))))}}catch(e){i.e(e)}finally{i.f()}return r&&o}},{key:"_updateAPs",value:(re=S(O().mark((function e(t){var r,n,a,o=arguments;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:{},!se.canAdvance(this)){e.next=12;break}if(isNaN(t)||null==t){e.next=11;break}return n=Number(t),r["system.details.experience.spent"]=Number(this.system.details.experience.spent)+n,e.next=7,this.update(r);case 7:a=game.i18n.format(n>0?"advancementCost":"refundCost",{cost:Math.abs(n)}),(0,h.p0)(a),e.next=12;break;case 11:ui.notifications.error(game.i18n.localize("DSAError.APUpdateError"));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return re.apply(this,arguments)})},{key:"checkEnoughXP",value:(te=S(O().mark((function e(t){var r,n,o,i,s,c;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(se.canAdvance(this)){e.next=2;break}return e.abrupt("return",!0);case 2:if(!isNaN(t)&&null!=t){e.next=4;break}return e.abrupt("return",!0);case 4:if(!(Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=t)){e.next=8;break}return e.abrupt("return",!0);case 8:if(!Number(0==this.system.details.experience.total)){e.next=23;break}return r=Object.entries(a.Z.startXP).map((function(e){var t=b(e,2),r=t[0],n=t[1];return'<option value="'.concat(r,'">').concat(game.i18n.localize(n)," (").concat(r,")</option>")})).join(""),n="<p>".concat(game.i18n.localize("DSAError.zeroXP"),"</p><label>").concat(game.i18n.localize("APValue"),': </label><select name ="APsel">').concat(r,"</select>"),o=0,i=!1,e.next=15,new Promise((function(e,t){new Dialog({title:game.i18n.localize("DSAError.NotEnoughXP"),content:n,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(t){e([!0,t.find('[name="APsel"]')[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function(){e([!1,0])}}}}).render(!0)}));case 15:if(s=e.sent,c=b(s,2),i=c[0],o=c[1],!i){e.next=23;break}return e.next=22,this.update({"system.details.experience.total":Number(o)});case 22:return e.abrupt("return",!0);case 23:return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughXP")),e.abrupt("return",!1);case 25:case"end":return e.stop()}}),e,this)}))),function(e){return te.apply(this,arguments)})},{key:"setupWeapon",value:function(e,t,r,n){return r.mode=t,f.Z.getSubClass(e.type).setupDialog(null,r,e,this,n)}},{key:"setupWeaponless",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,n=foundry.utils.duplicate(a.Z.defaultWeapon);return n.name=game.i18n.localize("".concat(e,"Weaponless")),n.system.combatskill={value:game.i18n.localize("LocalizedIDs.wrestle")},n.system.damageThreshold.value=14,u.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyAstralBody"))&&mergeObject(n,{system:{effect:{attributes:game.i18n.localize("magical")}}}),t.mode=e,f.Z.getSubClass(n.type).setupDialog(null,t,n,this,r)}},{key:"setupSpell",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return f.Z.getSubClass(e.type).setupDialog(null,t,e,this,r)}},{key:"setupSkill",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return f.Z.getSubClass(e.type).setupDialog(null,t,e,this,r)}},{key:"tokenScrollingText",value:function(e){var t,r,n=L(this.isToken?[null===(t=this.token)||void 0===t?void 0:t.object]:this.getActiveTokens(!0));try{for(n.s();!(r=n.n()).done;){var a=r.value;if(a){var o,i=0,s=L(e);try{for(s.s();!(o=s.n()).done;){var c=o.value;canvas.interface.createScrollingText(a.center,c.value,{anchor:i,direction:c.value>0?2:1,fontSize:game.settings.get("dsa5","scrollingFontsize"),stroke:c.stroke,strokeThickness:1,jitter:.25,duration:1e3}),i+=1}}catch(e){s.e(e)}finally{s.f()}}}}catch(e){n.e(e)}finally{n.f()}}},{key:"_preUpdate",value:(ee=S(O().mark((function e(t,r,n){var a,o,i,s,c,u;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j(N(se.prototype),"_preUpdate",this).call(this,t,r,n);case 2:for(a={wounds:9109504,astralenergy:723929,karmaenergy:303670},o=[],i=0,s=Object.keys(a);i<s.length;i++)c=s[i],(u=getProperty(t,"system.status.".concat(c,".value")))&&o.push({value:u-this.system.status[c].value,stroke:a[c]});o.length&&this.tokenScrollingText(o);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return ee.apply(this,arguments)})},{key:"applyDamage",value:(X=S(O().mark((function e(t){var r;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Math.min(this.system.status.wounds.max,this.system.status.wounds.value-t),e.next=3,this.update({"system.status.wounds.value":r});case 3:case"end":return e.stop()}}),e,this)}))),function(e){return X.apply(this,arguments)})},{key:"applyRegeneration",value:(Q=S(O().mark((function e(t,r,n){var a;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={"system.status.wounds.value":Math.min(this.system.status.wounds.max,this.system.status.wounds.value+(t||0)),"system.status.karmaenergy.value":Math.min(this.system.status.karmaenergy.max,this.system.status.karmaenergy.value+(n||0)),"system.status.astralenergy.value":Math.min(this.system.status.astralenergy.max,this.system.status.astralenergy.value+(r||0))},e.next=3,this.update(a);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return Q.apply(this,arguments)})},{key:"applyMana",value:(J=S(O().mark((function e(t,r){var n,a;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n="AsP"==r?"astralenergy":"karmaenergy",!((a=Math.min(this.system.status[n].max,this.system.status[n].value-t))>=0)){e.next=7;break}return e.next=5,this.update(_({},"data.status.".concat(n,".value"),a));case 5:e.next=8;break;case 7:ui.notifications.error(game.i18n.localize("DSAError.NotEnough".concat(r)));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return J.apply(this,arguments)})},{key:"preparePostRollAction",value:function(e){var t=e.flags.data,r={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.user};return t.attackerMessage&&(r.attackerMessage=t.attackerMessage),t.defenderMessage&&(r.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(r.unopposedStartMessage=t.unopposedStartMessage),r}},{key:"resetTargetAndMessage",value:function(e,t){e.originalTargets&&e.originalTargets.size>0&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}},{key:"fatererollDamage",value:(K=S(O().mark((function e(t,r,a,i,s,c){var u,l,f;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(s,r),u=s.postData.damageRoll,e.t0=o.Z,e.next=6,new Roll(u.formula||u._formula).evaluate({async:!0});case 6:return e.t1=e.sent,e.next=9,e.t0.manualRolls.call(e.t0,e.t1,"CHATCONTEXT.rerollDamage");case 9:for(l=e.sent,f=0;f<l.dice.length;f++)l.dice[f].options.colorset="black";return e.next=13,o.Z.showDiceSoNice(l,a.rollMode);case 13:return ChatMessage.create(n.Z.chatDataSetup(t)),a.damageRoll=duplicate(l),this["".concat(s.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),e.next=18,i.update({"flags.data.fatePointDamageRerollUsed":!0});case 18:return e.next=20,this.reduceSchips(c);case 20:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a,o){return K.apply(this,arguments)})},{key:"fateisTalented",value:(V=S(O().mark((function e(t,r,a,i,c){var u,l=this;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.talentedRerollUsed=!0,this.resetTargetAndMessage(c,r),t='<h3 class="center"><b>'.concat(game.i18n.localize("CHATFATE.faitepointUsed"),"</b></h3>\n            ").concat(game.i18n.format("CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"}),"<br>"),e.next=5,renderTemplate("systems/dsa5/templates/dialog/isTalentedReroll-dialog.html",{testData:a,postData:c.postData});case 5:u=e.sent,new s.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:u,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:function(){var e=S(O().mark((function e(s){var u,f,p,d,h,m,y,v,g,b,w,k,x;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((u=s.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get()).length>0)){e.next=23;break}f=[],p=L(u);try{for(p.s();!(d=p.n()).done;)h=d.value,m=a.roll.terms[2*h],f.push(m.number+"d"+m.faces+"["+m.options.colorset+"]")}catch(e){p.e(e)}finally{p.f()}return e.t0=o.Z,e.next=8,new Roll(f.join("+")).evaluate({async:!0});case 8:return e.t1=e.sent,e.next=11,e.t0.manualRolls.call(e.t0,e.t1,"CHATCONTEXT.talentedReroll");case 11:return f=e.sent,e.next=14,o.Z.showDiceSoNice(f,a.rollMode);case 14:y=0,v=[],g=L(u);try{for(g.s();!(b=g.n()).done;)w=b.value,k=a.source.system["characteristic".concat(w+1)],x=k?game.i18n.localize("CHARAbbrev.".concat(k.value.toUpperCase()))+" - ":"",v.push("".concat(x).concat(a.roll.terms[2*w].results[0].result,"/").concat(f.terms[2*y].results[0].result)),a.roll.terms[2*w].results[0].result=Math.min(f.terms[2*y].results[0].result,a.roll.terms[2*w].results[0].result),y+=1}catch(e){g.e(e)}finally{g.f()}return t+="<b>".concat(game.i18n.localize("Roll"),"</b>: ").concat(v.join(", ")),ChatMessage.create(n.Z.chatDataSetup(t)),l["".concat(c.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),e.next=23,i.update({"flags.data.talentedRerollUsed":!0});case 23:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a){return V.apply(this,arguments)})},{key:"fatereroll",value:(Y=S(O().mark((function e(t,r,a,i,c,u){var l,f=this;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(c,r),e.next=4,renderTemplate("systems/dsa5/templates/dialog/fateReroll-dialog.html",{testData:a,postData:c.postData});case 4:l=e.sent,new s.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:l,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:function(){var e=S(O().mark((function e(s){var l,p,d,h,m,y,v,g,b,w,k,x,_,E,S,T;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((l=s.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get()).length>0)){e.next=28;break}p=[],d=L(l);try{for(d.s();!(h=d.n()).done;)m=h.value,y=a.roll.terms[2*m],p.push(y.number+"d"+y.faces+"["+y.options.colorset+"]")}catch(e){d.e(e)}finally{d.f()}return e.t0=o.Z,e.next=8,new Roll(p.join("+")).evaluate({async:!0});case 8:return e.t1=e.sent,e.next=11,e.t0.manualRolls.call(e.t0,e.t1,"CHATCONTEXT.Reroll");case 11:return p=e.sent,e.next=14,o.Z.showDiceSoNice(p,a.rollMode);case 14:v=0,g=[],b=n.Z.getSpeaker(a.extra.speaker),w=game.i18n.localize("LocalizedIDs.traditionPhex"),k=b.items.some((function(e){return"specialability"==e.type&&e.name==w})),x=L(l);try{for(x.s();!(_=x.n()).done;)E=_.value,S=a.source.system["characteristic".concat(E+1)],T=S?"".concat(game.i18n.localize("CHARAbbrev.".concat(S.value.toUpperCase()))," - "):"",g.push("".concat(T).concat(a.roll.terms[2*E].results[0].result,"/").concat(p.terms[2*v].results[0].result)),a.roll.terms[2*E].results[0].result=k?Math.min(p.terms[2*v].results[0].result,a.roll.terms[2*E].results[0].result):p.terms[2*v].results[0].result,v+=1}catch(e){x.e(e)}finally{x.f()}return t+="<br><b>".concat(game.i18n.localize("Roll"),"</b>: ").concat(g.join(", ")),ChatMessage.create(n.Z.chatDataSetup(t)),f["".concat(c.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:i}),e.next=26,i.update({"flags.data.fatePointRerollUsed":!0});case 26:return e.next=28,f.reduceSchips(u);case 28:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a,o){return Y.apply(this,arguments)})},{key:"fateaddQS",value:(U=S(O().mark((function e(t,r,a,o,i,s){return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ChatMessage.create(n.Z.chatDataSetup(t)),game.user.targets.forEach((function(e){return e.setTarget(!1,{user:game.user,releaseOthers:!1,groupSelection:!0})})),r.fatePointAddQSUsed=!0,a.qualityStep=1,this["".concat(i.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:o}),e.next=7,o.update({"flags.data.fatePointAddQSUsed":!0});case 7:return e.next=9,this.reduceSchips(s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a,o){return U.apply(this,arguments)})},{key:"fateImprove",value:(q=S(O().mark((function e(t,r,a,o,i,c){var u,l,f,p=this;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(ChatMessage.create(n.Z.chatDataSetup(t)),this.resetTargetAndMessage(i,r),u=o.flags.data.preData.source.type,!["spell","liturgy","ceremony","ritual","skill"].includes(u)){e.next=10;break}return e.next=6,renderTemplate("systems/dsa5/templates/dialog/fateImprove-dialog.html",{testData:a,postData:i.postData});case 6:l=e.sent,new s.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:l,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:function(){var e=S(O().mark((function e(t){var n,s,u;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[0,0,0],1!=(s=t.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get()).length){e.next=12;break}return n[s]=2,u={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:n.join("|"),type:"roll"},a.roll.terms[2*s].results[0].result=Math.max(1,a.roll.terms[2*s].results[0].result-2),a.situationalModifiers.push(u),p["".concat(i.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:o}),e.next=10,o.update({"flags.data.fateImproved":!0});case 10:return e.next=12,p.reduceSchips(c);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0),e.next=18;break;case 10:return f={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:2,type:"roll"},a.situationalModifiers.push(f),a.roll.terms[0].results[0].result=Math.max(1,a.roll.terms[0].results[0].result-2),this["".concat(i.postData.postFunction)]({testData:a,cardOptions:r},{rerenderMessage:o}),e.next=16,o.update({"flags.data.fateImproved":!0});case 16:return e.next=18,this.reduceSchips(c);case 18:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a,o){return q.apply(this,arguments)})},{key:"reduceSchips",value:(W=S(O().mark((function e(t){var r;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!=t){e.next=5;break}return e.next=3,this.update({"system.status.fatePoints.value":this.system.status.fatePoints.value-1});case 3:e.next=9;break;case 5:return(r=game.settings.get("dsa5","groupschips").split("/").map((function(e){return Number(e)})))[0]=r[0]-1,e.next=9,game.settings.set("dsa5","groupschips",r.join("/"));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return W.apply(this,arguments)})},{key:"useFateOnRoll",value:(H=S(O().mark((function e(t,r,a){var o,i,s,c,u,l;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:("isTalented"==r||n.Z.fateAvailable(this,1==a))&&(o=t.flags.data,i=this.preparePostRollAction(t),0==a?(s=this.system.status.fatePoints.value-1,c="PointsRemaining"):(s=game.settings.get("dsa5","groupschips").split("/")[0],c="GroupPointsRemaining"),u='<h3 class="center"><b>'.concat(game.i18n.localize("CHATFATE.faitepointUsed"),"</b></h3>\n                ").concat(game.i18n.format("CHATFATE."+r,{character:"<b>"+this.name+"</b>"}),"<br>\n                <b>").concat(game.i18n.localize("CHATFATE.".concat(c)),"</b>: ").concat(s),(l=o.preData).extra.actor=n.Z.getSpeaker(l.extra.speaker).toObject(!1),this["fate".concat(r)](u,i,l,t,o,a));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return H.apply(this,arguments)})},{key:"setupRegeneration",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,i=game.i18n.localize("regenerationTest"),s={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:r,speaker:{token:n,actor:this.id}}};s.extra.actor.isMage=this.system.isMage,s.extra.actor.isPriest=this.system.isPriest;var c=l.Z.getRollModifiers(s.extra.actor,s.source),u={title:i,template:"/systems/dsa5/templates/dialog/regeneration-dialog.html",data:{rollMode:r.rollMode,regenerationInterruptOptions:a.Z.regenerationInterruptOptions,regnerationCampLocations:a.Z.regnerationCampLocations,showAspModifier:this.system.isMage,showKapModifier:this.system.isPriest,situationalModifiers:c,modifier:r.modifier||0},callback:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s.situationalModifiers=se._parseModifiers(e),f.rollMode=e.find('[name="rollMode"]').val(),s.situationalModifiers.push({name:game.i18n.localize("camplocation")+" - "+e.find('[name="regnerationCampLocations"] option:selected').text(),value:e.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("interruption")+" - "+e.find('[name="regenerationInterruptOptions"] option:selected').text(),value:e.find('[name="regenerationInterruptOptions"]').val()}),s.regenerationFactor=e.find('[name="badEnvironment"]').is(":checked")?.5:1,s.AsPModifier=Number(e.find('[name="aspModifier"]').val()||0),s.KaPModifier=Number(e.find('[name="kapModifier"]').val()||0),s.LePModifier=Number(e.find('[name="lepModifier"]').val()),s.regenerationAsP=Number(t.system.status.regeneration.AsPmax),s.regenerationKaP=Number(t.system.status.regeneration.KaPmax),s.regenerationLeP=Number(t.system.status.regeneration.LePmax),mergeObject(s.extra.options,r),t.update({"system.status.regeneration.LePTemp":0,"system.status.regeneration.KaPTemp":0,"system.status.regeneration.AsPTemp":0}),{testData:s,cardOptions:f}}},f=this._setupCardOptions("systems/dsa5/templates/chat/roll/regeneration-card.html",i);return o.Z.setupDialog({dialogOptions:u,testData:s,cardOptions:f})}},{key:"setupDodge",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r="dodge",n=this.system.status[r],a=game.i18n.localize(r)+" "+game.i18n.localize("Test"),i={source:{system:n,type:r},opposable:!1,extra:{statusId:r,actor:this.toObject(!1),options:e,speaker:{token:t,actor:this.id}}},s=[game.i18n.localize(r)],c=f.Z.buildCombatSpecAbs(this,["Combat"],s,"parry"),u=l.Z.getRollModifiers(i.extra.actor,i.source),p=f.Z.getDefenseMalus(u,this),h=d.Z.multipleDefenseValue(this,i.source),m={title:a,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:{rollMode:e.rollMode,combatSpecAbs:c,showDefense:!0,situationalModifiers:u,isRangeAttack:p,defenseCountString:game.i18n.format("defenseCount",{malus:h})},callback:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return y.rollMode=e.find('[name="rollMode"]').val(),i.situationalModifiers=se._parseModifiers(e),(t=i.situationalModifiers).push.apply(t,w(f.Z.getSpecAbModifiers(e,"parry"))),i.situationalModifiers.push({name:game.i18n.localize("attackFromBehind"),value:e.find('[name="attackFromBehind"]').is(":checked")?-4:0},{name:game.i18n.format("defenseCount",{malus:h}),value:(Number(e.find('[name="defenseCount"]').val())||0)*h}),mergeObject(i.extra.options,r),{testData:i,cardOptions:y}}},y=this._setupCardOptions("systems/dsa5/templates/chat/roll/status-card.html",a);return o.Z.setupDialog({dialogOptions:m,testData:i,cardOptions:y})}},{key:"setupCharacteristic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,n=this.system.characteristics[e],i=game.i18n.localize(n.label)+" "+game.i18n.localize("Test"),s={opposable:!1,source:{type:"char",system:n},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:{token:r,actor:this.id}}},c={title:i,template:"/systems/dsa5/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,difficultyLabels:a.Z.attributeDifficultyLabels,modifier:t.modifier||0},callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u.rollMode=e.find('[name="rollMode"]').val(),s.testDifficulty=a.Z.attributeDifficultyModifiers[e.find('[name="testDifficulty"]').val()],s.situationalModifiers=se._parseModifiers(e),mergeObject(s.extra.options,t),{testData:s,cardOptions:u}}},u=this._setupCardOptions("systems/dsa5/templates/chat/roll/characteristic-card.html",i);return o.Z.setupDialog({dialogOptions:c,testData:s,cardOptions:u})}},{key:"actorEffects",value:(B=S(O().mark((function e(){var t,r;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=["dead"],e.t0=game.user.isGM||this.testUserPermission(game.user,"OBSERVER"),e.t0){e.next=6;break}return e.next=5,game.settings.get("dsa5","hideEffects");case 5:e.t0=!e.sent;case 6:return r=e.t0,e.abrupt("return",r?this.effects.filter((function(e){return!e.disabled&&!e.notApplicable&&(game.user.isGM||!e.getFlag("dsa5","hidePlayers"))&&!e.getFlag("dsa5","hideOnToken")})):this.effects.filter((function(e){return t.includes(e.getFlag("core","statusId"))})));case 8:case"end":return e.stop()}}),e,this)}))),function(){return B.apply(this,arguments)})},{key:"_preCreate",value:(Z=S(O().mark((function e(t,r,n){var a;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j(N(se.prototype),"_preCreate",this).call(this,t,r,n);case 2:a={},t.img||(a.img="icons/svg/mystery-man-black.svg"),"character"==t.type&&mergeObject(a,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(a);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return Z.apply(this,arguments)})},{key:"_setupCardOptions",value:function(e,t){var r={speaker:{alias:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)r.speaker.alias=this.token.name,r.speaker.token=this.token.id,r.speaker.scene=canvas.scene.id,r.flags.img=this.token.img;else{var n=ChatMessage.getSpeaker();n.actor==this.id&&(r.speaker.alias=n.alias,r.speaker.token=n.token,r.speaker.scene=n.scene,r.flags.img=n.token?canvas.tokens.get(n.token).img:r.flags.img)}return r}},{key:"swapMag",value:(G=S(O().mark((function e(t){var r,n;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.items.get(t),!((n=this.items.get(r.system.currentAmmo.value))&&n.system.quantity.value>1)){e.next=7;break}return e.next=5,this.updateEmbeddedDocuments("Item",[{_id:n.id,"system.quantity.value":n.system.quantity.value-1,"system.mag.value":n.system.mag.max}]);case 5:return v.Z.playEquipmentWearStatusChange(n),e.abrupt("return",n);case 7:return ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),e.abrupt("return",void 0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return G.apply(this,arguments)})},{key:"payMiracles",value:(F=S(O().mark((function e(t){var r,n,a;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.extra.miraclePaid){e.next=8;break}if(t.extra.miraclePaid=!0,r=t.situationalModifiers.some((function(e){return e.name.trim()==game.i18n.localize("LocalizedIDs.miracleMight")})),n=t.situationalModifiers.some((function(e){return e.name.trim()==game.i18n.localize("LocalizedIDs.miracle")})),!(a=r?6:n?4:0)){e.next=8;break}return e.next=8,this.update({"system.status.karmaenergy.value":this.system.status.karmaenergy.value-a});case 8:case"end":return e.stop()}}),e,this)}))),function(e){return F.apply(this,arguments)})},{key:"consumeAmmunition",value:(z=S(O().mark((function e(t){var r;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.extra.ammo||t.extra.ammoDecreased){e.next=9;break}if(t.extra.ammoDecreased=!0,!t.extra.ammo._id){e.next=7;break}return r={_id:t.extra.ammo._id},"mag"==t.extra.ammo.system.ammunitiongroup.value?t.extra.ammo.system.mag.value<=0?(t.extra.ammo.system.quantity.value--,r["system.quantity.value"]=t.extra.ammo.system.quantity.value,r["system.mag.value"]=t.extra.ammo.system.mag.max-1):r["system.mag.value"]=t.extra.ammo.system.mag.value-1:(t.extra.ammo.system.quantity.value--,r["system.quantity.value"]=t.extra.ammo.system.quantity.value),e.next=7,this.updateEmbeddedDocuments("Item",[r,{_id:t.source._id,"system.reloadTime.progress":0}]);case 7:case 13:e.next=18;break;case 9:if("rangeweapon"!=t.source.type&&("trait"!=t.source.type||"rangeAttack"!=t.source.system.traitType.value)||t.extra.ammoDecreased){e.next=15;break}return t.extra.ammoDecreased=!0,e.next=13,this.updateEmbeddedDocuments("Item",[{_id:t.source._id,"system.reloadTime.progress":0}]);case 15:if(!["spell","liturgy"].includes(t.source.type)||"emptyActor"==t.extra.speaker.token){e.next=18;break}return e.next=18,this.updateEmbeddedDocuments("Item",[{_id:t.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}]);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return z.apply(this,arguments)})},{key:"basicTest",value:(R=S(O().mark((function e(t){var r,n,a,s,c,u,l,f=arguments;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.testData,n=t.cardOptions,a=f.length>1&&void 0!==f[1]?f[1]:{},e.next=4,o.Z.rollDices(r,n);case 4:return r=e.sent,e.next=7,o.Z.rollTest(r);case 7:return s=e.sent,r.extra.options.other&&(s.other||(s.other=[]),(c=s.other).push.apply(c,w(r.extra.options.other))),s.postFunction="basicTest",game.user.targets.size&&(n.isOpposedTest=r.opposable,u=" - ".concat(game.i18n.localize("Opposed")),n.isOpposedTest&&n.title.match(u+"$")!=u&&(n.title+=u)),e.next=13,this.consumeAmmunition(r);case 13:return e.next=15,this.payMiracles(r);case 15:if(a.suppressMessage){e.next=22;break}return e.next=18,o.Z.renderRollCard(n,s,a.rerenderMessage);case 18:return l=e.sent,e.next=21,i.Z.handleOpposedTarget(l);case 21:s.messageId=l.id;case 22:return e.abrupt("return",{result:s,cardOptions:n,options:a});case 23:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"addCondition",value:(C=S(O().mark((function e(t){var r,n,a,o=arguments;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:1,n=o.length>2&&void 0!==o[2]&&o[2],a=!(o.length>3&&void 0!==o[3])||o[3],"bleeding"!=t){e.next=7;break}return e.next=6,d.Z.bleedingMessage(this);case 6:case 9:return e.abrupt("return",e.sent);case 7:return e.next=9,l.Z.addCondition(this,t,r,n,a);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"_dependentEffects",value:(D=S(O().mark((function e(t,r,a){var o;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(4!=duplicate(r).flags.dsa5.value){e.next=24;break}if(!["encumbered","stunned","feared","inpain","confused","trance"].includes(t)){e.next=7;break}return e.next=5,this.addCondition("incapacitated");case 5:e.next=24;break;case 7:if("paralysed"!=t){e.next=12;break}return e.next=10,this.addCondition("rooted");case 10:e.next=24;break;case 12:if("drunken"!=t){e.next=19;break}return e.next=15,this.addCondition("stunned");case 15:return e.next=17,this.removeCondition("drunken");case 17:e.next=24;break;case 19:if("exhaustion"!=t){e.next=24;break}return e.next=22,this.addCondition("stunned");case 22:return e.next=24,this.removeCondition("exhaustion");case 24:if("dead"!=t||!game.combat){e.next=27;break}return e.next=27,this.markDead(!0);case 27:if("unconscious"!=t){e.next=30;break}return e.next=30,this.addCondition("prone");case 30:if(!(a>0&&"inpain"==t&&!this.hasCondition("bloodrush")&&c.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.frenzy")))){e.next=35;break}return e.next=33,this.addCondition("bloodrush");case 33:o=n.Z.replaceConditions("".concat(game.i18n.format("CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+this.name+"</b>"}))),ChatMessage.create(n.Z.chatDataSetup(o));case 35:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return D.apply(this,arguments)})},{key:"removeCondition",value:(T=S(O().mark((function e(t){var r,n,a,o=arguments;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:1,n=!(o.length>2&&void 0!==o[2])||o[2],a=o.length>3&&void 0!==o[3]&&o[3],e.next=5,l.Z.removeCondition(this,t,r,n,a);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"hasCondition",value:function(e){return l.Z.hasCondition(this,e)}},{key:"markDead",value:(E=S(O().mark((function e(t){var r,n,a,o;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.getActiveTokens(),n=L(r),e.prev=2,n.s();case 4:if((a=n.n()).done){e.next=11;break}if(!(o=a.value).combatant){e.next=9;break}return e.next=9,o.combatant.update({defeated:t});case 9:e.next=4;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),n.e(e.t0);case 16:return e.prev=16,n.f(),e.finish(16);case 19:case"end":return e.stop()}}),e,this,[[2,13,16,19]])}))),function(e){return E.apply(this,arguments)})}],g=[{key:"create",value:(k=S(O().mark((function e(t,r){var a,o,i,s;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t instanceof Array)){e.next=4;break}return e.next=3,j(N(se),"create",this).call(this,t,r);case 3:return e.abrupt("return",e.sent);case 4:if(!t.items){e.next=8;break}return e.next=7,j(N(se),"create",this).call(this,t,r);case 7:return e.abrupt("return",e.sent);case 8:return t.items=[],t.img&&"icons/svg/mystery-man.svg"!=t.img||(t.img="icons/svg/mystery-man-black.svg"),e.next=12,n.Z.allSkills();case 12:if(e.t0=e.sent,e.t0){e.next=15;break}e.t0=[];case 15:return o=e.t0,e.next=18,n.Z.allCombatSkills();case 18:if(e.t1=e.sent,e.t1){e.next=21;break}e.t1=[];case 21:return i=e.t1,e.next=24,n.Z.allMoneyItems();case 24:if(e.t2=e.sent,e.t2){e.next=27;break}e.t2=[];case 27:return s=e.t2,(a=t.items).push.apply(a,w(o).concat(w(i),w(s))),"character"!=t.type&&(t.system={status:{fatePoints:{current:0,value:0}}}),"creature"!=t.type&&[void 0,0].includes(getProperty(t,"system.status.wounds.value"))&&mergeObject(t,{system:{status:{wounds:{value:16}}}}),e.next=33,j(N(se),"create",this).call(this,t,r);case 33:return e.abrupt("return",e.sent);case 34:case"end":return e.stop()}}),e,this)}))),function(e,t){return k.apply(this,arguments)})},{key:"lockedCondition",value:function(){return{label:game.i18n.localize("MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{core:{statusId:"locked"},dsa5:{value:null,editable:!0,noEffect:!0,hidePlayers:!0,description:game.i18n.localize("MERCHANT.locked"),custom:!0}}}}},{key:"canAdvance",value:function(e){return e.canAdvance}},{key:"armorValue",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.items.filter((function(e){return"armor"==e.type&&1==e.system.worn.value}));t.origin&&(r=r.map((function(r){var n=mergeObject(duplicate(t),{armor:r});return y.Z.applyRollTransformation(e,n,4).options.armor})));var n=r.reduce((function(e,t){return e+m.Z.armorWearModifier(t,t.system.protection.value)}),0),a=e.items.filter((function(e){return"trait"==e.type&&"armor"==e.system.traitType.value})).reduce((function(e,t){return e+Number(t.system.at.value)}),0);return{wornArmor:r,armor:n+a+(e.system.totalArmor||0)}}},{key:"_calculateCombatSkillValues",value:function(e,t){if("melee"==e.system.weapontype.value){var r=e.system.guidevalue.value.split("/").map((function(e){return Number(t.characteristics[e].initial)+Number(t.characteristics[e].modifier)+Number(t.characteristics[e].advances)+Number(t.characteristics[e].gearmodifier)})),a=Math.max.apply(Math,w(r));e.system.parry.value=Math.ceil(e.system.talentValue.value/2)+Math.max(0,Math.floor((a-8)/3))+Number(game.settings.get("dsa5","higherDefense"));var o=t.characteristics.mu.initial+t.characteristics.mu.modifier+t.characteristics.mu.advances+t.characteristics.mu.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((o-8)/3))}else{e.system.parry.value=0;var i=t.characteristics.ff.initial+t.characteristics.ff.modifier+t.characteristics.ff.advances+t.characteristics.ff.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((i-8)/3))}return e.cost=game.i18n.format("advancementCost",{cost:n.Z._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e.canAdvance=se.canAdvance(t),e}},{key:"_parseModifiers",value:function(e,t){var r=[];return e.find('[name="situationalModifiers"] option:selected').each((function(){var e=$(this).val(),t={name:$(this).text().trim().split("[")[0],value:isNaN(e)?e:Number(e),type:$(this).attr("data-type")};"dmg"==t.type&&(t.damageBonus=t.value,t.value=0),$(this).attr("data-specAbId")&&(t.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(t.armorPen=$(this).attr("data-armorPen")),r.push(t)})),r.push({name:game.i18n.localize("manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),r}},{key:"_prepareConsumable",value:function(e){return e.system.maxCharges&&(e.consumable=!0,e.structureMax=e.system.maxCharges,e.structureCurrent=e.system.charges),e}},{key:"prepareMag",value:function(e){return"mag"==e.system.ammunitiongroup.value&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}},{key:"_prepareitemStructure",value:function(e){e.system.structure&&0!=e.system.structure.max&&(e.structureMax=e.system.structure.max,e.structureCurrent=e.system.structure.value);var t=getProperty(e,"flags.dsa5.enchantments");return t&&t.length>0?e.enchantClass="rar":(e.system.effect&&""!=e.system.effect.value||e.effects.length>0)&&(e.enchantClass="common"),e}},{key:"_prepareMeleetrait",value:function(e){return e.attack=Number(e.system.at.value),0!=e.system.pa&&(e.parry=e.system.pa),this._parseDmg(e)}},{key:"_prepareMeleeWeapon",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=t.find((function(t){return t.name==e.system.combatskill.value}));if(a){e.attack=Number(a.system.attack.value)+Number(e.system.atmod.value);var o=e.system.guidevalue.value.split("/").map((function(e){return r.system.characteristics[e]?Number(r.system.characteristics[e].initial)+Number(r.system.characteristics[e].modifier)+Number(r.system.characteristics[e].advances)+Number(r.system.characteristics[e].gearmodifier):0})),i=Math.ceil(a.system.talentValue.value/2)+Math.max(0,Math.floor((Math.max.apply(Math,w(o))-8)/3))+Number(game.settings.get("dsa5","higherDefense"));e.parry=i+Number(e.system.pamod.value)+(e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Shields")?Number(e.system.pamod.value):0),e.yieldedTwoHand=d.Z.isYieldedTwohanded(e),e.yieldedTwoHand||(n||(n=duplicate(r.items).filter((function(t){return"meleeweapon"==t.type&&t.system.worn.value&&t._id!=e._id&&!d.Z.isYieldedTwohanded(t)}))),n.length>0&&(e.parry+=Math.max.apply(Math,w(n.map((function(e){return e.system.pamod.offhandMod})))),e.attack+=Math.max.apply(Math,w(n.map((function(e){return e.system.atmod.offhandMod}))))));var s=0;if(e.system.worn.wrongGrip)if(e.yieldedTwoHand)e.parry-=1,s=1;else{e.system.reach.value="medium";var c=game.i18n.localize("LocalizedCTs.".concat(e.system.combatskill.value));switch(c){case"Two-Handed Impact Weapons":case"Two-Handed Swords":e.parry-=3;var u=new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex"));if(u.test(e.name))s=-2;else{var l=game.i18n.localize("wrongGrip.oneHanded");e.gripDamageText=" (".concat(l," * 0.5)"),e.dmgMultipliers=[{name:l,val:"0.5"}]}break;default:e.parry-=1,s=-1}}if("-"!=(e=this._parseDmg(e)).system.guidevalue.value){var f=Math.max.apply(Math,w(e.system.guidevalue.value.split("/").map((function(e){return Number(r.system.characteristics[e].value)})))),p=f-Number(e.system.damageThreshold.value)+s;p>0&&(e.extraDamage=p,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(p)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}m.Z.weaponWearModifier(e),e.damageToolTip=m.Z.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return e}},{key:"_prepareRangeTrait",value:function(e){return e.attack=Number(e.system.at.value),e.LZ=Number(e.system.reloadTime.value),e.LZ>0&&se.buildReloadProgress(e),this._parseDmg(e)}},{key:"calcLZ",value:function(e,t){var r=1,n=0;e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Throwing Weapons")?n=-1*u.Z.abilityStep(t,game.i18n.localize("LocalizedIDs.quickdraw")):e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Crossbows")&&u.Z.hasAbility(t,"".concat(game.i18n.localize("LocalizedIDs.quickload")," (").concat(game.i18n.localize("LocalizedIDs.Crossbows"),")"))?r=.5:n=-1*u.Z.abilityStep(t,"".concat(game.i18n.localize("LocalizedIDs.quickload")," (").concat(game.i18n.localize(e.system.combatskill.value),")"));var a="".concat(e.system.reloadTime.value).split("/");if("mag"==e.system.ammunitiongroup.value){var o=t.items.find((function(t){return t.id==e.system.currentAmmo.value||t._id==e.system.currentAmmo.value})),i=0;o&&(o=o.toObject()).system.mag.value<=0&&(i=1),a=a[i]||a[0]}else a=a[0];return Math.max(0,Math.round(Number(a)*r)+n)}},{key:"_parseDmg",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=new Roll(e.system.damage.value.replace(/[Ww]/g,"d"),{async:!1}),a="",o="",i="+",s=L(n.terms);try{for(s.s();!(t=s.n()).done;){var c=t.value;c.faces?a=c.number+"d"+c.faces:c.operator?i=c.operator:c.number&&(o+=Number("".concat(i).concat(c.number)))}}catch(e){s.e(e)}finally{s.f()}if(r){var u=getProperty(r,"system.damageMod");Number(u)?o+="+".concat(Number(u)):u&&(e.damageBonusDescription=", ".concat(u," ").concat(game.i18n.localize("CHARAbbrev.damage")," ").concat(r.name))}return o&&(o=Roll.safeEval(o)),e.damagedie=a||"0d6",e.damageAdd=""!=o?(Number(o)>=0?"+":"")+o:"",e}},{key:"buildReloadProgress",value:function(e){var t=e.system.reloadTime.progress/e.LZ;e.title=game.i18n.format("WEAPON.loading",{status:"".concat(e.system.reloadTime.progress,"/").concat(e.LZ)}),e.progress="".concat(e.system.reloadTime.progress,"/").concat(e.LZ),t>=1&&(e.title=game.i18n.localize("WEAPON.loaded")),this.progressTransformation(e,t)}},{key:"progressTransformation",value:function(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft="".concat(Math.round(360*t-179),"deg")):(e.transformRight="".concat(Math.round(360*t+1),"deg"),e.transformLeft=0)}},{key:"buildSpellChargeProgress",value:function(e){if(e.LZ=Number(e.system.castingTime.modified)||0,e.LZ>1){var t=e.system.castingTime.progress/e.LZ;e.title=game.i18n.format("SPELL.loading",{status:"".concat(e.system.castingTime.progress,"/").concat(e.LZ)}),e.progress="".concat(e.system.castingTime.progress,"/").concat(e.LZ),this.progressTransformation(e,t)}return e}},{key:"_prepareRangeWeapon",value:function(e,t,r,n){var a,o=r.find((function(t){return t.name==e.system.combatskill.value}));if(e.calculatedRange=e.system.reach.value,o){if(e.attack=Number(o.system.attack.value),"-"!=e.system.ammunitiongroup.value&&(t||(t=actorData.inventory.ammunition.items),e.ammo=t.filter((function(t){return t.system.ammunitiongroup.value==e.system.ammunitiongroup.value})),a=t.find((function(t){return t._id==e.system.currentAmmo.value})))){var i=Number(a.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map((function(e){return Math.round(Number(e)*i)})).join("/"),e.attack+=Number(a.system.atmod)||0,"mag"==a.system.ammunitiongroup.value&&(e.ammoMax=a.system.mag.max,e.ammoCurrent=a.system.mag.value)}e.LZ=se.calcLZ(e,n),e.LZ>0&&se.buildReloadProgress(e),m.Z.weaponWearModifier(e),e.damageToolTip=m.Z.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return this._parseDmg(e,a)}}],r&&A(t.prototype,r),g&&A(t,g),Object.defineProperty(t,"prototype",{writable:!1}),se}()},416:(e,t,r)=>{r.d(t,{Z:()=>b,x:()=>g});var n=r(565);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(){o=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,i,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,i)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,s,c){var u=f(e[o],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==a(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return o=o?o.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,i,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function i(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function s(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function s(e){i(o,n,a,s,c,"next",e)}function c(e){i(o,n,a,s,c,"throw",e)}s(void 0)}))}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function f(){return f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=p(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},f.apply(this,arguments)}function p(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=v(e)););return e}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}function h(e,t){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},h(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=v(e);if(t){var a=v(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return y(this,r)}}function y(e,t){if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}var g=function(e){d(i,Dialog);var t,r,a=m(i);function i(){return c(this,i),a.apply(this,arguments)}return l(i,[{key:"activateListeners",value:function(e){var t=this;f(v(i.prototype),"activateListeners",this).call(this,e);var r=e.find(".combatant");r.click((function(e){return t.setTargets(e)})),r.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),r.mousedown((function(e){return t._onRightClick(e)}))}},{key:"_onCombatantHoverOut",value:function(e){this._getCombatApp()._onCombatantHoverOut(e)}},{key:"_onCombatantHoverIn",value:function(e){this._getCombatApp()._onCombatantHoverIn(e)}},{key:"_onRightClick",value:function(e){if(2==e.button){var t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}},{key:"_getCombatApp",value:function(){return game.combats.apps[0]}},{key:"setTargets",value:(r=s(o().mark((function e(t){var r,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(r=t.originalEvent.shiftKey)||$(t.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(t.currentTarget).addClass("selectedTarget"),n=t.currentTarget.dataset.combatantId,game.combat.combatants.get(n).token.object.setTarget(!0,{user:game.user,releaseOthers:!r,groupSelection:!0});case 6:case"end":return e.stop()}}),e)}))),function(e){return r.apply(this,arguments)})}],[{key:"getDialog",value:(t=s(o().mark((function e(t){var r,a,s;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Array.from(game.user.targets).map((function(e){return e.id})),a=[],s=canvas.scene?canvas.scene.tokens.get(t.token).object:void 0,game.combat&&game.combat.combatants.forEach((function(e){if(e.visible){if(e.isSelected=r.includes(e.token.id),s&&e.token){var t=canvas.scene.tokens.get(e.token.id).object;e.distance=n.Z.rangeFinder(s,t),e.distance.distanceSum=Number(e.distance.distanceSum.toFixed(1))}a.push(e)}})),e.t0=i,e.t1=game.i18n.localize("DIALOG.addTarget"),e.next=8,renderTemplate("systems/dsa5/templates/dialog/addTarget-dialog.html",{selectables:a});case 8:return e.t2=e.sent,e.t3={},e.t4={title:e.t1,content:e.t2,default:"yes",buttons:e.t3},e.abrupt("return",new e.t0(e.t4));case 12:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),i}(),b=function(e){d(n,Dialog);var t,r=m(n);function n(){return c(this,n),r.apply(this,arguments)}return l(n,[{key:"activateListeners",value:function(e){var t=this;f(v(n.prototype),"activateListeners",this).call(this,e),e.find(".combatant").click((function(e){return t.setTargetToUser(e)}))}},{key:"setTargetToUser",value:function(e){var t=Array.from(game.user.targets).map((function(e){return e.id})),r=e.currentTarget.dataset.userId;game.users.get(r).updateTokenTargets(t),game.socket.emit("userActivity",r,{targets:t}),this.close()}}],[{key:"defaultOptions",get:function(){var e=f(v(n),"defaultOptions",this);return mergeObject(e,{classes:e.classes.concat(["dsa5Decent"])}),e}},{key:"getDialog",value:(t=s(o().mark((function e(){var t;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=game.users.filter((function(e){return e.active&&!e.isGM})),e.t0=n,e.t1=game.i18n.localize("DIALOG.setTargetToUser"),e.next=5,renderTemplate("systems/dsa5/templates/dialog/selectForUserDialog.html",{users:t});case 5:return e.t2=e.sent,e.t3={},e.t4={title:e.t1,content:e.t2,default:"yes",buttons:e.t3},e.abrupt("return",new e.t0(e.t4));case 9:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"registerButtons",value:function(){Hooks.on("getSceneControlButtons",(function(e){if(game.user.isGM){var t,r={name:"targetUser",title:game.i18n.localize("CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:(t=s(o().mark((function e(){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.getDialog();case 2:e.sent.render(!0);case 3:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})};e[0].tools.splice(2,0,r)}}))}}]),n}()},70:(e,t,r)=>{r.d(t,{Z:()=>L});var n=r(369),a=r(839),o=r(272),i=r(577),s=r(562),c=r(122),u=r(173),l=r(491),f=r(15),p=r(5);function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function h(e){return function(e){if(Array.isArray(e))return b(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||g(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(){m=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function h(){}var y={};s(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=h.prototype=f.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==d(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return p.prototype=h,s(b,"constructor",h),s(h,"constructor",p),p.displayName=s(h,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),s(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),s(b,i,"Generator"),s(b,a,(function(){return this})),s(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function y(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function v(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){y(o,n,a,i,s,"next",e)}function s(e){y(o,n,a,i,s,"throw",e)}i(void 0)}))}}function g(e,t){if(e){if("string"==typeof e)return b(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?b(e,t):void 0}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function x(){return x="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=_(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},x.apply(this,arguments)}function _(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}function O(e,t){return O=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},O(e,t)}function E(e,t){if(t&&("object"===d(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}var L=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&O(e,t)}(T,e);var t,r,d,y,b,_,L=(b=T,_=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=S(b);if(_){var r=S(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return E(this,e)});function T(){return w(this,T),L.apply(this,arguments)}return t=T,r=[{key:"activateListeners",value:function(e){var t=this;x(S(T.prototype),"activateListeners",this).call(this,e);var r=e.find(".specAbs");r.mouseenter((function(e){if(0==e.currentTarget.getElementsByClassName("hovermenu").length){var r=document.createElement("div");r.classList.add("hovermenu");var n=document.createElement("i");n.classList.add("fas","fa-comment"),n.title=game.i18n.localize("SHEET.PostItem"),n.addEventListener("mousedown",t._postItem,!1),r.appendChild(n),e.currentTarget.appendChild(r)}})),r.mouseleave((function(e){var r=e.toElement||e.relatedTarget;r.parentNode!=t&&r!=t&&e.currentTarget.querySelectorAll(".hovermenu").forEach((function(e){return e.remove()}))})),e.on("mousedown",".specAbs",(function(r){if(e.find(".opportunityAttack").is(":checked"))ui.notifications.error(game.i18n.localize("DSAError.opposedAttackNoSpecAbs"));else{var n=$(r.currentTarget),a=Number(n.attr("data-step")),o=Number(n.attr("data-maxStep")),i=Number(n.attr("data-category"));if(0==r.button){if(a=Math.min(o,a+1),[0,1].includes(i)&&game.settings.get("dsa5","limitCombatSpecAbs")){var s=n.siblings('[data-category="'.concat(i,'"]'));s.removeClass("active").attr("data-step",0),s.find(".step").text(p.Z.roman[0])}}else 2==r.button&&(a=Math.clamped(o,0,a-1));n.attr("data-step",a),a>0?n.addClass("active"):n.removeClass("active"),n.find(".step").text(p.Z.roman[a]),t.calculateModifier()}})),e.find(".opportunityAttack").change((function(t){if($(t.currentTarget).is(":checked")){var r,n=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=g(e))){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}(e.find(".specAbs"));try{for(n.s();!(r=n.n()).done;){var a=r.value;$(a).removeClass("active").attr("data-step",0).find(".step").text("")}}catch(e){n.e(e)}finally{n.f()}}})),e.on("change","input,select",(function(e){return t.calculateModifier(e)})),e.find(".modifiers option").mousedown((function(e){t.calculateModifier(e)})),e.find(".quantity-click").mousedown((function(e){return t.calculateModifier(e)}));var n=this.readTargets();this.calculateModifier();var a=this;this.checkTargets=setInterval((function(){n=a.compareTargets(e,n)}),500)}},{key:"close",value:(y=v(m().mark((function e(){var t,r=arguments;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},clearInterval(this.checkTargets),e.next=4,x(S(T.prototype),"close",this).call(this,t);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"_postItem",value:function(e){e.stopPropagation();var t=$(e.currentTarget).closest(".specAbs"),r=t.attr("data-actor"),n=t.attr("data-id");return game.actors.get(r).items.get(n).postItem(),!1}},{key:"recallSettings",value:function(e,t,r){return x(S(T.prototype),"recallSettings",this).call(this,e,t,r),this.prepareWeapon(),this}},{key:"prepareWeapon",value:function(){var e,t=this.dialogData.source,r=l.Z.getSpeaker(this.dialogData.speaker);if(r)if(["meleeweapon","rangeweapon"].includes(t.type)){var a=t.system.combatskill.value,o=n.Z._calculateCombatSkillValues(r.items.find((function(e){return"combatskill"==e.type&&e.name==a})).toObject(),r.system);switch(t.type){case"meleeweapon":e=n.Z._prepareMeleeWeapon(t,[o],r);break;case"rangeweapon":e=n.Z._prepareRangeWeapon(t,[],[o],r)}"attack"==this.dialogData.mode?this.dialogData.rollValue=e.attack:"parry"==this.dialogData.mode&&(this.dialogData.rollValue=e.parry)}else"dodge"==t.type?this.dialogData.rollValue=t.system.value:"attack"==this.dialogData.mode?this.dialogData.rollValue=Number(t.system.at.value):"parry"==this.dialogData.mode&&(this.dialogData.rollValue=Number(t.system.pa))}},{key:"prepareFormRecall",value:function(e){if(x(S(T.prototype),"prepareFormRecall",this).call(this,e),canvas.scene&&game.settings.get("dsa5","sightAutomationEnabled")){for(var t=canvas.scene.system.darkness,r=game.settings.get("dsa5","sightOptions").split("|").map((function(e){return Number(e)})),n=0;r[n]<=t;)n+=1;var a=l.Z.getSpeaker(this.dialogData.speaker);if(a){var i=o.Z.vantageStep(a,game.i18n.localize("LocalizedIDs.darksight"))+u.Z.abilityStep(a,game.i18n.localize("LocalizedIDs.sappeurStyle")),s=u.Z.abilityStep(a,game.i18n.localize("LocalizedIDs.blindFighting"));n<4&&n>0&&(i>1?n=0:(n=Math.max(0,n-i),u.Z.hasAbility(a,game.i18n.localize("LocalizedIDs.traditionBoron"))&&(n=Math.max(0,n-1)),n=Math.min(4,n+o.Z.vantageStep(a,game.i18n.localize("LocalizedIDs.nightBlind"))))),n=Math.max(0,n-s)}var c=e.find('[name="vision"] option:nth-child('.concat(n+1,")"));c.length&&(c[0].selected=!0)}}},{key:"calculateModifier",value:function(){if("damage"!=this.dialogData.mode){var e=this.dialogData.source,t="trait"==e.type&&getProperty(e,"system.traitType.value")||"meleeweapon"==e.type,r={source:this.dialogData.source,extra:{options:{}}},n=l.Z.getSpeaker(this.dialogData.speaker);t?T.resolveMeleeDialog(r,{},this.element,n,{},-3,this.dialogData.mode):T.resolveRangeDialog(r,{},this.element,n,{},this.dialogData.mode),this.dialogData.modifier=s.Z._situationalModifiers(r),this.updateRollButton(this.readTargets())}}}],d=[{key:"defaultOptions",get:function(){var e=x(S(T),"defaultOptions",this);return mergeObject(e,{width:700,resizable:!0}),e}},{key:"assassinationModifiers",value:function(e,t){var r=t.assassinate;if(!r||"-"==r)return[];e.opposingWeaponSize=0;var n=t.advantageousPosition?2:0,a=["short","medium","long"].indexOf(t.weaponsize),o=game.i18n.localize("DIALOG.".concat(r)),i=[{name:o,value:10-n-a}];if("assassinate"==r){var s=["short","medium","long"].indexOf(e.source.system.reach.value);!c.Z.isYieldedTwohanded(e.source)&&e.source.system.worn.wrongGrip&&(s=Math.min(s,1));var u=Math.max(1,new Roll(e.source.system.damage.value.replace(/[DWw]/g,"d")).terms.reduce((function(e,t){return e+(t.faces?t.number:0)}),0))-1,l=[2,0,-2,-4][s]-2*u,f=Math.max(1,5-s-u);i.push({name:o+" ("+game.i18n.localize("CHARAbbrev.damage")+")",damageBonus:l,value:0,step:1},{name:o+" (*)",damageBonus:"*".concat(f),value:0,step:1})}else e.source.effects||(e.source.effects=[]),e.source.effects.push({_id:o,changes:[],disabled:!1,duration:{},icon:"icons/svg/aura.svg",label:o,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:o,custom:!0,auto:null,manual:0,resistRoll:"".concat(game.i18n.localize("LocalizedIDs.selfControl")," -3"),hideOnToken:!1,hidePlayers:!1,customDuration:"",advancedFunction:"1",args0:"unconscious",args1:""}}});return i}},{key:"resolveMeleeDialog",value:function(e,t,r,n,o,i,s){var c;this._resolveDefault(e,t,r,o);var l=new FormDataExtended(r.find("form")[0]).object;e.opposingWeaponSize=l.weaponsize,e.narrowSpace=l.narrowSpace,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,l),(c=e.situationalModifiers).push.apply(c,[a.Z.parseValueType(game.i18n.localize("sight"),l.vision||0),{name:game.i18n.localize("attackFromBehind"),value:l.attackFromBehind?-4:0},{name:game.i18n.localize("MODS.damage"),damageBonus:l.damageModifier,value:0,step:1},{name:game.i18n.format("defenseCount",{malus:i}),value:(Number(l.defenseCount)||0)*i},{name:game.i18n.localize("wrongHand"),value:l.wrongHand?-4:0},{name:game.i18n.localize("advantageousPosition"),value:l.advantageousPosition?2:0}].concat(h(a.Z.getSpecAbModifiers(r,s)),h(this.assassinationModifiers(e,l)))),"attack"==s&&e.situationalModifiers.push({name:game.i18n.localize("doubleAttack"),value:l.doubleAttack?-2+u.Z.abilityStep(n,game.i18n.localize("LocalizedIDs.twoWeaponCombat")):0})}},{key:"resolveRangeDialog",value:function(e,t,r,n,o){var s;this._resolveDefault(e,t,r,o);var c=new FormDataExtended(r.find("form")[0]).object;e.rangeModifier=c.distance,(s=e.situationalModifiers).push.apply(s,[{name:game.i18n.localize("target")+" "+r.find('[name="targetMovement"] option:selected').text(),value:Number(c.targetMovement)||0},{name:game.i18n.localize("shooter")+" "+r.find('[name="shooterMovement"] option:selected').text(),value:Number(c.shooterMovement)||0},{name:game.i18n.localize("mount")+" "+r.find('[name="mountedOptions"] option:selected').text(),value:Number(c.mountedOptions)||0},{name:game.i18n.localize("rangeMovementOptions.QUICKCHANGE"),value:c.quickChange?-4:0},{name:game.i18n.localize("MODS.combatTurmoil"),value:c.combatTurmoil?-2:0},{name:game.i18n.localize("aim"),value:Number(c.aim)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:c.damageModifier,value:0,step:1},{name:game.i18n.localize("sight"),value:Number(c.vision||0)}].concat(h(a.Z.getSpecAbModifiers(r,"attack")),[{name:game.i18n.localize("sizeCategory"),value:i.Z.rangeSizeModifier[c.size]}]))}},{key:"_resolveDefault",value:function(e,t,r,a){t.rollMode=r.find('[name="rollMode"]').val(),e.situationalModifiers=n.Z._parseModifiers(r),mergeObject(e.extra.options,a)}},{key:"attackOfOpportunity",value:function(e,t){var r=t.opportunityAttack?-4:0;if(r){e.push({name:game.i18n.localize("opportunityAttack"),value:r});var n=game.i18n.localize("LocalizedIDs.enemySense");game.user.targets.forEach((function(t){t.actor&&t.actor.items.find((function(e){return"specialability"==e.type&&e.name==n}))&&e.push({name:n,value:r})}))}return 0!=r}},{key:"getRollButtons",value:function(e,t,r,a){var o,i=f.Z.getRollButtons(e,t,r,a);if("rangeweapon"==e.source.type||"trait"==e.source.type&&"rangeAttack"==e.source.system.traitType.value){var s="trait"==e.source.type?Number(e.source.system.reloadTime.value):n.Z.calcLZ(e.source,e.extra.actor),c=e.source.system.reloadTime.progress;c<s&&mergeObject(i,{reloadButton:{label:"".concat(game.i18n.localize("WEAPON.reload")," (").concat(c,"/").concat(s,")"),callback:(o=v(m().mark((function t(){var r,n;return m().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.Z.getSpeaker(e.extra.speaker);case 2:return r=t.sent,t.next=5,r.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":c+1}]);case 5:return n=game.i18n.format("WEAPON.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:"".concat(c+1,"/").concat(s)}),t.next=8,ChatMessage.create(l.Z.chatDataSetup(n));case 8:case"end":return t.stop()}}),t)}))),function(){return o.apply(this,arguments)})}})}return i}}],r&&k(t.prototype,r),d&&k(t,d),Object.defineProperty(t,"prototype",{writable:!1}),T}(p.Z)},15:(e,t,r)=>{r.d(t,{Z:()=>Z});var n=r(70),a=r(5),o=r(491),i=r(577),s=r(369),c=r(562);function u(e){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u(e)}function l(e){throw new TypeError('"'+e+'" is read-only')}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=h(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},d.apply(this,arguments)}function h(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=v(e)););return e}function m(e,t){return m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},m(e,t)}function y(e,t){if(t&&("object"===u(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}(g,e);var t,r,n,a,u,h=(a=g,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=v(a);if(u){var r=v(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return y(this,e)});function g(){return f(this,g),h.apply(this,arguments)}return t=g,n=[{key:"getRollButtons",value:function(e,t,r,n){var a=Z.getRollButtons(e,t,r,n);a.rollButton.label=game.i18n.localize("Opposed");var o={nonOpposedButton:{label:game.i18n.localize("Roll"),callback:function(n){game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),e.opposable=!1,r(t.callback(n))}},routineRoll:{label:game.i18n.localize("ROLL.routine"),callback:function(n){game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),e.routine=!0,mergeObject(e.extra.options,{cheat:!0,predefinedResult:[{val:2,index:0},{val:2,index:1},{val:2,index:2}]}),r(t.callback(n))}}};return mergeObject(o,a),o}},{key:"defaultOptions",get:function(){var e=d(v(g),"defaultOptions",this);return mergeObject(e,{width:700,resizable:!0}),e}}],(r=[{key:"activateListeners",value:function(e){var t=this;d(v(g.prototype),"activateListeners",this).call(this,e),e.on("change","input,select",(function(e){return t.rememberFormData(e)}));var r=this.readTargets(),n=this;this.checkTargets=setInterval((function(){r=n.compareTargets(e,r)}),500),this.rememberFormData(),e.on("mousedown",".quantity-click",(function(e){return t.rememberFormData(e)})),e.find(".modifiers option").mousedown((function(e){t.rememberFormData(e)}))}},{key:"rememberFormData",value:function(e){var t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=s.Z._parseModifiers(this._element),this.calculateRoutine(t)}},{key:"calculateRoutine",value:function(e){var t=o.Z.getSpeaker(this.dialogData.speaker),r=this.element.find(".routineRoll");if(!t)return r.prop("disabled",!0);for(var n=0;n<3;n++)if(t.system.characteristics[e["characteristics".concat(n)]].max*e["ch".concat(n)].max<13){l("routineAllowed");break}var a=this.dialogData.source.system.talentValue.value+e.fw+c.Z._situationalModifiers(e,"FW"),s=i.Z.skillDifficultyModifiers[e.testDifficulty]+c.Z._situationalModifiers(e),u=a>=Math.clamped(10-3*s,1,19),f=game.i18n.localize("ROLL.routine");r.prop("disabled",!u),r.html(u?"".concat(f," (").concat(game.i18n.localize("CHARAbbrev.FW")," ").concat(Math.round(a/2),")"):f)}}])&&p(t.prototype,r),n&&p(t,n),Object.defineProperty(t,"prototype",{writable:!1}),g}(a.Z);function b(e){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},b(e)}function w(){w=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(S([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==b(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(k.prototype),s(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function k(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function x(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function O(){return O="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=E(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},O.apply(this,arguments)}function E(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=T(e)););return e}function S(e,t){return S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},S(e,t)}function L(e,t){if(t&&("object"===b(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function T(e){return T=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},T(e)}var D,P,A,j=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&S(e,t)}(c,e);var t,r,n,a,i,s=(a=c,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=T(a);if(i){var r=T(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return L(this,e)});function c(){return x(this,c),s.apply(this,arguments)}return t=c,n=[{key:"defaultOptions",get:function(){var e=O(T(c),"defaultOptions",this);return mergeObject(e,{width:700,resizable:!0}),e}},{key:"getRollButtons",value:function(e,t,r,n){var a,i,s=Z.getRollButtons(e,t,r,n);if(["spell","liturgy"].includes(e.source.type)){var c=Number(e.source.system.castingTime.value),u=e.source.system.castingTime.progress,l=e.source.system.castingTime.modified;if(c&&"emptyActor"!=e.extra.speaker.token){var f=l>0?" (".concat(u,"/").concat(l,")"):"";mergeObject(s,{reloadButton:{label:"".concat(game.i18n.localize("SPELL.reload")).concat(f),callback:(a=w().mark((function t(r){var n,a,i;return w().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.Z.getSpeaker(e.extra.speaker);case 2:return n=t.sent,a={_id:e.source._id,"system.castingTime.progress":u+1},0==l&&(l=Number(r.find(".castingTime").text())-1,a["system.castingTime.modified"]=l),t.next=7,n.updateEmbeddedDocuments("Item",[a]);case 7:return i=game.i18n.format("SPELL.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:"".concat(u+1,"/").concat(l)}),t.next=10,ChatMessage.create(o.Z.chatDataSetup(i));case 10:case"end":return t.stop()}}),t)})),i=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){k(o,r,n,i,s,"next",e)}function s(e){k(o,r,n,i,s,"throw",e)}i(void 0)}))},function(e){return i.apply(this,arguments)})}})}}return s}}],(r=[{key:"prepareFormRecall",value:function(e){O(T(c.prototype),"prepareFormRecall",this).call(this,e),e.find(".spellModifier").trigger("change")}},{key:"activateListeners",value:function(e){O(T(c.prototype),"activateListeners",this).call(this,e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown((function(e){$(e.currentTarget).toggleClass("active")})),e.find(".variableBaseCost").change((function(e){var t=$(e.currentTarget).parents(".skill-test"),r=t.find(".aspcost").attr("data-base"),n=$(e.currentTarget).val();t.find(".aspcost").attr("data-base",n),t.find(".aspcost").text(Number(t.find(".aspcost").text())*n/r)})),e.find(".spellModifier").change((function(t){var r=$(t.currentTarget).parents(".skill-test"),n=r.find(".castingTime"),a=r.find(".aspcost"),o=r.find(".reach"),i=r.find(".maintainCost"),s=r.find(".ritual").length>0,u=r.find(".maxMods");if(r.find(".spellModifier:checked").length>Number(u.text()))return t.currentTarget.checked=!1,u.addClass("emphasize"),void setTimeout((function(){u.removeClass("emphasize")}),600);var l=a.attr("data-base"),f=o.attr("data-base"),p=n.attr("data-base"),d=l,h=i.attr("data-base"),m=0;r.find(".spellModifier[data-cost]:checked").each((function(e,t){if(d*=t.value<0?.5:2,""!=h&&null!=h){var r=String(h).split(" ");r[0]=Number(r[0])*(t.value<0?.5:2),h=r.join(" ")}m+=Number(t.value)})),d<1?t.currentTarget.checked=!1:(a.text(d),i.text(h),a.attr("data-mod",m)),m=0,d=p,r.find(".spellModifier[data-castingTime]:checked").each((function(e,t){if(s){var r=c.bigTimes.indexOf(Number(d));if(null!=r){var n=r+(t.value>0?1:-1);n<c.bigTimes.length&&n>=0?d=c.bigTimes[n]:ui.notifications.error(game.i18n.localize("DSAError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("DSAError.TimeCannotBeParsed"))}else d*=t.value>0?2:.5;m+=Number(t.value)})),d<1?t.currentTarget.checked=!1:(n.text(d),n.attr("data-mod",m)),m=0;var y=game.i18n.localize("ReverseSpellRanges."+f);o.text(f),r.find(".spellModifier[data-reach]:checked").each((function(e,r){if("self"==y)r.checked=!1;else if("touch"==y)o.text("4 "+game.i18n.localize("step")),m+=Number(r.value);else{var n=f.split(" ");y=Number(n[0]),isNaN(y)?(t.currentTarget.checked=!1,ui.notifications.error(game.i18n.localize("DSAError.RangeCannotBeParsed"))):(o.text(2*y+" "+game.i18n.localize("step")),m+=Number(r.value))}})),o.attr("data-mod",m),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}));var t=this.readTargets();0==t.length&&this.setRollButtonWarning();var r=this;this.checkTargets=setInterval((function(){t=r.compareTargets(e,t)}),500)}}])&&_(t.prototype,r),n&&_(t,n),Object.defineProperty(t,"prototype",{writable:!1}),c}(a.Z);function C(e){return C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},C(e)}function I(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function N(){return N="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=R(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},N.apply(this,arguments)}function R(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=G(e)););return e}function z(e,t){return z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},z(e,t)}function F(e,t){if(t&&("object"===C(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function G(e){return G=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},G(e)}A=[5,30,120,480,960,1920],(P="bigTimes")in(D=j)?Object.defineProperty(D,P,{value:A,enumerable:!0,configurable:!0,writable:!0}):D[P]=A;var Z=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&z(e,t)}(c,e);var t,r,a,o,i,s=(o=c,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=G(o);if(i){var r=G(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return F(this,e)});function c(){return I(this,c),s.apply(this,arguments)}return t=c,a=[{key:"getDialogForItem",value:function(e){switch(e){case"rangeweapon":case"meleeweapon":case"dodge":case"trait":return n.Z;case"spell":case"ritual":case"liturgy":case"ceremony":return j;case"skill":return g}return c}},{key:"getRollButtons",value:function(e,t,r,n){var a={rollButton:{label:game.i18n.localize("Roll"),callback:function(n){game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),r(t.callback(n))}}};return game.user.isGM&&mergeObject(a,{cheat:{label:game.i18n.localize("DIALOG.cheat"),callback:function(n){game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,n),r(t.callback(n,{cheat:!0}))}}}),a}},{key:"defaultOptions",get:function(){var e=N(G(c),"defaultOptions",this);return mergeObject(e,{resizable:!0}),e}}],(r=[{key:"activateListeners",value:function(e){N(G(c.prototype),"activateListeners",this).call(this,e),e.find(".dieButton").click((function(e){var t=$(e.currentTarget);"true"==t.attr("data-single")&&t.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),t.toggleClass("dieSelected")}))}}])&&M(t.prototype,r),a&&M(t,a),Object.defineProperty(t,"prototype",{writable:!1}),c}(a.Z)},266:(e,t,r)=>{r.d(t,{Z:()=>m});var n=r(702);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(){o=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,i,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,i)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,s,c){var u=f(e[o],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==a(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return o=o?o.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,i,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function i(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function s(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function s(e){i(o,n,a,s,c,"next",e)}function c(e){i(o,n,a,s,c,"throw",e)}s(void 0)}))}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(){return l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=f(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},l.apply(this,arguments)}function f(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}function p(e,t){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},p(e,t)}function d(e,t){if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}(g,Dialog);var t,r,a,i,f,m,y,v=(m=g,y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=h(m);if(y){var r=h(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return d(this,e)});function g(){return c(this,g),v.apply(this,arguments)}return t=g,r=[{key:"activateListeners",value:function(e){var t=this;l(h(g.prototype),"activateListeners",this).call(this,e),e.find(".reactClick").click((function(e){t.callbackResult(e),t.close()}))}},{key:"callbackResult",value:function(e){n.Z.breakingTest(this.items.find((function(t){return t.id==e.currentTarget.dataset.value})))}}],a=[{key:"showDialog",value:(f=s(o().mark((function e(t){var r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.t1=game.i18n.localize("WEAR.checkShort"),e.next=4,this.getTemplate(t);case 4:e.t2=e.sent,e.t3={},e.t4={title:e.t1,content:e.t2,buttons:e.t3},(r=new e.t0(e.t4)).items=t,r.render(!0);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"getTemplate",value:(i=s(o().mark((function e(t){var r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map((function(e){return{name:e.name,id:e.id,img:e.img}})),e.next=3,renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{items:r,title:"WEAR.checkShort"});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)})}],r&&u(t.prototype,r),a&&u(t,a),Object.defineProperty(t,"prototype",{writable:!1}),g}()},118:(e,t,r)=>{r.d(t,{$G:()=>E,HS:()=>S,MN:()=>L,ZP:()=>O});var n=r(369),a=r(600),o=r(491);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function s(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function u(){u=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};c(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,s,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==i(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,c(b,"constructor",m),c(m,"constructor",h),h.displayName=c(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,c(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),c(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),c(b,s,"Generator"),c(b,a,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function l(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function f(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){l(o,n,a,i,s,"next",e)}function s(e){l(o,n,a,i,s,"throw",e)}i(void 0)}))}}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function m(){return m="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=y(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},m.apply(this,arguments)}function y(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=x(e)););return e}function v(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&g(e,t)}function g(e,t){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},g(e,t)}function b(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=x(e);if(t){var a=x(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return w(this,r)}}function w(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return k(e)}function k(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e){return x=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},x(e)}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var O=function(e){v(a,Dialog);var t,r,n=b(a);function a(){var e;p(this,a);for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return _(k(e=n.call.apply(n,[this].concat(r))),"t",void 0),e}return h(a,null,[{key:"showDialog",value:(r=f(u().mark((function e(t){var r;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.callbackResult,e.t0=a,e.t1=game.i18n.localize("Unopposed"),e.next=5,this.getTemplate(t);case 5:e.t2=e.sent,e.t3={ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:function(e){r(e.find('[name="entryselection"]').val(),t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},e.t4={title:e.t1,content:e.t2,default:"ok",buttons:e.t3},new e.t0(e.t4).render(!0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getTargetActor",value:function(e){if(!canvas.tokens)return{};var t=e.flags.unopposeData.targetSpeaker,r=canvas.tokens.get(t.token).actor;return r?{actor:r,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}},{key:"getTemplate",value:(t=f(u().mark((function e(t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return","");case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"callbackResult",value:function(e,t,r){}},{key:"defaultOptions",get:function(){var e=m(x(a),"defaultOptions",this);return mergeObject(e,{resizable:!0}),e}}]),a}(),E=function(e){v(n,e);var t,r=b(n);function n(){return p(this,n),r.apply(this,arguments)}return h(n,null,[{key:"getTemplate",value:(t=f(u().mark((function e(t){var r,n,a,i;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=game.messages.get(t.flags.unopposeData.attackMessageId),n=r.flags.data.preData.source,a=n.name,e.next=5,o.Z.allSkillsList();case 5:return(i=e.sent.map((function(e){return{name:e,id:e}}))).unshift({name:game.i18n.localize("doNothing"),id:"doNothing"}),e.abrupt("return",renderTemplate("systems/dsa5/templates/dialog/dialog-act.html",{items:i,original:a,title:"DIALOG.selectReaction"}));case 8:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"callbackResult",value:function(e,t){var r=O.getTargetActor(t),n=r.actor,o=r.tokenId;if("doNothing"==e)a.Z.resolveUndefended(t);else{var i=n.items.find((function(t){return t.name==e&&"skill"==t.type}));i&&n.setupSkill(i,{},o).then((function(e){n.basicTest(e)}))}}}]),n}(O),S=function(e){v(o,Dialog);var t,r,a=b(o);function o(){return p(this,o),a.apply(this,arguments)}return h(o,[{key:"activateListeners",value:function(e){var t=this;m(x(o.prototype),"activateListeners",this).call(this,e),e.find(".reactClick").click((function(e){t.callbackResult(e.currentTarget.dataset.value,t.actor,t.tokenId),t.close()}))}},{key:"callbackResult",value:function(e,t,r){if("attackWeaponless"==e)t.setupWeaponless("attack",{},r).then((function(e){t.basicTest(e)}));else{var n=["meleeweapon","trait","rangeweapon"],a=t.items.find((function(t){return n.includes(t.type)&&t.name==e}));a&&t.setupWeapon(a,"attack",{},r).then((function(e){t.basicTest(e)}))}}}],[{key:"showDialog",value:(r=f(u().mark((function e(t,r){var n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o,e.t1=game.i18n.localize("attacktest"),e.next=4,this.getTemplate(t);case 4:e.t2=e.sent,e.t3={},e.t4={title:e.t1,content:e.t2,buttons:e.t3},(n=new e.t0(e.t4)).actor=t,n.tokenId=r,n.render(!0);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getTemplate",value:(t=f(u().mark((function e(t){var r,a,o,i,c,l,f,p,d;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.items.filter((function(e){return"combatskill"==e.type})).map((function(e){return n.Z._calculateCombatSkillValues(e.toObject(),t.system)})),a=r.find((function(e){return e.name==game.i18n.localize("LocalizedIDs.wrestle")})),o=[{name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:a.system.attack.value}],i=["meleeweapon","rangeweapon"],c=["meleeAttack","rangeAttack"],l=s(t.items);try{for(l.s();!(f=l.n()).done;)p=f.value,i.includes(p.type)&&1==p.system.worn.value?(d="meleeweapon"==p.type?n.Z._prepareMeleeWeapon(p.toObject(),r,t):n.Z._prepareRangeWeapon(p.toObject(),[],r,t),o.push({name:p.name,id:p.name,img:p.img,value:d.attack})):"trait"==p.type&&c.includes(p.system.traitType.value)&&o.push({name:p.name,id:p.name,img:p.img,value:p.system.at.value})}catch(e){l.e(e)}finally{l.f()}return e.next=9,renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:o,title:"DIALOG.selectAction"});case 9:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"defaultOptions",get:function(){var e=m(x(o),"defaultOptions",this);return mergeObject(e,{width:550}),e}}]),o}(),L=function(e){v(i,e);var t,r,o=b(i);function i(){return p(this,i),o.apply(this,arguments)}return h(i,[{key:"activateListeners",value:function(e){var t=this;m(x(i.prototype),"activateListeners",this).call(this,e),e.find(".reactClick").click((function(e){t.callbackResult(e.currentTarget.dataset.value,t.startMessage),t.close()}))}},{key:"callbackResult",value:function(e,t){var r=O.getTargetActor(t),n=r.actor,o=r.tokenId;if("doNothing"==e)a.Z.resolveUndefended(t);else if("dodge"==e)n.setupDodge({},o).then((function(e){n.basicTest(e)}));else if("parryWeaponless"==e)n.setupWeaponless("parry",{},o).then((function(e){n.basicTest(e)}));else{var i=["meleeweapon","trait"],s=n.items.find((function(t){return i.includes(t.type)&&t.name==e}));s&&n.setupWeapon(s,"parry",{},o).then((function(e){n.basicTest(e)}))}}}],[{key:"showDialog",value:(r=f(u().mark((function e(t){var r;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.t1=game.i18n.localize("Unopposed"),e.next=4,this.getTemplate(t);case 4:e.t2=e.sent,e.t3={},e.t4={title:e.t1,content:e.t2,buttons:e.t3},(r=new e.t0(e.t4)).startMessage=t,r.render(!0);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"defaultOptions",get:function(){var e=m(x(i),"defaultOptions",this);return mergeObject(e,{width:550}),e}},{key:"getTemplate",value:(t=f(u().mark((function e(t){var r,a,o,i,c,l,f,p,d,h,m,y;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=O.getTargetActor(t),a=r.actor,o=r.tokenId,i=a.items.filter((function(e){return"combatskill"==e.type})).map((function(e){return n.Z._calculateCombatSkillValues(e.toObject(),a.system)})),c=i.find((function(e){return e.name==game.i18n.localize("LocalizedIDs.wrestle")})),l=[{name:game.i18n.localize("doNothing"),id:"doNothing",img:"systems/dsa5/icons/categories/disease.webp"},{name:game.i18n.localize("dodge"),id:"dodge",img:"systems/dsa5/icons/categories/Dodge.webp",value:a.system.status.dodge.max},{name:game.i18n.localize("parryWeaponless"),id:"parryWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:c.system.parry.value}],f=0,!a){e.next=13;break}p=["meleeweapon"],d=s(a.items);try{for(d.s();!(h=d.n()).done;)m=h.value,p.includes(m.type)&&1==m.system.worn.value?(y=n.Z._prepareMeleeWeapon(m.toObject(),i,a),l.push({name:m.name,id:m.name,img:m.img,value:y.parry})):"trait"==m.type&&Number(m.system.pa)>0&&l.push({name:m.name,id:m.name,img:m.img,value:m.system.pa})}catch(e){d.e(e)}finally{d.f()}if(!game.combat){e.next=13;break}return e.next=12,game.combat.getDefenseCount({actor:a.id,token:o,scene:canvas.scene?canvas.scene.id:null});case 12:f=e.sent;case 13:return e.next=15,renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-in",items:l,defenses:f,title:"DIALOG.selectReaction"});case 15:return e.abrupt("return",e.sent);case 16:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),i}(O)},5:(e,t,r)=>{r.d(t,{Z:()=>k});var n=r(122),a=r(416);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw o}}}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(){c=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,i,s,c){var u=f(e[a],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==o(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,i,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,s,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function u(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){u(o,n,a,i,s,"next",e)}function s(e){u(o,n,a,i,s,"throw",e)}i(void 0)}))}}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=h(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},d.apply(this,arguments)}function h(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=v(e)););return e}function m(e,t){return m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},m(e,t)}function y(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}var g,b,w,k=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}(k,Dialog);var t,r,o,s,u,h,g,b,w=(g=k,b=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=v(g);if(b){var r=v(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return y(this,e)});function k(){return f(this,k),w.apply(this,arguments)}return t=k,r=[{key:"recallSettings",value:function(e,t,r){return this.recallData=game.dsa5.memory.recall(e,t,r),this.dialogData={mode:r,speaker:e,source:t},this}},{key:"_render",value:(h=l(c().mark((function e(t,r){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d(v(k.prototype),"_render",this).call(this,t,r);case 2:this.prepareFormRecall($(this._element));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"setRollButtonWarning",value:function(){if("attack"==this.dialogData.mode){var e=game.i18n.localize("DIALOG.noTarget");return'<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> '.concat(e,"</span>")}return""}},{key:"setMultipleTargetsWarning",value:function(){if("attack"==this.dialogData.mode){var e=game.i18n.localize("DIALOG.multipleTarget");return'<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> '.concat(e,"</span>")}return""}},{key:"renderRollValueDie",value:function(){if(this.dialogData.rollValue&&"damage"!=this.dialogData.mode){var e="attack"==this.dialogData.mode?"die-mu":"die-in",t=this.dialogData.modifier||0;return'<span class="rollValue '.concat(e,' d20">').concat(this.dialogData.rollValue+t,"</span>")}return""}},{key:"updateRollButton",value:(u=l(c().mark((function e(t){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.renderRollValueDie()+game.i18n.localize("Roll"),t.length>0?t.length>1&&(r+=this.setMultipleTargetsWarning()):r+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(r);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"updateTargets",value:(s=l(c().mark((function e(t,r){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/templates/dialog/parts/targets.html",{targets:r});case 2:n=e.sent,t.find(".targets").html(n),this.updateRollButton(r);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"removeTarget",value:function(e){var t=e.currentTarget.dataset.id;$(e.currentTarget).remove();var r=[];game.user.targets.forEach((function(e){t!=e.id&&r.push(e.id)})),game.user.updateTokenTargets(r)}},{key:"readTargets",value:function(){var e=[];return game.user.targets.forEach((function(t){t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})})),e}},{key:"compareTargets",value:function(e,t){var r=this.readTargets();return JSON.stringify(t)!=JSON.stringify(r)&&(t=r,this.updateTargets(e,t)),t}},{key:"activateListeners",value:function(e){var t=this;d(v(k.prototype),"activateListeners",this).call(this,e),e.find(".quantity-click").mousedown((function(e){var t=e.currentTarget.dataset.quantityfocus,r=$(e.currentTarget);if(!t||r.is(":focus")){var a={val:Number(r.val())};n.Z.increment(e,a,"val"),r.val(a.val)}else setTimeout((function(){r.select()}))})),e.find(".modifiers option").mousedown((function(e){return e.preventDefault(),$(e.currentTarget).prop("selected",!$(e.currentTarget).prop("selected")),!1})),e.on("click",".rollTarget",(function(e){return t.removeTarget(e)})),e.on("click",".addTarget",(function(e){return t.addTarget(e)}))}},{key:"addTarget",value:(o=l(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.x.getDialog(this.dialogData.speaker);case 2:e.sent.render(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"prepareFormRecall",value:function(e){var t=this;if(this.recallData)for(var r in this.recallData)if("specAbs"==r){var n,a=i(this.recallData[r]);try{for(a.s();!(n=a.n()).done;){var o=n.value,s=e.find('.specAbs[data-id="'.concat(o.id,'"]'));s.addClass("active").attr("data-step",o.step),s.find(".step").text(k.roman[o.step])}}catch(e){a.e(e)}finally{a.f()}}else{var c=e.find('[name="'.concat(r,'"]'));if(Array.isArray(this.recallData[r])){var u,l=i(c.find("option"));try{var f=function(){var e=u.value,n=t.recallData[r].find((function(t){return t.name==$(e).text().trim()}));n&&(e.selected=n.selected)};for(l.s();!(u=l.n()).done;)f()}catch(e){l.e(e)}finally{l.f()}}else"checkbox"==c.attr("type")?c[0].checked=this.recallData[r]:c.val(this.recallData[r])}}}],r&&p(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),k}();w=[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"],(b="roman")in(g=k)?Object.defineProperty(g,b,{value:w,enumerable:!0,configurable:!0,writable:!0}):g[b]=w},839:(e,t,r)=>{r.d(t,{Z:()=>R});var n=r(491),a=r(562),o=r(369),i=r(973),s=r(272),c=r(577),u=r(794),l=r(61),f=r(122),p=r(472),d=r(565),h=r(70),m=r(173);function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach((function(t){N(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function b(e){return function(e){if(Array.isArray(e))return x(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||k(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=k(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function k(e,t){if(e){if("string"==typeof e)return x(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?x(e,t):void 0}}function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _(){_=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=k(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,v=m&&m(m(S([])));v&&v!==t&&r.call(v,a)&&(h=v);var g=d.prototype=f.prototype=Object.create(h);function b(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==y(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function k(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return p.prototype=d,s(g,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},b(w.prototype),s(w.prototype,o,(function(){return this})),e.AsyncIterator=w,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new w(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(g),s(g,i,"Generator"),s(g,a,(function(){return this})),s(g,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function O(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function E(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){O(o,n,a,i,s,"next",e)}function s(e){O(o,n,a,i,s,"throw",e)}i(void 0)}))}}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function L(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function T(e,t,r){return t&&L(e.prototype,t),r&&L(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function D(){return D="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=P(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},D.apply(this,arguments)}function P(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=M(e)););return e}function A(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&j(e,t)}function j(e,t){return j=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},j(e,t)}function C(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=M(e);if(t){var a=M(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return I(this,r)}}function I(e,t){if(t&&("object"===y(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function M(e){return M=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},M(e)}function N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var R=function(e){A(x,Item);var t,r,o,u,l,f,h,y,v,k=C(x);function x(){return S(this,x),k.apply(this,arguments)}return T(x,[{key:"addCondition",value:(v=E(_().mark((function e(t){var r,n,a,o=arguments;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:1,n=o.length>2&&void 0!==o[2]&&o[2],a=!(o.length>3&&void 0!==o[3])||o[3],e.next=5,i.Z.addCondition(this,t,r,n,a);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"_dependentEffects",value:(y=E(_().mark((function e(t,r,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e,t,r){return y.apply(this,arguments)})},{key:"removeCondition",value:(h=E(_().mark((function e(t){var r,n,a,o=arguments;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:1,n=!(o.length>2&&void 0!==o[2])||o[2],a=o.length>3&&void 0!==o[3]&&o[3],e.abrupt("return",i.Z.removeCondition(this,t,r,n,a));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"hasCondition",value:function(e){return i.Z.hasCondition(this,e)}},{key:"setupEffect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;return x.getSubClass(this.type).setupDialog(e,t,this,r)}},{key:"_setupCardOptions",value:function(e,t){var r=ChatMessage.getSpeaker();return{speaker:{alias:r.alias,scene:r.scene},flags:{img:r.token?canvas.tokens.get(r.token).document.img:this.img},title:t,template:e}}},{key:"itemTest",value:(f=E(_().mark((function e(t){var r,n,o,i,s,c=arguments;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.testData,n=t.cardOptions,o=c.length>1&&void 0!==c[1]?c[1]:{},e.next=4,a.Z.rollDices(r,n);case 4:return r=e.sent,e.next=7,a.Z.rollTest(r);case 7:return(i=e.sent).postFunction="itemTest",game.user.targets.size&&(n.isOpposedTest=r.opposable,s=" - ".concat(game.i18n.localize("Opposed")),n.isOpposedTest&&n.title.match(s+"$")!=s&&(n.title+=s)),o.suppressMessage||a.Z.renderRollCard(n,i,o.rerenderMessage),e.abrupt("return",{result:i,cardOptions:n});case 12:case"end":return e.stop()}}),e)}))),function(e){return f.apply(this,arguments)})},{key:"postItem",value:(l=E(_().mark((function e(){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:x.getSubClass(this.type)._postItem(this);case 1:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})}],[{key:"defaultIcon",value:function(e){e.img&&""!=e.img||(e.type in this.defaultImages?e.img=this.defaultImages[e.type]:e.img="systems/dsa5/icons/blank.webp")}},{key:"create",value:(u=E(_().mark((function e(t,r){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.defaultIcon(t),e.next=3,D(M(x),"create",this).call(this,t,r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"getSpecAbModifiers",value:function(e,t){var r,n=[],a=w(e.find(".specAbs"));try{for(a.s();!(r=a.n()).done;){var o=r.value,i=Number($(o).attr("data-step"));if(i>0){var s="attack"==t?$(o).attr("data-atbonus"):$(o).attr("data-pabonus"),c=s.split(",").reduce((function(e,t){return e+Number(t)}),0);n.push({name:$(o).find("a").text(),value:isNaN(c)?Number(s.replace("*","")):Number(c)*i,damageBonus:$(o).attr("data-tpbonus"),dmmalus:$(o).attr("data-dmmalus")*i,step:i,specAbId:$(o).attr("data-id"),type:/^\*/.test(s)?"*":void 0})}}}catch(e){a.e(e)}finally{a.f()}return n}},{key:"setupSubClasses",value:function(){game.dsa5.config.ItemSubclasses={ritual:ie,spell:V,liturgy:K,ceremony:J,advantage:pe,disadvantage:pe,aggregatedTest:B,trait:fe,blessing:Y,magictrick:U,specialability:ce,disease:te,poison:ae,armor:q,rangeweapon:oe,meleeweapon:ne,ammunition:H,equipment:re,combatskill:Q,skill:se,consumable:X,spellextension:le,species:ue,effectwrapper:W,plant:z,magicalsign:F,patron:Z,demonmark:G,information:ee}}},{key:"buildSpeaker",value:function(e,t){return{token:t,actor:e?e.id:void 0,scene:canvas.scene?canvas.scene.id:null}}},{key:"parseValueType",value:function(e,t){var r="";return/^\*/.test(t)&&(r="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:r}}},{key:"getMiracleModifiers",value:function(e,t,r,n){var a=new RegExp("".concat(game.i18n.localize("combatskill")," "),"gi"),o=[];if((getProperty(e,"system.happyTalents.value")||"").split(/;|,/).map((function(e){return e.replace(a,"").trim()})).includes(t.name)){var i=e.system.status.karmaenergy.value,s=getProperty(e,"system.miracle.".concat(n))||0;if(i<4)return[];o.push({name:game.i18n.localize("LocalizedIDs.miracle"),value:2+s,type:r,selected:!1});var c=game.i18n.localize("LocalizedIDs.miracleMight");i>=6&&m.Z.hasAbility(e,c)&&o.push({name:c,value:3+s,type:r,selected:!1})}return o}},{key:"getSkZkModifier",value:function(e,t){var r=[],n=[],a=["spell","liturgy","ceremony","ritual"].includes(t.type)&&""==t.system.effectFormula.value.trim();game.user.targets.size&&game.user.targets.forEach((function(e){if(e.actor){var t=0;a&&(t=p.Z.detectCreatureType(e.actor).reduce((function(t,r){return t+r.spellResistanceModifier(e.actor)}),0)),r.push(-1*e.actor.system.status.soulpower.max-t),n.push(-1*e.actor.system.status.toughness.max-t)}})),mergeObject(e,{SKModifier:r.length>0?Math.min.apply(Math,r):0,ZKModifier:n.length>0?Math.min.apply(Math,n):0})}},{key:"parseEffect",value:function(e,t){var r,n={},a=new RegExp(game.i18n.localize("CHARAbbrev.GS"),"gi"),o=w(e.split(/,|;/).map((function(e){return e.trim()})));try{for(o.s();!(r=o.n()).done;){var i=r.value.replace(/(\s+)/g," ").trim().split(" ");i[0]=i[0].replace(a,t.system.status.speed.max),2==i.length&&(!isNaN(i[0])||/(=)?[+-]\d([+-]\d)?/.test(i[0])||/(=)?\d[dDwW]\d/.test(i[0])||/=\d+/.test(i[0])||/\*\d(\.\d)*/.test(i[0]))&&(null==n[i[1].toLowerCase()]?n[i[1].toLowerCase()]=[i[0]]:n[i[1].toLowerCase()].push(i[0]))}}catch(e){o.e(e)}finally{o.f()}return n}},{key:"getDefenseMalus",value:function(e,t){var r=!1;if(t.flags.oppose){var n=game.messages.get(t.flags.oppose.messageId),a=n.flags.data.preData;r=!("meleeweapon"==getProperty(a,"source.type")||"meleeAttack"==getProperty(a,"source.system.traitType.value"));var o,i=/ \[(-)?\d{1,}\]/,s=w(a.situationalModifiers);try{for(s.s();!(o=s.n()).done;){var c=o.value;null!=c.dmmalus&&0!=c.dmmalus?e.push({name:"".concat(game.i18n.localize("MODS.defenseMalus")," - ").concat(c.name.replace(i,"")),value:c.dmmalus,selected:!0}):"defenseMalus"==c.type&&0!=c.value&&e.push({name:c.name.replace(i,""),value:c.value,selected:!0})}}catch(e){s.e(e)}finally{s.f()}n.flags.data.postData.halfDefense&&e.push({name:"".concat(game.i18n.localize("MODS.defenseMalus")," - ").concat(game.i18n.localize("halfDefenseShort")),value:.5,type:"*",selected:!0})}return r}},{key:"changeChars",value:function(e,t,r,n){e.system.characteristic1.value=t,e.system.characteristic2.value=r,e.system.characteristic3.value=n}},{key:"buildCombatSpecAbs",value:function(e,t,r,n){var a;r?(r.push(game.i18n.localize("LocalizedIDs.all")),r=r.map((function(e){return e.toLowerCase()})),a=function(e,t){return e.system.list.value.split(/;|,/).map((function(e){return e.trim().toLowerCase()})).filter((function(e){return t.includes(e.replace(/ \([a-zA-Z ]*\)/,""))})).length>0}):a=function(){return!0};var o=e.items.filter((function(e){return"specialability"==e.type&&t.includes(e.system.category.value)&&""!=e.system.effect.value&&a(e,r)})),i=[],s=game.i18n.localize("LocalizedAbilityModifiers.at"),u=game.i18n.localize("LocalizedAbilityModifiers.tp"),l=game.i18n.localize("LocalizedAbilityModifiers.pa"),f=game.i18n.localize("LocalizedAbilityModifiers.dm");if("attack"==n){var p,d=w(o);try{for(d.s();!(p=d.n()).done;){var h=p.value,m=x.parseEffect(h.system.effect.value,e),y=m[s]||0,v=m[u]||0,g=m[f]||0;if(0!=y||0!=v||0!=g||h.data.effects.size>0){var b=game.i18n.localize(c.Z.combatSkillSubCategories[h.system.category.sub]);i.push({name:h.name,atbonus:y,tpbonus:v,dmmalus:g,label:"".concat(s,": ").concat(y,", ").concat(u,": ").concat(v,", ").concat(f,": ").concat(g),steps:h.system.step.value,category:{id:h.system.category.sub,css:"ab_".concat(h.system.category.sub),name:b},id:h.id,actor:e.id})}}}catch(e){d.e(e)}finally{d.f()}}else{var k,_=w(o);try{for(_.s();!(k=_.n()).done;){var O=k.value,E=x.parseEffect(O.system.effect.value,e)[l]||0;if(0!=E){var S=game.i18n.localize(c.Z.combatSkillSubCategories[O.system.category.sub]);i.push({name:O.name,pabonus:E,tpbonus:0,dmmalus:0,label:"".concat(l,": ").concat(E),steps:O.system.step.value,category:{id:O.system.category.sub,css:"ab_".concat(O.system.category.sub),name:S},id:O.id,actor:e.id})}}}catch(e){_.e(e)}finally{_.f()}}return i}},{key:"getCombatSkillModifier",value:function(e,t,r){if("trait"!=t.type){var n,a=e.items.find((function(e){return"combatskill"==e.type&&e.name==t.system.combatskill.value})),o=w(a.effects);try{for(o.s();!(n=o.n()).done;){var i,s=w(n.value.changes);try{for(s.s();!(i=s.n()).done;){var c=i.value;switch(c.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":r.push({name:"".concat(a.name," - ").concat(game.i18n.localize("MODS.defenseMalus")),value:-1*c.value,type:"defenseMalus",selected:!0})}}}catch(e){s.e(e)}finally{s.f()}}}catch(e){o.e(e)}finally{o.f()}}}},{key:"attackStatEffect",value:function(e,t){0!=t&&e.push({name:game.i18n.localize("statuseffects"),value:t,selected:!0})}},{key:"prepareRangeAttack",value:function(e,t,r,n,a,o){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:void 0;e.push.apply(e,b(s.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.restrictedSenseSight"),-2))),this.getCombatSkillModifier(t,n,e);var u="average";game.user.targets.size&&game.user.targets.forEach((function(r){if(r.actor){var a=getProperty(r.actor,"system.status.size");a&&(u=a.value),p.Z.addCreatureTypeModifiers(r.actor,n,e,t)}}));var l=-1*Number(t.system.rangeStats.defenseMalus);0!=l&&e.push({name:"".concat(game.i18n.localize("statuseffects")," - ").concat(game.i18n.localize("MODS.defenseMalus")),value:l,type:"defenseMalus",selected:!0});var f=g({},c.Z.rangeWeaponModifiers);delete f[s.Z.hasVantage(t,game.i18n.localize("LocalizedIDs.senseOfRange"))?"long":"rangesense"],m.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.extremeShot"))||delete f.extreme;var h=m.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.drivingArcher")),y=h?duplicate(c.Z.drivingArcherOptions):duplicate(c.Z.mountedRangeOptions);mergeObject(r,{rangeOptions:f,rangeDistance:Object.keys(f)[d.Z.distanceModifier(game.canvas.tokens.get(a),n,i)],sizeOptions:c.Z.rangeSizeCategories,visionOptions:c.Z.rangeVision,mountedOptions:y,shooterMovementOptions:c.Z.shooterMovementOptions,targetMovementOptions:c.Z.targetMomevementOptions,targetSize:u,combatSpecAbs:o,aimOptions:c.Z.aimOptions})}},{key:"prepareMeleeAttack",value:function(e,t,r,n,a,o){var i="short";game.user.targets.size&&game.user.targets.forEach((function(r){if(r.actor){var a=r.actor.items.filter((function(e){return"meleeweapon"==e.type&&e.system.worn.value||"trait"==e.type&&"meleeAttack"==e.system.traitType.value&&e.system.pa}));a.length>0&&(i=a[0].system.reach.value),p.Z.addCreatureTypeModifiers(r.actor,n,e,t)}})),this.getCombatSkillModifier(t,n,e);var s=-1*Number(t.system.meleeStats.defenseMalus);0!=s&&e.push({name:"".concat(game.i18n.localize("statuseffects")," - ").concat(game.i18n.localize("MODS.defenseMalus")),value:s,type:"defenseMalus",selected:!0}),mergeObject(r,{visionOptions:c.Z.meleeRangeVision(r.mode),weaponSizes:c.Z.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:i,combatSpecAbs:a,constricted:t.hasCondition("constricted"),wrongHandDisabled:o,offHand:!o&&getProperty(n,"system.worn.offHand")})}},{key:"prepareMeleeParry",value:function(e,t,r,n,a,o){var i=x.getDefenseMalus(e,t);mergeObject(r,{visionOptions:c.Z.meleeRangeVision(r.mode),showDefense:!0,isRangeDefense:i,wrongHandDisabled:o&&getProperty(n,"system.worn.offHand"),offHand:!o&&getProperty(n,"system.worn.offHand")&&getProperty(n,"system.combatskill.value")!=game.i18n.localize("LocalizedIDs.Shields"),melee:!0,combatSpecAbs:a,constricted:t.hasCondition("constricted")})}},{key:"_chatLineHelper",value:function(e,t){return"<b>".concat(game.i18n.localize(e),"</b>: ").concat(t||"-")}},{key:"setupDialog",value:function(e,t,r,n,a){return null}},{key:"checkEquality",value:function(e,t){return t.type==e.type&&e.name==t.name&&e.system.description.value==t.system.description.value}},{key:"combineItem",value:(o=E(_().mark((function e(t,r,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(t=duplicate(t)).system.quantity.value+=r.system.quantity.value,e.next=4,n.updateEmbeddedDocuments("Item",[t]);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)}))),function(e,t,r){return o.apply(this,arguments)})},{key:"areEquals",value:function(e,t){return e.type==t.type&&x.getSubClass(e.type).checkEquality(e,t)}},{key:"stackItems",value:(r=E(_().mark((function e(t,r,n){return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.getSubClass(t.type).combineItem(t,r,n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"chatData",value:function(e,t){return[]}},{key:"getSubClass",value:function(e){return game.dsa5.config.ItemSubclasses[e]?game.dsa5.config.ItemSubclasses[e]:x}},{key:"_postItem",value:(t=E(_().mark((function e(t){var r,a,o,i,s,c;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=duplicate(t),a=x.getSubClass(t.type).chatData(duplicate(r.system),t.name),r.properties=a,r.hasPrice="price"in r.system,r.hasPrice&&(o=r.system.price.value,r.system.QL&&(o*=r.system.QL),r.system.price.D=Math.floor(o/10),o-=10*r.system.price.D,r.system.price.S=Math.floor(o),o-=r.system.price.S,r.system.price.H=Math.floor(o/.1),o-=.1*r.system.price.H,r.system.price.K=Math.round(o/.01),i=["D","S","H","K"].map((function(e){return"".concat(r.system.price[e],' <div data-tooltip="').concat(game.i18n.localize("Money-".concat(e)),'" class="chatmoney money-').concat(e,'"></div>')})).join(","),a.push("<b>".concat(game.i18n.localize("price"),"</b>: ").concat(i))),t.pack&&(r.itemLink="@Compendium[".concat(t.pack,".").concat(t.id,"]")),r.img.includes("/blank.webp")&&(r.img=null),e.next=9,renderTemplate("systems/dsa5/templates/chat/post-item.html",r);case 9:s=e.sent,c=n.Z.chatDataSetup(s),ChatMessage.create(c);case 12:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),x}();N(R,"defaultImages",{advantage:"systems/dsa5/icons/categories/Vorteil.webp",disadvantage:"systems/dsa5/icons/categories/Nachteil.webp",armor:"systems/dsa5/icons/categories/Armor.webp",meleeweapon:"systems/dsa5/icons/categories/Meleeweapon.webp",rangeweapon:"systems/dsa5/icons/categories/Rangeweapon.webp",equipment:"systems/dsa5/icons/categories/Equipment.webp",consumable:"systems/dsa5/icons/categories/consumable.webp",liturgy:"systems/dsa5/icons/categories/Liturgy.webp",spell:"systems/dsa5/icons/categories/Spell.webp",ammunition:"systems/dsa5/icons/categories/Munition.webp",career:"systems/dsa5/icons/categories/Career.webp",magictrick:"systems/dsa5/icons/categories/Spelltrick.webp",blessing:"systems/dsa5/icons/categories/Blessing.webp",combatskill:"systems/dsa5/icons/categories/Combat_Skill.webp",skill:"systems/dsa5/icons/categories/Skill.webp",Geweihte:"systems/dsa5/icons/categories/Geweihte.webp",Weltliche:"systems/dsa5/icons/categories/Weltliche.webp",Zauberer:"systems/dsa5/icons/categories/Zauberer.webp",ritual:"systems/dsa5/icons/categories/ritual.webp",ceremony:"systems/dsa5/icons/categories/ceremony.webp",abilityclerical:"systems/dsa5/icons/categories/ability_clerical.webp",abilityCombat:"systems/dsa5/icons/categories/ability_combat.webp",abilityfatePoints:"systems/dsa5/icons/categories/ability_fate_points.webp",abilitygeneral:"systems/dsa5/icons/categories/ability_general.webp",specialability:"systems/dsa5/icons/categories/ability_general.webp",abilitymagical:"systems/dsa5/icons/categories/ability_magical.webp",abilitylanguage:"systems/dsa5/icons/categories/Ability_Language.webp",abilitystaff:"systems/dsa5/icons/categories/ability_staff.webp",abilityceremonial:"systems/dsa5/icons/categories/ability_ceremonial.webp",abilityanimal:"systems/dsa5/icons/categories/ability_animal.webp",trait:"systems/dsa5/icons/categories/trait.webp",Tiere:"systems/dsa5/icons/categories/Tiere.webp",aggregatedTest:"systems/dsa5/icons/categories/aggregated_test.webp",poison:"systems/dsa5/icons/categories/poison.webp",disease:"systems/dsa5/icons/categories/disease.webp",spellextension:"systems/dsa5/icons/categories/Spellextension.webp",species:"icons/environment/people/group.webp",application:"systems/dsa5/icons/categories/Skill.webp",trick:"systems/dsa5/icons/categories/Tiere.webp",disadvantageanimal:"systems/dsa5/icons/categories/NachteilAnimal.webp",advantageanimal:"systems/dsa5/icons/categories/VorteilAnimal.webp",diseaseanimal:"systems/dsa5/icons/categories/diseaseAnimal.webp",effectwrapper:"icons/svg/aura.svg",liturgyTalisman:"systems/dsa5/icons/categories/LiturgieTalisman.webp",plant:"systems/dsa5/icons/categories/plant.webp",magicalsign:"systems/dsa5/icons/categories/magicalsign.webp",abilitypact:"systems/dsa5/icons/categories/ability_pact.webp",demonmark:"systems/dsa5/icons/categories/ability_pact.webp",patron:"systems/dsa5/icons/categories/ability_pact.webp",information:"systems/dsa5/icons/categories/DSA-Auge.webp"});var z=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("effect",e.effect),this._chatLineHelper("PLANT.recipes",e.recipes),this._chatLineHelper("PLANT.usages",e.usages)]}}]),r}(R),F=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){var r=[this._chatLineHelper("AsPCost",e.asp)];return 2==e.category&&r.push(this._chatLineHelper("feature",e.feature)),r}}]),r}(R),G=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("attributes",e.attribute),this._chatLineHelper("skills",e.skills),this._chatLineHelper("domains",e.domain)]}}]),r}(R),Z=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("skills",e.talents),this._chatLineHelper("culture",e.culture),this._chatLineHelper("Category",game.i18n.localize("PATRON.".concat(e.category)))]}}]),r}(R),B=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){var r=game.i18n.localize("Ongoing");return e.cummulatedQS.value>=10?r=game.i18n.localize("Success"):e.cummulatedQS.value>=6?r=game.i18n.localize("PartSuccess"):e.allowedTestCount.value-e.usedTestCount.value<=0&&(r=game.i18n.localize("Failure")),[this._chatLineHelper("cummulatedQS","".concat(e.cummulatedQS.value," / 10")),this._chatLineHelper("interval",e.interval.value),this._chatLineHelper("probes","".concat(e.usedTestCount.value," / ").concat(e.allowedTestCount.value)),this._chatLineHelper("result",r)]}}]),r}(R),H=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("ammunitiongroup",game.i18n.localize(e.ammunitiongroup.value))]}}]),r}(R),W=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[]}}]),r}(R),q=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){var r=[this._chatLineHelper("protection",e.protection.value),this._chatLineHelper("encumbrance",e.encumbrance.value)];return""!=e.effect.value&&r.push(this._chatLineHelper("effect",e.effect.value)),r}}]),r}(R),U=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("feature",e.feature.value)]}}]),r}(R),Y=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r)}(U),V=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",n.Z.replaceConditions(n.Z.replaceDies(e.effect.value)))]}},{key:"getCallbackData",value:function(e,t,n){e.testDifficulty=0,e.situationalModifiers=o.Z._parseModifiers(t),e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text(),maintainCost:t.find(".maintainCost").text()},e.situationalModifiers.push({name:game.i18n.localize("removeGesture"),value:t.find('[name="removeGesture"]').is(":checked")?-2:0},{name:game.i18n.localize("removeFormula"),value:t.find('[name="removeFormula"]').is(":checked")?-2:0},{name:game.i18n.localize("castingTime"),value:t.find(".castingTime").data("mod")},{name:game.i18n.localize("cost"),value:t.find(".aspcost").data("mod")},{name:game.i18n.localize("reach"),value:t.find(".reach").data("mod")},{name:game.i18n.localize("zkModifier"),value:t.find('[name="zkModifier"]').val()||0},{name:game.i18n.localize("skModifier"),value:t.find('[name="skModifier"]').val()||0},{name:game.i18n.localize("maintainedSpells"),value:-1*Number(t.find('[name="maintainedSpells"]').val())}),e.extensions=r.getSpecAbModifiers(t).join(", "),e.advancedModifiers={chars:[0,1,2].map((function(e){return Number(t.find('[name="ch'.concat(e,'"]')).val())})),fws:Number(t.find('[name="fw"]').val()),qls:Number(t.find('[name="qs"]').val())},R.changeChars.apply(R,[e.source].concat(b([0,1,2].map((function(e){return t.find('[name="characteristics'.concat(e,'"]')).val()})))))}},{key:"getSpecAbModifiers",value:function(e){var t,r=[],n=w(e.find(".specAbs.active"));try{for(n.s();!(t=n.n()).done;){var a=t.value;r.push('<span data-tooltip="'.concat($(a).attr("title"),'">').concat($(a).attr("data-name"),"</span>"))}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"attackSpellMalus",value:function(e){var t=[];return e.system.effectFormula.value&&t.push({name:game.i18n.localize("MODS.defenseMalus"),value:-4,type:"defenseMalus",selected:!0}),t}},{key:"getPropertyModifiers",value:function(e,t){for(var r=["ceremony","liturgy"].includes(t.type),n=(getProperty(t,"system.feature")||"").replace(/\(a-z \-\)/gi,"").split(",").map((function(e){return e.trim()})),a=[],o=r?"KaPCost":"AsPCost",i=function(){var t=c[s],r="step"==t?"":t,o=getProperty(e.system.skillModifiers,"feature.".concat(t));a.push.apply(a,b(o.filter((function(e){return n.includes(e.target)})).map((function(e){return{name:e.source,value:e.value,type:r}}))))},s=0,c=["FP","step","QL","TPM","FW",o];s<c.length;s++)i();var u=getProperty(e.system.skillModifiers,"conditional.".concat(o));return a.push.apply(a,b(u.map((function(e){return{name:e.target,value:e.value,type:o}})))),a}},{key:"foreignSpellModifier",value:function(e,t,r,n){if(game.settings.get("dsa5","enableForeignSpellModifer")&&["npc","character"].includes(e.type)&&["spell","ritual"].includes(t.type)){var a=t.system.distribution.value.split(",").map((function(e){return e.trim().toLowerCase()})),o=new RegExp("(".concat(game.i18n.localize("tradition"),"|\\)|\\()"),"g"),i=e.system.tradition.magical.replace(o,"").split(",").map((function(e){return e.trim().toLowerCase()}));i.push(game.i18n.localize("general").toLowerCase()),n.isForeign=!a.some((function(e){return i.includes(e)})),n.isForeign&&r.push({name:game.i18n.localize("DSASETTINGS.enableForeignSpellModifer"),value:-2,selected:!0})}}},{key:"getSituationalModifiers",value:function(e,t,r,n){e.push.apply(e,b(u.Z.getTalentBonus(t,n.name,["advantage","disadvantage","specialability","equipment"])).concat(b(s.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalAttunement"),1,!0)),b(s.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalRestriction"),-1,!0)),b(s.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.boundToArtifact"),-1,!0)),b(this.getPropertyModifiers(t,n)),b(this.attackSpellMalus(n)))),this.foreignSpellModifier(t,n,e,r),game.user.targets.size&&game.user.targets.forEach((function(r){r.actor&&p.Z.addCreatureTypeModifiers(r.actor,n,e,t)})),e.push.apply(e,b(t.getSkillModifier(n.name,n.type)));var a,o=w(t.system.skillModifiers.global);try{for(o.s();!(a=o.n()).done;){var i=a.value;e.push({name:i.source,value:i.value})}}catch(e){o.e(e)}finally{o.f()}this.getSkZkModifier(r,n)}},{key:"setupDialog",value:function(e,t,r,n,o){var s=this,c="spell";"ceremony"!=r.type&&"liturgy"!=r.type||(c="liturgy");var u=r.name+" "+game.i18n.localize("".concat(r.type,"Test")),l={opposable:r.system.effectFormula.value.length>0,source:r,extra:{actor:n.toObject(!1),options:t,speaker:R.buildSpeaker(n,o)},advancedModifiers:{chars:[0,0,0],fws:0,qls:0},calculatedSpellModifiers:{castingTime:0,cost:0,reach:0,maintainCost:0}},f={rollMode:t.rollMode,spellCost:r.system.AsPCost.value,maintainCost:r.system.maintainCost.value,spellCastingTime:r.system.castingTime.value,spellReach:r.system.range.value,canChangeCost:"true"==r.system.canChangeCost.value,canChangeRange:"true"==r.system.canChangeRange.value,canChangeCastingTime:"true"==r.system.canChangeCastingTime.value,hasSKModifier:"SK"==r.system.resistanceModifier.value,hasZKModifier:"ZK"==r.system.resistanceModifier.value,maxMods:Math.floor(Number(r.system.talentValue.value)/4),extensions:this.prepareExtensions(n,r),variableBaseCost:"true"==r.system.variableBaseCost,characteristics:[1,2,3].map((function(e){return r.system["characteristic".concat(e)].value}))},p=n?i.Z.getRollModifiers(n,r):[];this.getSituationalModifiers(p,n,f,r),f.situationalModifiers=p;var d={title:u,template:"/systems/dsa5/templates/dialog/".concat(c,"-enhanced-dialog.html"),data:f,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h.rollMode=e.find('[name="rollMode"]').val(),s.getCallbackData(l,e,n),mergeObject(l.extra.options,t),{testData:l,cardOptions:h}}},h=n._setupCardOptions("systems/dsa5/templates/chat/roll/spell-card.html",u);return a.Z.setupDialog({dialogOptions:d,testData:l,cardOptions:h})}},{key:"prepareExtensions",value:function(e,t){return e.items.filter((function(e){return"spellextension"==e.type&&e.system.source==t.name&&e.system.category==t.type})).map((function(e){return e.shortName=e.name.split(" - ").length>1?e.name.split(" - ")[1]:e.name,e.descr=$(e.system.description.value).text(),e}))}}]),r}(R),K=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("KaPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",n.Z.replaceConditions(n.Z.replaceDies(e.effect.value)))]}}]),r}(V),J=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"getCallbackData",value:function(e,t,n){D(M(r),"getCallbackData",this).call(this,e,t,n),e.situationalModifiers.push({name:game.i18n.localize("CEREMONYMODIFIER.artefact"),value:t.find('[name="artefactUsage"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}},{key:"getSituationalModifiers",value:function(e,t,n,a){D(M(r),"getSituationalModifiers",this).call(this,e,t,n,a),mergeObject(n,{isCeremony:!0,locationModifiers:c.Z.ceremonyLocationModifiers,timeModifiers:c.Z.ceremonyTimeModifiers})}}]),r}(K),Q=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("Description",game.i18n.localize("Combatskilldescr.".concat(t)))]}},{key:"setupDialog",value:function(e,t,r,n,i){var s=t.mode,c=game.i18n.localize(r.name)+" "+game.i18n.localize(s+"test"),u={opposable:!0,source:r,mode:s,extra:{actor:n.toObject(!1),options:t,speaker:R.buildSpeaker(n,i)}},l={title:c,template:"systems/dsa5/templates/dialog/combatskill-dialog.html",data:{rollMode:t.rollMode},callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return f.rollMode=e.find('[name="rollMode"]').val(),u.situationalModifiers=o.Z._parseModifiers(e),mergeObject(u.extra.options,t),{testData:u,cardOptions:f}}},f=n._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",c);return a.Z.setupDialog({dialogOptions:l,testData:u,cardOptions:f})}}]),r}(R),X=function(e){A(i,e);var t,r,a,o=C(i);function i(){return S(this,i),o.apply(this,arguments)}return T(i,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("qualityStep",e.QL),this._chatLineHelper("effect",n.Z.replaceDies(e.QLList.split("\n")[e.QL-1])),this._chatLineHelper("charges",e.charges)]}},{key:"checkEquality",value:function(e,t){return t.type==e.type&&e.name==t.name&&e.system.description.value==t.system.description.value&&e.system.QL==t.system.QL}},{key:"setupDialog",value:(a=E(_().mark((function e(t,r,a,o){var i,s,c,u,l;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=game.i18n.format("CHATNOTIFICATION.usesItem",{actor:a.actor.name,item:a.name}),a.isOwned){e.next=3;break}return e.abrupt("return");case 3:if(!((a.system.quantity.value-1)*a.system.maxCharges+a.system.charges<=0)){e.next=7;break}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges")),e.abrupt("return");case 7:if(s=a.system.charges<=1?a.system.maxCharges:a.system.charges-1,c=a.system.charges<=1?a.system.quantity.value-1:a.system.quantity.value,u=n.Z.replaceDies(a.system.QLList.split("\n")[a.system.QL-1],!1),l="<div><b>".concat(i,"</b></div><div>").concat(a.system.description.value,"</div><div><b>").concat(game.i18n.localize("effect"),"</b>: ").concat(u,"</div>"),0!=c){e.next=16;break}return e.next=14,a.actor.deleteEmbeddedDocuments("Item",[a.id]);case 14:e.next=18;break;case 16:return e.next=18,a.update({"system.quantity.value":c,"system.charges":s});case 18:return e.next=20,ChatMessage.create(n.Z.chatDataSetup(l));case 20:return e.next=22,this._applyActiveEffect(a);case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return a.apply(this,arguments)})},{key:"_applyActiveEffect",value:(r=E(_().mark((function e(t){var r,a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((r=t.data.effects.toObject()).length>0)){e.next=10;break}return e.next=4,l.Z.applyAdvancedFunction(t.actor,r,t,{qualityStep:t.system.QL},t.actor);case 4:a=e.sent,o=a.msg,a.resistRolls,i=a.effectNames,s="".concat(game.i18n.format("ActiveEffects.appliedEffect",{target:t.actor.name,source:i.join(", ")})," ").concat(o||""),ChatMessage.create(n.Z.chatDataSetup(s));case 10:case"end":return e.stop()}}),e)}))),function(e){return r.apply(this,arguments)})},{key:"combineItem",value:(t=E(_().mark((function e(t,r,n){var a,o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=duplicate(t),a=(t.system.quantity.value-1)*t.system.maxCharges+t.system.charges,o=(r.system.quantity.value-1)*r.system.maxCharges+r.system.charges,i=Math.floor((a+o)/t.system.maxCharges)+1,0==(s=(a+o)%t.system.maxCharges)&&(i-=1,s=t.system.maxCharges),t.system.quantity.value=i,t.system.charges=s,e.next=10,n.updateEmbeddedDocuments("Item",[t]);case 10:return e.abrupt("return",e.sent);case 11:case"end":return e.stop()}}),e)}))),function(e,r,n){return t.apply(this,arguments)})}]),i}(R),ee=function(e){A(a,e);var t,r=C(a);function a(){return S(this,a),r.apply(this,arguments)}return T(a,null,[{key:"_postItem",value:(t=E(_().mark((function e(t){var r,a;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/templates/chat/informationRequestRoll.html",{item:t});case 2:r=e.sent,a=n.Z.chatDataSetup(r),ChatMessage.create(a);case 5:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),a}(R),te=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("incubation",e.incubation.value),this._chatLineHelper("damage",n.Z.replaceConditions(n.Z.replaceDies(e.damage.value))),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("source",n.Z.replaceDies(e.source.value)),this._chatLineHelper("treatment",e.treatment.value),this._chatLineHelper("antidot",e.antidot.value),this._chatLineHelper("resistanceModifier",e.resistance.value)]}},{key:"getSituationalModifiers",value:function(e,t,r,a){a=n.Z.toObjectIfPossible(a),game.user.targets.size&&game.user.targets.forEach((function(t){t.actor&&e.push.apply(e,b(s.Z.getVantageAsModifier(t.actor,game.i18n.localize("LocalizedIDs.ResistanttoDisease"),-1,!1,!0)))})),this.getSkZkModifier(r,a),mergeObject(r,{hasSKModifier:"SK"==a.system.resistance.value,hasZKModifier:"ZK"==a.system.resistance.value})}},{key:"setupDialog",value:function(e,t,r,n,i){var s=r.name+" "+game.i18n.localize(r.type)+" "+game.i18n.localize("Test"),c={opposable:!1,source:r,extra:{options:t,speaker:R.buildSpeaker(n,i)}},u={rollMode:t.rollMode},l=[];this.getSituationalModifiers(l,n,u,r),u.situationalModifiers=l,t.manualResistance&&mergeObject(u,t.manualResistance);var f={title:s,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:u,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return p.rollMode=e.find('[name="rollMode"]').val(),c.situationalModifiers=o.Z._parseModifiers(e),c.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:e.find('[name="zkModifier"]').val()||0}),c.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:e.find('[name="skModifier"]').val()||0}),mergeObject(c.extra.options,t),{testData:c,cardOptions:p}}},p=r._setupCardOptions("systems/dsa5/templates/chat/roll/".concat(r.type,"-card.html"),s);return a.Z.setupDialog({dialogOptions:f,testData:c,cardOptions:p})}}]),r}(R),re=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("equipmentType",game.i18n.localize("Equipment.".concat(e.equipmentType.value)))]}}]),r}(R),ne=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){var r=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("atmod",e.atmod.value),this._chatLineHelper("pamod",e.pamod.value),this._chatLineHelper("combatskill",e.combatskill.value)];return""!=e.effect.value&&r.push(this._chatLineHelper(n.Z.replaceConditions("effect",e.effect.value))),r}},{key:"getSituationalModifiers",value:function(e,t,a,o){var i=s.Z.hasVantage(t,game.i18n.localize("LocalizedIDs.ambidextrous")),c=[(o=n.Z.toObjectIfPossible(o)).system.combatskill.value],u=R.buildCombatSpecAbs(t,["Combat"],c,a.mode);"attack"==a.mode?this.prepareMeleeAttack(e,t,a,o,u,i):"parry"==a.mode&&this.prepareMeleeParry(e,t,a,o,u,i),this.attackStatEffect(e,Number(t.system.meleeStats[a.mode])),["attack","parry"].includes(a.mode)&&e.push.apply(e,b(r.getMiracleModifiers(t,{name:o.system.combatskill.value},"",a.mode)))}},{key:"setupDialog",value:function(e,t,r,n,o){var s=t.mode,c=game.i18n.localize(r.name)+" "+game.i18n.localize(s+"test"),u={opposable:!0,source:r,mode:s,extra:{actor:n.toObject(!1),options:t,speaker:R.buildSpeaker(n,o)}},l=f.Z.multipleDefenseValue(n,"function"==typeof r.toObject?r.toObject():r),p={rollMode:t.rollMode,mode:s,defenseCountString:game.i18n.format("defenseCount",{malus:l})},d=n?i.Z.getRollModifiers(n,r,{mode:s}):[];this.getSituationalModifiers(d,n,p,r),p.situationalModifiers=d;var m={title:c,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:p,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h.Z.resolveMeleeDialog(u,y,e,n,t,l,s),Hooks.call("callbackDialogCombatDSA5",u,n,e,r,o),u.isRangeDefense=p.isRangeDefense,{testData:u,cardOptions:y}}},y=n._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",c);return a.Z.setupDialog({dialogOptions:m,testData:u,cardOptions:y})}}]),r}(R),ae=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("poisonType",e.poisonType.value),this._chatLineHelper("start",e.start.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("resistanceModifier",e.resistance.value),this._chatLineHelper("effect",n.Z.replaceConditions(n.Z.replaceDies(e.effect.value)))]}},{key:"getSituationalModifiers",value:function(e,t,r,a){a=n.Z.toObjectIfPossible(a),game.user.targets.size&&game.user.targets.forEach((function(t){t.actor&&e.push.apply(e,b(s.Z.getVantageAsModifier(t.actor,game.i18n.localize("LocalizedIDs.poisonResistance"),-1,!1,!0)))})),this.getSkZkModifier(r,a),mergeObject(r,{hasSKModifier:"SK"==a.system.resistance.value,hasZKModifier:"ZK"==a.system.resistance.value})}},{key:"setupDialog",value:function(e,t,r,n,i){var s=r.name+" "+game.i18n.localize(r.type)+" "+game.i18n.localize("Test"),c={opposable:!1,source:r,extra:{options:t,speaker:R.buildSpeaker(n,i)}},u={rollMode:t.rollMode},l=[];this.getSituationalModifiers(l,n,u,r),u.situationalModifiers=l;var f={title:s,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:u,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return p.rollMode=e.find('[name="rollMode"]').val(),c.situationalModifiers=o.Z._parseModifiers(e),c.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:e.find('[name="zkModifier"]').val()||0}),c.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:e.find('[name="skModifier"]').val()||0}),mergeObject(c.extra.options,t),{testData:c,cardOptions:p}}},p=r._setupCardOptions("systems/dsa5/templates/chat/roll/".concat(r.type,"-card.html"),s);return a.Z.setupDialog({dialogOptions:f,testData:c,cardOptions:p})}}]),r}(R),oe=function(e){A(s,e);var t,r,o=C(s);function s(){return S(this,s),o.apply(this,arguments)}return T(s,null,[{key:"chatData",value:function(e,t){var r=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("combatskill",e.combatskill.value),this._chatLineHelper("reach",e.reach.value)];return""!=e.effect.value&&r.push(this._chatLineHelper(n.Z.replaceConditions("effect",e.effect.value))),r}},{key:"getSituationalModifiers",value:function(e,t,r,a,o){if("attack"==r.mode){var i=n.Z.toObjectIfPossible(a),c=[i.system.combatskill.value],u=R.buildCombatSpecAbs(t,["Combat"],c,r.mode),l=t.items.get(i.system.currentAmmo.value);if(l){l=l.toObject(!1),i.system.effect.attributes=(i.system.effect.attributes||"").split(",").concat((l.system.effect.attributes||"").split(",")).filter((function(e){return""!=e})).join(",");var f=getProperty(l.flags,"dsa5.poison");f&&mergeObject(a.flags,{dsa5:{poison:f}})}if(this.prepareRangeAttack(e,t,r,i,o,u,l),l){if(l.system.atmod&&e.push({name:"".concat(l.name," - ").concat(game.i18n.localize("atmod")),value:l.system.atmod,selected:!0,specAbId:i.system.currentAmmo.value}),l.system.damageMod||l.system.armorMod){var p={name:"".concat(l.name," - ").concat(game.i18n.localize("MODS.damage")),value:l.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:i.system.currentAmmo.value};l.system.armorMod&&(p.armorPen=l.system.armorMod),e.push(p)}l.effects.length&&e.push({name:"".concat(l.name," - ").concat(game.i18n.localize("effect")),value:1,type:game.i18n.localize("effect"),selected:!0,specAbId:i.system.currentAmmo.value})}e.push.apply(e,b(s.getMiracleModifiers(t,{name:i.system.combatskill.value},"",r.mode)))}this.attackStatEffect(e,Number(t.system.rangeStats[r.mode]))}},{key:"checkAmmunitionState",value:(r=E(_().mark((function e(t,r,n,a){var o,i,s;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=!0,"creature"!=n.type&&"damage"!=a&&("infinite"==(i=t.system).ammunitiongroup.value||("-"==i.ammunitiongroup.value?(r.extra.ammo=duplicate(t),o=r.extra.ammo.system.quantity.value>0):(s=n.items.get(i.currentAmmo.value))?(r.extra.ammo=s.toObject(),o="mag"==i.ammunitiongroup.value?r.extra.ammo.system.quantity.value>1||r.extra.ammo.system.mag.value>0&&r.extra.ammo.system.quantity.value>0:r.extra.ammo.system.quantity.value>0):o=!1)),o||ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),e.abrupt("return",o);case 4:case"end":return e.stop()}}),e)}))),function(e,t,n,a){return r.apply(this,arguments)})},{key:"setupDialog",value:(t=E(_().mark((function e(t,r,n,o,s){var c,u,l,f,p,d,m;return _().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=r.mode,u=game.i18n.localize(n.name)+" "+game.i18n.localize(c+"test"),l={opposable:!0,source:n,mode:c,extra:{actor:o.toObject(!1),options:r,speaker:R.buildSpeaker(o,s)}},e.next=5,this.checkAmmunitionState(n,l,o,c);case 5:if(e.sent){e.next=7;break}return e.abrupt("return");case 7:return f={rollMode:r.rollMode,mode:c},p=o?i.Z.getRollModifiers(o,n,{mode:c}):[],this.getSituationalModifiers(p,o,f,n,s),f.situationalModifiers=p,d={title:u,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:f,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h.Z.resolveRangeDialog(l,m,e,o,t),Hooks.call("callbackDialogCombatDSA5",l,o,e,n,s),{testData:l,cardOptions:m}}},m=o._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",u),e.abrupt("return",a.Z.setupDialog({dialogOptions:d,testData:l,cardOptions:m}));case 14:case"end":return e.stop()}}),e,this)}))),function(e,r,n,a,o){return t.apply(this,arguments)})}]),s}(R),ie=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"getCallbackData",value:function(e,t,n){D(M(r),"getCallbackData",this).call(this,e,t,n),e.situationalModifiers.push({name:game.i18n.localize("RITUALMODIFIER.rightClothes"),value:t.find('[name="rightClothes"]').is(":checked")?1:0},{name:game.i18n.localize("RITUALMODIFIER.rightEquipment"),value:t.find('[name="rightEquipment"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}},{key:"getSituationalModifiers",value:function(e,t,n,a){D(M(r),"getSituationalModifiers",this).call(this,e,t,n,a),mergeObject(n,{isRitual:!0,locationModifiers:c.Z.ritualLocationModifiers,timeModifiers:c.Z.ritualTimeModifiers})}}]),r}(V),se=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("Description",game.i18n.localize("SKILLdescr.".concat(t)))]}},{key:"getSituationalModifiers",value:function(e,t,n,a){e.push.apply(e,b(u.Z.getTalentBonus(t,a.name,["advantage","disadvantage","specialability","equipment"])).concat(b(t.getSkillModifier(a.name,a.type)),b(r.getMiracleModifiers(t,a,"FW","skill"))));var o,i=w(t.system.skillModifiers.global);try{for(i.s();!(o=i.n()).done;){var s=o.value;e.push({name:s.source,value:s.value})}}catch(e){i.e(e)}finally{i.f()}}},{key:"setupDialog",value:function(e,t,r,n,s){var u,l=r.name+" "+game.i18n.localize("Test")+(t.subtitle||""),f={opposable:!0,source:r,extra:{actor:n.toObject(!1),options:t,speaker:R.buildSpeaker(n,s)}},p={rollMode:t.rollMode,difficultyLabels:c.Z.skillDifficultyLabels,modifier:t.modifier||0,characteristics:[1,2,3].map((function(e){return r.system["characteristic".concat(e)].value})),situationalModifiers:n?i.Z.getRollModifiers(n,r):[]};t.situationalModifiers&&(u=p.situationalModifiers).push.apply(u,b(t.situationalModifiers)),this.getSituationalModifiers(p.situationalModifiers,n,p,r);var d={title:l,template:"/systems/dsa5/templates/dialog/skill-dialog.html",data:p,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h.rollMode=e.find('[name="rollMode"]').val(),f.testDifficulty=c.Z.skillDifficultyModifiers[e.find('[name="testDifficulty"]').val()],f.situationalModifiers=o.Z._parseModifiers(e),f.advancedModifiers={chars:[0,1,2].map((function(t){return Number(e.find('[name="ch'.concat(t,'"]')).val())})),fws:Number(e.find('[name="fw"]').val()),qls:Number(e.find('[name="qs"]').val())},R.changeChars.apply(R,[f.source].concat(b([0,1,2].map((function(t){return e.find('[name="characteristics'.concat(t,'"]')).val()}))))),mergeObject(f.extra.options,t),{testData:f,cardOptions:h}}},h=n._setupCardOptions("systems/dsa5/templates/chat/roll/skill-card.html",l);return a.Z.setupDialog({dialogOptions:d,testData:f,cardOptions:h})}}]),r}(R),ce=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("rule",e.rule.value)]}}]),r}(R),ue=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r)}(R),le=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("source",e.source),this._chatLineHelper("Category",game.i18n.localize(e.category))]}}]),r}(R),fe=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){var r=[];switch(e.traitType.value){case"meleeAttack":r=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value)];break;case"rangeAttack":r=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value),this._chatLineHelper("reloadTime",e.reloadTime.value)];break;case"armor":r=[this._chatLineHelper("protection",e.damage.value)];break;case"general":r=[];break;case"familiar":r=[this._chatLineHelper("APValue",e.APValue.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("aspect",e.aspect.value)];break;case"trick":r=[this._chatLineHelper("APValue",e.APValue.value)];break;case"entity":r=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("CHARAbbrev.QL",e.AsPCost.value)];break;case"summoning":r=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("conjuringDifficulty",e.at.value)]}return""!=e.effect.value&&r.push(this._chatLineHelper("effect",e.effect.value)),r}},{key:"getSituationalModifiers",value:function(e,t,r,a,o){var i=(a=n.Z.toObjectIfPossible(a)).system.traitType.value,s=R.buildCombatSpecAbs(t,["Combat","animal"],void 0,r.mode);"attack"==r.mode&&"meleeAttack"==i?this.prepareMeleeAttack(e,t,r,a,s,!1):"attack"==r.mode&&"rangeAttack"==i?this.prepareRangeAttack(e,t,r,a,o,s):"parry"==r.mode&&this.prepareMeleeParry(e,t,r,a,s,!1),this.attackStatEffect(e,Number(t.system["meleeAttack"==i?"meleeStats":"rangeStats"][r.mode]))}},{key:"setupDialog",value:function(e,t,r,n,o){var s=t.mode,c=game.i18n.localize(r.name)+" "+game.i18n.localize(s+"test"),u={opposable:!0,source:r,mode:s,extra:{actor:n.toObject(!1),options:t,speaker:R.buildSpeaker(n,o)}},l=f.Z.multipleDefenseValue(n,r.toObject()),p={rollMode:t.rollMode,mode:s,defenseCountString:game.i18n.format("defenseCount",{malus:l})},d=getProperty(r,"system.traitType.value")||getProperty(r.data,"system.traitType.value"),m=n?i.Z.getRollModifiers(n,r,{mode:s}):[];this.getSituationalModifiers(m,n,p,r,o),p.situationalModifiers=m;var y={title:c,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:p,callback:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"meleeAttack"==d?h.Z.resolveMeleeDialog(u,v,e,n,t,l,s):h.Z.resolveRangeDialog(u,v,e,n,t),u.isRangeDefense=p.isRangeDefense,Hooks.call("callbackDialogCombatDSA5",u,n,e,r,o),{testData:u,cardOptions:v}}},v=n._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",c);return a.Z.setupDialog({dialogOptions:y,testData:u,cardOptions:v})}}]),r}(R),pe=function(e){A(r,e);var t=C(r);function r(){return S(this,r),t.apply(this,arguments)}return T(r,null,[{key:"chatData",value:function(e,t){return[this._chatLineHelper("effect",e.effect.value)]}}]),r}(R)},61:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DSAActiveEffectConfig});var _system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(577),_system_dice_dsa5_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(562),_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(491);function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _regeneratorRuntime(){_regeneratorRuntime=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==_typeof(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=_superPropBase(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},_get.apply(this,arguments)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var r,n=_getPrototypeOf(e);if(t){var a=_getPrototypeOf(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return _possibleConstructorReturn(this,r)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function asyncGeneratorStep(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){asyncGeneratorStep(o,n,a,i,s,"next",e)}function s(e){asyncGeneratorStep(o,n,a,i,s,"throw",e)}i(void 0)}))}}function automatedAnimation(e){_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}function callMacro(e,t,r,n,a){return _callMacro.apply(this,arguments)}function _callMacro(){return _callMacro=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n,a,o){var i,s,c,u,l,f,p,d,h,m,y=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=y.length>5&&void 0!==y[5]?y[5]:{},s={},game.user.can("MACRO_SCRIPT")){e.next=6;break}ui.notifications.warn("You are not allowed to use JavaScript macros."),e.next=49;break;case 6:return c=game.packs.get(t),e.next=9,c.getDocuments({name:r});case 9:if((u=e.sent).length){e.next=31;break}l=_createForOfIteratorHelper(game.packs.filter((function(e){return"Macro"==e.documentName&&/\(internal\)/.test(e.metadata.label)}))),e.prev=12,l.s();case 14:if((f=l.n()).done){e.next=23;break}return p=f.value,e.next=18,p.getDocuments({name:r});case 18:if(!(u=e.sent).length){e.next=21;break}return e.abrupt("break",23);case 21:e.next=14;break;case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(12),l.e(e.t0);case 28:return e.prev=28,l.f(),e.finish(28);case 31:if(!u.length){e.next=48;break}return d="(async () => {".concat(u[0].system.command,"})()"),h=Function("actor","item","qs","automatedAnimation","args",d),e.prev=34,i.result=s,m=mergeObject({automatedAnimation},this),e.next=39,h.call(m,n,a,o,automatedAnimation,i);case 39:e.next=46;break;case 41:e.prev=41,e.t1=e.catch(34),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(e.t1),s.error=!0;case 46:e.next=49;break;case 48:ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:r}));case 49:return e.abrupt("return",s);case 50:case"end":return e.stop()}}),e,this,[[12,25,28,31],[34,41]])}))),_callMacro.apply(this,arguments)}var DSAActiveEffectConfig=function(_ActiveEffectConfig){_inherits(DSAActiveEffectConfig,_ActiveEffectConfig);var _super=_createSuper(DSAActiveEffectConfig),_parseEffectDuration2,_createResistRollMessage,_applyEffect,_resistEffect,_onSubmit2,_render2,_checkTimesUpInstalled;function DSAActiveEffectConfig(){return _classCallCheck(this,DSAActiveEffectConfig),_super.apply(this,arguments)}return _createClass(DSAActiveEffectConfig,[{key:"checkTimesUpInstalled",value:(_checkTimesUpInstalled=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!(t=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.moduleEnabled("times-up"))&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("DSAError.shouldTimesUp")),e.abrupt("return",t);case 3:case"end":return e.stop()}}),e)}))),function(){return _checkTimesUpInstalled.apply(this,arguments)})},{key:"_render",value:(_render2=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,r,n,a,o,i,s,c,u,l=this,f=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=f.length>0&&void 0!==f[0]&&f[0],r=f.length>1&&void 0!==f[1]?f[1]:{},e.next=4,_get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"_render",this).call(this,t,r);case 4:if(n=-1,a=["none","systemEffect","macro","creature"].map((function(e){return{name:"ActiveEffects.advancedFunctions.".concat(e),index:n+=1}})),o=getProperty(this.object,"parent.type"),(i={hasSpellEffects:["spell","liturgy","ritual","ceremony","consumable","poison","disease","ammunition","meleeweapon","rangeweapon"].includes(o)||["specialability"].includes(o)&&"Combat"==getProperty(this.object,"parent.system.category.value"),hasDamageTransformation:["ammunition"].includes(o)}).hasDamageTransformation&&a.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5}),e.t0=this.getStatusEffects(),e.t1=game.user.isGM,e.t1){e.next=15;break}return e.next=14,game.settings.get("dsa5","playerCanEditSpellMacro");case 14:e.t1=e.sent;case 15:return e.t2=e.t1,s={systemEffects:e.t0,canEditMacros:e.t2},(c=$(this._element)).find(".tabs").append('<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>'.concat(game.i18n.localize("advanced"),"</a>")),e.next=21,renderTemplate("systems/dsa5/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:a,effectConfigs:i,config:s});case 21:u=e.sent,c.find('.tab[data-tab="effects"]').after($(u)),c.find(".advancedSelector").change((function(e){var t=l.object;t.flags.dsa5.advancedFunction=$(e.currentTarget).val(),renderTemplate("systems/dsa5/templates/status/advanced_functions.html",{effect:t,config:s}).then((function(e){c.find(".advancedFunctions").html(e)}))})),this.checkTimesUpInstalled();case 25:case"end":return e.stop()}}),e,this)}))),function(){return _render2.apply(this,arguments)})},{key:"_onSubmit",value:(_onSubmit2=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=u.length>1&&void 0!==u[1]?u[1]:{},n=r.updateData,a=void 0===n?null:n,o=r.preventClose,i=void 0!==o&&o,s=r.preventRender,c=void 0!==s&&s,"Actor"!=getProperty(this.object,"system.document.parent.documentName")&&getProperty(this.object,"system.document.parent.parent")&&ui.notifications.error(game.i18n.localize("DSAError.nestedEffectNotSupported")),e.next=5,_get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"_onSubmit",this).call(this,t,{updateData:a,preventClose:i,preventRender:c});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return _onSubmit2.apply(this,arguments)})},{key:"getStatusEffects",value:function(){return duplicate(CONFIG.statusEffects).map((function(e){return{id:e.id,label:game.i18n.localize(e.label)}})).sort((function(e,t){return e.label.localeCompare(t.label)}))}},{key:"getData",value:function(e){return _get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"getData",this).call(this,e)}},{key:"dropDownMenu",value:function(){for(var e=game.i18n.localize("MODS.FW"),t=game.i18n.localize("skill"),r=game.i18n.localize("MODS.FP"),n=game.i18n.localize("stepValue"),a=game.i18n.localize("MODS.QS"),o=game.i18n.localize("MODS.partChecks"),i="".concat(game.i18n.localize("LocalizedIDs.perception")," 1"),s="".concat(game.i18n.localize("LocalizedIDs.wrestle")," 1"),c=game.i18n.localize("closeCombatAttacks"),u=game.i18n.localize("rangeCombatAttacks"),l="".concat(game.i18n.localize("regenerate")," (").concat(game.i18n.localize("CHARAbbrev.CR"),")"),f=game.i18n.localize("AsPCost"),p=game.i18n.localize("KaPCost"),d=game.i18n.localize("regenerate"),h="".concat(game.i18n.localize("Healing")," 1"),m="".concat(game.i18n.localize("Description")," 1"),y="".concat(game.i18n.localize("LocalizedIDs.miracle")),v=[{name:game.i18n.localize("protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:game.i18n.localize("liturgyArmor"),val:"system.liturgyArmor",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("resistanceModifier")," (").concat(game.i18n.localize("condition"),")"),val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("spellArmor"),val:"system.spellArmor",mode:2,ph:"1"},{name:game.i18n.localize("carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:"".concat(c," - ").concat(game.i18n.localize("CHARAbbrev.AT")),val:"system.meleeStats.attack",mode:2,ph:"1"},{name:"".concat(c," - ").concat(game.i18n.localize("CHARAbbrev.PA")),val:"system.meleeStats.parry",mode:2,ph:"1"},{name:"".concat(y," - ").concat(game.i18n.localize("CHARAbbrev.AT")),val:"system.miracle.attack",mode:2,ph:"1"},{name:"".concat(y," - ").concat(game.i18n.localize("CHARAbbrev.PA")),val:"system.miracle.parry",mode:2,ph:"1"},{name:"".concat(c," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:"".concat(c," - ").concat(game.i18n.localize("MODS.defenseMalus")),val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:"".concat(game.i18n.localize("CONJURATION.elemental")," 1")},{name:"".concat(u," - ").concat(game.i18n.localize("CHARAbbrev.AT")),val:"system.rangeStats.attack",mode:2,ph:"1"},{name:"".concat(u," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:"".concat(u," - ").concat(game.i18n.localize("MODS.defenseMalus")),val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("spell")," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.spellStats.damage",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("liturgy")," - ").concat(game.i18n.localize("CHARAbbrev.damage")),val:"system.liturgyStats.damage",mode:2,ph:"1"},{name:p,val:"system.kapModifier",mode:2,ph:"1"},{name:f,val:"system.aspModifier",mode:2,ph:"1"},{name:"".concat(t," - ").concat(e),val:"system.skillModifiers.FW",mode:0,ph:i},{name:"".concat(t," - ").concat(r),val:"system.skillModifiers.FP",mode:0,ph:i},{name:"".concat(t," - ").concat(n),val:"system.skillModifiers.step",mode:0,ph:i},{name:"".concat(t," - ").concat(a),val:"system.skillModifiers.QL",mode:0,ph:i},{name:"".concat(t," - ").concat(o),val:"system.skillModifiers.TPM",mode:0,ph:i},{name:"".concat(game.i18n.localize("vulnerability")," - ").concat(game.i18n.localize("combatskill")),val:"system.vulnerabilities.combatskill",mode:0,ph:s},{name:"".concat(t," - ").concat(game.i18n.localize("MODS.global")),val:"system.skillModifiers.global",mode:0,ph:"1"},{name:"".concat(l," - ").concat(game.i18n.localize("wounds")),val:"system.repeatingEffects.startOfRound.wounds",mode:0,ph:"1d6"},{name:"".concat(l," - ").concat(game.i18n.localize("astralenergy")),val:"system.repeatingEffects.startOfRound.astralenergy",mode:0,ph:"1d6"},{name:"".concat(l," - ").concat(game.i18n.localize("karmaenergy")),val:"system.repeatingEffects.startOfRound.karmaenergy",mode:0,ph:"1d6"},{name:"".concat(d," - ").concat(game.i18n.localize("wounds")),val:"system.status.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:"".concat(d," - ").concat(game.i18n.localize("astralenergy")),val:"system.status.regeneration.AsPgearmodifier",mode:2,ph:"1"},{name:"".concat(d," - ").concat(game.i18n.localize("karmaenergy")),val:"system.status.regeneration.KaPgearmodifier",mode:2,ph:"1"},{name:"".concat(game.i18n.localize("feature")," - ").concat(f),val:"data.skillModifiers.feature.AsPCost",mode:0,ph:h},{name:"".concat(game.i18n.localize("advanced")," - ").concat(f),val:"data.skillModifiers.conditional.AsPCost",mode:0,ph:m},{name:"".concat(game.i18n.localize("feature")," - ").concat(p),val:"data.skillModifiers.feature.KaPCost",mode:0,ph:h},{name:"".concat(game.i18n.localize("advanced")," - ").concat(p),val:"data.skillModifiers.conditional.KaPCost",mode:0,ph:m}],g=0,b=["liturgy","ceremony","spell","ritual","skill","feature"];g<b.length;g++){var w=b[g],k="skill"==w?"skillglobal":w,x=game.i18n.localize(k);v.push({name:"".concat(x," - ").concat(e),val:"data.skillModifiers.".concat(w,".FW"),mode:0,ph:i},{name:"".concat(x," - ").concat(r),val:"data.skillModifiers.".concat(w,".FP"),mode:0,ph:i},{name:"".concat(x," - ").concat(n),val:"data.skillModifiers.".concat(w,".step"),mode:0,ph:i},{name:"".concat(x," - ").concat(a),val:"data.skillModifiers.".concat(w,".QL"),mode:0,ph:i},{name:"".concat(x," - ").concat(o),val:"data.skillModifiers.".concat(w,".TPM"),mode:0,ph:i})}for(var _=0,O=["mu","kl","in","ch","ff","ge","ko","kk"];_<O.length;_++){var E=O[_];v.push({name:game.i18n.localize("CHAR.".concat(E.toUpperCase())),val:"data.characteristics.".concat(E,".gearmodifier"),mode:2,ph:"1"})}var S,L=_createForOfIteratorHelper(_system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z.gearModifyableCalculatedAttributes);try{for(L.s();!(S=L.n()).done;){var T=S.value;v.push({name:game.i18n.localize(T),val:"data.status.".concat(T,".gearmodifier"),mode:2,ph:"1"})}}catch(e){L.e(e)}finally{L.f()}var D,P=_createForOfIteratorHelper(v=v.sort((function(e,t){return e.name.localeCompare(t.name)})));try{for(P.s();!(D=P.n()).done;){var A=D.value;A.ph&&null!=A.mode||console.warn(A)}}catch(e){P.e(e)}finally{P.f()}return v=v.map((function(e){return'<option value="'.concat(e.val,'" data-mode="').concat(e.mode,'" data-ph="').concat(e.ph,'">').concat(e.name,"</option>")})).join("\n"),'<select class="selMenu">'.concat(v,"</select>")}},{key:"activateListeners",value:function(e){_get(_getPrototypeOf(DSAActiveEffectConfig.prototype),"activateListeners",this).call(this,e);var t=this.dropDownMenu();e.find(".changes-list .effect-change .key").append(t),e.find(".selMenu").change((function(e){var t=$(e.currentTarget);t.siblings("input").val(t.val());var r=t.closest(".effect-change"),n=t.find("option:selected");r.find(".mode select").val(n.attr("data-mode")),r.find(".value input").attr("placeholder",n.attr("data-ph")),t.blur()}))}}],[{key:"defaultOptions",get:function(){return mergeObject(_get(_getPrototypeOf(DSAActiveEffectConfig),"defaultOptions",this),{resizable:!0})}},{key:"onEffectRemove",value:function(){var _onEffectRemove=_asyncToGenerator(_regeneratorRuntime().mark((function _callee4(actor,effect){var onRemoveMacro;return _regeneratorRuntime().wrap((function _callee4$(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(onRemoveMacro=getProperty(effect,"flags.dsa5.onRemove"),!onRemoveMacro){_context4.next=8;break}if(game.user.can("MACRO_SCRIPT")){_context4.next=6;break}ui.notifications.warn("You are not allowed to use JavaScript macros."),_context4.next=8;break;case 6:return _context4.next=8,eval("(async () => {".concat(onRemoveMacro,"})()"));case 8:case"end":return _context4.stop()}}),_callee4)})));function onEffectRemove(e,t){return _onEffectRemove.apply(this,arguments)}return onEffectRemove}()},{key:"applyRollTransformation",value:function applyRollTransformation(actor,options,functionID){var msg="",source=options.origin,_iterator3=_createForOfIteratorHelper(source.effects),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var ef=_step3.value;try{Number(getProperty(ef,"flags.dsa5.advancedFunction"))==functionID&&eval(getProperty(ef,"flags.dsa5.args3"))}catch(e){console.warn("Unable to apply advanced effect",e,ef)}}}catch(e){_iterator3.e(e)}finally{_iterator3.f()}return options.origin=source,{msg,options}}},{key:"applyAdvancedFunction",value:function(){var _applyAdvancedFunction=_asyncToGenerator(_regeneratorRuntime().mark((function _callee5(actor,effects,source,testData,sourceActor){var skipResistRolls,msg,resistRolls,effectApplied,effectsWithChanges,effectNames,_iterator4,_step4,_loop,_args6=arguments;return _regeneratorRuntime().wrap((function _callee5$(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:skipResistRolls=!(_args6.length>5&&void 0!==_args6[5])||_args6[5],msg="",resistRolls=[],effectApplied=!1,effectsWithChanges=[],effectNames=new Set,_iterator4=_createForOfIteratorHelper(effects),_context6.prev=7,_loop=_regeneratorRuntime().mark((function _loop(){var ef,specStep,customEf,qs,resistRoll,skills,mod,effect,value,creatures;return _regeneratorRuntime().wrap((function _loop$(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(ef=_step4.value,ef.origin&&delete ef.origin,specStep=Number(getProperty(ef,"flags.dsa5.specStep"))||0,_context5.prev=3,customEf=Number(getProperty(ef,"flags.dsa5.advancedFunction")),qs=Math.min(testData.qualityStep||0,6),resistRoll=getProperty(ef,"flags.dsa5.resistRoll"),!resistRoll||skipResistRolls){_context5.next=13;break}skills=resistRoll.split(" "),mod="".concat(skills.pop()),resistRolls.push({skill:skills.join(" "),mod:Math.round(Roll.safeEval("".concat(mod).replace(/q(l|s)/i,qs).replace("step",specStep)))||0,effect:ef,target:actor,token:actor.token?actor.token.id:void 0}),_context5.next=37;break;case 13:if(effectApplied=!0,effectNames.has(ef.label)||effectNames.add(ef.label),ef.changes&&ef.changes.length>0&&effectsWithChanges.push(ef),!customEf){_context5.next=37;break}_context5.t0=customEf,_context5.next=1===_context5.t0?20:2===_context5.t0?27:3===_context5.t0?34:37;break;case 20:return effect=duplicate(CONFIG.statusEffects.find((function(e){return e.id==getProperty(ef,"flags.dsa5.args0")}))),value="".concat(getProperty(ef,"flags.dsa5.args1"))||"1",effect.duration=ef.duration,value=/,/.test(value)?Number(value.split(",")[qs-1]):Number(value.replace(game.i18n.localize("CHARAbbrev.QS"),qs)),_context5.next=26,actor.addCondition(effect,value,!1,!1);case 26:return _context5.abrupt("break",37);case 27:if(game.user.can("MACRO_SCRIPT")){_context5.next=31;break}ui.notifications.warn("You are not allowed to use JavaScript macros."),_context5.next=33;break;case 31:return _context5.next=33,eval("(async () => {".concat(getProperty(ef,"flags.dsa5.args3"),"})()"));case 33:return _context5.abrupt("break",37);case 34:return creatures=(getProperty(ef,"flags.dsa5.args4")||"").split(",").map((function(e){return"@Compendium[".concat(e.trim().replace(/(@Compendium\[|\])/),"]")})).join(" "),msg+="<p><b>".concat(game.i18n.localize("ActiveEffects.advancedFunctions.creature"),"</b>:</p><p>").concat(creatures,"</p>"),_context5.abrupt("break",37);case 37:_context5.next=44;break;case 39:_context5.prev=39,_context5.t1=_context5.catch(3),console.warn("Unable to apply advanced effect"),console.warn(_context5.t1),console.warn(ef);case 44:case"end":return _context5.stop()}}),_loop,null,[[3,39]])})),_iterator4.s();case 10:if((_step4=_iterator4.n()).done){_context6.next=14;break}return _context6.delegateYield(_loop(),"t0",12);case 12:_context6.next=10;break;case 14:_context6.next=19;break;case 16:_context6.prev=16,_context6.t1=_context6.catch(7),_iterator4.e(_context6.t1);case 19:return _context6.prev=19,_iterator4.f(),_context6.finish(19);case 22:return _context6.next=24,actor.createEmbeddedDocuments("ActiveEffect",effectsWithChanges.map((function(e){return e.origin=actor.uuid,e})));case 24:return _context6.abrupt("return",{msg,resistRolls,effectApplied,effectNames:Array.from(effectNames)});case 25:case"end":return _context6.stop()}}),_callee5,null,[[7,16,19,22]])})));function applyAdvancedFunction(e,t,r,n,a){return _applyAdvancedFunction.apply(this,arguments)}return applyAdvancedFunction}()},{key:"resistEffect",value:(_resistEffect=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i=this;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.currentTarget.dataset,n={token:r.token,actor:r.actor,scene:canvas.id},(a=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getSpeaker(n))?(o=a.items.find((function(e){return"skill"==e.type&&e.name==r.skill})),a.setupSkill(o,{modifier:r.mod},r.token).then(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.testData.opposable=!1,e.next=3,a.basicTest(t);case 3:if(!((e.sent.result.qualityStep||0)<=0)){e.next=8;break}return e.next=8,i.applyEffect(r.message,r.mode,[n],{effectIds:[r.effect],skipResistRolls:!0});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())):console.warn("Actor not found for resist roll.");case 4:case"end":return e.stop()}}),e)}))),function(e){return _resistEffect.apply(this,arguments)})},{key:"applyEffect",value:(_applyEffect=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n){var a,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=_.length>3&&void 0!==_[3]?_[3]:{},o=game.messages.get(t),i=o.flags.data.preData.source,s=o.flags.data.postData,c=o.speaker,["poison","disease"].includes(i.type)&&(s.qualityStep=s.successLevel>0?2:1),(u=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getSpeaker(c))||(u=game.actors.get(getProperty(o.flags,"data.preData.extra.actor.id"))),l=u,e.next=11,this._parseEffectDuration(i,s,o.flags.data.preData,u);case 11:if(f=e.sent,a.effectIds&&(f=f.filter((function(e){return a.effectIds.includes(e._id)}))),p=[],"self"==r?u&&p.push(u):n?p=n.map((function(e){return _system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getSpeaker(e)})):game.user.targets.size&&game.user.targets.forEach((function(e){e.actor&&p.push(e.actor)})),!game.user.isGM){e.next=48;break}d=_createForOfIteratorHelper(p),e.prev=17,d.s();case 19:if((h=d.n()).done){e.next=38;break}return m=h.value,e.next=23,DSAActiveEffectConfig.applyAdvancedFunction(m,f,i,s,l,a.skipResistRolls||!1);case 23:if(y=e.sent,v=y.msg,g=y.resistRolls,b=y.effectApplied,w=y.effectNames,!b){e.next=33;break}return k=game.i18n.format("ActiveEffects.appliedEffect",{target:m.name,source:w.join(", ")}),x="".concat(k).concat(v||""),e.next=33,ChatMessage.create(_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.chatDataSetup(x));case 33:if(!g.length){e.next=36;break}return e.next=36,this.createResistRollMessage(g,t,r);case 36:e.next=19;break;case 38:e.next=43;break;case 40:e.prev=40,e.t0=e.catch(17),d.e(e.t0);case 43:return e.prev=43,d.f(),e.finish(43);case 46:e.next=49;break;case 48:game.socket.emit("system.dsa5",{type:"addEffect",payload:{mode:r,id:t,actors:p.map((function(e){return{token:e.token?e.token.id:void 0,actor:e.id,scene:canvas.scene.id}}))}});case 49:case"end":return e.stop()}}),e,this,[[17,40,43,46]])}))),function(e,t,r){return _applyEffect.apply(this,arguments)})},{key:"createResistRollMessage",value:(_createResistRollMessage=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n){var a,o,i,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=_createForOfIteratorHelper(t),e.prev=1,a.s();case 3:if((o=a.n()).done){e.next=12;break}return i=o.value,e.next=7,renderTemplate("systems/dsa5/templates/chat/roll/resist-roll.html",{resist:i,id:r,mode:n});case 7:return s=e.sent,e.next=10,ChatMessage.create(_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.chatDataSetup(s));case 10:e.next=3;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(1),a.e(e.t0);case 17:return e.prev=17,a.f(),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[1,14,17,20]])}))),function(e,t,r){return _createResistRollMessage.apply(this,arguments)})},{key:"_parseEffectDuration",value:(_parseEffectDuration2=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n,a){var o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E,S,L,T,D,P,A;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o={},i=_createForOfIteratorHelper(n.situationalModifiers.filter((function(e){return e.specAbId})));try{for(i.s();!(s=i.n()).done;)c=s.value,o[c.specAbId]=c.step}catch(e){i.e(e)}finally{i.f()}u=Object.keys(o),l=a?a.items.filter((function(e){return u.includes(e.id)})):[],f=t.effects?duplicate(t.effects):[],p=_createForOfIteratorHelper(l);try{for(p.s();!(d=p.n()).done;){h=d.value,m=duplicate(h).effects,y=_createForOfIteratorHelper(m);try{for(y.s();!(v=y.n()).done;)g=v.value,setProperty(g,"flags.dsa5.specStep",o[h.id])}catch(e){y.e(e)}finally{y.f()}f.push.apply(f,_toConsumableArray(m))}}catch(e){p.e(e)}finally{p.f()}b=(b=getProperty(t,"system.duration.value")||"").replace(" x "," * ").replace(game.i18n.localize("CHARAbbrev.QS"),r.qualityStep),e.prev=10,w=[{regEx:new RegExp(game.i18n.localize("DSAREGEX.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEX.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEX.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEX.days"),"gi"),seconds:86400}],k=0,x=w;case 13:if(!(k<x.length)){e.next=25;break}if(!(_=x[k]).regEx.test(b)){e.next=22;break}return O=b.replace(_.regEx,"").trim(),e.next=19,_system_dice_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z._stringToRoll(O);case 19:if(E=e.sent,!isNaN(E)){S=_createForOfIteratorHelper(f);try{for(S.s();!(L=S.n()).done;)T=L.value,D=E*_.seconds,(P=getProperty(T,"flags.dsa5.customDuration"))&&(A=P.split(",")[r.qualityStep-1])&&"-"!=A&&(D=Number(A)),T.duration.seconds=D,T.duration.rounds=T.duration.seconds/5}catch(e){S.e(e)}finally{S.f()}}return e.abrupt("break",25);case 22:k++,e.next=13;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(10),console.error("Could not parse duration '".concat(b,"' of '").concat(t.name,"'"));case 30:return e.abrupt("return",f);case 31:case"end":return e.stop()}}),e,null,[[10,27]])}))),function(e,t,r,n){return _parseEffectDuration2.apply(this,arguments)})}]),DSAActiveEffectConfig}(ActiveEffectConfig)},973:(e,t,r)=>{r.d(t,{Z:()=>b});var n=r(577);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(){return o="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=i(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},o.apply(this,arguments)}function i(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=f(e);if(t){var a=f(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return l(this,r)}}function l(e,t){if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function p(){p=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===f)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=l(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===f)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var f={};function d(){}function h(){}function m(){}var y={};c(y,o,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,o)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,s,c){var u=l(e[o],e,i);if("throw"!==u.type){var f=u.arg,p=f.value;return p&&"object"==a(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return o=o?o.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return f;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var n=l(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,f;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,f):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,f)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,c(b,"constructor",m),c(m,"constructor",h),h.displayName=c(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,c(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),c(k.prototype,i,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(u(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),c(b,s,"Generator"),c(b,o,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},e}function d(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function h(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){d(o,n,a,i,s,"next",e)}function s(e){d(o,n,a,i,s,"throw",e)}i(void 0)}))}}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function g(e,t,r){return t&&v(e.prototype,t),r&&v(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var b=function(){function e(){y(this,e)}var t,r,n,a,o;return g(e,null,[{key:"bindButtons",value:function(e){e.find(".chat-condition").each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(function(e){var t={data:{type:"condition",payload:{id:$(e.currentTarget).attr("data-id")}}};e.dataTransfer.setData("text/plain",JSON.stringify(t))}))}))}},{key:"createCustomEffect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2?arguments[2]:void 0;r=r||game.i18n.localize("CONDITION.custom"),""==t&&(t=r),e.addCondition({label:r,icon:"icons/svg/aura.svg",origin:e.uuid,flags:{dsa5:{value:null,editable:!0,description:t,custom:!0}}})}},{key:"prepareActiveEffects",value:function(e,t){var r=duplicate(CONFIG.statusEffects),n=[];t.conditions=[],t.transferedConditions=[];var a,o=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return m(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?m(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}(e.effects.filter((function(t){return game.user.isGM||"Item"==e.documentName||!t.getFlag("dsa5","hidePlayers")})));try{for(o.s();!(a=o.n()).done;){var i=a.value;i.disabled=i.disabled,i.boolean=null==i.getFlag("dsa5","value"),i.label=i.label,i.icon=i.icon;var s=i.getFlag("core","statusId");s&&(i.value=i.getFlag("dsa5","value"),i.editable=i.getFlag("dsa5","editable"),i.descriptor=s,i.manual=i.getFlag("dsa5","manual"),n.push(s)),i.origin!=e.uuid&&i.origin||i.notApplicable?i.notApplicable||t.transferedConditions.push(i):t.conditions.push(i)}}catch(e){o.e(e)}finally{o.f()}t.manualConditions=r.filter((function(e){return!n.includes(e.id)}))}},{key:"addCondition",value:(o=h(p().mark((function t(r,n){var a,o,i,s,c=arguments;return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=c.length>2&&void 0!==c[2]?c[2]:1,o=c.length>3&&void 0!==c[3]&&c[3],i=!(c.length>4&&void 0!==c[4])||c[4],r.isOwner){t.next=5;break}return t.abrupt("return","Not owned");case 5:if(!r.compendium){t.next=7;break}return t.abrupt("return","Can not add in compendium");case 7:if(!(o&&a<=0)){t.next=9;break}return t.abrupt("return",this.removeCondition(r,n,a,i,o));case 9:if("string"==typeof n&&(n=duplicate(CONFIG.statusEffects.find((function(e){return e.id==n})))),n){t.next=12;break}return t.abrupt("return","No Effect Found");case 12:if(!(s=this.hasCondition(r,n.id))||null!=s.flags.dsa5.value){t.next=17;break}return t.abrupt("return",s);case 17:if(!s){t.next=21;break}return t.next=20,e.updateEffect(r,s,a,o,i,n);case 20:case 23:return t.abrupt("return",t.sent);case 21:return t.next=23,e.createEffect(r,n,a,i);case 24:case"end":return t.stop()}}),t,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"hasCondition",value:function(e,t){return!(null==e||!t)&&!!e.effects&&e.effects.find((function(e){return getProperty(e,"flags.core.statusId")==t}))}},{key:"removeCondition",value:(a=h(p().mark((function t(r,n){var a,o,i,s,c,u=arguments;return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=u.length>2&&void 0!==u[2]?u[2]:1,o=!(u.length>3&&void 0!==u[3])||u[3],i=u.length>4&&void 0!==u[4]&&u[4],r.isOwner){t.next=5;break}return t.abrupt("return","Not owned");case 5:if("string"==typeof n&&(n=duplicate(CONFIG.statusEffects.find((function(e){return e.id==n})))),n){t.next=8;break}return t.abrupt("return","No Effect Found");case 8:if(!(s=this.hasCondition(r,n.id))||null!=s.flags.dsa5.value){t.next=17;break}return r.token&&(r=r.token.actor),t.next=13,r.deleteEmbeddedDocuments("ActiveEffect",[s.id]);case 13:return c=t.sent,t.abrupt("return",c);case 17:if(!s){t.next=21;break}return t.next=20,e.removeEffect(r,s,a,i,o);case 20:return t.abrupt("return",t.sent);case 21:case"end":return t.stop()}}),t,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"immuneToEffect",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=getProperty(e,"system.immunities")||[];if(n.includes(t.id)){var a=game.i18n.format("DSAError.immuneTo",{name:e.name,condition:game.i18n.localize("CONDITION.".concat(t.id))});return ui.notifications&&!r&&ui.notifications.warn(a),a}return!1}},{key:"resistantToEffect",value:function(e,t){var r=getProperty(t,"flags.core.statusId");return r?(getProperty(e,"system.resistances.effects")||[]).reduce((function(e,t){return t.target==r&&(e+=Number(t.value)),e}),0):0}},{key:"createEffect",value:(n=h(p().mark((function e(t,r,n,a){var o,i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=this.immuneToEffect(t,r))){e.next=3;break}return e.abrupt("return",o);case 3:return r.label=game.i18n.localize(r.label),a?(r.flags.dsa5.auto=Math.min(r.flags.dsa5.max,n),r.flags.dsa5.manual=0):(r.flags.dsa5.manual=Math.min(r.flags.dsa5.max,n),r.flags.dsa5.auto=0),r.flags.dsa5.value=Math.min(4,r.flags.dsa5.manual+r.flags.dsa5.auto),r["flags.core.statusId"]=r.id,"dead"==r.id&&(r["flags.core.overlay"]=!0),e.next=10,t.createEmbeddedDocuments("ActiveEffect",[duplicate(r)]);case 10:return i=e.sent,e.next=13,t._dependentEffects(r.id,r,1);case 13:return delete r.id,e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,this)}))),function(e,t,r,a){return n.apply(this,arguments)})},{key:"removeEffect",value:(r=h(p().mark((function e(t,r,n,a,o){var i,s,c;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=o?a?n:Math.max(0,r.flags.dsa5.auto-n):r.flags.dsa5.auto,s=o?r.flags.dsa5.manual:a?n:r.flags.dsa5.manual-n,!((c={flags:{dsa5:{auto:i,manual:s,value:Math.max(0,Math.min(r.flags.dsa5.max,s+i))}}}).flags.dsa5.auto<=0&&0==c.flags.dsa5.manual)){e.next=9;break}return e.next=6,t.deleteEmbeddedDocuments("ActiveEffect",[r.id]);case 6:case 11:return e.abrupt("return",e.sent);case 9:return e.next=11,r.update(c);case 12:case"end":return e.stop()}}),e)}))),function(e,t,n,a,o){return r.apply(this,arguments)})},{key:"updateEffect",value:(t=h(p().mark((function e(t,r,n,a,o){var i,s,c,u,l,f=arguments;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=f.length>5&&void 0!==f[5]?f[5]:void 0,!(s=this.immuneToEffect(t,r,!0))){e.next=4;break}return e.abrupt("return",s);case 4:if(o?(u=Math.min(r.flags.dsa5.max,a?n:r.flags.dsa5.auto+n),c=u-r.flags.dsa5.auto,l={flags:{dsa5:{auto:u,manual:r.flags.dsa5.manual}}}):(u=a?n:r.flags.dsa5.manual+n,c=u-r.flags.dsa5.manual,l={flags:{dsa5:{manual:u,auto:r.flags.dsa5.auto}}}),0!=c){e.next=7;break}return e.abrupt("return",r);case 7:return l.flags.dsa5.value=Math.max(0,Math.min(r.flags.dsa5.max,l.flags.dsa5.manual+l.flags.dsa5.auto)),i.duration&&(l.duration=i.duration,l.duration.startTime=game.time.worldTime),e.next=11,r.update(l);case 11:return e.next=13,t._dependentEffects(r.flags.core.statusId,r,c);case 13:return e.abrupt("return",r);case 14:case"end":return e.stop()}}),e,this)}))),function(e,r,n,a,o){return t.apply(this,arguments)})},{key:"calculateRollModifier",value:function(e,t,r){return null==e.flags.dsa5.value||"regenerate"==r.type?0:Math.max(-1*e.flags.dsa5.max,Math.min(0,-1*e.flags.dsa5.value+this.resistantToEffect(t,e)))}},{key:"ModifierIsSelected",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"damage"!=t.mode}},{key:"getDamageBonus",value:function(){return 0}},{key:"getRollModifiers",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.effects.filter((function(e){return!e.disabled})).map((function(a){var o=duplicate(a),i=game.dsa5.config.statusEffectClasses[getProperty(o,"flags.core.statusId")]||e;return{name:o.label,value:i.calculateRollModifier(o,t,r,n),selected:i.ModifierIsSelected(r,n,t)}})).filter((function(e){return 0!=e.value}))}}]),e}(),w=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"ModifierIsSelected",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r="skill"==e.type&&"yes"==e.system.burden.value,n=["rangeweapon"].includes(e.type)&&"damage"!=t.mode&&game.settings.get("dsa5","encumbranceForRange"),a=!["skill","spell","ritual","ceremony","liturgy","rangeweapon"].includes(e.type)&&"damage"!=t.mode;return r||a||n}},{key:"calculateRollModifier",value:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return"regenerate"==n.type||"skill"==n.type&&"no"==n.system.burden.value?0:o(f(r),"calculateRollModifier",this).call(this,e,t,n,a)}}]),r}(b),k=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return"regenerate"==r.type?0:"dodge"==r.type?-2:n.mode?"attack"==n.mode?-4:-2:0}}]),r}(b),x=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){var n=new RegExp("".concat(game.i18n.localize("combatskill")," "),"gi"),a=t.system.happyTalents.value.split(/;|,/).map((function(e){return e.replace(n,"").trim()}));return a.includes(r.name)&&["skill","combatskill"].includes(r.type)||["rangeweapon","meleeweapon"].includes(r.type)&&a.includes(r.system.combatskill.value)||["ceremony","liturgy"].includes(r.type)?e.flags.dsa5.value-1:["ritual","spell","skill","combatskill"].includes(r.type)?-1*e.flags.dsa5.value:(r.type,0)}}]),r}(b),_=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return"regenerate"==r.type?0:"skill"==r.type&&r.name==game.i18n.localize("LocalizedIDs.perception")?-3:0}}]),r}(b),O=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return"regenerate"==r.type?0:"skill"==r.type?r.name==game.i18n.localize("LocalizedIDs.featOfStrength")?2:0:"attack"==n.mode?4:0}}]),r}(b),E=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"ModifierIsSelected",value:function(e){var t=arguments.length>2?arguments[2]:void 0;return null==t.effects.find((function(e){return"bloodrush"==getProperty(e,"flags.core.statusId")}))}}]),r}(b),S=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){if("regenerate"==r.type)return 0;switch(Number(e.flags.dsa5.value)){case 2:var n=new RegExp("".concat(game.i18n.localize("combatskill")," "),"gi"),a=t.system.happyTalents.value.split(/;|,/).map((function(e){return e.replace(n,"").trim()}));if(a.includes(r.name)&&["skill","combatskill"].includes(r.type)||["rangeweapon","meleeweapon"].includes(r.type)&&a.includes(r.system.combatskill.value)||["ceremony","liturgy"].includes(r.type))return-2;case 3:return-3}return 0}}]),r}(b),L=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return"regenerate"==r.type?0:"skill"==r.type&&r.name==game.i18n.localize("LocalizedIDs.gambling")?Math.max(-3,Math.min(-1*e.flags.dsa5.value+this.resistantToEffect(t,e))):0}}]),r}(b),T=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return"regenerate"==r.type?0:"skill"==r.type&&r.name==game.i18n.localize("LocalizedIDs.bodyControl")?Math.max(-2,Math.min(0,-1*(e.flags.dsa5.value-1)+this.resistantToEffect(t,e))):0}}]),r}(b),D=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return 0}}]),r}(b),P=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return"skill"==r.type&&r.name==game.i18n.localize("LocalizedIDs.willpower")?-2*(e.flags.dsa5.value-1):"regenerate"==r.type?-1*e.flags.dsa5.value:0}}]),r}(b),A=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return"skill"==r.type&&r.name==game.i18n.localize("LocalizedIDs.willpower")?Math.max(-3,Math.min(0,-1*e.flags.dsa5.value+this.resistantToEffect(t,e))):0}}]),r}(b),j=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return"regenerate"==r.type?1*e.flags.dsa5.value:0}}]),r}(b),C=function(e){s(r,e);var t=u(r);function r(){return y(this,r),t.apply(this,arguments)}return g(r,null,[{key:"calculateRollModifier",value:function(e,t,r){return 0}}]),r}(b);n.Z.statusEffectClasses={inpain:E,encumbered:w,stunned:b,raptured:x,feared:b,paralysed:b,confused:b,prone:k,deaf:_,bloodrush:O,trance:S,drunken:L,arousal:D,burning:T,sikaryanloss:P,desire:A,theriak:j,services:C}},272:(e,t,r)=>{r.d(t,{Z:()=>y});var n=r(577),a=r(794);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(){i=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,i,s,c){var u=f(e[a],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==o(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function s(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function c(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){s(o,n,a,i,c,"next",e)}function c(e){s(o,n,a,i,c,"throw",e)}i(void 0)}))}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(){return f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=p(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},f.apply(this,arguments)}function p(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=m(e)););return e}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function h(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(b,e);var t,r,a,o,s,p,y,v,g=(y=b,v=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=m(y);if(v){var r=m(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return h(this,e)});function b(){return u(this,b),g.apply(this,arguments)}return t=b,null,r=[{key:"setupFunctions",value:function(){}},{key:"vantageAdded",value:(p=c(i().mark((function e(t,r){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.dsa5.config.addvantageRules[r.name]&&game.dsa5.config.addvantageRules[r.name](t,r);case 1:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"vantageRemoved",value:(s=c(i().mark((function e(t,r){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.dsa5.config.removevantageRules[r.name]&&game.dsa5.config.removevantageRules[r.name](t,r);case 1:case"end":return e.stop()}}),e)}))),function(e,t){return s.apply(this,arguments)})},{key:"_vantageReturnFunction",value:(o=c(i().mark((function e(t,r,a,o){var s,c,u,l;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r){e.next=2;break}return e.abrupt("return");case 2:if(r=duplicate(r),/,/.test(r.system.APValue.value)&&(s=r.name.replace(" ()",""),r.system.APValue.value=r.system.APValue.value.split(",")[t.items.filter((function(e){return e.type==r.type&&e.name.includes(s)})).length].trim()),null!=o&&(b.simpleAdoption(r,o,r.name,n.Z.vantagesNeedingAdaption),r.name="".concat(r.name.replace(" ()","")," (").concat(o.name,")"),o.data&&(r.system.APValue.value=r.system.APValue.value.split("/")[o.system.StF.value.charCodeAt(0)-65].trim())),!(c=t.items.find((function(e){return e.type==a&&e.name==r.name})))){e.next=24;break}if(u=duplicate(c),l=/;/.test(u.system.APValue.value)?u.system.APValue.value.split(";").map((function(e){return Number(e.trim())}))[u.system.step.value]:u.system.APValue.value,e.t0=u.system.step.value+1<=u.system.max.value,!e.t0){e.next=14;break}return e.next=13,t.checkEnoughXP(l);case 13:e.t0=e.sent;case 14:if(!e.t0){e.next=22;break}return u.system.step.value+=1,e.next=18,t._updateAPs(l);case 18:return e.next=20,t.updateEmbeddedDocuments("Item",[u]);case 20:return e.next=22,b.vantageAdded(t,u);case 22:e.next=33;break;case 24:return e.next=26,t.checkEnoughXP(r.system.APValue.value.split(";").map((function(e){return e.trim()}))[0]);case 26:if(!e.sent){e.next=33;break}return e.next=29,b.vantageAdded(t,r);case 29:return e.next=31,t._updateAPs(r.system.APValue.value.split(";").map((function(e){return e.trim()}))[0]);case 31:return e.next=33,t.createEmbeddedDocuments("Item",[r]);case 33:case"end":return e.stop()}}),e)}))),function(e,t,r,n){return o.apply(this,arguments)})},{key:"needsAdoption",value:(a=c(i().mark((function e(t,r,a){var o,s,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.Z.vantagesNeedingAdaption[r.name]){e.next=17;break}if("text"!=n.Z.vantagesNeedingAdaption[r.name].items){e.next=8;break}return e.next=4,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:r});case 4:o=e.sent,s=function(e){var n={name:e.find('[name="entryselection"]').val()};b._vantageReturnFunction(t,r,a,n)},e.next=13;break;case 8:return c=t.items.filter((function(e){return n.Z.vantagesNeedingAdaption[r.name].items.includes(e.type)})),e.next=11,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:c,original:r});case 11:o=e.sent,s=function(e){var n=c.find((function(t){return t.name==e.find('[name="entryselection"]').val()}));b._vantageReturnFunction(t,r,a,n)};case 13:return e.next=15,new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:o,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:s},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 15:e.next=18;break;case 17:b._vantageReturnFunction(t,r,a,null);case 18:case"end":return e.stop()}}),e)}))),function(e,t,r){return a.apply(this,arguments)})},{key:"hasVantage",value:function(e,t){return f(m(b),"hasItem",this).call(this,e,t,["advantage","disadvantage"])}},{key:"vantageStep",value:function(e,t){return f(m(b),"itemStep",this).call(this,e,t,["advantage","disadvantage"])}},{key:"getVantageAsModifier",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return f(m(b),"itemAsModifier",this).call(this,e,t,r,["advantage","disadvantage"],n,a)}}],r&&l(t,r),Object.defineProperty(t,"prototype",{writable:!1}),b}(a.Z);a.Z.children.AdvantageRulesDSA5=y},231:(e,t,r)=>{r.d(t,{Z:()=>p});var n=r(947),a=r(903),o=r(491);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function s(){s=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,s,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==i(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function c(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function u(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){c(o,n,a,i,s,"next",e)}function s(e){c(o,n,a,i,s,"throw",e)}i(void 0)}))}}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),0==e.skills.length&&o.Z.allSkills().then((function(t){e.skills=t.map((function(e){return{name:e.name,type:"skill"}})).concat(Object.values(game.dsa5.config.characteristics).map((function(e){return{name:game.i18n.localize(e),type:"attribute"}})).concat({name:game.i18n.localize("regenerate"),type:"regeneration"}))})),this.regex,this.filtering=!1,this.constants={dodge:game.i18n.localize("dodge"),parryWeaponless:game.i18n.localize("parryWeaponless"),attackWeaponless:game.i18n.localize("attackWeaponless")}}var t,r,i,c;return t=e,r=[{key:"regex",get:function(){return new RegExp("^/(".concat(e.cmds.join(" |"),")"))}},{key:"chatListeners",value:(c=u(s().mark((function e(t){var r;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this,this.anchor=$("#chat-message").parent(),$("#chat-message").off("keydown",ui.chat._onChatKeyDownBinding),t.on("keyup","#chat-message",function(){var e=u(s().mark((function e(t){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r._parseInput(t);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.on("click",".quick-item",function(){var e=u(s().mark((function e(t){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r._quickSelect($(t.currentTarget));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.on("keydown","#chat-message",(function(e){r._navigateQuickFind(e)}));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"_parseInput",value:function(e){var t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(27==e.which)return this._closeQuickfind(),!1;var r=this._getCmd(t),n=t.substring(1+r.length).toLowerCase().trim();this["_filter".concat(r)](n),this.filtering=!0}else this._closeQuickfind()}},{key:"_getCmd",value:function(e){return e.substring(1,3).toUpperCase().trim()}},{key:"_completeCurrentEntry",value:function(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())}},{key:"_closeQuickfind",value:function(){this.filtering=!1,this.anchor.find(".quickfind").remove()}},{key:"_filterW",value:function(e){var t=game.users.contents.filter((function(t){return t.active&&-1!=t.name.toLowerCase().trim().indexOf(e)})).map((function(e){return{name:e.name,type:"user"}}));this._checkEmpty(t),this._setList(t,"W")}},{key:"_filterAT",value:function(t){var r=e._getActor(),n=r.actor;if(r.tokenId,n){var a=["meleeweapon","rangeweapon"],o=["meleeAttack","rangeAttack"],i=n.items.filter((function(e){return(a.includes(e.type)&&1==e.system.worn.value||"trait"==e.type&&o.includes(e.system.traitType.value))&&-1!=e.name.toLowerCase().trim().indexOf(t)})).slice(0,5).map((function(e){return{name:e.name,type:"item"}})).concat([{name:this.constants.attackWeaponless,type:"item"}].filter((function(e){return-1!=e.name.toLowerCase().trim().indexOf(t)})));this._checkEmpty(i),this._setList(i,"AT")}}},{key:"_filterPA",value:function(t){var r=e._getActor(),n=r.actor;if(r.tokenId,n){var a=["meleeweapon"],o=n.items.filter((function(e){return a.includes(e.type)&&-1!=e.name.toLowerCase().trim().indexOf(t)&&1==e.system.worn.value})).slice(0,5).map((function(e){return{name:e.name,type:"item"}})).concat([{name:this.constants.dodge,type:"item"},{name:this.constants.parryWeaponless,type:"item"}].filter((function(e){return-1!=e.name.toLowerCase().trim().indexOf(t)})));this._checkEmpty(o),this._setList(o,"PA")}}},{key:"_filterSP",value:function(t){var r=e._getActor(),n=r.actor;if(r.tokenId,n){var a=["spell","ritual"],o=n.items.filter((function(e){return a.includes(e.type)&&-1!=e.name.toLowerCase().trim().indexOf(t)})).slice(0,5).map((function(e){return{name:e.name,type:"item"}}));this._checkEmpty(o),this._setList(o,"SP")}}},{key:"_checkEmpty",value:function(e){e.length||e.push({name:game.i18n.localize("DSAError.noMatch"),type:"none"})}},{key:"_filterLI",value:function(t){var r=e._getActor(),n=r.actor;if(r.tokenId,n){var a=["liturgy","ceremony"],o=n.items.filter((function(e){return a.includes(e.type)&&-1!=e.name.toLowerCase().trim().indexOf(t)})).slice(0,5).map((function(e){return{name:e.name,type:"item"}}));this._checkEmpty(o),this._setList(o,"LI")}}},{key:"_getSkills",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;t=t.replace(/(-|\+)?\d+/g,"").trim();var n=e.skills.filter((function(e){return-1!=e.name.toLowerCase().trim().indexOf(t)&&(null==r||r==e.type)})).slice(0,5);return this._checkEmpty(n),n}},{key:"_filterCH",value:function(e){this._setList(this._getSkills(e),"CH")}},{key:"_filterSK",value:function(e){this._setList(this._getSkills(e),"SK")}},{key:"_filterRQ",value:function(e){this._setList(this._getSkills(e),"RQ")}},{key:"_filterGC",value:function(e){this._setList(this._getSkills(e,"skill"),"GC")}},{key:"_setList",value:function(e,t){var r=$('<div class="quickfind dsalist"><ul>'.concat(e.map((function(e){return'<li data-type="'.concat(e.type,'" data-category="').concat(t,'" class="quick-item">').concat(e.name,"</li>")})).join(""),"</ul></div>"));r.find(".quick-item:first").addClass("focus");var n=this.anchor.find(".quickfind");n.length?n.replaceWith(r):this.anchor.append(r)}},{key:"_navigateQuickFind",value:function(e){if(this.filtering){var t=this.anchor.find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if("W"==t.attr("data-category"))break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}ui.chat._onChatKeyDown(e)}},{key:"_quickSelect",value:function(t){var r=t.attr("data-category");switch(r){case"NM":case"GC":case"RQ":case"CH":this["_quick".concat(r)](t);break;case"W":this._completeCurrentEntry(t);break;default:var n=e._getActor(),a=n.actor,o=n.tokenId;a&&(this._resetChatAutoCompletion(),this["_quick".concat(r)](t,a,o))}}},{key:"_quickW",value:function(e,t,r){}},{key:"_quickCH",value:function(e){n.Z.check3D20(e),this._resetChatAutoCompletion()}},{key:"_quickSK",value:function(e,t,r){switch(e.attr("data-type")){case"skill":var n=t.items.find((function(t){return t.name==e.text()&&"skill"==t.type}));n&&t.setupSkill(n,{},r).then((function(e){t.basicTest(e)}));break;case"attribute":var a=Object.keys(game.dsa5.config.characteristics).find((function(t){return game.i18n.localize(game.dsa5.config.characteristics[t])==e.text()}));t.setupCharacteristic(a,{},r).then((function(e){t.basicTest(e)}));break;case"regeneration":t.setupRegeneration("regenerate",{},r).then((function(e){t.basicTest(e)}))}}},{key:"_resetChatAutoCompletion",value:function(){$("#chat-message").val(""),this.anchor.find(".quickfind").remove()}},{key:"_quickGC",value:function(e){var t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),a.Z.showGCMessage(e.text(),t)}},{key:"_quickRQ",value:function(e){var t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(),a.Z.showRQMessage(e.text(),t)}},{key:"_quickPA",value:function(e,t,r){var n=e.text();if(this.constants.dodge==n)t.setupDodge({},r).then((function(e){t.basicTest(e)}));else if(this.constants.parryWeaponless==n)t.setupWeaponless("parry",{},r).then((function(e){t.basicTest(e)}));else{var a=["meleeweapon"],o=t.items.find((function(t){return a.includes(t.type)&&t.name==e.text()}));o&&t.setupWeapon(o,"parry",{},r).then((function(e){t.basicTest(e)}))}}},{key:"_quickAT",value:function(e,t,r){var n=e.text();if(this.constants.attackWeaponless==n)t.setupWeaponless("attack",{},r).then((function(e){t.basicTest(e)}));else{var a=["meleeweapon","rangeweapon"],o=["meleeAttack","rangeAttack"],i=t.items.find((function(t){return a.includes(t.type)&&t.name==e.text()}));i||(i=t.items.find((function(t){return"trait"==t.type&&t.name==e.text()&&o.includes(t.system.traitType.value)}))),i&&t.setupWeapon(i,"attack",{},r).then((function(e){t.basicTest(e)}))}}},{key:"_quickSP",value:function(e,t,r){var n=["ritual","spell"],a=t.items.find((function(t){return n.includes(t.type)&&t.name==e.text()}));a&&t.setupSpell(a,{},r).then((function(e){t.basicTest(e)}))}},{key:"_quickLI",value:function(e,t,r){var n=["liturgy","ceremony"],a=t.items.find((function(t){return n.includes(t.type)&&t.name==e.text()}));a&&t.setupSpell(a,{},r).then((function(e){t.basicTest(e)}))}}],i=[{key:"_getActor",value:function(){var e,t=ChatMessage.getSpeaker();return t.token&&(e=game.actors.tokens[t.token]),e||(e=game.actors.get(t.actor)),e?{actor:e,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}},{key:"bindRollCommands",value:function(e){e.on("click",".request-roll",(function(e){return a.Z.showRQMessage($(e.currentTarget).attr("data-name"),Number($(e.currentTarget).attr("data-modifier"))||0),e.stopPropagation(),!1})),e.on("click",".request-GC",(function(e){return a.Z.showGCMessage($(e.currentTarget).attr("data-name"),Number($(e.currentTarget).attr("data-modifier"))||0),e.stopPropagation(),!1})),e.on("click",".request-CH",(function(e){return n.Z.check3D20(void 0,$(e.currentTarget).attr("data-name"),{modifier:Number($(e.currentTarget).attr("data-modifier"))||0}),e.stopPropagation(),!1}))}}],r&&l(t.prototype,r),i&&l(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();f(p,"skills",[]),f(p,"cmds",["sk","at","pa","sp","li","rq","gc","w","ch"])},947:(e,t,r)=>{r.d(t,{Z:()=>p});var n=r(577),a=r(491),o=r(586),i=r(122);function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(){c=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==s(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,c)}),(function(e){n("throw",e,i,c)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,i,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function u(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){u(o,n,a,i,s,"next",e)}function s(e){u(o,n,a,i,s,"throw",e)}i(void 0)}))}}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,s,u,p;return t=e,null,r=[{key:"chatListeners",value:function(t){t.on("click",".chat-condition",(function(t){e.postStatus($(t.currentTarget).attr("data-id"))})),t.on("click",".openJournalBrowser",(function(){return game.dsa5.apps.journalBrowser.render(!0)}));var r=$('<a class="button showHelp" data-tooltip="'.concat(game.i18n.localize("HELP.showHelp"),'"><i class="fas fa-question"></i></a>'));r.click((function(){e.getHelp()})),$(t.find(".control-buttons")).prepend(r),t.on("click",".showPatchViewer",(function(){return(0,o.j)()})),t.on("click",".functionswitch",(function(e){return i.Z[e.currentTarget.dataset.function](e)})),t.on("click",".panToToken",(function(t){return e.panToToken(t)}))}},{key:"panToToken",value:(p=l(c().mark((function e(t){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fromUuid(t.currentTarget.dataset.uuid);case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return");case 5:if(canvas.animatePan({x:r.x,y:r.y}),r.isOwner){e.next=8;break}return e.abrupt("return");case 8:r.object.control({releaseOthers:!0});case 9:case"end":return e.stop()}}),e)}))),function(e){return p.apply(this,arguments)})},{key:"postStatus",value:function(e){var t=CONFIG.statusEffects.find((function(t){return t.id==e})),r='<h2><a class="chat-condition chatButton" data-id="'.concat(e,'"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="').concat(t.icon,'"/>').concat(game.i18n.localize(t.label),"</h2></a><p>").concat(game.i18n.localize(t.description),"</p>");ChatMessage.create(a.Z.chatDataSetup(r,"roll"))}},{key:"getHelp",value:function(){var e=n.Z.helpContent.map((function(e){return"<h2>".concat(game.i18n.localize("HELP.".concat(e.name)),"</h2>\n            <p><b>").concat(game.i18n.localize("HELP.command"),"</b>: ").concat(e.command,"</p>\n            <p><b>").concat(game.i18n.localize("HELP.example"),"</b>: ").concat(e.example,"</p>\n            <p><b>").concat(game.i18n.localize("Description"),"</b>: ").concat(game.i18n.localize("HELP.descr".concat(e.name)))})).join("")+"<br>\n            <p>".concat(game.i18n.localize("HELP.default"),"</p>");ChatMessage.create(a.Z.chatDataSetup(e,"roll"))}},{key:"showConditions",value:function(){var e=duplicate(CONFIG.statusEffects).map((function(e){return e.label=game.i18n.localize(e.label),e})).sort((function(e,t){return e.label.localeCompare(t.label)})).map((function(e){return'<a class="chat-condition chatButton" data-id="'.concat(e.id,'"><img src="').concat(e.icon,'"/>').concat(e.label,"</a>")})).join(" ");ChatMessage.create(a.Z.chatDataSetup(e,"roll"))}},{key:"check3D20",value:(u=l(c().mark((function e(t,r){var n,o,i,s=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.length>2&&void 0!==s[2]?s[2]:{},o=12,!t){e.next=10;break}return t=t.get(0),e.next=6,a.Z.skillByName(t.textContent);case 6:r=e.sent,t.dataset.attrs&&(o=t.dataset.attrs.split("|")),e.next=14;break;case 10:if(!r){e.next=14;break}return e.next=13,a.Z.skillByName(r);case 13:r=e.sent;case 14:return r&&(r=r.toObject()),r||(r={name:"3d20",type:"skill",system:{talentValue:{value:0},characteristic1:{value:"mu"},characteristic2:{value:"kl"},characteristic3:{value:"in"},RPr:{value:"no"},burden:{value:"no"}}}),e.next=18,a.Z.emptyActor(o);case 18:(i=e.sent).setupSkill(r,n,"emptyActor").then((function(e){i.basicTest(e)}));case 20:case"end":return e.stop()}}),e)}))),function(e,t){return u.apply(this,arguments)})},{key:"showTables",value:(s=l(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/templates/tables/systemtables.html",{tables:n.Z.systemTables});case 2:t=e.sent,ChatMessage.create(a.Z.chatDataSetup(t,"roll"));case 4:case"end":return e.stop()}}),e)}))),function(){return s.apply(this,arguments)})}],r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},577:(e,t,r)=>{r.d(t,{Z:()=>a});var n={statusEffects:[{icon:"icons/svg/skull.svg",id:"dead",label:"CONDITION.defeated",description:"CONDITIONDESCRIPTION.defeated",flags:{dsa5:{value:null,editable:!0}}},{id:"inpain",label:"CONDITION.inpain",icon:"icons/svg/blood.svg",description:"CONDITIONDESCRIPTION.inpain",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"prone",label:"CONDITION.prone",icon:"icons/svg/falling.svg",description:"CONDITIONDESCRIPTION.prone",flags:{dsa5:{value:null,editable:!0}}},{id:"unconscious",label:"CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"CONDITIONDESCRIPTION.unconscious",flags:{dsa5:{value:null,editable:!0}}},{id:"rooted",label:"CONDITION.rooted",icon:"icons/svg/net.svg",description:"CONDITIONDESCRIPTION.rooted",flags:{dsa5:{value:null,editable:!0}}},{id:"fixated",label:"CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"CONDITIONDESCRIPTION.fixated",flags:{dsa5:{value:null,editable:!0}}},{id:"surprised",label:"CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"CONDITIONDESCRIPTION.surprised",flags:{dsa5:{value:null,editable:!0}}},{id:"blind",label:"CONDITION.blind",icon:"icons/svg/blind.svg",description:"CONDITIONDESCRIPTION.blind",flags:{dsa5:{value:null,editable:!0}}},{id:"poisoned",label:"CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"CONDITIONDESCRIPTION.poisoned",flags:{dsa5:{value:null,editable:!0}}},{id:"sick",label:"CONDITION.sick",icon:"icons/svg/biohazard.svg",description:"CONDITIONDESCRIPTION.sick",flags:{dsa5:{value:null,editable:!0}}},{id:"deaf",label:"CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"CONDITIONDESCRIPTION.deaf",flags:{dsa5:{value:null,editable:!0}}},{id:"burning",label:"CONDITION.burning",icon:"icons/svg/fire.svg",description:"CONDITIONDESCRIPTION.burning",flags:{dsa5:{value:1,editable:!0,max:3}}},{id:"invisible",label:"CONDITION.invisible",icon:"icons/svg/circle.svg",description:"CONDITIONDESCRIPTION.invisible",flags:{dsa5:{value:null,editable:!0}}},{id:"constricted",label:"CONDITION.constricted",icon:"icons/svg/cave.svg",description:"CONDITIONDESCRIPTION.constricted",flags:{dsa5:{value:null,editable:!0}}},{id:"bloodrush",label:"CONDITION.bloodrush",icon:"icons/svg/bones.svg",description:"CONDITIONDESCRIPTION.bloodrush",changes:[{key:"system.skillModifiers.step",mode:0,value:"Kraftakt 2;Feat of Strength 2"}],flags:{dsa5:{value:null,editable:!0}}},{id:"mute",label:"CONDITION.mute",icon:"icons/svg/silenced.svg",description:"CONDITIONDESCRIPTION.mute",flags:{dsa5:{value:null,editable:!0}}},{id:"incapacitated",label:"CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"CONDITIONDESCRIPTION.incapacitated",flags:{dsa5:{value:null,editable:!0}}},{id:"encumbered",label:"CONDITION.encumbered",icon:"icons/svg/anchor.svg",description:"CONDITIONDESCRIPTION.encumbered",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"stunned",label:"CONDITION.stunned",icon:"icons/svg/daze.svg",description:"CONDITIONDESCRIPTION.stunned",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"raptured",label:"CONDITION.raptured",icon:"icons/svg/ice-aura.svg",description:"CONDITIONDESCRIPTION.raptured",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"feared",label:"CONDITION.feared",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.feared",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"paralysed",label:"CONDITION.paralysed",icon:"icons/svg/paralysis.svg",description:"CONDITIONDESCRIPTION.paralysed",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"confused",label:"CONDITION.confused",icon:"icons/svg/stoned.svg",description:"CONDITIONDESCRIPTION.confused",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"minorSpirits",label:"CONDITION.minorSpirits",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.minorSpirits",changes:[{key:"system.skillModifiers.global",mode:0,value:-1}],duration:{seconds:600},flags:{dsa5:{value:null,editable:!0}}},{id:"services",label:"PLAYER.services",icon:"icons/svg/aura.svg",description:"CONDITIONDESCRIPTION.services",flags:{dsa5:{value:1,editable:!0,max:500,hideOnToken:!0}}}],armorSubcategories:{0:4,1:5,2:6,3:8,4:9,5:13,6:12,7:11,8:10},weaponStabilities:{Blowpipes:10,Bows:4,Brawling:12,"Chain Weapons":10,Crossbows:6,Daggers:14,Discuses:12,Fans:13,"Fencing Weapons":8,"Impact Weapons":12,Lances:6,Pikes:12,Polearms:12,Shields:10,Slingshots:4,Swords:13,"Throwing Weapons":10,"Two-Handed Impact Weapons":11,"Two-Handed Swords":12,Whips:4},localizedCompendiums:{de:["dsa5.skills","dsa5.combatskills","dsa5.species","dsa5.patzer"],en:["dsa5.skillsen","dsa5.combatskillsen","dsa5.speciesen","dsa5.botch"]},combatSkillSubCategories:{0:"COMBATSKILLCATEGORY.0",1:"COMBATSKILLCATEGORY.1",2:"COMBATSKILLCATEGORY.2",3:"COMBATSKILLCATEGORY.3",4:"COMBATSKILLCATEGORY.4"}};n.effectTextStyle=CONFIG.canvasTextStyle.clone(),n.effectTextStyle.fontSize="30",n.effectTextStyle.fontFamily="GentiumBasic",n.knownShortcuts={},n.gearModifyableCalculatedAttributes=["fatePoints","initiative","speed","astralenergy","karmaenergy","wounds","dodge","soulpower","toughness"],n.defaultWeapon={name:"default",type:"meleeweapon",effects:[],system:{type:"meleeweapon",crit:1,botch:20,reach:{value:"short"},damage:{value:"1d6"},atmod:{value:0,offHandMod:0},pamod:{value:0,offHandMod:0},guidevalue:{value:"ge/kk"},damageThreshold:{value:"5000"},worn:{offhand:!1}}},n.characteristics={mu:"CHAR.MU",kl:"CHAR.KL",in:"CHAR.IN",ch:"CHAR.CH",ff:"CHAR.FF",ge:"CHAR.GE",ko:"CHAR.KO",kk:"CHAR.KK"},n.equipmentTypes={misc:"Equipment.misc",clothes:"Equipment.clothes",tools:"Equipment.tools",light:"Equipment.light",healing:"Equipment.healing",bags:"Equipment.bags",wealth:"Equipment.wealth",writing:"Equipment.writing",alchemy:"Equipment.alchemy",service:"Equipment.service",luxus:"Equipment.luxus",blessed:"Equipment.blessed"},n.equipmentCategories=["meleeweapon","rangeweapon","equipment","ammunition","armor","poison","consumable","plant"],n.systemTables=[{name:"Defense",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"defenseBotchTableEnabled"}},{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"meleeBotchTableEnabled"}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"rangeBotchTableEnabled"}},{name:"Liturgy",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}},{name:"Spell",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}}],n.morePackages={},n.narrowSpaceModifiers={weaponshort:{attack:0,parry:0,label:"NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:-4,parry:-4,label:"NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-8,parry:-8,label:"NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:-2,parry:-2,label:"NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:-4,parry:-3,label:"NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-6,parry:-4,label:"NarrowSpaceModifiers.shield.long"}},n.moneyNames={D:"Money-D",S:"Money-S",H:"Money-H",K:"Money-K"},n.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}},n.regnerationCampLocations={0:"regnerationCampLocations.normal","-1":"regnerationCampLocations.bad",1:"regnerationCampLocations.good"},n.regenerationInterruptOptions={0:"regenerationInterruptOptions.none","-1":"regenerationInterruptOptions.small","-2":"regenerationInterruptOptions.big"},n.targetMomevementOptions={0:"rangeMovementOptions.SLOW","-2":"rangeMovementOptions.FAST",2:"rangeMovementOptions.STATIONARY"},n.shooterMovementOptions={0:"rangeMovementOptions.SHOOTERSTATIONARY","-2":"rangeMovementOptions.SHOOTERMOVING","-4":"rangeMovementOptions.SHOOTERRUNNING"},n.mountedRangeOptions={0:"mountedRangeOptions.STATIONARY","-4":"mountedRangeOptions.SCHRITT","-8":"mountedRangeOptions.GALOPP"},n.drivingArcherOptions={0:"mountedRangeOptions.STATIONARY","-2":"mountedRangeOptions.SCHRITT","-4":"mountedRangeOptions.GALOPP"},n.aimOptions={0:"aimOptions.0",2:"aimOptions.1",4:"aimOptions.2"},n.traitCategories={meleeAttack:"closeCombatAttacks",rangeAttack:"rangeCombatAttacks",armor:"armor",general:"general",familiar:"familiar",trick:"trick",training:"training",entity:"entityAbility",summoning:"summoningPackage"},n.ritualLocationModifiers={0:"-",1:"RITUALMODIFIER.holysite","-3":"RITUALMODIFIER.wrongsite"},n.ritualTimeModifiers={0:"-",1:"RITUALMODIFIER.matchingConstellation","-1":"RITUALMODIFIER.wrongConstellation"},n.ceremonyLocationModifiers={0:"-",2:"CEREMONYMODIFIER.holysite",1:"CEREMONYMODIFIER.temple","-1":"CEREMONYMODIFIER.otherTemple","-2":"CEREMONYMODIFIER.enemyGod","-3":"CEREMONYMODIFIER.archDemon","-4":"CEREMONYMODIFIER.nameless","-5":"CEREMONYMODIFIER.nemesis"},n.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,30,45,60,75,90,105,120,135,150,165,180]},n.hooks={},n.startXP={900:"EXP.inexperienced",1e3:"EXP.average",1100:"EXP.experienced",1200:"EXP.competent",1400:"EXP.masterful",1700:"EXP.brillant",2100:"EXP.legendary"},n.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /sp [a-z]*, /li [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk betren"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq betren"},{name:"threeD20Check",command:"/ch",example:"/ch"},{name:"groupcheck",command:"/gc",example:"/gc"}],n.ceremonyTimeModifiers={0:"-",1:"CEREMONYMODIFIER.monthGod",2:"CEREMONYMODIFIER.celebration","-5":"CEREMONYMODIFIER.namelessDays"},n.mageLevels={mundane:"mundane",clerical:"clerical",magical:"magical"},n.specialAbilityCategories={general:"general",Combat:"Combat",fatePoints:"fatePoints",magical:"magical",clerical:"clerical",language:"language",animal:"animal",staff:"traditionArtifact",ceremonial:"ceremonialItem",pact:"pactgift"},n.addvantageRules={},n.removevantageRules={},n.vantagesNeedingAdaption={},n.addAbilityRules={},n.removeAbilityRules={},n.AbilitiesNeedingAdaption={},n.addTraitRules={},n.rangeWeaponModifiers={short:"RangeMod.short",medium:"RangeMod.medium",long:"RangeMod.long",rangesense:"RangeMod.rangesense",extreme:"RangeMod.extreme"},n.meleeRangesArray=["short","medium","long"],n.meleeRanges={short:"Range-short",medium:"Range-medium",long:"Range-long"},n.weapontypes={melee:"meleeweapon",range:"rangeweapon"},n.ammunitiongroups={"-":"-",arrow:"arrow",bolt:"bolt",bullet:"bullet",stone:"stone",dart:"dart",mag:"mag",infinite:"infinite"},n.combatskillsGuidevalues={ff:"CHAR.FF",ge:"CHAR.GE",kk:"CHAR.KK","ge/kk":"CHAR.GEKK"},n.skillDifficultyModifiers={eeasy:5,veasy:3,easy:1,challenging:0,difficult:-1,hard:-3,vhard:-5},n.magicResistanceModifiers={"-":"-",SK:"soulpower",ZK:"toughness"},n.sizeCategories={tiny:"SIZE.tiny",small:"SIZE.small",average:"SIZE.average",big:"SIZE.big",giant:"SIZE.giant"},n.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4},n.rangeSizeCategories={tiny:"RANGESIZE.tiny",small:"RANGESIZE.small",average:"RANGESIZE.average",big:"RANGESIZE.big",giant:"RANGESIZE.giant"},n.shieldSizes={short:"SIZE.small",medium:"SIZE.average",long:"SIZE.big"},n.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8},n.rangeVision={0:"VisionDisruption.step0","-2":"VisionDisruption.step1","-4":"VisionDisruption.step2","-6":"VisionDisruption.step3","-5000":"VisionDisruption.step4"},n.meleeRangeVision=function(e){return n="meleeVisionDisruption.4",(r="attack"==e?"*0,5":"-5000")in(t={"+0":"meleeVisionDisruption.0","-1":"meleeVisionDisruption.1","-2":"meleeVisionDisruption.2","-3":"meleeVisionDisruption.3"})?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t;var t,r,n},n.attributeDifficultyModifiers={eeasy:6,veasy:4,easy:2,challenging:0,difficult:-2,hard:-4,vhard:-6},n.skillDifficultyLabels={eeasy:"Skill-eeasy",veasy:"Skill-veasy",easy:"Skill-easy",challenging:"Skill-challenging",difficult:"Skill-difficult",hard:"Skill-hard",vhard:"Skill-vhard"},n.attributeDifficultyLabels={eeasy:"Attribute-eeasy",veasy:"Attribute-veasy",easy:"Attribute-easy",challenging:"Attribute-challenging",difficult:"Attribute-difficult",hard:"Attribute-hard",vhard:"Attribute-vhard"},n.skillGroups={body:"SKILL.body",social:"SKILL.social",knowledge:"SKILL.knowledge",trade:"SKILL.trade",nature:"SKILL.nature"},n.features=["Object","Spheres","Influence","Clairvoyance","Healing","Transformation","Telekinesis","Elemental","Illusion","Anti-Magic","Demonic","Temporal"],n.skillBurdens={yes:"yes",no:"no",maybe:"maybe"},n.StFs={A:"A",B:"B",C:"C",D:"D"},CONFIG.time.roundTime=5,CONFIG.time.turnTime=0;const a=n},472:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>CreatureType});var _utility_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(491);function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=_superPropBase(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},_get.apply(this,arguments)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var r,n=_getPrototypeOf(e);if(t){var a=_getPrototypeOf(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return _possibleConstructorReturn(this,r)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _regeneratorRuntime(){_regeneratorRuntime=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==_typeof(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function asyncGeneratorStep(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){asyncGeneratorStep(o,n,a,i,s,"next",e)}function s(e){asyncGeneratorStep(o,n,a,i,s,"throw",e)}i(void 0)}))}}Hooks.once("ready",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(CreatureType.creatureData){e.next=11;break}return e.next=3,fetch("systems/dsa5/lazy/creaturetype/".concat(game.i18n.lang,".json"));case 3:return t=e.sent,e.next=6,t.json();case 6:CreatureType.creatureData=e.sent,CreatureType.magical=game.i18n.localize("WEAPON.magical"),CreatureType.clerical=game.i18n.localize("WEAPON.clerical"),CreatureType.silverPlated=game.i18n.localize("WEAPON.silverPlated"),game.dsa5.apps.CreatureType=CreatureType;case 11:case"end":return e.stop()}}),e)}))));var isNotEmpty=function(e){return!(!e||0===e.length)},CreatureType=function(){function CreatureType(e){_classCallCheck(this,CreatureType),this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}return _createClass(CreatureType,[{key:"ignoredCondition",value:function(e){return!1}},{key:"damageModifier",value:function(e){return[]}},{key:"spellImmunity",value:function(e){return this.spellImmunities.some((function(t){return e.includes(t)}))}},{key:"spellArmorModifier",value:function(e){return 0}},{key:"poisonImmunity",value:function(){return this.poisonImmunity}},{key:"diseaseImmunity",value:function(){return this.diseaseImmunity}},{key:"spellResistanceModifier",value:function(e){return 0}},{key:"weaponAttributes",value:function(e){return getProperty(e,"system.effect.attributes")||""}},{key:"getTypeByClass",value:function(e){return Object.keys(CreatureType.creatureData.types).find((function(t){return CreatureType.creatureData.types[t]===e}))}},{key:"isAttackItem",value:function(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&isNotEmpty(this.weaponAttributes(e))}},{key:"attributesRegex",value:function(e){var t=this.weaponAttributes(e);return new RegExp("(".concat(t.split(",").map((function(e){return _utility_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z.escapeRegex(e.split("(")[0].trim())})).join("|"),")"),"i")}}],[{key:"detectCreatureType",value:function detectCreatureType(actor){if("creature"==actor.type){var creatureClass=actor.system.creatureClass.value,types=Object.keys(CreatureType.creatureData.types).filter((function(e){return creatureClass.indexOf(e)>=0}));return types.map((function(x){return eval("new ".concat(CreatureType.creatureData.types[x],"(creatureClass)"))}))}return[]}},{key:"addCreatureTypeModifiers",value:function(e,t,r,n){var a,o=CreatureType.detectCreatureType(e),i=["spell","ceremony","liturgy","ritual"].includes(t.type),s=_createForOfIteratorHelper(o);try{for(s.s();!(a=s.n()).done;){var c=a.value,u=c.damageModifier(t);if(i){var l,f=_createForOfIteratorHelper(u);try{for(f.s();!(l=f.n()).done;)l.value.armorPen=c.spellResistanceModifier(e)}catch(e){f.e(e)}finally{f.f()}}r.push.apply(r,_toConsumableArray(u))}}catch(e){s.e(e)}finally{s.f()}r.push.apply(r,_toConsumableArray(this.creatureBonusDamage(e,n))),CreatureType.addVulnerabilitiesToSource(e,t,r)}},{key:"addVulnerabilitiesToSource",value:function(e,t,r){var n=getProperty(e,"system.vulnerabilities");n&&["meleeweapon","rangeweapon"].includes(t.type)&&getProperty(n,"combatskill").reduce((function(e,n){if(n.target==t.system.combatskill.value){var a=(/\*/.test(n.value)?Number(n.value.replace("*",""))>1:Number(n.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";r.push.apply(r,_toConsumableArray(CreatureType.buildDamageMod("".concat(game.i18n.format(a,{name:t.system.combatskill.value})," (").concat(n.source,")"),n.value)))}}),r)}},{key:"creatureBonusDamage",value:function(e,t){var r=[];if("creature"==e.type){var n,a=getProperty(t,"system.creatureBonus"),o=e.system.creatureClass.value,i=_createForOfIteratorHelper(a);try{for(i.s();!(n=i.n()).done;){var s=n.value;o.indexOf(s.target)>=0&&r.push.apply(r,_toConsumableArray(this.buildDamageMod(s.source,s.value,!0)))}}catch(e){i.e(e)}finally{i.f()}}return r}},{key:"buildDamageMod",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return[{name:e,value:t,selected:r,type:"dmg"}]}}]),CreatureType}();_defineProperty(CreatureType,"creatureData",void 0),_defineProperty(CreatureType,"magical",void 0),_defineProperty(CreatureType,"clerical",void 0);var VulnerableToLifeGods=function(e){_inherits(r,e);var t=_createSuper(r);function r(){return _classCallCheck(this,r),t.apply(this,arguments)}return _createClass(r,[{key:"damageModifier",value:function(e){if(this.isAttackItem(e)){var t,n=this.attributesRegex(e),a=_createForOfIteratorHelper(CreatureType.creatureData.godOfLife);try{for(a.s();!(t=a.n()).done;){var o=t.value,i="".concat(CreatureType.clerical," (").concat(o,")");if(n.test(i))return CreatureType.buildDamageMod(i,"*2")}}catch(e){a.e(e)}finally{a.f()}}return _get(_getPrototypeOf(r.prototype),"damageModifier",this).call(this,e)}}]),r}(CreatureType),ChimeraType=null,DaimonidType=null,DragonType=null,DemonType=null,ElementalType=null,FairyType=null,GhostType=null,GolemType=null,HomunculiType=null,IntelligentCreatureType=null,PlantType=null,AnimalType=null,UndeadType=null,SupernaturalType=null,MagicalConstructType=null,WerCreatureType=null,VampireType=null},565:(e,t,r)=>{function n(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?a(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){c=!0,i=e},f:function(){try{s||null==r.return||r.return()}finally{if(c)throw i}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}r.d(t,{Z:()=>i});var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,r=[{key:"rangeFinder",value:function(e,t){var r=canvas.scene.grid.size,n=new Ray(e,t).distance/r,a=n*canvas.scene.grid.distance,o=Math.abs((getProperty(e,"system.elevation")||0)-(getProperty(t,"system.elevation")||0));return{elevation:o,distance:a,distanceSum:Math.hypot(a,o),tileDistance:n,unit:canvas.scene.grid.units}}},{key:"inDistance",value:function(e){var t,r=n(canvas.scene.tokens);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.isOwner&&this.rangeFinder(e,a.object).tileDistance<=2)return!0}}catch(e){r.e(e)}finally{r.f()}return!1}},{key:"distanceModifier",value:function(t,r,a){if(!game.settings.get("dsa5","enableDPS")||!t)return 1;var o,i={},s=n(game.user.targets);try{for(s.s();!(o=s.n()).done;){var c=o.value,u=e.rangeFinder(t,c);(i.distanceSum||0)<u.distanceSum&&(i=u)}}catch(e){s.e(e)}finally{s.f()}if(i.unit==game.i18n.localize("gridUnits")){for(var l=Number(getProperty(a,"system.rangeMultiplier"))||1,f=r.system.reach.value.split("/").map((function(e){return Number(e)*l})),p=0;p<2&&f[p]<i.distanceSum;)p++;return p}return 1}},{key:"initDoorMinDistance",value:function(){var t=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(r){return game.user.isGM||!game.settings.get("dsa5","enableDPS")||e.inDistance(this)?t.apply(this,arguments):ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"))}}}],null&&o(t.prototype,null),r&&o(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},562:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DiceDSA5});var _actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(369),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(577),_dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(15),_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(491),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(272),_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(173),_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(101),_item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(839),_status_status_effects_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(973),_opposed_dsa5_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(600),_status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(61),_dsa_soundeffect_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(803),_equipment_damage_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(702),_dialog_dialog_equipmentdamage_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(266),_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(430),_request_roll_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(903);function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function _regeneratorRuntime(){_regeneratorRuntime=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==_typeof(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){asyncGeneratorStep(o,n,a,i,s,"next",e)}function s(e){asyncGeneratorStep(o,n,a,i,s,"throw",e)}i(void 0)}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var DiceDSA5=function(){function DiceDSA5(){_classCallCheck(this,DiceDSA5)}var _chatListeners,_gearDamaged,_rollEdit2,_itemRoll2,_showDiceSoNice,_rollDices,_updateDefenseCount,_rollTest,_rollItem,_rollTalent,_rollThreeD,_rollSpell,_manualRolls,_rollCombatskill,_addRollDiceSoNice2,_detailedWeaponResult,_rollWeapon,_evaluateDamage,_stringToRoll2,_rollCombatTrait,_rollDamage,_damageFormula,_rollAttribute,_rollStatus,_rollRegeneration,_rollSingleD,_getDefenseCount,_setupDialog;return _createClass(DiceDSA5,null,[{key:"setupDialog",value:(_setupDialog=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.dialogOptions,n=t.testData,a=t.cardOptions,e.next=3,game.settings.get("core","rollMode");case 3:return o=e.sent,i="challenging","function"==typeof n.source.toObject&&(n.source=n.source.toObject(!1)),mergeObject(n,{testDifficulty:i}),mergeObject(r.data,{testDifficulty:i,testModifier:r.data.modifier||0}),s=r.data.situationalModifiers?r.data.situationalModifiers:n.extra.actor?_status_status_effects_js__WEBPACK_IMPORTED_MODULE_8__.Z.getRollModifiers(n.extra.actor,n.source):[],null!=n.extra.options.moreModifiers&&(c=s).push.apply(c,_toConsumableArray(n.extra.options.moreModifiers)),u=[],game.user.targets.forEach((function(e){e.actor&&u.push({name:e.actor.name,id:e.id,img:e.actor.img})})),e.t0=mergeObject,e.t1=r.data,e.t2=s.length>0,e.t3=s,e.t4=r.data.rollMode||o,e.t5=CONFIG.Dice.rollModes?CONFIG.Dice.rollModes:CONFIG.rollModes,e.next=20,this.getDefenseCount(n);case 20:if(e.t6=e.sent,e.t7=u,e.t8={hasSituationalModifiers:e.t2,situationalModifiers:e.t3,rollMode:e.t4,rollModes:e.t5,defenseCount:e.t6,targets:e.t7},(0,e.t0)(e.t1,e.t8),mergeObject(a,{user:game.user.id}),n.extra.options.bypass){e.next=32;break}return e.next=28,renderTemplate(r.template,r.data);case 28:return l=e.sent,e.abrupt("return",new Promise((function(e,t){var a=_dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getDialogForItem(n.source.type);new a({title:r.title,content:l,buttons:a.getRollButtons(n,r,e,t),default:"rollButton"}).recallSettings(n.extra.speaker,n.source,n.mode).render(!0)})));case 32:return a.rollMode=n.extra.options.rollMode||o,n.situationalModifiers||(n.situationalModifiers=[]),e.abrupt("return",{testData:n,cardOptions:a});case 35:case"end":return e.stop()}}),e,this)}))),function(e){return _setupDialog.apply(this,arguments)})},{key:"getDefenseCount",value:(_getDefenseCount=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.combat){e.next=4;break}return e.next=3,game.combat.getDefenseCount(t.extra.speaker);case 3:return e.abrupt("return",e.sent);case 4:return e.abrupt("return",0);case 5:case"end":return e.stop()}}),e)}))),function(e){return _getDefenseCount.apply(this,arguments)})},{key:"_rollSingleD20",value:(_rollSingleD=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n,a,o){var i,s,c,u,l,f,p,d,h,m,y,v,g,b,w=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=w.length>5&&void 0!==w[5]?w[5]:"",s=w.length>6&&void 0!==w[6]?w[6]:1,c="",u=[],r+=a,r=Math.round(r*s),l=r-t.terms[0].results[0].result,f=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration(n),u.push({char:n,res:t.terms[0].results[0].result,suc:l>=0,tar:r}),e.next=11,new Roll("1d20").evaluate({async:!0});case 11:if(p=e.sent,d=l>=0?1:-1,h=20,m=1,"meleeweapon"==o.source.type&&(h=Math.min(o.extra.actor.system.meleeStats.botch,o.source.system.botch),m=Math.max(o.extra.actor.system.meleeStats.crit,o.source.system.crit)),"rangeweapon"==o.source.type&&(h=Math.min(o.extra.actor.system.rangeStats.botch,o.source.system.botch),m=Math.max(o.extra.actor.system.rangeStats.crit,o.source.system.crit)),/(\(|,)( )?i\)$/.test(o.source.name)&&(_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.hasAbility(o.extra.actor,game.i18n.localize("LocalizedIDs.improvisedWeaponMaster"))||(h=Math.min(19,h)),this._appendSituationalModifiers(o,"".concat(game.i18n.localize("CHAR.ATTACK")," - ").concat(game.i18n.localize("WEAPON.improvised")),2,"defenseMalus")),o.situationalModifiers.find((function(e){return e.name==game.i18n.localize("opportunityAttack")&&0!=e.value}))&&(h=50,m=-50),1!=t.terms[0].results.filter((function(e){return e.result<=m})).length){e.next=41;break}if(c=game.i18n.localize("CriticalSuccess"),!game.settings.get("dsa5","noConfirmationRoll")){e.next=25;break}d=3,e.next=39;break;case 25:return e.next=27,DiceDSA5.manualRolls(p,"confirmationRoll",o.extra.options);case 27:if(p=e.sent,y=r-p.terms[0].results[0].result,!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(o.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.weaponAptitude")," (").concat(i,")"))||y>=0){e.next=36;break}return v=p.terms[0].results[0].result,e.next=33,new Roll("1d20").evaluate({async:!0});case 33:p=e.sent,y=r-p.terms[0].results[0].result,c+=", "+game.i18n.format("usedWeaponExpertise",{a:v,b:p.terms[0].results[0].result});case 36:this._addRollDiceSoNice(o,p,f),u.push({char:n,res:p.terms[0].results[0].result,suc:y>=0,tar:r}),d=y>=0?3:2;case 39:e.next=61;break;case 41:if(1!=t.terms[0].results.filter((function(e){return e.result>=h})).length){e.next=61;break}if(c=game.i18n.localize("CriticalFailure"),!game.settings.get("dsa5","noConfirmationRoll")){e.next=47;break}d=-3,e.next=61;break;case 47:return e.next=49,DiceDSA5.manualRolls(p,"confirmationRoll",o.extra.options);case 49:if(p=e.sent,g=r-p.terms[0].results[0].result,!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(o.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.weaponAptitude")," (").concat(i,")"))||g>=0){e.next=58;break}return b=p.terms[0].results[0].result,e.next=55,new Roll("1d20").evaluate({async:!0});case 55:p=e.sent,g=r-p.terms[0].results[0].result,c+=", "+game.i18n.format("usedWeaponExpertise",{a:b,b:p.terms[0].results[0].result});case 58:this._addRollDiceSoNice(o,p,f),u.push({char:n,res:p.terms[0].results[0].result,suc:g>=0,tar:r}),d=g>=0?-2:-3;case 61:return""==c?c=game.i18n.localize(l>=0?"Success":"Failure"):game.settings.get("dsa5","noConfirmationRoll")||(3==Math.abs(d)?c="".concat(game.i18n.localize("confirmed")," ").concat(c):2==Math.abs(d)&&(c="".concat(game.i18n.localize("unconfirmed")," ").concat(c))),e.abrupt("return",{successLevel:d,characteristics:u,description:c,preData:o,modifiers:a,extra:{}});case 63:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a){return _rollSingleD.apply(this,arguments)})},{key:"rollRegeneration",value:(_rollRegeneration=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p,d;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._situationalModifiers(t),n=t.roll,a=[],o={rollType:"regenerate",preData:t,modifiers:r,extra:{}},i=["LeP"],t.extra.actor.system.isMage&&i.push("AsP"),t.extra.actor.system.isPriest&&i.push("KaP"),s=0,t.extra.actor.effects.some((function(e){return"sick"==getProperty(e,"flags.core.statusId")}))){this._appendSituationalModifiers(t,game.i18n.localize("CONDITION.sick"),"*0"),c=_createForOfIteratorHelper(i);try{for(c.s();!(u=c.n()).done;)l=u.value,a.push({char:l,res:0,die:"d6"}),o[l]=0,s+=2}catch(e){c.e(e)}finally{c.f()}}else{f=_createForOfIteratorHelper(i);try{for(f.s();!(p=f.n()).done;)d=p.value,this._appendSituationalModifiers(t,game.i18n.localize("LocalizedIDs.regeneration".concat(d)),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(t.extra.actor,game.i18n.localize("LocalizedIDs.regeneration".concat(d))),d),this._appendSituationalModifiers(t,game.i18n.localize("LocalizedIDs.weakRegeneration".concat(d)),-1*_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(t.extra.actor,game.i18n.localize("LocalizedIDs.weakRegeneration".concat(d))),d),this._appendSituationalModifiers(t,game.i18n.localize("LocalizedIDs.advancedRegeneration".concat(d)),_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.abilityStep(t.extra.actor,game.i18n.localize("LocalizedIDs.advancedRegeneration".concat(d))),d),this._appendSituationalModifiers(t,"".concat(game.i18n.localize("CHARAbbrev.".concat(d))," ").concat(game.i18n.localize("Modifier")),t["".concat(d,"Modifier")],d),this._appendSituationalModifiers(t,"".concat(game.i18n.localize("CHARAbbrev.".concat(d))," ").concat(game.i18n.localize("regenerate")),t["regeneration".concat(d)],d),a.push({char:d,res:n.terms[s].results[0].result,die:"d6"}),o[d]=Math.round(Math.max(0,Number(n.terms[s].results[0].result)+Number(r)+this._situationalModifiers(t,d))*Number(t.regenerationFactor)),s+=2}catch(e){f.e(e)}finally{f.f()}}return o.characteristics=a,e.abrupt("return",o);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return _rollRegeneration.apply(this,arguments)})},{key:"rollStatus",value:(_rollStatus=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.roll,e.t0){e.next=5;break}return e.next=4,new Roll("1d20").evaluate({async:!0});case 4:e.t0=e.sent;case 5:return r=e.t0,e.next=8,this._rollSingleD20(r,t.source.system.max,t.extra.statusId,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 8:if((n=e.sent).rollType="dodge",!(a="dodge"==t.extra.statusId)||3!=n.successLevel){e.next=21;break}return e.next=14,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalMeleeDefense");case 14:if(!e.sent){e.next=18;break}n.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalMeleeDefense",!1),e.next=19;break;case 18:n.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultParryCrit();case 19:e.next=32;break;case 21:if(!a||-3!=n.successLevel){e.next=32;break}return e.next=24,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Defense");case 24:if(!e.sent){e.next=28;break}n.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Defense",!0),e.next=32;break;case 28:return e.t1=n.description,e.next=31,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultBotch();case 31:n.description=e.t1+=e.sent;case 32:return e.abrupt("return",n);case 33:case"end":return e.stop()}}),e,this)}))),function(e){return _rollStatus.apply(this,arguments)})},{key:"rollAttribute",value:(_rollAttribute=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.roll){e.next=4;break}e.t0=t.roll,e.next=7;break;case 4:return e.next=6,new Roll("1d20").evaluate({async:!0});case 6:e.t0=e.sent;case 7:return r=e.t0,this._appendSituationalModifiers(t,game.i18n.localize("Difficulty"),t.testDifficulty),e.next=11,this._rollSingleD20(r,t.source.system.value,t.extra.characteristicId,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 11:return(n=e.sent).rollType="attribute",e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)}))),function(e){return _rollAttribute.apply(this,arguments)})},{key:"damageFormula",value:(_damageFormula=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"meleeweapon"==t.source.type?(n=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.extra.actor.items.find((function(e){return"combatskill"==e.type&&e.name==t.source.system.combatskill.value})),t.extra.actor.system),r=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareMeleeWeapon(t.source,[n],t.extra.actor)):"rangeweapon"==t.source.type?(a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.extra.actor.items.find((function(e){return"combatskill"==e.type&&e.name==t.source.system.combatskill.value})),t.extra.actor.system),r=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareRangeWeapon(t.source,[],[a],t.extra.actor)):r=t.source.system,e.abrupt("return",t.source.system.damage.value.replace(/[Ww]/g,"d")+"+".concat(r.extraDamage||0));case 2:case"end":return e.stop()}}),e)}))),function(e){return _damageFormula.apply(this,arguments)})},{key:"rollDamage",value:(_rollDamage=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._situationalModifiers(t),n=[],a=t.roll,o=a.total+r,i=_createForOfIteratorHelper(a.terms);try{for(i.s();!(s=i.n()).done;)if((c=s.value)instanceof Die||"Die"==c.class){u=_createForOfIteratorHelper(c.results);try{for(u.s();!(l=u.n()).done;)f=l.value,n.push({char:t.mode,res:f.result,die:"d"+c.faces})}catch(e){u.e(e)}finally{u.f()}}}catch(e){i.e(e)}finally{i.f()}return e.abrupt("return",{rollType:"damage",damage:o,characteristics:n,preData:t,modifiers:r,extra:{}});case 7:case"end":return e.stop()}}),e,this)}))),function(e){return _rollDamage.apply(this,arguments)})},{key:"_situationalModifiers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e.situationalModifiers.reduce((function(e,r){return e+((r.type==t||""==t&&null==r.type)&&Number(r.value)||0)}),0)}},{key:"_situationalPartCheckModifiers",value:function(e){return e.situationalModifiers.reduce((function(e,t){if("TPM"==t.type){var r=t.value.split("|");return 3!=r.length||(e[0]=e[0]+Number(r[0]),e[1]=e[1]+Number(r[1]),e[2]=e[2]+Number(r[2])),e}return e}),[0,0,0])}},{key:"_situationalMultipliers",value:function(e){return e.situationalModifiers.reduce((function(e,t){return e*("*"==t.type&&Number("".concat(t.value).replace(/,/,"."))||1)}),1)}},{key:"_appendSituationalModifiers",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",a=e.situationalModifiers.find((function(e){return e.name==t}));a?a.value=r:e.situationalModifiers.push({name:t,value:r,type:n})}},{key:"_getNarrowSpaceModifier",value:function(e,t){return t.narrowSpace?game.i18n.localize("LocalizedIDs.Shields")==e.system.combatskill.value?_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.narrowSpaceModifiers["shield"+e.system.reach.shieldSize][t.mode]:_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.narrowSpaceModifiers["weapon"+e.system.reach.value][t.mode]:0}},{key:"rollCombatTrait",value:(_rollCombatTrait=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.roll,e.t0){e.next=5;break}return e.next=4,new Roll("1d20").evaluate({async:!0});case 4:e.t0=e.sent;case 5:return r=e.t0,n=t.source,a="meleeAttack"==n.system.traitType.value,o="attack"==t.mode,a?(i={system:{combatskill:{value:"-"},reach:{value:n.system.reach.value}}},this._appendSituationalModifiers(t,game.i18n.localize("narrowSpace"),this._getNarrowSpaceModifier(i,t)),this._appendSituationalModifiers(t,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(i,t))):this._appendSituationalModifiers(t,game.i18n.localize("distance"),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.rangeMods[t.rangeModifier||"medium"].attack),e.next=12,this._rollSingleD20(r,Number(o?n.system.at.value:n.system.pa),t.mode,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 12:return s=e.sent,c=s.successLevel>0,e.next=16,this.detailedWeaponResult(s,t,n);case 16:if(!o||!c){e.next=19;break}return e.next=19,DiceDSA5.evaluateDamage(t,s,n,!a,s.doubleDamage);case 19:return s.rollType="weapon",(u=DiceDSA5.parseEffect(n))&&(s.parsedEffect=u),e.abrupt("return",s);case 23:case"end":return e.stop()}}),e,this)}))),function(e){return _rollCombatTrait.apply(this,arguments)})},{key:"_stringToRoll",value:(_stringToRoll2=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r){var n,a,o,i,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],a=/\d{1}[dDwW]\d/g,(o="".concat(t)).replace(a,(function(e){n.push(new Roll(e.replace(/[Ww]/,"d")).evaluate({async:!0}))})),e.next=6,Promise.all(n);case 6:return i=e.sent,s=o.replace(a,(function(){var e=i.shift();return r&&DiceDSA5._addRollDiceSoNice(r,e,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),e.total})),e.next=10,Roll.safeEval(s);case 10:return e.abrupt("return",e.sent);case 11:case"end":return e.stop()}}),e)}))),function(e,t){return _stringToRoll2.apply(this,arguments)})},{key:"evaluateDamage",value:(_evaluateDamage=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n,a,o){var i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E,S,L,T,D,P,A,j,C,I;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=n.system.damage.value.replace(/[Ww]/g,"d"),s=[],c=n.dmgMultipliers||[],u=c.map((function(e){return"".concat(e.name," *").concat(e.val)})),l=[],f=0,p=_createForOfIteratorHelper(t.situationalModifiers),e.prev=7,p.s();case 9:if((d=p.n()).done){e.next=33;break}if(h=d.value,m=0,h.armorPen&&l.push(h.armorPen),!h.damageBonus){e.next=31;break}if(!/^\*/.test(h.damageBonus)){e.next=17;break}return c.push({name:h.name,val:Number(h.damageBonus.replace("*",""))}),e.abrupt("continue",31);case 17:return y=/^=/.test(h.damageBonus),v="".concat(h.damageBonus).replace(/^=/,""),e.next=21,DiceDSA5._stringToRoll(v,t);case 21:if(g=e.sent,m=g*(h.step||1),!y){e.next=29;break}return i=v.replace(/[Ww]/,"d"),s.push({name:h.name,roll:g}),e.abrupt("continue",31);case 29:h.damageBonus=g,f+=m;case 31:e.next=9;break;case 33:e.next=38;break;case 35:e.prev=35,e.t0=e.catch(7),p.e(e.t0);case 38:return e.prev=38,p.f(),e.finish(38);case 41:if(!t.damageRoll){e.next=47;break}return e.next=44,t.damageRoll;case 44:e.t1=e.sent,e.next=55;break;case 47:return e.t2=DiceDSA5,e.next=50,new Roll(i).evaluate({async:!0});case 50:return e.t3=e.sent,e.t4=t.extra.options,e.next=54,e.t2.manualRolls.call(e.t2,e.t3,"CHAR.DAMAGE",e.t4);case 54:e.t1=e.sent;case 55:b=e.t1,w=b.total,k=0,x=_createForOfIteratorHelper(b.terms);try{for(x.s();!(_=x.n()).done;)if((O=_.value)instanceof Die||"Die"==O.class){E=_createForOfIteratorHelper(O.results);try{for(E.s();!(S=E.n()).done;)L=S.value,k+=Number(L.result),r.characteristics.push({char:"damage",res:L.result,die:"d"+O.faces})}catch(e){E.e(e)}finally{E.f()}}}catch(e){x.e(e)}finally{x.f()}if(T=w-k,!(s.length>0)){e.next=65;break}u.push(s[0].name+" "+w),e.next=76;break;case 65:return w+=f,u.push(game.i18n.localize("Roll")+" "+k),0!=T&&u.push(game.i18n.localize("weaponModifier")+" "+T),t.situationalModifiers.reduce((function(e,t){if(t.damageBonus){var r=/^\*/.test(t.damageBonus)?t.damageBonus:Number(t.damageBonus)*(t.step||1);u.push("".concat(t.name," ").concat(r))}}),u),t.situationalModifiers.find((function(e){return e.name.indexOf(game.i18n.localize("CONDITION.bloodrush"))>-1}))&&(w+=2,u.push(game.i18n.localize("CONDITION.bloodrush")+" 2")),n.extraDamage&&(w=Number(n.extraDamage)+Number(w),u.push(game.i18n.localize("damageThreshold")+" "+n.extraDamage)),a?(P=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.rangeMods[t.rangeModifier||"medium"].damage,w+=P,0!=P&&u.push(game.i18n.localize("distance")+" "+P),D=t.extra.actor.system.rangeStats.damage):D=t.extra.actor.system.meleeStats.damage,e.next=74,DiceDSA5._stringToRoll(D,t);case 74:0!=(A=e.sent)&&(w+=A,u.push(game.i18n.localize("statuseffects")+" "+A));case 76:o&&(w*=2,u.push(game.i18n.localize("doubleDamage"))),j=_createForOfIteratorHelper(c);try{for(j.s();!(C=j.n()).done;)I=C.value,w*=I.val}catch(e){j.e(e)}finally{j.f()}r.armorPen=l,r.damagedescription=u.join(", "),r.damage=Math.round(w),r.damageRoll=duplicate(b);case 83:case"end":return e.stop()}}),e,null,[[7,35,38,41]])}))),function(e,t,r,n,a){return _evaluateDamage.apply(this,arguments)})},{key:"rollWeapon",value:(_rollWeapon=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.roll,e.t0){e.next=5;break}return e.next=4,new Roll("1d20").evaluate({async:!0});case 4:e.t0=e.sent;case 5:return r=e.t0,a=t.source,o=a.system.combatskill.value,i=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.extra.actor.items.find((function(e){return"combatskill"==e.type&&e.name==o})),t.extra.actor.system),(s="meleeweapon"==a.type)?(n=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareMeleeWeapon(a,[i],t.extra.actor),this._appendSituationalModifiers(t,game.i18n.localize("narrowSpace"),this._getNarrowSpaceModifier(n,t)),"attack"==t.mode&&this._appendSituationalModifiers(t,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(n,t))):(n=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareRangeWeapon(a,[],[i],t.extra.actor),this._appendSituationalModifiers(t,game.i18n.localize("distance"),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.rangeMods[t.rangeModifier||"medium"].attack)),e.next=13,this._rollSingleD20(r,n[t.mode],t.mode,this._situationalModifiers(t),t,o,this._situationalMultipliers(t));case 13:return c=e.sent,e.next=16,this.detailedWeaponResult(c,t,a);case 16:if(!("attack"==t.mode&&c.successLevel>0)){e.next=19;break}return e.next=19,DiceDSA5.evaluateDamage(t,c,n,!s,c.doubleDamage);case 19:return c.rollType="weapon",(u=DiceDSA5.parseEffect(n))&&(c.parsedEffect=u),e.abrupt("return",c);case 23:case"end":return e.stop()}}),e,this)}))),function(e){return _rollWeapon.apply(this,arguments)})},{key:"detailedWeaponResult",value:(_detailedWeaponResult=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n){var a,o,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a="attack"==r.mode,o="meleeweapon"==n.type||"meleeAttack"==getProperty(n,"system.traitType.value"),e.t0=t.successLevel,e.next=3===e.t0?5:-3===e.t0?34:2===e.t0?67:-2===e.t0?69:70;break;case 5:if(!a){e.next=17;break}return e.next=8,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalAttack");case 8:if(!e.sent){e.next=12;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalAttack",!1),e.next=14;break;case 12:t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultAttackCrit(!0),t.doubleDamage=!0;case 14:t.halfDefense=!0,e.next=33;break;case 17:if(e.t1=r.isRangeDefense,!e.t1){e.next=22;break}return e.next=21,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalRangeDefense");case 21:e.t1=e.sent;case 22:if(!e.t1){e.next=26;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalRangeDefense",!1),e.next=33;break;case 26:return e.next=28,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("criticalMeleeDefense");case 28:if(!e.sent){e.next=32;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("criticalMeleeDefense",!1),e.next=33;break;case 32:t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultParryCrit();case 33:return e.abrupt("break",70);case 34:if(i=getProperty(n,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle")||"trait"==n.type,e.t2=a&&o,!e.t2){e.next=40;break}return e.next=39,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Melee");case 39:e.t2=e.sent;case 40:if(!e.t2){e.next=44;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Melee",i),e.next=66;break;case 44:if(e.t3=a,!e.t3){e.next=49;break}return e.next=48,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Range");case 48:e.t3=e.sent;case 49:if(!e.t3){e.next=53;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Range",!1),e.next=66;break;case 53:if(e.t4=!a,!e.t4){e.next=58;break}return e.next=57,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.tableEnabledFor("Defense");case 57:e.t4=e.sent;case 58:if(!e.t4){e.next=62;break}t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton("Defense",i),e.next=66;break;case 62:return e.t5=t.description,e.next=65,_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultBotch();case 65:t.description=e.t5+=e.sent;case 66:return e.abrupt("break",70);case 67:return a&&(t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.defaultAttackCrit(!1),t.halfDefense=!0),e.abrupt("break",70);case 69:return e.abrupt("break",70);case 70:case"end":return e.stop()}}),e)}))),function(e,t,r){return _detailedWeaponResult.apply(this,arguments)})},{key:"_addRollDiceSoNice",value:(_addRollDiceSoNice2=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r,n){var a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.rollMode){e.next=4;break}for(a=0;a<r.dice.length;a++)mergeObject(r.dice[a].options,n);return e.next=4,this.showDiceSoNice(r,t.rollMode);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return _addRollDiceSoNice2.apply(this,arguments)})},{key:"rollCombatskill",value:(_rollCombatskill=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.roll){e.next=4;break}e.t0=t.roll,e.next=7;break;case 4:return e.next=6,new Roll("1d20").evaluate({async:!0});case 6:e.t0=e.sent;case 7:return r=e.t0,n=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(t.source,t.extra.actor.system),e.next=11,this._rollSingleD20(r,n.system[t.mode].value,t.mode,this._situationalModifiers(t),t,"",this._situationalMultipliers(t));case 11:return a=e.sent,e.next=14,this.detailedWeaponResult(a,t,n);case 14:return a.rollType="combatskill",e.abrupt("return",a);case 16:case"end":return e.stop()}}),e,this)}))),function(e){return _rollCombatskill.apply(this,arguments)})},{key:"manualRolls",value:(_manualRolls=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p,d,h,m,y,v=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=v.length>1&&void 0!==v[1]?v[1]:"",!(n=v.length>2&&void 0!==v[2]?v[2]:{}).cheat&&!game.settings.get("dsa5","allowPhysicalDice")){e.next=21;break}if(n.predefinedResult){e.next=20;break}a=!1,i=[],s=_createForOfIteratorHelper(t.terms);try{for(s.s();!(c=s.n()).done;)if((u=c.value)instanceof Die||"Die"==u.class){l=_createForOfIteratorHelper(u.results);try{for(l.s();!(f=l.n()).done;)p=f.value,i.push({faces:u.faces,val:p.result})}catch(e){l.e(e)}finally{l.f()}}}catch(e){s.e(e)}finally{s.f()}return e.next=10,renderTemplate("systems/dsa5/templates/dialog/manualroll-dialog.html",{dice:i,description:r});case 10:return d=e.sent,e.next=13,new Promise((function(e,t){new _dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z({title:game.i18n.localize(n.cheat?"DIALOG.cheat":"DSASETTINGS.allowPhysicalDice"),content:d,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(t){e([!0,t])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function(){e([!1,0])}}}}).render(!0)}));case 13:h=e.sent,m=_slicedToArray(h,2),a=m[0],o=m[1],a&&(y=[],o.find(".dieInput").each((function(e){var t=Number($(this).val());t>0&&y.push({val:t,index:e}),e++})),t.editRollAtIndex(y)),e.next=21;break;case 20:t.editRollAtIndex(n.predefinedResult);case 21:return e.abrupt("return",t);case 22:case"end":return e.stop()}}),e)}))),function(e){return _manualRolls.apply(this,arguments)})},{key:"parseEffect",value:function(e){var t=e.system.effect?e.system.effect.value:void 0,r=[];if(t){var n,a=/^[a-z]+\|[a-zA-z ]+$/,o=_createForOfIteratorHelper(t.split(";"));try{for(o.s();!(n=o.n()).done;){var i=n.value;a.test(i.trim())&&function(){var e=i.split("|").map((function(e){return e.trim()}));if("condition"==e[0]){var t=CONFIG.statusEffects.find((function(t){return t.id==e[1]}));r.push('<a class="chat-condition chatButton" data-id="'.concat(t.id,'"><img src="').concat(t.icon,'"/>').concat(game.i18n.localize(t.label),"</a>"))}else r.push('<a class="roll-button roll-item" data-name="'.concat(e[1],'" data-type="').concat(e[0],'"><i class="fas fa-dice"></i>').concat(game.i18n.localize(e[0]),": ").concat(e[1],"</a>"))}()}}catch(e){o.e(e)}finally{o.f()}}var s=getProperty(e,"flags.dsa5.poison");return s&&r.push('<a class="roll-button roll-item" data-removecharge="'.concat(!s.permanent,'" data-name="').concat(s.name,'" data-type="poison"><i class="fas fa-dice"></i>').concat(game.i18n.localize("poison"),": ").concat(s.name,"</a>")),r.join(", ")}},{key:"calculateEnergyCost",value:function(e,t,r){var n,a,o,i,s=[];if(t.successLevel<0){var c=["traditionWitch","traditionFjarning","braniborian"].map((function(e){return game.i18n.localize("LocalizedIDs.".concat(e))})),u=r.extra.actor.items.some((function(e){return"specialability"==e.type&&c.includes(e.name)}))?3:2;t.preData.calculatedSpellModifiers.finalcost=Math.round(t.preData.calculatedSpellModifiers.cost/u)}e?(i="KaPCost",n=game.i18n.localize("LocalizedIDs.weakKarmicBody"),a=game.i18n.localize("LocalizedIDs.".concat(t.successLevel>0?"mightyKarmaControl":"karmaControl")),o={val:"kapModifier",name:"KaP"}):(i="AsPCost",n=game.i18n.localize("LocalizedIDs.weakAstralBody"),a=game.i18n.localize("LocalizedIDs.".concat(t.successLevel>0?"energyControl":"smallEnergyControl")),o={val:"aspModifier",name:"AsP"}),s.push({name:n,value:_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(r.extra.actor,n)},{name:a,value:-1*_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.abilityStep(r.extra.actor,a)},{name:"".concat(game.i18n.localize("statuseffects")," (").concat(game.i18n.localize("CHARAbbrev."+o.name),")"),value:r.extra.actor.system[o.val]+this._situationalModifiers(r,i)}),s=s.filter((function(e){return 0!=e.value})),t.preData.calculatedSpellModifiers.description=s.map((function(e){return"".concat(e.name," ").concat(e.value)})).join("\n"),t.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(t.preData.calculatedSpellModifiers.finalcost)+s.reduce((function(e,t){return e+t.value}),0))}},{key:"rollSpell",value:(_rollSpell=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p,d,h,m,y,v,g;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._rollThreeD20(t);case 2:if(r=e.sent,n=["ceremony","liturgy"].includes(t.source.type),r.rollType=t.source.type,r.preData.calculatedSpellModifiers.finalcost=r.preData.calculatedSpellModifiers.cost,!(r.successLevel>=2)){e.next=16;break}return e.next=9,new Roll("1d6").evaluate({async:!0});case 9:a=e.sent.total,r.description=r.description+", "+game.i18n.localize("additionalFPs")+" "+a,r.result+=a,r.qualityStep=Math.min(game.settings.get("dsa5","capQSat"),Math.ceil(r.result/3)),r.preData.calculatedSpellModifiers.finalcost=Math.round(r.preData.calculatedSpellModifiers.cost/2),e.next=17;break;case 16:r.successLevel<=-2&&(r.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.rollCritBotchButton(n?"Liturgy":"Spell",!1));case 17:if(!(r.successLevel>0)){e.next=50;break}if(""==t.source.system.effectFormula.value){e.next=50;break}o=t.source.system.effectFormula.value.replace(game.i18n.localize("CHARAbbrev.QS"),r.qualityStep).replace(/[Ww]/g,"d"),i=[],s=_createForOfIteratorHelper(t.situationalModifiers);try{for(s.s();!(c=s.n()).done;)(u=c.value).armorPen&&i.push(u.armorPen)}catch(e){s.e(e)}finally{s.f()}if(/(,|;)/.test(o)&&(o=o.split(/[,;]/)[r.qualityStep-1]),!t.damageRoll){e.next=28;break}e.t0=t.damageRoll,e.next=36;break;case 28:return e.t1=DiceDSA5,e.next=31,new Roll(o).evaluate({async:!0});case 31:return e.t2=e.sent,e.t3=t.extra.options,e.next=35,e.t1.manualRolls.call(e.t1,e.t2,"CHAR.DAMAGE",e.t3);case 35:e.t0=e.sent;case 36:l=e.t0,this._addRollDiceSoNice(t,l,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),r.calculatedEffectFormula=o,f=_createForOfIteratorHelper(l.terms);try{for(f.s();!(p=f.n()).done;)if((d=p.value)instanceof Die||"Die"==d.class){h=_createForOfIteratorHelper(d.results);try{for(h.s();!(m=h.n()).done;)y=m.value,r.characteristics.push({char:"effect",res:y.result,die:"d"+d.faces})}catch(e){h.e(e)}finally{h.f()}}}catch(e){f.e(e)}finally{f.f()}return v=[],e.next=44,DiceDSA5._stringToRoll(t.extra.actor.system[n?"liturgyStats":"spellStats"].damage,t);case 44:0!=(g=e.sent)&&v.push(game.i18n.localize("statuseffects")+" "+g),r.armorPen=i,r.damageRoll=l,r.damage=l.total+g,r.damagedescription=v.join("\n");case 50:if(this.calculateEnergyCost(n,r,t),!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(t.extra.actor,game.i18n.localize("CONDITION.minorSpirits"))||t.extra.actor.effects.find((function(e){return e.label==game.i18n.localize("CONDITION.minorSpirits")}))){e.next=56;break}return e.next=54,new Roll("1d20").evaluate({async:!0});case 54:e.sent.total<=r.preData.calculatedSpellModifiers.finalcost&&(r.description+=", "+game.i18n.localize("minorghostsappear"),_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(t.extra.speaker).addCondition("minorSpirits"));case 56:return e.abrupt("return",r);case 57:case"end":return e.stop()}}),e,this)}))),function(e){return _rollSpell.apply(this,arguments)})},{key:"_rollThreeD20",value:(_rollThreeD=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.roll){e.next=4;break}e.t0=Roll.fromData(t.roll),e.next=7;break;case 4:return e.next=6,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 6:e.t0=e.sent;case 7:if(r=e.t0,n=[],a=0,this._appendSituationalModifiers(t,game.i18n.localize("Difficulty"),t.testDifficulty),o=this._situationalModifiers(t),i=t.source.system.talentValue.value+t.advancedModifiers.fws+this._situationalModifiers(t,"FW"),s=this._situationalPartCheckModifiers(t,"TPM"),c=[1,2,3].map((function(e){return t.extra.actor.system.characteristics[t.source.system["characteristic".concat(e)].value].value+o+t.advancedModifiers.chars[e-1]+s[e-1]})),u=[0,1,2].map((function(e){return r.terms[2*e].results[0].result-c[e]})),t.routine)i=Math.round(i/2);else{l=_createForOfIteratorHelper(u);try{for(l.s();!(f=l.n()).done;)(p=f.value)>0&&(i-=p)}catch(e){l.e(e)}finally{l.f()}}if(d=t.extra.actor.system.skillModifiers.crit,h=t.extra.actor.system.skillModifiers.botch,"spell"!=t.source.type&&"ritual"!=t.source.type||!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(t.extra.actor,game.i18n.localize("LocalizedIDs.wildMagic"))||(h=19),"skill"!=t.source.type||!_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(t.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.incompetent")," (").concat(t.source.name,")"))){e.next=31;break}return e.next=23,new Roll("1d20").evaluate({async:!0});case 23:m=e.sent,y=u.reduce((function(e,t,r,n){return t<n[e]?r:e}),0),v=r.terms[2*y].total,i+=Math.max(u[y],0),i-=Math.max(0,m.total-c[y]),r.editRollAtIndex([{index:y,val:m.total}]),this._addRollDiceSoNice(t,m,r.terms[2*y].options),n.push(game.i18n.format("CHATNOTIFICATION.unableReroll",{die:y+1,oldVal:v,newVal:m.total}));case 31:return g=0,"skill"==t.source.type&&_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__.Z.hasTrait(t.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.automaticSuccess")," (").concat(t.source.name,")"))?(n.push(game.i18n.localize("LocalizedIDs.automaticSuccess")),a=1,g=1):"skill"==t.source.type&&_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__.Z.hasTrait(t.extra.actor,"".concat(game.i18n.localize("LocalizedIDs.automaticFail")," (").concat(t.source.name,")"))?(n.push(game.i18n.localize("LocalizedIDs.automaticFail")),a=-1):(a=DiceDSA5.get3D20SuccessLevel(r,i,h,d),t.routine&&(a=1),n.push(DiceDSA5.getSuccessDescription(a))),n=n.join(", "),b=0,a>0&&(i+=this._situationalModifiers(t,"FP"),b=Math.max(1,(0==i?1:i>0?Math.ceil(i/3):0)+(null!=t.qualityStep?Number(t.qualityStep):0))+(t.advancedModifiers.qls||0)+this._situationalModifiers(t,"QL")),(b=Math.min(game.settings.get("dsa5","capQSat"),b))<g&&(b=g),e.abrupt("return",{result:i,characteristics:[0,1,2].map((function(e){return{char:t.source.system["characteristic".concat(e+1)].value,res:r.terms[2*e].results[0].result,suc:u[e]<=0,tar:c[e]}})),qualityStep:b,description:n,preData:t,successLevel:a,modifiers:o,extra:{}});case 39:case"end":return e.stop()}}),e,this)}))),function(e){return _rollThreeD.apply(this,arguments)})},{key:"rollTalent",value:(_rollTalent=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._rollThreeD20(t);case 2:return(r=e.sent).rollType="talent",e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return _rollTalent.apply(this,arguments)})},{key:"get3D20SuccessLevel",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=e.terms.filter((function(e){return e.results&&e.results[0].result<=n})).length,o=e.terms.filter((function(e){return e.results&&e.results[0].result>=r})).length;return a>=2?a:o>=2?-1*o:t>=0?1:-1}},{key:"getSuccessDescription",value:function(e){return game.i18n.localize(["AstoundingFailure","CriticalFailure","Failure","","Success","CriticalSuccess","AstoundingSuccess"][e+3])}},{key:"rollItem",value:(_rollItem=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p,d,h,m,y;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.roll,e.t0){e.next=5;break}return e.next=4,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 4:e.t0=e.sent;case 5:r=e.t0,n=[],a=this._situationalModifiers(t),o=Number(t.source.system.step.value),i=[1,2,3].map((function(e){return 10+Number(t.source.system.step.value)+a})),s=[0,1,2].map((function(e){return r.terms[2*e].results[0].result-i[e]})),c=_createForOfIteratorHelper(s);try{for(c.s();!(u=c.n()).done;)(l=u.value)>0&&(o-=l)}catch(e){c.e(e)}finally{c.f()}f=DiceDSA5.get3D20SuccessLevel(r,o,20),n.push(DiceDSA5.getSuccessDescription(f)),n=n.join(", "),p={result:o,characteristics:[0,1,2].map((function(e){return{char:t.source.type,res:r.terms[2*e].results[0].result,suc:s[e]<=0,tar:i[e]}})),qualityStep:Math.min(game.settings.get("dsa5","capQSat"),(0==o?1:o>0?Math.ceil(o/3):0)+(null!=t.qualityStep?Number(t.qualityStep):0)),description:n,preData:t,successLevel:f,modifiers:a,extra:{}},e.t1=t.source.type,e.next="poison"===e.t1?21:"disease"===e.t1?26:31;break;case 21:return d=t.source.system.duration.value.split(" / ").map((function(e){return e.trim()})),h=t.source.system.effect.value.split(" / ").map((function(e){return e.trim()})),p.duration=d.length>1?p.successLevel>0?d[0]:d[1]:d[0],p.effect=h.length>1?p.successLevel>0?h[0]:h[1]:h[0],e.abrupt("break",31);case 26:return m=t.source.system.damage.value.split(" / ").map((function(e){return e.trim()})),y=t.source.system.duration.value.split(" / ").map((function(e){return e.trim()})),p.damageeffect=m.length>1?p.successLevel>0?m[0]:m[1]:m[0],p.duration=y.length>1?p.successLevel>0?y[0]:y[1]:y[0],e.abrupt("break",31);case 31:return e.abrupt("return",p);case 32:case"end":return e.stop()}}),e,this)}))),function(e){return _rollItem.apply(this,arguments)})},{key:"rollTest",value:(_rollTest=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.source.type,e.next="ceremony"===e.t0||"ritual"===e.t0||"liturgy"===e.t0||"spell"===e.t0?3:"skill"===e.t0?7:"combatskill"===e.t0?11:"trait"===e.t0?15:"regenerate"===e.t0?29:"meleeweapon"===e.t0||"rangeweapon"===e.t0?33:"dodge"===e.t0?47:"poison"===e.t0||"disease"===e.t0?53:57;break;case 3:return e.next=5,this.rollSpell(t);case 5:return r=e.sent,e.abrupt("break",60);case 7:return e.next=9,this.rollTalent(t);case 9:return r=e.sent,e.abrupt("break",60);case 11:return e.next=13,this.rollCombatskill(t);case 13:return r=e.sent,e.abrupt("break",60);case 15:if("parry"!=t.mode){e.next=18;break}return e.next=18,this.updateDefenseCount(t);case 18:if("damage"!=t.mode){e.next=24;break}return e.next=21,this.rollDamage(t);case 21:e.t1=e.sent,e.next=27;break;case 24:return e.next=26,this.rollCombatTrait(t);case 26:e.t1=e.sent;case 27:return r=e.t1,e.abrupt("break",60);case 29:return e.next=31,this.rollRegeneration(t);case 31:return r=e.sent,e.abrupt("break",60);case 33:if("parry"!=t.mode){e.next=36;break}return e.next=36,this.updateDefenseCount(t);case 36:if("damage"!=t.mode){e.next=42;break}return e.next=39,this.rollDamage(t);case 39:e.t2=e.sent,e.next=45;break;case 42:return e.next=44,this.rollWeapon(t);case 44:e.t2=e.sent;case 45:return r=e.t2,e.abrupt("break",60);case 47:return e.next=49,this.updateDefenseCount(t);case 49:return e.next=51,this.rollStatus(t);case 51:return r=e.sent,e.abrupt("break",60);case 53:return e.next=55,this.rollItem(t);case 55:return r=e.sent,e.abrupt("break",60);case 57:return e.next=59,this.rollAttribute(t);case 59:r=e.sent;case 60:return mergeObject(r,deepClone(t.extra)),e.abrupt("return",r);case 62:case"end":return e.stop()}}),e,this)}))),function(e){return _rollTest.apply(this,arguments)})},{key:"updateDefenseCount",value:(_updateDefenseCount=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.combat){e.next=3;break}return e.next=3,game.combat.updateDefenseCount(t.extra.speaker);case 3:case"end":return e.stop()}}),e)}))),function(e){return _updateDefenseCount.apply(this,arguments)})},{key:"_compareWeaponReach",value:function(e,t){var r=t.situationalModifiers.find((function(e){return e.name==game.i18n.localize("LocalizedIDs.circumvent")})),n=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.meleeRangesArray.indexOf(e.system.reach.value),a=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.meleeRangesArray.indexOf(t.opposingWeaponSize);return r&&a>n&&(r.value=2*Math.min(r.step,a-n)),2*Math.min(0,n-a)}},{key:"rollDices",value:(_rollDices=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r){var n,a,o,i,s,c;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.roll){e.next=61;break}n=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration,e.t0=t.source.type,e.next="liturgy"===e.t0||"spell"===e.t0||"ceremony"===e.t0||"ritual"===e.t0||"skill"===e.t0?5:"regenerate"===e.t0?12:"meleeweapon"===e.t0||"rangeweapon"===e.t0||"weaponless"===e.t0||"combatskill"===e.t0||"trait"===e.t0?22:"dodge"===e.t0?37:"poison"===e.t0||"disease"===e.t0?42:50;break;case 5:return e.next=7,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 7:return a=e.sent,mergeObject(a.dice[0].options,n(t.source.system.characteristic1.value)),mergeObject(a.dice[1].options,n(t.source.system.characteristic2.value)),mergeObject(a.dice[2].options,n(t.source.system.characteristic3.value)),e.abrupt("break",54);case 12:return o=[game.settings.get("dsa5","lessRegeneration")?"1d3":"1d6"],t.extra.actor.system.isMage&&o.push("1d6"),t.extra.actor.system.isPriest&&o.push("1d6"),e.next=17,new Roll(o.join("+")).evaluate({async:!0});case 17:return a=e.sent,mergeObject(a.dice[0].options,n("mu")),t.extra.actor.system.isMage&&mergeObject(a.dice[1].options,n("ge")),t.extra.actor.system.isPriest&&mergeObject(a.dice[o.length-1].options,n("in")),e.abrupt("break",54);case 22:if("damage"!=t.mode){e.next=32;break}return e.next=25,this.damageFormula(t);case 25:return i=e.sent,e.next=28,new Roll(i).evaluate({async:!0});case 28:for(a=e.sent,s=0;s<a.dice.length;s++)mergeObject(a.dice[s].options,n("damage"));e.next=36;break;case 32:return e.next=34,new Roll("1d20").evaluate({async:!0});case 34:a=e.sent,mergeObject(a.dice[0].options,n(t.mode));case 36:return e.abrupt("break",54);case 37:return e.next=39,new Roll("1d20").evaluate({async:!0});case 39:return a=e.sent,mergeObject(a.dice[0].options,n("dodge")),e.abrupt("break",54);case 42:return c=n("in"),e.next=45,new Roll("1d20+1d20+1d20").evaluate({async:!0});case 45:return a=e.sent,mergeObject(a.dice[0].options,c),mergeObject(a.dice[1].options,c),mergeObject(a.dice[2].options,c),e.abrupt("break",54);case 50:return e.next=52,new Roll("1d20").evaluate({async:!0});case 52:a=e.sent,mergeObject(a.dice[0].options,n(t.source.system.label.split(".")[1].toLowerCase()));case 54:return e.next=56,DiceDSA5.manualRolls(a,t.source.type,t.extra.options);case 56:return a=e.sent,e.next=59,this.showDiceSoNice(a,r.rollMode);case 59:t.roll=a,t.rollMode=r.rollMode;case 61:return e.abrupt("return",t);case 62:case"end":return e.stop()}}),e,this)}))),function(e,t){return _rollDices.apply(this,arguments)})},{key:"showDiceSoNice",value:(_showDiceSoNice=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,r){var n,a,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.moduleEnabled("dice-so-nice")){e.next=17;break}n=null,a=!1,e.t0=r,e.next="blindroll"===e.t0?6:"gmroll"===e.t0?9:"selfroll"===e.t0?11:13;break;case 6:return a=!0,n=game.users.filter((function(e){return e.isGM})).map((function(e){return e.id})),e.abrupt("break",13);case 9:return n=game.users.filter((function(e){return e.isGM})).map((function(e){return e.id})),e.abrupt("break",13);case 11:return n=[],e.abrupt("break",13);case 13:if(o=game.dice3d.showForRoll(t,game.user,!0,n,a),game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")){e.next=17;break}return e.next=17,o;case 17:case"end":return e.stop()}}),e)}))),function(e,t){return _showDiceSoNice.apply(this,arguments)})},{key:"addApplyEffectData",value:function(e){var t=e.preData.source;if(["spell","liturgy","ritual","ceremony","meleeweapon","rangeweapon"].includes(t.type)){if(e.successLevel>0&&t.effects.length>0)return!0}else if(["disease","poison"].includes(t.type))return t.effects.length>0;var r=e.preData.situationalModifiers.filter((function(e){return e.specAbId})).map((function(e){return e.specAbId}));if(r.length>0){var n,a=_createForOfIteratorHelper(e.preData.extra.actor.items.filter((function(e){return r.includes(e._id)})));try{for(a.s();!(n=a.n()).done;)if(n.value.effects.length>0)return!0}catch(e){a.e(e)}finally{a.f()}}return!1}},{key:"renderRollCard",value:function(){var _renderRollCard=_asyncToGenerator(_regeneratorRuntime().mark((function _callee25(chatOptions,testData,rerenderMessage){var applyEffect,preData,hideDamage,chatData;return _regeneratorRuntime().wrap((function _callee25$(_context25){for(;;)switch(_context25.prev=_context25.next){case 0:return applyEffect=this.addApplyEffectData(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:"attack"==preData.mode,_context25.next=5,Hooks.call("postProcessDSARoll",chatOptions,testData,rerenderMessage,hideDamage);case 5:return delete preData.extra.actor,delete testData.actor,delete testData.preData,_context25.t0=chatOptions.title,_context25.t1=testData,_context25.t2=game.user.isGM,_context25.t3=preData,_context25.t4=hideDamage,_context25.t5=preData.situationalModifiers.filter((function(e){return 0!=e.value})),_context25.t6=applyEffect,_context25.next=17,_equipment_damage_js__WEBPACK_IMPORTED_MODULE_12__.Z.showDamageToGear(preData,testData);case 17:if(_context25.t7=_context25.sent,chatData={title:_context25.t0,testData:_context25.t1,hideData:_context25.t2,preData:_context25.t3,hideDamage:_context25.t4,modifierList:_context25.t5,applyEffect:_context25.t6,showDamageToGear:_context25.t7},preData.advancedModifiers&&(preData.advancedModifiers.chars.some((function(e){return 0!=e}))&&chatData.modifierList.push({name:game.i18n.localize("MODS.partChecks"),value:preData.advancedModifiers.chars}),0!=preData.advancedModifiers.fws&&chatData.modifierList.push({name:game.i18n.localize("MODS.FW"),value:preData.advancedModifiers.fws}),0!=preData.advancedModifiers.qls&&chatData.modifierList.push({name:game.i18n.localize("MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter((function(e){return e.isGM})).map((function(e){return e.id}))),"blindroll"===chatOptions.rollMode?chatOptions.blind=!0:"selfroll"===chatOptions.rollMode&&(chatOptions.whisper=[game.user.id]),_dsa_soundeffect_js__WEBPACK_IMPORTED_MODULE_11__.Z.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSARoll:!0},rerenderMessage){_context25.next=33;break}return _context25.next=27,renderTemplate(chatOptions.template,chatData);case 27:return chatOptions.content=_context25.sent,_context25.next=30,ChatMessage.create(chatOptions,!1);case 30:return _context25.abrupt("return",_context25.sent);case 33:return _context25.abrupt("return",renderTemplate(chatOptions.template,chatData).then((function(html){var actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{};chatOptions.content=TextEditor.enrichHTML(html,rollData);var postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction");return postFunction&&(testData.messageId=rerenderMessage.id,eval(postFunction.functionName)(postFunction,{result:testData},preData.source)),rerenderMessage.update(_defineProperty({content:chatOptions.content},"flags.data",chatOptions["flags.data"])).then((function(e){return ui.chat.updateMessage(e),e}))})));case 34:case"end":return _context25.stop()}}),_callee25,this)})));function renderRollCard(e,t,r){return _renderRollCard.apply(this,arguments)}return renderRollCard}()},{key:"_itemRoll",value:(_itemRoll2=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=$(t.currentTarget),n=r.parents(".message").attr("data-message-id"),a=game.messages.get(n),o=a.speaker,i=r.attr("data-type"),s=r.attr("data-name"),!(c=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(o))){e.next=15;break}if(!(u=c.items.find((function(e){return e.name==s&&e.type==i})))){e.next=14;break}if(l=new _item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__.Z(u.toObject(),{temporary:!0}),!(f=!!r.attr("data-removecharge")&&"true"==r.attr("data-removecharge"))){e.next=11;break}if(!(l.system.quantity.value<1)){e.next=11;break}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges")),e.abrupt("return");case 11:l.setupEffect().then(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.itemTest(t);case 2:if(!f){e.next=5;break}return e.next=5,u.update({"system.quantity.value":u.system.quantity.value-1});case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=15;break;case 14:ui.notifications.error(game.i18n.format("DSAError.notFound",{category:i,name:s}));case 15:case"end":return e.stop()}}),e)}))),function(e){return _itemRoll2.apply(this,arguments)})},{key:"_rollEdit",value:(_rollEdit2=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=$(t.currentTarget),n=r.parents(".message").attr("data-message-id"),a=game.messages.get(n),o=a.flags.data,(i=o.preData).extra.actor=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(i.extra.speaker).toObject(!1),i.extra.options.cheat&&delete i.extra.options.cheat,e.t0=r.attr("data-edit-type"),e.next="roll"===e.t0?8:"mod"===e.t0?12:17;break;case 8:return s=r.attr("data-edit-id"),c=Number(r.val()),i.roll.terms.length>2*s?((u=Roll.fromData(i.roll)).editRollAtIndex([{index:s,val:c}]),i.roll=u):(l=Roll.fromData(o.postData.damageRoll),s-=i.roll.terms.filter((function(e){return e.results})).length,l.editRollAtIndex([{index:s,val:c}]),i.damageRoll=l),e.abrupt("break",17);case 12:return(s=i.situationalModifiers.findIndex((function(e){return e.name==game.i18n.localize("chatEdit")})))>0&&i.situationalModifiers.splice(s,1),f={name:game.i18n.localize("chatEdit"),value:Number(r.val())-this._situationalModifiers(i)},i.situationalModifiers.push(f),e.abrupt("break",17);case 17:p={template:o.template,rollMode:o.rollMode,title:o.title,speaker:a.speaker,user:a.user.id},["gmroll","blindroll"].includes(p.rollMode)&&(p.whisper=game.users.filter((function(e){return e.isGM})).map((function(e){return e.id}))),"blindroll"===p.rollMode&&(p.blind=!0),["poison","disease"].includes(i.source.type)?new _item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__.Z(i.source,{temporary:!0})["".concat(o.postData.postFunction)]({testData:i,cardOptions:p},{rerenderMessage:a}):_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(a.speaker)["".concat(o.postData.postFunction)]({testData:i,cardOptions:p},{rerenderMessage:a});case 21:case"end":return e.stop()}}),e,this)}))),function(e){return _rollEdit2.apply(this,arguments)})},{key:"gearDamaged",value:(_gearDamaged=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((r=t.currentTarget.dataset.uuid.split(";")).length>1)){e.next=8;break}return e.next=4,Promise.all(r.map((function(e){return fromUuid(e)})));case 4:n=e.sent,_dialog_dialog_equipmentdamage_js__WEBPACK_IMPORTED_MODULE_13__.Z.showDialog(n),e.next=13;break;case 8:return e.t0=_equipment_damage_js__WEBPACK_IMPORTED_MODULE_12__.Z,e.next=11,fromUuid(r[0]);case 11:e.t1=e.sent,e.t0.breakingTest.call(e.t0,e.t1);case 13:case"end":return e.stop()}}),e)}))),function(e){return _gearDamaged.apply(this,arguments)})},{key:"chatListeners",value:(_chatListeners=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.on("click",".expand-mods",(function(e){e.preventDefault();var t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()})),t.on("click",".edit-toggle",(function(e){e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()})),t.on("click",".botch-roll",(function(e){return _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_14__.Z.showBotchCard(e.currentTarget.dataset)})),t.on("click",".roll-item",(function(e){return DiceDSA5._itemRoll(e)})),t.on("click",".gearDamaged",function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",DiceDSA5.gearDamaged(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.on("change",".roll-edit",(function(e){return DiceDSA5._rollEdit(e)})),t.on("click",".applyEffect",function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var r,n,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=$(t.currentTarget)).hasClass("locked")){e.next=3;break}return e.abrupt("return");case 3:return r.addClass("locked"),r.prepend('<i class="fas fa-spinner fa-spin"></i>'),n=r.parents(".message").attr("data-message-id"),a=t.currentTarget.dataset.target,e.next=9,_status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__.Z.applyEffect(n,a);case 9:setTimeout((function(){r.removeClass("locked"),r.find("i").remove()}),2e3);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.on("click",".message-delete",(function(e){var t=game.messages.get($(e.currentTarget).parents(".message").attr("data-message-id"));if(t.flags.unopposeData){var r=canvas.tokens.get(t.flags.unopposeData.targetSpeaker.token);_opposed_dsa5_js__WEBPACK_IMPORTED_MODULE_9__.Z.clearOpposed(r.actor)}})),t.on("click",".resistEffect",(function(e){return _status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__.Z.resistEffect(e)})),_request_roll_js__WEBPACK_IMPORTED_MODULE_15__.Z.chatListeners(t);case 10:case"end":return e.stop()}}),e)}))),function(e){return _chatListeners.apply(this,arguments)})}]),DiceDSA5}()},803:(e,t,r)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function a(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=i(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){c=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(c)throw o}}}}function o(e){return function(e){if(Array.isArray(e))return s(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||i(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(){c=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,o,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,o)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function a(o,i,s,c){var u=f(e[o],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==n(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return a("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function n(){return new t((function(t,n){a(e,r,t,n)}))}return o=o?o.then(n,n):n()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,i,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,s,"Generator"),u(b,o,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function u(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){u(o,n,a,i,s,"next",e)}function s(e){u(o,n,a,i,s,"throw",e)}i(void 0)}))}}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}r.d(t,{Z:()=>d});var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n,i,s,u,p,d;return t=e,null,r=[{key:"playEffect",value:(d=l(c().mark((function e(t,r,n){var a,o,i,s=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=s.length>3&&void 0!==s[3]?s[3]:void 0,o=s.length>4&&void 0!==s[4]&&s[4],e.next=4,this.getSound(t,r,n);case 4:if(i=e.sent)try{a?(game.socket.emit("system.dsa5",{type:"playWhisperSound",payload:{whisper:a,soundPath:i}}),o||AudioHelper.play({src:i,volume:.8,loop:!1},!1)):AudioHelper.play({src:i,volume:.8,loop:!1},!0)}catch(e){console.warn("Could not play item sound effect ".concat(i))}case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return d.apply(this,arguments)})},{key:"loadSoundConfig",value:(p=l(c().mark((function e(){var t,r,n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.settings.get("dsa5","soundConfig");case 2:if(!(t=e.sent)){e.next=18;break}return e.prev=4,e.next=7,fetch(t);case 7:return r=e.sent,e.next=10,r.json();case 10:n=e.sent,this.sounds=n,console.log("DSA5 | Sound Config Loaded"),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(4),console.warn(e.t0);case 18:case"end":return e.stop()}}),e,this,[[4,15]])}))),function(){return p.apply(this,arguments)})},{key:"successLevelToString",value:function(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}},{key:"getSound",value:(u=l(c().mark((function e(t,r,n){var i,s,u,l,f,p,d;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.sounds||this.triedInit){e.next=4;break}return e.next=3,this.loadSoundConfig();case 3:this.triedInit=!0;case 4:if(this.sounds){e.next=6;break}return e.abrupt("return",void 0);case 6:s=this.successLevelToString(n),u=[],e.t0=r.type,e.next="meleeweapon"===e.t0||"rangeweapon"===e.t0?11:"skill"===e.t0?13:"liturgy"===e.t0||"spell"===e.t0||"ceremony"===e.t0||"ritual"===e.t0?15:17;break;case 11:return u=[].concat(o(s.map((function(e){return"".concat(r.type,".manual.").concat(r.name,".").concat(t,"_").concat(e)}))),["".concat(r.type,".manual.").concat(r.name,".").concat(t),"".concat(r.type,".manual.").concat(r.name,".default.").concat(t),"".concat(r.type,".manual.").concat(r.name,".default")],o(s.map((function(e){return"".concat(r.type,".").concat(r.system.combatskill.value,".").concat(t,"_").concat(e)}))),["".concat(r.type,".").concat(r.system.combatskill.value,".").concat(t)],o(s.map((function(e){return"".concat(r.type,".").concat(r.system.combatskill.value,".default_").concat(e)}))),["".concat(r.type,".").concat(r.system.combatskill.value,".default")]),e.abrupt("break",17);case 13:case 15:return u=[].concat(o(s.map((function(e){return"".concat(r.type,".").concat(r.name,".").concat(t,"_").concat(e)}))),["".concat(r.type,".").concat(r.name,".").concat(t)],o(s.map((function(e){return"".concat(r.type,".").concat(r.name,".default_").concat(e)}))),["".concat(r.type,".").concat(r.name,".default")]),e.abrupt("break",17);case 17:(i=u).push.apply(i,o(s.map((function(e){return"".concat(r.type,".default_").concat(e)}))).concat(["".concat(r.type,".default")])),f=a(u),e.prev=19,f.s();case 21:if((p=f.n()).done){e.next=30;break}if(d=p.value,hasProperty(this.sounds,d)){e.next=25;break}return e.abrupt("continue",28);case 25:if(!(l=getProperty(this.sounds,d))||!("string"==typeof l||l instanceof String)){e.next=28;break}return e.abrupt("break",30);case 28:e.next=21;break;case 30:e.next=35;break;case 32:e.prev=32,e.t1=e.catch(19),f.e(e.t1);case 35:return e.prev=35,f.f(),e.finish(35);case 38:return e.abrupt("return",l);case 39:case"end":return e.stop()}}),e,this,[[19,32,35,38]])}))),function(e,t,r){return u.apply(this,arguments)})},{key:"playMoneySound",value:(s=l(c().mark((function e(){var t,r,n,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]&&a[0],game.modules.get("gAudioBundle-3")){e.next=3;break}return e.abrupt("return");case 3:return n=(r=["modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"])[Math.floor(Math.random()*r.length)],e.next=7,this.playSoundPath(n,t);case 7:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"playEquipmentWearStatusChange",value:(i=l(c().mark((function e(t){var r,n,a,o,i,s,u=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=u.length>1&&void 0!==u[1]&&u[1],n=[],a=game.modules.get("gAudioBundle-2"),o=game.modules.get("gAudioBundle-3"),i=game.modules.get("gAudioBundle-4"),e.t0=t.type,e.next="armor"===e.t0?8:"meleeweapon"===e.t0?10:"rangeweapon"===e.t0?13:15;break;case 8:return a&&n.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg"),e.abrupt("break",15);case 10:return a&&n.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),o&&n.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg"),e.abrupt("break",15);case 13:return i&&n.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg"),e.abrupt("break",15);case 15:if(0==n.length&&a&&n.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg"),!(n.length>0)){e.next=20;break}return s=n[Math.floor(Math.random()*n.length)],e.next=20,this.playSoundPath(s,r,.5);case 20:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"playSoundPath",value:(n=l(c().mark((function e(t){var r,n,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>1&&void 0!==a[1]&&a[1],n=a.length>2&&void 0!==a[2]?a[2]:.8,game.settings.get("dsa5","inventorySound")){e.next=4;break}return e.abrupt("return");case 4:try{AudioHelper.play({src:t,volume:n,loop:!1},r)}catch(e){console.warn("Could not play item sound effect ".concat(t))}case 5:case"end":return e.stop()}}),e)}))),function(e){return n.apply(this,arguments)})}],r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();p(d,"sounds",void 0),p(d,"triedInit",!1)},702:(e,t,r)=>{r.d(t,{Z:()=>d});var n=r(5),a=r(577),o=r(472),i=r(562),s=r(491);function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function u(){u=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};s(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,s){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==c(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,s(b,"constructor",m),s(m,"constructor",h),h.displayName=s(m,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,s(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),s(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),s(b,i,"Generator"),s(b,a,(function(){return this})),s(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function l(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function f(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){l(o,n,a,i,s,"next",e)}function s(e){l(o,n,a,i,s,"throw",e)}i(void 0)}))}}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,c,l,d;return t=e,null,r=[{key:"armorWearModifier",value:function(t,r){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(e.calculateWear(t)){case 1:case 2:r-=1;break;case 3:case 4:r=0}return Math.max(0,Number(r))}},{key:"armorGetsDamage",value:function(e,t){return(e>14||t.successLevel>2)&&game.settings.get("dsa5","armorAndWeaponDamage")}},{key:"armorEncumbranceModifier",value:function(t){return game.settings.get("dsa5","armorAndWeaponDamage")&&e.calculateWear(t)>1?1:0}},{key:"showDamageToGear",value:(d=f(u().mark((function e(t,r){var n,a,o,i,c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.settings.get("dsa5","armorAndWeaponDamage")){e.next=11;break}if(n=s.Z.getSpeaker(t.extra.speaker),a=0,(o=getProperty(n,"flags.oppose.messageId"))&&(i=game.messages.get(o))&&(a=getProperty(i,"flags.data.postData.successLevel")||0),!((c=t.source)._id&&c.system.structure&&(r.successLevel<-2||a>2)&&["meleeweapon","rangeweapon","armor"].includes(c.type))){e.next=11;break}return e.next=9,s.Z.getSpeaker(r.speaker);case 9:return n=e.sent,e.abrupt("return",n.items.get(c._id).uuid);case 11:return e.abrupt("return",void 0);case 12:case"end":return e.stop()}}),e)}))),function(e,t){return d.apply(this,arguments)})},{key:"breakingTest",value:function(t){if(!t)return ui.notifications.warn(game.i18n.format("DSAError.notfound",{category:"",name:game.i18n.localize("equipment")}));if(t.system.structure.max<=0)return ui.notifications.warn(game.i18n.format("DSAError.noBreakingStructure",{name:t.name}));var r,i=0;if("armor"==t.type?(r=game.i18n.localize("ARMORSUBCATEGORIES.".concat(t.system.subcategory)),i=getProperty(t,"structure.breakPointRating")||a.Z.armorSubcategories[t.system.subcategory]):(r=t.system.combatskill.value,i=getProperty(t,"structure.breakPointRating")||a.Z.weaponStabilities[game.i18n.localize("LocalizedCTs.".concat(r))]),i){var s="",c=getProperty(t,"effect.attributes")||"";c.includes(o.Z.clerical)?s="".concat(game.i18n.format("WEAPON.attributeWarning",{domain:o.Z.clerical}),"<br/>"):c.includes(o.Z.magical)&&(s="".concat(game.i18n.format("WEAPON.attributeWarning",{domain:o.Z.magical}),"<br/>")),new n.Z({title:game.i18n.localize("DSASETTINGS.armorAndWeaponDamage"),content:"".concat(s,'<label for="threshold">').concat(game.i18n.format("WEAR.check",{category:r}),'</label>: <input class="quantity-click" style="width:80px" dtype="number" name="threshold" type="number" value="').concat(i,'"/>'),buttons:{Yes:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:function(n){e.resolveBreakingTest(t,Number(n.find('[name="threshold"]').val()),r)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else ui.notifications.error(game.i18n.format("DSAError.noBreakingResistance",{item:t.name}))}},{key:"applyDamageLevelToItem",value:(l=f(u().mark((function e(t,r){var n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Math.ceil(.25*t.system.structure.max)*r,e.next=3,t.update({"system.structure.value":Math.max(0,t.system.structure.value-n)});case 3:case"end":return e.stop()}}),e)}))),function(e,t){return l.apply(this,arguments)})},{key:"resolveBreakingTest",value:(c=f(u().mark((function t(r,n,a){var o,c,l,f;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=i.Z,t.next=3,new Roll("1d20").evaluate({async:!0});case 3:return t.t1=t.sent,t.t2=game.i18n.format("WEAR.check",{category:a}),t.next=7,t.t0.manualRolls.call(t.t0,t.t1,t.t2);case 7:return o=t.sent,t.t3=i.Z,t.t4=o,t.next=12,game.settings.get("core","rollMode");case 12:return t.t5=t.sent,t.next=15,t.t3.showDiceSoNice.call(t.t3,t.t4,t.t5);case 15:return c=o.total>n?1:0,t.next=18,this.applyDamageLevelToItem(r,c);case 18:return l=e.calculateWear(r.data),t.next=21,renderTemplate("systems/dsa5/templates/system/breakingtest.html",{wear:l,item:r,threshold:n,category:a,roll:o,result:game.i18n.localize("WEAR.".concat(r.type,".").concat(l))});case 21:f=t.sent,ChatMessage.create(s.Z.chatDataSetup(f));case 23:case"end":return t.stop()}}),t,this)}))),function(e,t,r){return c.apply(this,arguments)})},{key:"damageTooltip",value:function(e){if(game.settings.get("dsa5","armorAndWeaponDamage")){var t=this.calculateWear(e);return{msg:game.i18n.localize("WEAR.".concat(e.type,".").concat(t)),css:"gearD damaged".concat(t)}}return{msg:"",css:""}}},{key:"weaponWearModifier",value:function(t){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(e.calculateWear(t)){case 1:t.attack-=1,t.parry&&(t.parry-=1);break;case 2:t.attack-=2,t.parry&&(t.parry-=2);break;case 3:case 4:t.attack=0,t.parry&&(t.parry=0)}}},{key:"calculateWear",value:function(e){return!e.system.structure||Number(e.system.structure.max<=0)?0:Math.floor(4*(1-e.system.structure.value/e.system.structure.max))}}],r&&p(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},794:(e,t,r)=>{r.d(t,{Z:()=>f});var n=r(577),a=r(491);function o(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return i(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){c=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(c)throw o}}}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var c,u,l,f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,r=[{key:"getTalentBonus",value:function(e,t,r){var n,i=[],s=game.settings.get("dsa5","talentModifierEnabled"),c=o(e.items.filter((function(e){return r.includes(e.type)&&e.system.effect.value.includes(t)})));try{for(c.s();!(n=c.n()).done;){var u,l=n.value,f=o(l.system.effect.value.split(/;|,/));try{for(f.s();!(u=f.n()).done;){var p=u.value;if(p.includes(t)){var d=a.Z.parseAbilityString(p.trim());d.name==t&&i.push({name:l.name,value:d.step*(l.system.step?l.system.step.value:1),type:d.type,selected:s})}}}catch(e){f.e(e)}finally{f.f()}}}catch(e){c.e(e)}finally{c.f()}return i}},{key:"simpleAdoption",value:function(e,t,r,n){if(n[r].effect&&(e.system.effect.value="".concat(t.name," ").concat(n[r].effect)),n[r].activeEffect){var a=duplicate(n[r].activeEffect);a.value="".concat(t.name," ").concat(a.value);var o={changes:[a],duration:{},icon:"icons/svg/aura.svg",label:"".concat(r," (").concat(t.name,")"),transfer:!0,flags:{dsa5:{value:null,editable:!0,description:"".concat(r," (").concat(t.name,")"),custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(o)}}},{key:"reverseAdoptionCalculation",value:function(t,r,a){for(var o=[n.Z.vantagesNeedingAdaption,n.Z.AbilitiesNeedingAdaption],i=function(){var n=c[s];if(n[r.name]){var o=t.items.find((function(e){return n[r.name].items.includes(e.type)&&e.name==r.special}));return o&&(a.system.APValue.value=a.system.APValue.value.split("/")[o.system.StF.value.charCodeAt(0)-65],e.simpleAdoption(a,o,r.name,n)),"break"}},s=0,c=o;s<c.length&&"break"!==i();s++);return a}},{key:"hasItem",value:function(e,t,r){return null!=e.items.find((function(e){return r.includes(e.type)&&e.name==t}))}},{key:"itemStep",value:function(e,t,r){var n=e.items.find((function(e){return r.includes(e.type)&&e.name==t}));return n?Number((n.system,n.system.step.value)):0}},{key:"itemAsModifier",value:function(e,t,r,n){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=[],c=o?new RegExp("^".concat(a.Z.escapeRegex("".concat(t," (")))):new RegExp("^".concat(a.Z.escapeRegex(t),"$")),u=e.items.find((function(e){return n.includes(e.type)&&c.test(e.name)}));return u&&s.push({name:u.name,value:Number((u.system,u.system.step.value))*r,selected:i}),s}}],null&&s(t.prototype,null),r&&s(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();l={},(u="children")in(c=f)?Object.defineProperty(c,u,{value:l,enumerable:!0,configurable:!0,writable:!0}):c[u]=l},586:(e,t,r)=>{r.d(t,{Z:()=>w,j:()=>g});var n=r(491);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(){return i="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=s(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},i.apply(this,arguments)}function s(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function u(e,t){if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function f(){f=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=l(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var p={};function d(){}function h(){}function m(){}var y={};c(y,o,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,o)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,s,c){var u=l(e[o],e,i);if("throw"!==u.type){var f=u.arg,p=f.value;return p&&"object"==a(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return o=o?o.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=l(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,c(b,"constructor",m),c(m,"constructor",h),h.displayName=c(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,c(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),c(k.prototype,i,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(u(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),c(b,s,"Generator"),c(b,o,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function p(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function d(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){p(o,n,a,i,s,"next",e)}function s(e){p(o,n,a,i,s,"throw",e)}i(void 0)}))}}function h(){return m.apply(this,arguments)}function m(){return(m=d(f().mark((function e(){var t;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(game.settings.get("dsa5","defaultConfigFinished")){e.next=13;break}return console.log("Configuring default token settings"),(t=game.settings.get("core","defaultToken")).displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,t.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,t.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,t.bar1={attribute:"status.wounds"},e.next=9,game.settings.set("core","defaultToken",t);case 9:return e.next=11,game.settings.set("core","leftClickRelease",!0);case 11:return e.next=13,game.settings.set("dsa5","defaultConfigFinished",!0);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(e,t){return v.apply(this,arguments)}function v(){return(v=d(f().mark((function e(t,r){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,g();case 2:return e.next=4,game.settings.set("dsa5","migrationVersion",r);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(){return b.apply(this,arguments)}function b(){return(b=d(f().mark((function e(){var t,r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("systems/dsa5/lazy/updatenotes.json");case 2:return t=e.sent,e.next=5,t.json();case 5:r=e.sent,new k(r).render(!0);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(){Hooks.once("ready",d(f().mark((function e(){var t,r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(game.user.isGM){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,h();case 4:return e.next=6,game.settings.get("dsa5","migrationVersion");case 6:if((t=e.sent)<(r=18)){e.next=11;break}return e.abrupt("return");case 11:y(t,r);case 12:case"end":return e.stop()}}),e)}))))}var k=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(y,Application);var t,r,a,s,p,h,m=(p=y,h=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=l(p);if(h){var r=l(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return u(this,e)});function y(e,t){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,y),(r=m.call(this,t)).json=e,r}return t=y,r=[{key:"getData",value:(s=d(f().mark((function e(){var t,r,a,o,i,s,c,u,l,p;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.json.notes[this.json.notes.length-1],r=this.json.default.replace(/VERSION/g,t.version),a="<h1>CHANGELOG</h1><p>".concat(r,". </br><b>Important updates</b>: ").concat(t.text,'</p><p>For details or proposals visit our wiki page at <a href="https://github.com/Plushtoast/dsa5-foundryVTT/wiki" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>'),e.next=5,ChatMessage.create(n.Z.chatDataSetup(a,"roll"));case 5:return o=game.i18n.lang,e.next=8,renderTemplate("systems/dsa5/lazy/patchhtml/changelog_".concat(o,"_").concat(t.version,".html"));case 8:return i=e.sent,e.next=11,renderTemplate("systems/dsa5/lazy/patchhtml/news_".concat(o,"_").concat(t.version,".html"));case 11:return s=e.sent,c=[this.json.notes[this.json.notes.length-2]],e.next=15,Promise.all(c.map(function(){var e=d(f().mark((function e(t){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/lazy/patchhtml/changelog_".concat(o,"_").concat(t.version,".html"));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 15:return u=e.sent,e.next=18,Promise.all(c.map(function(){var e=d(f().mark((function e(t){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/lazy/patchhtml/news_".concat(o,"_").concat(t.version,".html"));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 18:return l=e.sent,e.next=21,renderTemplate("systems/dsa5/lazy/patchhtml/modules_".concat(o,".html"));case 21:return p=e.sent,e.abrupt("return",{patchName:r,changelog:i,news:s,prevVersions:c,prevChangeLogs:u,prevNews:l,modules:p});case 23:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})}],a=[{key:"defaultOptions",get:function(){var e=i(l(y),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsa5/templates/system/patchviewer.html",e.resizable=!0,e}}],r&&o(t.prototype,r),a&&o(t,a),Object.defineProperty(t,"prototype",{writable:!1}),y}()},604:(e,t,r)=>{r.d(t,{Z:()=>f});var n=r(491);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(){o=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,i,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,i)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,s,c){var u=f(e[o],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==a(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return o=o?o.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,i,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw o}}}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function u(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){c(o,n,a,i,s,"next",e)}function s(e){c(o,n,a,i,s,"throw",e)}i(void 0)}))}}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}r(122),r(803);var f=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.item=t}var t,r,a,s,c,f,p,d,h,m,y;return t=e,r=[{key:"callMacro",value:(y=u(o().mark((function e(t,r){var n,a,s,c,u,l,f,p,d,h=arguments;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=h.length>2&&void 0!==h[2]?h[2]:{},a=game.packs.get(t),e.next=4,a.getDocuments({name:r});case 4:if((s=e.sent).length){e.next=26;break}c=i(game.packs.filter((function(e){return"Macro"==e.documentName&&/\(internal\)/.test(e.metadata.label)}))),e.prev=7,c.s();case 9:if((u=c.n()).done){e.next=18;break}return l=u.value,e.next=13,l.getDocuments({name:r});case 13:if(!(s=e.sent).length){e.next=16;break}return e.abrupt("break",18);case 16:e.next=9;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(7),c.e(e.t0);case 23:return e.prev=23,c.f(),e.finish(23);case 26:if(f={},!s.length){e.next=43;break}return p="(async () => {".concat(s[0].data.command,"})()"),d=Function("args","actor","item",p),e.prev=30,n.result=f,e.next=34,d.call(this,n,this.item.actor,this.item);case 34:e.next=41;break;case 36:e.prev=36,e.t1=e.catch(30),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(e.t1),f.error=!0;case 41:e.next=44;break;case 43:ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:r}));case 44:return e.abrupt("return",f);case 45:case"end":return e.stop()}}),e,this,[[7,20,23,26],[30,36]])}))),function(e,t){return y.apply(this,arguments)})},{key:"executeOnUseEffect",value:(m=u(o().mark((function t(){var r,n,a;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(game.user.can("MACRO_SCRIPT")){t.next=2;break}return t.abrupt("return",ui.notifications.warn("You are not allowed to use JavaScript macros."));case 2:if(this.item.actor){t.next=4;break}return t.abrupt("return");case 4:return r=e.getOnUseEffect(this.item),n="(async () => {".concat(r,"})()"),a=Function("item","actor",n),t.prev=7,t.next=10,a.call(this,this.item,this.item.actor);case 10:t.next=17;break;case 12:t.prev=12,t.t0=t.catch(7),ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(t.t0),console.warn(t.t0.stack);case 17:case"end":return t.stop()}}),t,this,[[7,12]])}))),function(){return m.apply(this,arguments)})},{key:"automatedAnimation",value:(h=u(o().mark((function e(t){var r=arguments;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.length>1&&void 0!==r[1]&&r[1],n.Z.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet");case 2:case"end":return e.stop()}}),e)}))),function(e){return h.apply(this,arguments)})},{key:"effectDummy",value:function(e,t,r){return{label:e,icon:"icons/svg/aura.svg",changes:t,duration:r,flags:{dsa5:{value:null,editable:!0,customizable:!0,description:e,custom:!0}}}}},{key:"socketedConditionAddActor",value:(d=u(o().mark((function e(t,r){var n,a,s,c,u,l;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=31;break}(n="string"==typeof r)&&((r=duplicate(CONFIG.statusEffects.find((function(e){return e.id==r})))).label=game.i18n.localize(r.label)),a=[],s=i(t),e.prev=5,s.s();case 7:if((c=s.n()).done){e.next=19;break}if(u=c.value,!n){e.next=14;break}return e.next=12,u.addCondition(r,1,!1,!1);case 12:e.next=16;break;case 14:return e.next=16,u.addCondition(r);case 16:a.push(u.name);case 17:e.next=7;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(5),s.e(e.t0);case 24:return e.prev=24,s.f(),e.finish(24);case 27:return e.next=29,this.createInfoMessage(r,a);case 29:e.next=33;break;case 31:l={id:this.item.uuid,data:r,actors:t.map((function(e){return e.id}))},game.socket.emit("system.dsa5",{type:"socketedConditionAddActor",payload:l});case 33:case"end":return e.stop()}}),e,this,[[5,21,24,27]])}))),function(e,t){return d.apply(this,arguments)})},{key:"createInfoMessage",value:(p=u(o().mark((function e(t,r){var a,i,s,c=arguments;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=!(c.length>2&&void 0!==c[2])||c[2],!r.length){e.next=6;break}return i=a?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",s=game.i18n.format(i,{source:t.label,target:r.join(", ")}),e.next=6,ChatMessage.create(n.Z.chatDataSetup(s));case 6:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"socketedRemoveCondition",value:(f=u(o().mark((function e(t,r){var n,a,s,c,u,l,f,p,d=arguments;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=d.length>2&&void 0!==d[2]?d[2]:1,!game.user.isGM){e.next=29;break}a=[],s=i(t),e.prev=4,s.s();case 6:if((c=s.n()).done){e.next=15;break}if(u=c.value,!(l=canvas.tokens.get(u)).actor){e.next=13;break}return e.next=12,l.actor.removeCondition(r,n,!1);case 12:a.push(l.name);case 13:e.next=6;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(4),s.e(e.t0);case 20:return e.prev=20,s.f(),e.finish(20);case 23:return(f=CONFIG.statusEffects.find((function(e){return e.id==r}))).label=game.i18n.localize(f.label),e.next=27,this.createInfoMessage(f,a,!1);case 27:e.next=31;break;case 29:p={id:this.item.uuid,coreId:r,targets:t},game.socket.emit("system.dsa5",{type:"socketedRemoveCondition",payload:p});case 31:case"end":return e.stop()}}),e,this,[[4,17,20,23]])}))),function(e,t){return f.apply(this,arguments)})},{key:"socketedActorTransformation",value:(c=u(o().mark((function e(t,r){var n,a,s,c,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=22;break}n=i(t),e.prev=2,n.s();case 4:if((a=n.n()).done){e.next=12;break}if(s=a.value,!(c=canvas.tokens.get(s)).actor){e.next=10;break}return e.next=10,c.actor.update(r);case 10:e.next=4;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),n.e(e.t0);case 17:return e.prev=17,n.f(),e.finish(17);case 20:e.next=24;break;case 22:u={id:this.item.uuid,targets:t,update:r},game.socket.emit("system.dsa5",{type:"socketedActorTransformation",payload:u});case 24:case"end":return e.stop()}}),e,this,[[2,14,17,20]])}))),function(e,t){return c.apply(this,arguments)})},{key:"socketedConditionAdd",value:(s=u(o().mark((function e(t,r){var n,a,s,c,u,l,f;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=33;break}(n="string"==typeof r)&&((r=duplicate(CONFIG.statusEffects.find((function(e){return e.id==r})))).label=game.i18n.localize(r.label)),a=[],s=i(t),e.prev=5,s.s();case 7:if((c=s.n()).done){e.next=21;break}if(u=c.value,!(l=canvas.tokens.get(u)).actor){e.next=19;break}if(!n){e.next=16;break}return e.next=14,l.actor.addCondition(r,1,!1,!1);case 14:e.next=18;break;case 16:return e.next=18,l.actor.addCondition(r);case 18:a.push(l.name);case 19:e.next=7;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(5),s.e(e.t0);case 26:return e.prev=26,s.f(),e.finish(26);case 29:return e.next=31,this.createInfoMessage(r,a);case 31:e.next=35;break;case 33:f={id:this.item.uuid,data:r,targets:t},game.socket.emit("system.dsa5",{type:"socketedConditionAdd",payload:f});case 35:case"end":return e.stop()}}),e,this,[[5,23,26,29]])}))),function(e,t){return s.apply(this,arguments)})}],a=[{key:"getOnUseEffect",value:function(e){return e.getFlag("dsa5","onUseEffect")}}],r&&l(t.prototype,r),a&&l(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}()},600:(e,t,r)=>{r.d(t,{Z:()=>w});var n=r(491),a=r(562),o=r(118),i=r(369),s=r(702),c=r(61),u=r(839);function l(e){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l(e)}function f(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=h(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||h(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){if(e){if("string"==typeof e)return m(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?m(e,t):void 0}}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function y(){y=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof p?t:p,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===f)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===f)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var f={};function p(){}function d(){}function h(){}var m={};s(m,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(m=g);var b=h.prototype=p.prototype=Object.create(m);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var f=c.arg,p=f.value;return p&&"object"==l(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(p).then((function(e){f.value=e,i(f)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return f;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,f;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,f):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,f)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return d.prototype=h,s(b,"constructor",h),s(h,"constructor",d),d.displayName=s(h,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),s(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),s(b,i,"Generator"),s(b,a,(function(){return this})),s(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},e}function v(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function g(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){v(o,n,a,i,s,"next",e)}function s(e){v(o,n,a,i,s,"throw",e)}i(void 0)}))}}function b(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var w=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,l,h,m,v,w,k,x,_,O,E,S,L,T,D,P,A;return t=e,null,r=[{key:"handleOpposedTarget",value:(A=g(y().mark((function t(r){var a,o,i;return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r){t.next=2;break}return t.abrupt("return");case 2:if(a=n.Z.getSpeaker(r.speaker)){t.next=5;break}return t.abrupt("return");case 5:if(o=r.flags.data.postData,i=r.flags.data.preData,!a.flags.oppose){t.next=12;break}console.log("answering opposed"),e.answerOpposedTest(a,r,o,i),t.next=37;break;case 12:if(!game.user.targets.size||!r.flags.data.isOpposedTest||r.flags.data.defenderMessage||r.flags.data.attackerMessage){t.next=17;break}console.log("start opposed"),e.createOpposedTest(a,r,o,i),t.next=37;break;case 17:if(!r.flags.data.defenderMessage&&!r.flags.data.attackerMessage){t.next=22;break}console.log("end opposed"),e.resolveFinalMessage(r),t.next=37;break;case 22:if(!r.flags.data.unopposedStartMessage){t.next=27;break}console.log("repeat"),e.redoUndefended(r),t.next=37;break;case 27:if(!r.flags.data.startMessagesList){t.next=32;break}console.log("change start"),e.changeStartMessage(r),t.next=37;break;case 32:return console.log("show dmg"),t.next=35,this.showDamage(r);case 35:return t.next=37,this.showSpellWithoutTarget(r);case 37:case"end":return t.stop()}}),t,this)}))),function(e){return A.apply(this,arguments)})},{key:"redoUndefended",value:(P=g(y().mark((function e(t){var r;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=game.messages.get(t.flags.data.unopposedStartMessage),startmessage.flags.unopposeData.attackMessageId=t.id,this.resolveUndefended(r);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return P.apply(this,arguments)})},{key:"answerOpposedTest",value:(D=g(y().mark((function t(r,a,o,i){var s,c,u,l,f;return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=game.messages.get(r.flags.oppose.messageId)){t.next=6;break}return ui.notifications.error(game.i18n.localize("DSAError.staleData")),t.next=5,e.clearOpposed(r);case 5:return t.abrupt("return",e.createOpposedTest(r,a,o,i));case 6:if((u={speaker:r.flags.oppose.speaker,testResult:c.flags.data.postData,messageId:c.id,img:n.Z.getSpeaker(r.flags.oppose.speaker).img}).testResult.source=c.flags.data.preData.source,u.testResult.ammo&&(s=u.testResult.source.effects).push.apply(s,d(u.testResult.ammo.effects)),l={speaker:a.speaker,testResult:o,messageId:a.id,img:r.msg},(f=c.flags.data.defenderMessage?Array.from(c.flags.data.defenderMessage):[]).push(a.id),!game.user.isGM){t.next=15;break}return t.next=15,c.update({"flags.data.defenderMessage":f});case 15:return t.next=17,a.update({"flags.data.attackerMessage":c.id});case 17:return t.next=19,this.completeOpposedProcess(u,l,{target:!0,startMessageId:r.flags.oppose.startMessageId,whisper:a.whisper,blind:a.blind});case 19:return t.next=21,e.clearOpposed(r);case 21:case"end":return t.stop()}}),t,this)}))),function(e,t,r,n){return D.apply(this,arguments)})},{key:"videoOrImgTag",value:function(e){return/\.webm$/.test(e)?'<video loop autoplay src="'.concat(e,'" width="50" height="50"></video>'):'<img src="'.concat(e,'" width="50" height="50"/>')}},{key:"createOpposedTest",value:(T=g(y().mark((function t(r,n,a,o){var i,s,c,u;return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=n.speaker.token?canvas.tokens.get(n.speaker.token).document:r.prototypeToken,a.successLevel>0?(s=n.flags.data.preData.attackOfOpportunity,c=s?"":'<div><button class="unopposed-button small-button chat-button-target" data-target="true">'.concat(game.i18n.localize("Unopposed"),"</button></div>"),u=[],game.user.targets.forEach(function(){var t=g(y().mark((function t(r){var a,o;return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!r.actor){t.next=15;break}return a="".concat(e.opposeMessage(i,r,!1)," ").concat(c),t.next=4,ChatMessage.create(p({user:game.user.id,content:a,speaker:n.speaker},"flags.unopposeData",{attackMessageId:n.id,targetSpeaker:{scene:r.scene.id,token:r.id,alias:r.document.name}}));case 4:if(o=t.sent,game.user.isGM){t.next=9;break}game.socket.emit("system.dsa5",{type:"target",payload:{target:r.id,scene:canvas.scene.id,opposeFlag:{speaker:n.speaker,messageId:n.id,startMessageId:o.id}}}),t.next=11;break;case 9:return t.next=11,r.actor.update({"flags.oppose":{speaker:n.speaker,messageId:n.id,startMessageId:o.id}});case 11:if(u.push(o.id),!s){t.next=15;break}return t.next=15,e.resolveUndefended(o,game.i18n.localize("OPPOSED.attackOfOpportunity"));case 15:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),n.flags.data.startMessagesList=u):game.user.targets.forEach(function(){var t=g(y().mark((function t(r){return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!r.actor){t.next=3;break}return t.next=3,ChatMessage.create({user:game.user.id,content:e.opposeMessage(i,r,!0),speaker:n.speaker});case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 2:case"end":return t.stop()}}),t)}))),function(e,t,r,n){return T.apply(this,arguments)})},{key:"opposeMessage",value:function(t,r,n){return'<div class ="opposed-message">\n            <b>'.concat(t.name,"</b> ").concat(game.i18n.localize("ROLL.Targeting")," <b>").concat(r.document.name,"</b> ").concat(n?game.i18n.localize("ROLL.failed"):"",'\n            </div>\n            <div class = "opposed-tokens row-section">\n                <div class="col two attacker">').concat(e.videoOrImgTag(t.texture.src),'</div>\n                <div class="col two defender">').concat(e.videoOrImgTag(r.document.texture.src),"</div>\n            </div>\n             ")}},{key:"changeStartMessage",value:(L=g(y().mark((function e(t){var r,n,a,o,i;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=f(t.flags.data.startMessagesList),e.prev=1,r.s();case 3:if((n=r.n()).done){e.next=12;break}return a=n.value,o=game.messages.get(a),i=o.flags.unopposeData,game.socket.emit("system.dsa5",{type:"target",payload:{target:i.targetSpeaker.token,scene:canvas.scene.id,opposeFlag:{speaker:t.speaker,messageId:t.id,startMessageId:o.id}}}),e.next=10,o.update({"flags.unopposeData.attackMessageId":t.id});case 10:e.next=3;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(1),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[1,14,17,20]])}))),function(e){return L.apply(this,arguments)})},{key:"resolveFinalMessage",value:function(t){var r,n;if(t.flags.data.defenderMessage){var a,o=f(t.flags.data.defenderMessage);try{for(o.s();!(a=o.n()).done;){var i=a.value;r=e.getMessageDude(t);var s=game.messages.get(i);n=e.getMessageDude(s),this.completeOpposedProcess(r,n,{blind:t.blind,whisper:t.whisper})}}catch(e){o.e(e)}finally{o.f()}}else{n=e.getMessageDude(t);var c=game.messages.get(t.flags.data.attackerMessage);r=e.getMessageDude(c),this.completeOpposedProcess(r,n,{blind:t.blind,whisper:t.whisper})}}},{key:"getMessageDude",value:function(e){var t,r={speaker:e.speaker,testResult:mergeObject(e.flags.data.postData,{source:e.flags.data.preData.source}),img:n.Z.getSpeaker(e.speaker).data.img,messageId:e.id};return r.testResult.ammo&&(t=r.testResult.source.effects).push.apply(t,d(r.testResult.ammo.effects)),r}},{key:"showDamage",value:(S=g(y().mark((function e(t){var r,n=arguments;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]&&n[1],!game.user.isGM){e.next=8;break}if(r&&t.flags.data.hideDamage||!t.flags.data.postData.damageRoll){e.next=6;break}return e.next=5,t.update({content:t.content.replace('data-hide-damage="'.concat(!r,'"'),'data-hide-damage="'.concat(r,'"')),"flags.data.hideDamage":r});case 5:r||a.Z._addRollDiceSoNice(t.flags.data.preData,Roll.fromData(t.flags.data.postData.damageRoll),game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"));case 6:e.next=9;break;case 8:game.socket.emit("system.dsa5",{type:"showDamage",payload:{id:t.id,hide:r}});case 9:case"end":return e.stop()}}),e)}))),function(e){return S.apply(this,arguments)})},{key:"playAutomatedJBA2",value:(E=g(y().mark((function e(t,r,a){var o,i,s,c,l;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.Z.moduleEnabled("autoanimations")){e.next=12;break}if(o=n.Z.getSpeaker(t.speaker).getActiveTokens()[0],i=n.Z.getSpeaker(r.speaker).getActiveTokens()[0],o&&o.actor&&i&&i.actor){e.next=5;break}return e.abrupt("return");case 5:if((s=o.actor.items.get(t.testResult.source._id))||(s=new u.Z(t.testResult.source,{temporary:!0})),s){e.next=9;break}return e.abrupt("return");case 9:c=[i],l="attacker"==a.winner?c:[],AutoAnimations.playAnimation(o,c,s,{hitTargets:l,playOnMiss:!0});case 12:case"end":return e.stop()}}),e)}))),function(e,t,r){return E.apply(this,arguments)})},{key:"showSpellWithoutTarget",value:(O=g(y().mark((function e(t){var r,a,o,i;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.Z.moduleEnabled("autoanimations")){e.next=13;break}if((r=getProperty(t,"flags.data"))&&!r.isOpposedTest){e.next=4;break}return e.abrupt("return");case 4:if(!((getProperty(r,"postData.result")||-1)>0)){e.next=13;break}if((a=n.Z.getSpeaker(r.postData.speaker).getActiveTokens()[0])&&a.actor){e.next=9;break}return e.abrupt("return");case 9:o=Array.from(game.user.targets),i=a.actor.items.get(r.preData.source._id),o.length||(o=[a]),AutoAnimations.playAnimation(a,o,i);case 13:case"end":return e.stop()}}),e)}))),function(e){return O.apply(this,arguments)})},{key:"clearOpposed",value:(_=g(y().mark((function e(t){return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=5;break}return e.next=3,t.update(p({},"flags.-=oppose",null));case 3:e.next=6;break;case 5:game.socket.emit("system.dsa5",{type:"clearOpposed",payload:{actorId:t.id}});case 6:case"end":return e.stop()}}),e)}))),function(e){return _.apply(this,arguments)})},{key:"_handleReaction",value:(x=g(y().mark((function e(t){var r,n,a,i;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=$(t.currentTarget).parents(".message").attr("data-message-id"),n=game.messages.get(r),a=game.messages.get(n.flags.unopposeData.attackMessageId),i=a.flags.data.preData.source,e.t0=i.type,e.next="skill"===e.t0?7:9;break;case 7:return o.$G.showDialog(n),e.abrupt("break",10);case 9:o.MN.showDialog(n);case 10:case"end":return e.stop()}}),e)}))),function(e){return x.apply(this,arguments)})},{key:"chatListeners",value:(k=g(y().mark((function e(t){var r=this;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.on("click",".unopposed-button",(function(e){e.preventDefault(),r._handleReaction(e)}));case 1:case"end":return e.stop()}}),e)}))),function(e){return k.apply(this,arguments)})},{key:"hideReactionButton",value:(w=g(y().mark((function e(t){var r,n;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=11;break}if(!game.user.isGM){e.next=10;break}return r=game.messages.get(t),(n=$(r.content)).find("button.unopposed-button").remove(),n=$("<div></div>").append(n),e.next=8,r.update({content:n.html()});case 8:e.next=11;break;case 10:game.socket.emit("system.dsa5",{type:"hideQueryButton",payload:{id:t}});case 11:case"end":return e.stop()}}),e)}))),function(e){return w.apply(this,arguments)})},{key:"completeOpposedProcess",value:(v=g(y().mark((function e(t,r,n){var a;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.evaluateOpposedTest(t.testResult,r.testResult,n);case 2:return a=e.sent,this.formatOpposedResult(a,t.speaker,r.speaker),this.rerenderMessagesWithModifiers(a,t,r),e.next=7,Hooks.call("finishOpposedTest",t,r,a,n);case 7:return this.playAutomatedJBA2(t,r,a),e.next=10,this.renderOpposedResult(a,n);case 10:return e.next=12,this.hideReactionButton(n.startMessageId);case 12:return e.abrupt("return",a);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return v.apply(this,arguments)})},{key:"evaluateOpposedTest",value:(m=g(y().mark((function e(t,r){var n,a,o=arguments;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=o.length>2&&void 0!==o[2]?o[2]:{},(a={}).other=[],n.additionalInfo&&a.other.push(n.additionalInfo),a.winner="attacker",["weapon","spell","liturgy","ceremony","ritual","combatskill"].includes(t.rollType)&&null==r.successLevel&&(r.successLevel=-5),null==r.successLevel){e.next=16;break}e.t0=t.rollType,e.next="combatskill"===e.t0||"talent"===e.t0?10:"ceremony"===e.t0||"ritual"===e.t0||"spell"===e.t0||"liturgy"===e.t0||"weapon"===e.t0?12:14;break;case 10:return this._evaluateTalentOpposedRoll(t,r,a,n),e.abrupt("break",16);case 12:return this._evaluateWeaponOpposedRoll(t,r,a,n),e.abrupt("break",16);case 14:ui.notifications.error("Can not oppose "+t.rollType),console.warn("Can not oppose "+t.rollType);case 16:return e.abrupt("return",a);case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"_evaluateWeaponOpposedRoll",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(e.successLevel>0&&t.successLevel<0){var a=this._calculateOpposedDamage(e,t,n);a.armorDamaged.damaged&&a.armorDamaged.ids.length&&r.other.push('<div class="center"><button class="gearDamaged onlyTarget" data-uuid="'.concat(a.armorDamaged.ids.join(";"),'">').concat(game.i18n.localize("WEAR.checkShort"),"</button></div>")),r.winner="attacker";var o=[0!=a.armorMod?"".concat(a.armorMod+" "+game.i18n.localize("Modifier")):"",1!=a.armorMultiplier?"*"+a.armorMultiplier+" "+game.i18n.localize("Modifier"):"",0!=a.spellArmor?"".concat(a.spellArmor," ").concat(game.i18n.localize("spellArmor")):"",0!=a.liturgyArmor?"".concat(a.liturgyArmor," ").concat(game.i18n.localize("liturgyArmor")):""],i="<b>".concat(game.i18n.localize("damage"),"</b>: ").concat(a.damage,' - <span data-tooltip="').concat(o.join(""),'">').concat(a.armor," (").concat(game.i18n.localize("protection"),")</span> = ").concat(a.sum);r.damage={description:i,value:a.sum,sp:a.damage}}else r.winner="defender"}},{key:"_calculateOpposedDamage",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=n.Z.getSpeaker(t.speaker);r.origin=e.source,r.damage=e.damage;var o,u=c.Z.applyRollTransformation(a,r,5).options.damage,l=i.Z.armorValue(a,r),p=l.wornArmor,d=l.armor,h=[],m=0,y=e.armorPen||[],v=f(y);try{for(v.s();!(o=v.n()).done;){var g=o.value;/^\*/.test(g)?h.push(Number(g.replace("*",""))):m+=Number(g)}}catch(e){v.e(e)}finally{v.f()}var b=0,w=0;["spell","ritual"].includes(e.source.type)?b+=a.system.spellArmor||0:["liturgy","ceremony"].includes(e.source.type)&&(b+=a.system.liturgyArmor||0),d+=m;var k=h.reduce((function(e,t){return e*t}),1);d=Math.max(Math.round(d*k),0),d+=b+w;var x=s.Z.armorGetsDamage(u,e),_=p.map((function(e){return e.uuid}));return{damage:u,armor:d,armorDamaged:{damaged:x,ids:_},armorMod:m,spellArmor:b,liturgyArmor:w,armorMultiplier:k,sum:u-d}}},{key:"_evaluateTalentOpposedRoll",value:function(e,t,r){e.successLevel>0&&e.successLevel>t.successLevel?r.winner="attacker":e.qualityStep>t.qualityStep||e.result>=0&&t.result<0?(r.winner="attacker",r.differenceSL=e.qualityStep-t.qualityStep):(r.winner="defender",r.differenceSL=t.qualityStep-e.qualityStep)}},{key:"formatOpposedResult",value:function(e,t,r){var n=e.differenceSL?"winsFP":"wins";return"attacker"==e.winner?(e.result=game.i18n.format("OPPOSED."+n,{winner:t.alias,loser:r.alias,SL:e.differenceSL}),e.img=t.img):"defender"==e.winner&&(e.result=game.i18n.format("OPPOSED."+n,{winner:r.alias,loser:t.alias,SL:e.differenceSL}),e.img=r.img),e.speakerAttack=t,e.speakerDefend=r,e.swapped&&(e.speakerAttack=r,e.speakerDefend=t),e}},{key:"rerenderMessagesWithModifiers",value:function(e,t,r){var n=game.messages.get(t.messageId);this.showDamage(n,"attacker"!=e.winner)}},{key:"renderOpposedResult",value:(h=g(y().mark((function e(t){var r,n,a,o=arguments;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:{},e.next=3,game.settings.get("dsa5","hideOpposedDamage");case 3:return t.hideData=e.sent,e.next=6,renderTemplate("systems/dsa5/templates/chat/roll/opposed-result.html",t);case 6:if(n=e.sent,a={user:game.user.id,content:n,"flags.opposeData":t,"flags.hideData":t.hideData,whisper:r.whisper,blind:r.blind},!r.target){e.next=14;break}return a["flags.startMessageId"]=r.startMessageId,e.next=12,ChatMessage.create(a);case 12:case 17:e.next=23;break;case 14:return e.prev=14,e.next=17,this.startMessage.update(a).then((function(e){ui.chat.updateMessage(e)}));case 19:return e.prev=19,e.t0=e.catch(14),e.next=23,ChatMessage.create(a);case 23:case"end":return e.stop()}}),e,this,[[14,19]])}))),function(e){return h.apply(this,arguments)})},{key:"resolveUndefended",value:(l=g(y().mark((function e(t){var r,n,a,o,i,s,c,u=arguments;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=u.length>1&&void 0!==u[1]?u[1]:"",a=t.flags.unopposeData,o=game.messages.get(a.attackMessageId),(i={speaker:o.speaker,testResult:o.flags.data.postData,messageId:a.attackMessageId}).testResult.source=o.flags.data.preData.source,i.testResult.ammo&&(r=i.testResult.source.effects).push.apply(r,d(i.testResult.ammo.effects)),s=canvas.tokens.get(a.targetSpeaker.token),c={speaker:a.targetSpeaker,testResult:{actor:s.actor,speaker:{token:a.targetSpeaker.token}}},e.next=10,this.clearOpposed(s.actor);case 10:return e.next=12,this.completeOpposedProcess(i,c,{target:!0,startMessageId:t.id,additionalInfo:n});case 12:if(!game.user.isGM){e.next=17;break}return e.next=15,o.update({"flags.data.unopposedStartMessage":t.id});case 15:e.next=19;break;case 17:return e.next=19,game.socket.emit("system.dsa5",{type:"updateAttackMessage",payload:{messageId:o.id,startMessageId:t.id}});case 19:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})}],r&&b(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},903:(e,t,r)=>{r.d(t,{Z:()=>d});var n=r(15),a=r(231),o=r(491);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function s(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function u(){u=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};c(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,s,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==i(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,c(b,"constructor",m),c(m,"constructor",h),h.displayName=c(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,c(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),c(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),c(b,s,"Generator"),c(b,a,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function l(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function f(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){l(o,n,a,i,s,"next",e)}function s(e){l(o,n,a,i,s,"throw",e)}i(void 0)}))}}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i,c,l,d,h,m,y,v,g,b,w;return t=e,null,r=[{key:"requestGC",value:(w=f(u().mark((function t(r,n,o){var i,s,c,l,p,d,h=arguments;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=h.length>3&&void 0!==h[3]?h[3]:0,s=a.Z._getActor(),c=s.actor,l=s.tokenId,c){t.next=4;break}return t.abrupt("return");case 4:game.user.updateTokenTargets([]),p={modifier:i,postFunction:{cummulative:o,functionName:"RequestRoll.autoEditGroupCheckRoll"}},t.t0=r,t.next="attribute"===t.t0?9:10;break;case 9:return t.abrupt("break",12);case 10:d=c.items.find((function(e){return e.name==n&&e.type==r})),c.setupSkill(d,p,l).then(function(){var t=f(u().mark((function t(a){var i;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,c.basicTest(a);case 2:return i=t.sent,t.next=5,e.editGroupCheckRoll(o,i,n,r);case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 12:case"end":return t.stop()}}),t)}))),function(e,t,r){return w.apply(this,arguments)})},{key:"autoEditGroupCheckRoll",value:(b=f(u().mark((function t(r,n,a){return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.editGroupCheckRoll(r.cummulative,n,a.name,a.type);case 2:case"end":return t.stop()}}),t)}))),function(e,t,r){return b.apply(this,arguments)})},{key:"editGroupCheckRoll",value:(g=f(u().mark((function t(r,n,a,i){var s,c,l,f,p,d,h;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,game.messages.get(r);case 2:s=t.sent,c=s.flags,l=n.result.successLevel>1,f=l?2:1,c.botched=c.botched||n.result.successLevel<-1,p=o.Z.getSpeaker(n.result.speaker),d={messageId:n.result.messageId,actor:p.name,qs:(n.result.qualityStep||0)*f,success:n.result.successLevel,target:a,type:i},(h=c.results.findIndex((function(e){return e.messageId==d.messageId})))>=0?c.results[h]=d:c.results.push(d),e.rerenderGC(s,c);case 12:case"end":return t.stop()}}),t)}))),function(e,t,r,n){return g.apply(this,arguments)})},{key:"requestRoll",value:(v=f(u().mark((function e(t,r){var n,o,i,s,c,l,f,p=arguments;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=p.length>2&&void 0!==p[2]?p[2]:0,o=a.Z._getActor(),i=o.actor,s=o.tokenId,!i){e.next=15;break}game.user.updateTokenTargets([]),c={modifier:n},e.t0=t,e.next="attribute"===e.t0?8:"regeneration"===e.t0?11:13;break;case 8:return l=Object.keys(game.dsa5.config.characteristics).find((function(e){return game.i18n.localize(game.dsa5.config.characteristics[e])==r})),i.setupCharacteristic(l,c,s).then((function(e){i.basicTest(e)})),e.abrupt("break",15);case 11:return i.setupRegeneration("regenerate",c,s).then((function(e){i.basicTest(e)})),e.abrupt("break",15);case 13:f=i.items.find((function(e){return e.name==r&&e.type==t})),i.setupSkill(f,c,s).then((function(e){i.basicTest(e)}));case 15:case"end":return e.stop()}}),e)}))),function(e,t){return v.apply(this,arguments)})},{key:"rerenderGC",value:(y=f(u().mark((function e(t,r){var n,a,o,i,c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=14;break}n=0,r.qs=r.results.reduce((function(e,t){return n+=t.success<0?1:0,t.success>1&&(n=0),e+t.qs}),0),r.failed=n,a=s(r.rollOptions);try{for(a.s();!(o=a.n()).done;)(i=o.value).calculatedModifier=i.modifier-n}catch(e){a.e(e)}finally{a.f()}return r.openRolls=r.maxRolls-r.results.length,r.doneRolls=r.results.length,e.next=10,renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",r);case 10:c=e.sent,t.update({content:c,flags:r}),e.next=15;break;case 14:game.socket.emit("system.dsa5",{type:"updateGroupCheck",payload:{messageId:t.id,data:r}});case 15:$("#chat-log").find('[data-message-id="'.concat(t.id,'"')).appendTo("#chat-log");case 16:case"end":return e.stop()}}),e)}))),function(e,t){return y.apply(this,arguments)})},{key:"showRQMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=t<0?" ".concat(t):t>0?" +".concat(t):"",n=a.Z.skills.find((function(t){return t.name==e})).type,i=game.i18n.format("CHATNOTIFICATION.requestRoll",{user:game.user.name,item:'<a class="roll-button request-roll" data-type="'.concat(n,'" data-modifier="').concat(t,'" data-name="').concat(e,'"><i class="fas fa-dice"></i> ').concat(e).concat(r,"</a>")});ChatMessage.create(o.Z.chatDataSetup(i))}},{key:"showGCMessage",value:(m=f(u().mark((function e(t){var r,n,i,s,c,l,f=arguments;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=f.length>1&&void 0!==f[1]?f[1]:0,n=f.length>2&&void 0!==f[2]?f[2]:{},i=a.Z.skills.find((function(e){return e.name==t})).type,s={results:[],qs:0,failed:0,modifier:r,name:game.user.name,maxRolls:7,openRolls:7,doneRolls:0,targetQs:10,rollOptions:[{type:i,modifier:r,calculatedModifier:r,target:t}]},mergeObject(s,n),e.next=7,renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",s);case 7:c=e.sent,(l=o.Z.chatDataSetup(c)).flags=s,ChatMessage.create(l);case 11:case"end":return e.stop()}}),e)}))),function(e){return m.apply(this,arguments)})},{key:"addSkillToGC",value:(h=f(u().mark((function t(r){var o,i,s;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return o=$(r.currentTarget).parents(".message").attr("data-message-id"),t.next=3,renderTemplate("systems/dsa5/templates/dialog/addgroupcheckskill.html",{skills:a.Z.skills.filter((function(e){return"skill"==e.type})).sort((function(e,t){return e.name.localeCompare(t.name)}))});case 3:i=t.sent,s={title:game.i18n.localize("HELP.groupcheck"),content:i,buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:function(){var t=f(u().mark((function t(r){var n,a;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=game.messages.get(o),(a=n.flags).rollOptions.push({type:"skill",modifier:r.find('[name="modifier"]').val(),target:r.find('[name="skill"]').val()}),e.rerenderGC(n,a);case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}},new n.Z(s).render(!0);case 6:case"end":return t.stop()}}),t)}))),function(e){return h.apply(this,arguments)})},{key:"removeGCEntry",value:(d=f(u().mark((function t(r){var n,a,o,i;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=$(r.currentTarget),a=Number(r.currentTarget.dataset.index),o=game.messages.get(n.parents(".message").attr("data-message-id")),(i=o.flags).results.splice(a,1),e.rerenderGC(o,i);case 6:case"end":return t.stop()}}),t)}))),function(e){return d.apply(this,arguments)})},{key:"removeSkillFromGC",value:function(t){var r=$(t.currentTarget),n=game.messages.get(r.parents(".message").attr("data-message-id")),a=n.flags;a.rollOptions=a.rollOptions.filter((function(e){return!(e.type==t.currentTarget.dataset.type&&e.target==t.currentTarget.dataset.name)})),a.results=a.results.filter((function(e){return!(e.type==t.currentTarget.dataset.type&&e.target==t.currentTarget.dataset.name)})),e.rerenderGC(n,a)}},{key:"editGC",value:(l=f(u().mark((function t(r){var n,a,o,i;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=$(r.currentTarget),a=Number(r.currentTarget.dataset.index),o=game.messages.get(n.parents(".message").attr("data-message-id")),i=o.flags,a?i.results[a].qs=Number(n.val()):r.currentTarget.dataset.name?i.rollOptions.find((function(e){return e.target==r.currentTarget.dataset.name&&r.currentTarget.dataset.type==e.type}))[r.currentTarget.dataset.field]=Number(n.val()):i[r.currentTarget.dataset.field]=Number(n.val()),e.rerenderGC(o,i);case 6:case"end":return t.stop()}}),t)}))),function(e){return l.apply(this,arguments)})},{key:"updateInformationRoll",value:(c=f(u().mark((function e(t,r,n){var a,i,s,c,l,f;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((a=r.result.qualityStep||0)>0)){e.next=10;break}return e.next=4,fromUuid(t.uuid);case 4:for(i=e.sent,s=[],c=1;c<=a;c++)l="qs".concat(c),i.system[l]&&s.push("<p>".concat(i.system[l],"</p>"));f=o.Z.chatDataSetup(s.join("")),t.recipients.length&&(f.whisper=t.recipients),ChatMessage.create(f);case 10:case"end":return e.stop()}}),e)}))),function(e,t,r){return c.apply(this,arguments)})},{key:"informationRequestRoll",value:(i=f(u().mark((function e(t){var r,n,o,i,s,c,l,p,d,h=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.currentTarget.dataset.mod,n=t.currentTarget.dataset.uuid,o=a.Z._getActor(),i=o.actor,s=o.tokenId,i){e.next=5;break}return e.abrupt("return");case 5:1==(c=game.settings.get("dsa5","informationDistribution"))?(l=game.users.filter((function(e){return e.isGM})).map((function(e){return e.id}))).push(game.user.id):2==c&&(l=game.users.filter((function(e){return e.isGM})).map((function(e){return e.id}))),p={modifier:r,postFunction:{functionName:"RequestRoll.updateInformationRoll",uuid:n,recipients:l}},d=i.items.find((function(e){return e.name==t.currentTarget.dataset.skill&&"skill"==e.type})),i.setupSkill(d,p,s).then(function(){var e=f(u().mark((function e(t){var r;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.testData.opposable=!1,e.next=3,i.basicTest(t);case 3:r=e.sent,h.updateInformationRoll(p.postFunction,r);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 10:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)})},{key:"chatListeners",value:function(t){t.on("change",".editGC",(function(t){return e.editGC(t)})),t.on("click",".request-roll",(function(t){var r=t.currentTarget.dataset;e.requestRoll(r.type,r.name,Number(r.modifier)||0)})),t.on("click",".request-gc",(function(t){var r=t.currentTarget.dataset;e.requestGC(r.type,r.name,$(t.currentTarget).parents(".message").attr("data-message-id"),Number(r.modifier)||0)})),t.on("click",".removeGC",(function(t){return e.removeGCEntry(t)})),t.on("click",".removeSkillFromGC",(function(t){return e.removeSkillFromGC(t)})),t.on("click",".addSkillToGC",(function(t){return e.addSkillToGC(t)})),t.on("click",".informationRequestRoll",(function(t){return e.informationRequestRoll(t)}))}}],r&&p(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},122:(e,t,r)=>{r.d(t,{Z:()=>m}),r(839);var n=r(973),a=r(173),o=r(491);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(){c=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,s,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==i(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,s,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function u(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){u(o,n,a,i,s,"next",e)}function s(e){u(o,n,a,i,s,"throw",e)}i(void 0)}))}}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var p,d,h,m=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i,u;return t=e,null,r=[{key:"multipleDefenseValue",value:function(e,t){var r=-3;return"dodge"!=t.type&&getProperty(t,"system.combatskill.value")!=game.i18n.localize("LocalizedIDs.wrestle")||!a.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulDodge"))?a.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.mightyMasterfulParry"))?r=-1:a.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulParry"))&&(r=-2):r=-2,a.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.vinsaltStyle"))&&(r-=1),Math.min(0,r)}},{key:"isFamiliar",value:function(e){return null!=e.items.find((function(e){return"trait"==e.type&&game.i18n.localize("LocalizedIDs.familiar")==e.name}))}},{key:"isPet",value:function(e){return null!=e.items.find((function(e){return"trait"==e.type&&game.i18n.localize("LocalizedIDs.companion")==e.name}))}},{key:"bleedingMessage",value:(u=l(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ChatMessage.create(o.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.applyBleeding",{actor:t.name,actorId:t.id,tokenId:t.token?t.token.id:""})));case 2:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)})},{key:"_getFunctionData",value:function(e){return{data:e.currentTarget.dataset,actor:o.Z.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}},{key:"isYieldedTwohanded",value:function(e){var t=this.regex2h.test(e.name),r=e.system.worn.wrongGrip;return t&&!r||!t&&r}},{key:"_buildDuration",value:function(e){var t={duration:{startTime:game.time.worldTime,rounds:e,seconds:5*e}};return game.combat&&mergeObject(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}},{key:"calcBleeding",value:(i=l(c().mark((function t(r){var a,i,s,u;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=e._getFunctionData(r),i=a.data,s=a.actor){t.next=3;break}return t.abrupt("return");case 3:u=s.items.find((function(e){return e.name==game.i18n.localize("LocalizedIDs.selfControl")&&"skill"==e.type})),s.setupSkill(u,{},i.token).then(function(){var t=l(c().mark((function t(r){var a,i,u,l,f,p,d;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.basicTest(r);case 2:if(!((a=t.sent).result.successLevel<2)){t.next=22;break}if(i=a.result.qualityStep||0,u=7,1==a.result.successLevel?u-=Number(i):a.successLevel<1&&(u+=u),l=s.hasCondition("bleeding"),f=e._buildDuration(u),!l){t.next=16;break}if(p=game.combat?(l.data.duration.startRound||1)+l.data.duration.rounds-game.combat.round:l.data.duration.rounds,!(u>p)){t.next=14;break}return t.next=14,l.update(f);case 14:t.next=22;break;case 16:return d=duplicate(CONFIG.statusEffects.find((function(e){return"bleeding"==e.id}))),mergeObject(d,f),t.next=20,n.Z.addCondition(s,d,1,!1,!0);case 20:return t.next=22,ChatMessage.create(o.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.gotBleeding",{actor:s.name})));case 22:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 5:case"end":return t.stop()}}),t)}))),function(e){return i.apply(this,arguments)})},{key:"increment",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,a=e.ctrlKey?10:1,o=2==e.button?-1:1,i=getProperty(t,r)+a*o;null!=n&&(i=Math.max(n,i)),setProperty(t,r,i)}},{key:"magicalImprovement",value:function(e,t){var r,n=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw o}}}}(e.items);try{for(n.s();!(r=n.n()).done;){var a=r.value;["ritual","spell"].includes(a.type)&&(a.data.talentValue.value+=4)}}catch(e){n.e(e)}finally{n.f()}}}],r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();h=/\(2H/,(d="regex2h")in(p=m)?Object.defineProperty(p,d,{value:h,enumerable:!0,configurable:!0,writable:!0}):p[d]=h},173:(e,t,r)=>{r.d(t,{Z:()=>y});var n=r(577),a=r(794);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(){i=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,i,s,c){var u=f(e[a],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==o(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function s(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function c(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){s(o,n,a,i,c,"next",e)}function c(e){s(o,n,a,i,c,"throw",e)}i(void 0)}))}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(){return f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=p(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},f.apply(this,arguments)}function p(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=m(e)););return e}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function h(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(k,e);var t,r,a,o,s,p,y,v,g,b,w=(g=k,b=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=m(g);if(b){var r=m(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return h(this,e)});function k(){return u(this,k),w.apply(this,arguments)}return t=k,null,r=[{key:"setupFunctions",value:function(){}},{key:"abilityAdded",value:(v=c(i().mark((function e(t,r){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.Z.addAbilityRules[r.name]&&n.Z.addAbilityRules[r.name](t,r);case 1:case"end":return e.stop()}}),e)}))),function(e,t){return v.apply(this,arguments)})},{key:"abilityRemoved",value:(y=c(i().mark((function e(t,r){var a,o,s;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.Z.removeAbilityRules[r.name]&&n.Z.removeAbilityRules[r.name](t,r),a=r.system.APValue.value*r.system.step.value,/;/.test(r.system.APValue.value))for(o=r.system.APValue.value.split(";").map((function(e){return Number(e.trim())})),a=0,s=0;s<r.system.step.value;s++)a+=o[s];return e.next=5,k.refundFreelanguage(r,t,a);case 5:return a=e.sent,e.next=8,t._updateAPs(-1*a);case 8:case"end":return e.stop()}}),e)}))),function(e,t){return y.apply(this,arguments)})},{key:"_specialabilityReturnFunction",value:(p=c(i().mark((function e(t,r,a,o){var s,c,u,l,f,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r){e.next=2;break}return e.abrupt("return");case 2:if(r=duplicate(r),null!=o&&(/,/.test(r.system.APValue.value)&&(c="".concat(r.name.replace(" ()","")," (").concat(o.name),r.system.APValue.value=r.system.APValue.value.split(",")[t.items.filter((function(e){return e.type==r.type&&e.name.includes(c)})).length].trim()),k.simpleAdoption(r,o,r.name,n.Z.AbilitiesNeedingAdaption),r.name="".concat(r.name.replace(" ()","")," (").concat(o.name).concat(o.customEntry?", "+o.customEntry:"",")"),o.data&&null!==(s=o.system.StF)&&void 0!==s&&s.value&&/\//.test(r.system.APValue.value)&&(r.system.APValue.value=r.system.APValue.value.split("/")[o.system.StF.value.charCodeAt(0)-65].trim())),!(u=t.items.find((function(e){return e.type==a&&e.name==r.name})))){e.next=25;break}return l=duplicate(u),e.next=9,k.isFreeLanguage(r,t,/;/.test(l.system.APValue.value)?l.system.APValue.value.split(";").map((function(e){return Number(e.trim())}))[l.system.step.value]:l.system.APValue.value);case 9:if(f=e.sent,e.t0=l.system.step.value+1<=l.system.maxRank.value,!e.t0){e.next=15;break}return e.next=14,t.checkEnoughXP(f);case 14:e.t0=e.sent;case 15:if(!e.t0){e.next=23;break}return l.system.step.value+=1,e.next=19,t._updateAPs(f);case 19:return e.next=21,t.updateEmbeddedDocuments("Item",[l]);case 21:return e.next=23,k.abilityAdded(t,l);case 23:e.next=37;break;case 25:return e.next=27,k.isFreeLanguage(r,t,r.system.APValue.value.split(";").map((function(e){return e.trim()}))[0]);case 27:return p=e.sent,e.next=30,t.checkEnoughXP(p);case 30:if(!e.sent){e.next=37;break}return e.next=33,k.abilityAdded(t,r);case 33:return e.next=35,t._updateAPs(p);case 35:return e.next=37,t.createEmbeddedDocuments("Item",[r]);case 37:case"end":return e.stop()}}),e)}))),function(e,t,r,n){return p.apply(this,arguments)})},{key:"refundFreelanguage",value:(s=c(i().mark((function e(t,r,n){var a,o,s,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("language"!=t.system.category.value||!r.system.freeLanguagePoints){e.next=8;break}return a=Number(r.system.freeLanguagePoints.value),o=r.items.filter((function(e){return"specialability"==e.type&&"language"==e.system.category.value})).reduce((function(e,t){return e+Number(t.system.step.value)*Number(t.system.APValue.value)}),0),s=Math.min(a,o-Number(n)),c=Math.max(0,a-s),e.next=7,r.update({"system.freeLanguagePoints.used":Math.min(a,Number(s))});case 7:n=Math.max(0,n-c);case 8:return e.abrupt("return",n);case 9:case"end":return e.stop()}}),e)}))),function(e,t,r){return s.apply(this,arguments)})},{key:"isFreeLanguage",value:(o=c(i().mark((function e(t,r,n){var a,o,s,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("language"!=t.system.category.value||!r.system.freeLanguagePoints){e.next=8;break}return a=Number(r.system.freeLanguagePoints.value),o=r.items.filter((function(e){return"specialability"==e.type&&"language"==e.system.category.value})).reduce((function(e,t){return e+Number(t.system.step.value)*Number(t.system.APValue.value)}),0),s=Math.min(a,o),c=Math.max(0,a-s),e.next=7,r.update({"system.freeLanguagePoints.used":Math.min(a,Number(s)+Number(n))});case 7:n=Math.max(0,n-c);case 8:return e.abrupt("return",n);case 9:case"end":return e.stop()}}),e)}))),function(e,t,r){return o.apply(this,arguments)})},{key:"needsAdoption",value:(a=c(i().mark((function e(t,r,a){var o,s,c,u,l;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=n.Z.AbilitiesNeedingAdaption[r.name])){e.next=26;break}if("text"!=o.items){e.next=9;break}return e.next=5,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:r});case 5:s=e.sent,c=function(e){var n={name:e.find('[name="entryselection"]').val()};k._specialabilityReturnFunction(t,r,a,n)},e.next=22;break;case 9:if("array"!=o.items){e.next=17;break}return u=o.elems.map((function(e){return{name:e}})),e.next=13,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:u,original:r,area:o.area});case 13:s=e.sent,c=function(e){var n=u.find((function(t){return t.name==e.find('[name="entryselection"]').val()}));k._specialabilityReturnFunction(t,r,a,n)},e.next=22;break;case 17:return l=t.items.filter((function(e){return o.items.includes(e.type)})).sort((function(e,t){return e.name.localeCompare(t.name)})),e.next=20,renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:l,original:r,area:o.area});case 20:s=e.sent,c=function(e){var n=l.find((function(t){return t.name==e.find('[name="entryselection"]').val()}));n.customEntry=e.find('[name="custom"]').val(),k._specialabilityReturnFunction(t,r,a,n)};case 22:return e.next=24,new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:s,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:c},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0);case 24:e.next=27;break;case 26:k._specialabilityReturnFunction(t,r,a,null);case 27:case"end":return e.stop()}}),e)}))),function(e,t,r){return a.apply(this,arguments)})},{key:"hasAbility",value:function(e,t){return f(m(k),"hasItem",this).call(this,e,t,["specialability"])}},{key:"abilityStep",value:function(e,t){return f(m(k),"itemStep",this).call(this,e,t,["specialability"])}},{key:"abilityAsModifier",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return f(m(k),"itemAsModifier",this).call(this,e,t,r,["specialability"],n)}}],r&&l(t,r),Object.defineProperty(t,"prototype",{writable:!1}),k}(a.Z);a.Z.children.SpecialabilityRulesDSA5=y},101:(e,t,r)=>{r.d(t,{Z:()=>v});var n=r(577),a=r(794),o=r(491);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function s(){s=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,s,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==i(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function c(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function u(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){c(o,n,a,i,s,"next",e)}function s(e){c(o,n,a,i,s,"throw",e)}i(void 0)}))}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function p(){return p="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=d(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},p.apply(this,arguments)}function d(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}function h(e,t){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},h(e,t)}function m(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}(d,e);var t,r,a,o,i,c=(o=d,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=y(o);if(i){var r=y(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return m(this,e)});function d(){return l(this,d),c.apply(this,arguments)}return t=d,null,r=[{key:"traitAdded",value:(a=u(s().mark((function e(t,r){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.Z.addTraitRules[r.name]){e.next=3;break}return e.next=3,n.Z.addTraitRules[r.name](t,r);case 3:case"end":return e.stop()}}),e)}))),function(e,t){return a.apply(this,arguments)})},{key:"hasTrait",value:function(e,t){return p(y(d),"hasItem",this).call(this,e,t,["trait"])}}],r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),d}(a.Z);Hooks.on("setup",(function(){var e=game.i18n.localize("LocalizedIDs.familiar");n.Z.addTraitRules[e]=function(){var t=u(s().mark((function t(r,n){var i,c;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0==n.effects.length&&(n.effects=[{changes:[{key:"system.status.wounds.gearmodifier",mode:2,value:10},{key:"system.status.soulpower.gearmodifier",mode:2,value:1},{key:"system.status.toughness.gearmodifier",mode:2,value:1},{key:"system.status.astralenergy.gearmodifier",mode:2,value:15},{key:"system.characteristics.mu.gearmodifier",mode:2,value:1},{key:"system.characteristics.kl.gearmodifier",mode:2,value:1},{key:"system.characteristics.in.gearmodifier",mode:2,value:1},{key:"system.characteristics.ch.gearmodifier",mode:2,value:1},{key:"system.characteristics.ff.gearmodifier",mode:2,value:1},{key:"system.characteristics.ge.gearmodifier",mode:2,value:1},{key:"system.characteristics.ko.gearmodifier",mode:2,value:1},{key:"system.characteristics.kk.gearmodifier",mode:2,value:1},{key:"system.totalArmor",mode:2,value:1}],duration:{},icon:"icons/svg/aura.svg",label:e,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:e,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}}}]),i=game.i18n.localize("LocalizedIDs.witchSense"),a.Z.hasItem(r,i,["trait"])){t.next=8;break}return t.next=5,o.Z.findAnyItem([{name:i,type:"trait"}]);case 5:return c=t.sent,t.next=8,r.createEmbeddedDocuments("Item",c);case 8:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()}))},491:(e,t,r)=>{r.d(t,{Z:()=>p});var n=r(369),a=r(577);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw o}}}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(){c=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,i,s,c){var u=f(e[a],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==o(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,i,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,s,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function u(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){u(o,n,a,i,s,"next",e)}function s(e){u(o,n,a,i,s,"throw",e)}i(void 0)}))}}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,o,s,u,p,d,h,m,y,v,g,b,w;return t=e,null,r=[{key:"skillByName",value:(w=l(c().mark((function e(t){var r,n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=game.packs.get("de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen"),e.next=3,r.getIndex();case 3:return n=r.index.find((function(e){return e.name===t})),e.next=6,r.getDocument(n._id);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)}))),function(e){return w.apply(this,arguments)})},{key:"allSkills",value:(b=l(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t="de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen",e.next=3,this.getCompendiumEntries(t,"skill");case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"moduleEnabled",value:function(e){return game.modules.get(e)&&game.modules.get(e).active}},{key:"allCombatSkills",value:(g=l(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t="de"==game.i18n.lang?"dsa5.combatskills":"dsa5.combatskillsen",e.next=3,this.getCompendiumEntries(t,"combatskill");case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"getCompendiumEntries",value:(v=l(c().mark((function e(t,r){var n,a,o,s,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.packs.get(t);case 2:if(n=e.sent){e.next=5;break}return e.abrupt("return",ui.notifications.error("No content found"));case 5:return a=[],e.next=8,n.getDocuments().then((function(e){return o=e.filter((function(e){return e.type==r}))}));case 8:s=i(o);try{for(s.s();!(u=s.n()).done;)l=u.value,a.push(l.toObject())}catch(e){s.e(e)}finally{s.f()}return e.abrupt("return",a);case 11:case"end":return e.stop()}}),e)}))),function(e,t){return v.apply(this,arguments)})},{key:"renderToggle",value:function(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}},{key:"calcTokenSize",value:function(e,t){var r=game.dsa5.config.tokenSizeCategories[e.system.status.size.value];if(r)if(r<1)mergeObject(t,{texture:{scaleX:r,scaleY:r},width:1,height:1});else{var n=Math.floor(r),a=Math.max(r/n,.25);mergeObject(t,{width:n,height:n,texture:{scaleX:a,scaleY:a}})}}},{key:"allMoneyItems",value:(y=l(c().mark((function e(){var t;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getCompendiumEntries("dsa5.money","money");case 2:return t=e.sent.map((function(e){return e.system.quantity.value=0,e})),e.abrupt("return",t.filter((function(e){return Object.values(a.Z.moneyNames).map((function(e){return e.toLowerCase()})).includes(e.name.toLowerCase())})).sort((function(e,t){return e.system.price.value>t.system.price.value?-1:1})));case 4:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"allSkillsList",value:(m=l(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.allSkills();case 2:if(e.t0=e.sent,e.t0){e.next=5;break}e.t0=[];case 5:return e.abrupt("return",e.t0.map((function(e){return e.name})).sort((function(e,t){return e.localeCompare(t)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"allCombatSkillsList",value:(h=l(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.allCombatSkills();case 2:if(e.t0=e.sent.filter((function(e){return e.system.weapontype.value==t})),e.t0){e.next=5;break}e.t0=[];case 5:return e.abrupt("return",e.t0.map((function(e){return e.name})).sort((function(e,t){return e.localeCompare(t)})));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"parseAbilityString",value:function(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:null!=e.match(/[-+]\d{1,2}$/)}}},{key:"chatDataSetup",value:function(e,t,r){var n={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(n.rollMode)&&(n.whisper=ChatMessage.getWhisperRecipients("GM").map((function(e){return e.id}))),"blindroll"===n.rollMode?n.blind=!0:"selfroll"===n.rollMode&&(n.whisper=[game.user]),r&&(n.speaker=ChatMessage.getSpeaker(),n.whisper=ChatMessage.getWhisperRecipients(r)),n}},{key:"findItembyId",value:function(e){return game.items.contents.find((function(t){return t.id==e}))}},{key:"findActorbyId",value:function(e){return game.actors.contents.find((function(t){return t.id==e}))}},{key:"findItembyIdAndPack",value:(d=l(c().mark((function e(t,r){var n,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=game.packs.get(r),e.next=3,n.getDocuments().then((function(e){return a=e.find((function(e){return e.id==t}))}));case 3:return e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)}))),function(e,t){return d.apply(this,arguments)})},{key:"getSpeaker",value:function(e){var t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){var r=canvas.tokens.get(e.token);r&&(t=r.actor)}if(!t){var n=game.scenes.get(e.scene);try{n&&(t=new Token(n.getEmbeddedDocument("Token",e.token)).actor)}catch(e){}}return t}},{key:"fateAvailable",value:function(e,t){return t?game.settings.get("dsa5","groupschips").split("/").map((function(e){return Number(e)}))[0]>0:e.system.status.fatePoints.value>0}},{key:"_calculateAdvCost",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return a.Z.advancementCosts[t][Number(e)+r]}},{key:"getFolderForType",value:(p=l(c().mark((function e(t){var r,n,a,o,i,s=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>1&&void 0!==s[1]?s[1]:null,n=s.length>2&&void 0!==s[2]?s[2]:null,a=s.length>3&&void 0!==s[3]?s[3]:0,o=s.length>4&&void 0!==s[4]?s[4]:"",e.next=6,game.folders.contents.find((function(e){var a;return e.name==n&&e.type==t&&(null===(a=e.folder)||void 0===a?void 0:a.id)==r}));case 6:if(i=e.sent){e.next=11;break}return e.next=10,Folder.create({name:n,type:t,sorting:"JournalEntry"==t?"a":"m",color:o,sort:a,parent:r});case 10:i=e.sent;case 11:return e.abrupt("return",i);case 12:case"end":return e.stop()}}),e)}))),function(e){return p.apply(this,arguments)})},{key:"toObjectIfPossible",value:function(e){return"function"==typeof e.toObject?e.toObject(!1):duplicate(e)}},{key:"showArtwork",value:(u=l(c().mark((function e(t){var r,n,a,o,i,s=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.img,n=t.name,a=t.uuid,o=t.isOwner,i=s.length>1&&void 0!==s[1]&&s[1],new ImagePopout(r,{title:i?o?n:"-":n,shareable:!0,uuid:a}).render(!0);case 3:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)})},{key:"findAnyItem",value:(s=l(c().mark((function e(t){var r,n,a,o,s,u,l,f,p,d,h,m,y;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],n=t.map((function(e){return e.name})),a=t.map((function(e){return e.type})),o=i(game.items.contents),e.prev=4,o.s();case 6:if((s=o.n()).done){e.next=14;break}if(u=s.value,(l=n.indexOf(u.name))>=0&&a[l]==u.type&&(n.splice(l,1),a.splice(l,1),r.push(u)),!(n.length<=0)){e.next=12;break}return e.abrupt("break",14);case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),o.e(e.t0);case 19:return e.prev=19,o.f(),e.finish(19);case 22:if(!(n.length>0)){e.next=46;break}f=/^dsa5-core/,p=Array.from(game.packs.keys()).sort((function(e,t){return f.test(e)&&f.test(t)&&e.localeCompare(t),f.test(t)?-1:f.test(e)?1:e.localeCompare(t)})),d=i(p),e.prev=26,d.s();case 28:if((h=d.n()).done){e.next=38;break}if(m=h.value,"Item"!=(y=game.packs.get(m)).documentName||!game.user.isGM&&y.private){e.next=36;break}return e.next=34,y.getDocuments({name:{$in:n},type:{$in:a}}).then((function(e){var t,o=i(e);try{for(o.s();!(t=o.n()).done;){var s=t.value,c=n.indexOf(s.name);c>=0&&a[c]==s.type&&(n.splice(c,1),a.splice(c,1),r.push(s.toObject()))}}catch(e){o.e(e)}finally{o.f()}}));case 34:if(!(n.length<=0)){e.next=36;break}return e.abrupt("break",38);case 36:e.next=28;break;case 38:e.next=43;break;case 40:e.prev=40,e.t1=e.catch(26),d.e(e.t1);case 43:return e.prev=43,d.f(),e.finish(43);case 46:return e.abrupt("return",r);case 47:case"end":return e.stop()}}),e,null,[[4,16,19,22],[26,40,43,46]])}))),function(e){return s.apply(this,arguments)})},{key:"replaceDies",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,n=t?"":"/roll ";return e.replace(r,(function(e){return" [[".concat(n).concat(e.replace(/[DwW]/,"d"),"]]")}))}},{key:"customEntityLinks",value:function(e){if(!e)return e;var t={"@Rq":"roll","@Gc":"GC","@Ch":"CH"},r={"@Rq":"dice","@Gc":"dice","@Ch":"user-shield"},n={"@Rq":"","@Gc":"".concat(game.i18n.localize("HELP.groupcheck")," "),"@Ch":""},a=/^@(Rq|Gc|Ch)/,o=/(-|\+)?\d+/,i=/\[[a-zA-z&; -]+/,s=/[\[\]]/g;return e.replace(/@(Rq|Gc|Ch)\[[a-zA-z&; -]+ (-|\+)?\d+\]/g,(function(e){var c=e.match(a)[0],u=Number(e.match(o)[0]),l=e.replace(u,"").match(i)[0].replace(s,"").trim();return'<a class="roll-button request-'.concat(t[c],'" data-type="skill" data-modifier="').concat(u,'" data-name="').concat(l,'"><em class="fas fa-').concat(r[c],'"></em>').concat(n[c]).concat(l," ").concat(u,"</a>")}))}},{key:"escapeRegex",value:function(e){return("string"==typeof e||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}},{key:"replaceConditions",value:function(e){if(!e)return e;if(!a.Z.statusRegex){var t=a.Z.statusEffects.map((function(e){return game.i18n.localize(e.label).toLowerCase()})),r=["status","condition","level","levels"].map((function(e){return game.i18n.localize(e)})).join("|");a.Z.statusRegex={effects:t,regex:new RegExp("(".concat(r,") (").concat(t.join("|"),")"),"gi")}}return e.replace(a.Z.statusRegex.regex,(function(e){var t=e.split(" "),r=t.shift();t=t.join(" ");var n=a.Z.statusEffects[a.Z.statusRegex.effects.indexOf(t.toLowerCase())];return"".concat(r,' <a class="chatButton chat-condition" data-id="').concat(n.id,'"><img src="').concat(n.icon,'"/>').concat(t,"</a>")}))}},{key:"experienceDescription",value:function(e){for(var t=["EXP.legendary","EXP.brillant","EXP.masterful","EXP.competent","EXP.experienced","EXP.average"],r=0,n=0,a=[2100,1700,1400,1200,1100,1e3];n<a.length;n++){var o=a[n];if(Number(e)>=Number(o))return t[r];r++}return"EXP.inexperienced"}},{key:"emptyActor",value:(o=l(c().mark((function e(){var t,r,a=arguments;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:12,Array.isArray(t)||(t=[t,t,t,t,t,t,t,t]),e.next=4,n.Z.create({name:"Alrik",type:"npc",items:[],system:{status:{wounds:{value:50},fatePoints:{}},characteristics:{mu:{initial:t[0]},kl:{initial:t[1]},in:{initial:t[2]},ch:{initial:t[3]},ff:{initial:t[4]},ge:{initial:t[5]},ko:{initial:t[6]},kk:{initial:t[7]}}}},{temporary:!0,noHook:!0});case 4:return(r=e.sent).prepareData(),e.abrupt("return",r);case 7:case"end":return e.stop()}}),e)}))),function(){return o.apply(this,arguments)})}],r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},707:(e,t,r)=>{r.d(t,{Jp:()=>d,p0:()=>h,x8:()=>f,zJ:()=>l});var n=r(491);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(){o=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,i,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,i)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,s,c){var u=f(e[o],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==a(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var o;this._invoke=function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return o=o?o.then(a,a):a()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,i,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw o}}}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function c(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function u(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){c(o,n,a,i,s,"next",e)}function s(e){c(o,n,a,i,s,"throw",e)}i(void 0)}))}}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:320,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:40;e.attr({width:.8*t,viewBox:"0 0 ".concat(t," ").concat(r)});var n=e.find("text"),a=n.get(0).getBBox(),o=t/a.width,i=r/a.height,s=o<i,c=s?o:i;isFinite(c)&&n.attr({transform:"matrix("+c+", 0, 0, "+c+", 0,0)",x:Math.max(0,(t-a.width)/2),y:.75*r/(s?1:c)})}function f(e,t){return p.apply(this,arguments)}function p(){return(p=u(o().mark((function e(t,r){var a,i,s;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.actorId&&t.actorId==r,!t.uuid){e.next=9;break}return e.next=4,fromUuid(t.uuid);case 4:a=e.sent,t.amount&&(a.system.quantity.value=Number(t.amount)),i=a.type,e.next=17;break;case 9:if(!t.id||!t.pack){e.next=16;break}return e.next=12,n.Z.findItembyIdAndPack(t.id,t.pack);case 12:a=e.sent,i=a.type,e.next=17;break;case 16:t.id&&"Actor"==t.type?(a=n.Z.findActorbyId(t.id),i=a.type):t.id?(a=n.Z.findItembyId(t.id),i=a.type):(a=t.data,i=a.type);case 17:return"function"==typeof a.toObject&&"creature"!=i&&(a=a.toObject(!0)),e.abrupt("return",{item:a,typeClass:i,selfTarget:s});case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function d(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"div";if(t=e.find(t)[0]){t.classList.add("slist");var a,s=t.querySelectorAll(n),c=null,l=i(s);try{for(l.s();!(a=l.n()).done;){var f=a.value;f.draggable=!0,f.addEventListener("dragstart",(function(e){c=this})),f.addEventListener("dragover",(function(e){e.preventDefault()})),f.addEventListener("drop",function(){var e=u(o().mark((function e(n){var a,i,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.preventDefault(),this==c){e.next=7;break}for(a=0,i=0,u=0;u<s.length;u++)c==s[u]&&(a=u),this==s[u]&&(i=u);return a<i?this.parentNode.insertBefore(c,this.nextSibling):this.parentNode.insertBefore(c,this),e.next=7,r(t);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}())}}catch(e){l.e(e)}finally{l.f()}}}function h(e){var t=$(".tinyNotifications");t.length||($("body").append('<ul class="tinyNotifications"></ul>'),t=$(".tinyNotifications"));var r=$("<li>".concat(e,"</li>"));t.prepend(r),setTimeout((function(){r.remove()}),1500)}},430:(e,t,r)=>{r.d(t,{Z:()=>l});var n=r(577),a=r(491);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(){i=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",c=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};u(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,i,s,c){var u=f(e[a],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==o(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(p).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,u(b,"constructor",m),u(m,"constructor",h),h.displayName=u(m,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),u(b,c,"Generator"),u(b,a,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function s(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function c(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){s(o,n,a,i,c,"next",e)}function c(e){s(o,n,a,i,c,"throw",e)}i(void 0)}))}}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,o,s,l,f;return t=e,null,r=[{key:"showBotchCard",value:(f=c(i().mark((function t(r){var o,s,c,u,l,f,p=arguments;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return o=p.length>1&&void 0!==p[1]?p[1]:{},s=n.Z.systemTables.find((function(e){return e.name==r.table})),t.next=4,e.getRollTable(s.pack[game.i18n.lang],game.i18n.localize("TABLENAMES.".concat(r.table)),r);case 4:return c=t.sent,u=a.Z.replaceDies(a.Z.replaceConditions(c.results[0].text)),l="".concat(game.i18n.localize("TABLENAMES."+r.table)),t.next=9,renderTemplate("systems/dsa5/templates/tables/tableCard.html",{result:u,title:l});case 9:f=t.sent,ChatMessage.create({user:game.user.id,content:f,whisper:o.whisper,blind:o.blind});case 11:case"end":return t.stop()}}),t)}))),function(e){return f.apply(this,arguments)})},{key:"getRollTable",value:(l=c(i().mark((function e(t,r){var n,a,o,s,c=arguments;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>2&&void 0!==c[2]?c[2]:{},a=game.packs.get(t),e.next=4,a.getDocuments({name:{$in:[r]}});case 4:return o=e.sent[0],e.next=7,o.draw({displayChat:!1});case 7:if(s=e.sent,!("true"==n.weaponless&&s.roll.total<7)){e.next=13;break}return s.roll.editRollAtIndex([{index:0,val:s.roll.total+5}]),e.next=12,o.draw({displayChat:!1,roll:s.roll});case 12:s=e.sent;case 13:return e.abrupt("return",s);case 14:case"end":return e.stop()}}),e)}))),function(e,t){return l.apply(this,arguments)})},{key:"tableEnabledFor",value:(s=c(i().mark((function e(t){var r;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.Z.systemTables.find((function(e){return e.name==t})),e.abrupt("return",!!r&&game.settings.get(r.setting.module,r.setting.key));case 2:case"end":return e.stop()}}),e)}))),function(e){return s.apply(this,arguments)})},{key:"rollCritBotchButton",value:function(e,t){var r=game.i18n.localize("TABLENAMES.".concat(e));return', <a class="roll-button botch-roll" data-table="'.concat(e,'" data-weaponless="').concat(t,'}"><i class="fas fa-dice"></i>').concat(r,"</a>")}},{key:"defaultBotch",value:(o=c(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=", "+game.i18n.localize("selfDamage"),e.next=3,new Roll("1d6+2").evaluate({async:!0});case 3:return e.t1=e.sent.total,e.abrupt("return",e.t0+e.t1);case 5:case"end":return e.stop()}}),e)}))),function(){return o.apply(this,arguments)})},{key:"defaultAttackCrit",value:function(e){var t=", "+game.i18n.localize("halfDefense");return e&&(t+=", "+game.i18n.localize("doubleDamage")),t}},{key:"defaultParryCrit",value:function(){return", "+game.i18n.localize("attackOfOpportunity")}}],r&&u(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()},93:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _regeneratorRuntime(){_regeneratorRuntime=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==_typeof(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function asyncGeneratorStep(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){asyncGeneratorStep(o,n,a,i,s,"next",e)}function s(e){asyncGeneratorStep(o,n,a,i,s,"throw",e)}i(void 0)}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=_superPropBase(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},_get.apply(this,arguments)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var r,n=_getPrototypeOf(e);if(t){var a=_getPrototypeOf(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return _possibleConstructorReturn(this,r)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}__webpack_require__.d(__webpack_exports__,{Z:()=>DSATour});var DSATour=function(_Tour){_inherits(DSATour,_Tour);var _super=_createSuper(DSATour),_travelAgency,_preStep2;function DSATour(){return _classCallCheck(this,DSATour),_super.apply(this,arguments)}return _createClass(DSATour,[{key:"_preStep",value:(_preStep2=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.currentStep.activateTab){e.next=4;break}ui.sidebar.activateTab(this.currentStep.activateTab),e.next=12;break;case 4:if(!this.currentStep.activateLayer||canvas.activeLayer.options.name==this.currentStep.activateLayer){e.next=11;break}return e.next=7,canvas[this.currentStep.activateLayer].activate();case 7:return e.next=9,timeout(100);case 9:e.next=12;break;case 11:this.currentStep.appTab&&this.app.sheet.activateTab(this.currentStep.appTab);case 12:case"end":return e.stop()}}),e,this)}))),function(){return _preStep2.apply(this,arguments)})},{key:"exit",value:function(){TooltipManager.TOOLTIP_ACTIVATION_MS=500,_get(_getPrototypeOf(DSATour.prototype),"exit",this).call(this)}},{key:"start",value:function(){var _start=_asyncToGenerator(_regeneratorRuntime().mark((function _callee2(){var fn,res;return _regeneratorRuntime().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(!this.config.preCommand){_context2.next=12;break}return TooltipManager.TOOLTIP_ACTIVATION_MS=5e10,_context2.next=4,eval("(async() => { ".concat(this.config.preCommand," })"));case 4:return fn=_context2.sent,_context2.next=7,fn();case 7:if($(this.steps[this.stepIndex+1].selector+":visible").length){_context2.next=12;break}return _context2.next=10,timeout(50);case 10:_context2.next=7;break;case 12:return _context2.next=14,_get(_getPrototypeOf(DSATour.prototype),"start",this).call(this);case 14:return res=_context2.sent,$("#tooltip").show(),_context2.abrupt("return",res);case 17:case"end":return _context2.stop()}}),_callee2,this)})));function start(){return _start.apply(this,arguments)}return start}()}],[{key:"travelAgency",value:(_travelAgency=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,r,n,a,o,i,s,c,u;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t="de"==game.i18n.lang?"de":"en",console.log("Adding DSA/TDE Tours"),r=_createForOfIteratorHelper(this.tours),e.prev=3,r.s();case 5:if((n=r.n()).done){e.next=13;break}return a=n.value,e.next=9,game.dsa5.apps.DSATour.fromJSON("".concat(a.replace("/lang/","/".concat(t,"/")),".json"));case 9:o=e.sent,game.tours.register(o.config.module,o.id,o);case 11:e.next=5;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(3),r.e(e.t0);case 18:return e.prev=18,r.f(),e.finish(18);case 21:if(game.user.isGM){e.next=23;break}return e.abrupt("return");case 23:i=_createForOfIteratorHelper(this.gmTours),e.prev=24,i.s();case 26:if((s=i.n()).done){e.next=34;break}return c=s.value,e.next=30,game.dsa5.apps.DSATour.fromJSON("".concat(c.replace("/lang/","/".concat(t,"/")),".json"));case 30:u=e.sent,game.tours.register(u.config.module,u.id,u);case 32:e.next=26;break;case 34:e.next=39;break;case 36:e.prev=36,e.t1=e.catch(24),i.e(e.t1);case 39:return e.prev=39,i.f(),e.finish(39);case 42:case"end":return e.stop()}}),e,this,[[3,15,18,21],[24,36,39,42]])}))),function(){return _travelAgency.apply(this,arguments)})}]),DSATour}(Tour);function timeout(e){return new Promise((function(t){return setTimeout(t,e)}))}_defineProperty(DSATour,"tours",["systems/dsa5/modules/tours/lang/initial","systems/dsa5/modules/tours/lang/library","systems/dsa5/modules/tours/lang/actor"]),_defineProperty(DSATour,"gmTours",["systems/dsa5/modules/tours/lang/mastermenu"])}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](r,r.exports,__webpack_require__),r.exports}__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{var e=__webpack_require__(491),t=__webpack_require__(577),r=__webpack_require__(272),n=__webpack_require__(839),a=__webpack_require__(173),o=__webpack_require__(947),i=__webpack_require__(973);function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=l(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function u(){u=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof d?t:d,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===p)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function f(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var p={};function d(){}function h(){}function m(){}var y={};c(y,a,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&r.call(g,a)&&(y=g);var b=m.prototype=d.prototype=Object.create(y);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,c){var u=f(e[a],e,o);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==s(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,c)}),(function(e){n("throw",e,i,c)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,c)}))}c(u.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=f(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,p;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return h.prototype=m,c(b,"constructor",m),c(m,"constructor",h),h.displayName=c(m,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,c(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),c(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(l(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),c(b,i,"Generator"),c(b,a,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),p}},e}function l(e,t){if(e){if("string"==typeof e)return f(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,t):void 0}}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function p(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function d(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){p(o,n,a,i,s,"next",e)}function s(e){p(o,n,a,i,s,"throw",e)}i(void 0)}))}}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var m=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n,a,o,i,s,f,p,m;return t=e,null,r=[{key:"showDialog",value:(m=d(u().mark((function e(t){var r,n,a;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,r){new Dialog({title:game.i18n.localize("Migrakel.Migration"),content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){e([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function(){e([!1])}}},close:function(){e([!1])}}).render(!0)}));case 2:return r=e.sent,i=1,n=function(e){if(Array.isArray(e))return e}(o=r)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(o,i)||l(o,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=n[0],e.abrupt("return",a);case 6:case"end":return e.stop()}var o,i}),e)}))),function(e){return m.apply(this,arguments)})},{key:"refreshStatusEffects",value:(p=d(u().mark((function e(t){var r,n,a,o,i;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],n=c(t.effects),e.prev=2,n.s();case 4:if((a=n.n()).done){e.next=19;break}if(!(o=a.value).origin){e.next=17;break}return i=void 0,e.prev=8,e.next=11,fromUuid(o.origin);case 11:i=e.sent,e.next=16;break;case 14:e.prev=14,e.t0=e.catch(8);case 16:i||r.push(o.id);case 17:e.next=4;break;case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(2),n.e(e.t1);case 24:return e.prev=24,n.f(),e.finish(24);case 27:return e.next=29,t.deleteEmbeddedDocuments("ActiveEffect",r);case 29:case"end":return e.stop()}}),e,null,[[2,21,24,27],[8,14]])}))),function(e){return p.apply(this,arguments)})},{key:"updateVals",value:(f=d(u().mark((function e(t,r,n){var a,o,i,s,l,f,p,d,h,m,y,v,g,b;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=game.dsa5.itemLibrary,o=[],i=[],s=new Map,e.next=6,this.refreshStatusEffects(t);case 6:if(!r({type:"equipment"})){e.next=34;break}l=[],f=[],p=c(t.items.filter((function(e){return"equipment"==e.type&&"bags"==e.system.equipmentType.value}))),e.prev=10,h=u().mark((function e(){var t,r,o;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=d.value,e.next=3,a.findCompendiumItem(t.name,t.type);case 3:if(!((r=e.sent).length>0)){e.next=12;break}if(r=r.find((function(e){return e.name==t.name&&e.type==t.type}))){e.next=8;break}return e.abrupt("return","continue");case 8:console.log("MIGRATION - Updated ".concat(t.name)),o=mergeObject(t.toObject(),n(r)),f.push(o),l.push(t.id);case 12:case"end":return e.stop()}}),e)})),p.s();case 13:if((d=p.n()).done){e.next=20;break}return e.delegateYield(h(),"t0",15);case 15:if("continue"!==e.t0){e.next=18;break}return e.abrupt("continue",18);case 18:e.next=13;break;case 20:e.next=25;break;case 22:e.prev=22,e.t1=e.catch(10),p.e(e.t1);case 25:return e.prev=25,p.f(),e.finish(25);case 28:return e.next=30,t.createEmbeddedDocuments("Item",f);case 30:for(m=e.sent,y=0;y<m.length;y++)s.set(l[y],m[y].id);return e.next=34,t.deleteEmbeddedDocuments("Item",l);case 34:v=c(t.items.filter((function(e){return r(e)&&!("equipment"==e.type&&"bags"==e.system.equipmentType.value)}))),e.prev=35,b=u().mark((function e(){var t,r,c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=g.value,e.next=3,a.findCompendiumItem(t.name,t.type);case 3:if(!((r=e.sent).length>0)){e.next=13;break}if(r=r.find((function(e){return e.name==t.name&&e.type==t.type}))){e.next=8;break}return e.abrupt("return","continue");case 8:console.log("MIGRATION - Updated ".concat(t.name)),(c=mergeObject(t.toObject(),n(r))).system.parent_id&&s.has(c.system.parent_id)&&(c.system.parent_id=s.get(c.system.parent_id)),i.push(c),o.push(t.id);case 13:case"end":return e.stop()}}),e)})),v.s();case 38:if((g=v.n()).done){e.next=45;break}return e.delegateYield(b(),"t2",40);case 40:if("continue"!==e.t2){e.next=43;break}return e.abrupt("continue",43);case 43:e.next=38;break;case 45:e.next=50;break;case 47:e.prev=47,e.t3=e.catch(35),v.e(e.t3);case 50:return e.prev=50,v.f(),e.finish(50);case 53:return e.next=55,t.createEmbeddedDocuments("Item",i);case 55:return e.next=57,t.deleteEmbeddedDocuments("Item",o);case 57:ui.notifications.notify(game.i18n.localize("Migrakel.migrationDone"));case 58:case"end":return e.stop()}}),e,this,[[10,22,25,28],[35,47,50,53]])}))),function(e,t,r){return f.apply(this,arguments)})},{key:"updateSpellsAndLiturgies",value:(s=d(u().mark((function e(t){var r,n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.showDialog(game.i18n.localize("Migrakel.spells"));case 2:if(!e.sent){e.next=7;break}return r=function(e){return["spell","liturgy","ritual","ceremony"].includes(e.type)},n=function(e){return{system:{effectFormula:{value:e.system.effectFormula.value}},effects:e.effects.toObject()}},e.next=7,this.updateVals(t,r,n);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"updateSpecialAbilities",value:(i=d(u().mark((function e(t){var r,n,a=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.showDialog(game.i18n.localize("Migrakel.abilities"));case 2:if(!e.sent){e.next=7;break}return r=function(e){var t={system:{effect:{value:e.system.effect.value}},effects:e.effects.toObject()};return"specialability"==e.type&&(mergeObject(t,{system:{category:{sub:e.system.category.sub||0},list:{value:e.system.list.value}}}),"staff"==e.system.category.value&&mergeObject(t,{system:{feature:getProperty(e,"system.feature")||"",AsPCost:getProperty(e,"system.AsPCost")||"",volume:Number(getProperty(e,"system.volume"))||0}})),a.updateMacro(t,e),t},n=function(e){return["specialability","advantage","disadvantage","trait"].includes(e.type)},e.next=7,this.updateVals(t,n,r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"updateCombatskills",value:(o=d(u().mark((function e(t){var r,n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.showDialog(game.i18n.localize("Migrakel.cskills"));case 2:if(!e.sent){e.next=7;break}return r=function(e){return{effects:e.effects.toObject()}},n=function(e){return["combatskill"].includes(e.type)},e.next=7,this.updateVals(t,n,r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"updateSkills",value:(a=d(u().mark((function e(t){var r,n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.showDialog(game.i18n.localize("Migrakel.skills"));case 2:if(!e.sent){e.next=7;break}return r=function(e){return["skill"].includes(e.type)},n=function(e){return{img:e.img}},e.next=7,this.updateVals(t,r,n);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"updateMacro",value:function(e,t){var r=t.getFlag("dsa5","onUseEffect");r&&mergeObject(e,{flags:{dsa5:{onUseEffect:r}}})}},{key:"updateGear",value:(n=d(u().mark((function e(t){var r,n,a=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.showDialog(game.i18n.localize("Migrakel.gear"));case 2:if(!e.sent){e.next=7;break}return r=function(e){return["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(e.type)},n=function(e){var t={img:e.img,effects:e.effects.toObject()};return["poison","consumable"].includes(e.type)||mergeObject(t,{system:{effect:{value:e.system.effect.value}}}),["armor"].includes(e.type)&&mergeObject(t,{system:{subcategory:e.system.subcategory}}),["meleeweapon","rangeweapon","armor"].includes(e.type)&&mergeObject(t,{system:{structure:{max:e.system.structure.max,value:e.system.structure.value}}}),a.updateMacro(t,e),t},e.next=7,this.updateVals(t,r,n);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})}],r&&h(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function v(){v=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new E(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=x(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(S([])));g&&g!==t&&r.call(g,a)&&(h=g);var b=d.prototype=f.prototype=Object.create(h);function w(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==y(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function x(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,x(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function _(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(_,this),this.reset(!0)}function S(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:L}}function L(){return{value:void 0,done:!0}}return p.prototype=d,s(b,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(k.prototype),s(k.prototype,o,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(b),s(b,i,"Generator"),s(b,a,(function(){return this})),s(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;O(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function g(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function b(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){g(o,n,a,i,s,"next",e)}function s(e){g(o,n,a,i,s,"throw",e)}i(void 0)}))}}function w(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function k(){return k="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=x(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},k.apply(this,arguments)}function x(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=E(e)););return e}function _(e,t){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_(e,t)}function O(e,t){if(t&&("object"===y(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function E(e){return E=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},E(e)}var S=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_(e,t)}(u,Dialog);var t,r,n,a,o,i,s,c=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=E(i);if(s){var r=E(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return O(this,e)});function u(e,t){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(r=c.call(this,t)).actor=e,r.lock=!1,r}return t=u,r=[{key:"updateWrapper",value:(o=b(v().mark((function e(t,r){var n,a=this;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.lock){e.next=2;break}return e.abrupt("return");case 2:n=function(){var e=b(v().mark((function e(){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a.lock=!0,$(r.currentTarget).prepend('<i class="fas fa-spinner fa-spin"></i>'),e.next=4,m[t](a.actor);case 4:$(r.currentTarget).find("i").remove(),a.lock=!1;case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),n();case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;k(E(u.prototype),"activateListeners",this).call(this,e),e.find(".updateSpells").click(function(){var e=b(v().mark((function e(r){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.updateWrapper("updateSpellsAndLiturgies",r));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".updateAbilities").click(function(){var e=b(v().mark((function e(r){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.updateWrapper("updateSpecialAbilities",r));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".updatecSkills").click(function(){var e=b(v().mark((function e(r){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.updateWrapper("updateCombatskills",r));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".updateSkills").click(function(){var e=b(v().mark((function e(r){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.updateWrapper("updateSkills",r));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".updateGear").click(function(){var e=b(v().mark((function e(r){return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.updateWrapper("updateGear",r));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}}],n=[{key:"buildDialog",value:(a=b(v().mark((function e(t){var r;return v().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/templates/actors/parts/actorConfig.html",{actor:t});case 2:r=e.sent,new u(t,{title:game.i18n.localize("SHEET.actorConfig"),content:r,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Save"),callback:function(e){var r={"system.config.autoBar":e.find('[name="autoBar"]').is(":checked")};"creature"==t.type&&(r["system.config.autoSize"]=e.find('[name="autoSize"]').is(":checked")),t.update(r)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 4:case"end":return e.stop()}}),e)}))),function(e){return a.apply(this,arguments)})}],r&&w(t.prototype,r),n&&w(t,n),Object.defineProperty(t,"prototype",{writable:!1}),u}(),L=__webpack_require__(707),T=__webpack_require__(369),D=__webpack_require__(803),P=__webpack_require__(122),A=__webpack_require__(604);function j(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"img";game.user.isGM&&e.find(t).each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(function(e){return C(e)}))}))}var C=function(e){canvas.tiles.activate();var t=e.currentTarget.src,r=e.currentTarget,n=canvas.dimensions.sceneHeight/r.naturalHeight,a=canvas.dimensions.sceneWidth/r.naturalWidth,o=Math.min(1,a,n),i={type:"Tile",texture:{src:t},tileSize:Math.round(canvas.dimensions.size/o)};e.dataTransfer.setData("text/plain",JSON.stringify(i));var s=r.naturalWidth*o*canvas.stage.scale.x,c=r.naturalHeight*o*canvas.stage.scale.y,u=DragDrop.createDragImage(r,s,c);e.dataTransfer.setDragImage(u,s/2,c/2)},I=__webpack_require__(231);function M(e){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},M(e)}function N(e){return function(e){if(Array.isArray(e))return G(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||F(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function z(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=F(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function F(e,t){if(e){if("string"==typeof e)return G(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?G(e,t):void 0}}function G(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Z(){Z=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==M(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function B(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function H(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){B(o,n,a,i,s,"next",e)}function s(e){B(o,n,a,i,s,"throw",e)}i(void 0)}))}}function W(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function q(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function U(){return U="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Y(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},U.apply(this,arguments)}function Y(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=J(e)););return e}function V(e,t){return V=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},V(e,t)}function K(e,t){if(t&&("object"===M(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function J(e){return J=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},J(e)}var Q=function(s){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&V(e,t)}(ve,ActorSheet);var c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E,C,M,F,G,B,Y,Q,X,ee,te,re,ne,ae,oe,ie,se,ce,ue,le,fe,pe,de,he,me,ye=(he=ve,me=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=J(he);if(me){var r=J(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return K(this,e)});function ve(){return W(this,ve),ye.apply(this,arguments)}return c=ve,u=[{key:"actorType",get:function(){return this.actor.type}},{key:"_render",value:(de=H(Z().mark((function e(){var t,r,n,a=arguments;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],r=a.length>1&&void 0!==a[1]?a[1]:{},this._saveSearchFields(),this._saveCollapsed(),e.next=6,U(J(ve.prototype),"_render",this).call(this,t,r);case 6:this._setCollapsed(),this._restoreSeachFields(),(n=$(this._element)).find(".close").attr("data-tooltip",game.i18n.localize("SHEET.Close")),n.find(".configure-sheet").attr("data-tooltip",game.i18n.localize("SHEET.Configure")),n.find(".configure-token").attr("data-tooltip",game.i18n.localize("SHEET.Token")),n.find(".import").attr("data-tooltip",game.i18n.localize("SHEET.Import")),n.find(".locksheet").attr("data-tooltip",game.i18n.localize("SHEET.Lock")),n.find(".library").attr("data-tooltip",game.i18n.localize("SHEET.Library")),n.find(".playerview").attr("data-tooltip",game.i18n.localize("SHEET.switchLimited")),n.find(".actorConfig").attr("data-tooltip",game.i18n.localize("SHEET.actorConfig")),this.currentFocus&&(n.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null);case 18:case"end":return e.stop()}}),e,this)}))),function(){return de.apply(this,arguments)})},{key:"_saveSearchFields",value:function(){if(null!==this.form){var e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}}},{key:"_restoreSeachFields",value:function(){if(null!=this.searchFields){var e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));var t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),""!=this.searchFields.searchText&&this._filterTalents(t);var r=$(e.find(".gearSearch"));r.val(this.searchFields.gearSearch),""!=this.searchFields.searchText&&this._filterGear(r)}}},{key:"_saveCollapsed",value:function(){if(null!==this.form){var e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];var t,r=z(e.find(".ch-collapse i"));try{for(r.s();!(t=r.n()).done;){var n=t.value;this.collapsedBoxes.push($(n).attr("class"))}}catch(e){r.e(e)}finally{r.f()}var a,o=z($(e.find(".expandDetails.shown")));try{for(o.s();!(a=o.n()).done;){var i=a.value;this.openDetails.push($(i).closest(".item").attr("data-item-id"))}}catch(e){o.e(e)}finally{o.f()}}}},{key:"_setCollapsed",value:function(){var e=$(this.form).parent();if(this.collapsedBoxes)for(var t=e.find(".ch-collapse i"),r=0;r<t.length;r++)$(t[r]).attr("class",this.collapsedBoxes[r]),this.collapsedBoxes[r]&&-1!=this.collapsedBoxes[r].indexOf("fa-angle-down")&&$(t[r]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}},{key:"getData",value:(pe=H(Z().mark((function e(t){var r,n,a;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U(J(ve.prototype),"getData",this).call(this,t);case 2:return r=e.sent,n={actor:r.actor,editable:r.editable,limited:r.limited,owner:r.owner},a=this.actor.prepareSheet({details:this.openDetails}),mergeObject(n.actor,a),n.isGM=game.user.isGM,n.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},i.Z.prepareActiveEffects(this.actor,n),e.abrupt("return",n);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return pe.apply(this,arguments)})},{key:"_onItemCreate",value:function(e){e.preventDefault();var r=e.currentTarget,a=duplicate(r.dataset);t.Z.equipmentTypes[a.type]&&(a.type="equipment",a=mergeObject(a,{"system.equipmentType.value":e.currentTarget.attributes["item-section"].value,"system.effect.value":""})),"aggregatedTest"==a.type||"spell"==a.type||"liturgy"==a.type||(a["system.weight.value"]=0,a["system.quantity.value"]=0),n.Z.defaultIcon(a),a.name=game.i18n.localize(a.type),this.actor.createEmbeddedDocuments("Item",[a])}},{key:"_handleAggregatedProbe",value:function(t){var r=this,n=this._getItemId(t),a=this.actor.items.get(n).toObject(),o=this.actor.items.find((function(e){return e.name==a.system.talent.value&&"skill"==e.type})),i='<h3 class="center"><b>'.concat(game.i18n.localize("aggregatedTest"),"</b></h3>");a.system.usedTestCount.value>=a.system.allowedTestCount.value?(i+="".concat(game.i18n.localize("Aggregated.noMoreAllowed")),ChatMessage.create(e.Z.chatDataSetup(i))):this.actor.setupSkill(o,{moreModifiers:[{name:game.i18n.localize("failedTests"),value:-1*a.system.previousFailedTests.value,selected:!0},{name:game.i18n.localize("Modifier"),value:a.system.baseModifier,selected:!0}]},this.getTokenId()).then((function(e){r.actor.basicTest(e).then((function(e){e.result.successLevel>0?(a.system.cummulatedQS.value=e.result.qualityStep+a.system.cummulatedQS.value,a.system.cummulatedQS.value=Math.min(10,a.system.cummulatedQS.value)):a.system.previousFailedTests.value+=1,a.system.usedTestCount.value+=1,r.actor.updateEmbeddedDocuments("Item",[a]).then((function(e){return r.actor.items.get(n).postItem()}))}))}))}},{key:"consumeItem",value:(fe=H(Z().mark((function e(t){var r=this;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+t.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+t.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){t.setupEffect(null,{},r.getTokenId())}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 1:case"end":return e.stop()}}),e)}))),function(e){return fe.apply(this,arguments)})},{key:"_advanceAttribute",value:(le=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=Number(this.actor.system.characteristics[r].advances)+Number(this.actor.system.characteristics[r].initial),a=e.Z._calculateAdvCost(n,"E"),t.next=4,this._checkEnoughXP(a);case 4:if(!t.sent){t.next=7;break}return t.next=7,this._updateAPs(a,R({},"system.characteristics.".concat(r,".advances"),Number(this.actor.system.characteristics[r].advances)+1));case 7:case"end":return t.stop()}}),t,this)}))),function(e){return le.apply(this,arguments)})},{key:"_refundAttributeAdvance",value:(ue=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=Number(this.actor.system.characteristics[r].advances)+Number(this.actor.system.characteristics[r].initial),!(Number(this.actor.system.characteristics[r].advances)>0)){t.next=5;break}return a=-1*e.Z._calculateAdvCost(n,"E",0),t.next=5,this._updateAPs(a,R({},"system.characteristics.".concat(r,".advances"),Number(this.actor.system.characteristics[r].advances)-1));case 5:case"end":return t.stop()}}),t,this)}))),function(e){return ue.apply(this,arguments)})},{key:"_advancePoints",value:(ce=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=Number(this.actor.system.status[r].advances),a=e.Z._calculateAdvCost(n,"D"),t.next=4,this._checkEnoughXP(a);case 4:if(t.t0=t.sent,!t.t0){t.next=7;break}t.t0=this._checkMaximumPointAdvancement(r,n+1);case 7:if(!t.t0){t.next=10;break}return t.next=10,this._updateAPs(a,R({},"system.status.".concat(r,".advances"),Number(this.actor.system.status[r].advances)+1));case 10:case"end":return t.stop()}}),t,this)}))),function(e){return ce.apply(this,arguments)})},{key:"_refundPointsAdvance",value:(se=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!((n=Number(this.actor.system.status[r].advances))>0)){t.next=5;break}return a=-1*e.Z._calculateAdvCost(n,"D",0),t.next=5,this._updateAPs(a,R({},"system.status.".concat(r,".advances"),Number(this.actor.system.status[r].advances)-1));case 5:case"end":return t.stop()}}),t,this)}))),function(e){return se.apply(this,arguments)})},{key:"_advanceItem",value:(ie=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this.actor.items.get(r).toObject(),a=e.Z._calculateAdvCost(Number(n.system.talentValue.value),n.system.StF.value),t.next=4,this._checkEnoughXP(a);case 4:if(t.t0=t.sent,!t.t0){t.next=7;break}t.t0=this._checkMaximumItemAdvancement(n,Number(n.system.talentValue.value)+1);case 7:if(!t.t0){t.next=12;break}return t.next=10,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.talentValue.value":n.system.talentValue.value+1}]);case 10:return t.next=12,this._updateAPs(a);case 12:case"end":return t.stop()}}),t,this)}))),function(e){return ie.apply(this,arguments)})},{key:"_refundItemAdvance",value:(oe=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!((n=this.actor.items.get(r).toObject()).system.talentValue.value>0)){t.next=7;break}return a=-1*e.Z._calculateAdvCost(Number(n.system.talentValue.value),n.system.StF.value,0),t.next=5,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.talentValue.value":n.system.talentValue.value-1}]);case 5:return t.next=7,this._updateAPs(a);case 7:case"end":return t.stop()}}),t,this)}))),function(e){return oe.apply(this,arguments)})},{key:"_checkMaximumPointAdvancement",value:function(e,t){var r=!1;switch(e){case"wounds":r=t<=this.actor.system.characteristics.ko.value;break;case"astralenergy":r=t<=(null==this.actor.system.characteristics[this.actor.system.guidevalue.magical]?0:this.actor.system.characteristics[this.actor.system.guidevalue.magical].value*this.actor.system.energyfactor.magical);break;case"karmaenergy":r=t<=(null==this.actor.system.characteristics[this.actor.system.guidevalue.clerical]?0:this.actor.system.characteristics[this.actor.system.guidevalue.clerical].value*this.actor.system.energyfactor.clerical)}return r||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),r}},{key:"_checkMaximumItemAdvancement",value:function(e,t){var n=this,o=!1;switch(e.type){case"combatskill":o=t<=Math.max.apply(Math,N(e.system.guidevalue.value.split("/").map((function(e){return n.actor.system.characteristics[e].value}))))+2+r.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalCombatTechnique")," (").concat(e.name,")"));break;case"spell":case"ritual":var i,s=0,c=z(e.system.feature.replace(/\(a-z \-\)/gi,"").split(",").map((function(e){return e.trim()})));try{for(c.s();!(i=c.n()).done;){var u=i.value;if(a.Z.hasAbility(this.actor,"".concat(game.i18n.localize("LocalizedIDs.propertyKnowledge")," (").concat(u,")"))){s=this.maxByAttr(e);break}}}catch(e){c.e(e)}finally{c.f()}o=t<=Math.max(14+r.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalSkill")," (").concat(e.name,")")),s);break;case"liturgy":case"ceremony":var l=new RegExp("^".concat(game.i18n.localize("LocalizedIDs.aspectKnowledge"))),f=0;this.actor.items.filter((function(e){return"specialability"==e.type&&l.test(e.name)})).some((function(t){return e.system.distribution.value.includes(t.name.split("(")[1].split(")")[0])}))&&(f=this.maxByAttr(e)),o=t<=Math.max(14+r.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalSkill")," (").concat(e.name,")")),f);break;case"skill":o=t<=this.maxByAttr(e)}return o||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),o}},{key:"maxByAttr",value:function(e){return Math.max.apply(Math,[this.actor.system.characteristics[e.system.characteristic1.value].value,this.actor.system.characteristics[e.system.characteristic2.value].value,this.actor.system.characteristics[e.system.characteristic3.value].value])+2+r.Z.vantageStep(this.actor,"".concat(game.i18n.localize("LocalizedIDs.exceptionalSkill")," (").concat(e.name,")"))}},{key:"_openLibrary",value:(ae=H(Z().mark((function e(){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.dsa5.itemLibrary.render(!0);case 1:case"end":return e.stop()}}),e)}))),function(){return ae.apply(this,arguments)})},{key:"_configActor",value:(ne=H(Z().mark((function e(){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:S.buildDialog(this.actor);case 1:case"end":return e.stop()}}),e,this)}))),function(){return ne.apply(this,arguments)})},{key:"_getHeaderButtons",value:function(){var e,t,r,n=this,a=U(J(ve.prototype),"_getHeaderButtons",this).call(this);return a.unshift({class:"library",icon:"fas fa-university",onclick:(e=H(Z().mark((function e(){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n._openLibrary());case 1:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}),this.actor.isOwner&&a.unshift({class:"actorConfig",icon:"fas fa-link",onclick:(t=H(Z().mark((function e(){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n._configActor());case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}),this.actor.system.canAdvance&&a.unshift({class:"locksheet",icon:"fas fa-".concat(this.actor.system.sheetLocked.value?"":"un","lock"),onclick:(r=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n._changeAdvanceLock(t));case 1:case"end":return e.stop()}}),e)}))),function(e){return r.apply(this,arguments)})}),a}},{key:"_changeAdvanceLock",value:(re=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.actor.update({"system.sheetLocked.value":!this.actor.system.sheetLocked.value});case 2:$(t.currentTarget).find("i").toggleClass("fa-unlock fa-lock");case 3:case"end":return e.stop()}}),e,this)}))),function(e){return re.apply(this,arguments)})},{key:"_checkEnoughXP",value:(te=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.actor.checkEnoughXP(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return te.apply(this,arguments)})},{key:"advanceWrapper",value:(ee=H(Z().mark((function e(t,r,n){var a,o;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=$(t.currentTarget),(o=a.find("i")).hasClass("fa-spin")){e.next=7;break}return o.addClass("fa-spin fa-spinner"),e.next=6,this[r](n);case 6:o.removeClass("fa-spin fa-spinner");case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return ee.apply(this,arguments)})},{key:"showLimited",value:function(){return!game.user.isGM&&this.actor.limited}},{key:"getTokenId",value:function(){return this.token?this.token.id:void 0}},{key:"rollDisease",value:function(e){var t=this,r=this.actor.items.get(e),n=-1*this.actor.system.status.soulpower.max,a=-1*this.actor.system.status.toughness.max;r.setupEffect(void 0,{rollMode:"gmroll",manualResistance:{SKModifier:n,ZKModifier:a}}).then(function(){var e=H(Z().mark((function e(n){var a;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.itemTest(n);case 2:return a=e.sent,e.next=5,t.actor.updateEmbeddedDocuments("Item",[{_id:r.id,"system.duration.resolved":a.result.duration}]);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}},{key:"swapWeaponHand",value:(X=H(Z().mark((function e(t){var r,n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._getItemId(t),n=this.actor.items.get(r),["Daggers","Fencing Weapons"].includes(game.i18n.localize("LocalizedCTs.".concat(n.system.combatskill.value)))){e.next=5;break}return e.next=5,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"system.worn.wrongGrip":!n.system.worn.wrongGrip}]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return X.apply(this,arguments)})},{key:"activateListeners",value:function(t){var r=this;U(J(ve.prototype),"activateListeners",this).call(this,t);var n=function(e){r.actor.items.get(r._getItemId(e)).postItem()};t.find(".roll-disease").click((function(e){return r.rollDisease(r._getItemId(e))})),t.find(".schip").click((function(e){e.preventDefault();var t=Number(e.currentTarget.getAttribute("data-val")),n=$(r.form).parent().find('[name="system.status.fatePoints.value"]');1==t&&1==$(r.form).find(".fullSchip").length&&(t=0),n.val(t),n.trigger("change")})),t.find(".swapWeaponHand").click((function(e){return r.swapWeaponHand(e)})),t.find(".defenseToggle").click((function(){return r.actor.update({"system.config.defense":!r.actor.system.config.defense})})),t.find(".loadWeapon").mousedown(function(){var e=H(Z().mark((function e(t){var n,a,o;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r._getItemId(t),a=r.actor.items.get(n).toObject(),""!==getProperty(a,"system.currentAmmo.value")||"creature"==r.actor.type){e.next=4;break}return e.abrupt("return");case 4:return o="trait"==a.type?a.system.reloadTime.value:T.Z.calcLZ(a,r.actor),0==t.button?a.system.reloadTime.progress=Math.min(a.system.reloadTime.progress+1,o):2==t.button&&(a.system.reloadTime.progress=0),e.next=8,r.actor.updateEmbeddedDocuments("Item",[a]);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".chargeSpell").mousedown(function(){var e=H(Z().mark((function e(t){var n,a,o;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r._getItemId(t),a=r.actor.items.get(n).toObject(),o=Number(a.system.castingTime.modified),0==t.button?a.system.castingTime.progress=Math.min(a.system.castingTime.progress+1,o):2==t.button&&(a.system.castingTime.progress=0,a.system.castingTime.modified=0),e.next=6,r.actor.updateEmbeddedDocuments("Item",[a]);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".item-swapMag").click(function(){var e=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.actor.swapMag(r._getItemId(t));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".ammo-selector").change(function(){var e=H(Z().mark((function e(t){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),n=r._getItemId(t),e.next=4,r.actor.updateEmbeddedDocuments("Item",[{_id:n,"system.currentAmmo.value":$(t.currentTarget).val()}]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".condition-edit").click((function(e){r.actor.effects.get($(e.currentTarget).attr("data-id")).sheet.render(!0)})),t.find(".ch-collapse").click((function(e){$(e.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(e.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()})),t.find(".item-toggle").click((function(e){var t=r._getItemId(e),n=r.actor.items.get(t).toObject();switch(n.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":r.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.value":!n.system.worn.value}]),D.Z.playEquipmentWearStatusChange(n)}})),t.find(".status-create").click((function(e){var t=$(e.currentTarget).closest(".statusEffectMenu").find("ul");t.fadeIn("fast",(function(){t.find("input").focus()}))})),t.find(".statusEffectMenu ul").mouseleave((function(e){return $(e.currentTarget).fadeOut()})),t.find(".status-add").click(function(){var e=H(Z().mark((function e(t){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("custom"!=(n=$(t.currentTarget).attr("data-id"))){e.next=5;break}i.Z.createCustomEffect(r.actor),e.next=7;break;case 5:return e.next=7,r.actor.addCondition(n,1,!1,!1);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".roll-aggregated").mousedown((function(e){return r._handleAggregatedProbe(e)})),t.find(".skill-select").mousedown((function(e){var t=r._getItemId(e),n=r.actor.items.get(t);0==e.button?r.actor.setupSkill(n,{},r.getTokenId()).then((function(e){r.actor.basicTest(e)})):2==e.button&&n.sheet.render(!0)})),t.find(".advance-attribute").mousedown((function(e){return r.advanceWrapper(e,"_advanceAttribute",$(e.currentTarget).attr("data-attr"))})),t.find(".refund-attribute").mousedown((function(e){return r.advanceWrapper(e,"_refundAttributeAdvance",$(e.currentTarget).attr("data-attr"))})),t.find(".advance-item").mousedown((function(e){return r.advanceWrapper(e,"_advanceItem",r._getItemId(e))})),t.find(".refund-item").mousedown((function(e){return r.advanceWrapper(e,"_refundItemAdvance",r._getItemId(e))})),t.find(".advance-points").mousedown((function(e){return r.advanceWrapper(e,"_advancePoints",$(e.currentTarget).attr("data-attr"))})),t.find(".refund-points").mousedown((function(e){return r.advanceWrapper(e,"_refundPointsAdvance",$(e.currentTarget).attr("data-attr"))})),t.find(".spell-select").mousedown((function(e){var t=r._getItemId(e),n=r.actor.items.get(t);0==e.button?r.actor.setupSpell(n,{},r.getTokenId()).then((function(e){return r.actor.basicTest(e)})):2==e.button&&n.sheet.render(!0)})),t.find(".quantity-click").mousedown((function(e){var t=r._getItemId(e),n=r.actor.items.get(t).toObject();P.Z.increment(e,n,"system.quantity.value",0),r.actor.updateEmbeddedDocuments("Item",[n])})),t.find(".item-post").click((function(e){return n(e)})),t.find(".item-dropdown").click((function(e){e.preventDefault(),$(e.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")})),t.find(".condition-show").mousedown((function(e){e.preventDefault();var t=e.currentTarget.dataset.id,n=$(e.currentTarget).parents(".statusEffect").attr("data-descriptor");if(0==e.button){var a=$(e.currentTarget).parents(".statusEffect").attr("data-origin");if(a)fromUuid(a).then((function(e){return e.sheet.render(!0)}));else{var o,i;n?(o=CONFIG.statusEffects.find((function(e){return e.id==n})),i=$('<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="'.concat(o.id,'"><img src="').concat(o.icon,'"/>').concat(game.i18n.localize(o.label),"</a></b>: ").concat(game.i18n.localize(o.description),"</div>"))):(o=r.actor.effects.find((function(e){return e.id==t})))&&(i=$('<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="'.concat(o.id,'"><img src="').concat(o.icon,'"/>').concat(game.i18n.localize(o.label),"</a></b>: ").concat(game.i18n.localize(o.flags.dsa5.description),"</div>")));var s=$(e.currentTarget).closest(".groupbox").find(".effectDescription");s.fadeOut("fast",(function(){s.html(i).fadeIn("fast")}))}}else 2!=e.button||e.currentTarget.dataset.locked||r._deleteActiveEffect(t)})),t.on("click",".chat-condition",(function(e){return o.Z.postStatus($(e.currentTarget).attr("data-id"))})),t.find(".money-change, .skill-advances").focusin((function(e){r.currentFocus=$(e.currentTarget).closest("[data-item-id]").attr("data-item-id")})),t.find(".money-change").change(function(){var e=H(Z().mark((function e(t){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r._getItemId(t),e.next=3,r.actor.updateEmbeddedDocuments("Item",[{_id:n,"system.quantity.value":Number(t.target.value)}]);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".skill-advances").change(function(){var e=H(Z().mark((function e(t){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r._getItemId(t),e.next=3,r.actor.updateEmbeddedDocuments("Item",[{_id:n,"system.talentValue.value":Number(t.target.value)}]);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".item-edit").click((function(e){e.preventDefault();var t=r._getItemId(e);r.actor.items.get(t).sheet.render(!0)})),t.find(".showApplication").mousedown((function(e){if(e.preventDefault(),2==e.button)r._deleteItem(e);else{var t=r._getItemId(e);r.actor.items.get(t).sheet.render(!0)}})),t.find(".disableRegeneration").click((function(e){var t=e.currentTarget.dataset.type,n="system.repeatingEffects.disabled.".concat(t);r.actor.update(R({},n,!getProperty(r.actor,n)))})),t.find(".consume-item").mousedown((function(e){if(2==e.button){var t=r._getItemId(e),n=r.actor.items.get(t);r.consumeItem(n)}})),t.find(".ch-value").click((function(e){e.preventDefault();var t=e.currentTarget.attributes["data-char"].value;r.actor.setupCharacteristic(t,{},r.getTokenId()).then((function(e){return r.actor.basicTest(e)}))})),t.find(".ch-status").click((function(e){e.preventDefault(),r.actor.setupDodge({},r.getTokenId()).then((function(e){r.actor.basicTest(e)}))})),t.find(".ch-regenerate").click((function(e){e.preventDefault(),r.actor.setupRegeneration("regenerate",{},r.getTokenId()).then((function(e){return r.actor.basicTest(e)}))})),t.find(".ch-weaponless").click((function(e){e.preventDefault();var t=e.currentTarget.attributes["data-char"].value;r.actor.setupWeaponless(t,{},r.getTokenId()).then((function(e){return r.actor.basicTest(e)}))})),t.find(".item-create").click((function(e){return r._onItemCreate(e)})),t.find(".ch-rollCombat").click((function(e){e.preventDefault();var t=r._getItemId(e),n=$(e.currentTarget).attr("data-mode"),a=r.actor.items.get(t);r.actor.setupWeapon(a,n,{},r.getTokenId()).then((function(e){return r.actor.basicTest(e)}))}));var a=function(e){return r._deleteItem(e)};t.find(".onUseItem").click((function(e){return r._onMacroUseItem(e)})),t.find(".cards .item").mouseenter((function(e){if(0==e.currentTarget.getElementsByClassName("hovermenu").length){var t=document.createElement("div");t.classList.add("hovermenu");var r=document.createElement("i");r.classList.add("fas","fa-times"),r.title=game.i18n.localize("SHEET.DeleteItem"),r.addEventListener("click",a,!1);var o=document.createElement("i");o.classList.add("fas","fa-comment"),o.title=game.i18n.localize("SHEET.PostItem"),o.addEventListener("click",n,!1),t.appendChild(o),t.appendChild(r),e.currentTarget.appendChild(t)}})),t.find(".cards .item").mouseleave((function(e){var t=e.toElement||e.relatedTarget;t&&t.parentNode!=r&&t!=r&&e.currentTarget.querySelectorAll(".hovermenu").forEach((function(e){return e.remove()}))}));var s=this.actor.uuid;t.find(".actorDrag").each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(function(e){var t={type:"Actor",uuid:s};e.dataTransfer.setData("text/plain",JSON.stringify(t))}))}));var c=function(e){return r._onDragItemStart(e)};t.find(".content .item").each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",c,!1)})),t.find(".item-delete").click((function(e){return r._deleteItem(e)})),t.find(".filterTalents").click((function(e){$(e.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(e.currentTarget).toggleClass("filtered")})),t.find(".condition-value").mousedown(function(){var e=H(Z().mark((function e(t){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=$(t.currentTarget).parents(".statusEffect").attr("data-descriptor"),0!=t.button){e.next=6;break}return e.next=4,r.actor.addCondition(n,1,!1,!1);case 4:e.next=9;break;case 6:if(2!=t.button){e.next=9;break}return e.next=9,r.actor.removeCondition(n,1,!1);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".condition-toggle").mousedown(function(){var e=H(Z().mark((function e(t){var n,a;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=$(t.currentTarget).parents(".statusEffect").attr("data-id"),a=r.actor.effects.get(n),e.next=4,a.update({disabled:!a.disabled});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".charimg").mousedown((function(t){2==t.button&&e.Z.showArtwork(r.actor,!0)})),I.Z.bindRollCommands(t);var u=t.find(".talentSearch");u.keyup((function(e){return r._filterTalents($(e.currentTarget))})),u[0]&&u[0].addEventListener("search",(function(e){return r._filterTalents($(e.currentTarget))}),!1);var l=t.find(".conditionSearch");l.keyup((function(e){return r._filterConditions($(e.currentTarget))})),l[0]&&l[0].addEventListener("search",(function(e){return r._filterConditions($(e.currentTarget))}),!1);var f=t.find(".gearSearch");f.keyup((function(e){return r._filterGear($(e.currentTarget))})),f[0]&&f[0].addEventListener("search",(function(e){return r._filterGear($(e.currentTarget))}),!1),j(t,"img.charimg")}},{key:"_onMacroUseItem",value:function(e){var t=this.actor.items.get(this._getItemId(e));new A.Z(t).executeOnUseEffect()}},{key:"_filterGear",value:function(e){if(null!=e.val()){var t=e.val().toLowerCase().trim(),r=$(this.element).find(".inventory .item");r.removeClass("filterHide"),r.filter((function(){return-1==$(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)})).addClass("filterHide")}}},{key:"_filterTalents",value:function(e){if(null!=e.val()){var t=e.val().toLowerCase().trim(),r=$(this.form).parent().find(".allTalents");r.find(".item, .table-header, .table-title").removeClass("filterHide"),r.addClass("showAll").find(".item").filter((function(){return-1==$(this).find(".talentName").text().toLowerCase().trim().indexOf(t)})).addClass("filterHide"),t.length>0?(r.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),r.addClass("filterfull")):r.removeClass("filterfull")}}},{key:"_filterConditions",value:function(e){if(null!=e.val()){var t=e.val().toLowerCase().trim(),r=$(this.form).find(".statusEffectMenu li:not(.search)");r.removeClass("filterHide"),r.filter((function(){return-1==$(this).find("a").attr("data-tooltip").toLowerCase().trim().indexOf(t)})).addClass("filterHide")}}},{key:"_deleteActiveEffect",value:(Q=H(Z().mark((function e(t){var r;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isEditable){e.next=2;break}return e.abrupt("return");case 2:if(!(r=this.actor.effects.find((function(e){return e.id==t})))){e.next=8;break}if(!(this.token?this.token.actor:this.actor)){e.next=8;break}return e.next=8,this.actor.deleteEmbeddedDocuments("ActiveEffect",[r.id]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return Q.apply(this,arguments)})},{key:"_deleteItem",value:function(e){var t=this;if(this.isEditable){var r=this._getItemId(e),n=this.actor.items.get(r),a=game.i18n.format("DIALOG.DeleteItemDetail",{item:n.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:a}).then((function(e){new Dialog({title:game.i18n.localize("Delete Confirmation"),content:e,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){return t._cleverDeleteItem(r)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}))}}},{key:"_cleverDeleteItem",value:(Y=H(Z().mark((function t(n){var o,i,s,c,u,l,f,p;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=this.actor.items.get(n),i=[n],t.t0=o.type,t.next="advantage"===t.t0||"disadvantage"===t.t0?5:"specialability"===t.t0?12:"blessing"===t.t0||"magictrick"===t.t0?15:"ritual"===t.t0||"ceremony"===t.t0||"liturgy"===t.t0||"spell"===t.t0?18:25;break;case 5:return t.next=7,r.Z.vantageRemoved(this.actor,o);case 7:if(s=o.system.APValue.value*o.system.step.value,/;/.test(o.system.APValue.value))for(c=o.system.APValue.value.split(";").map((function(e){return Number(e.trim())})),s=0,u=0;u<o.system.step.value;u++)s+=c[u];return t.next=11,this._updateAPs(-1*s);case 11:case 14:case 17:case 24:return t.abrupt("break",25);case 12:return t.next=14,a.Z.abilityRemoved(this.actor,o);case 15:return t.next=17,this._updateAPs(-1);case 18:for(l=0,f=0;f<=o.system.talentValue.value;f++)l+=e.Z._calculateAdvCost(f,o.system.StF.value,0);return p=this.actor.items.filter((function(e){return"spellextension"==e.type&&o.type==e.system.category&&o.name==e.system.source})),p&&(l+=p.reduce((function(e,t){return e+t.system.APValue.value}),0),i.push.apply(i,N(p.map((function(e){return e.id}))))),t.next=24,this._updateAPs(-1*l);case 25:return t.next=27,this.actor.deleteEmbeddedDocuments("Item",i);case 27:case"end":return t.stop()}}),t,this)}))),function(e){return Y.apply(this,arguments)})},{key:"_getItemId",value:function(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}},{key:"_addMoney",value:(B=H(Z().mark((function e(t){var r,n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=duplicate(this.actor.items.filter((function(e){return"money"==e.type}))),!(n=r.find((function(e){return e.name==t.name})))){e.next=8;break}return n.system.quantity.value+=t.system.quantity.value,e.next=6,this.actor.updateEmbeddedDocuments("Item",[n]);case 6:e.next=10;break;case 8:return e.next=10,this.actor.createEmbeddedDocuments("Item",[t]);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return B.apply(this,arguments)})},{key:"_updateAPs",value:(G=H(Z().mark((function e(t){var r,n=arguments;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=3,this.actor._updateAPs(t,r);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return G.apply(this,arguments)})},{key:"_addVantage",value:(F=H(Z().mark((function e(t,n){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.Z.needsAdoption(this.actor,t,n);case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return F.apply(this,arguments)})},{key:"_addSpecialAbility",value:(M=H(Z().mark((function e(t,r){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a.Z.needsAdoption(this.actor,t,r);case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return M.apply(this,arguments)})},{key:"_onDragItemStart",value:function(e){var t=e.currentTarget,r=t.getAttribute("data-item-id"),n=t.getAttribute("data-mod"),a=r?this.actor.items.get(r).toObject():{};e.dataTransfer.setData("text/plain",JSON.stringify({type:"Item",sheetTab:this.actor.flags._sheetTab,actorId:this.actor.id,tokenId:this.token?this.token.id:null,mod:n,data:a,root:t.getAttribute("root")})),e.stopPropagation()}},{key:"_handleSpellExtension",value:(C=H(Z().mark((function e(t){var r,n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.actor.items.find((function(e){return e.type==t.type&&e.name==t.name}))){e.next=19;break}if(t=duplicate(t),r=this.actor.items.find((function(e){return e.type==t.system.category&&e.name==t.system.source}))){e.next=8;break}ui.notifications.error(game.i18n.localize("DSAError.noSpellForExtension")),e.next=19;break;case 8:if(!(r.system.talentValue.value<t.system.talentValue)){e.next=11;break}return ui.notifications.error(game.i18n.localize("DSAError.talentValueTooLow")),e.abrupt("return");case 11:return n=t.system.APValue.value,e.next=14,this.actor.checkEnoughXP(n);case 14:if(!e.sent){e.next=19;break}return e.next=17,this._updateAPs(n);case 17:return e.next=19,this.actor.createEmbeddedDocuments("Item",[t]);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"_addSpellOrLiturgy",value:(E=H(Z().mark((function t(r){var n,a;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this.actor.items.find((function(e){return e.type==r.type&&e.name==r.name})),r=duplicate(r),n){t.next=20;break}t.t0=r.type,t.next="spell"===t.t0||"liturgy"===t.t0||"ceremony"===t.t0||"ritual"===t.t0?6:"blessing"===t.t0||"magictrick"===t.t0?8:"magicalsign"===t.t0?10:12;break;case 6:return a=e.Z._calculateAdvCost(0,r.system.StF.value,0),t.abrupt("break",13);case 8:return a=1,t.abrupt("break",13);case 10:return a=r.system.APValue.value,t.abrupt("break",13);case 12:return t.abrupt("return");case 13:return t.next=15,this.actor.checkEnoughXP(a);case 15:if(!t.sent){t.next=20;break}return t.next=18,this._updateAPs(a);case 18:return t.next=20,this.actor.createEmbeddedDocuments("Item",[r]);case 20:case"end":return t.stop()}}),t,this)}))),function(e){return E.apply(this,arguments)})},{key:"_addLoot",value:(O=H(Z().mark((function e(t){var r;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=duplicate(t),r=this.actor.items.find((function(e){return n.Z.areEquals(t,e)}))){e.next=9;break}return"combat"==this._tabs[0].active&&t.system.worn&&(t.system.worn.value=!0),e.next=6,this.actor.createEmbeddedDocuments("Item",[t]);case 6:case 11:return e.abrupt("return",e.sent[0]);case 9:return e.next=11,n.Z.stackItems(r,t,this.actor);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"_addUniqueItem",value:(_=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=duplicate(t),this.actor.items.some((function(e){return n.Z.areEquals(t,e)}))){e.next=5;break}return e.next=4,this.actor.createEmbeddedDocuments("Item",[t]);case 4:return e.abrupt("return",e.sent[0]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"_addDemonMarkOrPatron",value:(x=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._addUniqueItem(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"_addDisease",value:(k=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.system.duration.resolved="?",e.next=3,this._addUniqueItem(t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"_addSkill",value:(w=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=duplicate(t),this.actor.items.find((function(e){return e.type==t.type&&e.name==t.name&&e.system.description.value==t.system.description.value}))){e.next=5;break}return e.next=5,this.actor.createEmbeddedDocuments("Item",[t]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"_onDrop",value:(b=H(Z().mark((function e(t){var r;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=JSON.parse(t.dataTransfer.getData("text/plain")),e.t0=this,e.t1=r,e.t2=t,e.next=6,(0,L.x8)(r,this.actor.id);case 6:e.t3=e.sent,e.t0._handleDragData.call(e.t0,e.t1,e.t2,e.t3);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"handleItemCopy",value:(g=H(Z().mark((function e(r,n){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.Z.equipmentCategories.includes(n)){e.next=5;break}return r.name+=" (Copy)",e.next=4,this._addLoot(r);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"_addFullPack",value:(v=H(Z().mark((function e(t){var r,n,a=this;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.packs.get(t.name).getDocuments();case 2:return r=e.sent,n=r.filter((function(e){return!a.actor.items.find((function(t){return t.type==e.type&&t.name==e.name}))})),e.next=6,this.actor.createEmbeddedDocuments("Item",n.map((function(e){return e.toObject()})));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"_manageDragItems",value:(y=H(Z().mark((function e(t,r){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r,e.next="disease"===e.t0?3:"meleeweapon"===e.t0||"rangeweapon"===e.t0||"equipment"===e.t0||"ammunition"===e.t0||"armor"===e.t0||"poison"===e.t0||"consumable"===e.t0||"plant"===e.t0?6:"disadvantage"===e.t0||"advantage"===e.t0?9:"specialability"===e.t0?12:"money"===e.t0?15:"skill"===e.t0?18:"ritual"===e.t0||"ceremony"===e.t0||"blessing"===e.t0||"magictrick"===e.t0||"liturgy"===e.t0||"spell"===e.t0||"magicalsign"===e.t0?21:"effectwrapper"===e.t0?24:"lookup"===e.t0?27:"fullpack"===e.t0?30:"application"===e.t0?33:"spellextension"===e.t0?36:"condition"===e.t0?39:"creature"===e.t0?42:"information"===e.t0?47:"patron"===e.t0||"demonmark"===e.t0?50:53;break;case 3:return e.next=5,this._addDisease(t);case 5:return e.abrupt("break",54);case 6:return e.next=8,this._addLoot(t);case 8:return e.abrupt("return",e.sent);case 9:return e.next=11,this._addVantage(t,r);case 11:return e.abrupt("break",54);case 12:return e.next=14,this._addSpecialAbility(t,r);case 14:return e.abrupt("break",54);case 15:return e.next=17,this._addMoney(t);case 17:return e.abrupt("break",54);case 18:return e.next=20,this._addSkill(t);case 20:return e.abrupt("break",54);case 21:return e.next=23,this._addSpellOrLiturgy(t);case 23:return e.abrupt("break",54);case 24:return e.next=26,this._handleEffectWrapper(t);case 26:return e.abrupt("break",54);case 27:return e.next=29,this._handleLookup(t);case 29:return e.abrupt("break",54);case 30:return e.next=32,this._addFullPack(t);case 32:return e.abrupt("break",54);case 33:return e.next=35,this._handleApplication(t);case 35:return e.abrupt("break",54);case 36:return e.next=38,this._handleSpellExtension(t);case 38:return e.abrupt("break",54);case 39:return e.next=41,this.actor.addCondition(t.payload.id,1,!1,!1);case 41:return e.abrupt("break",54);case 42:if(!(n=game.dsa5.config.hooks.shapeshift)){e.next=47;break}return n.setShapeshift(this.actor,t),n.render(!0),e.abrupt("break",54);case 47:return e.next=49,this._addUniqueItem(t);case 49:return e.abrupt("break",54);case 50:return e.next=52,this._addDemonMarkOrPatron(t);case 52:return e.abrupt("break",54);case 53:ui.notifications.error(game.i18n.format("DSAError.canNotBeAdded",{item:t.name,category:game.i18n.localize(t.type)}));case 54:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"_handleEffectWrapper",value:(m=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.actor.createEmbeddedDocuments("ActiveEffect",t.effects.map((function(e){return e.origin=null,e})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"_handleLookup",value:(h=H(Z().mark((function t(r){var n,a,o,i;return Z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.Z.findAnyItem(r.items);case 2:if(!(n=t.sent)){t.next=10;break}a=z(r.items);try{for(i=function(){var e=o.value;if(e.count){var t=n.find((function(t){return t.name==e.name&&t.type==e.type}));t?(t.system.quantity.value=e.count,e.qs&&"equipment"==e.type&&(t.system.QL=e.qs)):ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:e.type,name:e.name}))}},a.s();!(o=a.n()).done;)i()}catch(e){a.e(e)}finally{a.f()}return t.next=8,this.actor.createEmbeddedDocuments("Item",n);case 8:t.next=11;break;case 10:ui.notifications.error(game.i18n.format("DSAError.notFound",{category:thing.type,name:thing.name}));case 11:case"end":return t.stop()}}),t,this)}))),function(e){return h.apply(this,arguments)})},{key:"_handleApplication",value:(d=H(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=duplicate(t),this.actor.items.find((function(e){return e.type==t.type&&e.name==t.name}))){e.next=5;break}return e.next=5,this.actor.createEmbeddedDocuments("Item",[t]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"_handleRemoveSourceOnDrop",value:(p=H(Z().mark((function e(t,r){var n;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.tokenId&&(n=game.actors.tokens[t.tokenId]),n||(n=game.actors.get(t.actorId)),!n||!n.isOwner){e.next=5;break}return e.next=5,n.deleteEmbeddedDocuments("Item",[r._id]);case 5:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"_handleDragData",value:(f=H(Z().mark((function e(r,n,a){var o,i,s,c,u;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.item,i=a.typeClass,s=a.selfTarget,o){e.next=3;break}return e.abrupt("return");case 3:if((u=$(n.target).parents(".item"))&&"bags"==u.attr("data-category")&&t.Z.equipmentCategories.includes(i)&&u.attr("data-item-id")!=o._id&&(c=u.attr("data-item-id"),o.system.parent_id=c,o.system.worn&&o.system.worn.value&&(o.system.worn.value=!1)),!n.ctrlKey||!s){e.next=10;break}return e.next=8,this.handleItemCopy(o,i);case 8:case 13:case 18:e.next=23;break;case 10:if(s){e.next=15;break}return e.next=13,this._manageDragItems(o,i);case 15:if(!s||!c){e.next=20;break}return e.next=18,this.actor.updateEmbeddedDocuments("Item",[o]);case 20:if(!s||!t.Z.equipmentCategories.includes(i)){e.next=23;break}return e.next=23,this.actor.updateEmbeddedDocuments("Item",[{_id:o._id,system:{parent_id:0}}]);case 23:if(!n.altKey||s||!t.Z.equipmentCategories.includes(i)){e.next=26;break}return e.next=26,this._handleRemoveSourceOnDrop(r,o);case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return f.apply(this,arguments)})}],l=[{key:"defaultOptions",get:function(){var e=U(J(ve),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(e,{width:770,height:740,scrollY:[".save-scroll"]}),e}}],u&&q(c.prototype,u),l&&q(c,l),Object.defineProperty(c,"prototype",{writable:!1}),ve}(),X=__webpack_require__(794);function ee(e){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ee(e)}function te(e){return function(e){if(Array.isArray(e))return oe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ae(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function re(){re=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==ee(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function ne(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=ae(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function ae(e,t){if(e){if("string"==typeof e)return oe(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?oe(e,t):void 0}}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function ie(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function se(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ie(o,n,a,i,s,"next",e)}function s(e){ie(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ce(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ue(){return ue="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=le(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},ue.apply(this,arguments)}function le(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=de(e)););return e}function fe(e,t){return fe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},fe(e,t)}function pe(e,t){if(t&&("object"===ee(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function de(e){return de=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},de(e)}var he=function(n){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&fe(e,t)}(m,Application);var o,i,s,c,u,l,f,p,d,h=(p=m,d=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=de(p);if(d){var r=de(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return pe(this,e)});function m(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(t=h.call(this,e)).items=[],t.actor=null,t.errors=[],t.dataTypes=[],t.attributes=[],t.updating=!1,t}return o=m,i=[{key:"parseToItem",value:function(r,n){var a=this;return""==r.trim()?[]:r.split(", ").map((function(r){var o=e.Z.parseAbilityString(r.trim()),i=a.items.find((function(e){return e.name==o.original&&n.includes(e.type)}));if(i||(i=a.items.find((function(e){return e.name==o.name&&n.includes(e.type)}))),i)(i=duplicate(i)).tooltip=game.i18n.localize("Details"),(i=X.Z.reverseAdoptionCalculation(a.actor,o,i)).system.APValue&&(i.APunparseable=isNaN(i.system.APValue.value),i.apCost=i.APunparseable?i.system.APValue.value:o.step*Number(i.system.APValue.value));else if(a.attributes.includes(o.name)){for(var s=0,c=a.actor.system.characteristics[game.dsa5.config.knownShortcuts[o.name.toLowerCase()][1]].value+1;c<o.step+1;c++)s+=t.Z.advancementCosts.E[c];i={name:o.name,step:o.step,attributeRequirement:!0,system:{APValue:{value:s}}}}else console.warn("Not found <".concat(r,">")),a.errors.push("".concat(n.map((function(e){return game.i18n.localize(e)})).join("/"),": ").concat(r)),i={name:r.trim(),notFound:!0,tooltip:game.i18n.localize("DSAError.itemNotFound"),apCost:"?"};i.replaceName=o.original,i.step=o.step;var u=null!=a.actor.items.find((function(e){return n.includes(e.type)&&e.name==o.original}));return i.disabled=u||i.notFound||i.APunparseable,u&&(i.tooltip=game.i18n.localize("YouAlreadyHaveit")),i}))}},{key:"addSelections",value:(f=se(re().mark((function t(n){var o,i,s,c,u=this;return re().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=[],i=ne(n),t.prev=2,c=function(){var t=s.value;if(""==$(t).val())return"continue";var n=duplicate(u.items.find((function(e){return e.id==$(t).val()}))),i=e.Z.parseAbilityString(n.name);switch(n.name=$(t).attr("name"),n.type){case"advantage":case"disadvantage":n.system.step.value=Number($(t).attr("data-step")),n=X.Z.reverseAdoptionCalculation(u.actor,i,n),o.push(n),r.Z.vantageAdded(u.actor,n);break;case"specialability":n.system.step.value=Number($(t).attr("data-step")),$(t).attr("data-free")&&(n.system.APValue.value=0),n=X.Z.reverseAdoptionCalculation(u.actor,i,n),o.push(n),a.Z.abilityAdded(u.actor,n);break;case"magictrick":o.push(n)}},i.s();case 5:if((s=i.n()).done){t.next=11;break}if("continue"!==c()){t.next=9;break}return t.abrupt("continue",9);case 9:t.next=5;break;case 11:t.next=16;break;case 13:t.prev=13,t.t0=t.catch(2),i.e(t.t0);case 16:return t.prev=16,i.f(),t.finish(16);case 19:return t.next=21,this.actor.createEmbeddedDocuments("Item",o);case 21:case"end":return t.stop()}}),t,this,[[2,13,16,19]])}))),function(e){return f.apply(this,arguments)})},{key:"alreadyAdded",value:(l=se(re().mark((function e(t,r){var n;return re().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""!=t){e.next=2;break}return e.abrupt("return",!1);case 2:return n=!1,e.next=5,new Promise((function(e,t){new Dialog({title:game.i18n.localize("DIALOG.warning"),content:game.i18n.format("DIALOG.alreadyAddedCharacterpart",{category:game.i18n.localize(r)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Ok"),default:!0,callback:function(){e(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("Cancel"),default:!0,callback:function(){e(!0)}}}}).render(!0)}));case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)}))),function(e,t){return l.apply(this,arguments)})},{key:"updateSkill",value:(u=se(re().mark((function t(r,n){var a,o,i,s,c,u,l=this,f=arguments;return re().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=f.length>2&&void 0!==f[2]?f[2]:1,o=!(f.length>3&&void 0!==f[3])||f[3],i=[],s=ne(r);try{for(u=function(){var t=c.value,r=e.Z.parseAbilityString(t.trim()),s=l.actor.items.find((function(e){return e.type==n&&e.name==r.name}));if(s){var u=duplicate(s);u.system.talentValue.value=Math.max(0,a*r.step+(o?Number(u.system.talentValue.value):0)),i.push(u)}else console.warn("Could not find ".concat(n," ").concat(t)),l.errors.push("".concat(game.i18n.localize(n),": ").concat(t))},s.s();!(c=s.n()).done;)u()}catch(e){s.e(e)}finally{s.f()}return t.next=7,this.actor.updateEmbeddedDocuments("Item",i);case 7:case"end":return t.stop()}}),t,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"_loadCompendiae",value:(c=se(re().mark((function e(){var t,r,n,a,o=this;return re().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.items=[],r=ne(game.packs),e.prev=2,r.s();case 4:if((n=r.n()).done){e.next=11;break}if("Item"!=(a=n.value).documentName||!game.user.isGM&&a.private){e.next=9;break}return e.next=9,a.getDocuments().then((function(e){var t;(t=o.items).push.apply(t,te(e.filter((function(e){return o.dataTypes.includes(e.type)}))))}));case 9:e.next=4;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),r.e(e.t0);case 16:return e.prev=16,r.f(),e.finish(16);case 19:(t=this.items).push.apply(t,te(game.items.contents.filter((function(e){return e.permission>1&&o.dataTypes.includes(e.type)}))));case 20:case"end":return e.stop()}}),e,this,[[2,13,16,19]])}))),function(){return c.apply(this,arguments)})},{key:"_validateInput",value:function(e){var t,r=new Set,n=/^exclusive_/,a=ne(e.find(".exclusive"));try{for(a.s();!(t=a.n()).done;){var o=t.value;r.add(o.className.split(/\s+/).filter((function(e){return n.test(e)}))[0])}}catch(e){a.e(e)}finally{a.f()}var i,s=ne(r);try{for(s.s();!(i=s.n()).done;){var c=i.value,u=e.find(".allowedCount_"+c.split("_")[1]),l=Number(u.attr("data-count"));if(e.find(".".concat(c,":checked")).length!=l){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),m.flashElem(u);var f=u.closest(".tab").attr("data-tab");return m.flashElem(e.find(".tabs a[data-tab='".concat(f,"']"))),!1}}}catch(e){s.e(e)}finally{s.f()}return!0}},{key:"activateListeners",value:function(e){var t=this;ue(de(m.prototype),"activateListeners",this).call(this,e),e.find("button.ok").click((function(){t.updating||(t.updating=!0,t.updateCharacter().then((function(){return t.updating=!1})))})),e.find("button.cancel").click((function(){t.close()})),e.find(".show-item").click((function(e){var r=$(e.currentTarget).attr("data-id");t.items.find((function(e){return e.id==r})).sheet.render(!0)})),e.find(".exclusive").change((function(e){var t=$(e.currentTarget).closest(".content"),r=$(e.currentTarget).attr("data-sel"),n=t.find(".allowedCount_".concat(r)),a=Number(n.attr("data-count"));if(t.find(".exclusive_".concat(r,":checked")).length>a)return e.currentTarget.checked=!1,void m.flashElem(n)}))}},{key:"finalizeUpdate",value:function(){0==this.errors.length?this.close():$(this._element).find(".dialog-buttons").html('<div class="error"><p>'.concat(game.i18n.localize("DSAError.notUnderstood"),"</p><ul><li>").concat(this.errors.join("</li><li>"),"</li></ul></div>"))}}],s=[{key:"defaultOptions",get:function(){var e=ue(de(m),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog"]),width:770,height:740}),e.resizable=!0,e}},{key:"flashElem",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"emphasize";e.addClass(t),setTimeout((function(){e.removeClass(t)}),600)}}],i&&ce(o.prototype,i),s&&ce(o,s),Object.defineProperty(o,"prototype",{writable:!1}),m}();function me(e){return me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},me(e)}function ye(){ye=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==me(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function ve(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ge(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ve(o,n,a,i,s,"next",e)}function s(e){ve(o,n,a,i,s,"throw",e)}i(void 0)}))}}function be(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function we(){return we="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=ke(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},we.apply(this,arguments)}function ke(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Oe(e)););return e}function xe(e,t){return xe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},xe(e,t)}function _e(e,t){if(t&&("object"===me(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Oe(e){return Oe=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Oe(e)}var Ee=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&xe(e,t)}(u,e);var t,r,n,a,o,i,s,c=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Oe(i);if(s){var r=Oe(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _e(this,e)});function u(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(t=c.call(this,e)).actor=null,t.culture=null,t.dataTypes=["advantage","disadvantage","specialability","combatskill"],t}return t=u,r=[{key:"activateListeners",value:function(e){we(Oe(u.prototype),"activateListeners",this).call(this,e),e.find(".optional").change((function(e){var t=$(e.currentTarget).closest(".content"),r=Number(t.attr("data-cost"));t.find(".optional:checked").each((function(){r+=Number($(this).attr("data-cost"))}));var n=t.find(".apCost");n.text(r),he.flashElem(n,"emphasize2")}))}},{key:"getData",value:function(e){var t=we(Oe(u.prototype),"getData",this).call(this,e),r=this.parseToItem(this.culture.system.recommendedAdvantages.value,["advantage"]),n=this.parseToItem(this.culture.system.recommendedDisadvantages.value,["disadvantage"]),a=""==this.culture.system.writing.value?[]:this.parseToItem(this.culture.system.writing.value.split(",").map((function(e){return"".concat(game.i18n.localize("LocalizedIDs.literacy")," (").concat(e.trim(),")")})).join(", "),["specialability"]),o=""==this.culture.system.language.value?[]:this.parseToItem(this.culture.system.language.value.split(",").map((function(e){return"".concat(game.i18n.localize("LocalizedIDs.language")," (").concat(e.trim(),") 3")})).join(", "),["specialability"]),i=Number(this.culture.system.APValue.value);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("culture")," ").concat(this.culture.name)}),culture:this.culture,description:game.i18n.format("WIZARD.culturedescr",{culture:this.culture.name,cost:i}),advantages:r,disadvantages:n,writings:a,languages:o,advantagesToChose:r.length>0,disadvantagesToChose:n.length>0,writingsToChose:a.length>0,languagesToChose:o.length>0,languagesToSelect:o.length>1,vantagesToChose:r.length>0||n.length>0,generalToChose:a.length>0||o.length>0}),t}},{key:"addCulture",value:(o=ge(ye().mark((function e(t,r){return ye().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.actor=t,this.culture=duplicate(r),e.next=4,this._loadCompendiae();case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"_validateInput",value:function(e){var t=e.find(".localKnowledge");if(""==t.val()){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),he.flashElem(t);var r=t.closest(".tab").attr("data-tab");return he.flashElem(e.find(".tabs a[data-tab='".concat(r,"']"))),!1}var n=e.find(".selectOnlyOne");if(n.length&&1!=n.find(".optional:checked").length){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),he.flashElem(n);var a=n.closest(".tab").attr("data-tab");return he.flashElem(e.find(".tabs a[data-tab='".concat(a,"']"))),!1}return we(Oe(u.prototype),"_validateInput",this).call(this,e)}},{key:"updateCharacter",value:(a=ge(ye().mark((function e(){var t,r,n,a;return ye().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=$(this._element)).find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),r=Number(t.find(".apCost").text()),e.t1=!this._validateInput($(this._element)),e.t1){e.next=8;break}return e.next=7,this.actor.checkEnoughXP(r);case 7:e.t1=!e.sent;case 8:if(e.t0=e.t1,e.t0){e.next=13;break}return e.next=12,this.alreadyAdded(this.actor.system.details.culture.value,"culture");case 12:e.t0=e.sent;case 13:if(!e.t0){e.next=16;break}return t.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),e.abrupt("return");case 16:if(n={"system.details.culture.value":this.culture.name},!(a=this.items.find((function(e){return e.name=="".concat(game.i18n.localize("LocalizedIDs.localKnowledge")," ()")&&"specialability"==e.type})))){e.next=24;break}return(a=duplicate(a)).name="".concat(game.i18n.localize("LocalizedIDs.localKnowledge")," (").concat(t.find(".localKnowledge").val(),")"),a.system.APValue.value=0,e.next=24,this.actor.createEmbeddedDocuments("Item",[a]);case 24:return e.next=26,this.addSelections(t.find(".optional:checked"));case 26:return e.next=28,this.actor.update(n);case 28:return e.next=30,this.actor._updateAPs(r);case 30:return e.next=32,this.updateSkill(this.culture.system.skills.value.split(","),"skill");case 32:this.finalizeUpdate();case 33:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})}],n=[{key:"defaultOptions",get:function(){var e=we(Oe(u),"defaultOptions",this);return e.title=game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("culture"))}),e.template="systems/dsa5/templates/wizard/add-culture-wizard.html",e}}],r&&be(t.prototype,r),n&&be(t,n),Object.defineProperty(t,"prototype",{writable:!1}),u}(he);function Se(e){return Se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Se(e)}function Le(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Te(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Te(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Te(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function De(){De=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Se(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Pe(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ae(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Pe(o,n,a,i,s,"next",e)}function s(e){Pe(o,n,a,i,s,"throw",e)}i(void 0)}))}}function je(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ce(){return Ce="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Ie(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Ce.apply(this,arguments)}function Ie(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Re(e)););return e}function Me(e,t){return Me=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Me(e,t)}function Ne(e,t){if(t&&("object"===Se(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Re(e){return Re=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Re(e)}var ze=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Me(e,t)}(p,t);var r,n,a,o,i,s,c,u,l,f=(u=p,l=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Re(u);if(l){var r=Re(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return Ne(this,e)});function p(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,p),(t=f.call(this,e)).items=[],t.career=null,t.dataTypes=["magictrick","blessing","spell","ritual","liturgy","ceremony","advantage","disadvantage","specialability"],t.attributes={de:["MU","KL","IN","CH","FF","GE","KO","KK"],en:["COU","SGC","INT","CHA","DEX","AGI","CON","STR"]}[game.i18n.lang],t}return r=p,n=[{key:"activateListeners",value:function(e){Ce(Re(p.prototype),"activateListeners",this).call(this,e),e.find(".optional").change((function(e){var t=$(e.currentTarget).closest(".content");if($(e.currentTarget).hasClass("exclusiveTricks")){var r=Number(t.find(".maxTricks").attr("data-spelltricklimit"));if(t.find(".exclusiveTricks:checked").length>r)return e.currentTarget.checked=!1,void he.flashElem(t.find(".maxTricks"))}var n=Number(t.attr("data-cost"));t.find(".optional:checked").each((function(){n+=Number($(this).attr("data-cost"))})),t.find(".attributes:checked").each((function(){n+=Number($(this).attr("data-cost"))}));var a=t.find(".apCost");a.text(n),he.flashElem(a,"emphasize2")}))}},{key:"_validateInput",value:function(e){var t=e.find(".maxTricks"),r=Number(t.attr("data-spelltricklimit"))||0;if(e.find(".exclusiveTricks:checked").length!=r){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices")),he.flashElem(t);var n=t.closest(".tab").attr("data-tab");return he.flashElem(e.find(".tabs a[data-tab='".concat(n,"']"))),!1}return Ce(Re(p.prototype),"_validateInput",this).call(this,e)}},{key:"getData",value:function(e){var t=Ce(Re(p.prototype),"getData",this).call(this,e),r=this.parseToItem(this.career.system.recommendedAdvantages.value,["advantage"]),n=this.parseToItem(this.career.system.recommendedDisadvantages.value,["disadvantage"]),a=this.parseToItem(this.career.system.requirements.value,["disadvantage","advantage","specialability"]),o=a.filter((function(e){return["advantage","disadvantage"].includes(e.type)&&!e.disabled})),i=a.filter((function(e){return e.attributeRequirement})),s=this.parseCombatskills(this.career.system.combatSkills.value),c=Number(this.career.system.APValue.value),u=a.reduce((function(e,t){return e+(t.disabled?0:Number(t.system.APValue.value)||0)}),0),l=a.filter((function(e){return"specialability"==e.type&&!e.disabled}));return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("career")," ").concat(this.career.name)}),career:this.career,description:game.i18n.format("WIZARD.careerdescr",{career:this.career.name,cost:c+u}),baseCost:c,advantages:r,disadvantages:n,missingVantages:o,missingSpecialabilities:l,combatskillchoices:s,spelltricks:this.parseToItem(this.career.system.spelltricks.value,["magictrick"]),attributeRequirements:i,advantagesToChose:r.length>0,disadvantagesToChose:n.length>0,vantagesToChose:r.length>0||n.length>0||o.length>0,missingVantagesToChose:o.length>0,missingSpecialabiltiesToChose:l.length>0,combatToChose:s.length>0,magicToChose:this.career.system.spelltrickCount.value>0,religionToChose:!1,anyAttributeRequirements:i.length>0,generalToChose:l.length>0||i.length>0}),t}},{key:"addCareer",value:(c=Ae(De().mark((function e(t,r){return De().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.actor=t,this.career=duplicate(r),e.next=4,this._loadCompendiae();case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"parseCombatskills",value:function(e){var t,r=[],n=Le(e.split(/,|;/));try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.includes(game.i18n.localize("combatskillcountdivider")+":")){var o=a.split(":");r.push({choices:o[1].split("/").map((function(e){return e.trim()})),allowedCount:Number(o[0].match(/\d/g))})}}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"setAbility",value:(s=Ae(De().mark((function t(r,n){var a,o,i,s,c,u=this;return De().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(""!=r.trim()){t.next=2;break}return t.abrupt("return");case 2:a=[],o=[],i=Le(r.split(","));try{for(c=function(){var t=s.value,r=e.Z.parseAbilityString(t.trim()),i=u.actor.items.find((function(e){return n.includes(e.type)&&e.name==r.original}));i?((i=duplicate(i)).system.talentValue&&(i.system.talentValue.value=r.step),i.system.step&&(i.system.step.value=r.step),i=X.Z.reverseAdoptionCalculation(u.actor,r,i),o.push(i)):((i=u.items.find((function(e){return n.includes(e.type)&&e.name==r.original})))||(i=u.items.find((function(e){return n.includes(e.type)&&e.name==r.name}))),i?((i=duplicate(i)).name=r.original,i.system.talentValue&&(i.system.talentValue.value=r.step),i.system.step&&(i.system.step.value=r.step),i=X.Z.reverseAdoptionCalculation(u.actor,r,i),a.push(i)):(u.errors.push("".concat(n.map((function(e){return game.i18n.localize(e)})).join("/"),": ").concat(t)),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(n[0]),name:t}))))},i.s();!(s=i.n()).done;)c()}catch(e){i.e(e)}finally{i.f()}return t.next=8,this.actor.updateEmbeddedDocuments("Item",o);case 8:return t.next=10,this.actor.createEmbeddedDocuments("Item",a);case 10:case"end":return t.stop()}}),t,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"addBlessing",value:(i=Ae(De().mark((function e(t,r){var n,a,o,i,s=this;return De().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],a=Le(t),e.prev=2,i=function(){var e=o.value,t=e.trim();if(""==t)return"continue";var a=s.actor.items.find((function(e){return r==e.type&&e.name==t}));a||((a=s.items.find((function(e){return r==e.type&&e.name==t})))?(a=duplicate(a),n.push(a)):(s.errors.push("".concat(game.i18n.localize(r),": ").concat(e)),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(r),name:t}))))},a.s();case 5:if((o=a.n()).done){e.next=11;break}if("continue"!==i()){e.next=9;break}return e.abrupt("continue",9);case 9:e.next=5;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),a.e(e.t0);case 16:return e.prev=16,a.f(),e.finish(16);case 19:return e.next=21,this.actor.createEmbeddedDocuments("Item",n);case 21:case"end":return e.stop()}}),e,this,[[2,13,16,19]])}))),function(e,t){return i.apply(this,arguments)})},{key:"updateCharacter",value:(o=Ae(De().mark((function e(){var t,r,n,a,o,i,s,c,u,l,f,p;return De().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=$(this._element)).find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),r=Number(t.find(".apCost").text()),e.t1=!this._validateInput($(this._element)),e.t1){e.next=8;break}return e.next=7,this.actor.checkEnoughXP(r);case 7:e.t1=!e.sent;case 8:if(e.t0=e.t1,e.t0){e.next=13;break}return e.next=12,this.alreadyAdded(this.actor.system.details.career.value,"career");case 12:e.t0=e.sent;case 13:if(!e.t0){e.next=16;break}return t.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),e.abrupt("return");case 16:n={"system.details.career.value":this.career.name,"system.freeLanguagePoints.value":this.career.system.languagePoints.value},a=Le(t.find(".attributes"));try{for(a.s();!(o=a.n()).done;)i=o.value,s=$(i).attr("data-attribute").toLowerCase(),s=game.dsa5.config.knownShortcuts[s.toLowerCase()][1],Number(this.actor.system.characteristics[s].initial)+Number(this.actor.system.characteristics[s].advances)<Number($(i).val())&&(this.actor.system.canAdvance?n["system.characteristics.".concat(s,".advances")]=Number($(i).val())-Number(this.actor.system.characteristics[s].initial):n["system.characteristics.".concat(s,".initial")]=Number($(i).val()))}catch(e){a.e(e)}finally{a.f()}if("mundane"!=this.career.system.mageLevel.value&&(n["system.guidevalue.".concat(this.career.system.mageLevel.value)]=this.career.system.guidevalue.value,n["system.energyfactor.".concat(this.career.system.mageLevel.value)]=this.career.system.guidevalue.factor,n["system.tradition.".concat(this.career.system.mageLevel.value)]=this.career.system.tradition.value,n["system.feature.".concat(this.career.system.mageLevel.value)]=this.career.system.feature.value),"clerical"!=this.career.system.mageLevel.value){e.next=26;break}return n["system.happyTalents.value"]=this.career.system.happyTalents.value,e.next=24,this.setAbility(this.career.system.liturgies.value,["liturgy","ceremony"]);case 24:return e.next=26,this.addBlessing(this.career.system.blessings.value.split(","),"blessing");case 26:if("magical"!=this.career.system.mageLevel.value){e.next=29;break}return e.next=29,this.setAbility(this.career.system.spells.value,["spell","ritual"]);case 29:return e.next=31,this.setAbility(this.career.system.specialAbilities.value,["specialability"]);case 31:return e.next=33,this.actor.update(n);case 33:return e.next=35,this.actor._updateAPs(r);case 35:return e.next=37,this.addSelections(t.find(".optional:checked"));case 37:return e.next=39,this.updateSkill(this.career.system.skills.value.split(","),"skill");case 39:c=[],u=Le(t.find(".exclusive:checked"));try{for(u.s();!(l=u.n()).done;)f=l.value,c.push($(f).val())}catch(e){u.e(e)}finally{u.f()}return p=this.career.system.combatSkills.value.split(",").concat(c).filter((function(e){return!(e.includes(game.i18n.localize("combatskillcountdivider")+":")||""==e)})),e.next=45,this.updateSkill(p,"combatskill",1,!1);case 45:this.finalizeUpdate();case 46:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],a=[{key:"defaultOptions",get:function(){var e=Ce(Re(p),"defaultOptions",this);return e.title=game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("career"))}),e.template="systems/dsa5/templates/wizard/add-career-wizard.html",e}}],n&&je(r.prototype,n),a&&je(r,a),Object.defineProperty(r,"prototype",{writable:!1}),p}(he);function Fe(e){return Fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Fe(e)}function Ge(){Ge=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Fe(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Ze(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Be(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ze(o,n,a,i,s,"next",e)}function s(e){Ze(o,n,a,i,s,"throw",e)}i(void 0)}))}}function He(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return We(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?We(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function We(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function qe(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function $e(){return $e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Ue(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},$e.apply(this,arguments)}function Ue(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ke(e)););return e}function Ye(e,t){return Ye=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ye(e,t)}function Ve(e,t){if(t&&("object"===Fe(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Ke(e){return Ke=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Ke(e)}var Je=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ye(e,t)}(u,e);var t,r,n,a,o,i,s,c=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Ke(i);if(s){var r=Ke(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return Ve(this,e)});function u(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(t=c.call(this,e)).actor=null,t.culture=null,t.dataTypes=["advantage","disadvantage"],t.attributes=[],t}return t=u,r=[{key:"activateListeners",value:function(e){$e(Ke(u.prototype),"activateListeners",this).call(this,e),e.find(".optional").change((function(e){var t=$(e.currentTarget).closest(".content"),r=Number(t.attr("data-cost"));t.find(".optional:checked").each((function(){r+=Number($(this).attr("data-cost"))}));var n=t.find(".apCost");n.text(r),he.flashElem(n,"emphasize2")}))}},{key:"_toGroups",value:function(e,t){var r=this;return e.split("\n").map((function(e){var n=e.split(":");return n.length>1?{name:n[0].trim(),res:r.parseToItem(n[1].trim(),t)}:{name:"",res:r.parseToItem(e,t)}}))}},{key:"_parseAttributes",value:function(e){var t,r=[],n=He(e.split(","));try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.includes(game.i18n.localize("combatskillcountdivider")+":")){var o=a.split(":");r.push({choices:o[1].split("/").map((function(e){return e.trim()})),allowedCount:Number(o[0].match(/\d/g))})}}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"getData",value:function(e){var t=$e(Ke(u.prototype),"getData",this).call(this,e),r=this._toGroups(this.species.system.recommendedAdvantages.value,["advantage"]),n=this._toGroups(this.species.system.recommendedDisadvantages.value,["disadvantage"]),a=this.parseToItem(this.species.system.requirements.value,["disadvantage","advantage"]),o=a.filter((function(e){return["advantage","disadvantage"].includes(e.type)&&!e.disabled})),i=this._parseAttributes(this.species.system.attributeChange.value),s=Number(this.species.system.APValue.value),c=a.reduce((function(e,t){return e+(t.disabled?0:Number(t.system.APValue.value)||0)}),0);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("species")," ").concat(this.species.name)}),species:this.species,description:game.i18n.format("WIZARD.speciesdescr",{species:this.species.name,cost:s+c}),advantagegroups:r,baseCost:s,speciesDescription:game.i18n.has("Racedescr.".concat(this.species.name))?game.i18n.localize("Racedescr.".concat(this.species.name)):this.species.system.description.value,disadvantagegroups:n,missingVantages:o,attributeRequirements:i,anyAttributeRequirements:i.length>0,advantagesToChose:r.length>0,missingVantagesToChose:o.length>0,disadvantagesToChose:n.length>0,vantagesToChose:r.length>0||n.length>0||o.length>0,generalToChose:i.length>0}),t}},{key:"addSpecies",value:(o=Be(Ge().mark((function e(t,r){return Ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.actor=t,this.species=duplicate(r),e.next=4,this._loadCompendiae();case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"updateCharacter",value:(a=Be(Ge().mark((function e(){var t,r,n,a,o,i,s,c,u,l,f,p;return Ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=$(this._element)).find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),r=Number(t.find(".apCost").text()),e.t1=!this._validateInput($(this._element)),e.t1){e.next=8;break}return e.next=7,this.actor.checkEnoughXP(r);case 7:e.t1=!e.sent;case 8:if(e.t0=e.t1,e.t0){e.next=13;break}return e.next=12,this.alreadyAdded(this.actor.system.details.species.value,"species");case 12:e.t0=e.sent;case 13:if(!e.t0){e.next=16;break}return t.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin"),e.abrupt("return");case 16:n={"system.details.species.value":this.species.name,"system.status.speed.initial":this.species.system.baseValues.speed.value,"system.status.soulpower.initial":this.species.system.baseValues.soulpower.value,"system.status.toughness.initial":this.species.system.baseValues.toughness.value,"system.status.wounds.initial":this.species.system.baseValues.wounds.value,"system.status.wounds.value":this.species.system.baseValues.wounds.value+2*this.actor.system.characteristics.ko.value},a=[],o=He(t.find(".exclusive:checked"));try{for(o.s();!(i=o.n()).done;)s=i.value,a.push($(s).val())}catch(e){o.e(e)}finally{o.f()}["mu","kl","in","ch","ff","ge","ko","kk"].forEach((function(e){n["data.characteristics.".concat(e,".species")]=0})),c=He(this.species.system.attributeChange.value.split(",").concat(a)),e.prev=22,c.s();case 24:if((u=c.n()).done){e.next=34;break}if(!(l=u.value).includes(game.i18n.localize("combatskillcountdivider")+":")&&""!=l){e.next=28;break}return e.abrupt("continue",32);case 28:f=l.trim().split(" "),(p=game.dsa5.config.knownShortcuts[f[0].toLowerCase().trim()].slice(0))[p.length-1]="species",n["data.".concat(p.join("."))]=Number(f[1]);case 32:e.next=24;break;case 34:e.next=39;break;case 36:e.prev=36,e.t2=e.catch(22),c.e(e.t2);case 39:return e.prev=39,c.f(),e.finish(39);case 42:return e.next=44,this.actor.update(n);case 44:return e.next=46,this.actor._updateAPs(r);case 46:return e.next=48,this.addSelections(t.find(".optional:checked"));case 48:return e.next=50,this.actor.removeCondition("incapacitated");case 50:this.finalizeUpdate();case 51:case"end":return e.stop()}}),e,this,[[22,36,39,42]])}))),function(){return a.apply(this,arguments)})}],n=[{key:"defaultOptions",get:function(){var e=$e(Ke(u),"defaultOptions",this);return e.title=game.i18n.format("WIZARD.addItem",{item:"".concat(game.i18n.localize("species"))}),e.template="systems/dsa5/templates/wizard/add-species-wizard.html",e}}],r&&qe(t.prototype,r),n&&qe(t,n),Object.defineProperty(t,"prototype",{writable:!1}),u}(he);function Qe(e){return Qe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Qe(e)}function Xe(){Xe=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Qe(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function et(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function tt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function nt(){return nt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=at(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},nt.apply(this,arguments)}function at(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=st(e)););return e}function ot(e,t){return ot=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ot(e,t)}function it(e,t){if(t&&("object"===Qe(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function st(e){return st=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},st(e)}var ct=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ot(e,t)}(u,e);var t,r,n,a,o,i,s,c=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=st(i);if(s){var r=st(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return it(this,e)});function u(){return tt(this,u),c.apply(this,arguments)}return t=u,r=[{key:"template",get:function(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/actor-sheet.html"}},{key:"_manageDragItems",value:(a=Xe().mark((function e(t,r){var n,a,o;return Xe().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r,e.next="aggregatedTest"===e.t0?3:"species"===e.t0?6:"culture"===e.t0?11:"career"===e.t0?16:21;break;case 3:return e.next=5,this.actor.createEmbeddedDocuments("Item",[t]);case 5:return e.abrupt("break",22);case 6:return n=new Je,e.next=9,n.addSpecies(this.actor,t);case 9:return n.render(!0),e.abrupt("break",22);case 11:return a=new Ee,e.next=14,a.addCulture(this.actor,t);case 14:return a.render(!0),e.abrupt("break",22);case 16:return o=new ze,e.next=19,o.addCareer(this.actor,t);case 19:return o.render(!0),e.abrupt("break",22);case 21:return e.abrupt("return",nt(st(u.prototype),"_manageDragItems",this).call(this,t,r));case 22:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){et(o,r,n,i,s,"next",e)}function s(e){et(o,r,n,i,s,"throw",e)}i(void 0)}))},function(e,t){return o.apply(this,arguments)})}],n=[{key:"defaultOptions",get:function(){var e=nt(st(u),"defaultOptions",this);return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","character-sheet"]),width:784}),e}}],r&&rt(t.prototype,r),n&&rt(t,n),Object.defineProperty(t,"prototype",{writable:!1}),u}(Q),ut=__webpack_require__(101);function lt(e){return lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},lt(e)}function ft(){ft=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==lt(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function pt(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function dt(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){pt(o,n,a,i,s,"next",e)}function s(e){pt(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ht(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function mt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function yt(){return yt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=vt(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},yt.apply(this,arguments)}function vt(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=wt(e)););return e}function gt(e,t){return gt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},gt(e,t)}function bt(e,t){if(t&&("object"===lt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function wt(e){return wt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},wt(e)}var kt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&gt(e,t)}(p,e);var r,n,a,o,i,s,c,u,l,f=(u=p,l=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=wt(u);if(l){var r=wt(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return bt(this,e)});function p(){return ht(this,p),f.apply(this,arguments)}return r=p,n=[{key:"template",get:function(){return this.showLimited()?"systems/dsa5/templates/actors/creature-limited.html":"systems/dsa5/templates/actors/creature-sheet.html"}},{key:"getData",value:(c=dt(ft().mark((function e(r){var n;return ft().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,yt(wt(p.prototype),"getData",this).call(this,r);case 2:return(n=e.sent).sizeCategories=t.Z.sizeCategories,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"_cleverDeleteItem",value:(s=dt(ft().mark((function e(t){var r;return ft().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.actor.items.find((function(e){return e.id==t})),e.t0=r.type,e.next="trait"===e.t0?4:7;break;case 4:return e.next=6,this._updateAPs(-1*r.system.APValue.value);case 6:return e.abrupt("break",7);case 7:return e.next=9,yt(wt(p.prototype),"_cleverDeleteItem",this).call(this,t);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"_addTrait",value:(i=dt(ft().mark((function e(t){return ft().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.actor.items.find((function(e){return"trait"==e.type&&e.name==t.name}))){e.next=8;break}return e.next=4,this._updateAPs(t.system.APValue.value);case 4:return e.next=6,ut.Z.traitAdded(this.actor,t);case 6:return e.next=8,this.actor.createEmbeddedDocuments("Item",[t]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"_handleDragData",value:(o=dt(ft().mark((function e(t,r,n){var a,o,i;return ft().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.item,o=n.typeClass,i=n.selfTarget,a){e.next=3;break}return e.abrupt("return");case 3:e.t0=o,e.next="trait"===e.t0?6:9;break;case 6:return e.next=8,this._addTrait(a);case 8:return e.abrupt("break",10);case 9:yt(wt(p.prototype),"_handleDragData",this).call(this,t,r,{item:a,typeClass:o,selfTarget:i});case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return o.apply(this,arguments)})}],a=[{key:"defaultOptions",get:function(){var e=yt(wt(p),"defaultOptions",this);return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","creature-sheet"])}),e}}],n&&mt(r.prototype,n),a&&mt(r,a),Object.defineProperty(r,"prototype",{writable:!1}),p}(Q);function xt(e){return xt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},xt(e)}function _t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ot(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Et(){return Et="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=St(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Et.apply(this,arguments)}function St(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Dt(e)););return e}function Lt(e,t){return Lt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Lt(e,t)}function Tt(e,t){if(t&&("object"===xt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Dt(e){return Dt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Dt(e)}var Pt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Lt(e,t)}(s,e);var t,r,n,a,o,i=(a=s,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Dt(a);if(o){var r=Dt(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return Tt(this,e)});function s(){return _t(this,s),i.apply(this,arguments)}return t=s,n=[{key:"defaultOptions",get:function(){var e=Et(Dt(s),"defaultOptions",this);return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","npc-sheet"])}),e}}],(r=[{key:"template",get:function(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/npc-sheet.html"}}])&&Ot(t.prototype,r),n&&Ot(t,n),Object.defineProperty(t,"prototype",{writable:!1}),s}(ct),At=__webpack_require__(702),jt=__webpack_require__(562);function Ct(e){return Ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ct(e)}function It(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Mt(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Nt(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Nt(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Nt(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Rt(){Rt=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Ct(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function zt(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ft(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){zt(o,n,a,i,s,"next",e)}function s(e){zt(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Gt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Zt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Bt(e,t,r){return t&&Zt(e.prototype,t),r&&Zt(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Ht(){return Ht="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Wt(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Ht.apply(this,arguments)}function Wt(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Vt(e)););return e}function qt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&$t(e,t)}function $t(e,t){return $t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},$t(e,t)}function Ut(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Vt(e);if(t){var a=Vt(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Yt(this,r)}}function Yt(e,t){if(t&&("object"===Ct(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Vt(e){return Vt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Vt(e)}var Kt=function(r){qt(u,ItemSheet);var n,a,s,c=Ut(u);function u(e,t){var r;return Gt(this,u),(r=c.call(this,e,t)).mce=null,r}return Bt(u,[{key:"_render",value:(s=Ft(Rt().mark((function e(){var t,r,n=arguments;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]&&n[0],r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=4,Ht(Vt(u.prototype),"_render",this).call(this,t,r);case 4:$(this._element).find(".close").attr("data-tooltip",game.i18n.localize("SHEET.Close")),$(this._element).find(".configure-sheet").attr("data-tooltip",game.i18n.localize("SHEET.Configure")),$(this._element).find(".import").attr("data-tooltip",game.i18n.localize("SHEET.Import")),$(this._element).find(".rolleffect").attr("data-tooltip",game.i18n.localize("SHEET.RollEffect")),$(this._element).find(".showItemHead").attr("data-tooltip",game.i18n.localize("SHEET.PostItem")),$(this._element).find(".consumeItem").attr("data-tooltip",game.i18n.localize("SHEET.ConsumeItem")),$(this._element).find(".rollDamaged").attr("data-tooltip",game.i18n.localize("DSASETTINGS.armorAndWeaponDamage")),$(this._element).find(".onUseEffect").attr("data-tooltip",game.i18n.localize("SHEET.onUseEffect"));case 12:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"_getHeaderButtons",value:function(){var e,t,r=this,n=Ht(Vt(u.prototype),"_getHeaderButtons",this).call(this);return n.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:(e=Ft(Rt().mark((function e(){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.item.postItem());case 1:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}),this.item.actor&&A.Z.getOnUseEffect(this.item)&&n.unshift({class:"onUseEffect",icon:"fas fa-dice-six",onclick:(t=Ft(Rt().mark((function e(){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:new A.Z(r.item).executeOnUseEffect();case 2:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}),n}},{key:"setupEffect",value:function(e){var t=this;this.item.setupEffect().then((function(e){return t.item.itemTest(e)}))}},{key:"template",get:function(){var e=this.item.type;return"systems/dsa5/templates/items/item-".concat(e,"-sheet.html")}},{key:"_getItemId",value:function(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}},{key:"_advanceStep",value:function(){}},{key:"_refundStep",value:function(){}},{key:"advanceWrapper",value:(a=Ft(Rt().mark((function e(t,r){var n,a;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=$(t.currentTarget),(a=n.find("i")).hasClass("fa-spin")){e.next=7;break}return a.addClass("fa-spin fa-spinner"),e.next=6,this[r]();case 6:a.removeClass("fa-spin fa-spinner");case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"activateListeners",value:function(t){var r=this;Ht(Vt(u.prototype),"activateListeners",this).call(this,t),t.find(".advance-step").mousedown((function(e){return r.advanceWrapper(e,"_advanceStep")})),t.find(".refund-step").mousedown((function(e){return r.advanceWrapper(e,"_refundStep")})),t.find(".domainsPretty").click((function(e){$(e.currentTarget).hide(),$(e.currentTarget).next(".domainToggle").show()})),t.find('[data-edit="img"]').mousedown((function(t){2==t.button&&e.Z.showArtwork(r.item)})),t.find(".status-add").click((function(){r.item.actor?ui.notifications.error(game.i18n.localize("DSAError.nestedEffectNotSupported")):i.Z.createCustomEffect(r.item,"",r.item.name)})),t.find(".condition-show").mousedown((function(e){e.preventDefault();var t=$(e.currentTarget).attr("data-id");0==e.button?r.item.effects.get(t).sheet.render(!0):2==e.button&&r.item.deleteEmbeddedDocuments("ActiveEffect",[t])})),t.find(".condition-toggle").mousedown((function(e){var t=$(e.currentTarget).parents(".statusEffect").attr("data-id"),n=r.item.effects.get(t);n.update({disabled:!n.system.disabled})})),t.find(".condition-edit").click((function(e){r.item.effects.get($(e.currentTarget).attr("data-id")).sheet.render(!0)})),i.Z.bindButtons(t),t.on("click",".chat-condition",(function(e){o.Z.postStatus($(e.currentTarget).attr("data-id"))}));var n=t.find(".item-header");if(n.length){var a=n.find("svg");if(a){new ResizeObserver((function(e){var t=e[0];(0,L.zJ)(a,t.contentRect.width)})).observe(n.get(0));var s=n.find("input");s.get(0).disabled||(a.click((function(){a.hide(),s.show(),s.focus()})),s.blur((function(){a.show(),s.hide()})))}}}},{key:"getData",value:(n=Ft(Rt().mark((function r(n){var a;return Rt().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:a=Ht(Vt(u.prototype),"getData",this).call(this,n).data,r.t0=this.item.type,r.next="skill"===r.t0?4:"application"===r.t0?10:"combatskill"===r.t0?16:"trait"===r.t0?21:"aggregatedTest"===r.t0?24:28;break;case 4:return a.characteristics=t.Z.characteristics,a.skillGroups=t.Z.skillGroups,a.skillBurdens=t.Z.skillBurdens,a.hasLocalization=game.i18n.has("SKILLdescr.".concat(this.item.name)),a.StFs=t.Z.StFs,r.abrupt("break",28);case 10:return a.hasLocalization=game.i18n.has("APPLICATION.".concat(this.item.system.skill," - ").concat(this.item.name)),a.localization=game.i18n.localize("APPLICATION.".concat(this.item.system.skill," - ").concat(this.item.name)),r.next=14,e.Z.allSkillsList();case 14:case 26:return a.allSkills=r.sent,r.abrupt("break",28);case 16:return a.weapontypes=t.Z.weapontypes,a.guidevalues=t.Z.combatskillsGuidevalues,a.hasLocalization=game.i18n.has("Combatskilldescr.".concat(this.item.name)),a.StFs=t.Z.StFs,r.abrupt("break",28);case 21:return a.traitCategories=t.Z.traitCategories,a.ranges=t.Z.meleeRanges,r.abrupt("break",28);case 24:return r.next=26,e.Z.allSkillsList();case 28:return a.isOwned=this.item.actor,a.editable=this.isEditable,a.isOwned&&(a.canAdvance=this.item.actor.system.canAdvance&&this._advancable()),i.Z.prepareActiveEffects(this.item,a),a.item=this.item,a.armorAndWeaponDamage=game.settings.get("dsa5","armorAndWeaponDamage"),r.abrupt("return",a);case 35:case"end":return r.stop()}}),r,this)}))),function(e){return n.apply(this,arguments)})},{key:"_advancable",value:function(){return!1}}],[{key:"defaultOptions",get:function(){var e=Ht(Vt(u),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content"}],mergeObject(e,{classes:e.classes.concat(["dsa5","item"]),width:450,height:500}),e}},{key:"setupSheets",value:function(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsa5",u,{makeDefault:!0}),Items.registerSheet("dsa5",mr,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsa5",sr,{makeDefault:!0,types:["career"]}),Items.registerSheet("dsa5",ur,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsa5",gr,{makeDefault:!0,types:["advantage","disadvantage"]}),Items.registerSheet("dsa5",yr,{makeDefault:!0,types:["ritual","ceremony","liturgy","spell"]}),Items.registerSheet("dsa5",hr,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsa5",pr,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsa5",dr,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsa5",lr,{makeDefault:!0,types:["disease"]}),Items.registerSheet("dsa5",cr,{makeDefault:!0,types:["consumable"]}),Items.registerSheet("dsa5",vr,{makeDefault:!0,types:["spellextension"]}),Items.registerSheet("dsa5",fr,{makeDefault:!0,types:["magictrick"]}),Items.registerSheet("dsa5",ir,{makeDefault:!0,types:["blessing"]}),Items.registerSheet("dsa5",or,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsa5",er,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsa5",tr,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsa5",Xt,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsa5",rr,{makeDefault:!0,types:["plant"]}),Items.registerSheet("dsa5",ar,{makeDefault:!0,types:["magicalsign"]}),Items.registerSheet("dsa5",nr,{makeDefault:!0,types:["patron"]}),Items.registerSheet("dsa5",Qt,{makeDefault:!0,types:["information"]}),Items.unregisterSheet("dsa5",u,{types:["armor","equipment","rangeweapon","blessing","magictrick","spellextension","consumable","species","career","culture","advantage","specialability","disadvantage","ritual","information","ceremony","liturgy","spell","disease","poison","meleeweapon","ammunition","plant","magicalsign","patron"]})}}]),u}(),Jt=function(t){qt(c,t);var r,n,a,o,i,s=Ut(c);function c(){return Gt(this,c),s.apply(this,arguments)}return Bt(c,[{key:"_onDrop",value:(i=Ft(Rt().mark((function e(t){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.enchant(t);case 2:if(!this.isPoisonable){e.next=5;break}return e.next=5,this.poison(t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"enchant",value:(o=Ft(Rt().mark((function e(t){var r,n,a,o,i,s,c;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=JSON.parse(t.dataTransfer.getData("text/plain")),e.next=3,(0,L.x8)(r,void 0);case 3:if(n=e.sent,a=n.item,o=n.typeClass,n.selfTarget,!["spell","liturgy","ceremony","ritual"].includes(o)){e.next=18;break}if(!((i=this.item.getFlag("dsa5","enchantments")||[]).length>=7)){e.next=11;break}return e.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.tooManyEnchants")));case 11:if(r.pack){e.next=13;break}return e.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.onlyCompendiumSpells")));case 13:return s={name:a.name,pack:r.pack,id:i.length,itemId:a._id,permanent:["liturgy","ceremony"].includes(o),actorId:r.actorId,charged:!0,talisman:["liturgy","ceremony"].includes(o),fw:["liturgy","ceremony"].includes(o)?18:0},i.push(s),c={flags:{dsa5:{enchantments:i}}},e.next=18,this.item.update(c);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"poison",value:(a=Ft(Rt().mark((function e(t){var r,n,a,o,i,s;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=JSON.parse(t.dataTransfer.getData("text/plain")),e.next=3,(0,L.x8)(r,void 0);case 3:if(n=e.sent,a=n.item,o=n.typeClass,n.selfTarget,"poison"!=o){e.next=12;break}return i={name:a.name,pack:r.pack,itemId:a._id,permanent:!1,actorId:r.actorId},s={flags:{dsa5:{poison:i}}},e.next=12,this.item.update(s);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"toggleChargedState",value:function(e,t){var r,n=Mt(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;if(a.id==e){a.charged=!(!a.talisman||!a.permanent)||!a.charged;break}}}catch(e){n.e(e)}finally{n.f()}this.item.update({flags:{dsa5:{enchantments:t}}})}},{key:"activateListeners",value:function(t){var r=this;Ht(Vt(c.prototype),"activateListeners",this).call(this,t),t.find(".ench-toggle-permanent").click((function(e){var t,n=r.enchantMentId(e),a=n.id,o=n.enchantments,i=Mt(o);try{for(i.s();!(t=i.n()).done;){var s=t.value;if(s.id==a){s.permanent=!s.permanent;break}}}catch(e){i.e(e)}finally{i.f()}r.item.update({flags:{dsa5:{enchantments:o}}})})),t.find(".ench-toggle-charge").click((function(e){var t=r.enchantMentId(e),n=t.id,a=t.enchantments;r.toggleChargedState(n,a)})),t.find(".ench-roll").click(function(){var t=Ft(Rt().mark((function t(n){var a,o,i,s,c,u;return Rt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=r.enchantMentId(n),o=a.id,i=a.enchantments,(s=i.find((function(e){return e.id==o}))).charged){t.next=4;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges")));case 4:return t.next=6,r.getSpell(s);case 6:if(!(c=t.sent)){t.next=14;break}return(c=c.toObject()).system.talentValue.value=s.fw,t.next=12,e.Z.emptyActor(14);case 12:(u=t.sent).setupSpell(c,{},"emptyActor").then(function(){var t=Ft(Rt().mark((function t(n){var a;return Rt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=game.i18n.format("CHATNOTIFICATION.enchantmentUsed",{item:r.item.name,spell:c.name}),t.next=3,ChatMessage.create(e.Z.chatDataSetup(a));case 3:return t.next=5,u.basicTest(n);case 5:s.permanent?r.toggleChargedState(o,i):r.deleteEnchantment(o,i);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 14:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),t.find(".ench-fw").change((function(e){var t=r.enchantMentId(e),n=t.id,a=t.enchantments,o=Number($(e.currentTarget).val());if(o){var i,s=Mt(a);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(c.id==n){c.fw=o;break}}}catch(e){s.e(e)}finally{s.f()}r.item.update({flags:{dsa5:{enchantments:a}}})}})),t.find(".ench-delete").click((function(e){var t=r.enchantMentId(e),n=t.id,a=t.enchantments;r.deleteEnchantment(n,a)})),t.find(".ench-show").click(function(){var e=Ft(Rt().mark((function e(t){var n,a,o,i,s;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.enchantMentId(t),a=n.id,o=n.enchantments,i=o.find((function(e){return e.id==a})),e.next=4,r.getSpell(i);case 4:(s=e.sent)&&s.sheet.render(!0);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.find(".poison-toggle-permanent").click((function(e){r.item.update({flags:{dsa5:{poison:{permanent:!r.item.flags.dsa5.poison.permanent}}}})})),t.find(".poison-delete").click((function(e){r.deletePoison()})),t.find(".poison-show").click(Ft(Rt().mark((function e(){var t;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.item.actor&&(t=r.item.actor.items.find((function(e){return"poison"==e.type&&e.name==r.item.flags.dsa5.poison.name}))),t){e.next=5;break}return e.next=4,r.getSpell(r.item.flags.dsa5.poison);case 4:t=e.sent;case 5:t&&t.sheet.render(!0);case 6:case"end":return e.stop()}}),e)})))),I.Z.bindRollCommands(t)}},{key:"deletePoison",value:function(){this.item.update(It({},"flags.dsa5.-=poison",null))}},{key:"deleteEnchantment",value:function(e,t){var r=t.findIndex((function(t){return t.id==e}));t.splice(r,1),this.item.update({flags:{dsa5:{enchantments:t}}})}},{key:"getSpell",value:(n=Ft(Rt().mark((function e(t){var r,n,a;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.packs.get(t.pack);case 2:if(r=e.sent){e.next=6;break}return ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),e.abrupt("return");case 6:return e.next=8,r.getDocument(t.itemId);case 8:if(n=e.sent){e.next=17;break}return e.next=12,r.index.getName(t.name);case 12:if(!(a=e.sent)){e.next=17;break}return e.next=16,r.getDocument(a._id);case 16:n=e.sent;case 17:return n||ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),e.abrupt("return",n);case 19:case"end":return e.stop()}}),e)}))),function(e){return n.apply(this,arguments)})},{key:"enchantMentId",value:function(e){return{id:$(e.currentTarget).parents(".statusEffect").attr("data-id"),enchantments:this.item.getFlag("dsa5","enchantments")}}},{key:"prepareDomains",value:function(){var e=getProperty(this.item.system,"effect.attributes");if(e){var t=new RegExp(game.i18n.localize("WEAPON.magical"),"i"),r=new RegExp(game.i18n.localize("WEAPON.clerical"),"i");e=e.split(",").map((function(e){var n="";return t.test(e)?n="magical":r.test(e)&&(n="blessed"),'<li class="'.concat(n,'">').concat(e,"</li>")})).join("")}return e}},{key:"_canDragDrop",value:function(e){return this.isEditable}},{key:"getData",value:(r=Ft(Rt().mark((function e(t){var r,n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(c.prototype),"getData",this).call(this,t);case 2:return(r=e.sent).enchantments=this.item.getFlag("dsa5","enchantments"),n=[],r.poison=this.item.getFlag("dsa5","poison"),r.poison&&n.push("poison"),r.enchantments&&r.enchantments.some((function(e){return!e.talisman}))&&n.push("enchantment"),r.enchantments&&r.enchantments.some((function(e){return e.talisman}))&&n.push("talisman"),r.enchantmentLabel=n.map((function(e){return game.i18n.localize(e)})).join("/"),r.hasEnchantments=r.poison||r.enchantments&&r.enchantments.length>0,e.abrupt("return",r);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}],[{key:"defaultOptions",get:function(){var e=Ht(Vt(c),"defaultOptions",this);return mergeObject(e,{dragDrop:[{dragSelector:".item-list .item",dropSelector:".content"}]}),e}}]),c}(Kt),Qt=function(t){qt(a,t);var r,n=Ut(a);function a(){return Gt(this,a),n.apply(this,arguments)}return Bt(a,[{key:"getData",value:(r=Ft(Rt().mark((function t(r){var n;return Rt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:return n=t.sent,t.next=5,e.Z.allSkillsList();case 5:return n.allSkills=t.sent,t.abrupt("return",n);case 7:case"end":return t.stop()}}),t,this)}))),function(e){return r.apply(this,arguments)})}]),a}(Kt),Xt=function(e){qt(a,e);var r,n=Ut(a);function a(e,t){var r;return Gt(this,a),(r=n.call(this,e,t)).mce=null,r.isPoisonable=!0,r}return Bt(a,[{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:return(n=e.sent).ammunitiongroups=t.Z.ammunitiongroups,n.domains=this.prepareDomains(),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),a}(Jt),er=function(e){qt(i,e);var r,n,a,o=Ut(i);function i(){return Gt(this,i),o.apply(this,arguments)}return Bt(i,[{key:"getData",value:(a=Ft(Rt().mark((function e(r){var n,a,o=this;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(i.prototype),"getData",this).call(this,r);case 2:if((n=e.sent).equipmentTypes=t.Z.equipmentTypes,n.domains=this.prepareDomains(),e.t0=game.user.isGM,e.t0){e.next=10;break}return e.next=9,game.settings.get("dsa5","playerCanEditSpellMacro");case 9:e.t0=e.sent;case 10:return n.canOnUseEffect=e.t0,this.isBagWithContents()&&(a=0,n.containerContent=this.item.actor.items.filter((function(e){return t.Z.equipmentCategories.includes(e.type)&&e.system.parent_id==o.item.id})).map((function(e){e.weight=parseFloat((e.system.weight.value*e.system.quantity.value).toFixed(3)),a+=Number(e.weight);var t=getProperty(e,"flags.dsa5.enchantments");return t&&t.length>0?e.enchantClass="rar":(e.system.effect&&""!=e.system.effect.value||e.effects.length>0)&&(e.enchantClass="common"),e})),n.weightSum=parseFloat(a.toFixed(3)),n.weightWidth='style="width: '.concat(Math.min(this.item.system.capacity?a/this.item.system.capacity*100:0,100),'%"'),n.weightExceeded=a>Number(this.item.system.capacity)?"exceeded":""),e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"breakOverflow",value:(n=Ft(Rt().mark((function e(t,r){var n,a,o;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=$,e.next=3,renderTemplate("systems/dsa5/templates/items/baghover.html",t);case 3:return e.t1=e.sent,n=(0,e.t0)(e.t1),a=r.offset().top+52,o=r.offset().left-75,n.appendTo($("body")),n.css({position:"absolute",left:o+"px",top:a+"px",bottom:"auto",right:"auto","z-index":1e4}),e.abrupt("return",n);case 10:case"end":return e.stop()}}),e)}))),function(e,t){return n.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;Ht(Vt(i.prototype),"activateListeners",this).call(this,e);var r=e.find(".slot");r.mouseenter(function(){var e=Ft(Rt().mark((function e(r){var n,a;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=$(r.currentTarget),e.next=3,t.breakOverflow({name:n.attr("data-name"),weight:n.attr("data-weight"),quantity:n.attr("data-quantity")},n);case 3:(a=e.sent).fadeIn(),n.mouseleave((function(){a.remove(),n.off("mouseleave")}));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),r.mousedown(function(){var e=Ft(Rt().mark((function e(r){var n,a;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=$(r.currentTarget).attr("data-item-id"),a=t.actor.items.get(n),0!=r.button){e.next=6;break}a.sheet.render(!0),e.next=11;break;case 6:if(2!=r.button){e.next=11;break}return $(".itemInfo").remove(),e.next=10,a.update({"system.parent_id":0});case 10:t.render(!0);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}},{key:"isBagWithContents",value:function(){return"bags"==this.item.system.equipmentType.value&&this.item.actor}},{key:"_onDrop",value:(r=Ft(Rt().mark((function e(r){var n,a,o,s,c,u;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isBagWithContents()){e.next=22;break}return n=JSON.parse(r.dataTransfer.getData("text/plain")),e.next=4,(0,L.x8)(n,void 0);case 4:if(a=e.sent,o=a.item,s=a.typeClass,a.selfTarget,c=this.item.id==o.id,u=this.item.parent.id==n.actorId,!t.Z.equipmentCategories.includes(s)||c){e.next=22;break}if(o.system.parent_id=this.item.id,o.system.worn&&o.system.worn.value&&(o.system.worn.value=!1),!u){e.next=18;break}return e.next=16,this.item.actor.updateEmbeddedDocuments("Item",[o]);case 16:e.next=20;break;case 18:return e.next=20,this.item.actor.sheet._addLoot(o);case 20:return this.render(!0),e.abrupt("return");case 22:return e.next=24,Ht(Vt(i.prototype),"_onDrop",this).call(this,r);case 24:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),i}(Jt),tr=function(e){qt(a,e);var r,n=Ut(a);function a(){return Gt(this,a),n.apply(this,arguments)}return Bt(a,[{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:if(n=e.sent,mergeObject(n,{domains:this.prepareDomains(),armorSubcategories:Object.keys(t.Z.armorSubcategories),breakPointRating:t.Z.armorSubcategories[this.item.system.subcategory]}),e.t0=game.user.isGM,e.t0){e.next=9;break}return e.next=8,game.settings.get("dsa5","playerCanEditSpellMacro");case 8:e.t0=e.sent;case 9:return n.canOnUseEffect=e.t0,e.abrupt("return",n);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(a.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&r.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",At.Z.breakingTest(t.item));case 1:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}),r}}]),a}(Jt),rr=function(e){qt(n,e);var t,r=Ut(n);function n(){return Gt(this,n),r.apply(this,arguments)}return Bt(n,[{key:"getData",value:(t=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(n.prototype),"getData",this).call(this,t);case 2:return(r=e.sent).attributes=Object.keys(r.system.planttype).map((function(e){return{name:e,checked:r.system.planttype[e]}})),e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),n}(Kt),nr=function(e){qt(n,e);var t,r=Ut(n);function n(){return Gt(this,n),r.apply(this,arguments)}return Bt(n,[{key:"getData",value:(t=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(n.prototype),"getData",this).call(this,t);case 2:return(r=e.sent).patronCategories=[0,1,2,3].map((function(e){return{name:game.i18n.localize("PATRON.".concat(e)),val:e}})),r.priorities={0:game.i18n.localize("PATRON.primary"),1:game.i18n.localize("PATRON.secondary")},e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),n}(Kt),ar=function(e){qt(a,e);var t,r,n=Ut(a);function a(){return Gt(this,a),n.apply(this,arguments)}return Bt(a,[{key:"getData",value:(r=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,t);case 2:if((r=e.sent).categories={1:game.i18n.localize("magicalsign"),2:game.i18n.localize("additionalsign")},e.t0=game.user.isGM,e.t0){e.next=9;break}return e.next=8,game.settings.get("dsa5","playerCanEditSpellMacro");case 8:e.t0=e.sent;case 9:return r.canOnUseEffect=e.t0,e.abrupt("return",r);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(a.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&r.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(r){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setupEffect(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"setupEffect",value:(t=Ft(Rt().mark((function e(t){var r,n,a,o,i;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=Number(this.item.system.asp)||0,!(this.item.actor.system.status.astralenergy.value<r)){e.next=3;break}return e.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP")));case 3:n=this.item.actor,a=game.dsa5.config.ItemSubclasses.magicalsign,o=n.items.find((function(e){return"skill"==e.type&&e.name==game.i18n.localize("LocalizedIDs.artisticAbility")})),i="<hr/><p><b>".concat(this.item.name,"</b></p><p>").concat(this.item.system.description.value,"</p><p>").concat(a.chatData(this.item.system,"").join("</br>"),' <span class="costCheck"></span></p>'),n.setupSkill(o,{other:[i],subtitle:" (".concat(game.i18n.localize("magicalsign"),")")},void 0).then(function(){var e=Ft(Rt().mark((function e(t){var a;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.basicTest(t,{suppressMessage:!0});case 2:return(a=e.sent).result.preData.calculatedSpellModifiers={finalcost:r,costsMana:!0},e.next=6,jt.Z.renderRollCard(a.cardOptions,a.result,a.options.rerenderMessage);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),a}(Kt),or=function(r){qt(o,r);var n,a=Ut(o);function o(){return Gt(this,o),a.apply(this,arguments)}return Bt(o,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(o.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&r.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",At.Z.breakingTest(t.item));case 1:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}),r}},{key:"getData",value:(n=Ft(Rt().mark((function r(n){var a;return Rt().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Ht(Vt(o.prototype),"getData",this).call(this,n);case 2:if(a=r.sent,r.t0=game.user.isGM,r.t0){r.next=8;break}return r.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:r.t0=r.sent;case 8:return a.canOnUseEffect=r.t0,r.t1=mergeObject,r.t2=a,r.t3=t.Z.ammunitiongroups,r.next=14,e.Z.allCombatSkillsList("range");case 14:return r.t4=r.sent,r.t5=this.prepareDomains(),r.t6=t.Z.weaponStabilities[game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value))],r.t7={ammunitiongroups:r.t3,combatskills:r.t4,domains:r.t5,breakPointRating:r.t6},(0,r.t1)(r.t2,r.t7),r.abrupt("return",a);case 20:case"end":return r.stop()}}),r,this)}))),function(e){return n.apply(this,arguments)})}]),o}(Jt),ir=function(t){qt(o,t);var r,n,a=Ut(o);function o(){return Gt(this,o),a.apply(this,arguments)}return Bt(o,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(o.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&r.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(r){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setupEffect(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"getData",value:(n=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(o.prototype),"getData",this).call(this,t);case 2:if(r=e.sent,e.t0=game.user.isGM,e.t0){e.next=8;break}return e.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:e.t0=e.sent;case 8:return r.canOnUseEffect=e.t0,e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"setupEffect",value:(r=Ft(Rt().mark((function t(r){var n,a;return Rt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(this.item.actor.system.status.karmaenergy.value<1)){t.next=2;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughKaP")));case 2:return n=game.dsa5.config.ItemSubclasses.magictrick,t.next=5,this.item.actor.update({"system.status.karmaenergy.value":this.item.actor.system.status.karmaenergy.value-=1});case 5:return a="<p><b>".concat(this.item.name," - ").concat(game.i18n.localize("blessing")," ").concat(game.i18n.localize("probe"),"</b></p><p>").concat(this.item.system.description.value,"</p><p>").concat(n.chatData(this.item.system,"").join("</br>"),"</p>"),t.next=8,ChatMessage.create(e.Z.chatDataSetup(a));case 8:case"end":return t.stop()}}),t,this)}))),function(e){return r.apply(this,arguments)})}]),o}(Kt),sr=function(e){qt(a,e);var r,n=Ut(a);function a(e,t){var r;return Gt(this,a),t.width=700,t.height=700,(r=n.call(this,e,t)).mce=null,r}return Bt(a,[{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n,o;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:return n=e.sent,(o=duplicate(t.Z.characteristics))["-"]="-",n.mageLevels=t.Z.mageLevels,n.guidevalues=o,e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),a}(Kt),cr=function(e){qt(a,e);var r,n=Ut(a);function a(e,t){var r;return Gt(this,a),t.width=480,(r=n.call(this,e,t)).mce=null,r}return Bt(a,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(a.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&r.unshift({class:"consumeItem",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(r){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setupEffect(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:return(n=e.sent).calculatedPrice=n.system.price.value*n.system.QL||0,n.availableSteps=n.system.QLList.split("\n").map((function(e,t){return t+1})),n.equipmentTypes=t.Z.equipmentTypes,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setupEffect",value:function(e){this.item.setupEffect()}}]),a}(Kt),ur=function(e){qt(r,e);var t=Ut(r);function r(e,n){var a;return Gt(this,r),n.width=700,n.height=700,(a=t.call(this,e,n)).mce=null,a}return Bt(r)}(Kt),lr=function(e){qt(a,e);var r,n=Ut(a);function a(){return Gt(this,a),n.apply(this,arguments)}return Bt(a,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(a.prototype),"_getHeaderButtons",this).call(this);return r.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(r){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setupEffect(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:return(n=e.sent).resistances=t.Z.magicResistanceModifiers,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),a}(Kt),fr=function(t){qt(o,t);var r,n,a=Ut(o);function o(){return Gt(this,o),a.apply(this,arguments)}return Bt(o,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(o.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&r.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(r){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setupEffect(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"getData",value:(n=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(o.prototype),"getData",this).call(this,t);case 2:if(r=e.sent,e.t0=game.user.isGM,e.t0){e.next=8;break}return e.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:e.t0=e.sent;case 8:return r.canOnUseEffect=e.t0,e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"setupEffect",value:(r=Ft(Rt().mark((function t(r){var n,a;return Rt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(this.item.actor.system.status.astralenergy.value<1)){t.next=2;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP")));case 2:return n=game.dsa5.config.ItemSubclasses.magictrick,t.next=5,this.item.actor.update({"system.status.astralenergy.value":this.item.actor.system.status.astralenergy.value-=1});case 5:return a="<p><b>".concat(this.item.name," - ").concat(game.i18n.localize("magictrick")," ").concat(game.i18n.localize("probe"),"</b></p><p>").concat(this.item.system.description.value,"</p><p>").concat(n.chatData(this.item.system,"").join("</br>"),"</p>"),t.next=8,ChatMessage.create(e.Z.chatDataSetup(a));case 8:case"end":return t.stop()}}),t,this)}))),function(e){return r.apply(this,arguments)})}]),o}(Kt),pr=function(r){qt(o,r);var n,a=Ut(o);function o(e,t){var r;return Gt(this,o),(r=a.call(this,e,t)).mce=null,r.isPoisonable=!0,r}return Bt(o,[{key:"getData",value:(n=Ft(Rt().mark((function r(n){var a,i,s,c,u,l,f,p=this;return Rt().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Ht(Vt(o.prototype),"getData",this).call(this,n);case 2:if(a=r.sent,i=mergeObject(duplicate(t.Z.characteristics),It({"ge/kk":game.i18n.localize("CHAR.GEKK")},"-","-")),s=P.Z.regex2h.test(this.item.name),c="",s){r.next=10;break}c="wrongGrip.yieldTwo",r.next=18;break;case 10:u=game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value)),r.t0=u,r.next="Two-Handed Impact Weapons"===r.t0||"Two-Handed Swords"===r.t0?14:17;break;case 14:return l=new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")),c=l.test(this.item.name)?"wrongGrip.yieldOneBastard":"wrongGrip.yieldOneSwordBlunt",r.abrupt("break",18);case 17:c="wrongGrip.yieldOnePolearms";case 18:return r.t1=mergeObject,r.t2=a,r.t3=i,r.t4=s,r.t5=s?"wrongGrip.oneHanded":"wrongGrip.twoHanded",r.t6=c,r.next=26,e.Z.allCombatSkillsList("melee");case 26:if(r.t7=r.sent,r.t8=t.Z.meleeRanges,r.t9=t.Z.shieldSizes,r.t10=this.item.system.combatskill.value==game.i18n.localize("LocalizedIDs.Shields"),r.t11=this.prepareDomains(),r.t12=t.Z.weaponStabilities[game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value))],r.t13={characteristics:r.t3,twoHanded:r.t4,wrongGripLabel:r.t5,wrongGripHint:r.t6,combatskills:r.t7,ranges:r.t8,shieldSizes:r.t9,isShield:r.t10,domains:r.t11,breakPointRating:r.t12},(0,r.t1)(r.t2,r.t13),this.item.actor&&(f=this.item.actor.items.find((function(e){return"combatskill"==e.type&&e.name==p.item.system.combatskill.value})),a.canBeOffHand=f&&!f.system.weapontype.twoHanded&&this.item.system.worn.value,a.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize("LocalizedCTs.".concat(this.item.system.combatskill.value)))),r.t14=game.user.isGM,r.t14){r.next=40;break}return r.next=39,game.settings.get("dsa5","playerCanEditSpellMacro");case 39:r.t14=r.sent;case 40:return a.canOnUseEffect=r.t14,r.abrupt("return",a);case 42:case"end":return r.stop()}}),r,this)}))),function(e){return n.apply(this,arguments)})},{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(o.prototype),"_getHeaderButtons",this).call(this);return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&r.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",At.Z.breakingTest(t.item));case 1:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}),r}}]),o}(Jt),dr=function(e){qt(a,e);var r,n=Ut(a);function a(){return Gt(this,a),n.apply(this,arguments)}return Bt(a,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ht(Vt(a.prototype),"_getHeaderButtons",this).call(this);return r.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:(e=Ft(Rt().mark((function e(r){return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setupEffect(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(a.prototype),"getData",this).call(this,r);case 2:return(n=e.sent).resistances=t.Z.magicResistanceModifiers,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),a}(Kt),hr=function(e){qt(s,e);var r,n,o,i=Ut(s);function s(){return Gt(this,s),i.apply(this,arguments)}return Bt(s,[{key:"_refundStep",value:(o=Ft(Rt().mark((function e(){var t,r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.item.system.step.value>1)){e.next=10;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(e){return Number(e.trim())})),t=r[this.item.system.step.value-1]),e.next=5,a.Z.refundFreelanguage(this.item.data,this.item.actor,t);case 5:return t=e.sent,e.next=8,this.item.actor._updateAPs(-1*t);case 8:return e.next=10,this.item.update({"system.step.value":this.item.system.step.value-1});case 10:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"_advanceStep",value:(n=Ft(Rt().mark((function e(){var t,r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.item.system.step.value<this.item.system.maxRank.value)){e.next=13;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(e){return Number(e.trim())})),t=r[this.item.system.step.value]),e.next=5,a.Z.isFreeLanguage(this.item.data,this.item.actor,t);case 5:return t=e.sent,e.next=8,this.item.actor.checkEnoughXP(t);case 8:if(!e.sent){e.next=13;break}return e.next=11,this.item.actor._updateAPs(t);case 11:return e.next=13,this.item.update({"system.step.value":this.item.system.step.value+1});case 13:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"_advancable",value:function(){return this.item.system.maxRank.value>0}},{key:"getData",value:(r=Ft(Rt().mark((function e(r){var n;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(s.prototype),"getData",this).call(this,r);case 2:if((n=e.sent).categories=t.Z.specialAbilityCategories,n.subCategories=t.Z.combatSkillSubCategories,e.t0=game.user.isGM,e.t0){e.next=10;break}return e.next=9,game.settings.get("dsa5","playerCanEditSpellMacro");case 9:e.t0=e.sent;case 10:return n.canOnUseEffect=e.t0,e.abrupt("return",n);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),s}(Kt),mr=function(e){qt(n,e);var t,r=Ut(n);function n(e,t){var a;return Gt(this,n),t.width=530,t.height=570,(a=r.call(this,e,t)).mce=null,a}return Bt(n,[{key:"getData",value:(t=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(n.prototype),"getData",this).call(this,t);case 2:return(r=e.sent).hasLocalization=game.i18n.has("Racedescr.".concat(this.item.name)),e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),n}(Kt),yr=function(e){qt(o,e);var r,n,a=Ut(o);function o(){return Gt(this,o),a.apply(this,arguments)}return Bt(o,[{key:"getData",value:(n=Ft(Rt().mark((function e(r){var n,a=this;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(o.prototype),"getData",this).call(this,r);case 2:return(n=e.sent).characteristics=t.Z.characteristics,n.StFs=t.Z.StFs,n.resistances=t.Z.magicResistanceModifiers,n.isOwned&&(n.extensions=this.item.actor.items.filter((function(e){return"spellextension"==e.type&&e.system.source==a.item.name&&a.item.type==e.system.category}))),e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;Ht(Vt(o.prototype),"activateListeners",this).call(this,e),e.find(".item-edit").click((function(e){e.preventDefault();var r=t._getItemId(e);t.item.actor.items.get(r).sheet.render(!0)})),e.find(".item-delete").click((function(e){t._deleteItem(e)}))}},{key:"_deleteItem",value:function(e){var t=this,r=this._getItemId(e),n=this.actor.items.find((function(e){return e.id==r})),a=game.i18n.format("DIALOG.DeleteItemDetail",{item:n.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:a}).then((function(n){new Dialog({title:game.i18n.localize("Delete Confirmation"),content:n,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){t._cleverDeleteItem(r),$(e.currentTarget).closest(".item").remove()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}))}},{key:"_cleverDeleteItem",value:(r=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.item.actor.items.find((function(e){return e.id==t})),e.next=3,this.item.actor._updateAPs(-1*r.system.APValue.value);case 3:return e.next=5,this.item.actor.deleteEmbeddedDocuments("Item",[t]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),o}(Kt),vr=function(e){qt(n,e);var t,r=Ut(n);function n(){return Gt(this,n),r.apply(this,arguments)}return Bt(n,[{key:"getData",value:(t=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(n.prototype),"getData",this).call(this,t);case 2:return r=e.sent,mergeObject(r,{categories:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}),e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),n}(Kt),gr=function(e){qt(o,e);var t,r,n,a=Ut(o);function o(){return Gt(this,o),a.apply(this,arguments)}return Bt(o,[{key:"_advancable",value:function(){return this.item.system.max.value>0}},{key:"_refundStep",value:(n=Ft(Rt().mark((function e(){var t,r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.item.system.step.value>1)){e.next=7;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(e){return Number(e.trim())})),t=r[this.item.system.step.value-1]),e.next=5,this.item.actor._updateAPs(-1*t);case 5:return e.next=7,this.item.update({"system.step.value":this.item.system.step.value-1});case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getData",value:(r=Ft(Rt().mark((function e(t){var r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ht(Vt(o.prototype),"getData",this).call(this,t);case 2:if(r=e.sent,e.t0=game.user.isGM,e.t0){e.next=8;break}return e.next=7,game.settings.get("dsa5","playerCanEditSpellMacro");case 7:e.t0=e.sent;case 8:return r.canOnUseEffect=e.t0,e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"_advanceStep",value:(t=Ft(Rt().mark((function e(){var t,r;return Rt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.item.system.step.value<this.item.system.max.value)){e.next=10;break}return t=this.item.system.APValue.value,/;/.test(t)&&(r=t.split(";").map((function(e){return Number(e.trim())})),t=r[this.item.system.step.value]),e.next=5,this.item.actor.checkEnoughXP(t);case 5:if(!e.sent){e.next=10;break}return e.next=8,this.item.actor._updateAPs(t);case 8:return e.next=10,this.item.update({"system.step.value":this.item.system.step.value+1});case 10:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),o}(Kt);function br(e){return br="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},br(e)}function wr(){wr=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==br(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function kr(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function xr(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){kr(o,n,a,i,s,"next",e)}function s(e){kr(o,n,a,i,s,"throw",e)}i(void 0)}))}}function _r(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Or(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Or(e,t){if(e){if("string"==typeof e)return Er(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Er(e,t):void 0}}function Er(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Sr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Lr(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Tr(e,t,r){return t&&Lr(e.prototype,t),r&&Lr(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Dr(){return Dr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Pr(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Dr.apply(this,arguments)}function Pr(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Mr(e)););return e}function Ar(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&jr(e,t)}function jr(e,t){return jr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},jr(e,t)}function Cr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Mr(e);if(t){var a=Mr(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Ir(this,r)}}function Ir(e,t){if(t&&("object"===br(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Mr(e){return Mr=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Mr(e)}var Nr,Rr,zr,Fr=function(t){Ar(o,Application);var r,n,a=Cr(o);function o(){return Sr(this,o),a.apply(this,arguments)}return Tr(o,[{key:"initConfigs",value:function(){var e,t,r=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(var n=0,a=Object.entries(r);n<a.length;n++){var i=(e=a[n],t=2,function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(e,t)||Or(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),s=(i[0],i[1]);mergeObject(this.choices,s)}var c={damage:"black"};game.settings.registerMenu("dsa5","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("DSASETTINGS.dicesonicesettings"),type:Gr,restricted:!1});var u,l=_r(o.attrs);try{for(l.s();!(u=l.n()).done;){var f=u.value;game.settings.register("dsa5","dice3d_".concat(f),{name:"CHAR.".concat(f.toUpperCase()),scope:"client",config:!1,default:c[f]||f,type:String}),game.settings.register("dsa5","dice3d_system_".concat(f),{name:"CHAR.".concat(f.toUpperCase()),scope:"client",config:!1,default:"standard",type:String})}}catch(e){l.e(e)}finally{l.f()}}},{key:"getAttributeConfiguration",value:function(t){return e.Z.moduleEnabled("dice-so-nice")?{colorset:game.settings.get("dsa5","dice3d_".concat(t)),appearance:{colorset:game.settings.get("dsa5","dice3d_".concat(t)),system:game.settings.get("dsa5","dice3d_system_".concat(t))}}:{colorset:t}}},{key:"activateListeners",value:function(e){Dr(Mr(o.prototype),"activateListeners",this).call(this),e.find('[name="entryselection"]').change(function(){var e=xr(wr().mark((function e(t){return wr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.settings.set("dsa5","dice3d_".concat(t.currentTarget.dataset.attr),t.currentTarget.value);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find('[name="systemselection"]').change(function(){var e=xr(wr().mark((function e(t){return wr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.settings.set("dsa5","dice3d_system_".concat(t.currentTarget.dataset.attr),t.currentTarget.value);case 2:o.preloadDiceAssets([t.currentTarget.value]),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:{toPreload:[t.currentTarget.value]}});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}},{key:"getData",value:(n=xr(wr().mark((function e(t){var r,n,a,i;return wr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Dr(Mr(o.prototype),"getData",this).call(this,t);case 2:(r=e.sent).choices=this.choices,r.systems=game.dice3d.DiceFactory.systems,r.selections={},n=_r(o.attrs);try{for(n.s();!(a=n.n()).done;)i=a.value,r.selections[i]={color:game.settings.get("dsa5","dice3d_".concat(i)),system:game.settings.get("dsa5","dice3d_system_".concat(i))}}catch(e){n.e(e)}finally{n.f()}return e.abrupt("return",r);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})}],[{key:"onConnect",value:function(){game.socket.on("system.dsa5",(function(e){switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSA dice assets"),o.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":o.requestDicePreloads()}})),this.collectPreloads(),game.socket.emit("system.dsa5",{type:"getPreloadDice3d"})}},{key:"collectPreloads",value:function(){var e,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r=new Set,n=_r(o.attrs);try{for(n.s();!(e=n.n()).done;){var a=e.value;r.add(game.settings.get("dsa5","dice3d_system_".concat(a)))}}catch(e){n.e(e)}finally{n.f()}r=Array.from(r),t&&this.preloadDiceAssets(r),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:r})}},{key:"requestDicePreloads",value:function(){this.collectPreloads(!1)}},{key:"preloadDiceAssets",value:(r=xr(wr().mark((function e(t){var r,n,a,o,i,s,c,u,l,f=arguments;return wr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=f.length>1&&void 0!==f[1]?f[1]:[],console.warn("loading",t),n=_r(t),e.prev=3,n.s();case 5:if((a=n.n()).done){e.next=41;break}if(o=a.value,i=game.dice3d.DiceFactory.systems[o]){e.next=10;break}return e.abrupt("continue",39);case 10:s=i.dice.filter((function(e){return 0==r.length||r.includes(e.type)})),c=_r(s),e.prev=12,c.s();case 14:if((u=c.n()).done){e.next=31;break}if(l=u.value,e.prev=16,!l.modelFile){e.next=22;break}return e.next=20,l.loadModel(game.dice3d.DiceFactory.loaderGLTF);case 20:e.next=24;break;case 22:return e.next=24,l.loadTextures();case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(16),console.warn("Unable to load dice model",o,l);case 29:e.next=14;break;case 31:e.next=36;break;case 33:e.prev=33,e.t1=e.catch(12),c.e(e.t1);case 36:return e.prev=36,c.f(),e.finish(36);case 39:e.next=5;break;case 41:e.next=46;break;case 43:e.prev=43,e.t2=e.catch(3),n.e(e.t2);case 46:return e.prev=46,n.f(),e.finish(46);case 49:case"end":return e.stop()}}),e,null,[[3,43,46,49],[12,33,36,39],[16,26]])}))),function(e){return r.apply(this,arguments)})},{key:"defaultOptions",get:function(){var e=Dr(Mr(o),"defaultOptions",this);return mergeObject(e,{template:"systems/dsa5/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("DSASETTINGS.dicesonicesettings"),width:600}),e}}]),o}();zr=["mu","kl","in","ch","ff","ge","ko","kk","attack","dodge","parry","damage"],(Rr="attrs")in(Nr=Fr)?Object.defineProperty(Nr,Rr,{value:zr,enumerable:!0,configurable:!0,writable:!0}):Nr[Rr]=zr;var Gr=function(e){Ar(r,FormApplication);var t=Cr(r);function r(){return Sr(this,r),t.apply(this,arguments)}return Tr(r,[{key:"render",value:function(){game.dsa5.apps.DiceSoNiceCustomization.render(!0)}}]),r}(),Zr=__webpack_require__(61);function Br(e){return Br="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Br(e)}function Hr(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Wr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Wr(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Wr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function qr(){qr=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Br(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function $r(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ur(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){$r(o,n,a,i,s,"next",e)}function s(e){$r(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Yr(e){return Yr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Yr(e)}function Vr(){Vr=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Yr(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Kr(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Jr(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Kr(o,n,a,i,s,"next",e)}function s(e){Kr(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Qr(e,t,r,n){return Xr.apply(this,arguments)}function Xr(){return(Xr=Jr(Vr().mark((function e(t,r,n,a){var o;return Vr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=game.macros.contents.find((function(e){return e.name===r&&e.command===t}))){e.next=5;break}return e.next=4,Macro.create({name:r,type:"script",img:n,command:t},{displaySheet:!1});case 4:o=e.sent;case 5:game.user.assignHotbarMacro(o,a);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var en=__webpack_require__(600);function tn(e){return tn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tn(e)}function rn(){rn=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==tn(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function nn(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function an(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function on(e,t){if(e){if("string"==typeof e)return sn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?sn(e,t):void 0}}function sn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function cn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var un=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}var r,n,a,o;return r=t,null,n=[{key:"payMoney",value:function(r,n){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=t.canPay(r,n,a);return o.success&&t._updateMoney(r,o.actorsMoney.money,o.actorsMoney.sum-o.money),a||""==o.msg||ChatMessage.create(e.Z.chatDataSetup("<p>".concat(o.msg,"</p>"),"roll")),o.success}},{key:"canPay",value:function(e,r,n){var a=this._getPaymoney(r),o={success:!1,msg:"",money:a};return a&&(o.actorsMoney=this._actorsMoney(e),o.actorsMoney.sum>=a?(o.msg=game.i18n.format("PAYMENT.pay",{actor:e.name,amount:t._moneyToString(a)}),o.success=!0):(o.msg=game.i18n.format("PAYMENT.cannotpay",{actor:e.name,amount:t._moneyToString(a)}),n&&ui.notifications.notify(o.msg))),o}},{key:"getMoney",value:function(r,n){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=this._getPaidmoney(n);if(o){var i=this._actorsMoney(r);t._updateMoney(r,i.money,i.sum+o);var s="<p>".concat(game.i18n.format("PAYMENT.getPaid",{actor:r.name,amount:t._moneyToString(o)}),"</p>");return a||ChatMessage.create(e.Z.chatDataSetup(s,"roll")),!0}}},{key:"_updateMoney",value:function(e,r,n){var a,o=t._moneyToCoins(n),i=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=on(e))){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}(r);try{for(i.s();!(a=i.n()).done;){var s=a.value;switch(s.name){case"Money-D":s.system.quantity.value=o.D;break;case"Money-S":s.system.quantity.value=o.S;break;case"Money-H":s.system.quantity.value=o.H;break;case"Money-K":s.system.quantity.value=o.K}}}catch(e){i.e(e)}finally{i.f()}e.updateEmbeddedDocuments("Item",r)}},{key:"createGetPaidChatMessage",value:function(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,a=this._getPaidmoney(r);if(a){var o=n?" (".concat(n,")"):"",i="<p><b>".concat(game.i18n.localize("PAYMENT.wage"),"</b></p><p>").concat(game.i18n.format("PAYMENT.getPaidSum",{amount:t._moneyToString(a)})).concat(o,'</p><button class="payButton" data-pay="1" data-amount="').concat(a,'">').concat(game.i18n.localize("PAYMENT.getPaidButton"),"</button>");ChatMessage.create(e.Z.chatDataSetup(i,"roll"))}}},{key:"createPayChatMessage",value:function(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,a=this._getPaymoney(r);if(a){var o=n?" (".concat(n,")"):"",i="<p><b>".concat(game.i18n.localize("PAYMENT.bill"),"</b></p>").concat(game.i18n.format("PAYMENT.paySum",{amount:t._moneyToString(a)})).concat(o,'</p><button class="payButton" data-pay="0" data-amount="').concat(a,'">').concat(game.i18n.localize("PAYMENT.payButton"),"</button>");ChatMessage.create(e.Z.chatDataSetup(i,"roll"))}}},{key:"_getPaidmoney",value:function(t){var r=this._parseMoneyString(t);if(!r){var n="<p><b>".concat(game.i18n.localize("PAYMENT.error"),"</b></p><p><i>").concat(game.i18n.localize("PAYMENT.getPaidexample"),"</i></p>");return ChatMessage.create(e.Z.chatDataSetup(n,"roll")),!1}return r}},{key:"_getPaymoney",value:function(t){var r=this._parseMoneyString(t);if(!r){var n="<p><b>".concat(game.i18n.localize("PAYMENT.error"),"</b></p><p><i>").concat(game.i18n.localize("PAYMENT.payexample"),"</i></p>");return ChatMessage.create(e.Z.chatDataSetup(n,"roll")),!1}return r}},{key:"_parseMoneyString",value:function(e){var t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return!!t&&Number(t[0])}},{key:"_actorsMoney",value:function(e){var t=duplicate(e.items.filter((function(e){return"money"==e.type})));return{money:t,sum:t.reduce((function(e,t){return e+Number(t.system.quantity.value)*Number(t.system.price.value)}),0)}}},{key:"handlePayAction",value:function(e,r,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;if(!game.user.isGM||a){a?D.Z.playMoneySound(!0):a=game.user.character;var o=!1;a&&r?o=t.payMoney(a,n):a&&!r?o=t.getMoney(a,n):ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors")),o&&e&&(e.fadeOut(),game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:an({},"flags.dsa5.userHidden.".concat(game.user.id),!0)}}))}else ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors"))}},{key:"_moneyToCoins",value:function(e){var t=Math.round(100*e),r=Math.floor(t/1e3),n=Math.floor((t-1e3*r)/100),a=Math.floor((t-1e3*r-100*n)/10);return{D:r,S:n,H:a,K:Math.round(t-1e3*r-100*n-10*a)}}},{key:"_moneyToString",value:function(e){for(var r=t._moneyToCoins(e),n=[],a=0,o=Object.entries(r);a<o.length;a++){var i=(u=o[a],l=2,function(e){if(Array.isArray(e))return e}(u)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(u,l)||on(u,l)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),s=i[0],c=i[1];c>0&&n.push('<span class="nobr">'.concat(c,' <span data-tooltip="').concat(game.i18n.localize("Money-".concat(s)),'" class="chatmoney money-').concat(s,'"></span></span>'))}var u,l;return n.join(", ")}},{key:"chatListeners",value:(a=rn().mark((function e(r){return rn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.on("click",".payButton",(function(e){var r=$(e.currentTarget);t.handlePayAction(r,1!=Number(r.attr("data-pay")),r.attr("data-amount")),D.Z.playMoneySound()}));case 1:case"end":return e.stop()}}),e)})),o=function(){var e=this,t=arguments;return new Promise((function(r,n){var o=a.apply(e,t);function i(e){nn(o,r,n,i,s,"next",e)}function s(e){nn(o,r,n,i,s,"throw",e)}i(void 0)}))},function(e){return o.apply(this,arguments)})}],n&&cn(r,n),Object.defineProperty(r,"prototype",{writable:!1}),t}(),ln=__webpack_require__(118);function fn(e){return fn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},fn(e)}function pn(){pn=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==fn(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function dn(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function hn(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){dn(o,n,a,i,s,"next",e)}function s(e){dn(o,n,a,i,s,"throw",e)}i(void 0)}))}}function mn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var yn=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}var r,n,a,o,i;return r=t,null,n=[{key:"firstTimeMessage",value:(i=hn(pn().mark((function r(){var n;return pn().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,game.settings.get("dsa5","firstTimeStart");case 2:if(r.sent){r.next=10;break}return r.next=5,t.setupDefaultOptions();case 5:return n=game.i18n.localize("WELCOME"),ChatMessage.create(e.Z.chatDataSetup(n)),t.firstTimeLanguage(),r.next=10,game.settings.set("dsa5","firstTimeStart",!0);case 10:case"end":return r.stop()}}),r)}))),function(){return i.apply(this,arguments)})},{key:"firstTimeLanguage",value:function(){for(var e={title:game.i18n.localize("DIALOG.firstTime"),content:game.i18n.localize("DIALOG.firstTimeWarning"),default:"de",buttons:{}},r=function(){var r=a[n];e.buttons[r]={label:game.i18n.localize(r),callback:function(){return t.setLanguage(r)}}},n=0,a=["de","en"];n<a.length;n++)r();new Dialog(e).render(!0)}},{key:"setLanguage",value:(o=hn(pn().mark((function e(t){return pn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.settings.set("dsa5","firstTimeStart",!0);case 2:return e.next=4,game.settings.set("dsa5","forceLanguage",t);case 4:return e.next=6,game.settings.set("core","language",t);case 6:case"end":return e.stop()}}),e)}))),function(e){return o.apply(this,arguments)})},{key:"setupDefaultOptions",value:(a=hn(pn().mark((function e(){var t;return pn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(t=game.settings.get("core",Combat.CONFIG_SETTING)).skipDefeated=!0,e.next=4,game.settings.set("core",Combat.CONFIG_SETTING,t);case 4:return e.next=6,game.settings.set("core","leftClickRelease",!0);case 6:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})}],n&&mn(r,n),Object.defineProperty(r,"prototype",{writable:!1}),t}();function vn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(e,t)||kn(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function gn(e){return gn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},gn(e)}function bn(){bn=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==gn(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function wn(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=kn(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function kn(e,t){if(e){if("string"==typeof e)return xn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?xn(e,t):void 0}}function xn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _n(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function On(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){_n(o,n,a,i,s,"next",e)}function s(e){_n(o,n,a,i,s,"throw",e)}i(void 0)}))}}function En(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Sn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ln(){return Ln="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Tn(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Ln.apply(this,arguments)}function Tn(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=An(e)););return e}function Dn(e,t){return Dn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Dn(e,t)}function Pn(e,t){if(t&&("object"===gn(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function An(e){return An=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},An(e)}var jn=function(r){return function(r){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Dn(e,t)}(C,r);var a,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E,S,L,T,A,j=(T=C,A=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=An(T);if(A){var r=An(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return Pn(this,e)});function C(){return En(this,C),j.apply(this,arguments)}return a=C,o=[{key:"template",get:function(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsa5/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsa5/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsa5/templates/actors/merchant/merchant-epic.html";default:return Ln(An(C.prototype),"template",this)}return this.constructor.merchantTemplate}},{key:"merchantSheetActivated",value:function(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}},{key:"allowMerchant",value:(L=On(bn().mark((function e(t,r){var n,a,o,i,s;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=duplicate(this.actor.ownership),a=r?1:0,o=wn(t);try{for(o.s();!(i=o.n()).done;)s=i.value,n[s]=a}catch(e){o.e(e)}finally{o.f()}return e.next=6,this.actor.update({ownership:n},{diff:!1,recursive:!1,noHook:!0});case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return L.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;if(Ln(An(C.prototype),"activateListeners",this).call(this,e),e.find(".allowMerchant").click(function(){var e=On(bn().mark((function e(r){var n,a;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=$(r.currentTarget).attr("data-user-id"),a=$(r.currentTarget).find("i"),e.next=4,t.allowMerchant([n],!a.hasClass("fa-check-circle"));case 4:a.toggleClass("fa-circle fa-check-circle");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".toggleAllAllowMerchant").click(function(){var e=On(bn().mark((function e(r){var n,a;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=game.users.filter((function(e){return!e.isGM})).map((function(e){return e.id})),a="true"==r.currentTarget.dataset.lock,e.next=4,t.allowMerchant(n,a);case 4:t.render();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".lockTradeSection").click((function(e){return t.lockTradeSection(e)})),e.find(".item-tradeLock").click((function(e){return t.toggleTradeLock(e)})),e.find(".randomGoods").click((function(e){return t.randomGoods(e)})),e.find(".clearInventory").click((function(e){return t.clearInventory(e)})),e.find(".removeOtherTradeFriend").click((function(e){return t.removeOtherTradeFriend()})),e.find(".setCustomPrice").click((function(e){return $(e.currentTarget).addClass("edit")})),e.find(".customPriceTag").change(function(){var e=On(bn().mark((function e(r){return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.setCustomPrice(r));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).blur((function(e){return $(e.currentTarget).closest(".setCustomPrice").removeClass("edit")})),e.find(".buy-item").click((function(e){t.advanceWrapper(e,"buyItem",e),D.Z.playMoneySound()})),e.find(".sell-item").click((function(e){t.advanceWrapper(e,"sellItem",e),D.Z.playMoneySound()})),e.find(".item-external-edit").click((function(e){e.preventDefault();var r=t._getItemId(e);t.getTradeFriend().items.get(r).sheet.render(!0)})),e.find(".changeAmountAllItems").mousedown((function(e){return t.changeAmountAllItems(e)})),this.showLimited()){var r=e.find(".content .item");r.each((function(e,t){return t.setAttribute("draggable",!1)})),r.on("dragstart",null)}e.find(".gearSearch").prop("disabled",!1)}},{key:"toggleTradeLock",value:(S=On(bn().mark((function e(t){var r,n;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._getItemId(t),n=this.actor.items.get(r),this.actor.updateEmbeddedDocuments("Item",[{_id:n.id,"system.tradeLocked":!n.system.tradeLocked}]);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"setCustomPrice",value:(E=On(bn().mark((function e(t){var r;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.stopPropagation(),t.preventDefault(),r=this._getItemId(t),e.next=5,this.actor.updateEmbeddedDocuments("Item",[{_id:r,"flags.dsa5.customPriceTag":Number(t.target.value)}]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"removeOtherTradeFriend",value:function(){this.otherTradeFriend=void 0,this.render(!0)}},{key:"lockTradeSection",value:(O=On(bn().mark((function e(t){var r,n,a,o,i,s,c;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],n=this.filterRule(t),o=wn(this.actor.items);try{for(o.s();!(i=o.n()).done;)s=i.value,n(s)&&(c=s.toObject(),void 0===a&&(a=!c.system.tradeLocked),c.system.tradeLocked=a,r.push(c))}catch(e){o.e(e)}finally{o.f()}this.actor.updateEmbeddedDocuments("Item",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"filterRule",value:function(e){var r=e.currentTarget.dataset.type;return t.Z.equipmentTypes[r]?function(e){return"equipment"==e.type&&e.system.equipmentType.value==r}:function(e){return e.type==r&&t.Z.equipmentCategories.includes(e.type)}}},{key:"changeAmountAllItems",value:(_=On(bn().mark((function e(t){var r,n,a,o,i,s;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],n=this.filterRule(t),a=wn(this.actor.items);try{for(a.s();!(o=a.n()).done;)i=o.value,n(i)&&(s=i.toObject(),P.Z.increment(t,s,"system.quantity.value",0),r.push(s))}catch(e){a.e(e)}finally{a.f()}this.actor.updateEmbeddedDocuments("Item",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"playerViewEnabled",value:function(){return getProperty(this.actor.system,"merchant.playerView")}},{key:"buyItem",value:(x=On(bn().mark((function e(t){return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transferItem(this.actor,this.getTradeFriend(),t,!0);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"sellItem",value:(k=On(bn().mark((function e(t){return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transferItem(this.getTradeFriend(),this.actor,t,!1);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"transferItem",value:(w=On(bn().mark((function e(t,r,n){var a,o,i,s,c=arguments;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=!(c.length>3&&void 0!==c[3])||c[3],o=this._getItemId(n),i=$(n.currentTarget).attr("data-price"),s=n.ctrlKey?10:1,!game.user.isGM){e.next=9;break}return e.next=7,this.constructor.finishTransaction(t,r,i,o,a,s);case 7:e.next=10;break;case 9:(this.constructor.noNeedToPay(r,t,i)||un.canPay(r,i,!0))&&game.socket.emit("system.dsa5",{type:"trade",payload:{target:this.constructor.transferTokenData(r),source:this.constructor.transferTokenData(t),price:i,itemId:o,buy:a,amount:s}});case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return w.apply(this,arguments)})},{key:"getTradeFriend",value:function(){return this.otherTradeFriend||game.user.character}},{key:"_manageDragItems",value:(b=On(bn().mark((function e(t,r){return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r,e.next="creature"===e.t0||"npc"===e.t0||"character"===e.t0?3:5;break;case 3:return this.setTradeFriend(t),e.abrupt("break",6);case 5:return e.abrupt("return",Ln(An(C.prototype),"_manageDragItems",this).call(this,t,r));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"setTradeFriend",value:function(e){var t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}},{key:"_render",value:(g=On(bn().mark((function e(){var t,r,n=arguments;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.length>0&&void 0!==n[0]&&n[0],r=n.length>1&&void 0!==n[1]?n[1]:{},game.user.isGM||"loot"!=getProperty(this.actor.system,"merchant.merchantType")||!getProperty(this.actor.system,"merchant.locked")){e.next=5;break}return AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1),e.abrupt("return");case 5:return e.next=7,Ln(An(C.prototype),"_render",this).call(this,t,r);case 7:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"_getHeaderButtons",value:function(){var e,t=this,r=Ln(An(C.prototype),"_getHeaderButtons",this).call(this);return this.actor.isOwner&&r.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:(e=On(bn().mark((function e(r){return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t._togglePlayerview(r));case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"_togglePlayerview",value:function(e){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}},{key:"randomGoods",value:(v=On(bn().mark((function e(r){var n,a=this;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,renderTemplate("systems/dsa5/templates/dialog/randomGoods-dialog.html",{categories:t.Z.equipmentCategories});case 2:n=e.sent,new Dialog({title:game.i18n.localize("MERCHANT.randomGoods"),content:n,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(e){return a.addRandomGoods(a.actor,e,r)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 4:case"end":return e.stop()}}),e)}))),function(e){return v.apply(this,arguments)})},{key:"clearInventory",value:(y=On(bn().mark((function e(t){var r=this;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:new Dialog({title:game.i18n.localize("MERCHANT.clearInventory"),content:game.i18n.localize("MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){r.removeAllGoods(r.actor,t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 1:case"end":return e.stop()}}),e)}))),function(e){return y.apply(this,arguments)})},{key:"addRandomGoods",value:(m=On(bn().mark((function e(t,r,n){var a,o,i,s,c,u,l,f;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=$(n.currentTarget).text(),$(n.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>'),o=[],r.find('input[type="checkbox"]:checked').each((function(){var e=$(this).val();o.push({name:e,count:Number(r.find('input[name="each_'.concat(e,'"]')).val()),number:Number(r.find('input[name="number_'.concat(e,'"]')).val())})})),(i=game.dsa5.itemLibrary).equipmentBuild){e.next=8;break}return e.next=8,i.buildEquipmentIndex();case 8:s=[],c=bn().mark((function e(){var t,r,n;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l[u],e.next=3,i.getRandomItems(r.name,r.number);case 3:n=e.sent.map((function(e){var t=e.toObject();return t.system.quantity.value=r.count,t})),(t=s).push.apply(t,function(e){if(Array.isArray(e))return xn(e)}(a=n)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||kn(a)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());case 5:case"end":return e.stop()}var a}),e)})),u=0,l=o;case 11:if(!(u<l.length)){e.next=16;break}return e.delegateYield(c(),"t0",13);case 13:u++,e.next=11;break;case 16:return f={},s=s.filter((function(e){var r=getProperty(e,"system.effect");r="object"===gn(r)&&null!==r&&getProperty(r,"attributes")||"";var n=Number(getProperty(e,"system.price.value"))||0;if(""!=r||n>1e4)return!1;var a="".concat(e.type,"_").concat(e.name);return!f.hasOwnProperty(a)&&(f[a]=!0)&&0==t.items.filter((function(t){return t.type==e.type&&t.name==e.name})).length})),e.next=20,t.createEmbeddedDocuments("Item",s);case 20:$(n.currentTarget).text(a);case 21:case"end":return e.stop()}}),e)}))),function(e,t,r){return m.apply(this,arguments)})},{key:"removeAllGoods",value:(h=On(bn().mark((function e(r,n){var a,o;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=$(n.currentTarget).text(),$(n.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>'),o=r.items.filter((function(e){return t.Z.equipmentCategories.includes(e.type)&&!getProperty(e,"worn.value")})).map((function(e){return e.id})),e.next=5,r.deleteEmbeddedDocuments("Item",o);case 5:$(n.currentTarget).text(a);case 6:case"end":return e.stop()}}),e)}))),function(e,t){return h.apply(this,arguments)})},{key:"getData",value:(d=On(bn().mark((function e(t){var r,n=this;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ln(An(C.prototype),"getData",this).call(this,t);case 2:return(r=e.sent).merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",r.merchantTypes={none:game.i18n.localize("MERCHANT.typeNone"),merchant:game.i18n.localize("MERCHANT.typeMerchant"),loot:game.i18n.localize("MERCHANT.typeLoot"),epic:game.i18n.localize("MERCHANT.typeEpic")},r.invName=r.merchantTypes[r.merchantType],r.players=game.users.filter((function(e){return!e.isGM})).map((function(e){return e.allowedMerchant=n.actor.testUserPermission(e,"LIMITED",!1),e.buyingFactor=getProperty(n.actor.system,"merchant.factors.buyingFactor.".concat(e.id)),e.sellingFactor=getProperty(n.actor.system,"merchant.factors.sellingFactor.".concat(e.id)),e})),"epic"!=r.merchantType?(this.prepareStorage(r),this.merchantSheetActivated()&&(this.filterWornEquipment(r),this.prepareTradeFriend(r),0==r.actor.inventory.misc.items.length&&(r.actor.inventory.misc.show=!1))):(this.prepareStorage(r),r.garadanOptions={1:game.i18n.localize("GARADAN.1"),2:game.i18n.localize("GARADAN.2"),3:game.i18n.localize("GARADAN.3"),4:game.i18n.localize("GARADAN.4"),6:game.i18n.localize("GARADAN.6")}),r.hasOtherTradeFriend=!!this.otherTradeFriend,e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"filterWornEquipment",value:function(e){for(var t=0,r=Object.entries(e.actor.inventory);t<r.length;t++){var n=vn(r[t],2),a=(n[0],n[1]);a.items=a.items.filter((function(e){return!getProperty(e,"system.worn.value")}))}}},{key:"prepareStorage",value:function(e){if("merchant"==e.merchantType)for(var t=0,r=Object.entries(e.actor.inventory);t<r.length;t++){var n,a=vn(r[t],2),o=(a[0],wn(a[1].items));try{for(o.s();!(n=o.n()).done;){var i=n.value;i.defaultPrice=this.getItemPrice(i),i.calculatedPrice=Number(parseFloat("".concat(i.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1))).toFixed(2))*(getProperty(this.actor.system,"merchant.factors.sellingFactor.".concat(game.user.id))||1),i.priceTag=" / ".concat(i.calculatedPrice)}}catch(e){o.e(e)}finally{o.f()}}else if("loot"==e.merchantType){for(var s=0,c=Object.entries(e.actor.inventory);s<c.length;s++){var u,l=vn(c[s],2),f=(l[0],wn(l[1].items));try{for(f.s();!(u=f.n()).done;){var p=u.value;p.calculatedPrice=this.getItemPrice(p)}}catch(e){f.e(e)}finally{f.f()}}var d={items:e.actor.money.coins.map((function(e){return e.name=game.i18n.localize(e.name),e})),show:!0,dataType:"money"};d.items.length&&(e.actor.inventory.money=d)}}},{key:"getItemPrice",value:function(e){return Number(getProperty(e,"flags.dsa5.customPriceTag"))||Number(e.system.price.value)*("consumable"==e.type?Number(e.system.QL)||0:1)}},{key:"prepareTradeFriend",value:function(e){var t=this.getTradeFriend();if(t){var r=t.prepareItems({details:[]}),n="loot"==getProperty(this.actor.system,"merchant.merchantType")?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,"merchant.factors.buyingFactor.".concat(game.user.id))||1),a=this.prepareSellPrices(r.inventory,n);0==a.misc.items.length&&(a.misc.show=!1),"loot"==e.merchantType&&(a.money={items:r.money.coins.map((function(e){return e.name=game.i18n.localize(e.name),e})),show:!0,dataType:"money"}),mergeObject(e,{tradeFriend:{img:t.img,name:t.name,inventory:a,money:r.money}})}else mergeObject(e,{tradeFriend:{inventory:[],money:{coins:[]}}})}},{key:"prepareSellPrices",value:function(e,t){for(var r=0,n=Object.entries(e);r<n.length;r++){var a,o=vn(n[r],2),i=(o[0],wn(o[1].items));try{for(i.s();!(a=i.n()).done;){var s=a.value;s.calculatedPrice=Number(parseFloat("".concat(this.getItemPrice(s)*t)).toFixed(2))}}catch(e){i.e(e)}finally{i.f()}}return e}}],i=[{key:"defaultOptions",get:function(){var e=Ln(An(C),"defaultOptions",this);return mergeObject(e,{classes:e.classes.concat(["merchant-sheet"])}),e}},{key:"merchantTemplate",get:function(){return"systems/dsa5/templates/actors/merchant/merchant-sheet.html"}},{key:"transferTokenData",value:function(e){var t={actor:e.id};return e.token&&(t.token=e.token.id),t}},{key:"finishTransaction",value:(p=On(bn().mark((function e(t,r,n,a,o,i){var s,c;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.items.get(a).toObject(),i=Math.min(Number(s.system.quantity.value),i),!(Number(s.system.quantity.value)>0)){e.next=24;break}if(!(c=this.noNeedToPay(r,t,n))&&!un.payMoney(r,n,!0)){e.next=24;break}if(getProperty(s,"system.worn.value")&&(s.system.worn.value=!1),!o){e.next=18;break}return e.next=10,this.updateTargetTransaction(r,s,i,t,n);case 10:return e.next=12,this.updateSourceTransaction(t,r,s,n,a,i);case 12:return e.next=14,this.transferNotification(s,r,t,o,n,i,c);case 14:return e.next=16,this.selfDestruction(t);case 16:e.next=24;break;case 18:return e.next=20,this.updateSourceTransaction(t,r,s,n,a,i);case 20:return e.next=22,this.updateTargetTransaction(r,s,i,t,n);case 22:return e.next=24,this.transferNotification(s,t,r,o,n,i,c);case 24:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a,o){return p.apply(this,arguments)})},{key:"isTemporaryToken",value:function(e){return"loot"==getProperty(e,"merchant.merchantType")&&getProperty(e,"merchant.temporary")}},{key:"selfDestruction",value:(f=On(bn().mark((function e(r){var n;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isTemporaryToken(r)){e.next=10;break}if(r.items.some((function(e){return t.Z.equipmentCategories.includes(e.type)||"money"==e.type&&e.system.quantity.value>0}))){e.next=10;break}return game.socket.emit("system.dsa5",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(r)}}),n=r.getActiveTokens().map((function(e){return e.id})),e.next=7,canvas.scene.deleteEmbeddedDocuments("Token",n);case 7:return e.next=9,game.actors.get(r.id).delete();case 9:this.hideDeletedSheet(r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"hideDeletedSheet",value:(l=On(bn().mark((function e(t){return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.sheet.close(!0);case 1:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"transferNotification",value:(u=On(bn().mark((function t(r,n,a,o,i,s,c){var u,l,f,p;return bn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!=(u=game.settings.get("dsa5","merchantNotification"))&&"service"!=getProperty(r,"system.equipmentType.value")){t.next=3;break}return t.abrupt("return");case 3:return l="MERCHANT."+(o?"buy":"sell")+(c?"Loot":"")+"Notification",f=game.i18n.format(l,{item:r.name,source:n.name,target:a.name,amount:s,price:i,buy:o}),p=e.Z.chatDataSetup(f),2==u&&(p.whisper=ChatMessage.getWhisperRecipients("GM").map((function(e){return e.id}))),t.next=9,ChatMessage.create(p);case 9:case"end":return t.stop()}}),t)}))),function(e,t,r,n,a,o,i){return u.apply(this,arguments)})},{key:"noNeedToPay",value:function(e,t,r){return 0==r||"loot"==getProperty(e.system,"merchant.merchantType")||"loot"==getProperty(t.system,"merchant.merchantType")}},{key:"updateSourceTransaction",value:(c=On(bn().mark((function e(t,r,n,a,o,i){var s;return bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=duplicate(n),!(Number(s.system.quantity.value)>i||"money"==s.type)){e.next=7;break}return s.system.quantity.value=Number(s.system.quantity.value)-i,e.next=5,t.updateEmbeddedDocuments("Item",[s]);case 5:e.next=9;break;case 7:return e.next=9,t.deleteEmbeddedDocuments("Item",[o]);case 9:if(this.noNeedToPay(t,r,a)){e.next=12;break}return e.next=12,un.getMoney(t,a,!0);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,a,o){return c.apply(this,arguments)})},{key:"updateTargetTransaction",value:(s=On(bn().mark((function t(r,a,o,i,s){var c,u,l;return bn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=duplicate(a),"service"!=getProperty(c,"system.equipmentType.value")){t.next=7;break}u=game.i18n.format("MERCHANT.buyNotification",{item:c.name,amount:o,source:r.name,target:i.name,price:s}),ChatMessage.create(e.Z.chatDataSetup(u)),t.next=16;break;case 7:if(l=r.items.find((function(e){return n.Z.areEquals(c,e)})),c.system.quantity.value=o,l){t.next=14;break}return t.next=12,r.createEmbeddedDocuments("Item",[c]);case 12:t.next=16;break;case 14:return t.next=16,n.Z.stackItems(l,c,r);case 16:case"end":return t.stop()}}),t)}))),function(e,t,r,n,a){return s.apply(this,arguments)})}],o&&Sn(a.prototype,o),i&&Sn(a,i),Object.defineProperty(a,"prototype",{writable:!1}),C}(r)};function Cn(e){return Cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Cn(e)}function In(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Mn(e,t){return Mn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Mn(e,t)}function Nn(e,t){if(t&&("object"===Cn(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Rn(e){return Rn=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Rn(e)}var zn=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Mn(e,t)}(o,e);var t,r,n,a=(r=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Rn(r);if(n){var a=Rn(this).constructor;e=Reflect.construct(t,arguments,a)}else e=t.apply(this,arguments);return Nn(this,e)});function o(){return In(this,o),a.apply(this,arguments)}return t=o,Object.defineProperty(t,"prototype",{writable:!1}),t}(jn(Pt)),Fn=__webpack_require__(15);function Gn(e){return Gn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Gn(e)}function Zn(e){return function(e){if(Array.isArray(e))return qn(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Wn(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Bn(){Bn=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Gn(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Hn(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Wn(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Wn(e,t){if(e){if("string"==typeof e)return qn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?qn(e,t):void 0}}function qn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function $n(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Un(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){$n(o,n,a,i,s,"next",e)}function s(e){$n(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Yn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Vn(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Kn(e,t,r){return t&&Vn(e.prototype,t),r&&Vn(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Jn(){return Jn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Qn(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Jn.apply(this,arguments)}function Qn(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=na(e)););return e}function Xn(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ea(e,t)}function ea(e,t){return ea=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ea(e,t)}function ta(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=na(e);if(t){var a=na(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return ra(this,r)}}function ra(e,t){if(t&&("object"===Gn(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function na(e){return na=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},na(e)}var aa=function(e){Xn(c,Application);var t,r,n,a,o,i,s=ta(c);function c(e){var t;return Yn(this,c),(t=s.call(this,e)).entityAbilities=[],game.dsa5.apps.PlayerMenuSubApp=oa,t.summoningModifiers=[{id:1,name:"CONJURATION.offensiveImprovement",descr:"CONJURATION.offensiveImprovementDescr",changes:[{key:"system.meleeStats.attack",mode:2,value:2},{key:"system.meleeStats.damage",mode:2,value:4},{key:"system.rangeStats.attack",mode:2,value:2},{key:"system.rangeStats.damage",mode:2,value:4}]},{id:2,name:"CONJURATION.defensiveImprovement",descr:"CONJURATION.defensiveImprovementDescr",changes:[{key:"system.meleeStats.parry",mode:2,value:2},{key:"system.totalArmor",mode:2,value:2},{key:"system.status.wounds.gearmodifier",mode:2,value:10}]},{id:3,name:"CONJURATION.speedImprovement",descr:"CONJURATION.speedImprovementDescr",changes:[{key:"system.status.speed.gearmodifier",mode:2,value:2},{key:"system.status.dodge.gearmodifier",mode:2,value:2}]},{id:4,name:"CONJURATION.magicalImprovement",descr:"CONJURATION.magicalImprovementDescr",changes:[],fun:P.Z.magicalImprovement},{id:5,name:"CONJURATION.resistanceImprovement",descr:"CONJURATION.resistanceImprovementDescr",changes:[{key:"system.status.soulpower.gearmodifier",mode:2,value:2},{key:"system.status.toughness.gearmodifier",mode:2,value:2}]},{id:6,name:"CONJURATION.mentalImprovement",descr:"CONJURATION.mentalImprovementDescr",changes:[{key:"system.characteristics.mu.gearmodifier",mode:2,value:2},{key:"system.characteristics.kl.gearmodifier",mode:2,value:2},{key:"system.characteristics.in.gearmodifier",mode:2,value:2},{key:"system.characteristics.ch.gearmodifier",mode:2,value:2}]},{id:7,name:"CONJURATION.physicalImprovement",descr:"CONJURATION.physicalImprovementDescr",changes:[{key:"system.characteristics.ff.gearmodifier",mode:2,value:2},{key:"system.characteristics.ge.gearmodifier",mode:2,value:2},{key:"system.characteristics.ko.gearmodifier",mode:2,value:2},{key:"system.characteristics.kk.gearmodifier",mode:2,value:2}]}],t.conjurationData={qs:0,consumedQS:0,packageModifier:0,selectedIds:[],selectedEntityIds:[],selectedPackageIds:[],conjurationTypes:{1:game.i18n.localize("CONJURATION.demon"),2:game.i18n.localize("CONJURATION.elemental")},rules:{1:{de:{pack:"dsa5-core.corerules",name:"Beschwrungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}},2:{de:{pack:"dsa5-core.corerules",name:"Beschwrungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}}},conjurationType:1,skills:{1:["invocatioMinima","invocatioMinor","invocatioMaior"].map((function(e){return game.i18n.localize("LocalizedIDs.".concat(e))})),2:["manifesto","elementalServant","callDjinn"].map((function(e){return game.i18n.localize("LocalizedIDs.".concat(e))}))},modifiers:{1:t.summoningModifiers,2:t.summoningModifiers},moreModifiers:{},postFunction:{}},t.subApps=[],t}return Kn(c,[{key:"registerSubApp",value:function(e){this.subApps.push(e)}},{key:"rollConjuration",value:(i=Un(Bn().mark((function e(t){var r,n,a,o,i,s,c,u=this;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.conjuration){e.next=2;break}return e.abrupt("return",ui.notifications.warn(game.i18n.localize("CONJURATION.dragConjuration")));case 2:if(r=$(t.currentTarget).closest(".item").attr("data-item-id"),n=this.actor.items.get(r),a=[{name:game.i18n.localize("conjuringDifficulty"),value:getProperty(this.conjuration,"system.conjuringDifficulty.value")||0,selected:!0}],this.conjurationData.packageModifier&&a.push({name:game.i18n.localize("summoningPackage"),value:this.conjurationData.packageModifier,selected:!0}),this.conjurationData.moreModifiers[this.conjurationData.conjurationType]){o=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].filter((function(e){return e.selected})),i=Hn(o);try{for(i.s();!(s=i.n()).done;)c=s.value,a.push({name:c.name,value:Number(c.selected),selected:!0})}catch(e){i.e(e)}finally{i.f()}}this.actor.setupSkill(n,{moreModifiers:a,subtitle:" (".concat(this.conjuration.name,")")},void 0).then(function(){var e=Un(Bn().mark((function e(t){var r;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.actor.basicTest(t);case 2:r=e.sent,u.conjurationData.qs=r.result.qualityStep,u.render(!0);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 8:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;Jn(na(c.prototype),"activateListeners",this).call(this,e),e.find(".conjurationData").change((function(e){var r=$(e.currentTarget);setProperty(t.conjurationData,r.attr("name"),r.val()),r.attr("data-refresh")&&t.render()})),e.find(".skill-select").click((function(e){t.rollConjuration(e)})),e.find(".initLibrary").click(function(){var e=Un(Bn().mark((function e(r){return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return $(r.currentTarget).html('<i class="fas fa-spin fa-spinner"></i>'),e.next=3,game.dsa5.itemLibrary.buildEquipmentIndex();case 3:t.render();case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".item-edit").click((function(e){var r=$(e.currentTarget).closest(".item").attr("data-item-id");t.actor.items.get(r).sheet.render(!0)})),e.find(".selectableRow").click((function(e){return t.selectImprovement(e)})),e.find(".finalizeConjuration").click((function(){return t.finalizeConjuration()})),e.find(".ruleLink").click((function(){return t.openRules()})),e.find(".showEntity").click((function(e){e.stopPropagation();var t=function(){var t=Un(Bn().mark((function t(){return Bn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fromUuid(e.currentTarget.dataset.uuid);case 2:t.sent.sheet.render(!0);case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();t()})),e.find(".moreModifiers").change((function(e){t.conjurationData.moreModifiers[t.conjurationData.conjurationType].find((function(t){return t.name==e.currentTarget.dataset.name})).selected=$(e.currentTarget).val()}));var r,n=Hn(this.subApps);try{for(n.s();!(r=n.n()).done;)r.value.activateListeners(e)}catch(e){n.e(e)}finally{n.f()}}},{key:"openRules",value:(o=Un(Bn().mark((function e(){var t,r;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.conjurationData.rules[this.conjurationData.conjurationType][game.i18n.lang],r=function(){var e=Un(Bn().mark((function e(){var r,n,a,o;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=game.packs.get(t.pack),e.next=3,r.getDocuments({name:t.name});case 3:n=e.sent,a=Hn(n);try{for(a.s();!(o=a.n()).done;)o.value.sheet.render(!0)}catch(e){a.e(e)}finally{a.f()}case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),r();case 3:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"finalizeConjuration",value:function(){var e=this;if(this.conjurationData){if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("DSAError.noConjurationActive"));var t={source:this.conjuration.toObject(),creationData:{type:this.conjurationData.conjurationType,typeName:this.conjurationData.conjurationTypes[this.conjurationData.conjurationType],qs:this.conjurationData.qs,consumedQS:this.conjurationData.consumedQS,modifiers:this.conjurationData.modifiers[this.conjurationData.conjurationType].filter((function(t){return e.conjurationData.selectedIds.includes(t.id)})),entityIds:this.conjurationData.selectedEntityIds,packageIds:this.conjurationData.selectedPackageIds},summoner:{name:this.actor.name,img:this.actor.img}};game.user.isGM?c.createConjuration(t):(game.socket.emit("system.dsa5",{type:"summonCreature",payload:t}),ui.notifications.notify(game.i18n.localize("CONJURATION.requestSend")))}}},{key:"selectImprovement",value:function(e){$(e.currentTarget).toggleClass("selected");var t=[],r=[],n=[],a=0,o=0;$(this._element).find(".selectableRow.selected").each((function(e,i){i.dataset.entityid?(r.push(i.dataset.id),a+=-1*(Number(i.dataset.qs)||0)):i.dataset.packageid?(n.push(i.dataset.id),o+=Number(i.dataset.mod)||0):t.push(Number(i.dataset.id))})),this.conjurationData.selectedIds=t,this.conjurationData.selectedEntityIds=r,this.conjurationData.selectedPackageIds=n,this.conjurationData.consumedQS=t.length+a,this.conjurationData.packageModifier=o,this.render()}},{key:"_canDragDrop",value:function(e){return!0}},{key:"_onDrop",value:(a=Un(Bn().mark((function e(t){var r,n,a,o,i;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=JSON.parse(t.dataTransfer.getData("text/plain")),e.next=4,Actor.implementation.fromDropData(r);case 4:r=e.sent,e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",!1);case 10:if("Actor"!=r.documentName){e.next=32;break}if(!("creature"==(n=game.actors.get(r.id)).type||$(t.target).closest(".summoningArea").length>0)){e.next=29;break}if(this.conjuration=n,this.conjurationData.selectedIds=[],this.conjurationData.selectedEntityIds=[],this.conjurationData.selectedPackageIds=[],"creature"!=n.type){e.next=27;break}a=0,o=Object.keys(this.conjurationData.conjurationTypes);case 19:if(!(a<o.length)){e.next=27;break}if(i=o[a],!n.system.creatureClass.value.includes(this.conjurationData.conjurationTypes[i])){e.next=24;break}return this.conjurationData.conjurationType=i,e.abrupt("break",27);case 24:a++,e.next=19;break;case 27:e.next=31;break;case 29:this.trackedId=r.id,this.actor=n;case 31:this.render(!0);case 32:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e){return a.apply(this,arguments)})},{key:"prepareEntityAbilities",value:(n=Un(Bn().mark((function e(){var t,r,n,a,o,i,s,c;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t={entityAbilities:[],entityPackages:[]},!game.dsa5.itemLibrary.equipmentBuild){e.next=14;break}return r=[game.i18n.localize("all"),this.conjurationData.conjurationTypes[this.conjurationData.conjurationType]],e.t0=Promise,e.next=6,game.dsa5.itemLibrary.getCategoryItems("trait",!1);case 6:return e.t1=e.sent.map((function(e){return e.getItem()})),e.next=9,e.t0.all.call(e.t0,e.t1);case 9:n=e.sent,a=new Set,o=new Set,i=Hn(n);try{for(c=function(){var e=s.value;e.system.distribution&&r.some((function(t){return e.system.distribution.includes(t)}))&&("entity"!=e.system.traitType.value||a.has(e.name)?"summoning"!=e.system.traitType.value||o.has(e.name)||(o.add(e.name),t.entityPackages.push(e)):(a.add(e.name),t.entityAbilities.push(e)))},i.s();!(s=i.n()).done;)c()}catch(e){i.e(e)}finally{i.f()}case 14:return e.abrupt("return",t);case 15:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getData",value:(r=Un(Bn().mark((function e(t){var r,n,a,o,i,s,u,l,f=this;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jn(na(c.prototype),"getData",this).call(this,t);case 2:if(r=e.sent,game.user.isGM||this.actor||(this.actor=game.user.character),!this.actor){e.next=17;break}return n=this.conjurationData.qs-this.conjurationData.consumedQS+1,a=game.dsa5.itemLibrary.equipmentBuild,e.next=9,this.prepareEntityAbilities();case 9:return o=e.sent,i=o.entityAbilities,s=o.entityPackages,e.next=14,renderTemplate("systems/dsa5/templates/system/conjuration/summoning.html",{actor:this.actor,conjuration:this.conjuration||{name:game.i18n.localize("CONJURATION.dragConjuration"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,services:n,conjurationModifiers:this.conjurationData.modifiers[this.conjurationData.conjurationType],equipmentIndexLoaded:a,entityAbilities:i,entityPackages:s,moreModifiers:this.conjurationData.moreModifiers[this.conjurationData.conjurationType]});case 14:u=e.sent,l=this.actor.items.filter((function(e){return f.conjurationData.skills[f.conjurationData.conjurationType].includes(e.name)&&["liturgy","ceremony","spell","ritual"].includes(e.type)})).map((function(e){return e.toObject()})),mergeObject(r,{conjurationSheet:u,conjurationskills:l});case 17:return mergeObject(r,{actor:this.actor||{name:game.i18n.localize("CONJURATION.dragActor"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,conjurationTypes:this.conjurationData.conjurationTypes}),e.next=20,this.prepareSubApps(r);case 20:return e.abrupt("return",r);case 21:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"prepareSubApps",value:(t=Un(Bn().mark((function e(t){var r,n,a;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.subApps=[],r=Hn(this.subApps),e.prev=2,r.s();case 4:if((n=r.n()).done){e.next=13;break}return a=n.value,e.t0=t.subApps,e.next=9,a.prepareApp(t);case 9:e.t1=e.sent,e.t0.push.call(e.t0,e.t1);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(2),r.e(e.t2);case 18:return e.prev=18,r.f(),e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(e){return t.apply(this,arguments)})}],[{key:"createConjuration",value:function(e){var t=e.source,r=e.creationData,n=e.summoner;new ia(t,n,r).render(!0)}},{key:"defaultOptions",get:function(){var e=Jn(na(c),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"summoning"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","playerMenu"]),width:470,height:740,title:game.i18n.localize("PLAYER.title"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/playermenu.html",e.resizable=!0,e}}]),c}(),oa=function(){function e(){Yn(this,e)}var t,r,n;return Kn(e,[{key:"getData",value:(n=Un(Bn().mark((function e(t){return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{});case 1:case"end":return e.stop()}}),e)}))),function(e){return n.apply(this,arguments)})},{key:"activateListeners",value:function(e){}},{key:"renderData",value:(r=Un(Bn().mark((function e(t){var r,n;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getData(t);case 2:return r=e.sent,mergeObject(r,t),e.next=6,renderTemplate(this.constructor.template,r);case 6:return n=e.sent,e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"prepareApp",value:(t=Un(Bn().mark((function e(t){return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=game.i18n.localize("PLAYER.".concat(this.constructor.name)),e.next=3,this.renderData(t);case 3:return e.t1=e.sent,e.abrupt("return",{name:e.t0,view:e.t1});case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();!function(e,t,r){t in e?Object.defineProperty(e,t,{value:"",enumerable:!0,configurable:!0,writable:!0}):e[t]=""}(oa,"template");var ia=function(t){Xn(o,t);var r,n,a=ta(o);function o(e,t,r){var n;return Yn(this,o),(n=a.call(this,{title:"".concat(game.i18n.localize("CONJURATION.request")," (").concat(t.name,")"),default:"ok",buttons:{}})).conjuration=e,n.summoner=t,n.creationData=r,n.confirmed=!1,n}return Kn(o,[{key:"getData",value:(n=Un(Bn().mark((function e(t){var r;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jn(na(o.prototype),"getData",this).call(this,t);case 2:return r=e.sent,e.t0=mergeObject,e.t1=r,e.t2=this.conjuration,e.t3=this.summoner,e.t4=this.confirmed,e.t5=this.creationData.qs-this.creationData.consumedQS+1,e.t6=this.creationData,e.t7=this.creationData.modifiers,e.next=13,Promise.all(this.creationData.entityIds.map((function(e){return fromUuid(e)})));case 13:return e.t8=e.sent,e.next=16,Promise.all(this.creationData.packageIds.map((function(e){return fromUuid(e)})));case 16:return e.t9=e.sent,e.t10=this.actor,e.t11={conjuration:e.t2,summoner:e.t3,confirmed:e.t4,services:e.t5,creationData:e.t6,conjurationModifiers:e.t7,entityModifiers:e.t8,packageModifiers:e.t9,actor:e.t10},(0,e.t0)(e.t1,e.t11),e.abrupt("return",r);case 21:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"createActor",value:(r=Un(Bn().mark((function t(){var r,n,a,o,i,s,c,u,l,f,p,d,h,m,y,v,g=this;return Bn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.confirmed=!0,t.next=3,e.Z.getFolderForType("Actor",null,game.i18n.localize("PLAYER.conjuration"));case 3:return r=t.sent,t.next=6,e.Z.getFolderForType("Actor",r.id,this.creationData.typeName);case 6:n=t.sent,a=this.creationData.qs-this.creationData.consumedQS+1,this.conjuration.folder=n.id,this.conjuration.effects||(this.conjuration.effects=[]),o=Hn(this.creationData.modifiers);try{for(o.s();!(i=o.n()).done;)s=i.value,this.conjuration.effects.push({changes:s.changes,duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize(s.name),flags:{dsa5:{value:null,editable:!0,description:"".concat(game.i18n.localize("PLAYER.conjuration")," ").concat(game.i18n.localize("extensions")),custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}}}),s.fun&&s.fun(this.conjuration,this.creationData)}catch(e){o.e(e)}finally{o.f()}return t.next=14,Promise.all(this.creationData.entityIds.map((function(e){return fromUuid(e)})));case 14:return c=t.sent.map((function(e){return e.toObject(!1)})),t.next=17,Promise.all(this.creationData.packageIds.map((function(e){return fromUuid(e)})));case 17:if(u=t.sent.map((function(e){return e.toObject(!1)})),this.conjuration.effects.push({changes:[],duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize("PLAYER.services"),flags:{dsa5:{value:a,editable:!0,max:500,description:"".concat(game.i18n.localize("PLAYER.conjuration")," ").concat(game.i18n.localize("PLAYER.services")),manual:a,auto:0,hideOnToken:!0,hidePlayers:!1},core:{statusId:"services"}}}),!game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type]){t.next=22;break}return t.next=22,game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type](this.conjuration,this.creationData.qs-this.creationData.consumedQS,this.creationData.type);case 22:return"creature"!=this.conjuration.type||this.conjuration.system.creatureClass.value.includes(this.creationData.typeName)||(this.conjuration.system.creatureClass.value+=", ".concat(this.creationData.typeName)),t.next=25,T.Z.create(this.conjuration);case 25:return this.actor=t.sent,l=[].concat(Zn(c),Zn(u)).filter((function(e){return!g.conjuration.items.find((function(t){return t.type==e.type&&e.name==t.name}))})),t.next=29,this.actor.createEmbeddedDocuments("Item",l);case 29:f=Hn(u),t.prev=30,f.s();case 32:if((p=f.n()).done){t.next=38;break}return d=p.value,t.next=36,ut.Z.traitAdded(this.actor,d);case 36:t.next=32;break;case 38:t.next=43;break;case 40:t.prev=40,t.t0=t.catch(30),f.e(t.t0);case 43:return t.prev=43,f.f(),t.finish(43);case 46:h=Hn(c),t.prev=47,h.s();case 49:if((m=h.n()).done){t.next=55;break}return y=m.value,t.next=53,ut.Z.traitAdded(this.actor,y);case 53:t.next=49;break;case 55:t.next=60;break;case 57:t.prev=57,t.t1=t.catch(47),h.e(t.t1);case 60:return t.prev=60,h.f(),t.finish(60);case 63:return t.next=65,this.actor.update({"system.status.wounds.value":this.actor.system.status.wounds.max});case 65:return t.next=67,renderTemplate("systems/dsa5/templates/system/conjuration/chat.html",{actor:this.actor,modifiers:this.creationData.modifiers,summoner:this.summoner,summonerImg:en.Z.videoOrImgTag(this.summoner.img),conjureImg:en.Z.videoOrImgTag(this.actor.img),services:a});case 67:return v=t.sent,t.next=70,ChatMessage.create(e.Z.chatDataSetup(v));case 70:this.render();case 71:case"end":return t.stop()}}),t,this,[[30,40,43,46],[47,57,60,63]])}))),function(){return r.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;Jn(na(o.prototype),"activateListeners",this).call(this,e),e.find(".createActor").click((function(){t.createActor()})),e.on("mousedown",".newNPC",function(){var e=Un(Bn().mark((function e(t){var r;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=$(t.currentTarget).attr("data-id"),2==t.button&&(game.actors.get(r).delete(),$(t.currentTarget).remove());case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("click",".newNPC",function(){var e=Un(Bn().mark((function e(t){var r;return Bn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=$(t.currentTarget).attr("data-id"),game.actors.get(r).sheet.render(!0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("dragstart",".newNPC",(function(e){e.stopPropagation();var t={type:"Actor",uuid:e.currentTarget.dataset.uuid};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(t))})),e.find(".showEntity").click((function(e){e.stopPropagation();var t=function(){var t=Un(Bn().mark((function t(){return Bn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fromUuid(e.currentTarget.dataset.uuid);case 2:t.sent.sheet.render(!0);case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();t()}))}}],[{key:"defaultOptions",get:function(){var e=Jn(na(o),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog"]),width:470}),e.template="systems/dsa5/templates/system/conjuration/request.html",e}}]),o}(Fn.Z),sa=__webpack_require__(903);function ca(e){return ca="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ca(e)}function ua(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function la(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function fa(){return fa="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=pa(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},fa.apply(this,arguments)}function pa(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ma(e)););return e}function da(e,t){return da=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},da(e,t)}function ha(e,t){if(t&&("object"===ca(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function ma(e){return ma=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ma(e)}function ya(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=ga(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function va(){va=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==ca(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function ga(e,t){if(e){if("string"==typeof e)return ba(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ba(e,t):void 0}}function ba(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function wa(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ka(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){wa(o,n,a,i,s,"next",e)}function s(e){wa(o,n,a,i,s,"throw",e)}i(void 0)}))}}var xa=function(){var t=ka(va().mark((function t(r,n,a,o){var i,s,c,u,l,f,p,d,h,m,y;return va().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!game.user.isGM){t.next=35;break}return t.next=3,game.dsa5.apps.DSA5_Utility.allMoneyItems();case 3:return i=t.sent,t.next=6,e.Z.getFolderForType("Actor",null,"Dropped Items");case 6:return s=t.sent,c=game.users.filter((function(e){return!e.isGM})).map((function(e){return e.id})),u=c.reduce((function(e,t){return e[t]=1,e}),{default:0}),(l=n.toObject()).system.quantity.value=o,getProperty(l,"system.worn.value")&&(l.system.worn.value=!1),f={type:"npc",name:n.name,img:n.img,prototypeToken:{img:n.img,width:.4,height:.4},ownership:u,items:[].concat((v=i,function(e){if(Array.isArray(e))return ba(e)}(v)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(v)||ga(v)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),[l]),flags:{core:{sheetClass:"dsa5.MerchantSheetDSA5"}},folder:s,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},status:{wounds:{value:16}}}},t.next=15,game.dsa5.entities.Actordsa5.create(f);case 15:return p=t.sent,t.next=18,p.getTokenData({x:a.x,y:a.y,hidden:!1});case 18:if(d=t.sent,canvas.dimensions.rect.contains(d.x,d.y)){t.next=21;break}return t.abrupt("return",!1);case 21:return h=getDocumentClass("Token"),t.next=24,h.create(d,{parent:canvas.scene});case 24:if(!r){t.next=33;break}if(!((m=n.system.quantity.value-o)<=0)){t.next=31;break}return t.next=29,r.deleteEmbeddedDocuments("Item",[a.data._id]);case 29:t.next=33;break;case 31:return t.next=33,r.updateEmbeddedDocuments("Item",[{_id:a.data._id,"system.quantity.value":m}]);case 33:t.next=37;break;case 35:y={itemId:n.uuid,sourceActorId:r.id,data:a,amount:o},game.socket.emit("system.dsa5",{type:"itemDrop",payload:y});case 37:case"end":return t.stop()}var v}),t)})));return function(e,r,n,a){return t.apply(this,arguments)}}(),_a=function(){var r=ka(va().mark((function r(n,a){var o,i,s,c;return va().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!a.uuid){r.next=8;break}return r.next=3,fromUuid(a.uuid);case 3:(o=r.sent).parent&&(i=o.parent),a.amount&&(o.system.quantity.value=Number(a.amount)),r.next=23;break;case 8:if(!a.pack){r.next=15;break}return s=game.packs.get(a.pack),r.next=12,s.getDocument(a.data._id);case 12:o=r.sent,r.next=23;break;case 15:if(!a.tokenId&&!a.actorId){r.next=22;break}if((i=e.Z.getSpeaker({actor:a.actorId,token:a.tokenId,scene:n.scene.id})).isOwner){r.next=19;break}return r.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.notOwner")));case 19:o=i.items.get(a.data._id),r.next=23;break;case 22:o=game.items.get(a.data._id);case 23:if(t.Z.equipmentCategories.includes(o.type)){r.next=25;break}return r.abrupt("return");case 25:return r.next=27,renderTemplate("systems/dsa5/templates/dialog/dropToGround.html",{name:o.name,count:o.system.quantity.value});case 27:c=r.sent,new Ea({title:a.name,content:c,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){var e=ka(va().mark((function e(t){return va().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",xa(i,o,a,Number(t.find('[name="count"]').val())));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0);case 29:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),Oa=function(){var e=ka(va().mark((function e(t,r){var n,a,o,i,s,c,u,l,f,p;return va().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=r.x,a=r.y,o=0,i=t.grid.size,s=Math.ceil(Math.sqrt(r.ids.length)),c=ya(r.ids),e.prev=6,c.s();case 8:if((u=c.n()).done){e.next=21;break}if(l=u.value,f=game.actors.get(l)){e.next=13;break}return e.abrupt("continue",19);case 13:return e.next=15,f.getTokenData({x:n,y:a,hidden:!1});case 15:(p=e.sent).constructor.create(p,{parent:t.scene}),s%o==0&&o>0?(a+=i,n=r.x):n+=i,o++;case 19:e.next=8;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),c.e(e.t0);case 26:return e.prev=26,c.f(),e.finish(26);case 29:case"end":return e.stop()}}),e,null,[[6,23,26,29]])})));return function(t,r){return e.apply(this,arguments)}}(),Ea=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&da(e,t)}(i,Dialog);var t,r,n,a,o=(n=i,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=ma(n);if(a){var r=ma(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return ha(this,e)});function i(){return ua(this,i),o.apply(this,arguments)}return t=i,(r=[{key:"activateListeners",value:function(e){fa(ma(i.prototype),"activateListeners",this).call(this,e),e.find('input[type="range"]').change((function(e){$(e.currentTarget).closest(".row-section").find(".range-value").html($(e.currentTarget).val())}))}}])&&la(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),i}();function Sa(e){return Sa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Sa(e)}function La(){La=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Sa(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Ta(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Da(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Ta(o,n,a,i,s,"next",e)}function s(e){Ta(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Pa(e){return Pa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Pa(e)}function Aa(){Aa=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Pa(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function ja(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ca(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){ja(o,n,a,i,s,"next",e)}function s(e){ja(o,n,a,i,s,"throw",e)}i(void 0)}))}}var Ia=__webpack_require__(565);function Ma(e){return Ma="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ma(e)}function Na(){Na=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Ma(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Ra(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return za(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?za(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function za(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Fa(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Ga(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Fa(o,n,a,i,s,"next",e)}function s(e){Fa(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Za(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Ba(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ba(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Ba(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Ha=__webpack_require__(586);function Wa(e){return Wa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wa(e)}function qa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ua(e,t,r){return t&&$a(e.prototype,t),r&&$a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Ya(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Va(e,t)}function Va(e,t){return Va=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Va(e,t)}function Ka(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Qa(e);if(t){var a=Qa(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Ja(this,r)}}function Ja(e,t){if(t&&("object"===Wa(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Qa(e){return Qa=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Qa(e)}function Xa(){Xa=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Wa(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function eo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function to(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){eo(o,n,a,i,s,"next",e)}function s(e){eo(o,n,a,i,s,"throw",e)}i(void 0)}))}}var ro=function(e){Ya(r,FormApplication);var t=Ka(r);function r(){return qa(this,r),t.apply(this,arguments)}return Ua(r,[{key:"render",value:function(){(0,Ha.j)()}}]),r}(),no=function(e){Ya(n,FormApplication);var t,r=Ka(n);function n(){return qa(this,n),r.apply(this,arguments)}return Ua(n,[{key:"render",value:(t=to(Xa().mark((function e(){return Xa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.settings.set("dsa5","tokenhotbarPosition",{});case 2:return e.next=4,game.settings.set("dsa5","tokenhotbarLayout",0);case 4:return e.next=6,game.settings.set("dsa5","tokenhotbarSize",35);case 6:game.dsa5.apps.tokenHotbar.resetPosition(),game.dsa5.apps.tokenHotbar.render(!0);case 8:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}]),n}();function ao(e){return ao="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ao(e)}function oo(){oo=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==ao(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function io(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function so(e){return so="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},so(e)}function co(){co=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==so(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function uo(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function lo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}var fo=__webpack_require__(416);function po(e){return po="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},po(e)}function ho(){ho=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==po(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function mo(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return yo(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?yo(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function yo(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function vo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function go(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){vo(o,n,a,i,s,"next",e)}function s(e){vo(o,n,a,i,s,"throw",e)}i(void 0)}))}}function bo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function wo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ko(e,t,r){return t&&wo(e.prototype,t),r&&wo(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function xo(){return xo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=_o(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},xo.apply(this,arguments)}function _o(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=To(e)););return e}function Oo(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Eo(e,t)}function Eo(e,t){return Eo=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Eo(e,t)}function So(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=To(e);if(t){var a=To(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Lo(this,r)}}function Lo(e,t){if(t&&("object"===po(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function To(e){return To=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},To(e)}var Do=function(e){Oo(n,CombatTracker);var t,r=So(n);function n(){return bo(this,n),r.apply(this,arguments)}return ko(n,[{key:"activateListeners",value:function(e){xo(To(n.prototype),"activateListeners",this).call(this,e),e.find(".combatant.actor .aggroButton").click((function(e){e.preventDefault(),e.stopPropagation(),n.runActAttackDialog()}))}},{key:"getData",value:(t=go(ho().mark((function e(t){var r,a,o,i;return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,xo(To(n.prototype),"getData",this).call(this,t);case 2:r=e.sent,a=mo(r.turns);try{for(i=function(){var e=o.value,t=r.combat.turns.find((function(t){return t.id==e.id})),n=game.user.isGM||t.actor&&t.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects");e.defenseCount=t._source.defenseCount;var a=[];if(t.actor){var i,s=mo(t.actor.items);try{for(s.s();!(i=s.n()).done;){var c=i.value;if("rangeweapon"==c.type&&c.system.worn.value&&c.system.reloadTime.progress>0){var u={name:c.name,remaining:T.Z.calcLZ(c.data,t.actor)-c.system.reloadTime.progress};u.remaining>0&&a.push(u)}else if(["spell","liturgy"].includes(c.type)&&c.system.castingTime.modified>0){var l={name:c.name,remaining:c.system.castingTime.modified-c.system.castingTime.progress};l.remaining>0&&a.push(l)}}}catch(e){s.e(e)}finally{s.f()}}(a=a.sort((function(e,t){return e.remaining-t.remaining}))).length>0&&(e.ongoings="".concat(game.i18n.localize("COMBATTRACKER.ongoing"),"\n").concat(a.map((function(e){return"".concat(e.name," - ").concat(e.remaining)})).join("\n")),e.ongoing=a[0].remaining),e.effects=new Set,t.token&&(t.token.effects.forEach((function(t){return e.effects.add(t)})),t.token.overlayEffect&&e.effects.add(t.token.overlayEffect)),t.actor&&t.actor.temporaryEffects.forEach((function(t){t.getFlag("core","statusId")===CONFIG.Combat.defeatedStatusId?e.defeated=!0:!t.icon||!n||t.notApplicable||!game.user.isGM&&t.getFlag("dsa5","hidePlayers")||t.getFlag("dsa5","hideOnToken")||e.effects.add(t.icon)}))},a.s();!(o=a.n()).done;)i()}catch(e){a.e(e)}finally{a.f()}return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"defaultOptions",get:function(){return foundry.utils.mergeObject(xo(To(n),"defaultOptions",this),{template:"/systems/dsa5/templates/system/combattracker.html"})}},{key:"runActAttackDialog",value:function(){if(game.combat){var e=game.combat.combatant;(game.user.isGM||e.isOwner)&&ln.HS.showDialog(e.actor,e.tokenId)}}}]),n}(),Po=function(e){Oo(i,Combat);var t,r,n,a,o=So(i);function i(e,t){return bo(this,i),o.call(this,e,t)}return ko(i,[{key:"refreshTokenbars",value:(a=go(ho().mark((function e(){return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar();case 1:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})},{key:"_onCreate",value:function(e,t,r){xo(To(i.prototype),"_onCreate",this).call(this,e,t,r),this.refreshTokenbars()}},{key:"_onDelete",value:function(e,t){xo(To(i.prototype),"_onDelete",this).call(this,e,t),this.refreshTokenbars()}},{key:"nextRound",value:(n=go(ho().mark((function e(){var t,r,n;return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=20;break}t=mo(this.turns),e.prev=2,t.s();case 4:if((r=t.n()).done){e.next=10;break}return n=r.value,e.next=8,n.update({defenseCount:0});case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),t.e(e.t0);case 15:return e.prev=15,t.f(),e.finish(15);case 18:e.next=22;break;case 20:return e.next=22,game.socket.emit("system.dsa5",{type:"clearCombat",payload:{}});case 22:return e.next=24,xo(To(i.prototype),"nextRound",this).call(this);case 24:return e.abrupt("return",e.sent);case 25:case"end":return e.stop()}}),e,this,[[2,12,15,18]])}))),function(){return n.apply(this,arguments)})},{key:"getDefenseCount",value:(r=go(ho().mark((function e(t){var r;return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.getCombatantFromActor(t),e.abrupt("return",r?r._source.defenseCount:0);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getCombatantFromActor",value:function(e){var t;return(t=e.token?Array.from(this.combatants).find((function(t){return t.tokenId==e.token})):Array.from(this.combatants).find((function(t){return t.actorId==e.actor})))?this.combatants.get(t.id):void 0}},{key:"updateDefenseCount",value:(t=go(ho().mark((function e(t){var r;return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.user.isGM){e.next=7;break}if(!(r=this.getCombatantFromActor(t))||getProperty(r.actor,"config.defense")){e.next=5;break}return e.next=5,r.update({defenseCount:r._source.defenseCount+1});case 5:e.next=9;break;case 7:return e.next=9,game.socket.emit("system.dsa5",{type:"updateDefenseCount",payload:{speaker:t}});case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),i}(),Ao=function(e){Oo(r,Combatant);var t=So(r);function r(e,n){return bo(this,r),e.defenseCount=0,t.call(this,e,n)}return ko(r)}(),jo=function(){function t(){bo(this,t)}var r,n,a,o,s;return ko(t,null,[{key:"updateCombatHook",value:(s=go(ho().mark((function e(r,n,a,o){return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.round||n.turn){e.next=2;break}return e.abrupt("return");case 2:if(0==r.round||!r.turns||!r.active){e.next=6;break}if(!(r.previous.round<r.current.round)){e.next=6;break}return e.next=6,t.startOfRound(r);case 6:case"end":return e.stop()}}),e)}))),function(e,t,r,n){return s.apply(this,arguments)})},{key:"startOfRound",value:(o=go(ho().mark((function e(t){var r,n,a,o,i,s,c,u;return ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=game.users.find((function(e){return e.active&&e.isGM})))&&game.user.id==r.id){e.next=3;break}return e.abrupt("return");case 3:n=mo(t.turns),e.prev=4,n.s();case 6:if((a=n.n()).done){e.next=37;break}if((o=a.value).defeated){e.next=35;break}i=mo(o.actor.effects),e.prev=10,i.s();case 12:if((s=i.n()).done){e.next=25;break}if(c=s.value,"bleeding"!=(u=c.getFlag("core","statusId"))){e.next=20;break}return e.next=18,this.applyBleeding(o);case 18:e.next=23;break;case 20:if("burning"!=u){e.next=23;break}return e.next=23,this.applyBurning(o,c);case 23:e.next=12;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(10),i.e(e.t0);case 30:return e.prev=30,i.f(),e.finish(30);case 33:return e.next=35,this.startOfRoundEffects(o);case 35:e.next=6;break;case 37:e.next=42;break;case 39:e.prev=39,e.t1=e.catch(4),n.e(e.t1);case 42:return e.prev=42,n.f(),e.finish(42);case 45:case"end":return e.stop()}}),e,this,[[4,39,42,45],[10,27,30,33]])}))),function(e){return o.apply(this,arguments)})},{key:"startOfRoundEffects",value:(a=go(ho().mark((function t(r){var n,a,o,i,s,c,u,l,f,p;return ho().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=0,a=["wounds","astralenergy","karmaenergy"];case 2:if(!(n<a.length)){t.next=41;break}o=a[n],i=mo(r.actor.system.repeatingEffects.startOfRound[o]),t.prev=5,i.s();case 7:if((s=i.n()).done){t.next=30;break}if(c=s.value,!getProperty(r.actor.system.repeatingEffects,"disabled.".concat(o))){t.next=11;break}return t.abrupt("continue",28);case 11:return t.next=13,new Roll(c.value).evaluate({async:!0});case 13:return u=t.sent,t.next=16,u.render();case 16:return l=t.sent,f=game.i18n.localize(u.total>0?"CHATNOTIFICATION.regenerates":"CHATNOTIFICATION.getsHurt"),p="".concat(r.actor.name," ").concat(f," ").concat(game.i18n.localize(o)," ").concat(l),t.next=21,ChatMessage.create(e.Z.chatDataSetup(p));case 21:if("wounds"!=o){t.next=26;break}return t.next=24,r.actor.applyDamage(-1*u.total);case 24:t.next=28;break;case 26:return t.next=28,r.actor.applyMana(-1*u.total,"astralenergy"==o?"AsP":"KaP");case 28:t.next=7;break;case 30:t.next=35;break;case 32:t.prev=32,t.t0=t.catch(5),i.e(t.t0);case 35:return t.prev=35,i.f(),t.finish(35);case 38:n++,t.next=2;break;case 41:case"end":return t.stop()}}),t,null,[[5,32,35,38]])}))),function(e){return a.apply(this,arguments)})},{key:"applyBleeding",value:(n=go(ho().mark((function t(r){return ho().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r.actor.system.status.wounds.value<=0)){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,ChatMessage.create(e.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.bleeding",{actor:r.actor.name})));case 4:return t.next=6,r.actor.applyDamage(1);case 6:case"end":return t.stop()}}),t)}))),function(e){return n.apply(this,arguments)})},{key:"applyBurning",value:(r=go(ho().mark((function t(r,n){var a,o,s,c,u;return ho().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r.actor.system.status.wounds.value<=0)){t.next=2;break}return t.abrupt("return");case 2:return a=Number(n.getFlag("dsa5","value")),o=i.Z.resistantToEffect(r.actor,n),s={0:"1",1:"1d3",2:"1d6",3:"2d6"}[a-o]||"1",t.next=7,new Roll(s).evaluate({async:!0});case 7:return c=t.sent,t.next=10,c.render();case 10:return u=t.sent,t.next=13,ChatMessage.create(e.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.burning.".concat(a),{actor:r.actor.name,damage:u})));case 13:return t.next=15,r.actor.applyDamage(c.total);case 15:case"end":return t.stop()}}),t)}))),function(e,t){return r.apply(this,arguments)})}]),t}();function Co(e){return Co="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Co(e)}function Io(){Io=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Co(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Mo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}Hooks.on("updateCombat",jo.updateCombatHook);var No=function(e){var t,r;(null===(t=game.combat)||void 0===t||null===(r=t.combatant)||void 0===r?void 0:r.isOwner)&&game.combat[e]()};function Ro(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return zo(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?zo(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function zo(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Fo(e){return Fo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Fo(e)}function Go(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Zo(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Zo(e,t){if(e){if("string"==typeof e)return Bo(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Bo(e,t):void 0}}function Bo(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Ho(){Ho=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Fo(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Wo(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function qo(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Wo(o,n,a,i,s,"next",e)}function s(e){Wo(o,n,a,i,s,"throw",e)}i(void 0)}))}}function $o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Uo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Yo(e,t,r){return t&&Uo(e.prototype,t),r&&Uo(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Vo(){return Vo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Ko(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Vo.apply(this,arguments)}function Ko(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ti(e)););return e}function Jo(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Qo(e,t)}function Qo(e,t){return Qo=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Qo(e,t)}function Xo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=ti(e);if(t){var a=ti(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return ei(this,r)}}function ei(e,t){if(t&&("object"===Fo(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function ti(e){return ti=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ti(e)}var ri=function(t){Jo(x,Application);var r,n,a,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k=Xo(x);function x(e){var t;return $o(this,x),(t=k.call(this,e)).adventures=[],t.books=[],t.rshs=[],t}return Yo(x,[{key:"_getHeaderButtons",value:function(){var e,t=this,r=Vo(ti(x.prototype),"_getHeaderButtons",this).call(this);return r.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:(e=qo(Ho().mark((function e(r){return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t._showBooks());case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),r}},{key:"_render",value:(w=qo(Ho().mark((function e(){var t,r,n=arguments;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]&&n[0],r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=4,Vo(ti(x.prototype),"_render",this).call(this,t,r);case 4:$(this._element).find(".library").attr("data-tooltip",game.i18n.localize("Book.home"));case 5:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"_showBooks",value:function(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!1,this.currentType=void 0,this.loadPage(this._element)}},{key:"toggleBookVisibility",value:(b=qo(Ho().mark((function e(t,r,n){var a,o,i,s,c,u,l;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(a=game.settings.get("dsa5","expansionPermissions"))[t]=n,e.next=4,game.settings.set("dsa5","expansionPermissions",a);case 4:return o=this[r].find((function(e){return e.id==t})),e.next=7,fetch(o.path);case 7:return e.next=9,e.sent.json();case 9:i=e.sent,s=0,c=["actors","journal","scenes"];case 12:if(!(s<c.length)){e.next=22;break}if(u=c[s],i[u]){e.next=16;break}return e.abrupt("continue",19);case 16:return l=game.packs.get(i[u]),e.next=19,l.configure({private:!n});case 19:s++,e.next=12;break;case 22:this.render();case 23:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return b.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;Vo(ti(x.prototype),"activateListeners",this).call(this,e),e.on("click",".toggleVisibility",function(){var e=qo(Ho().mark((function e(r){var n,a,o;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=r.currentTarget.dataset.itemid,a=r.currentTarget.dataset.type,o=$(r.currentTarget).find("i").hasClass("fa-toggle-off"),t.toggleBookVisibility(n,a,o);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("click",".showMapNote",(function(e){game.journal.get(e.currentTarget.dataset.entryid).panToNote()})),e.on("search keyup",".filterJournals",(function(e){t.filterToc($(e.currentTarget).val())})),e.on("click",".loadBook",(function(r){t.selectedChapter=void 0,t.selectedType=void 0,t.content=void 0,t.loadBook($(r.currentTarget).text(),e,$(r.currentTarget).attr("data-type"))})),e.on("click",".getChapter",(function(r){t.selectedType=$(r.currentTarget).closest(".toc").attr("data-type"),t.selectedChapter=$(r.currentTarget).attr("data-id"),t.content=void 0,t.loadPage(e)})),e.on("click",".subChapter",(function(e){var r=$(e.currentTarget).text(),n=$(e.currentTarget).attr("data-jid");n?t.loadJournalById(n):($(t._element).find(".subChapter").removeClass("selected"),$(t._element).find('[data-id="'.concat(r,'"]')).addClass("selected"),t.loadJournal(r))})),I.Z.bindRollCommands(e),e.find(".tocCollapser").click((function(t){$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")})),e.on("mousedown",".openPin",function(){var e=qo(Ho().mark((function e(r){var n;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.currentTarget.dataset.uuid,0!=r.button){e.next=9;break}return e.t0=t,e.next=5,fromUuid(n);case 5:e.t1=e.sent,e.t0.showJournal.call(e.t0,e.t1),e.next=10;break;case 9:2==r.button&&t.unpinJournal(n);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("click",".showJournal",(function(e){t.popJournal($(e.currentTarget).closest("h1").attr("data-uuid"))})),e.on("click",".pinJournal",(function(e){var r=$(e.currentTarget).closest("h1"),n=r.attr("data-uuid"),a=r.text();t.pinJournal(n,a)})),e.on("click",".activateScene",(function(e){t.showSzene($(e.currentTarget).attr("data-id"),$(e.currentTarget).attr("data-mode"))})),e.on("click",".fulltextsearch",(function(r){t.fulltextsearch=!t.fulltextsearch,$(r.currentTarget).toggleClass("on"),t.filterToc(e.find(".filterJournals").val())})),e.on("mousedown",".chapter img",(function(e){var r=t.book.id;2==e.button&&game.dsa5.apps.DSA5_Utility.showArtwork({name:r,uuid:"",img:$(e.currentTarget).attr("src")})})),i.Z.bindButtons(e),e.on("click",".chat-condition",(function(e){o.Z.postStatus($(e.currentTarget).attr("data-id"))})),e.on("click",".importBook",qo(Ho().mark((function e(){return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.importBook());case 1:case"end":return e.stop()}}),e)})))),j(e),(0,L.Jp)(e,".breadcrumbs",this.resaveBreadCrumbs),this.heightFix()}},{key:"heightFix",value:function(){var e=$(this._element).find(".breadcrumbs").height();$(this._element).find(".col.seventy.scrollable").css({"margin-bottom":"".concat(e,"px")})}},{key:"loadJournal",value:(g=qo(Ho().mark((function e(t){var r=this;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.showJournal(this.journals.find((function(e){return e.name==t&&e.flags.dsa5.parent==r.selectedChapter})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"loadJournalById",value:(v=qo(Ho().mark((function e(t){return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.showJournal(this.journals.find((function(e){return e.id==t})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"resaveBreadCrumbs",value:(y=qo(Ho().mark((function e(t){var r,n,a,o;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={},n=Go(t.getElementsByTagName("div"));try{for(n.s();!(a=n.n()).done;)o=a.value,r[o.dataset.uuid]=o.innerText}catch(e){n.e(e)}finally{n.f()}return e.next=5,game.settings.set("dsa5","breadcrumbs",JSON.stringify(r));case 5:case"end":return e.stop()}}),e)}))),function(e){return y.apply(this,arguments)})},{key:"filterToc",value:(m=qo(Ho().mark((function e(t){var r,n;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==t){e.next=23;break}if(""==(t=t.toLowerCase().trim())){e.next=19;break}if(n=[],!this.fulltextsearch){e.next=14;break}if(this.journalIndex){e.next=9;break}return this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),e.next=9,this.journalIndex.add(this.journals.map((function(e){return new ai(e)})));case 9:return e.next=11,this.journalIndex.search(t);case 11:n=e.sent,e.next=15;break;case 14:n=this.journals.filter((function(e){return-1!=e.name.toLowerCase().trim().indexOf(t)}));case 15:n=n.map((function(e){return'<li class="fas fa-caret-right"><a data-jid="'.concat(e.id,'" class="subChapter">').concat(e.name,"</a></li>")})),$(this._element).find(".tocContent").html("<ul>".concat(n.join("\n"),"</ul>")),e.next=23;break;case 19:return e.next=21,this.getToc();case 21:r=e.sent,$(this._element).find(".adventureWizard > .row-section > .toc").html(r).find(".filterJournals").focus();case 23:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"showJournal",value:function(e){var t,r=this,n="",a=Go(e.pages);try{for(a.s();!(t=a.n()).done;){var o=t.value;"text"==o.type?n+=o.text.content:"image"==o.type?n+='<img src="'.concat(o.src,'"/>'):ui.notifications.warn("Page type ".concat(o.type," not supported by the journal browser yet"))}}catch(e){a.e(e)}finally{a.f()}var i=this.findSceneNote(e.getFlag("dsa5","initId"));this.content='<div><h1 class="journalHeader" data-uuid="'.concat(e.uuid,'">').concat(e.name,'<div class="jrnIcons">').concat(i,'<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>').concat(TextEditor.enrichHTML(n));var s=$(this._element).find(".chapter");s.html(this.content),j(s),s.find(".documentName-link, .entity-link").click((function(e){var t=$(e.currentTarget);r.bookData&&t.attr("data-pack")==r.bookData.journal&&(e.stopPropagation(),r.loadJournalById(t.attr("data-id")))}))}},{key:"findSceneNote",value:function(e){if(e){var t=game.journal.find((function(t){return t.getFlag("dsa5","initId")==e}));if(t&&t.sceneNote)return'<a class="showMapNote" data-entryId="'.concat(t.id,'"><i class="fas fa-map-pin"></i></a>')}return""}},{key:"importBook",value:(h=qo(Ho().mark((function e(){return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.user.isGM&&(new ni).render(this.bookData.moduleName);case 1:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"loadBook",value:(d=qo(Ho().mark((function e(t,r,n){var a=this;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n||(n=this.currentType),this.currentType=n,this.book=this[n].find((function(e){return e.id==t})),e.next=5,fetch(this.book.path).then(function(){var e=qo(Ho().mark((function e(t){return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(function(){var e=qo(Ho().mark((function e(t){var n,o;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a.bookData=t,n=game.packs.get(t.journal),e.next=4,n.getIndex();case 4:return e.sent,e.next=7,n.getDocuments();case 7:if(o=e.sent,a.journals=o,!t.actors){e.next=15;break}return n=game.packs.get(t.actors),e.next=13,n.getIndex();case 13:o=e.sent,a.actors=o;case 15:if(!t.scenes){e.next=21;break}return n=game.packs.get(t.scenes),e.next=19,n.getIndex();case 19:o=e.sent,a.scenes=o;case 21:a.loadPage(r);case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return d.apply(this,arguments)})},{key:"prefillActors",value:(p=qo(Ho().mark((function e(t){var r,n,a,o,i,s,c=this;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.actors){e.next=2;break}return e.abrupt("return",[]);case 2:return r=[],e.next=5,game.folders.contents.find((function(e){return e.name==game.i18n.localize("".concat(c.bookData.moduleName,".name"))&&"Actor"==e.type&&null==e.parent}));case 5:if(!(n=e.sent)){e.next=12;break}return e.next=9,game.folders.contents.find((function(e){var r;return e.name==t.name&&"Actor"==e.type&&(null===(r=e.parent)||void 0===r?void 0:r.id)==n.id}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=void 0;case 13:a=e.t0,o=Go(t.actors);try{for(s=function(){var e=i.value,t=a?game.actors.contents.find((function(t){var r;return t.name==e&&(null===(r=t.folder)||void 0===r?void 0:r.id)==a.id})):void 0,n=void 0,o=t?t.id:void 0;t||(t=c.actors.find((function(t){return t.name==e})),n=c.bookData.actors,o=t?t._id:void 0),r.push({name:e,actor:t,pack:n,id:o})},o.s();!(i=o.n()).done;)s()}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",r);case 17:case"end":return e.stop()}}),e)}))),function(e){return p.apply(this,arguments)})},{key:"popJournal",value:(f=qo(Ho().mark((function e(t){return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fromUuid(t);case 2:e.sent.sheet.render(!0);case 4:case"end":return e.stop()}}),e)}))),function(e){return f.apply(this,arguments)})},{key:"showSzene",value:(l=qo(Ho().mark((function e(t){var r,n,a=arguments;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>1&&void 0!==a[1]?a[1]:"activate",n=game.scenes.contents.find((function(e){return e.system.name==t}))){e.next=4;break}return e.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.sceneNotInitialized")));case 4:e.t0=r,e.next="activate"===e.t0?7:"view"===e.t0?9:"toggle"===e.t0?11:13;break;case 7:return n.activate(),e.abrupt("break",13);case 9:return n.view(),e.abrupt("break",13);case 11:return n.update({navigation:!n.system.navigation}),e.abrupt("break",13);case 13:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"getChapter",value:(u=qo(Ho().mark((function e(){var t,r,n,a,o,i,s,c=this;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.book){e.next=41;break}if(!this.content){e.next=3;break}return e.abrupt("return",this.content);case 3:if(!this.selectedChapter){e.next=36;break}if("prep"!=this.selectedChapter){e.next=14;break}t={initDescr:game.i18n.format("".concat(this.bookData.moduleName,".importContent"),{defaultText:game.i18n.localize("importDefault")})},r=this.bookData.modules,n=Go(r);try{for(n.s();!(a=n.n()).done;)(o=a.value).enabled=this.moduleEnabled(o.id)}catch(e){n.e(e)}finally{n.f()}return e.next=11,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_preparation.html",{modules:r,info:t});case 11:case 17:case 30:case 35:case 38:case 43:return e.abrupt("return",e.sent);case 14:if("foundryUsage"!=this.selectedChapter){e.next=18;break}return e.next=17,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_foundry.html");case 18:if(i=this.bookData.chapters.find((function(e){return e.name==c.selectedType})).content.find((function(e){return e.id==c.selectedChapter})),s=this.getSubChapters(),!i.scenes&&!i.actors&&0!=s.length){e.next=33;break}return e.t0=renderTemplate,e.t1=i,e.t2=this.getSubChapters(),e.next=26,this.prefillActors(i);case 26:return e.t3=e.sent,e.t4={chapter:e.t1,subChapters:e.t2,actors:e.t3},e.next=30,(0,e.t0)("systems/dsa5/templates/wizard/adventure/adventure_chapter.html",e.t4);case 33:return e.next=35,this.loadJournal(s[0].name);case 36:return e.next=38,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData});case 41:return e.next=43,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM});case 44:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"filterBooks",value:function(e){var t,r=game.settings.get("dsa5","expansionPermissions"),n=Go(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;null!=r[a.id]&&(a.visible=r[a.id])}}catch(e){n.e(e)}finally{n.f()}return game.user.isGM?e:e.filter((function(e){return null==e.visible||e.visible})).sort((function(e,t){return e.id.localeCompare(t.id)}))}},{key:"getSubChapters",value:function(){var e=this;return this.journals.filter((function(t){return t.flags.dsa5.parent==e.selectedChapter})).sort((function(e,t){return e.flags.dsa5.sort>t.flags.dsa5.sort?1:-1})).map((function(e){return{name:e.name,id:e.id}}))}},{key:"getToc",value:(c=qo(Ho().mark((function e(){var t,r,n,a,o,i=this;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=[],!this.book){e.next=29;break}if(t.push.apply(t,function(e){if(Array.isArray(e))return Bo(e)}(s=duplicate(this.bookData.chapters))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(s)||Zo(s)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),!this.selectedChapter){e.next=24;break}n=Go(t),e.prev=5,n.s();case 7:if((a=n.n()).done){e.next=14;break}if(o=a.value,!(r=o.content.find((function(e){return e.id==i.selectedChapter})))){e.next=12;break}return e.abrupt("break",14);case 12:e.next=7;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(5),n.e(e.t0);case 19:return e.prev=19,n.f(),e.finish(19);case 22:r.cssClass="selected",r.subChapters=this.getSubChapters();case 24:return e.next=26,renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_toc.html",{chapters:t,book:this.book,fulltextsearch:this.fulltextsearch?"on":""});case 26:return e.abrupt("return",e.sent);case 29:return e.abrupt("return",'<div class="libraryImg"></div>');case 30:case"end":return e.stop()}var s}),e,this,[[5,16,19,22]])}))),function(){return c.apply(this,arguments)})},{key:"loadPage",value:(s=qo(Ho().mark((function e(t){var r,n;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getChapter();case 2:return r=e.sent,e.next=5,this.getToc();case 5:n=e.sent,t.find(".toc").html(n),t.find(".chapter").html(r);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"getData",value:(a=qo(Ho().mark((function e(t){var r,n,a;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Vo(ti(x.prototype),"getData",this).call(this,t);case 2:return r=e.sent,e.next=5,this.getChapter();case 5:return n=e.sent,e.next=8,this.getToc();case 8:return a=e.sent,mergeObject(r,{adventure:this.bookData,currentChapter:n,breadcrumbs:this.renderBreadcrumbs(),toc:a}),e.abrupt("return",r);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"pinJournal",value:(n=qo(Ho().mark((function e(t,r){var n;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.readBreadCrumbs(),r){e.next=5;break}return e.next=4,fromUuid(t);case 4:r=e.sent.name;case 5:n[t]=r,game.settings.set("dsa5","breadcrumbs",JSON.stringify(n)),this.render(!0);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"unpinJournal",value:function(e){var t=this.readBreadCrumbs();delete t[e],game.settings.set("dsa5","breadcrumbs",JSON.stringify(t)),this.render(!0)}},{key:"_canDragDrop",value:function(e){return!0}},{key:"_onDrop",value:(r=qo(Ho().mark((function e(t){var r;return Ho().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=JSON.parse(t.dataTransfer.getData("text/plain")),e.next=7;break;case 4:return e.prev=4,e.t0=e.catch(0),e.abrupt("return",!1);case 7:"JournalEntry"==r.type&&this.pinJournal(r.pack?"Compendium.".concat(r.pack,".").concat(r.id):"JournalEntry.".concat(r.id));case 8:case"end":return e.stop()}}),e,this,[[0,4]])}))),function(e){return r.apply(this,arguments)})},{key:"readBreadCrumbs",value:function(){var e={};try{e=JSON.parse(game.settings.get("dsa5","breadcrumbs"))}catch(e){console.log("No Journalbrowser notes found")}return e}},{key:"renderBreadcrumbs",value:function(){var e=this.readBreadCrumbs(),t=Object.entries(e).map((function(e){return'<div data-tooltip="'.concat(e[1],'" data-uuid="').concat(e[0],'" class="openPin item">').concat(e[1],"</div>")}));return t.length>0?'<div id"breadcrumbs" class="breadcrumbs wrap row-section">'.concat(t.join(""),"</div>"):""}},{key:"moduleEnabled",value:function(t){return e.Z.moduleEnabled(t)}}],[{key:"defaultOptions",get:function(){var e=Vo(ti(x),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","noscrollWizard","bookWizardsheet"]),width:800,height:880,template:"systems/dsa5/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}},{key:"initHook",value:function(){x.wizard=new x,game.dsa5.apps.journalBrowser=x.wizard,Hooks.on("renderSidebarTab",(function(e,t){if("journal"==e.options.id){var r=$('<div class="header-actions action-buttons flexrow"></div>'),n=$('<button id="openJournalBrowser"><i class="fa fa-book"></i>'.concat(game.i18n.localize("Book.Wizard"),"</button>"));n.click((function(){x.wizard.render(!0)})),r.append(n),t.find(".header-actions:first-child").after(r)}}))}}]),x}();!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(ri,"wizard",void 0);var ni=function(e){Jo(r,FormApplication);var t=Xo(r);function r(){return $o(this,r),t.apply(this,arguments)}return Yo(r,[{key:"render",value:function(e){new game.dsa5.apps.DSA5Initializer("DSA5 Module Initialization",game.i18n.format("".concat(e,".importContent"),{defaultText:game.i18n.localize("importDefault")}),e,game.i18n.lang).render(!0)}}]),r}(),ai=function(){function e(t){$o(this,e);var r=t.pages.find((function(e){return!0})).text.content;this.document={name:t.name,data:$("<div>").html(r).text(),id:t.id}}return Yo(e,[{key:"name",get:function(){return this.document.name}},{key:"data",get:function(){return this.document.data}},{key:"id",get:function(){return this.document.id}}]),e}();function oi(e){return oi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},oi(e)}function ii(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(e,t)||ci(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function si(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=ci(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function ci(e,t){if(e){if("string"==typeof e)return li(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?li(e,t):void 0}}function li(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function fi(){fi=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==oi(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function pi(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function di(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){pi(o,n,a,i,s,"next",e)}function s(e){pi(o,n,a,i,s,"throw",e)}i(void 0)}))}}function hi(){return hi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=mi(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},hi.apply(this,arguments)}function mi(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=wi(e)););return e}function yi(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&vi(e,t)}function vi(e,t){return vi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},vi(e,t)}function gi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=wi(e);if(t){var a=wi(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return bi(this,r)}}function bi(e,t){if(t&&("object"===oi(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function wi(e){return wi=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},wi(e)}function ki(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _i(e,t,r){return t&&xi(e.prototype,t),r&&xi(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var Oi=function(){function t(){ki(this,t)}return _i(t,null,[{key:"registerButtons",value:function(){game.dsa5.apps.playerMenu=new aa,CONFIG.Canvas.layers.dsamenu={layerClass:Ei,group:"interface"},Hooks.on("getSceneControlButtons",(function(t){var r=[{name:"JournalBrowser",title:game.i18n.localize("Book.Wizard"),icon:"fa fa-book",button:!0,onClick:function(){e.Z.renderToggle(game.dsa5.apps.journalBrowser)}},{name:"Library",title:game.i18n.localize("SHEET.Library"),icon:"fas fa-university",button:!0,onClick:function(){e.Z.renderToggle(game.dsa5.itemLibrary)}},{name:"PlayerMenu",title:game.i18n.localize("PLAYER.title"),icon:"fas fa-dsa5-player",button:!0,onClick:function(){e.Z.renderToggle(game.dsa5.apps.playerMenu)}}];game.user.isGM&&(game.dsa5.apps.gameMasterMenu||(game.dsa5.apps.gameMasterMenu=new Si),r.push({name:"mastersMenu",title:game.i18n.localize("gmMenu"),icon:"fa fa-dsa5",button:!0,onClick:function(){e.Z.renderToggle(game.dsa5.apps.gameMasterMenu)}})),t.push({name:"GM Menu",title:game.i18n.localize("gmMenu"),icon:"fas fa-dsa5",layer:"dsamenu",tools:r})}))}}]),t}(),Ei=function(e){yi(r,InteractionLayer);var t=gi(r);function r(){return ki(this,r),t.apply(this,arguments)}return _i(r,[{key:"selectObjects",value:function(e){canvas.tokens.selectObjects(e)}}],[{key:"layerOptions",get:function(){return foundry.utils.mergeObject(hi(wi(r),"layerOptions",this),{name:"dsamenu",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}}]),r}(),Si=function(t){yi(g,Application);var n,a,o,i,s,c,u,l,f,p,d,h,m,y,v=gi(g);function g(e){var t;return ki(this,g),(t=v.call(this,e)).selected={},t.heros=[],t.lastSkill="".concat(game.i18n.localize("LocalizedIDs.perception"),"|skill"),t.randomCreation=[],game.user.isGM&&(Hooks.on("updateActor",function(){var e=di(fi().mark((function e(r,n,a,o){var i;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=["system.status.fatePoints","system.status.wounds","system.status.karmaenergy","system.status.astralenergy"],t.heros.find((function(e){return e.id==r.id}))&&i.reduce((function(e,t){return e||hasProperty(n,t)}),!1)&&t.render();case 2:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}()),Hooks.on("updateScene",function(){var e=di(fi().mark((function e(r,n,a,o){var i;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=["darkness"],game.canvas.id==r.id&&i.reduce((function(e,t){return e||hasProperty(n,t)}),!1)&&(game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.onDarknessChange(),t.render());case 2:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}()),Hooks.on("canvasInit",(function(){t.render()}))),t}return _i(g,[{key:"_render",value:(y=di(fi().mark((function e(){var t,r,n=arguments;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.length>0&&void 0!==n[0]&&n[0],r=n.length>1&&void 0!==n[1]?n[1]:{},game.user.isGM){e.next=4;break}return e.abrupt("return",ui.notifications.error("DSAError.onlyGMallowed"));case 4:return e.next=6,hi(wi(g.prototype),"_render",this).call(this,t,r);case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;hi(wi(g.prototype),"activateListeners",this).call(this,e),e.find("select.select2").select2(),e.find(".heroLink").click((function(e){e.stopPropagation(),game.actors.get(t.getID(e)).sheet.render(!0)})),e.find(".heroSelector").change((function(e){e.stopPropagation(),t.selected[t.getID(e)]=$(e.currentTarget).is(":checked")})),e.find(".skillSelektor").change((function(e){e.stopPropagation(),t.lastSkill=$(e.currentTarget).val()})),e.find(".rollChar").click((function(e){e.stopPropagation(),t.rollAbility([t.getID(e)])})),e.find(".rollAll").click((function(e){e.stopPropagation(),t.rollAbility(t.selectedIDs())})),e.find(".pay").click((function(e){e.stopPropagation(),t.doPayment([t.getID(e)],!0)})),e.find(".actorItem").click(function(){var e=di(fi().mark((function e(t){var r;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.stopPropagation(),r=$(t.currentTarget).attr("data-uuid"),e.next=4,fromUuid(r);case 4:e.sent.sheet.render(!0);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".getPaid").click((function(e){e.stopPropagation(),t.doPayment([t.getID(e)],!1)})),e.find(".payAll").click((function(e){e.stopPropagation(),t.doPayment(t.selectedIDs(e),!0)})),e.find(".getPaidAll").click((function(e){e.stopPropagation(),t.doPayment(t.selectedIDs(e),!1)})),e.find(".selectAll").change((function(t){t.stopPropagation();var r=e.find(".heroSelector");r.prop("checked",$(t.currentTarget).is(":checked")),r.change()})),e.find(".exp").click((function(e){e.stopPropagation(),t.getExp([t.getID(e)])})),e.find(".expAll").click((function(e){e.stopPropagation(),t.getExp(t.selectedIDs())})),e.find(".randomPlayer").mousedown((function(r){r.stopPropagation(),t.randomPlayer(e,r)})),e.find(".heroSelector").click((function(e){return e.stopPropagation()})),e.find(".hero").click((function(e){e.stopPropagation(e),$(e.currentTarget).find(".expandDetails").fadeToggle()}));var r=function(e){return t._deleteHero(e)};e.find(".hero").mouseenter((function(e){if(0==e.currentTarget.getElementsByClassName("hovermenu").length){var t=document.createElement("div");t.classList.add("hovermenu");var n=document.createElement("i");n.classList.add("fas","fa-times"),n.title=game.i18n.localize("SHEET.DeleteItem"),n.addEventListener("click",r,!1),t.appendChild(n),e.currentTarget.appendChild(t)}})),e.find(".hero").mouseleave((function(e){var r=e.toElement||e.relatedTarget;r&&r.parentNode!=t&&r!=t&&e.currentTarget.querySelectorAll(".hovermenu").forEach((function(e){return e.remove()}))})),e.find(".addGroupSchip").click(function(){var e=di(fi().mark((function e(r){return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.changeGroupSchipCount(Number($(r.currentTarget).attr("data-value")));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".groupschip").click((function(e){t.changeGroupSchip(e)})),e.find(".heroschip").click((function(e){e.stopPropagation(),e.preventDefault();var r=Number(e.currentTarget.getAttribute("data-val"));1==r&&1==$(e.currentTarget).closest(".hero").find(".fullSchip").length&&(r=0),game.actors.get(t.getID(e)).update({"system.status.fatePoints.value":r})})),e.find(".groupCheck").click((function(e){e.stopPropagation(),t.doGroupCheck()})),e.find(".changeSetting").change(function(){var e=di(fi().mark((function e(t){return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,game.settings.set("dsa5",t.currentTarget.name,t.currentTarget.checked);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".changeSightTreshold").change(function(){var e=di(fi().mark((function e(r){return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:$(r.currentTarget).closest(".row-section").find(".range-value").text(r.currentTarget.value),t.updateSightThreshold(r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".updateDarkness").change(function(){var e=di(fi().mark((function e(r){return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:$(r.currentTarget).closest(".row-section").find(".range-value").text(r.currentTarget.value),t.updateDarkness(r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());var n,a=si(this.randomCreation);try{for(a.s();!(n=a.n()).done;)n.value.activateListeners(e)}catch(e){a.e(e)}finally{a.f()}(0,L.Jp)(e,".heros",this.updateHeroOrder,".hero"),e.on("dragstart",".hero",(function(e){e.stopPropagation();var t={type:"Actor",uuid:e.currentTarget.dataset.uuid};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(t))})),e.find(".dragEveryone").each((function(e,t){t.setAttribute("draggable",!0)})),e.on("dragstart",".dragEveryone",(function(e){e.stopPropagation(),e.currentTarget;var r={type:"GroupDrop",ids:t.selectedIDs()};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(r))})),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.activateButtonListener(e)}},{key:"_deleteHero",value:(m=di(fi().mark((function e(t){var r,n,a;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.stopPropagation(),t.preventDefault(),r=$(t.currentTarget).closest(".hero").attr("data-id"),n=game.settings.get("dsa5","trackedActors").actors||[],!((a=n.indexOf(r))>-1)){e.next=10;break}return n.splice(a,1),e.next=9,game.settings.set("dsa5","trackedActors",{actors:n});case 9:this.render(!0);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"updateHeroOrder",value:(h=di(fi().mark((function e(t){var r,n,a,o;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],n=si(t.querySelectorAll(".hero"));try{for(n.s();!(a=n.n()).done;)o=a.value,r.push(o.dataset.id)}catch(e){n.e(e)}finally{n.f()}return e.next=5,game.settings.set("dsa5","trackedActors",{actors:r});case 5:case"end":return e.stop()}}),e)}))),function(e){return h.apply(this,arguments)})},{key:"updateDarkness",value:(d=di(fi().mark((function e(t){return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:canvas.scene&&canvas.scene.update({darkness:Number(t.currentTarget.value)},{animateDarkness:3e3});case 1:case"end":return e.stop()}}),e)}))),function(e){return d.apply(this,arguments)})},{key:"updateSightThreshold",value:(p=di(fi().mark((function e(t){var r,n,a;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Number(t.currentTarget.dataset.index),n=Number(t.currentTarget.value),(a=game.settings.get("dsa5","sightOptions").split("|"))[r]=n,e.next=6,game.settings.set("dsa5","sightOptions",a.join("|"));case 6:case"end":return e.stop()}}),e)}))),function(e){return p.apply(this,arguments)})},{key:"getGroupSchipSetting",value:function(){return game.settings.get("dsa5","groupschips").split("/").map((function(e){return Number(e)}))}},{key:"changeGroupSchipCount",value:(f=di(fi().mark((function e(t){var r;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=this.getGroupSchipSetting())[1]=Math.max(0,r[1]+t),r[0]=Math.min(r[1],r[0]),e.next=5,game.settings.set("dsa5","groupschips",r.join("/"));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"changeGroupSchip",value:(l=di(fi().mark((function e(t){var r,n;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return 1==(r=Number(t.currentTarget.getAttribute("data-val")))&&1==$(t.currentTarget).closest(".col").find(".fullSchip").length&&(r=0),(n=this.getGroupSchipSetting())[0]=r,e.next=6,game.settings.set("dsa5","groupschips",n.join("/"));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"randomPlayer",value:(u=di(fi().mark((function e(t,n){var a,o,i,s,c,u,l,f,p,d=this;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.find(".hero"),o=2==n.button,i={},s=1,c=t.find(".heroSelector:checked").length>0,u=si(this.heros),e.prev=6,u.s();case 8:if((l=u.n()).done){e.next=17;break}if(f=l.value,this.selected[f.id]||!c){e.next=12;break}return e.abrupt("continue",15);case 12:i[s]=f.id,s++,o&&r.Z.hasVantage(f,game.i18n.localize("LocalizedIDs.misfortune"))&&(i[s]=f.id,s++);case 15:e.next=8;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(6),u.e(e.t0);case 22:return e.prev=22,u.f(),e.finish(22);case 25:return e.next=27,new Roll("1d".concat(s-1)).evaluate({async:!0});case 27:p=e.sent.total,$(n.currentTarget).find("i").addClass("fa-spin"),a.removeClass("victim"),setTimeout((function(){$(d._element).find('.hero[data-id="'.concat(i[p],'"]')).addClass("victim"),$(n.currentTarget).find("i").removeClass("fa-spin")}),500);case 31:case"end":return e.stop()}}),e,this,[[6,19,22,25]])}))),function(e,t){return u.apply(this,arguments)})},{key:"doPayment",value:(c=di(fi().mark((function e(t,r){var n,a,o,i;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=game.actors.filter((function(e){return t.includes(e.id)})),a=this.getNames(n),e.next=4,renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format(r?"MASTER.payText":"MASTER.getPaidText",{heros:a}))});case 4:o=e.sent,i=function(e){var t,a=e.find(".input-text").val(),o=si(n);try{for(o.s();!(t=o.n()).done;){var i=t.value;un.handlePayAction(void 0,r,a,i)}}catch(e){o.e(e)}finally{o.f()}},this.buildDialog(game.i18n.localize(r?"MASTER.payTT":"PAYMENT.payButton"),o,i);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"getPaid",value:(s=di(fi().mark((function e(t){return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.doPayment(t,!1);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"getExp",value:(i=di(fi().mark((function t(r){var n,a,o,i=this;return fi().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=game.actors.filter((function(e){return r.includes(e.id)})),t.next=3,renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.awardXPText",{heros:this.getNames(n)}))});case 3:a=t.sent,o=function(){var t=di(fi().mark((function t(r){var a,o,s,c,u,l,f,p;return fi().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=Number(r.find(".input-text").val()),o=Math.max(1,Math.round(.25*a)),s=[],c=[],isNaN(a)){t.next=30;break}u=si(n),t.prev=6,u.s();case 8:if((l=u.n()).done){t.next=16;break}return f=l.value,p=a,P.Z.isFamiliar(f)||P.Z.isPet(f)?(p=o,c.push(f)):s.push(f),t.next=14,f.update({"system.details.experience.total":f.system.details.experience.total+p});case 14:t.next=8;break;case 16:t.next=21;break;case 18:t.prev=18,t.t0=t.catch(6),u.e(t.t0);case 21:return t.prev=21,u.f(),t.finish(21);case 24:if(!(s.length>0)){t.next=27;break}return t.next=27,ChatMessage.create(e.Z.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:i.getNames(s),number:a})));case 27:if(!(c.length>0)){t.next=30;break}return t.next=30,ChatMessage.create(e.Z.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:i.getNames(c),number:a})));case 30:case"end":return t.stop()}}),t,null,[[6,18,21,24]])})));return function(e){return t.apply(this,arguments)}}(),this.buildDialog(game.i18n.localize("MASTER.awardXP"),a,o);case 6:case"end":return t.stop()}}),t,this)}))),function(e){return i.apply(this,arguments)})},{key:"getNames",value:function(e){return e.map((function(e){return e.name})).join(", ")}},{key:"buildDialog",value:function(e,t,r){new Dialog({title:e,content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(e){r(e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}},{key:"_canDragDrop",value:function(e){return!0}},{key:"_onDrop",value:(o=di(fi().mark((function e(t){var r,n;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=JSON.parse(t.dataTransfer.getData("text/plain")),e.next=4,Actor.implementation.fromDropData(r);case 4:r=e.sent,e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",!1);case 10:if("Actor"!=r.documentName){e.next=18;break}if(-1!=(n=(n=game.settings.get("dsa5","trackedActors")).actors||[]).indexOf(r.id)||r.pack){e.next=18;break}return n.push(r.id),e.next=17,game.settings.set("dsa5","trackedActors",{actors:n});case 17:this.render(!0);case 18:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e){return o.apply(this,arguments)})},{key:"selectedIDs",value:function(){for(var e=[],t=0,r=Object.entries(this.selected);t<r.length;t++){var n=ii(r[t],2),a=n[0];n[1]&&e.push(a)}return e.length?e:game.settings.get("dsa5","trackedActors").actors||[]}},{key:"doGroupCheck",value:(a=di(fi().mark((function e(){var t,r,n,a,o,i=this;return fi().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.lastSkill.split("|"),r=ii(t,2),n=r[0],"skill"==r[1]){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.doGroupCheck",{skill:n}))});case 5:a=e.sent,o=function(e){var t=Number(e.find(".input-text").val()),r=ii(i.lastSkill.split("|"),2),n=r[0];"skill"==r[1]&&sa.Z.showGCMessage(n,t)},this.buildDialog(game.i18n.localize("HELP.groupcheck"),a,o);case 8:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"rollAbility",value:function(e){var t=ii(this.lastSkill.split("|"),2),r=t[0];switch(t[1]){case"skill":this.rollSkill(e,r);break;case"attribute":this.rollAttribute(e,r);break;case"regeneration":this.rollRegeneration(e)}}},{key:"rollRegeneration",value:function(e){var t,r=si(game.actors.filter((function(t){return e.includes(t.id)})));try{var n=function(){var e=t.value;e.setupRegeneration("regenerate",{rollMode:"blindroll",subtitle:" (".concat(e.name,")")},void 0).then((function(t){e.basicTest(t)}))};for(r.s();!(t=r.n()).done;)n()}catch(e){r.e(e)}finally{r.f()}}},{key:"rollAttribute",value:function(e,t){var r,n=game.actors.filter((function(t){return e.includes(t.id)})),a=Object.keys(game.dsa5.config.characteristics).find((function(e){return game.i18n.localize(game.dsa5.config.characteristics[e])==t})),o=si(n);try{var i=function(){var e=r.value;e.setupCharacteristic(a,{rollMode:"blindroll",subtitle:" (".concat(e.name,")")},void 0).then((function(t){e.basicTest(t)}))};for(o.s();!(r=o.n()).done;)i()}catch(e){o.e(e)}finally{o.f()}}},{key:"rollSkill",value:function(e,t){var r,n=si(game.actors.filter((function(t){return e.includes(t.id)})));try{var a=function(){var e=r.value,n=e.items.find((function(e){return e.name==t&&"skill"==e.type}));e.setupSkill(n,{rollMode:"blindroll",subtitle:" (".concat(e.name,")")},void 0).then((function(t){e.basicTest(t)}))};for(n.s();!(r=n.n()).done;)a()}catch(e){n.e(e)}finally{n.f()}}},{key:"getID",value:function(e){return $(e.currentTarget).closest(".hero").attr("data-id")}},{key:"getData",value:(n=di(fi().mark((function t(r){var n,a,o,i,s,c,u,l,f,p,d,h,m,y,v;return fi().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,hi(wi(g.prototype),"getData",this).call(this,r);case 2:if(n=t.sent,a=game.settings.get("dsa5","trackedActors"),o=[],!(a.actors&&a.actors.length>0)){t.next=9;break}o=game.actors.filter((function(e){return a.actors.includes(e.id)})).sort((function(e,t){return a.actors.indexOf(e.id)-a.actors.indexOf(t.id)})),t.next=12;break;case 9:return o=game.actors.filter((function(e){return e.hasPlayerOwner})),t.next=12,game.settings.set("dsa5","trackedActors",{actors:o.map((function(e){return e.id}))});case 12:for(i=this.getGroupSchipSetting(),s=[],c=1;c<=i[1];c++)s.push({value:c,cssClass:c<=i[0]?"fullSchip":"emptySchip"});u=game.settings.get("dsa5","sightOptions").split("|"),l=/ \[[a-zA-Z\d-]+\]/,f=[1,2,3,4].map((function(e){return{label:game.i18n.localize("VisionDisruption.step".concat(e)).replace(l,""),value:u[e-1]}})),n.sceneConfig={sceneAutomationEnabled:game.settings.get("dsa5","sightAutomationEnabled"),enableDPS:game.settings.get("dsa5","enableDPS"),visions:f,darkness:canvas.scene?canvas.scene.darkness:0},this.heros=o,p=si(o);try{for(p.s();!(d=p.n()).done;){for((h=d.value).gmSelected=this.selected[h.id],m=[],y=1;y<=Number(h.system.status.fatePoints.max);y++)m.push({value:y,cssClass:y<=Number(h.system.status.fatePoints.value)?"fullSchip":"emptySchip"});h.schips=m,h.purse=h.items.filter((function(e){return"money"==e.type})).sort((function(e,t){return t.system.price.value-e.system.price.value})).map((function(e){return'<span data-tooltip="'.concat(game.i18n.localize(e.name),'">').concat(e.system.quantity.value,"</span>")})).join(" - "),h.advantages=h.items.filter((function(e){return"advantage"==e.type})).map((function(e){return{name:e.name,uuid:e.uuid}})),h.disadvantages=h.items.filter((function(e){return"disadvantage"==e.type})).map((function(e){return{name:e.name,uuid:e.uuid}}))}}catch(e){p.e(e)}finally{p.f()}if(this.abilities){t.next=27;break}return t.next=25,e.Z.allSkillsList();case 25:v=t.sent,this.abilities=v.map((function(e){return{name:e,type:"skill"}})).concat(Object.values(game.dsa5.config.characteristics).map((function(e){return{name:game.i18n.localize(e),type:"attribute"}})).concat({name:game.i18n.localize("regenerate"),type:"regeneration"})).sort((function(e,t){return e.name.localeCompare(t.name)}));case 27:if(t.t0=mergeObject,t.t1=n,t.t2=o,t.t3=this.abilities,t.t4=s,t.t5=this.lastSkill,t.t6=this.randomCreation.map((function(e){return e.template})),!game.dsa5.apps.LightDialog){t.next=40;break}return t.next=37,game.dsa5.apps.LightDialog.getButtonHTML();case 37:t.t7=t.sent,t.next=41;break;case 40:t.t7="";case 41:return t.t8=t.t7,t.t9={heros:t.t2,abilities:t.t3,groupschips:t.t4,lastSkill:t.t5,randomCreation:t.t6,lightButton:t.t8},(0,t.t0)(t.t1,t.t9),t.abrupt("return",n);case 45:case"end":return t.stop()}}),t,this)}))),function(e){return n.apply(this,arguments)})},{key:"registerRandomCreation",value:function(e){this.randomCreation.push(e)}}],[{key:"defaultOptions",get:function(){var e=hi(wi(g),"defaultOptions",this);return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","masterMenu"]),width:470,height:740,title:game.i18n.localize("gmMenu"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/mastermenu.html",e.resizable=!0,e}}]),g}();function Li(e){return Li="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Li(e)}function Ti(){Ti=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Li(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Di(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Pi(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Di(o,n,a,i,s,"next",e)}function s(e){Di(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Ai(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ji=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,null,r=[{key:"showOneMessage",value:(n=Pi(Ti().mark((function e(){return Ti().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.settings.get("dsa5","disableDidYouKnow")){e.next=2;break}return e.abrupt("return");case 2:fetch("systems/dsa5/lazy/didyouknow/".concat(game.i18n.lang,".json")).then(function(){var e=Pi(Ti().mark((function e(t){return Ti().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(function(){var e=Pi(Ti().mark((function e(t){var r,n;return Ti().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.data[Math.floor(Math.random()*t.data.length)],e.next=3,renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:r});case 3:n=e.sent,$("body").append(n),$(".didYouKnow").click((function(){return $(".didYouKnow").remove()})),$(".didYouKnow").fadeIn(),setTimeout((function(){$(".didYouKnow").fadeOut(1e3,(function(){return $(".didYouKnow").remove()}))}),4e3);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})}],r&&Ai(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function Ci(e){return Ci="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ci(e)}function Ii(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Mi(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Mi(e,t){if(e){if("string"==typeof e)return Ni(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ni(e,t):void 0}}function Ni(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Ri(){Ri=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Ci(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function zi(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Fi(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){zi(o,n,a,i,s,"next",e)}function s(e){zi(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Gi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Zi(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Bi(e,t,r){return t&&Zi(e.prototype,t),r&&Zi(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Hi(){return Hi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Wi(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Hi.apply(this,arguments)}function Wi(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Vi(e)););return e}function qi(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&$i(e,t)}function $i(e,t){return $i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},$i(e,t)}function Ui(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=Vi(e);if(t){var a=Vi(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Yi(this,r)}}function Yi(e,t){if(t&&("object"===Ci(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Vi(e){return Vi=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Vi(e)}var Ki=function(e){qi(c,Application);var t,r,n,a,o,i,s=Ui(c);function c(e){var t;Gi(this,c),(t=s.call(this,e)).combatSkills=["selfControl","featOfStrength","bodyControl","perception"].map((function(e){return game.i18n.localize("LocalizedIDs.".concat(e))})),t.defaultSkills=[game.i18n.localize("LocalizedIDs.perception")];var r=function(e){var t=e.parent?e.parent.id:void 0;t&&c.hookUpdate(t)};return Hooks.on("controlToken",(function(e,r){t.updateDSA5Hotbar()})),Hooks.on("updateActor",(function(e,t){c.hookUpdate(e.id)})),Hooks.on("updateToken",(function(e,r,n){r._id==getProperty(game.dsa5.apps.tokenHotbar,"actor.prototypeToken.id")&&t.updateDSA5Hotbar()})),Hooks.on("updateOwnedItem",(function(e,t){c.hookUpdate(e.data.id)})),Hooks.on("createOwnedItem",(function(e,t){c.hookUpdate(e.data.id)})),Hooks.on("deleteOwnedItem",(function(e,t){c.hookUpdate(e.data.id)})),Hooks.on("updateItem",(function(e,t){r(e)})),Hooks.on("createItem",(function(e,t){r(e)})),Hooks.on("deleteItem",(function(e,t){r(e)})),t}return Bi(c,[{key:"resetPosition",value:function(){var e=$("#hotbar").first().position(),t=game.settings.get("dsa5","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}},{key:"_onWheelResize",value:(i=Fi(Ri().mark((function e(t){var r;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=game.settings.get("dsa5","tokenhotbarSize"),r=t.originalEvent.deltaY>0?Math.min(100,r+5):Math.max(15,r-5),e.next=4,game.settings.set("dsa5","tokenhotbarSize",r);case 4:return e.next=6,this.render(!0);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"_cycleLayout",value:(o=Fi(Ri().mark((function e(t){var r;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(2!=t.button){e.next=7;break}return 4==(r=game.settings.get("dsa5","tokenhotbarLayout")+1)&&(r=0),e.next=5,game.settings.set("dsa5","tokenhotbarLayout",r);case 5:return e.next=7,this.render(!0);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;Hi(Vi(c.prototype),"activateListeners",this).call(this,e);var r=e.find(".dragHandler");new Draggable(this,e,r[0],this.options.resizable),r.on("wheel",function(){var e=Fi(Ri().mark((function e(r){return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.stopPropagation(),r.preventDefault(),e.next=4,t._onWheelResize(r);case 4:return e.abrupt("return",!1);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),r.on("mousedown",function(){var e=Fi(Ri().mark((function e(r){return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._cycleLayout(r);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("mousedown","li",function(){var e=Fi(Ri().mark((function e(r){return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.stopPropagation(),e.next=3,t.executeQuickButton(r);case 3:return e.abrupt("return",!1);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.on("mouseenter","li",(function(t){var r=$(t.currentTarget);r.hasClass("primary")&&e.find('.secondary[data-category="'.concat(r.attr("data-category"),'"]')).addClass("shown")})),e.on("mouseleave","li",(function(t){var r=$(t.currentTarget);r.hasClass("primary")&&e.find('.secondary[data-category="'.concat(r.attr("data-category"),'"]')).removeClass("shown")})),e.on("mouseleave",".tokenQuickHot",(function(e){$(e.currentTarget).find(".secondary").removeClass("shown")}))}},{key:"executeQuickButton",value:(a=Fi(Ri().mark((function e(t){var r,n,a,o,i,s,c,u,l=this;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=canvas.tokens.controlled[0].actor,n=canvas.tokens.controlled[0].id,a=t.currentTarget.dataset.id,o=t.currentTarget.dataset.subfunction,e.t0=o,e.next="addEffect"===e.t0?7:"effect"===e.t0?9:"onUse"===e.t0?31:35;break;case 7:return Ji.showDialog(),e.abrupt("break",52);case 9:if(i=r.effects.get(a),s=i.getFlag("core","statusId"),0!=t.button){e.next=20;break}if(!s){e.next=17;break}return e.next=15,r.addCondition(s,1,!1,!1);case 15:e.next=18;break;case 17:i.sheet.render(!0);case 18:e.next=28;break;case 20:if(2!=t.button){e.next=28;break}if(!s){e.next=26;break}return e.next=24,r.removeCondition(s,1,!1);case 24:e.next=28;break;case 26:return e.next=28,r.sheet._deleteActiveEffect(a);case 28:return e.next=30,this.render(!0);case 30:return e.abrupt("break",52);case 31:return c=r.items.get(a),new A.Z(c).executeOnUseEffect(),e.abrupt("break",52);case 35:if("attackWeaponless"!=a){e.next=39;break}r.setupWeaponless("attack",{},n).then((function(e){r.basicTest(e)})),e.next=52;break;case 39:if(!(u=r.items.get(a))){e.next=52;break}e.t1=u.type,e.next="meleeweapon"===e.t1||"rangeweapon"===e.t1||"trait"===e.t1?44:"liturgy"===e.t1||"spell"===e.t1?46:"skill"===e.t1?48:"consumable"===e.t1?50:52;break;case 44:return r.setupWeapon(u,"attack",{},n).then((function(e){r.basicTest(e)})),e.abrupt("break",52);case 46:return r.setupSpell(u,{},n).then((function(e){r.basicTest(e)})),e.abrupt("break",52);case 48:return r.setupSkill(u,{},n).then((function(e){r.basicTest(e)})),e.abrupt("break",52);case 50:return new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+u.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+u.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){var e=Fi(Ri().mark((function e(){return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.setupEffect(null,{},n);case 2:return e.next=4,l.updateDSA5Hotbar();case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0),e.abrupt("break",52);case 52:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"subWidth",value:function(e,t){return'style="width:'.concat(Math.ceil(e.length/3)*t,'px"')}},{key:"getData",value:(n=Fi(Ri().mark((function e(){var t,r,n,a,o,i,s,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E,S,L;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Hi(Vi(c.prototype),"getData",this).call(this);case 2:if(t=e.sent,r=this.actor,n={attacks:[],spells:[],default:[],skills:[]},i=[],s=[],u=[],l=game.settings.get("dsa5","tokenhotbarLayout"),f=l%2,p=c.defaultOptions.itemWidth,!r){e.next=22;break}return d=[],e.next=15,r.actorEffects();case 15:if(u=e.sent.map((function(e){return{name:e.label,id:e.id,icon:e.icon,cssClass:"effect",abbrev:"".concat(e.label[0]," ").concat(e.getFlag("dsa5","value")||""),subfunction:"effect"}})),game.combat){n.attacks.push({name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",icon:"systems/dsa5/icons/categories/attack_weaponless.webp"}),h=["meleeweapon","rangeweapon"],m=["meleeAttack","rangeAttack"],y=["liturgy","spell"],v=Ii(r.items);try{for(v.s();!(g=v.n()).done;)b=g.value,h.includes(b.type)&&1==b.system.worn.value||"trait"==b.type&&m.includes(b.system.traitType.value)?n.attacks.push({name:b.name,id:b.id,icon:b.img,cssClass:"",abbrev:b.name[0]}):y.includes(b.type)?b.system.effectFormula.value?n.spells.push({name:b.name,id:b.id,icon:b.img,cssClass:"spell",abbrev:b.name[0]}):d.push({name:b.name,id:b.id,icon:b.img,cssClass:"spell",abbrev:b.name[0]}):["skill"].includes(b.type)&&this.combatSkills.includes(b.name)?n.default.push({name:"".concat(b.name," (").concat(b.system.talentValue.value,")"),id:b.id,icon:b.img,cssClass:"skill",abbrev:b.name[0]}):"consumable"==b.type&&i.push({name:b.name,id:b.id,icon:b.img,cssClass:"consumable",abbrev:b.system.quantity.value}),b.getFlag("dsa5","onUseEffect")&&s.push({name:b.name,id:b.id,icon:b.img,cssClass:"onUse",abbrev:b.name[0],subfunction:"onUse"})}catch(e){v.e(e)}finally{v.f()}a=i.pop()}else{k=[],x=Ii(r.items);try{for(x.s();!(_=x.n()).done;)O=_.value,["skill"].includes(O.type)&&this.defaultSkills.includes(O.name)?n.default.push({name:"".concat(O.name," (").concat(O.system.talentValue.value,")"),id:O.id,icon:O.img,cssClass:"skill",abbrev:O.name[0]}):["skill"].includes(O.type)&&!this.defaultSkills.includes(O.name)&&O.system.talentValue.value>0&&k.push({name:"".concat(O.name," (").concat(O.system.talentValue.value,")"),id:O.id,icon:O.img,cssClass:"skill",abbrev:O.name[0],tw:O.system.talentValue.value}),O.getFlag("dsa5","onUseEffect")&&s.push({name:O.name,id:O.id,icon:O.img,cssClass:"onUse",abbrev:O.name[0],subfunction:"onUse"})}catch(e){x.e(e)}finally{x.f()}(w=n.skills).push.apply(w,function(e){if(Array.isArray(e))return Ni(e)}(T=k.sort((function(e,t){return t.tw-e.tw})).slice(0,10))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(T)||Mi(T)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())}o=s.pop(),0==n.spells.length&&d.length>0&&n.spells.push(d.pop()),n.spells.length>0&&d.length>0&&(n.spells[0].more=d.sort((function(e,t){return e.name.localeCompare(t.name)})),n.spells[0].subwidth=this.subWidth(d,p)),a&&(i.length>0&&(a.more=i,a.subwidth=this.subWidth(i,p)),n.consumables=[a]),o&&(s.length>0&&(o.more=s,o.subwidth=this.subWidth(s,p)),n.onUsages=[o]);case 22:return this.showEffects&&(E=game.i18n.localize("CONDITION.add"),S={name:E,id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:E[0],subfunction:"addEffect"},u.length>0&&(S.more=u,S.subwidth=this.subWidth(u,p)),n.effects=[S]),L=Object.keys(n).reduce((function(e,t){return e+n[t].length}),0),f?(this.position.width=p,this.position.height=p*L+14):(this.position.width=p*L+14,this.position.height=p),mergeObject(t,{items:n,itemWidth:p,direction:l,count:L}),e.abrupt("return",t);case 27:case"end":return e.stop()}var T}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"render",value:(r=Fi(Ri().mark((function e(t){var r,n,a=arguments;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]?a[1]:{},e.next=3,Hi(Vi(c.prototype),"render",this).call(this,t,r);case 3:return n=e.sent,this._element&&this._element.css({zIndex:61}),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setPosition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.left,r=e.top,n=e.width,a=e.height,o=e.scale,i=Hi(Vi(c.prototype),"setPosition",this).call(this,{left:t,top:r,width:n,height:a,scale:o}),s=this.element[0];if(!s.style.width||n){var u=n||s.offsetWidth,l=s.style.maxWidth||window.innerWidth;i.width=n=Math.clamped(u,0,l),s.style.width=n+"px",n+i.left>window.innerWidth&&(t=i.left)}return game.settings.set("dsa5","tokenhotbarPosition",{left:i.left,top:i.top}),i}},{key:"updateDSA5Hotbar",value:(t=Fi(Ri().mark((function e(){var t,r;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=canvas.tokens.controlled,this.actor=void 0,this.showEffects=!1,1===t.length&&(r=t[0].actor)&&r.isOwner&&(this.actor=r),t.length>=1&&(this.showEffects=!0),e.next=7,this.render(!0);case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"registerTokenHotbar",value:function(){game.dsa5.apps.tokenHotbar||(game.dsa5.apps.tokenHotbar=new c)}},{key:"hookUpdate",value:function(e){e==getProperty(game.dsa5.apps.tokenHotbar,"actor.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}},{key:"defaultOptions",get:function(){var e=Hi(Vi(c),"defaultOptions",this),t=$("#hotbar").first().position(),r=game.settings.get("dsa5","tokenhotbarSize"),n=game.settings.get("dsa5","tokenhotbarPosition");return mergeObject(e,{classes:e.classes.concat(["dsa5","tokenQuickHot"]),itemWidth:r,resizable:!1,height:r+45,zIndex:61,left:t.left+8,top:t.top-r-25,template:"systems/dsa5/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(e,n),e}}]),c}(),Ji=function(e){qi(a,Dialog);var t,r,n=Ui(a);function a(){return Gi(this,a),n.apply(this,arguments)}return Bi(a,[{key:"activateListeners",value:function(e){var t=this;Hi(Vi(a.prototype),"activateListeners",this).call(this,e),e.find(".reactClick").click((function(e){return t.addEffect(e)}));var r=e.find(".conditionSearch");r.keyup((function(r){return t._filterConditions($(r.currentTarget),e)})),r[0]&&r[0].addEventListener("search",(function(r){return t._filterConditions($(r.currentTarget),e)}),!1)}},{key:"_filterConditions",value:function(e,t){if(null!=e.val()){var r=e.val().toLowerCase().trim(),n=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),n.filter((function(){return-1==$(this).find("span").text().toLowerCase().trim().indexOf(r)})).addClass("filterHide")}}},{key:"addEffect",value:(r=Fi(Ri().mark((function e(t){var r,n,a;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=Ii(canvas.tokens.controlled),e.prev=1,r.s();case 3:if((n=r.n()).done){e.next=9;break}return a=n.value,e.next=7,a.actor.addCondition(t.currentTarget.dataset.value,1,!1,!1);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),r.e(e.t0);case 14:return e.prev=14,r.f(),e.finish(14);case 17:game.dsa5.apps.tokenHotbar.render(!0),this.close();case 19:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return r.apply(this,arguments)})}],[{key:"showDialog",value:(t=Fi(Ri().mark((function e(){var t,r;return Ri().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=duplicate(CONFIG.statusEffects).map((function(e){return{label:game.i18n.localize(e.label),icon:e.icon,description:game.i18n.localize(e.description),id:e.id}})).sort((function(e,t){return e.label.localeCompare(t.label)})),e.t0=a,e.t1=game.i18n.localize("CONDITION.add"),e.next=5,renderTemplate("systems/dsa5/templates/dialog/addstatusdialog.html",{effects:t});case 5:e.t2=e.sent,e.t3={},e.t4={title:e.t1,content:e.t2,buttons:e.t3},(r=new e.t0(e.t4)).position.height=36*Math.ceil(t.length/3)+170,r.render(!0);case 11:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"defaultOptions",get:function(){var e=Hi(Vi(a),"defaultOptions",this),t=32*Math.ceil(CONFIG.statusEffects.length/3);return mergeObject(e,{classes:["dsa5","tokenStatusEffects"],width:700,resizable:!0,height:t}),e}}]),a}();function Qi(e){return Qi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Qi(e)}function Xi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function es(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ts(e,t){return ts=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ts(e,t)}function rs(e,t){if(t&&("object"===Qi(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function ns(e){return ns=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ns(e)}var as=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ts(e,t)}(i,e);var t,r,n,a,o=(n=i,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=ns(n);if(a){var r=ns(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return rs(this,e)});function i(){return Xi(this,i),o.apply(this,arguments)}return t=i,r=[{key:"merchantTemplate",get:function(){return"systems/dsa5/templates/actors/merchant/creature-merchant-sheet.html"}}],null&&es(t.prototype,null),r&&es(t,r),Object.defineProperty(t,"prototype",{writable:!1}),i}(jn(kt));function os(e){return os="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},os(e)}function is(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ss(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function cs(e,t){return cs=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},cs(e,t)}function us(e,t){if(t&&("object"===os(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function ls(e){return ls=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ls(e)}var fs=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&cs(e,t)}(i,e);var t,r,n,a,o=(n=i,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=ls(n);if(a){var r=ls(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return us(this,e)});function i(){return is(this,i),o.apply(this,arguments)}return t=i,r=[{key:"merchantTemplate",get:function(){return"systems/dsa5/templates/actors/merchant/character-merchant-sheet.html"}}],null&&ss(t.prototype,null),r&&ss(t,r),Object.defineProperty(t,"prototype",{writable:!1}),i}(jn(ct));function ps(e){return ps="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ps(e)}function ds(){ds=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==ps(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function hs(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function ms(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){hs(o,n,a,i,s,"next",e)}function s(e){hs(o,n,a,i,s,"throw",e)}i(void 0)}))}}function ys(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function vs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function gs(){return gs="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=bs(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},gs.apply(this,arguments)}function bs(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=xs(e)););return e}function ws(e,t){return ws=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ws(e,t)}function ks(e,t){if(t&&("object"===ps(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function xs(e){return xs=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},xs(e)}var _s=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ws(e,t)}(f,Application);var t,r,n,a,o,i,s,c,u,l=(c=f,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=xs(c);if(u){var r=xs(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return ks(this,e)});function f(){return ys(this,f),l.apply(this,arguments)}return t=f,r=[{key:"setPosition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.left,r=e.top,n=e.width,a=e.height,o=e.scale,i=gs(xs(f.prototype),"setPosition",this).call(this,{left:t,top:r,width:n,height:a,scale:o}),s=this.element[0];if(!s.style.width||n){var c=n||s.offsetWidth,u=s.style.maxWidth||window.innerWidth;i.width=n=Math.clamped(c,0,u),s.style.width=n+"px",n+i.left>window.innerWidth&&(t=i.left)}return game.settings.set("dsa5","iniTrackerPosition",{left:i.left,top:i.top}),i}},{key:"updateTracker",value:function(e){this.combatData=e,this.render(!0)}},{key:"getData",value:(s=ms(ds().mark((function e(t){var r,n,a,o,i,s,c,u,l,f,p,d,h,m,y,v;return ds().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.combatData,n=game.settings.get("dsa5","iniTrackerSize"),this.position.width=5*n+17+50+28,this.position.height=n+10,a=r.turns,o=[],i=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,s=r.turns.some((function(e){return e.owner&&!e.hasRolled&&(!game.user.isGM||r.combat.combatants.get(e.id).isNPC)})),a.length){for(c=[],u=5,l=!1,f=-1,p=0,d=0;0!=u&&5!=d;)m=duplicate(a[p]),y=r.combat.combatants.get(m.id),l&&p==f&&(m.css=m.css.replace("active","")),m.active&&!l?(l=!0,f=p):y.getFlag("dsa5","waitInit")!=r.round+d||m.defeated||!game.user.isGM&&m.hidden||o.push(m),!l||i&&m.defeated||!game.user.isGM&&m.hidden||(m.round=r.round+d,m.owner&&y.token.actor&&(m.maxLP=y.token.actor.system.status.wounds.max,m.currentLP=y.token.actor.system.status.wounds.value),h&&h!=m.round&&(m.newRound="newRound"),h=m.round,c.push(m),u--),++p>=a.length&&(p=0,d++);r.turns=c}return mergeObject(r,{itemWidth:n,unRolled:s,waitingTurns:o}),(v=r.turns[0])&&this.panToCurrentCombatant(r.combat.combatants.get(v.id)),e.abrupt("return",r);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"panToCurrentCombatant",value:(i=ms(ds().mark((function e(t){return ds().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&game.settings.get("dsa5","enableCombatPan")){e.next=2;break}return e.abrupt("return");case 2:setTimeout((function(){var e=t.token;e&&e.object&&e.object.isVisible&&(canvas.animatePan({x:e.x,y:e.y}),t.actor&&t.actor.isOwner&&e.object.control({releaseOthers:!0}))}),300);case 3:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)})},{key:"_onWheelResize",value:(o=ms(ds().mark((function e(t){var r;return ds().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=game.settings.get("dsa5","iniTrackerSize"),r=t.originalEvent.deltaY>0?Math.min(140,r+5):Math.max(30,r-5),e.next=4,game.settings.set("dsa5","iniTrackerSize",r);case 4:return e.next=6,this.render(!0);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"activateListeners",value:function(e){var t=this;gs(xs(f.prototype),"activateListeners",this).call(this,e);var r=e.find(".dragHandler");new Draggable(this,e,r[0],this.options.resizable),r.on("wheel",function(){var e=ms(ds().mark((function e(r){return ds().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.stopPropagation(),r.preventDefault(),e.next=4,t._onWheelResize(r);case 4:return e.abrupt("return",!1);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.find(".combat-control").click((function(e){return t._onCombatControl(e)}));var n=e.find(".iniItem");n.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),n.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown((function(e){return t._onRightClick(e)})),e.find(".combatant-control").click((function(e){return t._onCombatantControl(e)})),e.find(".combatant .aggroButton").click((function(e){e.preventDefault(),e.stopPropagation(),Do.runActAttackDialog()})),e.find(".rollMine").click((function(e){return t.rollMyChars()})),game.user.isGM&&e.find(".rolledInit").click((function(e){return t.editCombatant(e)}))}},{key:"rollMyChars",value:function(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}},{key:"_onRightClick",value:function(e){if(2==e.button){var t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsa5","waitInit")}}},{key:"editCombatant",value:function(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}},{key:"_onCombatantControl",value:function(e){this._getCombatApp()._onCombatantControl(e)}},{key:"_onCombatControl",value:function(e){"waitInit"==e.currentTarget.dataset.control?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}},{key:"waitInit",value:(a=ms(ds().mark((function e(t){var r;return ds().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=game.combat.combatants.get(game.combat.current.combatantId),e.next=3,r.setFlag("dsa5","waitInit",game.combat.current.round);case 3:t.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"_onCombatantHoverOut",value:function(e){this._getCombatApp()._onCombatantHoverOut(e)}},{key:"_onCombatantHoverIn",value:function(e){this._getCombatApp()._onCombatantHoverIn(e)}},{key:"_onCombatantMouseDown",value:function(e){this._getCombatApp()._onCombatantMouseDown(e)}},{key:"_getCombatApp",value:function(){return game.combats.apps[0]}},{key:"_canDragStart",value:function(e){return!1}},{key:"_canDragDrop",value:function(e){return!1}},{key:"_onDragStart",value:function(e){var t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}},{key:"_onDrop",value:function(e){JSON.parse(e.dataTransfer.getData("text/plain")).type}}],n=[{key:"defaultOptions",get:function(){var e=gs(xs(f),"defaultOptions",this);mergeObject(e,{classes:e.classes.concat(["dsa5","initTracker"]),template:"systems/dsa5/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"DSAIniTracker"});var t=game.settings.get("dsa5","iniTrackerPosition");return mergeObject(e,t),e}},{key:"connectHooks",value:function(){Hooks.on("renderDSA5CombatTracker",(function(e,t,r){game.settings.get("dsa5","enableCombatFlow")&&(game.combat?(game.dsa5.apps.initTracker||(game.dsa5.apps.initTracker=new f),game.dsa5.apps.initTracker.updateTracker(r)):game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0))}))}}],r&&vs(t.prototype,r),n&&vs(t,n),Object.defineProperty(t,"prototype",{writable:!1}),f}();function Os(e){return Os="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Os(e)}function Es(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ss(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ls(){return Ls="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Ts(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Ls.apply(this,arguments)}function Ts(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=As(e)););return e}function Ds(e,t){return Ds=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ds(e,t)}function Ps(e,t){if(t&&("object"===Os(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function As(e){return As=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},As(e)}var js=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ds(e,t)}(i,JournalSheet);var t,r,n,a,o=(n=i,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=As(n);if(a){var r=As(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return Ps(this,e)});function i(){return Es(this,i),o.apply(this,arguments)}return t=i,r=[{key:"defaultOptions",get:function(){var e=Ls(As(i),"defaultOptions",this);return mergeObject(e,{classes:e.classes.concat(["dsa5","dsajournal"])}),e}}],null&&Ss(t.prototype,null),r&&Ss(t,r),Object.defineProperty(t,"prototype",{writable:!1}),i}(),Cs=__webpack_require__(93);function Is(e){return Is="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Is(e)}function Ms(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ns(e,t){return Ns=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ns(e,t)}function Rs(e,t){if(t&&("object"===Is(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function zs(e){return zs=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},zs(e)}function Fs(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Hooks.once("init",(function(){var e,t,r,n;loadTemplates(["systems/dsa5/templates/actors/actor-main.html","systems/dsa5/templates/actors/actor-talents.html","systems/dsa5/templates/items/item-description.html","systems/dsa5/templates/dialog/default-dialog.html","systems/dsa5/templates/dialog/parts/targets.html","systems/dsa5/templates/dialog/enhanced-default-dialog.html","systems/dsa5/templates/dialog/default-combat-dialog.html","systems/dsa5/templates/chat/roll/test-card.html","systems/dsa5/templates/items/item-equipment.html","systems/dsa5/templates/items/item-enchantment.html","systems/dsa5/templates/actors/actor-combat.html","systems/dsa5/templates/actors/actor-equipment.html","systems/dsa5/templates/actors/actor-notes.html","systems/dsa5/templates/chat/post-item.html","systems/dsa5/templates/items/item-stat.html","systems/dsa5/templates/items/item-extension.html","systems/dsa5/templates/actors/creature/creature-main.html","systems/dsa5/templates/actors/creature/creature-loot.html","systems/dsa5/templates/actors/creature/creature-combat.html","systems/dsa5/templates/actors/creature/creature-notes.html","systems/dsa5/templates/actors/creature/creature-magic.html","systems/dsa5/templates/actors/creature/creature-religion.html","systems/dsa5/templates/actors/parts/characteristics-small.html","systems/dsa5/templates/actors/parts/characteristics-large.html","systems/dsa5/templates/actors/parts/gearSearch.html","systems/dsa5/templates/actors/parts/magicalSigns.html","systems/dsa5/templates/actors/parts/containerContent.html","systems/dsa5/templates/actors/npc/npc-main.html","systems/dsa5/templates/actors/character/actor-magic.html","systems/dsa5/templates/actors/character/actor-religion.html","systems/dsa5/templates/actors/character/actor-aggregatedtests.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-small.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-large.html","systems/dsa5/templates/actors/parts/status_effects.html","systems/dsa5/templates/actors/parts/purse.html","systems/dsa5/templates/actors/parts/healthbar.html","systems/dsa5/templates/actors/merchant/merchant-commerce.html","systems/dsa5/templates/items/item-header.html","systems/dsa5/templates/items/item-effects.html","systems/dsa5/templates/status/advanced_functions.html","systems/dsa5/templates/actors/parts/information.html"]),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsa5",ct,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsa5",kt,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsa5",Pt,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsa5",zn,{types:["npc"]}),Actors.registerSheet("dsa5",as,{types:["creature"]}),Actors.registerSheet("dsa5",fs,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsa5",Zr.Z,{makeDefault:!0}),Journal.registerSheet("dsa5",js,{makeDefault:!0}),Kt.setupSheets(),game.settings.register("dsa5","meleeBotchTableEnabled",{name:"DSASETTINGS.meleeBotchTableEnabled",hint:"DSASETTINGS.meleeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","rangeBotchTableEnabled",{name:"DSASETTINGS.rangeBotchTableEnabled",hint:"DSASETTINGS.rangeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","defenseBotchTableEnabled",{name:"DSASETTINGS.defenseBotchTableEnabled",hint:"DSASETTINGS.defenseBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","higherDefense",{name:"DSASETTINGS.higherDefense",hint:"DSASETTINGS.higherDefenseHint",scope:"world",config:!0,default:"0",type:String,choices:{0:"0",2:"+2",4:"+4"}}),game.settings.register("dsa5","informationDistribution",{name:"DSASETTINGS.informationDistribution",hint:"DSASETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("DSASETTINGS.information0"),1:game.i18n.localize("DSASETTINGS.information1"),2:game.i18n.localize("DSASETTINGS.information2")}}),game.settings.register("dsa5","enableItemDropToCanvas",{name:"DSASETTINGS.enableItemDropToCanvas",hint:"DSASETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","statusEffectCounterColor",{name:"DSASETTINGS.statusEffectCounterColor",hint:"DSASETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsa5","migrationVersion",{name:"migrationVersion",hint:"migrationVersion",scope:"world",config:!1,default:17,type:Number}),game.settings.register("dsa5","firstTimeStart",{name:"firstTimeStart",hint:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","defaultConfigFinished",{name:"defaultConfigFinished",hint:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","tokenizerSetup",{name:"tokenizerSetup",hint:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","capQSat",{name:"DSASETTINGS.capQSat",hint:"DSASETTINGS.capQSatHint",scope:"world",config:!0,default:6,type:Number}),game.settings.register("dsa5","hideEffects",{name:"DSASETTINGS.hideEffects",hint:"DSASETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","inventorySound",{name:"DSASETTINGS.inventorySound",hint:"DSASETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","talentModifierEnabled",{name:"DSASETTINGS.talentModifierEnabled",hint:"DSASETTINGS.talentModifierEnabledHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","noConfirmationRoll",{name:"DSASETTINGS.noConfirmationRoll",hint:"DSASETTINGS.noConfirmationRollHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","lessRegeneration",{name:"DSASETTINGS.lessRegeneration",hint:"DSASETTINGS.lessRegenerationHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","limitCombatSpecAbs",{name:"DSASETTINGS.limitCombatSpecAbs",hint:"DSASETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","allowPhysicalDice",{name:"DSASETTINGS.allowPhysicalDice",hint:"DSASETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideOpposedDamage",{name:"DSASETTINGS.hideOpposedDamage",hint:"DSASETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableForeignSpellModifer",{name:"DSASETTINGS.enableForeignSpellModifer",hint:"DSASETTINGS.enableForeignSpellModiferHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","playerCanEditSpellMacro",{name:"DSASETTINGS.playerCanEditSpellMacro",hint:"DSASETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableDPS",{name:"DSASETTINGS.enableDPS",hint:"DSASETTINGS.enableDPSHint",scope:"world",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","iniTrackerSize",{name:"DSASETTINGS.iniTrackerSize",hint:"DSASETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:(e=to(Xa().mark((function e(t){return Xa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=t;case 1:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}),game.settings.register("dsa5","tokenhotbarSize",{name:"DSASETTINGS.tokenhotbarSize",hint:"DSASETTINGS.tokenhotbarSizeHint",scope:"client",config:!0,default:35,type:Number,range:{min:15,max:100,step:5},onChange:(t=to(Xa().mark((function e(t){return Xa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=t;case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}),game.settings.register("dsa5","tokenhotbarLayout",{name:"DSASETTINGS.tokenhotbarLayout",hint:"DSASETTINGS.tokenhotbarLayoutHint",scope:"client",config:!0,default:"0",type:Number,choices:{0:game.i18n.localize("DSASETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("DSASETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("DSASETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("DSASETTINGS.tokenhotbarLayout3")}}),game.settings.register("dsa5","forceLanguage",{name:"DSASETTINGS.forceLanguage",hint:"DSASETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German",en:"English"}}),game.settings.register("dsa5","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","iniTrackerPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","soundConfig",{name:"DSASETTINGS.soundConfig",hint:"DSASETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:(r=to(Xa().mark((function e(){return Xa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:D.Z.loadSoundConfig();case 1:case"end":return e.stop()}}),e)}))),function(){return r.apply(this,arguments)})}),game.settings.registerMenu("dsa5","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("DSASETTINGS.changelog"),type:ro,restricted:!1}),game.settings.registerMenu("dsa5","resetTokenbar",{name:game.i18n.localize("DSASETTINGS.resetTokenbar"),label:game.i18n.localize("DSASETTINGS.resetTokenbar"),hint:game.i18n.localize("DSASETTINGS.resetTokenbarHint"),type:no,restricted:!1}),game.settings.register("dsa5","breadcrumbs",{name:"DSASETTINGS.breadcrumbs",hint:"DSASETTINGS.breadcrumbsHint",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsa5","groupschips",{name:"DSASETTINGS.groupschips",hint:"DSASETTINGS.groupschips",scope:"world",config:!1,default:"0/0",type:String,onChange:(n=to(Xa().mark((function e(){return Xa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:game.user.isGM&&game.dsa5.apps.gameMasterMenu.render();case 1:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})}),game.settings.register("dsa5","expandChatModifierlist",{name:"DSASETTINGS.expandChatModifierlist",hint:"DSASETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexWorldItems",{name:"DSASETTINGS.indexWorldItems",hint:"DSASETTINGS.indexWorldItemsHint",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","enableCombatFlow",{name:"DSASETTINGS.enableCombatFlow",hint:"DSASETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:function(e){game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0)}}),game.settings.register("dsa5","enableCombatPan",{name:"DSASETTINGS.enableCombatPan",hint:"DSASETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","disableDidYouKnow",{name:"DSASETTINGS.disableDidYouKnow",hint:"DSASETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","scrollingFontsize",{name:"DSASETTINGS.scrollingFontsize",hint:"DSASETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsa5","armorAndWeaponDamage",{name:"DSASETTINGS.armorAndWeaponDamage",hint:"DSASETTINGS.armorAndWeaponDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexDescription",{name:"DSASETTINGS.indexDescription",hint:"DSASETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","encumbranceForRange",{name:"DSASETTINGS.encumbranceForRange",hint:"DSASETTINGS.encumbranceForRangeHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","obfuscateTokenNames",{name:"DSASETTINGS.obfuscateTokenNames",hint:"DSASETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("yes"),2:game.i18n.localize("DSASETTINGS.rename")}}),game.settings.register("dsa5","merchantNotification",{name:"DSASETTINGS.merchantNotification",hint:"DSASETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("yes"),2:game.i18n.localize("MERCHANT.onlyGM")}}),game.settings.register("dsa5","sightOptions",{name:"sightOptions",scope:"world",config:!1,default:"0.5|0.7|0.85|0.95",type:String}),game.settings.register("dsa5","trackedActors",{name:"sightOptions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object}),Ia.Z.initDoorMinDistance()})),Hooks.once("ready",(function(){ji.showOneMessage(),Ki.registerTokenHotbar(),Hooks.on("dropCanvasData",function(){var e=ka(va().mark((function e(t,r){return va().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(game.settings.get("dsa5","enableItemDropToCanvas")||game.user.isGM||r.tokenId){e.next=2;break}return e.abrupt("return");case 2:"Item"==r.type?_a(t,r):"GroupDrop"==r.type&&Oa(t,r);case 3:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()),_s.connectHooks(),Hooks.on("changeSidebarTab",(function e(t){"settings"==t.tabName&&(Cs.Z.travelAgency(),Hooks.off("changeSidebarTab",e))}))})),Hooks.once("setup",(function(){["de","en"].includes(game.i18n.lang)||(console.warn("DSA5 - ".concat(game.i18n.lang," is not a supported language. Falling back to default language.")),game.settings.set("core","language","de"));var t,n,o=game.settings.get("dsa5","forceLanguage");["de","en"].includes(o)&&game.i18n.lang!=o&&Gs(o),function(){var e;game.dsa5.config.knownShortcuts=(Fs(e={},game.i18n.localize("CHARAbbrev.INI").toLowerCase(),["status","initiative","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.GS").toLowerCase(),["status","speed","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.AsP").toLowerCase(),["status","astralenergy","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.LeP").toLowerCase(),["status","wounds","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.KaP").toLowerCase(),["status","karmaenergy","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.AW").toLowerCase(),["status","dodge","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.SK").toLowerCase(),["status","soulpower","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.ZK").toLowerCase(),["status","toughness","gearmodifier"]),Fs(e,game.i18n.localize("CHARAbbrev.FtP").toLowerCase(),["status","fatePoints","gearmodifier"]),e);for(var t=0,r=["MU","KL","IN","CH","FF","GE","KO","KK"];t<r.length;t++){var n=r[t];game.dsa5.config.knownShortcuts[game.i18n.localize("CHARAbbrev.".concat(n)).toLowerCase()]=["characteristics",n.toLowerCase(),"gearmodifier"]}}(),ri.initHook(),game.keybindings.register("dsa5","masterMenu",{name:"gmMenu",hint:game.i18n.localize("KEYBINDINGS.masterMenu"),editable:[{key:"KeyM"}],onDown:function(){return e.Z.renderToggle(game.dsa5.apps.gameMasterMenu)},restricted:!0}),game.keybindings.register("dsa5","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:function(){return e.Z.renderToggle(game.dsa5.apps.journalBrowser)}}),game.keybindings.register("dsa5","library",{name:"ItemLibrary",hint:game.i18n.localize("KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:function(){return e.Z.renderToggle(game.dsa5.itemLibrary)}}),game.keybindings.register("dsa5","attacktest",{name:"attacktest",hint:game.i18n.localize("KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:function(){return Do.runActAttackDialog()}}),game.keybindings.register("dsa5","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:function(){return No("nextTurn")}}),game.keybindings.register("dsa5","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:function(){return No("previousTurn")}}),game.keybindings.register("dsa5","setTargetToUser",{name:"DIALOG.setTargetToUser",hint:game.i18n.localize("DIALOG.setTargetToUserHint"),editable:[],onDown:(t=Io().mark((function e(){return Io().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fo.Z.getDialog();case 2:return e.abrupt("return",e.sent.render(!0));case 3:case"end":return e.stop()}}),e)})),n=function(){var e=this,r=arguments;return new Promise((function(n,a){var o=t.apply(e,r);function i(e){Mo(o,n,a,i,s,"next",e)}function s(e){Mo(o,n,a,i,s,"throw",e)}i(void 0)}))},function(){return n.apply(this,arguments)}),restricted:!0}),Oi.registerButtons(),fo.Z.registerButtons(),CONFIG.Canvas.lightAnimations.daylight={label:"LIGHT.daylight",illuminationShader:Zs},r.Z.setupFunctions(),a.Z.setupFunctions()}));var Gs=function(e){var t={title:game.i18n.localize("DSASETTINGS.forceLanguage"),content:game.i18n.format("DSAError.wrongLanguage",{lang:e}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:function(){game.settings.set("core","language",e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new Dialog(t).render(!0)},Zs=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ns(e,t)}(o,AdaptiveIlluminationShader);var t,r,n,a=(r=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=zs(r);if(n){var a=zs(this).constructor;e=Reflect.construct(t,arguments,a)}else e=t.apply(this,arguments);return Rs(this,e)});function o(){return Ms(this,o),a.apply(this,arguments)}return t=o,Object.defineProperty(t,"prototype",{writable:!1}),t}();function Bs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Fs(Zs,"fragmentShader","\n    precision mediump float;\n    uniform float time;\n    uniform float intensity;\n    uniform float alpha;\n    uniform float ratio;\n    uniform vec3 colorDim;\n    uniform vec3 colorBright;\n    varying vec2 vUvs;\n    const float MU_TWOPI = 0.1591549431;\n\n    void main() {\n      float dist = distance(vUvs, vec2(0.5)) * 2.0;\n      vec3 color = mix(colorDim, colorBright, smoothstep(clamp(0.8 - ratio, 0.0, 1.0), clamp(1.2 - ratio, 0.0, 1.0),1.0 - dist));\n      vec3 fcolor = mix(color, max(color, smoothstep( 0.1, 1.0, color ) * 10.0), 1.0 - dist) * alpha;\n      gl_FragColor = vec4(fcolor, 1.0);\n    }");var Hs=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,r=[{key:"weaponLessMacro",value:function(e){var t,r=ChatMessage.getSpeaker();r.token&&(t=game.actors.tokens[r.token]),t||(t=game.actors.get(r.actor)),this.runWeaponless(t,e,r.token)}},{key:"weaponLessMacroId",value:function(e,t){var r=game.actors.get(t);this.runWeaponless(r,e)}},{key:"requestRoll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;sa.Z.showRQMessage(e,t)}},{key:"requestGC",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};sa.Z.showGCMessage(e,t,r)}},{key:"rollCh",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o.Z.check3D20(void 0,e,t)}},{key:"itemMacroById",value:function(e,t,r,n){var a=game.actors.get(e),o=a?a.items.find((function(e){return e.name===t&&e.type==r})):null;this.runItem(a,o,t,n)}},{key:"itemMacro",value:function(e,t,r){var n,a=ChatMessage.getSpeaker();a.token&&(n=game.actors.tokens[a.token]),n||(n=game.actors.get(a.actor));var o=n?n.items.find((function(r){return r.name===e&&r.type==t})):null;this.runItem(n,o,e,r,a.token)}},{key:"charMacroById",value:function(e,t){var r=game.actors.get(t);this.runChar(r,e)}},{key:"charMacro",value:function(e){var t,r=ChatMessage.getSpeaker();r.token&&(t=game.actors.tokens[r.token]),t||(t=game.actors.get(r.actor)),this.runChar(t,e,r.token)}},{key:"runWeaponless",value:function(e,t,r){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));var n=t.split("Weaponless")[0];e.setupWeaponless(n,{},r).then((function(t){e.basicTest(t)}))}},{key:"runChar",value:function(e,t,r){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));e.setupDodge({},r).then((function(t){e.basicTest(t)}))}},{key:"runItem",value:function(e,t,r,n,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:r}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,n.mod,n,a).then((function(t){e.basicTest(t)}));case"rangeweapon":return e.setupWeapon(t,"attack",n,a).then((function(t){e.basicTest(t)}));case"skill":return e.setupSkill(t,n,a).then((function(t){e.basicTest(t)}));case"ceremony":case"ritual":case"spell":case"liturgy":return e.setupSpell(t,n,a).then((function(t){e.basicTest(t)}))}}}],null&&Bs(t.prototype,null),r&&Bs(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function Ws(e){return Ws="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ws(e)}function qs(){qs=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Ws(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function $s(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Us(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){$s(o,n,a,i,s,"next",e)}function s(e){$s(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Ys(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Vs=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n,a;return t=e,null,r=[{key:"bindImports",value:(a=Us(qs().mark((function e(){return qs().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:import("./import_functions.js").then((function(e){game.dsa5.importers=e.default}));case 1:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})},{key:"bindInitCreator",value:(n=Us(qs().mark((function e(){return qs().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:import("./init_creator.js").then((function(e){game.dsa5.initCreator=e.default})),import("./initers.js").then((function(e){game.dsa5.initers=e.default}));case 2:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})}],r&&Ys(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function Ks(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Js(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ks(Object(r),!0).forEach((function(t){Qs(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ks(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function Qs(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var Xs={};Hooks.once("ready",(function(){Promise.all([e.Z.allSkillsList(),e.Z.allCombatSkills()]).then((function(e){var r=e[0].reduce((function(e,t){return Js(Js({},e),{},Qs({},t,t))}),{}),n=e[1].filter((function(e){return"range"==e.system.weapontype.value})).sort((function(e,t){return e.name.localeCompare(t.name)})).reduce((function(e,t){return Js(Js({},e),{},Qs({},t.name,t.name))}),{}),a=e[1].filter((function(e){return"melee"==e.system.weapontype.value})).sort((function(e,t){return e.name.localeCompare(t.name)})).reduce((function(e,t){return Js(Js({},e),{},Qs({},t.name,t.name))}),{});mergeObject(Xs,{ammunition:[{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:t.Z.ammunitiongroups}],equipment:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:t.Z.equipmentTypes}],rangeweapon:[{label:"combatskill",attr:"combatskill.value",type:"select",options:n},{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:t.Z.ammunitiongroups}],meleeweapon:[{label:"combatskill",attr:"combatskill.value",type:"select",options:a},{label:"guidevalue",attr:"guidevalue.value",type:"select",options:t.Z.combatskillsGuidevalues},{label:"reach",attr:"reach.value",type:"select",options:t.Z.meleeRanges}],poison:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:t.Z.magicResistanceModifiers}],disease:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:t.Z.magicResistanceModifiers}],consumable:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:t.Z.equipmentTypes}],application:[{label:"skill",attr:"skill",type:"select",options:r}],trait:[{label:"traitType",attr:"traitType.value",type:"select",options:t.Z.traitCategories}],career:[{label:"mageLevel",attr:"mageLevel.value",type:"select",options:t.Z.mageLevels}],specialability:[{label:"Category",attr:"category.value",type:"select",options:t.Z.specialAbilityCategories}],liturgy:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spell:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ritual:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ceremony:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spellextension:[{label:"Category",attr:"category",type:"select",options:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}],magictrick:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],blessing:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],npc:[{label:"species",attr:"details.species.value",type:"text"},{label:"career",attr:"details.career.value",type:"text"},{label:"culture",attr:"details.culture.value",type:"text"}],character:[{label:"species",attr:"details.species.value",type:"text"},{label:"career",attr:"details.career.value",type:"text"},{label:"culture",attr:"details.culture.value",type:"text"}],creature:[{label:"creatureClass",attr:"creatureClass.value",type:"text"},{label:"sizeCategory",attr:"status.size.value",type:"select",options:t.Z.sizeCategories}],armor:[{label:"protection",attr:"protection.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}},{label:"encumbrance",attr:"encumbrance.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4"}}],plant:[{label:"PLANT.landscape",attr:"location.landscape",type:"text"},{label:"PLANT.region",attr:"location.region",type:"text"},{label:"PLANT.healing",attr:"planttype.healing",type:"checkbox"},{label:"PLANT.poison",attr:"planttype.poison",type:"checkbox"},{label:"PLANT.physical",attr:"planttype.physical",type:"checkbox"},{label:"PLANT.psychic",attr:"planttype.psychic",type:"checkbox"},{label:"PLANT.crop",attr:"planttype.crop",type:"checkbox"},{label:"PLANT.defensive",attr:"planttype.defensive",type:"checkbox"},{label:"PLANT.supernatural",attr:"planttype.supernatural",type:"checkbox"},{label:"PLANT.highNorth",attr:"availability.highNorth",type:"range"},{label:"PLANT.grasLands",attr:"availability.grasLands",type:"range"},{label:"PLANT.swamps",attr:"availability.swamps",type:"range"},{label:"PLANT.woods",attr:"availability.woods",type:"range"},{label:"PLANT.jungle",attr:"availability.jungle",type:"range"},{label:"PLANT.mountains",attr:"availability.mountains",type:"range"},{label:"PLANT.desert",attr:"availability.desert",type:"range"},{label:"PLANT.maraskan",attr:"availability.maraskan",type:"range"}],magicalsign:[],patron:[],demonmark:[]})}))}));const ec=Xs;function tc(e){return tc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tc(e)}function rc(e){return function(e){if(Array.isArray(e))return sc(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ic(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function nc(){return nc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=ac(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},nc.apply(this,arguments)}function ac(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=pc(e)););return e}function oc(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=ic(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function ic(e,t){if(e){if("string"==typeof e)return sc(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?sc(e,t):void 0}}function sc(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function cc(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&uc(e,t)}function uc(e,t){return uc=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},uc(e,t)}function lc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=pc(e);if(t){var a=pc(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return fc(this,r)}}function fc(e,t){if(t&&("object"===tc(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function pc(e){return pc=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},pc(e)}function dc(){dc=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==tc(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function hc(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function mc(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){hc(o,n,a,i,s,"next",e)}function s(e){hc(o,n,a,i,s,"throw",e)}i(void 0)}))}}function yc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function vc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function gc(e,t,r){return t&&vc(e.prototype,t),r&&vc(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var bc=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};yc(this,e);var n=t.documentName||t.type;switch(t.documentName){case"Actor":case"Item":n=t.type}var a="";if(game.settings.get("dsa5","indexDescription"))switch(n){case"creature":case"npc":case"character":a=getProperty(t,"system.description.value");break;case"JournalEntry":a=getProperty(t,"system.content");break;default:a=getProperty(t,"description.value")}this.document={name:t.name,filterType:n,data:$("<div>").html(a).text(),id:t.id||t._id,visible:!t.visible||t.visible,compendium:t.compendium?t.compendium.metadata.packageName:r.packageName||"",pack:t.pack||(r.packageName?r.id:void 0),img:t.img}}var t,r;return gc(e,[{key:"uuid",get:function(){if(this.document.compendium)return"Compendium.".concat(this.document.pack,".").concat(this.document.id);switch(this.itemType){case"character":case"creature":case"npc":return"Actor.".concat(this.id);case"JournalEntry":return"JournalEntry.".concat(this.id);default:return"Item.".concat(this.id)}}},{key:"name",get:function(){return this.document.name}},{key:"data",get:function(){return this.document.data}},{key:"id",get:function(){return this.document.id}},{key:"itemType",get:function(){return this.document.filterType}},{key:"getItem",value:(r=mc(dc().mark((function e(){return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fromUuid(this.uuid);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"hasPermission",value:function(){return this.document.visible}},{key:"render",value:(t=mc(dc().mark((function e(){return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getItem();case 2:e.sent.sheet.render(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"compendium",get:function(){return this.document.compendium}},{key:"img",get:function(){return"JournalEntry"==this.itemType?"systems/dsa5/icons/categories/DSA-Auge.webp":this.document.img}}]),e}(),wc=function(e){cc(r,e);var t=lc(r);function r(e,n){var a;yc(this,r),a=t.call(this,e);var o,i=oc(ec[n]||[]);try{for(i.s();!(o=i.n()).done;){var s=o.value;a[s.attr]=s.attr.split(".").reduce((function(e,t){return void 0===e[t]?{}:e[t]}),e.system)}}catch(e){i.e(e)}finally{i.f()}return a}return gc(r)}(bc),kc=function(t){cc(y,Application);var r,n,a,o,i,s,c,u,l,f,p,d,h,m=lc(y);function y(e){var t;return yc(this,y),(t=m.call(this,e)).advancedFiltering=!1,t.journalBuild=!1,t.journalWorldBuild=!1,t.equipmentBuild=!1,t.equipmentWorldBuild,t.zooBuild=!1,t.zooWorldBuild=!1,t.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},t.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),t.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),t.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),t.detailFilter={},t.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},t.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1,disease:!1,consumable:!1,plant:!1},filterBy:{search:""}},character:{categories:{career:!1,advantage:!1,combatskill:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1,application:!1,demonmark:!1,patron:!1},filterBy:{search:""}},spell:{categories:{blessing:!1,ceremony:!1,liturgy:!1,magictrick:!1,ritual:!1,spell:!1,spellextension:!1,magicalsign:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}},t}return gc(y,[{key:"getData",value:(h=mc(dc().mark((function e(t){var r;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,nc(pc(y.prototype),"getData",this).call(this,t);case 2:if((r=e.sent).categories=this.translateFilters(),r.isGM=game.user.isGM,r.items=this.items,r.advancedMode=this.advancedFiltering?"on":"",r.worldIndexed=game.settings.get("dsa5","indexWorldItems")?"on":"",r.fullTextEnabled=game.settings.get("dsa5","indexDescription")?"on":"",!this.advancedFiltering){e.next=13;break}return e.next=12,this.buildDetailFilter("tbd",this.subcategory);case 12:r.advancedFilter=e.sent;case 13:return e.abrupt("return",r);case 14:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"translateFilters",value:function(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo),journal:this.buildFilter(this.filters.journal)}}},{key:"purgeAdvancedFilters",value:function(){var e=this;for(var t in this.filters)for(var r in this.filters[t].categories)this.filters[t].categories[r]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then((function(t){$(e._element).find(".advancedSearch .groupbox").html(t)}))}},{key:"buildFilter",value:function(e){var t=[];return Object.keys(e.categories).forEach((function(r){t.push({label:game.i18n.localize(r),selected:e.categories[r],key:r})})),t=t.sort((function(e,t){return e.label.localeCompare(t.label)}))}},{key:"getRandomItems",value:(d=mc(dc().mark((function e(t,r){var n,a;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],a=this.equipmentIndex,e.t0=n.push,e.t1=n,e.t2=rc,e.next=7,a.search(t,{field:["itemType"]});case 7:return e.t3=e.sent,e.t4=(0,e.t2)(e.t3),e.t0.apply.call(e.t0,e.t1,e.t4),e.next=12,Promise.all(this.shuffle(n.filter((function(e){return e.hasPermission}))).slice(0,r+5).map((function(e){return e.getItem()})));case 12:return e.abrupt("return",e.sent.filter((function(e){var t=e.getFlag("dsa5","enchantments");return!t||!t.find((function(e){return e.talisman}))})).slice(0,r));case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"shuffle",value:function(e){for(var t,r,n=e.length;0!==n;)r=Math.floor(Math.random()*n),t=e[n-=1],e[n]=e[r],e[r]=t;return e}},{key:"findCompendiumItem",value:(p=mc(dc().mark((function e(t,r){var n,a,o,i=arguments;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!(i.length>2&&void 0!==i[2])||i[2],this.equipmentBuild){e.next=4;break}return e.next=4,this.buildEquipmentIndex();case 4:return a={field:["name"],where:{itemType:r}},e.next=7,this.equipmentIndex.search(t,a);case 7:return o=e.sent,n&&(o=o.filter((function(e){return""!=e.compendium}))),e.next=11,Promise.all(o.map((function(e){return e.getItem()})));case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"getCategoryItems",value:(f=mc(dc().mark((function e(t){var r,n=arguments;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]&&n[1],e.next=3,this.buildEquipmentIndex();case 3:if(!r){e.next=7;break}return e.next=6,Promise.all(this.equipmentIndex.search(t,{field:["itemType"]}).map((function(e){return e.getItem()})));case 6:return e.abrupt("return",e.sent.map((function(e){return e.toObject()})));case 7:return e.abrupt("return",this.equipmentIndex.search(t,{field:["itemType"]}));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"executeAdvancedFilter",value:(l=mc(dc().mark((function e(t,r,n,a,o){var i,s,c,u,l,f,p,d=arguments;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=d.length>5&&void 0!==d[5]?d[5]:[],s=function(e){var t,r=oc(n);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(e[a[0]]!=a[1])return!1}}catch(e){r.e(e)}finally{r.f()}return!0},c=function(e){var t,r=oc(a);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(-1==e[n[0]].toLowerCase().indexOf(n[1]))return!1}}catch(e){r.e(e)}finally{r.f()}return!0},u=function(e){var t,r=oc(o);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(e[n[0]]!=n[1])return!1}}catch(e){r.e(e)}finally{r.f()}return!0},l=function(e){var t,r=oc(i);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(e[n[0]]<n[1]||e[n[0]]>n[2])return!1}}catch(e){r.e(e)}finally{r.f()}return!0},f=r.where((function(e){return(""==t||-1!=e.name.toLowerCase().indexOf(t))&&s(e)&&c(e)&&u(e)&&l(e)})),p=(p=f).filter((function(e){return e.hasPermission})).sort((function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1})),e.abrupt("return",p);case 9:case"end":return e.stop()}}),e)}))),function(e,t,r,n,a){return l.apply(this,arguments)})},{key:"advancedFilterStuff",value:(u=mc(dc().mark((function e(t,r){var n,a,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=$(this._element).find(".detailFilters"),a=n.attr("data-subc"),o=this.filters[t].filterBy.search.toLowerCase(),i=this.detailFilter[a],s=[],c=[],u=[],l=oc(n.find("select"));try{for(l.s();!(f=l.n()).done;)p=f.value,""!=(d=$(p).val())&&s.push([$(p).attr("name"),d])}catch(e){l.e(e)}finally{l.f()}h=oc(n.find('input[type="text"]:not(.manualFilter)'));try{for(h.s();!(m=h.n()).done;)y=m.value,""!=(v=$(y).val())&&c.push([$(y).attr("name"),v.toLowerCase()])}catch(e){h.e(e)}finally{h.f()}g=oc(n.find('input[type="checkbox"]:checked:not(.manualFilter)'));try{for(g.s();!(b=g.n()).done;)w=b.value,""!=(k=$(w).val())&&u.push([$(w).attr("name"),k.toLowerCase()])}catch(e){g.e(e)}finally{g.f()}return e.next=15,this.executeAdvancedFilter(o,i,s,c,u);case 15:return x=e.sent,this.setBGImage(x,t),e.abrupt("return",x);case 18:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"filterStuff",value:(c=mc(dc().mark((function e(t,r,n){var a,o,i,s,c,u,l,f;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(c in a=this.filters[t].filterBy.search,o={field:["name","data"],limit:60,page:n||!0},i=[],s=!1,this.filters[t].categories)this.filters[t].categories[c]&&(l=void 0,""==a?l=r.search(c,{field:["itemType"],limit:60,page:n||!0}):(f=duplicate(o),mergeObject(f,{where:{itemType:c}}),l=r.search(a,f)),this.pages[t].next=l.next,(u=i).push.apply(u,rc(l.result))),s=this.filters[t].categories[c]||s;return s||(i=r.search(a,o),this.pages[t].next=i.next),i=(i=i.result?i.result:i).filter((function(e){return e.hasPermission})).sort((function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1})),this.setBGImage(i,t),e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return c.apply(this,arguments)})},{key:"setBGImage",value:function(e,t){$(this._element).find(".".concat(t," .libcontainer"))["".concat(e.length>0?"remove":"add","Class")]("libraryImg")}},{key:"renderResult",value:function(e,t,r,n){var a=r.index,o=r.itemType,i=e.find(".searchResult .item-list");renderTemplate("systems/dsa5/templates/system/libraryItem.html",{items:t}).then((function(e){n||i.empty(),(e=$(e)).each((function(){var e=$(this);e.attr("draggable",!0).on("dragstart",(function(t){var r=a.find($(e).attr("data-item-id"));t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:o,uuid:r.uuid}))}))})),i.append(e)}))}},{key:"filterItems",value:(s=mc(dc().mark((function e(t,r,n){var a,o,i;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.selectIndex(r),!this.advancedFiltering||"journal"==r){e.next=9;break}return e.next=4,this.advancedFilterStuff(r,n);case 4:return o=e.sent,this.renderResult(t,o,a,n),e.abrupt("return",o);case 9:return e.next=11,this.filterStuff(r,a.index,n);case 11:return i=e.sent,this.renderResult(t,i,a,n),e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return s.apply(this,arguments)})},{key:"selectIndex",value:function(e){var t="Item",r=this.equipmentIndex;switch(e){case"zoo":t="Actor",r=this.zooIndex;break;case"journal":t="JournalEntry",r=this.journalIndex}return{index:r,itemType:t}}},{key:"_render",value:(i=mc(dc().mark((function e(){var t,r,n=arguments;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]&&n[0],r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=4,nc(pc(y.prototype),"_render",this).call(this,t,r);case 4:this.buildEquipmentIndex();case 5:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"buildEquipmentIndex",value:(o=mc(dc().mark((function e(){return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._createIndex("equipment","Item",game.items);case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"_createIndex",value:(a=mc(dc().mark((function e(t,r,n){var a,o,i,s,c,u,l,f,p=this;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this["".concat(t,"Build")]){e.next=2;break}return e.abrupt("return");case 2:return SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:0}),a=$(this._element).find('*[data-tab="'.concat(t,'"]')),this.showLoading(a,t),o=game.packs.filter((function(e){return e.documentName==r&&(game.user.isGM||!e.private)})),i=100/(o.length+1),s=i,c=["name","system.type","system.description.value","img"],u="Actor"==r?function(e){return e.getIndex({actorFields:c})}:"JournalEntry"==r?function(e){return e.getDocuments()}:function(e){return e.getDocuments({type:{$in:game.system.documentTypes.Item}})},l=this.indexWorldItems(n,t),SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"world items"}),pct:Math.round(i)}),f=o.map(function(){var e=mc(dc().mark((function e(t){var r;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u(t);case 2:r=e.sent,s+=i,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"".concat(t.metadata.label," (").concat(t.metadata.id,")")}),pct:Math.round(s)}),l.push.apply(l,rc(r.map((function(e){return new bc(e,t.metadata)}))));case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.abrupt("return",Promise.all(f).then((function(e){p["".concat(t,"Index")].add(l),p["".concat(t,"Build")]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:100}),p.hideLoading(a,t)})));case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return a.apply(this,arguments)})},{key:"subcategoryFields",value:function(e){var t,r=["name","itemType"],n=oc(ec[e]||[]);try{for(n.s();!(t=n.n()).done;){var a=t.value;r.push(a.attr)}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"indexWorldItems",value:function(e,t){var r=[];return game.settings.get("dsa5","indexWorldItems")&&(r.push.apply(r,rc(e.filter((function(e){return e.visible})).map((function(e){return new bc(e)})))),this["".concat(t,"WorldBuild")]=!0),r}},{key:"createDetailIndex",value:(n=mc(dc().mark((function e(t,r){var n,a,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.detailFilter[r]){e.next=39;break}n=this.subcategoryFields(r),(a=$(this._element).find('*[data-tab="'.concat(t,'"]'))).find(".searchResult ul").html(""),this.showLoading(a,t),this.detailFilter[r]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:n}}),o=this.selectIndex(t),i=o.index,s=o.itemType,c="Item"==s?game.items:game.actors,u=c.filter((function(e){return e.visible&&e.type==r})).map((function(e){return new wc(e,r)})),l=i.search(r,{field:["itemType"]}),f={},p=oc(l),e.prev=12,p.s();case 14:if((d=p.n()).done){e.next=22;break}if((h=d.value).document.pack){e.next=18;break}return e.abrupt("continue",20);case 18:f[h.document.pack]||(f[h.document.pack]=[]),f[h.document.pack].push(h.document.id);case 20:e.next=14;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(12),p.e(e.t0);case 27:return e.prev=27,p.f(),e.finish(27);case 30:for(m=[],y=0,v=Object.entries(f);y<v.length;y++)g=v[y],m.push(game.packs.get(g[0]).getDocuments({_id:{$in:g[1]},type:r}));return e.next=34,Promise.all(m);case 34:b=e.sent,w=oc(b);try{for(w.s();!(k=w.n()).done;)x=k.value,u.push.apply(u,rc(x.map((function(e){return new wc(e,r)}))))}catch(e){w.e(e)}finally{w.f()}this.detailFilter[r].add(u),this.hideLoading(a,t);case 39:case"end":return e.stop()}}),e,this,[[12,24,27,30]])}))),function(e,t){return n.apply(this,arguments)})},{key:"buildDetailFilter",value:(r=mc(dc().mark((function e(t,r){var n,a,o;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=ec[r]||[])){e.next=11;break}return a=this.createDetailIndex(t,r),e.next=5,renderTemplate("systems/dsa5/templates/system/detailFilter.html",{fields:n,subcategory:r});case 5:return o=e.sent,e.next=8,a;case 8:return e.abrupt("return",o);case 11:return e.abrupt("return","<p>".concat(game.i18n.localize("Library.selectAdvanced"),"</p>"));case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"checkWorldStuffIndex",value:function(){game.settings.get("dsa5","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}},{key:"activateListeners",value:function(t){var r=this;nc(pc(y.prototype),"activateListeners",this).call(this,t),t.on("click",".toggleAdvancedMode",(function(){r.advancedFiltering=!r.advancedFiltering,r.advancedFiltering?($(r._element).find(".toggleAdvancedMode").addClass("on"),$(r._element).find(".advancedSearch").fadeIn(),r.purgeAdvancedFilters()):($(r._element).find(".toggleAdvancedMode").removeClass("on"),$(r._element).find(".advancedSearch").fadeOut())})),t.on("change",".detailFilters input, .detailFilters select",(function(){var e=$(r._element).find(".tab.active"),t=e.attr("data-tab");r.filterItems(e,t)})),t.on("click",".filter",function(){var e=mc(dc().mark((function e(t){var n,a,o,i;return dc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=$(t.currentTarget).closest(".tab"),a=n.attr("data-tab"),o=$(t.currentTarget).attr("data-category"),i=$(t.currentTarget).is(":checked"),!r.advancedFiltering||!i){e.next=13;break}return r.purgeAdvancedFilters(),r.subcategory=o,$(t.currentTarget).prop("checked",i),e.t0=$(r._element).find(".advancedSearch .groupbox"),e.next=11,r.buildDetailFilter(a,o);case 11:e.t1=e.sent,e.t0.html.call(e.t0,e.t1);case 13:r.filters[a].categories[o]=i,r.filterItems(n,a);case 15:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.on("click",".item-name",(function(e){r.getItemFromHTML(e).render()})),t.on("mousedown",".item-name",(function(t){2==t.button&&e.Z.showArtwork(r.getItemFromHTML(t))})),t.on("keyup",".filterBy-search",(function(e){var t=$(e.currentTarget).closest(".tab"),n=t.attr("data-tab");r.filters[n].filterBy.search=$(e.currentTarget).val(),r.filterItems(t,n)})),t.find('*[data-tab="journal"]').click((function(e){r._createIndex("journal","JournalEntry",game.journal)})),t.find('*[data-tab="zoo"]').click((function(e){r._createIndex("zoo","Actor",game.actors)})),t.find(".showDetails").click((function(e){var r=$(e.currentTarget).attr("data-btn");$(e.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),t.find(".".concat(r," .detailBox")).toggleClass("dsahidden")})),t.find(".toggleWorldIndex").click((function(e){game.settings.set("dsa5","indexWorldItems",!game.settings.get("dsa5","indexWorldItems")),r.checkWorldStuffIndex(),$(e.currentTarget).toggleClass("on")})),t.find(".fulltextsearch").click((function(e){game.settings.set("dsa5","indexDescription",!game.settings.get("dsa5","indexDescription")),$(e.currentTarget).toggleClass("on")}));var n=this;$(this._element).find(".window-content").on("scroll.infinit",debounce((function(e){if(!n.advancedFiltering){var r=$(e.target),a=r.scrollTop()+r.innerHeight()>=r[0].scrollHeight-100,o=t.find(".tabs .item.active").attr("data-tab");if(a&&n.pages[o].next){var i=t.find(".tab.active");n.filterItems.call(n,i,o,n.pages[o].next)}}}),100))}},{key:"getItemFromHTML",value:function(e){var t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}},{key:"showLoading",value:function(e,t){this.setBGImage([1],t),$('<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>'.concat(game.i18n.localize("Library.buildingIndex"),"</div>")).appendTo(e.find(".searchResult"))}},{key:"hideLoading",value:function(e,t){this.setBGImage([],t),e.find(".loader").remove()}}],[{key:"defaultOptions",get:function(){var e=nc(pc(y),"defaultOptions",this);return e.id="DSA5ItemLibrary",e.classes.push("dsa5","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("ItemLibrary"),e.template="systems/dsa5/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}}]),y}();function xc(e){return xc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},xc(e)}function _c(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=Oc(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function Oc(e,t){if(e){if("string"==typeof e)return Ec(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ec(e,t):void 0}}function Ec(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Sc(){Sc=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==xc(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Lc(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Tc(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Lc(o,n,a,i,s,"next",e)}function s(e){Lc(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Dc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Pc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ac(e,t){return Ac=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ac(e,t)}function jc(e,t){if(t&&("object"===xc(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function Cc(e){return Cc=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Cc(e)}var Ic=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ac(e,t)}(f,Dialog);var r,a,o,i,s,c,u,l=(c=f,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=Cc(c);if(u){var r=Cc(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return jc(this,e)});function f(e,t,r){var n,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";Dc(this,f);var o,i,s={title:e,content:t,buttons:{initialize:{label:game.i18n.localize("initialize"),callback:(i=Tc(Sc().mark((function e(){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.lock){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,n.initialize();case 4:case"end":return e.stop()}}),e)}))),function(){return i.apply(this,arguments)})},cancel:{label:game.i18n.localize("cancel"),callback:(o=Tc(Sc().mark((function e(){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.lock){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,n.dontInitialize();case 4:case"end":return e.stop()}}),e)}))),function(){return o.apply(this,arguments)})}}};return(n=l.call(this,s)).module=r,n.lang=a,n.folders={},n.journals={},n.scenes={},n.actors={},n.lock=!1,n}return r=f,a=[{key:"initialize",value:(s=Tc(Sc().mark((function e(){var t,r,a=this;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.lock=!0,(t=$(this._element).find(".initialize")).prepend('<i class="fas fa-spinner fa-spin"></i>'),r={},e.prev=4,!game.settings.settings.has("".concat(this.module,".initialized"))){e.next=8;break}return e.next=8,game.settings.set(this.module,"initialized",!0);case 8:e.next=12;break;case 10:e.prev=10,e.t0=e.catch(4);case 12:return e.prev=12,e.next=15,fetch("modules/".concat(this.module,"/adventure").concat(this.lang,".json")).then(function(){var e=Tc(Sc().mark((function e(t){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(function(){var e=Tc(Sc().mark((function e(t){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t;case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 15:e.next=27;break;case 17:return e.prev=17,e.t1=e.catch(12),e.prev=19,e.next=22,fetch("modules/".concat(this.module,"/adventure.json")).then(function(){var e=Tc(Sc().mark((function e(t){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(function(){var e=Tc(Sc().mark((function e(t){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t;case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 22:e.next=27;break;case 24:e.prev=24,e.t2=e.catch(19),console.warn("Could not find book data for ".concat(this.module," import."));case 27:return e.next=29,fetch("modules/".concat(this.module,"/initialization").concat(this.lang,".json")).then(function(){var e=Tc(Sc().mark((function e(t){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(function(){var e=Tc(Sc().mark((function e(t){var o,i,s,c,u,l,f,p,d,h,m;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=t.folders)){e.next=17;break}return e.next=4,a.getFolderForType("JournalEntry");case 4:return i=e.sent,s=t.folders[0].name,i&&(a.folders[i.data.name]=i,t.folders.shift()),e.next=9,Folder.create(o);case 9:c=e.sent,Array.isArray(c)||(c=[c]),u=_c(c);try{for(u.s();!(l=u.n()).done;)f=l.value,a.folders[f.data.name]=f}catch(e){u.e(e)}finally{u.f()}for(d in p=[],a.folders)h=a.folders[d].getFlag("dsa5","parent"),(m=h==s?game.i18n.localize("".concat(a.module,".name")):h)&&p.push({_id:a.folders[d].id,parent:a.folders[m].id});return e.next=17,Folder.updateDocuments(p);case 17:if(!t.items){e.next=19;break}return e.delegateYield(Sc().mark((function e(){var r,o,i,s,c,u;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.getFolderForType("Item");case 2:r=e.sent,o=[],i=[],s=_c(t.items);try{for(u=function(){var e=c.value;e.folder=r.id;var t=game.items.find((function(t){var n;return t.name==e.name&&(null===(n=t.folder)||void 0===n?void 0:n.id)==r.id}));t?(e._id=t.id,i.push(e)):o.push(e)},s.s();!(c=s.n()).done;)u()}catch(e){s.e(e)}finally{s.f()}return e.next=9,n.Z.create(o);case 9:return e.next=11,n.Z.updateDocuments(i);case 11:case"end":return e.stop()}}),e)}))(),"t0",19);case 19:if(!t.playlists){e.next=21;break}return e.delegateYield(Sc().mark((function e(){var r,n,o,i,s,c,u,l;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.getFolderForType("Playlist");case 2:return r=e.sent,n=[],o=[],i=game.packs.get(t.playlists),e.next=8,i.getDocuments();case 8:s=e.sent.map((function(e){return e.toObject()})),c=_c(s);try{for(l=function(){var e=u.value;e.folder=r.id;var t=game.playlists.find((function(t){var n;return t.name==e.name&&(null===(n=t.folder)||void 0===n?void 0:n.id)==r.id}));t?(e._id=t.data._id,o.push(e)):n.push(e)},c.s();!(u=c.n()).done;)l()}catch(e){c.e(e)}finally{c.f()}return e.next=13,Playlist.create(n);case 13:return e.next=15,Playlist.updateDocuments(o);case 15:case"end":return e.stop()}}),e)}))(),"t1",21);case 21:if(!t.scenes){e.next=23;break}return e.delegateYield(Sc().mark((function e(){var r,n,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.getFolderForType("Scene");case 2:return r=e.sent,n=game.packs.get(t.scenes),e.next=6,n.getDocuments();case 6:return o=e.sent.map((function(e){return e.toObject()})),i=game.packs.get(t.journal),e.next=10,i.getDocuments();case 10:return s=e.sent.map((function(e){return e.toObject()})),e.next=13,a.getFolderForType("JournalEntry");case 13:c=e.sent,u=[],l=[],f=new Map,p=!1,d=_c(o),e.prev=19,m=Sc().mark((function e(){var t,n,o,i,d,m,y,v;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.value,n=p,o=game.scenes.find((function(e){var n;return e.name==t.name&&(null===(n=e.folder)||void 0===n?void 0:n.id)==r.id})),p||!o){e.next=10;break}return e.next=6,new Promise((function(e,r){new Dialog({title:game.i18n.localize("Book.sceneReset"),content:game.i18n.format("Book.sceneResetDescription",{name:t.name}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:function(){e([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("LocalizedIDs.all"),callback:function(){e([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:function(){e([!1,!1])}}},close:function(){e([!1,!1])}}).render(!0)}));case 6:i=e.sent,b=2,d=function(e){if(Array.isArray(e))return e}(g=i)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,o=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return o}}(g,b)||Oc(g,b)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),n=d[0],p=d[1];case 10:if(!o||n){e.next=13;break}return a.scenes[o.name]=o,e.abrupt("return","continue");case 13:t.folder=r.id,m=_c(t.notes),e.prev=15,v=Sc().mark((function e(){var r,n,o,i,u,l;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=y.value,e.prev=1,n=s.find((function(e){return e.flags.dsa5.initId==r.entryId})),f.has(n._id)){e.next=26;break}if(o=getProperty(n,"flags.dsa5.parent"),i=c,!a.folders[o]){e.next=10;break}i=a.folders[o],e.next=14;break;case 10:if(!o){e.next=14;break}return e.next=13,a.getFolderForType("JournalEntry",c.id,o,0,getProperty(n,"flags.dsa5.foldercolor")||"");case 13:i=e.sent;case 14:if(n.folder=i.id,!(u=game.journal.find((function(e){var t;return e.name==n.name&&(null===(t=e.folder)||void 0===t?void 0:t.id)==i.id&&e.flags.dsa5.initId==r.entryId})))){e.next=22;break}return e.next=19,u.update(n);case 19:f.set(n._id,u.id),e.next=26;break;case 22:return e.next=24,JournalEntry.create(n);case 24:l=e.sent,f.set(n._id,l.id);case 26:r.entryId=f.get(n._id),e.next=32;break;case 29:e.prev=29,e.t0=e.catch(1),console.warn("Could not initialize Scene Notes for scene :".concat(t.name)+e.t0);case 32:case"end":return e.stop()}}),e,null,[[1,29]])})),m.s();case 18:if((y=m.n()).done){e.next=22;break}return e.delegateYield(v(),"t0",20);case 20:e.next=18;break;case 22:e.next=27;break;case 24:e.prev=24,e.t1=e.catch(15),m.e(e.t1);case 27:return e.prev=27,m.f(),e.finish(27);case 30:o?(t._id=o.id,l.push(t)):u.push(t);case 31:case"end":return e.stop()}var g,b}),e,null,[[15,24,27,30]])})),d.s();case 22:if((h=d.n()).done){e.next=29;break}return e.delegateYield(m(),"t0",24);case 24:if("continue"!==e.t0){e.next=27;break}return e.abrupt("continue",27);case 27:e.next=22;break;case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(19),d.e(e.t1);case 34:return e.prev=34,d.f(),e.finish(34);case 37:return e.next=39,Scene.create(u);case 39:y=e.sent,v=_c(y),e.prev=41,v.s();case 43:if((g=v.n()).done){e.next=53;break}return b=g.value,a.scenes[b.name]=b,e.next=48,b.createThumbnail();case 48:return w=e.sent,e.next=51,b.update({thumb:w.thumb},{diff:!1});case 51:e.next=43;break;case 53:e.next=58;break;case 55:e.prev=55,e.t2=e.catch(41),v.e(e.t2);case 58:return e.prev=58,v.f(),e.finish(58);case 61:k=0,x=l;case 62:if(!(k<x.length)){e.next=71;break}return _=x[k],O=game.scenes.get(_._id),e.next=67,O.update(_);case 67:a.scenes[_.name]=game.scenes.get(_._id);case 68:k++,e.next=62;break;case 71:if(!t.initialScene){e.next=79;break}return E=a.scenes[t.initialScene],e.next=75,game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0);case 75:return e.next=77,E.activate();case 77:return e.next=79,E.update({navigation:!0});case 79:case"end":return e.stop()}}),e,null,[[19,31,34,37],[41,55,58,61]])}))(),"t2",23);case 23:if(!t.actors){e.next=25;break}return e.delegateYield(Sc().mark((function e(){var n,o,i,s,c,u,l,f,p,d,h,m,y,v,g,b,w,k,x,_,O,E,S,L;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.getFolderForType("Actor");case 2:return n=e.sent,o=game.packs.get(t.actors),e.next=6,o.getDocuments();case 6:if(i=e.sent.map((function(e){return e.toObject()})),s=[],c=[],u=new Map,l=0,!getProperty(r,"chapters")){e.next=50;break}f=_c(r.chapters),e.prev=13,f.s();case 15:if((p=f.n()).done){e.next=42;break}d=p.value,h=_c(d.content),e.prev=18,h.s();case 20:if((m=h.n()).done){e.next=32;break}if(!(y=m.value).actors){e.next=30;break}v=!1,g=_c(y.actors);try{for(g.s();!(b=g.n()).done;)w=b.value,u.has(w)||(u.set(w,y.name),v=!0)}catch(e){g.e(e)}finally{g.f()}if(!v){e.next=30;break}return e.next=29,a.getFolderForType("Actor",n.id,y.name,l);case 29:l+=1;case 30:e.next=20;break;case 32:e.next=37;break;case 34:e.prev=34,e.t0=e.catch(18),h.e(e.t0);case 37:return e.prev=37,h.f(),e.finish(37);case 40:e.next=15;break;case 42:e.next=47;break;case 44:e.prev=44,e.t1=e.catch(13),f.e(e.t1);case 47:return e.prev=47,f.f(),e.finish(47);case 50:k=_c(i),e.prev=51,_=Sc().mark((function e(){var t,r,o;return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=x.value,!u.has(t.name)){e.next=7;break}return e.next=4,a.getFolderForType("Actor",n.id,u.get(t.name));case 4:e.t0=e.sent,e.next=8;break;case 7:e.t0=n;case 8:if(r=e.t0,t.folder=r.id,t._id&&delete t._id,!(o=game.actors.find((function(e){var a;return e.name==t.name&&[n.id,r.id].includes(null===(a=e.folder)||void 0===a?void 0:a.id)})))){e.next=19;break}return t._id=o.id,e.next=16,o.deleteEmbeddedDocuments("Item",o.items.map((function(e){return e.id})));case 16:c.push(t),e.next=20;break;case 19:s.push(t);case 20:case"end":return e.stop()}}),e)})),k.s();case 54:if((x=k.n()).done){e.next=58;break}return e.delegateYield(_(),"t2",56);case 56:e.next=54;break;case 58:e.next=63;break;case 60:e.prev=60,e.t3=e.catch(51),k.e(e.t3);case 63:return e.prev=63,k.f(),e.finish(63);case 66:return e.next=68,Actor.create(s);case 68:return O=e.sent,e.next=71,Actor.updateDocuments(c);case 71:E=_c(O);try{for(E.s();!(S=E.n()).done;)L=S.value,a.actors[L.name]=L}catch(e){E.e(e)}finally{E.f()}case 73:case"end":return e.stop()}}),e,null,[[13,44,47,50],[18,34,37,40],[51,60,63,66]])}))(),"t3",25);case 25:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 29:return this.lock=!1,t.find("i").remove(),ui.notifications.notify(game.i18n.localize("initComplete")),e.next=34,this.close();case 34:case"end":return e.stop()}}),e,this,[[4,10],[12,17],[19,24]])}))),function(){return s.apply(this,arguments)})},{key:"dontInitialize",value:(i=Tc(Sc().mark((function e(){return Sc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!game.settings.settings.has("".concat(this.module,".initialized"))){e.next=3;break}return e.next=3,game.settings.set(this.module,"initialized",!0);case 3:return ui.notifications.notify(game.i18n.localize("initSkipped")),e.next=6,this.close();case 6:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"submit",value:function(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(e){throw ui.notifications.error(e),new Error(e)}}},{key:"getFolderForType",value:(o=Tc(Sc().mark((function t(r){var n,a,o,i,s=arguments;return Sc().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=s.length>1&&void 0!==s[1]?s[1]:null,a=s.length>2&&void 0!==s[2]?s[2]:null,o=s.length>3&&void 0!==s[3]?s[3]:0,i=s.length>4&&void 0!==s[4]?s[4]:"",a||(a=game.i18n.localize("".concat(this.module,".name"))),t.abrupt("return",e.Z.getFolderForType(r,n,a,o,i));case 6:case"end":return t.stop()}}),t,this)}))),function(e){return o.apply(this,arguments)})}],a&&Pc(r.prototype,a),Object.defineProperty(r,"prototype",{writable:!1}),f}();function Mc(e){return Mc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Mc(e)}function Nc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Rc(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function zc(e,t,r){return t&&Rc(e.prototype,t),r&&Rc(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Fc(){return Fc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=Gc(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},Fc.apply(this,arguments)}function Gc(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=qc(e)););return e}function Zc(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Bc(e,t)}function Bc(e,t){return Bc=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Bc(e,t)}function Hc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=qc(e);if(t){var a=qc(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Wc(this,r)}}function Wc(e,t){if(t&&("object"===Mc(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function qc(e){return qc=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},qc(e)}var $c=function(e){Zc(r,ChatMessage);var t=Hc(r);function r(){return Nc(this,r),t.apply(this,arguments)}return zc(r,[{key:"isRoll",get:function(){return this.isDSARoll||Fc(qc(r.prototype),"isRoll",this)}},{key:"roll",get:function(){return this.isDSARoll?new Uc(""):Fc(qc(r.prototype),"roll",this)}},{key:"isDSARoll",get:function(){return!!this.flags.data&&this.flags.data.isDSARoll}}]),r}(),Uc=function(e){Zc(r,Roll);var t=Hc(r);function r(){return Nc(this,r),t.apply(this,arguments)}return zc(r,[{key:"render",value:function(){return""}}]),r}();function Yc(e){return Yc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Yc(e)}function Vc(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Kc(){Kc=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new _(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=w(i,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};s(h,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(O([])));y&&y!==t&&r.call(y,a)&&(h=y);var v=d.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==Yc(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;this._invoke=function(e,r){function o(){return new t((function(t,a){n(e,r,t,a)}))}return a=a?a.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return p.prototype=d,s(v,"constructor",d),s(d,"constructor",p),p.displayName=s(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},g(b.prototype),s(b.prototype,o,(function(){return this})),e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(c(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},g(v),s(v,i,"Generator"),s(v,a,(function(){return this})),s(v,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),x(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;x(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function Jc(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function Qc(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){Jc(o,n,a,i,s,"next",e)}function s(e){Jc(o,n,a,i,s,"throw",e)}i(void 0)}))}}function Xc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function eu(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function tu(){return tu="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=ru(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(arguments.length<3?e:r):a.value}},tu.apply(this,arguments)}function ru(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ou(e)););return e}function nu(e,t){return nu=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},nu(e,t)}function au(e,t){if(t&&("object"===Yc(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function ou(e){return ou=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ou(e)}var iu=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&nu(e,t)}(u,Hotbar);var t,r,n,a,o,i,s,c=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=ou(i);if(s){var r=ou(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return au(this,e)});function u(){return Xc(this,u),c.apply(this,arguments)}return t=u,r=[{key:"_render",value:(o=Qc(Kc().mark((function e(){var t,r,n=arguments;return Kc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]&&n[0],r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=4,tu(ou(u.prototype),"_render",this).call(this,t,r);case 4:this.addContextColor();case 5:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"collapse",value:(a=Qc(Kc().mark((function e(){return Kc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._collapsed){e.next=2;break}return e.abrupt("return",!0);case 2:return $(this.element).addClass("collapsedHotbar"),e.abrupt("return",tu(ou(u.prototype),"collapse",this).call(this));case 4:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"expand",value:(n=Qc(Kc().mark((function e(){return Kc().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._collapsed){e.next=2;break}return e.abrupt("return",!0);case 2:return $(this.element).removeClass("collapsedHotbar"),e.abrupt("return",tu(ou(u.prototype),"expand",this).call(this));case 4:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"addContextColor",value:function(){var e,t=new RegExp(" ".concat(game.i18n.localize("CHAR.PARRY"),"$")),r=new RegExp(" ".concat(game.i18n.localize("CHAR.ATTACK"),"$")),n=$(this._element).find("#macro-list"),a=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Vc(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Vc(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}(this.macros);try{for(a.s();!(e=a.n()).done;){var o=e.value;o.macro&&(t.test(o.macro.name)?n.find('[data-macro-id="'.concat(o.macro.id,'"]')).addClass("parry"):r.test(o.macro.name)&&n.find('[data-macro-id="'.concat(o.macro.id,'"]')).addClass("attack"))}}catch(e){a.e(e)}finally{a.f()}}}],r&&eu(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),u}();function su(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var cu,uu,lu,fu,pu,du,hu,mu,yu,vu,gu,bu,wu,ku,xu,_u,Ou,Eu,Su,Lu,Tu,Du=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.tokens={},this.actors={}}var t,r,n;return t=e,r=[{key:"getPath",value:function(e,t,r){var n=r||"",a=t._id||t.type;return e.token?"tokens.".concat(e.token||e.actor,".").concat(a).concat(n):"actors.".concat(e.actor,".").concat(a).concat(n)}},{key:"remember",value:function(e,t,r,n){var a=this.formDataSerialize(n);Object.entries(a).length>0&&setProperty(this,this.getPath(e,t,r),a)}},{key:"recall",value:function(e,t,r){return getProperty(this,this.getPath(e,t,r))}},{key:"formDataSerialize",value:function(t){var r=t.find("form"),n={};return r.find("select").each((function(){var t=$(this).attr("name");e.wantedKeys.includes(t)&&(n[t]=$(this).val())})),r.find('input[type="checkbox"]').each((function(){var t=$(this).attr("name");e.wantedKeys.includes(t)&&(n[t]=this.checked)})),r.find(".specAbs.active").each((function(){n.specAbs||(n.specAbs=[]),n.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})})),t.find('[name="situationalModifiers"] option').each((function(){n.situationalModifiers||(n.situationalModifiers=[]),n.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})})),n}}],n=[{key:"wantedKeys",get:function(){var e=["vision","targetMovement","shooterMovement","quickChange","mountOptions","narrowSpace","advantageousPosition","doubleAttack","reduceCostSpell","forceSpell","increaseCastingTime","decreaseCastingTime","removeGesture","removeFormula"];return game.settings.get("dsa5","enableDPS")||e.push("distance"),e}}],r&&su(t.prototype,r),n&&su(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}(),Pu=__webpack_require__(430);Hooks.once("init",(function(){console.log("Initializing DSA5 system"),CONFIG.statusEffects=t.Z.statusEffects,game.dsa5={apps:{ActorSheetdsa5:Q,ActorSheetdsa5Character:ct,ActorSheetdsa5Creature:kt,ActorSheetdsa5NPC:Pt,MerchantSheetMixin:jn,ItemSheetdsa5:Kt,DSA5_Utility:e.Z,DSA5Initializer:Ic,DSA5ChatListeners:o.Z,DSA5Payment:un,SpecialabilityRulesDSA5:a.Z,AdvantageRulesDSA5:r.Z,Migrakel:m,DSA5Dialog:Fn.Z,DSA5StatusEffects:i.Z,DPS:Ia.Z,DSATables:Pu.Z,DiceDSA5:jt.Z,DSATour:Cs.Z},entities:{Actordsa5:T.Z,Itemdsa5:n.Z},macro:Hs,config:t.Z,memory:new Du,itemLibrary:new kc,lazy:{LazyImporter:Vs}},CONFIG.Actor.documentClass=T.Z,CONFIG.Item.documentClass=n.Z,CONFIG.ChatMessage.template="systems/dsa5/templates/chat/chat-message.html",CONFIG.ChatMessage.documentClass=$c,CONFIG.ui.combat=Do,CONFIG.ui.hotbar=iu,CONFIG.Combat.documentClass=Po,CONFIG.Combatant.documentClass=Ao})),Handlebars.registerHelper({concat:function(){var e;return(e=HandlebarsHelpers).concat.apply(e,arguments).string},concatUp:function(e,t){return e+t.toUpperCase()},mod:function(e,t){return e%t},roman:function(e,t){return null!=t&&Number(t)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][e-1]},isWEBM:function(e){return/.webm$/.test(e)},joinStr:function(e,t){return t.join(e)},diceThingsUp:function(t,r){return e.Z.replaceDies(t,!1)},replaceConditions:e.Z.replaceConditions,floor:function(e){return Math.floor(Number(e))},hasElem:function(e,t){return e.includes(t)},enrich:function(e,t){return TextEditor.enrichHTML(e,{secrets:t,documents:!0,async:!1})},grouped_each:function(e,t,r){var n,a="",o=[];if(t&&t.length>0){for(n=0;n<t.length;n++)n>0&&n%e==0&&(a+=r.fn(o),o=[]),o.push(t[n]);a+=r.fn(o)}return a},plantify:function(e){return game.i18n.localize("PLANT.avLevels.".concat(e||0))}}),Hooks.once("init",(function(){game.dsa5.apps.DiceSoNiceCustomization=new Fr})),Hooks.once("diceSoNiceReady",(function(e,t,r,n){e.addColorset({name:"mu",description:"DSA5.mu",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"kl",description:"DSA5.kl",category:"DSA5.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"in",description:"DSA5.in",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ch",description:"DSA5.ch",category:"DSA5.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ff",description:"DSA5.ff",category:"DSA5.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ge",description:"DSA5.ge",category:"DSA5.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ko",description:"DSA5.ko",category:"DSA5.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"kk",description:"DSA5.kk",category:"DSA5.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"attack",description:"DSA5.attack",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),e.addColorset({name:"dodge",description:"DSA5.dodge",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"parry",description:"DSA5.parry",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),game.dsa5.apps.DiceSoNiceCustomization.initConfigs(),Fr.onConnect()})),function(){Hooks.on("deleteActiveEffect",(function(e){var t=e.parent;if(t&&"Actor"==t.documentName){var r=getProperty(e,"flags.core.statusId");if("bloodrush"==r)return t.addCondition("stunned",2,!1,!1),!1;if("dead"==r&&game.combat)return t.markDead(!1),!1;if(Zr.Z.onEffectRemove(t,e),!1===Hooks.call("deleteActorActiveEffect",t,e))return!1}}));var t=function(e){var t;new Dialog({title:game.i18n.localize("DSASETTINGS.obfuscateTokenNames"),content:'<label for="name">'.concat(game.i18n.localize("DSASETTINGS.rename"),'</label> <input dtype="string" name="name" type="text" value="').concat(e.name,'"/>'),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:(t=Ur(qr().mark((function t(r){var n,a;return qr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.find('[name="name"]').val(),a=canvas.scene.tokens.find((function(t){var r;return(null===(r=t.actor)||void 0===r?void 0:r.id)===e.id})),t.next=4,a.update({name:n});case 4:case"end":return t.stop()}}),t)}))),function(e){return t.apply(this,arguments)})},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)},r=function(){var e=Ur(qr().mark((function e(r,n){var a,o,i,s,c,u;return qr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("0"!=(a=game.settings.get("dsa5","obfuscateTokenNames"))&&"loot"!=getProperty(r,"merchant.merchantType")){e.next=3;break}return e.abrupt("return");case 3:o=Hr(game.users),e.prev=4,o.s();case 6:if((i=o.n()).done){e.next=14;break}if(!(s=i.value).isGM){e.next=10;break}return e.abrupt("continue",12);case 10:if(!r.testUserPermission(s,"LIMITED")){e.next=12;break}return e.abrupt("return");case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),o.e(e.t0);case 19:return e.prev=19,o.f(),e.finish(19);case 22:c=canvas.scene.tokens.filter((function(e){return e.actor&&e.actor.id===r.id})),u=game.i18n.localize("unknown"),c.length>0&&(u="".concat(c[0].name.replace(/ \d{1,}$/)," ").concat(c.length+1)),"2"==a&&0==c?t(r):n.name=u;case 26:case"end":return e.stop()}}),e,null,[[4,16,19,22]])})));return function(t,r){return e.apply(this,arguments)}}();Hooks.on("preCreateToken",(function(t,n,a,o){var i=t.actor;if(i){var s={};"loot"==getProperty(i,"system.merchant.merchantType")?mergeObject(s,{displayBars:0}):getProperty(i,"system.config.autoBar")&&(mergeObject(s,{bar1:{attribute:"status.wounds"}}),i.system.isMage?mergeObject(s,{bar2:{attribute:"status.astralenergy"}}):i.system.isPriest?mergeObject(s,{bar2:{attribute:"status.karmaenergy"}}):mergeObject(s,{bar2:{attribute:"tbd"}})),"creature"==i.type&&getProperty(i,"system.config.autoSize")&&e.Z.calcTokenSize(i,s),r(i,s),t.updateSource(s)}}))}(),Hooks.on("hotbarDrop",function(){var e=Jr(Vr().mark((function e(t,r,n){var a,o,i,s,c,u,l,f,p,d;return Vr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("dodge"!=r.mod){e.next=7;break}return a={name:game.i18n.localize(r.mod),img:"systems/dsa5/icons/categories/Dodge.webp"},o=game.user.isGM||null==r.actorId?'game.dsa5.macro.charMacro("'.concat(r.mod,'")'):'game.dsa5.macro.charMacroById("'.concat(r.mod,'", "').concat(r.actorId,'")'),e.next=5,Qr(o,a.name,a.img,n);case 5:case 12:case 30:e.next=39;break;case 7:if("attackWeaponless"!=r.mod&&"parryWeaponless"!=r.mod){e.next=14;break}return i={name:game.i18n.localize(r.mod),img:"systems/dsa5/icons/categories/attack_weaponless.webp"},s=game.user.isGM||null==r.actorId?'game.dsa5.macro.weaponLessMacro("'.concat(r.mod,'")'):'game.dsa5.macro.weaponLessMacroId("'.concat(r.mod,'", "').concat(r.actorId,'")'),e.next=12,Qr(s,i.name,i.img,n);case 14:if("Item"!=r.type){e.next=32;break}if(["ritual","ceremony","meleeweapon","rangeweapon","skill","combatskill","spell","liturgy","char","trait"].includes(r.data.type)){e.next=18;break}return e.abrupt("return");case 18:if("meleeweapon"!=r.data.type&&"combatskill"!=r.data.type||["attack","parry"].includes(r.mod)){e.next=22;break}return e.abrupt("return");case 22:if("rangeweapon"!=r.data.type&&"trait"!=r.data.type||["attack"].includes(r.mod)){e.next=24;break}return e.abrupt("return");case 24:return c=r.data,u='{mod: "'.concat(r.mod,'"}'),l=game.user.isGM||null==r.actorId?'game.dsa5.macro.itemMacro("'.concat(c.name,'", "').concat(c.type,'", ').concat(u,");"):'game.dsa5.macro.itemMacroById("'.concat(r.actorId,'", "').concat(c.name,'", "').concat(c.type,'", ').concat(u,")"),f=null==r.mod?c.name:"".concat(c.name," - ").concat(game.i18n.localize("CHAR."+r.mod.toUpperCase())),e.next=30,Qr(l,f,c.img,n);case 32:if("Actor"!=r.type&&"JournalEntry"!=r.type){e.next=39;break}return e.next=35,fromUuid(r.uuid);case 35:return p=e.sent,d="(await fromUuid('".concat(r.uuid,"')).sheet.render(true)"),e.next=39,Qr(d,p.name,p.img,n);case 39:return e.abrupt("return",!1);case 40:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),Hooks.on("renderChatLog",(function(e,t,r){en.Z.chatListeners(t),jt.Z.chatListeners(t),un.chatListeners(t);var n=new I.Z;Hooks.call("startDSA5ChatAutoCompletion",n),n.chatListeners(t),o.Z.chatListeners(t)})),Hooks.on("renderChatMessage",(function(t,r,n){if(!game.user.isGM){var a;r.find(".chat-button-gm").remove();var o=r.find(".chat-button-target");o.length&&(a=ln.ZP.getTargetActor(n.message))&&a.actor&&!a.actor.isOwner&&o.remove();var s=e.Z.getSpeaker(n.message.speaker);s&&!s.isOwner&&(r.find(".selfButton").remove(),r.find(".d20").data("tooltip",""));var c=r.find(".onlyTarget");c.length&&(a=e.Z.getSpeaker({token:c.attr("data-token"),actor:c.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}))&&!a.isOwner&&c.remove(),r.find(".hideData").remove(),getProperty(n.message,"flags.dsa5.userHidden.".concat(game.user.id))&&r.find(".payButton").remove()}game.settings.get("dsa5","expandChatModifierlist")&&(r.find(".expand-mods i").toggleClass("fa-minus fa-plus"),r.find(".expand-mods + ul").css({display:"block"})),i.Z.bindButtons(r)})),Hooks.on("chatMessage",(function(t,r,n){var a=r.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(a=a?a[0]:""){case"/pay":return game.user.isGM?un.createPayChatMessage(r):un.payMoney(e.Z.getSpeaker(n.speaker),r),!1;case"/getPaid":return game.user.isGM?un.createGetPaidChatMessage(r):un.getMoney(e.Z.getSpeaker(n.speaker),r),!1;case"/help":return o.Z.getHelp(),!1;case"/conditions":return o.Z.showConditions(),!1;case"/tables":return o.Z.showTables(),!1}})),Hooks.on("ready",Da(La().mark((function t(){return La().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(game.socket.on("system.dsa5",(function(e){if("hideDeletedSheet"===e.type){var t=e.payload.target.token?game.actors.tokens[e.payload.target.token]:game.actors.get(e.payload.target.actor);zn.hideDeletedSheet(t)}})),game.user.isGM&&game.socket.on("system.dsa5",(function(e){switch(e.type){case"target":var t=game.scenes.get(e.payload.scene);new Token(t.getEmbeddedDocument("Token",e.payload.target)).actor.update({"flags.oppose":e.payload.opposeFlag});break;case"addEffect":Zr.Z.applyEffect(e.payload.id,e.payload.mode,e.payload.actors);break;case"updateMsg":game.messages.get(e.payload.id).update(e.payload.updateData);break;case"deleteMsg":game.messages.get(e.payload.id).delete();break;case"showDamage":en.Z.showDamage(game.messages.get(e.payload.id),e.payload.hide);break;case"hideQueryButton":en.Z.hideReactionButton(e.payload.id);break;case"updateGroupCheck":sa.Z.rerenderGC(game.messages.get(e.payload.messageId),e.payload.data);break;case"updateAttackMessage":game.messages.get(e.payload.messageId).update({"flags.data.unopposedStartMessage":e.payload.startMessageId});break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"clearOpposed":en.Z.clearOpposed(game.actors.get(e.payload.actorId));break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(e.payload.speaker);break;case"trade":var r=e.payload.source.token?game.actors.tokens[e.payload.source.token]:game.actors.get(e.payload.source.actor),n=e.payload.target.token?game.actors.tokens[e.payload.target.token]:game.actors.get(e.payload.target.actor);zn.finishTransaction(r,n,e.payload.price,e.payload.itemId,e.payload.buy,e.payload.amount);break;case"playWhisperSound":e.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:e.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(e.payload.id).then((function(t){new A.Z(t).socketedConditionAddActor(e.payload.actors.map((function(e){return game.actors.get(e)})),e.payload.data)}));break;case"socketedConditionAdd":fromUuid(e.payload.id).then((function(t){new A.Z(t).socketedConditionAdd(e.payload.targets,e.payload.data)}));break;case"socketedRemoveCondition":fromUuid(e.payload.id).then((function(t){new A.Z(t).socketedRemoveCondition(e.payload.targets,e.payload.coreId)}));break;case"socketedActorTransformation":fromUuid(e.payload.id).then((function(t){new A.Z(t).socketedActorTransformation(e.payload.targets,e.payload.update)}));break;case"itemDrop":var a=e.payload.sourceActorId?game.actors.get(e.payload.sourceActorId):void 0;fromUuid(e.payload.itemId).then((function(t){xa(a,t,e.payload.data,e.payload.amount)}));break;case"hideDeletedSheet":case"finalizeidentification":case"updateHits":case"hideResistButton":break;case"summonCreature":aa.createConjuration(e.payload);break;default:console.warn("Unhandled socket data type ".concat(e.type))}})),t.t1=e.Z.moduleEnabled("vtta-tokenizer"),!t.t1){t.next=7;break}return t.next=6,game.settings.get("dsa5","tokenizerSetup");case 6:t.t1=!t.sent;case 7:if(t.t0=t.t1,!t.t0){t.next=10;break}t.t0=game.user.isGM;case 10:if(!t.t0){t.next=19;break}return t.next=13,game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsa5/icons/backgrounds/token_green.webp");case 13:return t.next=15,game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsa5/icons/backgrounds/token_black.webp");case 15:return t.next=17,game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsa5/icons/backgrounds/token_blue.webp");case 17:return t.next=19,game.settings.set("dsa5","tokenizerSetup",!0);case 19:if(t.t3=e.Z.moduleEnabled("dice-so-nice"),!t.t3){t.next=24;break}return t.next=23,game.settings.get("dsa5","diceSetup");case 23:t.t3=!t.sent;case 24:if(t.t2=t.t3,!t.t2){t.next=27;break}t.t2=game.user.isGM;case 27:if(!t.t2){t.next=32;break}return t.next=30,game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0);case 30:return t.next=32,game.settings.set("dsa5","diceSetup",!0);case 32:return t.next=34,yn.firstTimeMessage();case 34:n.Z.setupSubClasses();case 35:case"end":return t.stop()}}),t)})))),cu=function(t,r){return e.Z.fateAvailable(t,r)},uu=function(e){var t=game.messages.get(e.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&e.find(".opposed-card").length||e.find(".dice-roll").length)&&t&&t.damage.value>0},lu=function(e){var t=game.messages.get(e.attr("data-message-id")).flags.opposeData;return(game.user.isGM&&e.find(".opposed-card").length||e.find(".dice-roll").length)&&t&&t.damage.sp>0},fu=function(e){var t=game.messages.get(e.attr("data-message-id"));return!(!t.speaker.actor||!t.flags.data||!game.actors.get(t.speaker.actor).isOwner&&!game.user.isGM)&&(["liturgy","ceremony","spell","ritual","magicalsign"].includes(t.flags.data.preData.source.type)||getProperty(t.flags.data.preData,"calculatedSpellModifiers.costsMana"))},pu=function(e){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){var t=game.messages.get(e.attr("data-message-id"));return"hideData"in t.flags&&t.flags.hideData}return!1},du=function(e){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){var t=game.messages.get(e.attr("data-message-id"));return"hideData"in t.flags&&!t.flags.hideData}return!1},hu=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=game.messages.get(e.attr("data-message-id"));if(r.speaker.actor&&r.flags.data&&r.flags.data.postData.successLevel>-2){var n=game.actors.get(r.speaker.actor);if(n.isOwner&&cu(n,t)){var a=r.flags.data.preData.source.type,o=r.flags.data.preData.mode||"";["skill","spell","liturgy","ritual","ceremony"].includes(a)&&(a="char");var i=game.i18n.localize("SCHIPSKILLS.".concat(a).concat(o));return!r.flags.data.fateImproved&&n.items.getName(i)}}return!1},mu=function(e){return hu(e,!0)},yu=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=game.messages.get(e.attr("data-message-id"));if(r.speaker.actor&&r.flags.data){var n=game.actors.get(r.speaker.actor);if(n.isOwner&&cu(n,t)&&!r.flags.data.fatePointAddQSUsed)return r.flags.data.postData.successLevel>0&&null!=r.flags.data.postData.qualityStep}return!1},vu=function(e){return yu(e,!0)},gu=function(e){var t=game.messages.get(e.attr("data-message-id"));if(t.speaker.actor&&t.flags.data){var r=game.actors.get(t.speaker.actor);if(r.isOwner)return null!=r.items.find((function(e){return e.name=="".concat(game.i18n.localize("LocalizedIDs.aptitude")," (").concat(t.flags.data.preData.source.name,")")}))&&!t.flags.data.talentedRerollUsed}return!1},bu=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=game.messages.get(e.attr("data-message-id"));if(r.speaker.actor&&r.flags.data){var n=game.actors.get(r.speaker.actor);if(n.isOwner&&cu(n,t))return null!=r.flags.data.postData.damageRoll&&!r.flags.data.fatePointDamageRerollUsed}return!1},wu=function(e){return bu(e,!0)},ku=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=game.messages.get(e.attr("data-message-id"));if(r.speaker.actor&&r.flags.data){var n=game.actors.get(r.speaker.actor);if(n.isOwner&&cu(n,t))return!(r.flags.data.fatePointRerollUsed||"regenerate"==r.flags.data.postData.rollType)}return!1},xu=function(e){return ku(e,!0)},_u=function(e){var t=game.messages.get(e.attr("data-message-id"));return!!(t.speaker.actor&&t.flags.data&&game.actors.get(t.speaker.actor).isOwner&&null!=getProperty(t.flags,"data.postData.LeP"))&&!t.flags.data.healApplied},Ou=function(e){if(game.user.isGM){var t=game.messages.get(e.attr("data-message-id"));if("hideData"in t.flags){var r=!t.flags.hideData,n=$(t.content);n.find(".hideAnchor")[r?"addClass":"removeClass"]("hideData"),n=$("<div></div>").append(n),t.update({content:n.html(),"flags.hideData":r})}}},Eu=function(e){var t=game.messages.get(e.data("messageId"));return!(!t||!canvas.tokens)&&t.isRoll&&t.isContentVisible&&canvas.tokens.controlled.length&&e.find(".dice-roll").length},Su=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=game.messages.get(e.attr("data-message-id"));game.actors.get(n.speaker.actor).useFateOnRoll(n,t,r)},Lu=function(){var t=Ca(Aa().mark((function t(r,n){var a,o,i,s;return Aa().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=game.messages.get(r.attr("data-message-id")),o=a.flags.opposeData,i=o.speakerDefend,(s=e.Z.getSpeaker(i)).isOwner){t.next=6;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.DamagePermission")));case 6:return t.next=8,s.applyDamage(o.damage[n]);case 8:return t.next=10,a.update({"flags.data.damageApplied":!0,content:a.content.replace(/hideAnchor">/,'hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="'.concat(game.i18n.localize("damageApplied"),'"></i>'))});case 10:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}(),Tu=function(e,t){var r=game.messages.get(e.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map((function(e){var n=e.actor,a="sp"!=t?r.total-T.Z.armorValue(n).armor:r.total;return n.applyDamage(Math.max(0,a))})))},Hooks.on("getChatLogEntryContext",(function(t,r){var n,a;r.push({name:game.i18n.localize("CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:du,callback:function(e){Ou(e)}},{name:game.i18n.localize("CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:pu,callback:function(e){Ou(e)}},{name:game.i18n.localize("regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:_u,callback:(a=Ca(Aa().mark((function t(r){var n,a;return Aa().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,game.messages.get(r.attr("data-message-id"));case 2:if(n=t.sent,(a=e.Z.getSpeaker(n.speaker)).isOwner){t.next=6;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.DamagePermission")));case 6:return t.next=8,n.update({"flags.data.healApplied":!0,content:n.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')});case 8:return t.next=10,a.applyRegeneration(n.flags.data.postData.LeP,n.flags.data.postData.AsP,n.flags.data.postData.KaP);case 10:case"end":return t.stop()}}),t)}))),function(e){return a.apply(this,arguments)})},{name:game.i18n.localize("CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:fu,callback:(n=Ca(Aa().mark((function t(r){var n,a,o;return Aa().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=game.messages.get(r.attr("data-message-id")),a=n.flags.data,(o=e.Z.getSpeaker(n.speaker)).isOwner){t.next=5;break}return t.abrupt("return",ui.notifications.error(game.i18n.localize("DSAError.DamagePermission")));case 5:return t.next=7,o.applyMana(a.preData.calculatedSpellModifiers.finalcost,["ritual","spell"].includes(a.preData.source.type)||getProperty(a.preData.calculatedSpellModifiers,"costsMana")?"AsP":"KaP");case 7:return t.next=9,n.update({"flags.data.manaApplied":!0,content:n.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')});case 9:case"end":return t.stop()}}),t)}))),function(e){return n.apply(this,arguments)})},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:uu,callback:function(e){Lu(e,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:lu,callback:function(e){Lu(e,"sp")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:Eu,callback:function(e){Tu(e,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:Eu,callback:function(e){Tu(e,"sp")}},{name:game.i18n.localize("CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:ku,callback:function(e){Su(e,"reroll")}},{name:game.i18n.localize("CHATCONTEXT.RerollGroup"),icon:'<i class="fas fa-dice"></i>',condition:xu,callback:function(e){Su(e,"reroll",1)}},{name:game.i18n.localize("CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:gu,callback:function(e){Su(e,"isTalented")}},{name:game.i18n.localize("CHATCONTEXT.AddQS"),icon:'<i class="fas fa-plus-square"></i>',condition:yu,callback:function(e){Su(e,"addQS")}},{name:game.i18n.localize("CHATCONTEXT.AddQSGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:vu,callback:function(e){Su(e,"addQS",1)}},{name:game.i18n.localize("CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:bu,callback:function(e){Su(e,"rerollDamage")}},{name:game.i18n.localize("CHATCONTEXT.rerollDamageGroup"),icon:'<i class="fas fa-dice"></i>',condition:wu,callback:function(e){Su(e,"rerollDamage",1)}},{name:game.i18n.localize("CHATCONTEXT.improveFate"),icon:'<i class="fas fa-plus-square"></i>',condition:hu,callback:function(e){Su(e,"Improve")}},{name:game.i18n.localize("CHATCONTEXT.improveFateGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:mu,callback:function(e){Su(e,"Improve",1)}})})),function(){Token.prototype.drawEffects=Ga(Na().mark((function e(){var t,r,n,a,o,i,s,c,u,l,f,p,d,h;return Na().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.effects.removeChildren().forEach((function(e){return e.destroy()})),t=this.document.effects,!this.actor){e.next=8;break}return e.next=5,this.actor.actorEffects();case 5:e.t0=e.sent,e.next=9;break;case 8:e.t0=[];case 9:if(r=e.t0,n={src:this.document.overlayEffect,tint:null},!t.length&&!r.length){e.next=43;break}a=[],o=2*Math.round(canvas.dimensions.size/2/5),i=this.effects.addChild(new PIXI.Graphics).beginFill(0,.4).lineStyle(1,0),s=0,c=Ra(r),e.prev=17,c.s();case 19:if((u=c.n()).done){e.next=31;break}if((l=u.value).icon){e.next=23;break}return e.abrupt("continue",29);case 23:if(f=l.tint?colorStringToHex(l.tint):null,!l.getFlag("core","overlay")){e.next=27;break}return n={src:l.icon,tint:f},e.abrupt("continue",29);case 27:a.push(this._drawEffect(l.icon,s,i,o,f,getProperty(l,"flags.dsa5.value"))),s++;case 29:e.next=19;break;case 31:e.next=36;break;case 33:e.prev=33,e.t1=e.catch(17),c.e(e.t1);case 36:return e.prev=36,c.f(),e.finish(36);case 39:p=Ra(t);try{for(p.s();!(d=p.n()).done;)h=d.value,a.push(this._drawEffect(h,s,i,o,null)),s++}catch(e){p.e(e)}finally{p.f()}return e.next=43,Promise.all(a);case 43:return e.abrupt("return",this._drawOverlay(n));case 44:case"end":return e.stop()}}),e,this,[[17,33,36,39]])}))),Token.prototype._drawEffect=function(){var e=Ga(Na().mark((function e(t,r,n,a,o,i){var s,c,u,l,f;return Na().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,loadTexture(t);case 2:s=e.sent,(c=this.effects.addChild(new PIXI.Sprite(s))).width=c.height=a,c.x=Math.floor(r/5)*a,c.y=r%5*a,o&&(c.tint=o);try{n.drawRoundedRect(c.x+1,c.y+1,a-2,a-2,2)}catch(e){}if(this.effects.addChild(c),!i){e.next=20;break}return u=game.dsa5.config.effectTextStyle,e.next=14,game.settings.get("dsa5","statusEffectCounterColor");case 14:l=e.sent,u._fill=/^#[0-9A-F]+$/.test(l)?l:"#000000",(f=this.effects.addChild(new PreciseText(i,u))).x=c.x,f.y=c.y,this.effects.addChild(f);case 20:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a,o,i){return e.apply(this,arguments)}}(),TokenHUD.prototype._onToggleEffect=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.overlay,e.preventDefault();var r=e.currentTarget,n=r.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find((function(e){return e.id===r.dataset.statusId})):r.getAttribute("src");if(n.flags.dsa5.editable)return 0==e.button?this.object.incrementCondition(n):2==e.button?this.object.decrementCondition(n):void 0},Token.prototype.incrementCondition=function(){var e=Ga(Na().mark((function e(t){var r,n,a,o=arguments;return Na().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:{},n=r.active,r.overlay,(a=this.actor.effects.find((function(e){return e.getFlag("core","statusId")===t.id})))&&!Number.isNumeric(getProperty(a,"flags.dsa5.value"))){e.next=7;break}return e.next=5,this.actor.addCondition(t.id,1,!1,!1);case 5:e.next=10;break;case 7:if(!a){e.next=10;break}return e.next=10,this.actor.removeCondition(t.id,1,!1);case 10:return this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),e.abrupt("return",n);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),Token.prototype.decrementCondition=function(){var e=Ga(Na().mark((function e(t){var r,n,a=arguments;return Na().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]?a[1]:{},n=r.active,r.overlay,this.actor.removeCondition(t.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),e.abrupt("return",n);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}();var e=Token.prototype._onClickLeft2;Token.prototype._onClickLeft2=function(t){var r;if(!(game.user.isGM||!game.settings.get("dsa5","enableDPS")||!((r=this.actor)&&["merchant","loot"].includes(getProperty(r.system,"merchant.merchantType")))||Ia.Z.inDistance(this)))return ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"));e.call(this,t)},Hooks.on("applyActiveEffect",(function(e,t){return function(e,t){var r=getProperty(e,t.key)||null;null==r&&/^system\.(vulnerabilities|resistances)/.test(t.key)&&(r=[],setProperty(e,t.key,r));var n=null;if("Array"===getType(r)){var a,o=[],i=t.effect.label,s=Ra("".concat(t.value).split(/[;,]+/));try{for(s.s();!(a=s.n()).done;){var c=a.value.split(" "),u=c.pop(),l=c.join(" ");o.push({source:i,value:u,target:l})}}catch(e){s.e(e)}finally{s.f()}n=r.concat(o)}return null!==n&&setProperty(e,t.key,n),n}(e,t)}))}(),Hooks.on("renderSidebarTab",(function(e,t){if("settings"==e.options.id){var r=$('<button id="reportADSABug"><i class="fas fa-bug"></i> '.concat(game.i18n.localize("DSA5Error"),"</button>"));r.click((function(){window.open("https://github.com/Plushtoast/dsa5-foundryVTT/issues","_blank")})),t.find("#settings-documentation").append(r),(r=$('<button><i class="fas fa-info-circle"></i> '.concat(game.i18n.localize("DSA5Wiki"),"</button>"))).click((function(){window.open("https://github.com/Plushtoast/dsa5-foundryVTT/wiki","_blank")})),t.find("#settings-documentation").append(r),(r=$('<button class="fshopButton"><div></div> F-Shop</button>')).click((function(){window.open(game.i18n.localize("fshopLink"),"_blank")})),t.find("#settings-documentation").append(r);var n=game.system.title.split("/")["de"==game.i18n.lang?0:1];t.find("#game-details .system").html("".concat(n,"<span>").concat(game.system.version,"</span>"))}})),Hooks.on("renderCompendiumDirectory",(function(e,t,r){var n=$('<button id="openLibrary"><i class="fas fa-university"></i>'.concat(game.i18n.localize("ItemLibrary"),"</button>"));t.find(".header-actions").append(n),n.click((function(){game.dsa5.itemLibrary.render(!0)})),t.find('li[data-pack="dsa5.money"]').hide();var a,o=game.dsa5.config.localizedCompendiums["".concat("de"==game.i18n.lang?"en":"de")],i=Za(game.packs.filter((function(e){return o.includes("".concat(e.metadata.packageName,".").concat(e.metadata.name))})));try{for(i.s();!(a=i.n()).done;){var s=a.value,c="".concat(s.metadata.packageName,".").concat(s.metadata.name);game.packs.delete(c),t.find('li[data-pack="'.concat(c,'"]')).hide()}}catch(e){i.e(e)}finally{i.f()}})),Hooks.on("renderActorDirectory",(function(e,t,r){if(!game.user.isGM){var n,a=Za(e.documents.filter((function(e){return e.isMerchant()&&getProperty(e,"merchant.hidePlayer")})));try{for(a.s();!(n=a.n()).done;){var o=n.value;t.find('[data-document-id="'.concat(o.id,'"]')).remove()}}catch(e){a.e(e)}finally{a.f()}}})),Hooks.on("renderJournalSheet",(function(e,t,r){t.find(".close").attr("data-tooltip",game.i18n.localize("SHEET.Close")),t.find(".entry-image").attr("data-tooltip",game.i18n.localize("SHEET.imageView")),t.find(".entry-text").attr("data-tooltip",game.i18n.localize("SHEET.textView")),t.find(".share-image").attr("data-tooltip",game.i18n.localize("SHEET.showToPlayers")),t.find(".import").attr("data-tooltip",game.i18n.localize("SHEET.import")),t.find(".panMapNote").attr("data-tooltip",game.i18n.localize("SHEET.panMapNote")),I.Z.bindRollCommands(t),i.Z.bindButtons(t),t.on("click",".chat-condition",(function(e){o.Z.postStatus($(e.currentTarget).attr("data-id"))})),t.on("mousedown","img",(function(t){2==t.button&&game.dsa5.apps.DSA5_Utility.showArtwork({name:e.name,uuid:"",img:$(t.currentTarget).attr("src")})})),j(t)})),Hooks.on("getJournalSheetHeaderButtons",(function(e,t){var r,n;e.document.sceneNote&&t.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:(r=oo().mark((function t(){return oo().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.document.panToNote());case 1:case"end":return t.stop()}}),t)})),n=function(){var e=this,t=arguments;return new Promise((function(n,a){var o=r.apply(e,t);function i(e){io(o,n,a,i,s,"next",e)}function s(e){io(o,n,a,i,s,"throw",e)}i(void 0)}))},function(){return n.apply(this,arguments)})})})),TextEditor._enrichHTML=TextEditor.enrichHTML,TextEditor.enrichHTML=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.secrets,a=void 0!==n&&n,o=r.documents,i=void 0===o||o,s=r.links,c=void 0===s||s,u=r.rolls,l=void 0===u||u,f=r.rollData,p=void 0===f?null:f,d=(r.async,TextEditor._enrichHTML(t,{secrets:a,documents:i,links:c,rolls:l,rollData:p,async:!1}));return e.Z.customEntityLinks(e.Z.replaceConditions(d))},Hooks.on("renderTokenHUD",(function(e,t,r){var n=e.object.actor;n&&(function(e,t,r){if(t.system.isPriest&&t.system.isMage){var n=t.system.status.karmaenergy.value,a='<div class="attribute bar3"><input type="text" name="system.status.karmaenergy.value" value="'.concat(n,'"></div>');e.find(".col.middle").prepend(a),e.find(".bar3 input").change(function(){var e,n=(e=co().mark((function e(n){var a,o,i,s,c;return co().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.currentTarget,o=a.value.trim(),i=o.startsWith("+")||o.startsWith("-"),o.startsWith("=")&&(o=o.slice(1)),s=Number(o),c=a.name.split(".").reduce((function(e,t){return e[t]}),t),e.next=8,t.update(uo({},a.name,i?c+s:s));case 8:r.clear();case 9:case"end":return e.stop()}}),e)})),function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){lo(o,n,a,i,s,"next",e)}function s(e){lo(o,n,a,i,s,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}())}}(t,n,e),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.lightHud(t,n,r)),t.find('.control-icon[data-action="target"]').mousedown((function(e){2==e.button&&(game.user.updateTokenTargets([]),$(e.currentTarget).click(),e.preventDefault())})),t.find(".attribute input").off("change")})),Ha.Z(),Hooks.on("preCreateScene",(function(e,t,r,n){t.grid.units||e.updateSource({grid:{units:game.i18n.localize("gridUnits")}})})),Hooks.on("preCreateActiveEffect",(function(e,t,r,n){if("Actor"==e.parent.documentName){var a={duration:{}};e.duration.startTime||(a.duration.startTime=game.time.worldTime),game.combat?(a.duration.combat=game.combat.id,a.duration.startRound=game.combat.round,a.duration.startTurn=game.combat.turn,!e.duration.rounds&&e.duration.seconds&&(a.duration.rounds=e.duration.seconds/5),e.updateSource(a)):e.updateSource(a)}})),Roll.prototype.editRollAtIndex=function(e){var t,r=[],n=Ro(e);try{for(n.s();!(t=n.n()).done;){var a,o=t.value,i=o.index,s=o.val,c=0,u=Ro(this.terms);try{for(u.s();!(a=u.n()).done;){var l=a.value;if(l instanceof Die||"Die"==l.class){if(l.results[i-c]){var f=l.results[i-c].result;l.results[i-c].result=s,r.push(f)}c+=l.results.length}}}catch(e){u.e(e)}finally{u.f()}r.push(0)}}catch(e){n.e(e)}finally{n.f()}return this._total=this._evaluateTotal(),r}})()})();