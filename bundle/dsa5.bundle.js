(()=>{"use strict";var __webpack_modules__={369:(e,t,a)=>{a.d(t,{Z:()=>Actordsa5});var s=a(491),i=a(577),n=a(562),r=a(600),o=a(538),l=a(272),c=a(173),d=a(973),m=a(839),u=a(101),g=a(122),p=a(707),h=a(702),f=a(61),y=a(803),b=a(472),v=a(169);class Actordsa5 extends Actor{static _baseCarryItems=new Set(["armor","meleeweapon","ammunition","rangeweapon","plant","poison","money","consumable","equipment"]);static _mageSpecs=new Set(["magical","staff","pact"]);static _clericSpecs=new Set(["ceremonial","clerical"]);static async create(e,t){if(e instanceof Array||e.items)return await super.create(e,t);e.img&&"icons/svg/mystery-man.svg"!=e.img||(e.img="icons/svg/mystery-man-black.svg");const a=await s.Z.allSkills()||[],i=await s.Z.allCombatSkills()||[],n=await s.Z.allMoneyItems()||[];return e.items=[...a,...i,...n],"character"!=e.type&&(e.system={status:{fatePoints:{current:0,value:0}}}),"creature"!=e.type&&[void 0,0].includes(getProperty(e,"system.status.wounds.value"))&&mergeObject(e,{system:{status:{wounds:{value:16}}}}),await super.create(e,t)}_getArmorCompensation(e,t,a){if(c.Z.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance"))>t.reduce(((e,t)=>e+Number(t.system.encumbrance.value)),0)){const e=[game.i18n.localize("CHARAbbrev.GS"),game.i18n.localize("CHARAbbrev.INI")];for(let t of e)a[t]&&(a[t]=a[t].filter((e=>"armor"!=e.type)))}}_getItemModifiers(){let e=[],t={};for(let a of this.items.filter((e=>["meleeweapon","rangeweapon","armor","equipment"].includes(e.type)&&getProperty(e,"system.worn.value")||["advantage","specialability","disadvantage"].includes(e.type))))this._buildGearAndAbilityModifiers(t,a),"armor"==a.type&&e.push(a);this._getArmorCompensation(this,e,t),this._applyModiferTransformations(t)}prepareDerivedData(){const e=this.system;try{this._getItemModifiers();for(let t of Object.values(e.characteristics))t.value=t.initial+t.advances+(t.modifier||0)+t.gearmodifier;e.totalWeight=0;const t=[],a=game.i18n.localize("LocalizedIDs.familiar"),i=game.i18n.localize("LocalizedIDs.companion");let n=new Map;const r=this.items.filter((e=>"equipment"==e.type&&"bags"==e.system.equipmentType.value));for(let e of r)n.set(e.id,[]);for(const s of this.items)if(Actordsa5._baseCarryItems.has(s.type)){let a=getProperty(s,"system.parent_id");if(a&&a!=s._id&&n.has(a)){n.get(a).push(s);continue}"armor"==s.type?(s.system.preparedWeight=parseFloat((s.system.weight.value*s.system.quantity.value).toFixed(3)),e.totalWeight+=parseFloat((s.system.weight.value*(s.system.worn.value?Math.max(0,s.system.quantity.value-1):s.system.quantity.value)).toFixed(3)),s.system.worn.value&&t.push(s)):(s.system.preparedWeight=parseFloat((s.system.weight.value*s.system.quantity.value).toFixed(3)),e.totalWeight+=Number(s.system.preparedWeight))}else switch(s.type){case"trait":s.name==a&&(e.isFamiliar=!0),s.name==i&&(e.isPet=!0);break;case"spell":case"ritual":case"magictrick":e.isMage=!0;break;case"liturgy":case"ceremony":case"blessing":e.isPriest=!0;break;case"specialability":Actordsa5._mageSpecs.has(s.system.category.value)?e.isMage=!0:Actordsa5._clericSpecs.has(s.system.category.value)&&(e.isPriest=!0)}e.isMage||=e.isFamiliar;for(let t of r){let a=getProperty(t,"system.parent_id");a&&n.has(a)||(e.totalWeight+=this._calcBagweight(t,n,!0))}e.canAdvance=this.isOwner&&("character"==this.type||e.isFamiliar||e.isPet),this.canAdvance=e.canAdvance,e.carrycapacity=2*e.characteristics.kk.value+e.carryModifier,e.canAdvance&&(e.details.experience.current=e.details.experience.total-e.details.experience.spent,e.details.experience.description=s.Z.experienceDescription(e.details.experience.total)),"character"!=this.type&&"npc"!=this.type||(e.status.wounds.current=e.status.wounds.initial+2*e.characteristics.ko.value,e.status.soulpower.value=(e.status.soulpower.initial||0)+Math.round((e.characteristics.mu.value+e.characteristics.kl.value+e.characteristics.in.value)/6),e.status.toughness.value=(e.status.toughness.initial||0)+Math.round((e.characteristics.ko.value+e.characteristics.ko.value+e.characteristics.kk.value)/6),e.status.wounds.min=-1*e.characteristics.ko.value),e.status.fatePoints.max=Number(e.status.fatePoints.current)+Number(e.status.fatePoints.modifier)+e.status.fatePoints.gearmodifier,"creature"==this.type&&(e.status.wounds.current=e.status.wounds.initial,e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial),e.status.wounds.max=Math.round((e.status.wounds.current+e.status.wounds.modifier+e.status.wounds.advances)*e.status.wounds.multiplier+e.status.wounds.gearmodifier),e.status.regeneration.LePmax=e.status.regeneration.LePTemp+e.status.regeneration.LePMod+e.status.regeneration.LePgearmodifier,e.status.regeneration.KaPmax=e.status.regeneration.KaPTemp+e.status.regeneration.KaPMod+e.status.regeneration.KaPgearmodifier,e.status.regeneration.AsPmax=e.status.regeneration.AsPTemp+e.status.regeneration.AsPMod+e.status.regeneration.AsPgearmodifier;let o=e.guidevalue;(e.isFamiliar||o&&"creature"!=this.type)&&(e.status.astralenergy.current=e.status.astralenergy.initial,e.status.karmaenergy.current=e.status.karmaenergy.initial,e.characteristics[o.magical]&&(e.status.astralenergy.current+=Math.round(e.characteristics[o.magical].value*e.energyfactor.magical)),e.characteristics[o.clerical]&&(e.status.karmaenergy.current+=Math.round(e.characteristics[o.clerical].value*e.energyfactor.clerical))),e.status.astralenergy.max=e.status.astralenergy.current+e.status.astralenergy.modifier+e.status.astralenergy.advances+e.status.astralenergy.gearmodifier,e.status.karmaenergy.max=e.status.karmaenergy.current+e.status.karmaenergy.modifier+e.status.karmaenergy.advances+e.status.karmaenergy.gearmodifier,e.status.soulpower.max=e.status.soulpower.value+e.status.soulpower.modifier+e.status.soulpower.gearmodifier,e.status.toughness.max=e.status.toughness.value+e.status.toughness.modifier+e.status.toughness.gearmodifier,e.status.dodge.value=Math.round(e.characteristics.ge.value/2)+e.status.dodge.gearmodifier;let c=this.calcEncumbrance(e);const d=v.Z.isRiding(this)?v.Z.getHorse(this):void 0;this.calcInitiative(e,c,d),e.status.dodge.max=Number(e.status.dodge.value)+Number(e.status.dodge.modifier)+Number(game.settings.get("dsa5","higherDefense"))/2;let m=this.getArmorEncumbrance(this,t);if(s.Z.isActiveGM()){const t=this.woundPain(e),a=this.effects.find((e=>e.statuses.has("inpain")))?.flags.dsa5.auto||0,s=!this.changingPain&&a!=t;this.changingPain=a!=t,s&&!u.Z.hasTrait(this,game.i18n.localize("LocalizedIDs.painImmunity"))&&this.addCondition("inpain",t,!0).then((()=>this.changingPain=void 0)),"creature"==this.type&&!this.canAdvance||this.isMerchant()||(m+=Math.max(0,Math.ceil((e.totalWeight-e.carrycapacity-4)/4)));const i=this.effects.find((e=>e.statuses.has("encumbered")))?.flags.dsa5.auto||0,n=!this.changingEncumbrance&&i!=m;this.changingEncumbrance=i!=m,n&&this.addCondition("encumbered",m,!0).then(this.changingEncumbrance=void 0),l.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.blind"))&&this.addCondition("blind"),l.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.mute"))&&this.addCondition("mute"),l.Z.hasVantage(this,game.i18n.localize("LocalizedIDs.deaf"))&&this.addCondition("deaf"),this.isMerchant()&&this.prepareMerchant()}this.effectivePain(e);const g=this.hasCondition("fixated");this.calcSpeed(e,g,d),g&&(e.status.dodge.max=Math.max(0,e.status.dodge.max-4))}catch(e){console.error(`Something went wrong with preparing actor data ${this.name}: `+e+e.stack),ui.notifications.error(game.i18n.format("DSAError.PreparationError",{name:this.name})+e+e.stack)}}effectivePain(e){let t=e.condition.inpain||0;t<4&&(t-=l.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedFighter"))+l.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.ruggedAnimal"))+(c.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.traditionKor"))?1:0)),t>0&&(t+=l.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.sensitiveToPain"))+l.Z.vantageStep(this,game.i18n.localize("LocalizedIDs.fragileAnimal"))),t=Math.clamped(t,0,4),e.condition.inpain=t}woundPain(e){let t=0;if(e.status.wounds.max>0){"creature"!=this.type||e.status.wounds.max>=20?(t=Math.floor(4*(1-e.status.wounds.value/e.status.wounds.max)),e.status.wounds.value<=5&&(t=4)):t=Math.floor(5-5*e.status.wounds.value/e.status.wounds.max)}return Math.clamped(t,0,4)}calcSpeed(e,t,a){if(a){if(e.status.speed.max=a.system.status.speed.max,!e.status.speed.max){const e=a.system;a.calcSpeed(e,a.hasCondition("fixated"))}e.status.speed.max=a.system.status.speed.max}else{e.status.speed.max=e.status.speed.initial+(e.status.speed.modifier||0)+(e.status.speed.gearmodifier||0),e.status.speed.max=Math.round(Math.max(0,e.status.speed.max-Math.min(4,this.calcEncumbrance(e)))*e.status.speed.multiplier),this.hasCondition("bloodrush")||(e.status.speed.max=Math.max(0,e.status.speed.max-(e.condition?.inpain||0)));const a=this.hasCondition("paralysed");a&&(e.status.speed.max=Math.round(e.status.speed.max*(1-.25*a.flags.dsa5.value))),t||this.hasCondition("rooted")||this.hasCondition("incapacitated")?e.status.speed.max=0:this.hasCondition("prone")&&(e.status.speed.max=Math.min(1,e.status.speed.max)),v.Z.updateRiderSpeed(this,e.status.speed.max)}}calcEncumbrance(e){return Math.clamped(e.condition?.encumbered||0,0,4)}calcInitiative(e,t,a){if("character"==this.type||"npc"==this.type?e.status.initiative.value=Math.round((e.characteristics.mu.value+e.characteristics.ge.value)/2)+(e.status.initiative.modifier||0):e.status.initiative.value=e.status.initiative.current+(e.status.initiative.modifier||0),a){if(e.status.initiative.value=a.system.status.initiative.value,!e.status.initiative.value){const t=a.system;a.calcInitiative(t,a.calcEncumbrance(t)),e.status.initiative.value=t.status.initiative.value}}else{e.status.initiative.value+=(e.status.initiative.gearmodifier||0)-Math.min(4,t);const a=Number((.01*e.status.initiative.value).toFixed(2));e.status.initiative.value*=e.status.initiative.multiplier||1,e.status.initiative.value=Math.round(e.status.initiative.value)+a}}get creatureType(){return b.Z.creatureTypeName(this)}async prepareMerchant(){if("loot"==getProperty(this,"system.merchant.merchantType"))if(getProperty(this,"system.merchant.locked")&&!this.hasCondition("locked"))await this.addCondition(Actordsa5.lockedCondition());else if(!getProperty(this,"system.merchant.locked")){let e=this.effects.find((e=>e.statuses.has("locked")));e&&await this.deleteEmbeddedDocuments("ActiveEffect",[e.id])}}static lockedCondition(){return{id:"locked",name:game.i18n.localize("MERCHANT.locked"),icon:"icons/svg/padlock.svg",flags:{dsa5:{value:null,editable:!0,noEffect:!0,hidePlayers:!0,description:game.i18n.localize("MERCHANT.locked"),custom:!0}}}}applyActiveEffects(){const e={};this.statuses??=new Set;const t=new Map;for(const e of Object.values(CONFIG.specialStatusEffects))t.set(e,this.statuses.has(e));this.statuses.clear();const a=this.effects.reduce(((e,t)=>{if(!t.active)return e;let a=1;if(t.origin){const s=t.origin.match(/[^.]+$/)[0],i=this.items.get(s);if(i){let s=!0;switch(i.type){case"meleeweapon":case"rangeweapon":s=i.system.worn.value&&t.getFlag("dsa5","applyToOwner");break;case"armor":s=i.system.worn.value;break;case"equipment":s=!i.system.worn.wearable||i.system.worn.wearable&&i.system.worn.value;break;case"trait":s=!["meleeAttack","rangeAttack"].includes(i.system.traitType.value)||t.getFlag("dsa5","applyToOwner");break;case"ammunition":case"plant":case"consumable":case"combatskill":case"magicsign":case"poison":case"spell":case"liturgy":case"ceremony":case"ritual":case"spellextension":s=!1;break;case"specialability":s="Combat"!=i.system.category.value||[2,3].includes(Number(i.system.category.sub)),a=Number(i.system.step.value)||1;break;case"advantage":case"disadvantage":a=Number(i.system.step.value)||1}if(t.notApplicable=!s,!s)return e}}else{const e=t.getFlag("dsa5","value");e&&(a=Number(e))}for(let s=0;s<a;s++)e.push(...t.changes.map((e=>((e=foundry.utils.duplicate(e)).effect=t,e.priority=e.priority?e.priority:10*e.mode,e))));for(const e of t.statuses)this.statuses.add(e);return e}),[]);a.sort(((e,t)=>e.priority-t.priority));for(let t of a){if(!t.key)continue;const a=t.effect.apply(this,t);Object.assign(e,a)}let s;this.overrides=foundry.utils.expandObject(e);for(const[e,a]of t){const t=this.statuses.has(e);if(t!==a){s??=this.getActiveTokens();for(const a of s)a._onApplyStatusEffect(e,t)}}}_setOnUseEffect(e){getProperty(e,"flags.dsa5.onUseEffect")&&(e.OnUseEffect=!0)}prepareBaseData(){const e=this.system;mergeObject(e,{itemModifiers:{},condition:{},creatureType:this.creatureType,skillModifiers:{FP:[],step:[],QL:[],TPM:[],FW:[],botch:20,crit:1,global:[],conditional:{AsPCost:[],KaPCost:[]},feature:{FP:[],step:[],QL:[],TPM:[],FW:[],KaPCost:[],AsPCost:[]},...["liturgy","ceremony","ritual","spell","skill"].reduce(((e,t)=>(e[t]={FP:[],step:[],QL:[],TPM:[],FW:[]},e)),{})},status:{initiative:{multiplier:1},wounds:{multiplier:1},speed:{multiplier:1},regeneration:{LePgearmodifier:0,KaPgearmodifier:0,AsPgearmodifier:0}},repeatingEffects:{startOfRound:{wounds:[],karmaenergy:[],astralenergy:[]}},temperature:{heatProtection:0,coldProtection:0},totalArmor:0,spellArmor:0,liturgyArmor:0,carryModifier:0,aspModifier:0,kapModifier:0,immunities:[],creatureBonus:[],miracle:{attack:0,parry:0},spellStats:{damage:"0"},liturgyStats:{damage:"0"},meleeStats:{parry:0,attack:0,damage:"0",defenseMalus:0,botch:20,crit:1},rangeStats:{attack:0,damage:"0",defenseMalus:0,botch:20,crit:1}});for(const t of i.Z.gearModifyableCalculatedAttributes)e.status[t]&&(e.status[t].gearmodifier=0);for(let t of Object.values(e.characteristics))t.gearmodifier=0}getSkillModifier(e,t){let a=[];const s=["FP","step","QL","TPM","FW"];for(const i of s){const s="step"==i?"":i;a.push(...this.system.skillModifiers[i].filter((t=>t.target==e)).map((e=>({name:e.source,value:e.value,type:s})))),this.system.skillModifiers[t]&&a.push(...this.system.skillModifiers[t][i].map((e=>({name:e.source,value:e.value,type:s}))))}return a}prepareSheet(e){let t={system:{characteristics:{}}};if(mergeObject(t,this.prepareItems(e)),t.canAdvance){const e=["wounds","astralenergy","karmaenergy"];for(const a of e)mergeObject(t.system,{status:{[a]:{cost:game.i18n.format("advancementCost",{cost:s.Z._calculateAdvCost(this.system.status[a].advances,"D")}),refund:game.i18n.format("refundCost",{cost:s.Z._calculateAdvCost(this.system.status[a].advances,"D",0)})}}});for(let[e,a]of Object.entries(this.system.characteristics))t.system.characteristics[e]={cost:game.i18n.format("advancementCost",{cost:s.Z._calculateAdvCost(a.initial+a.advances,"E")}),refund:game.i18n.format("refundCost",{cost:s.Z._calculateAdvCost(a.initial+a.advances,"E",0)})}}return t}static canAdvance(e){return e.canAdvance}static armorValue(e,t={}){let a=e.items.filter((e=>"armor"==e.type&&1==e.system.worn.value));t.origin&&(a=a.map((a=>{let s=mergeObject(duplicate(t),{armor:a});return f.Z.applyRollTransformation(e,s,4).options.armor})));const s=a.reduce(((e,t)=>e+h.Z.armorWearModifier(t,t.system.protection.value)),0);return{wornArmor:a,armor:s+e.items.filter((e=>"trait"==e.type&&"armor"==e.system.traitType.value)).reduce(((e,t)=>e+Number(t.system.at.value)),0)+(e.system.totalArmor||0)}}static _calculateCombatSkillValues(e,t){if("melee"==e.system.weapontype.value){const a=e.system.guidevalue.value.split("/").map((e=>Number(t.characteristics[e].initial)+Number(t.characteristics[e].modifier)+Number(t.characteristics[e].advances)+Number(t.characteristics[e].gearmodifier))),s=Math.max(...a);e.system.parry.value=Math.ceil(e.system.talentValue.value/2)+Math.max(0,Math.floor((s-8)/3))+Number(game.settings.get("dsa5","higherDefense"));const i=t.characteristics.mu.initial+t.characteristics.mu.modifier+t.characteristics.mu.advances+t.characteristics.mu.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((i-8)/3))}else{e.system.parry.value=0;let a=t.characteristics.ff.initial+t.characteristics.ff.modifier+t.characteristics.ff.advances+t.characteristics.ff.gearmodifier;e.system.attack.value=e.system.talentValue.value+Math.max(0,Math.floor((a-8)/3))}return e.cost=game.i18n.format("advancementCost",{cost:s.Z._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e}_perpareItemAdvancementCost(e){return e.cost=game.i18n.format("advancementCost",{cost:s.Z._calculateAdvCost(e.system.talentValue.value,e.system.StF.value)}),e.refund=game.i18n.format("refundCost",{cost:s.Z._calculateAdvCost(e.system.talentValue.value,e.system.StF.value,0)}),e}async modifyTokenAttribute(e,t,a=!1,s=!0){const i=foundry.utils.getProperty(this.system,e);let n;s?(a&&(t=Math.clamped(i.min||0,Number(i.value)+t,i.max)),n={[`system.${e}.value`]:t}):(a&&(t=Number(i)+t),n={[`system.${e}`]:t});return!1!==Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:a,isBar:s},n)?this.update(n):this}schipshtml(){const e=[];for(let t=1;t<=Number(this.system.status.fatePoints.max);t++)e.push({value:t,cssClass:t<=Number(this.system.status.fatePoints.value)?"fullSchip":"emptySchip"});return e}prepareItems(e){let t=this.toObject(!1),a=[],n=[],r=[],o=[],l=[],c=[],d=[],m=[];const u=Object.fromEntries(Object.keys(i.Z.specialAbilityCategories).map((e=>[e,[]]))),p=Object.fromEntries(Object.keys(i.Z.traitCategories).map((e=>[e,[]])));let f=[],y=[],b=[];const k=[],D={hasSpells:this.system.isMage,hasPrayers:this.system.isPriest,liturgy:[],spell:[],ritual:[],ceremony:[],blessing:[],magictrick:[],magicalsign:[]},w={spell:{},ritual:{},ceremony:{},liturgy:{}},_=this.hasPlayerOwner?g.Z.getGroupSchips():[],S=this.schipshtml(),T={meleeweapons:{items:[],show:!1,dataType:"meleeweapon"},rangeweapons:{items:[],show:!1,dataType:"rangeweapon"},armor:{items:[],show:!1,dataType:"armor"},ammunition:{items:[],show:!1,dataType:"ammunition"},plant:{items:[],show:!1,dataType:"plant"},poison:{items:[],show:!1,dataType:"poison"}};for(let e in i.Z.equipmentTypes)T[e]={items:[],show:!1,dataType:e};T.misc.show=!0;const A={coins:[],total:0,show:!0};t.items=t.items.sort(((e,t)=>e.name.localeCompare(t.name)));let C=t.system.totalArmor||0,M={body:[],social:[],knowledge:[],trade:[],nature:[]},I=new Map;for(let e of t.items.filter((e=>"equipment"==e.type&&"bags"==e.system.equipmentType.value)))I.set(e._id,[]);let E=new Map,O=[],P=!1;const z=v.Z.getHorse(this,!0);for(let s of t.items)try{let t=getProperty(s,"system.parent_id");if("ammunition"==s.type&&O.push(Actordsa5._prepareitemStructure(s)),t&&t!=s._id&&I.has(t)){I.get(t).push(s);continue}switch(e.details&&e.details.includes(s._id)&&(s.detailed="shown"),s.system.isArtifact&&(s.volume=i.Z.traditionArtifacts[s.system.artifact]||0,s.volumeFinal=0,k.push(s)),s.type){case"skill":M[s.system.group.value].push(this._perpareItemAdvancementCost(s));break;case"information":m.push(s);break;case"aggregatedTest":o.push(s);break;case"spellextension":w[s.system.category][s.system.source]?w[s.system.category][s.system.source].push(s.name):w[s.system.category][s.system.source]=[s.name];break;case"ritual":case"spell":case"liturgy":case"ceremony":D[s.type].push(Actordsa5.buildSpellChargeProgress(this._perpareItemAdvancementCost(s)));break;case"magicalsign":case"magictrick":case"blessing":D[s.type].push(s);break;case"trait":switch(s.system.traitType.value){case"rangeAttack":s=Actordsa5._prepareRangeTrait(s);break;case"meleeAttack":s=Actordsa5._prepareMeleetrait(s);break;case"armor":C+=Number(s.system.at.value)}p[s.system.traitType.value].push(s),P=!0;break;case"combatskill":a.push(Actordsa5._calculateCombatSkillValues(s,this.system));break;case"ammunition":T.ammunition.items.push(Actordsa5.prepareMag(s)),T.ammunition.show=!0;break;case"meleeweapon":s.toggleValue=s.system.worn.value||!1,s.toggle=!0,this._setOnUseEffect(s),T.meleeweapons.items.push(Actordsa5._prepareitemStructure(s)),T.meleeweapons.show=!0,s.toggleValue&&d.push(s);break;case"rangeweapon":s.toggleValue=s.system.worn.value||!1,s.toggle=!0,this._setOnUseEffect(s),T.rangeweapons.items.push(Actordsa5._prepareitemStructure(s)),T.rangeweapons.show=!0;break;case"armor":s.toggleValue=s.system.worn.value||!1,T.armor.items.push(Actordsa5._prepareitemStructure(s)),T.armor.show=!0,s.toggle=!0,this._setOnUseEffect(s),s.system.worn.value&&(s.system.protection.value=h.Z.armorWearModifier(s,s.system.protection.value),C+=Number(s.system.protection.value),f.push(s));break;case"poison":case"plant":T[s.type].items.push(s),T[s.type].show=!0;break;case"consumable":T[s.system.equipmentType.value].items.push(Actordsa5._prepareConsumable(s)),T[s.system.equipmentType.value].show=!0;break;case"equipment":s.toggle=getProperty(s,"system.worn.wearable")||!1,s.toggle&&(s.toggleValue=s.system.worn.value||!1),this._setOnUseEffect(s),T[s.system.equipmentType.value].items.push(Actordsa5._prepareitemStructure(s)),T[s.system.equipmentType.value].show=!0;break;case"money":A.coins.push(s),A.total+=s.system.quantity.value*s.system.price.value;break;case"advantage":this._setOnUseEffect(s),n.push(s);break;case"disadvantage":this._setOnUseEffect(s),r.push(s);break;case"specialability":this._setOnUseEffect(s),u[s.system.category.value].push(s);break;case"disease":l.push(s);break;case"patron":u.magical.push(s);break;case"demonmark":c.push(s);break;case"application":E.has(s.system.skill)?E.get(s.system.skill).push(s):E.set(s.system.skill,[s])}}catch(e){this._itemPreparationError(s,e)}for(let e of T.bags.items)this._setBagContent(e,I);for(let[e,t]of Object.entries(w))for(let[a,i]of Object.entries(t)){const t=D[e].find((e=>e.name==a));t?t.extensions=i.join(", "):ui.notifications.warn(game.i18n.format("DSAError.noSpellForExtension",{name:a,category:s.Z.categoryLocalization(e),extension:i.join(",")}))}for(let e of T.rangeweapons.items)try{e.system.worn.value&&y.push(Actordsa5._prepareRangeWeapon(e,O,a,this))}catch(t){this._itemPreparationError(e,t)}for(let e of d)try{b.push(Actordsa5._prepareMeleeWeapon(e,a,t,d.filter((t=>t._id!=e._id&&!g.Z.isYieldedTwohanded(t)))))}catch(t){this._itemPreparationError(e,t)}for(let e of Object.values(M))for(let t of e)t.applications=E.get(t.name)||[];A.coins=A.coins.sort(((e,t)=>e.system.price.value>t.system.price.value?-1:1)),u.magical.push(...u.pact),u.clerical.push(...u.ceremonial);for(let e of u.staff){const t=k.find((t=>t.system.artifact==e.system.artifact));if(t){null==t.abilities&&(t.abilities=[]),t.abilities.push(e);const a=Number(e.system.volume)||0;t[a>0?"volumeFinal":"volume"]+=Math.abs(a)*Number(e.system.step.value)}else u.magical.push(e)}let $=duplicate(i.Z.characteristics);return $["-"]="-",{totalWeight:parseFloat(this.system.totalWeight.toFixed(3)),traditionArtifacts:k,armorSum:C,spellArmor:t.system.spellArmor||0,liturgyArmor:t.system.liturgyArmor||0,money:A,encumbrance:this.system.condition?.encumbered||0,carrycapacity:this.system.carrycapacity,wornRangedWeapons:y,wornMeleeWeapons:b,horseActor:z,advantages:n,disadvantages:r,specAbs:u,information:m,aggregatedtests:o,wornArmor:f,inventory:T,hasTrait:P,demonmarks:c,diseases:l,canBuild:game.dsa5.sheets.DSACharBuilder&&!t.system.details.species?.value,itemModifiers:this.system.itemModifiers,languagePoints:{used:t.system.freeLanguagePoints?.used||0,available:t.system.freeLanguagePoints?.value||0},schips:S,groupschips:_,guidevalues:$,magic:D,traits:p,combatskills:a,canAdvance:this.canAdvance,sheetLocked:t.system.sheetLocked.value,bodyAttrs:["ff","ge","ko","kk"],mentalAttrs:["mu","kl","in","ch"],allSkillsLeft:{body:M.body,social:M.social,nature:M.nature},allSkillsRight:{knowledge:M.knowledge,trade:M.trade}}}getArmorEncumbrance(e,t){const a=t.reduce(((e,t)=>(t.system.calculatedEncumbrance=Number(t.system.encumbrance.value)+h.Z.armorEncumbranceModifier(t),t.system.damageToolTip=h.Z.damageTooltip(t),e+t.system.calculatedEncumbrance)),0),s=v.Z.isRiding(this)?-1:0;return Math.max(0,a-c.Z.abilityStep(e,game.i18n.localize("LocalizedIDs.inuredToEncumbrance"))+s)}_calcBagweight(e,t,a=!0){let s=0;if(t.has(e._id)){let i=0;!e.system.worn.value&&a&&(s-=e.system.preparedWeight);for(let a of t.get(e._id))a.system.preparedWeight=Number(parseFloat((a.system.weight.value*a.system.quantity.value).toFixed(3))),t.has(a._id)?i+=this._calcBagweight(a,t,!1):i+=a.system.preparedWeight;a?e.system.worn.value&&(s+=i):s+=i+e.system.preparedWeight,e.system.bagweight=`${i.toFixed(3)}/${e.system.capacity}`}return s}_setBagContent(e,t){if(t.has(e._id)){e.children=[];for(let a of t.get(e._id))e.children.push(Actordsa5._prepareitemStructure(Actordsa5._prepareConsumable(a))),t.has(a._id)&&this._setBagContent(a,t)}}isMerchant(){return["merchant","loot"].includes(getProperty(this,"system.merchant.merchantType"))}_itemPreparationError(e,t){console.error("Something went wrong with preparing item "+e.name+": "+t),console.warn(t),console.warn(e),ui.notifications.error("Something went wrong with preparing item "+e.name+": "+t)}_applyModiferTransformations(e){this.system.itemModifiers={};for(const t of Object.keys(e)){let a=game.dsa5.config.knownShortcuts[t.toLowerCase()];if(a){const s=e[t].reduce(((e,t)=>e+t.value),0);this.system[a[0]][a[1]][a[2]]+=s,this.system.itemModifiers[t]={value:s,sources:e[t].map((e=>e.source))}}}}_buildGearAndAbilityModifiers(e,t){const a=getProperty(t,"system.effect.value");if(a)for(let s of a.split(/,|;/).map((e=>e.trim()))){let a=s.replace(/(\s+)/g," ").trim().split(" ");if(2==a.length&&!isNaN(a[0])){let s={value:Number(a[0])*(t.system.step&&Number(t.system.step.value)||1),source:t.name,type:t.type};null==e[a[1]]?e[a[1]]=[s]:e[a[1]].push(s)}}}async _updateAPs(e,t={},a={}){if(Actordsa5.canAdvance(this))if(isNaN(e)||null==e)ui.notifications.error(game.i18n.localize("DSAError.APUpdateError"));else{const s=Number(e);t["system.details.experience.spent"]=Number(this.system.details.experience.spent)+s,await this.update(t,a);const i=game.i18n.format(s>0?"advancementCost":"refundCost",{cost:Math.abs(s)});(0,p.p0)(i)}}async checkEnoughXP(e){if(!Actordsa5.canAdvance(this))return!0;if(isNaN(e)||null==e)return!0;if(Number(this.system.details.experience.total)-Number(this.system.details.experience.spent)>=e)return!0;if(0==Number(this.system.details.experience.total)){const e=await renderTemplate("systems/dsa5/templates/dialog/parts/expChoices.html",{entries:i.Z.startXP});let t=0,a=!1;if([a,t]=await new Promise(((t,a)=>{new Dialog({title:game.i18n.localize("DSAError.NotEnoughXP"),content:e,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:e=>{t([!0,e.find(".APsel")[0].value])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{t([!1,0])}}}}).render(!0)})),a)return await this.update({"system.details.experience.total":Number(t)}),!0}return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughXP")),!1}setupWeapon(e,t,a,s){return a.mode=t,m.Z.getSubClass(e.type).setupDialog(null,a,e,this,s)}setupWeaponless(e,t={},a){let s=foundry.utils.duplicate(i.Z.defaultWeapon);s.name=game.i18n.localize(`${e}Weaponless`),s.system.combatskill={value:game.i18n.localize("LocalizedIDs.wrestle")},s.system.damageThreshold.value=14;const n=[];return c.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyAstralBody"))&&n.push(game.i18n.localize("magical")),c.Z.hasAbility(this,game.i18n.localize("LocalizedIDs.mightyKarmalBody"))&&n.push(game.i18n.localize("blessed")),mergeObject(s,{system:{effect:{attributes:n.join(", ")}}}),t.mode=e,m.Z.getSubClass(s.type).setupDialog(null,t,s,this,a)}setupSpell(e,t={},a){return m.Z.getSubClass(e.type).setupDialog(null,t,e,this,a)}setupSkill(e,t={},a){return m.Z.getSubClass(e.type).setupDialog(null,t,e,this,a)}tokenScrollingText(e){const t=this.isToken?[this.token?.object]:this.getActiveTokens(!0);for(let a of t){if(!a)continue;let t=0;for(let s of e)canvas.interface.createScrollingText(a.center,s.value,{anchor:t,direction:s.value>0?2:1,fontSize:game.settings.get("dsa5","scrollingFontsize"),stroke:s.stroke,strokeThickness:1,jitter:.25,duration:1e3}),t+=1}}async _preUpdate(e,t,a){await super._preUpdate(e,t,a);const s={wounds:9109504,astralenergy:723929,karmaenergy:303670},i=[];for(let t of Object.keys(s)){const a=getProperty(e,`system.status.${t}.value`);a&&i.push({value:a-this.system.status[t].value,stroke:s[t]})}i.length&&this.tokenScrollingText(i)}async applyDamage(e){const t=Math.min(this.system.status.wounds.max,this.system.status.wounds.value-e);await this.update({"system.status.wounds.value":t})}async applyRegeneration(e,t,a){const s={"system.status.wounds.value":Math.min(this.system.status.wounds.max,this.system.status.wounds.value+(e||0)),"system.status.karmaenergy.value":Math.min(this.system.status.karmaenergy.max,this.system.status.karmaenergy.value+(a||0)),"system.status.astralenergy.value":Math.min(this.system.status.astralenergy.max,this.system.status.astralenergy.value+(t||0))};await this.update(s)}async applyMana(e,t){let a="AsP"==t?"astralenergy":"karmaenergy";const s=Math.min(this.system.status[a].max,this.system.status[a].value-e);return s>=0?(await this.update({[`data.status.${a}.value`]:s}),!0):(ui.notifications.error(game.i18n.localize(`DSAError.NotEnough${t}`)),!1)}preparePostRollAction(e){let t=e.flags.data,a={flags:{img:e.flags.img},rollMode:t.rollMode,speaker:e.speaker,template:t.template,title:t.title,user:e.user};return t.attackerMessage&&(a.attackerMessage=t.attackerMessage),t.defenderMessage&&(a.defenderMessage=t.defenderMessage),t.unopposedStartMessage&&(a.unopposedStartMessage=t.unopposedStartMessage),a}resetTargetAndMessage(e,t){e.originalTargets?.size&&(game.user.targets=e.originalTargets,game.user.targets.user=game.user),!e.defenderMessage&&e.startMessagesList&&(t.startMessagesList=e.startMessagesList)}async fatererollDamage(e,t,a,i,r,o){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(r,t);let l=r.postData.damageRoll,c=await n.Z.manualRolls(await new Roll(l.formula||l._formula).evaluate({async:!0}),"CHATCONTEXT.rerollDamage");for(let e=0;e<c.dice.length;e++)c.dice[e].options.colorset="black";await n.Z.showDiceSoNice(c,a.rollMode),ChatMessage.create(s.Z.chatDataSetup(e)),a.damageRoll=duplicate(c),this[`${r.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:i}),await i.update({"flags.data.fatePointDamageRerollUsed":!0}),await this.reduceSchips(o)}async fateisTalented(e,t,a,i,r){t.talentedRerollUsed=!0,this.resetTargetAndMessage(r,t),e=`<h3 class="center"><b>${game.i18n.localize("CHATFATE.fatepointUsed")}</b></h3>\n            ${game.i18n.format("CHATFATE.isTalented",{character:"<b>"+this.name+"</b>"})}<br>`;const l=await renderTemplate("systems/dsa5/templates/dialog/isTalentedReroll-dialog.html",{testData:a,postData:r.postData});new o.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:l,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async o=>{let l=o.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get();if(l.length>0){let o=[];for(let e of l){let t=a.roll.terms[2*e];o.push(t.number+"d"+t.faces+"["+t.options.colorset+"]")}o=await n.Z.manualRolls(await new Roll(o.join("+")).evaluate({async:!0}),"CHATCONTEXT.talentedReroll"),await n.Z.showDiceSoNice(o,a.rollMode);let c=0,d=[];for(let e of l){const t=a.source.system[`characteristic${e+1}`],s=t?game.i18n.localize(`CHARAbbrev.${t.value.toUpperCase()}`)+" - ":"";d.push(`${s}${a.roll.terms[2*e].results[0].result}/${o.terms[2*c].results[0].result}`),a.roll.terms[2*e].results[0].result=Math.min(o.terms[2*c].results[0].result,a.roll.terms[2*e].results[0].result),c+=1}e+=`<b>${game.i18n.localize("Roll")}</b>: ${d.join(", ")}`,ChatMessage.create(s.Z.chatDataSetup(e)),this[`${r.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:i}),await i.update({"flags.data.talentedRerollUsed":!0})}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}async fatereroll(e,t,a,i,r,l){t.fatePointDamageRerollUsed=!0,this.resetTargetAndMessage(r,t);const c=await renderTemplate("systems/dsa5/templates/dialog/fateReroll-dialog.html",{testData:a,postData:r.postData,singleDie:1==r.postData.characteristics.length});new o.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:c,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async o=>{let c=o.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get();if(c.length>0){let o=[];for(let e of c){let t=a.roll.terms[2*e];o.push(t.number+"d"+t.faces+"["+t.options.colorset+"]")}o=await n.Z.manualRolls(await new Roll(o.join("+")).evaluate({async:!0}),"CHATCONTEXT.Reroll"),await n.Z.showDiceSoNice(o,a.rollMode);let d=0,m=[];const u=s.Z.getSpeaker(a.extra.speaker),g=game.i18n.localize("LocalizedIDs.traditionPhex"),p=u.items.some((e=>"specialability"==e.type&&e.name==g));for(let e of c){const t=a.source.system[`characteristic${e+1}`],s=t?`${game.i18n.localize(`CHARAbbrev.${t.value.toUpperCase()}`)} - `:"";m.push(`${s}${a.roll.terms[2*e].results[0].result}/${o.terms[2*d].results[0].result}`),a.roll.terms[2*e].results[0].result=p?Math.min(o.terms[2*d].results[0].result,a.roll.terms[2*e].results[0].result):o.terms[2*d].results[0].result,d+=1}e+=`<br><b>${game.i18n.localize("Roll")}</b>: ${m.join(", ")}`,ChatMessage.create(s.Z.chatDataSetup(e)),this[`${r.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:i}),await i.update({"flags.data.fatePointRerollUsed":!0}),await this.reduceSchips(l)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}async fateaddQS(e,t,a,i,n,r){ChatMessage.create(s.Z.chatDataSetup(e)),game.user.targets.forEach((e=>e.setTarget(!1,{user:game.user,releaseOthers:!1,groupSelection:!0}))),t.fatePointAddQSUsed=!0,a.qualityStep=1,this[`${n.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:i}),await i.update({"flags.data.fatePointAddQSUsed":!0}),await this.reduceSchips(r)}async fateImprove(e,t,a,i,n,r){ChatMessage.create(s.Z.chatDataSetup(e)),this.resetTargetAndMessage(n,t);let l=i.flags.data.preData.source.type;if(["spell","liturgy","ceremony","ritual","skill"].includes(l)){const e=await renderTemplate("systems/dsa5/templates/dialog/fateImprove-dialog.html",{testData:a,postData:n.postData});new o.Z({title:game.i18n.localize("CHATFATE.selectDice"),content:e,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Ok"),callback:async e=>{let s=[0,0,0],o=e.find(".dieSelected").map((function(){return Number($(this).attr("data-index"))})).get();if(1==o.length){s[o]=2;const e={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:s.join("|"),type:"roll"};a.roll.terms[2*o].results[0].result=Math.max(1,a.roll.terms[2*o].results[0].result-2),a.situationalModifiers.push(e),this[`${n.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:i}),await i.update({"flags.data.fateImproved":!0}),await this.reduceSchips(r)}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else{const e={name:game.i18n.localize("CHATCONTEXT.improveFate"),value:2,type:"roll"};a.situationalModifiers.push(e),a.roll.terms[0].results[0].result=Math.max(1,a.roll.terms[0].results[0].result-2),this[`${n.postData.postFunction}`]({testData:a,cardOptions:t},{rerenderMessage:i}),await i.update({"flags.data.fateImproved":!0}),await this.reduceSchips(r)}}async reduceSchips(e){0==e?await this.update({"system.status.fatePoints.value":this.system.status.fatePoints.value-1}):await Actordsa5.reduceGroupSchip()}static async reduceGroupSchip(){if(game.user.isGM){const e=game.settings.get("dsa5","groupschips").split("/").map((e=>Number(e)));e[0]=e[0]-1,await game.settings.set("dsa5","groupschips",e.join("/"))}else game.socket.emit("system.dsa5",{type:"reduceGroupSchip",payload:{}})}async useFateOnRoll(e,t,a){if("isTalented"==t||s.Z.fateAvailable(this,1==a)){let i,n,r=e.flags.data,o=this.preparePostRollAction(e);0==a?(i=this.system.status.fatePoints.value-1,n="PointsRemaining"):(i=game.settings.get("dsa5","groupschips").split("/")[0],n="GroupPointsRemaining");let l=`<h3 class="center"><b>${game.i18n.localize("CHATFATE.fatepointUsed")}</b></h3>\n                ${game.i18n.format("CHATFATE."+t,{character:"<b>"+this.name+"</b>"})}<br>\n                <b>${game.i18n.localize(`CHATFATE.${n}`)}</b>: ${i}`,c=r.preData;c.extra.actor=s.Z.getSpeaker(c.extra.speaker).toObject(!1),this[`fate${t}`](l,o,c,e,r,a)}}get horseSpeed(){return v.Z.getHorseSpeed(this)}setupFallingDamage(e,t){const a=game.i18n.localize("fallingDamage"),s=this.items.find((e=>"skill"==e.type&&e.name==game.i18n.localize("LocalizedIDs.bodyControl"))).toObject(),i={subtitle:` (${a})`,postFunction:{functionName:"game.dsa5.entities.Actordsa5.updateFallingDamage",options:e,tokenId:t,speaker:m.Z.buildSpeaker(this,t)}};this.setupSkill(s,i,t).then((async e=>{e.testData.opposable=!1;const t=await this.basicTest(e,{suppressMessage:!0});await Actordsa5.updateFallingDamage(i.postFunction,t),await n.Z.renderRollCard(t.cardOptions,t.result,t.options.rerenderMessage)}))}static async updateFallingDamage(e,t,a){const i=2*(t.result.qualityStep||0);mergeObject(e.options,{availableQs:i});const n=s.Z.getSpeaker(e.speaker),r=await n._setupFallingHeight(e.options,e.tokenId),o=await n.basicTest(r,{suppressMessage:!0}),l=await renderTemplate("systems/dsa5/templates/chat/roll/fallingdamage-card.html",o);t.result.other||(t.result.other=[]),t.result.other.push(l),t.chatData&&(t.chatData.other=[l])}_setupFallingHeight(e,t){let a=game.i18n.localize("fallingDamage"),s={source:{type:"fallingDamage"},opposable:!1,extra:{actor:this.toObject(!1),options:e,speaker:m.Z.buildSpeaker(this,t)}},r={title:a,template:"/systems/dsa5/templates/dialog/fallingdamage-dialog.html",data:{rollMode:e.rollMode,situationalModifiers:[],fallingFloorOptions:i.Z.fallingConditions,modifier:e.modifier||0},callback:(e,t={})=>(s.situationalModifiers=[],s.situationalModifiers.push({name:game.i18n.localize("fallingFloor"),value:e.find('[name="fallingFloor"]').val()}),o.rollMode=e.find('[name="rollMode"]').val(),s.fallingHeight=e.find('[name="testModifier"]').val(),mergeObject(s.extra.options,t),{testData:s,cardOptions:o})},o=this._setupCardOptions("systems/dsa5/templates/chat/roll/fallingdamage-card.html",a,t);return n.Z.setupDialog({dialogOptions:r,testData:s,cardOptions:o})}setupRegeneration(e,t={},a){let s=game.i18n.localize("regenerationTest"),r={source:{type:"regenerate",system:{}},opposable:!1,extra:{statusId:e,actor:this.toObject(!1),options:t,speaker:m.Z.buildSpeaker(this,a)}};r.extra.actor.isMage=this.system.isMage,r.extra.actor.isPriest=this.system.isPriest;let o=d.Z.getRollModifiers(r.extra.actor,r.source),l={title:s,template:"/systems/dsa5/templates/dialog/regeneration-dialog.html",data:{rollMode:t.rollMode,regenerationInterruptOptions:i.Z.regenerationInterruptOptions,regnerationCampLocations:i.Z.regnerationCampLocations,showAspModifier:this.system.isMage,showKapModifier:this.system.isPriest,situationalModifiers:o,modifier:t.modifier||0},callback:(e,t={})=>{r.situationalModifiers=Actordsa5._parseModifiers(e),c.rollMode=e.find('[name="rollMode"]').val(),r.situationalModifiers.push({name:game.i18n.localize("camplocation")+" - "+e.find('[name="regnerationCampLocations"] option:selected').text(),value:e.find('[name="regnerationCampLocations"]').val()},{name:game.i18n.localize("interruption")+" - "+e.find('[name="regenerationInterruptOptions"] option:selected').text(),value:e.find('[name="regenerationInterruptOptions"]').val()}),r.regenerationFactor=e.find('[name="badEnvironment"]').is(":checked")?.5:1;const a=["LeP","KaP","AsP"],s={};for(let t of a){r[`${t}Modifier`]=Number(e.find(`[name="${t}Modifier"]`).val()||0),r[`regeneration${t}`]=Number(this.system.status.regeneration[`${t}max`]);const a=e.find(`[name="regenerate${t}"]`).is(":checked")?1:0;r[`regenerate${t}`]=a,a&&(s[`system.status.regeneration.${t}Temp`]=0)}return mergeObject(r.extra.options,t),this.update(s),{testData:r,cardOptions:c}}},c=this._setupCardOptions("systems/dsa5/templates/chat/roll/regeneration-card.html",s,a);return n.Z.setupDialog({dialogOptions:l,testData:r,cardOptions:c})}setupDodge(e={},t){const a="dodge";let s=this.system.status.dodge,i=game.i18n.localize(a)+" "+game.i18n.localize("Test"),r={source:{system:s,type:a},opposable:!1,extra:{statusId:a,actor:this.toObject(!1),options:e,speaker:m.Z.buildSpeaker(this,t)}},o=[game.i18n.localize(a),game.i18n.localize("LocalizedIDs.wrestle")],l=m.Z.buildCombatSpecAbs(this,["Combat"],o,"parry"),c=d.Z.getRollModifiers(r.extra.actor,r.source);const u=m.Z.getDefenseMalus(c,this),p=g.Z.multipleDefenseValue(this,r.source);let h={title:i,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:{rollMode:e.rollMode,combatSpecAbs:l,showDefense:!0,situationalModifiers:c,isRangeAttack:u,defenseCountString:game.i18n.format("defenseCount",{malus:p}),isDodge:!0},callback:(e,t={})=>(f.rollMode=e.find('[name="rollMode"]').val(),r.situationalModifiers=Actordsa5._parseModifiers(e),r.situationalModifiers.push(...m.Z.getSpecAbModifiers(e,"parry")),r.situationalModifiers.push({name:game.i18n.localize("attackFromBehind"),value:e.find('[name="attackFromBehind"]').is(":checked")?-4:0},{name:game.i18n.format("defenseCount",{malus:p}),value:(Number(e.find('[name="defenseCount"]').val())||0)*p},{name:game.i18n.localize("advantageousPosition"),value:e.find('[name="advantageousPosition"]').is(":checked")?2:0}),mergeObject(r.extra.options,t),{testData:r,cardOptions:f})},f=this._setupCardOptions("systems/dsa5/templates/chat/roll/status-card.html",i,t);return n.Z.setupDialog({dialogOptions:h,testData:r,cardOptions:f})}setupCharacteristic(e,t={},a){let r=duplicate(this.system.characteristics[e]),o=s.Z.attributeLocalization(e)+" "+game.i18n.localize("Test");r.attr=e;let l={opposable:!1,source:{type:"char",system:r},extra:{characteristicId:e,actor:this.toObject(!1),options:t,speaker:m.Z.buildSpeaker(this,a)}},c={title:o,template:"/systems/dsa5/templates/dialog/characteristic-dialog.html",data:{rollMode:t.rollMode,difficultyLabels:i.Z.attributeDifficultyLabels,modifier:t.modifier||0},callback:(e,t={})=>(d.rollMode=e.find('[name="rollMode"]').val(),l.testDifficulty=i.Z.attributeDifficultyModifiers[e.find('[name="testDifficulty"]').val()],l.situationalModifiers=Actordsa5._parseModifiers(e),mergeObject(l.extra.options,t),{testData:l,cardOptions:d})},d=this._setupCardOptions("systems/dsa5/templates/chat/roll/characteristic-card.html",o,a);return n.Z.setupDialog({dialogOptions:c,testData:l,cardOptions:d})}static _parseModifiers(e,t){let a=[];return e.find('[name="situationalModifiers"] option:selected').each((function(){const e=$(this).val();let t={name:$(this).text().trim().split("[")[0],value:isNaN(e)?e:Number(e),type:$(this).attr("data-type")};"dmg"==t.type&&(t.damageBonus=t.value,t.value=0),$(this).attr("data-specAbId")&&(t.specAbId=$(this).attr("data-specAbId")),$(this).attr("data-armorPen")&&(t.armorPen=$(this).attr("data-armorPen")),a.push(t)})),a.push({name:game.i18n.localize("manual"),value:Number(e.find('[name="testModifier"]').val()),type:""}),a}static _prepareConsumable(e){return e.system.maxCharges&&(e.consumable=!0,e.structureMax=e.system.maxCharges,e.structureCurrent=e.system.charges),e}static prepareMag(e){return"mag"==e.system.ammunitiongroup.value&&(e.structureMax=e.system.mag.max,e.structureCurrent=e.system.mag.value),e}static _prepareitemStructure(e){e.system.structure&&0!=e.system.structure.max&&(e.structureMax=e.system.structure.max,e.structureCurrent=e.system.structure.value);const t=getProperty(e,"flags.dsa5.enchantments");if(t&&t.length>0)e.enchantClass="rar";else if(e.effects.length>0)e.enchantClass="common";else if(e.system.effect&&""!=e.system.effect.value)if("armor"==e.type)for(let t of e.system.effect.value.split(/,|;/).map((e=>e.trim()))){let a=t.replace(/(\s+)/g," ").trim().split(" ");if(2!=a.length||![game.i18n.localize("CHARAbbrev.INI").toLowerCase(),game.i18n.localize("CHARAbbrev.GS").toLowerCase()].includes(a[1].toLowerCase())||isNaN(a[0])||-1!=a[0]){e.enchantClass="common";break}}else e.enchantClass="common";return e}static _prepareMeleetrait(e){return e.attack=Number(e.system.at.value),0!=e.system.pa&&(e.parry=e.system.pa),this._parseDmg(e)}static _prepareMeleeWeapon(e,t,a,s=null){let i=t.find((t=>t.name==e.system.combatskill.value));if(i){e.attack=Number(i.system.attack.value)+Number(e.system.atmod.value);const t=e.system.guidevalue.value.split("/").map((e=>a.system.characteristics[e]?Number(a.system.characteristics[e].initial)+Number(a.system.characteristics[e].modifier)+Number(a.system.characteristics[e].advances)+Number(a.system.characteristics[e].gearmodifier):0)),n=Math.ceil(i.system.talentValue.value/2)+Math.max(0,Math.floor((Math.max(...t)-8)/3))+Number(game.settings.get("dsa5","higherDefense"));e.parry=n+Number(e.system.pamod.value)+(e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Shields")?Number(e.system.pamod.value):0),e.yieldedTwoHand=g.Z.isYieldedTwohanded(e),e.yieldedTwoHand||(s||(s=duplicate(a.items).filter((t=>"meleeweapon"==t.type&&t.system.worn.value&&t._id!=e._id&&!g.Z.isYieldedTwohanded(t)))),s.length>0&&(e.parry+=Math.max(...s.map((e=>e.system.pamod.offhandMod))),e.attack+=Math.max(...s.map((e=>e.system.atmod.offhandMod)))));let r=0;if(e.system.worn.wrongGrip)if(e.yieldedTwoHand)e.parry-=1,r=1;else{e.system.reach.value="medium";switch(game.i18n.localize(`LocalizedCTs.${e.system.combatskill.value}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":e.parry-=3;if(new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")).test(e.name))r=-2;else{const t=game.i18n.localize("wrongGrip.oneHanded");e.gripDamageText=` (${t} * 0.5)`,e.dmgMultipliers=[{name:t,val:"0.5"}]}break;default:e.parry-=1,r=-1}}if("-"!=(e=this._parseDmg(e)).system.guidevalue.value){let t=Math.max(...e.system.guidevalue.value.split("/").map((e=>Number(a.system.characteristics[e].value)))),s=Math.max(t-Number(e.system.damageThreshold.value),0)+r;s>0&&(e.extraDamage=s,e.damageAdd=Roll.safeEval(e.damageAdd+" + "+Number(s)),e.damageAdd=(e.damageAdd>0?"+":"")+e.damageAdd)}h.Z.weaponWearModifier(e),e.system.damageToolTip=h.Z.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return e}async actorEffects(){const e=["dead"];return game.user.isGM||this.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects")?this.effects.filter((e=>e.isVisibleEffect())):this.effects.filter((t=>e.some((e=>t.statuses.has(e)))))}async _preCreate(e,t,a){await super._preCreate(e,t,a);let s={};e.img||(s.img="icons/svg/mystery-man-black.svg"),"character"==e.type&&mergeObject(s,{prototypeToken:{sight:{enabled:!0},actorLink:!0}}),this.updateSource(s)}static _prepareRangeTrait(e){return e.attack=Number(e.system.at.value),e.LZ=Number(e.system.reloadTime.value),e.LZ>0&&Actordsa5.buildReloadProgress(e),this._parseDmg(e)}static calcLZ(e,t){let a=1,i=0;e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Throwing Weapons")?i=-1*c.Z.abilityStep(t,game.i18n.localize("LocalizedIDs.quickdraw")):e.system.combatskill.value==game.i18n.localize("LocalizedIDs.Crossbows")&&c.Z.hasAbility(t,`${game.i18n.localize("LocalizedIDs.quickload")} (${game.i18n.localize("LocalizedIDs.Crossbows")})`)?a=.5:i=-1*c.Z.abilityStep(t,`${game.i18n.localize("LocalizedIDs.quickload")} (${game.i18n.localize(e.system.combatskill.value)})`);let n=`${e.system.reloadTime.value}`.split("/");if("mag"==e.system.ammunitiongroup.value){let a=t.items.find((t=>t.id==e.system.currentAmmo.value||t._id==e.system.currentAmmo.value)),i=0;a&&(a=s.Z.toObjectIfPossible(a),a.system.mag.value<=0&&(i=1)),n=n[i]||n[0]}else n=n[0];return Math.max(0,Math.round(Number(n)*a)+i)}static _parseDmg(e,t){let a=new Roll(e.system.damage.value.replace(/[Ww]/g,"d"),{async:!1}),s="",i="",n="+";for(let e of a.terms)e.faces?s=e.number+"d"+e.faces:e.operator?n=e.operator:e.number&&(i+=Number(`${n}${e.number}`));if(t){let a=getProperty(t,"system.damageMod");Number(a)?i+=`+${Number(a)}`:a&&(e.damageBonusDescription=`, ${a} ${game.i18n.localize("CHARAbbrev.damage")} ${t.name}`)}return i&&(i=Roll.safeEval(i)),e.damagedie=s||"0d6",e.damageAdd=""!=i?(Number(i)>=0?"+":"")+i:"",e}static buildReloadProgress(e){const t=e.system.reloadTime.progress/e.LZ;e.title=game.i18n.format("WEAPON.loading",{status:`${e.system.reloadTime.progress}/${e.LZ}`}),e.progress=`${e.system.reloadTime.progress}/${e.LZ}`,t>=1&&(e.title=game.i18n.localize("WEAPON.loaded")),this.progressTransformation(e,t)}static progressTransformation(e,t){t>=.5?(e.transformRight="181deg",e.transformLeft=`${Math.round(360*t-179)}deg`):(e.transformRight=`${Math.round(360*t+1)}deg`,e.transformLeft=0)}static buildSpellChargeProgress(e){if(e.LZ=Number(e.system.castingTime.modified)||0,e.LZ>1){const t=e.system.castingTime.progress/e.LZ;e.title=game.i18n.format("SPELL.loading",{status:`${e.system.castingTime.progress}/${e.LZ}`}),e.progress=`${e.system.castingTime.progress}/${e.LZ}`,this.progressTransformation(e,t)}return e}static _prepareRangeWeapon(e,t,a,s){let i,n=a.find((t=>t.name==e.system.combatskill.value));if(e.calculatedRange=e.system.reach.value,n){if(e.attack=Number(n.system.attack.value),"-"!=e.system.ammunitiongroup.value&&(e.ammo=t.filter((t=>t.system.ammunitiongroup.value==e.system.ammunitiongroup.value)),i=t.find((t=>t._id==e.system.currentAmmo.value)),i)){const t=Number(i.system.rangeMultiplier)||1;e.calculatedRange=e.calculatedRange.split("/").map((e=>Math.round(Number(e)*t))).join("/"),e.attack+=Number(i.system.atmod)||0,"mag"==i.system.ammunitiongroup.value&&(e.ammoMax=i.system.mag.max,e.ammoCurrent=i.system.mag.value)}e.LZ=Actordsa5.calcLZ(e,s),e.LZ>0&&Actordsa5.buildReloadProgress(e),h.Z.weaponWearModifier(e),e.system.damageToolTip=h.Z.damageTooltip(e)}else ui.notifications.error(game.i18n.format("DSAError.unknownCombatSkill",{skill:e.system.combatskill.value,item:e.name}));return this._parseDmg(e,i)}_setupCardOptions(e,t,a){const s=game.canvas?.tokens?.get(a);let i={speaker:{alias:s?s.name:this.prototypeToken.name,actor:this.id},title:t,template:e,flags:{img:this.prototypeToken.randomImg?this.img:this.prototypeToken.img}};if(this.token)i.speaker.alias=this.token.name,i.speaker.token=this.token.id,i.speaker.scene=canvas.scene.id,i.flags.img=this.token.img;else{let e=ChatMessage.getSpeaker();e.actor==this.id&&(i.speaker.alias=e.alias,i.speaker.token=e.token,i.speaker.scene=e.scene,i.flags.img=e.token?canvas.tokens.get(e.token).img:i.flags.img)}return i}async swapMag(e){const t=this.items.get(e),a=this.items.get(t.system.currentAmmo.value);if(a&&a.system.quantity.value>1)return await this.updateEmbeddedDocuments("Item",[{_id:a.id,"system.quantity.value":a.system.quantity.value-1,"system.mag.value":a.system.mag.max}]),y.Z.playEquipmentWearStatusChange(a),a;ui.notifications.error(game.i18n.localize("DSAError.NoAmmo"))}async payMiracles(e){if(!e.extra.miraclePaid){e.extra.miraclePaid=!0;const t=e.situationalModifiers.some((e=>e.name.trim()==game.i18n.localize("LocalizedIDs.miracleMight"))),a=e.situationalModifiers.some((e=>e.name.trim()==game.i18n.localize("LocalizedIDs.miracle"))),s=t?6:a?4:0;s&&await this.update({"system.status.karmaenergy.value":this.system.status.karmaenergy.value-s})}}async consumeAmmunition(e){if(e.extra.ammo&&!e.extra.ammoDecreased){if(e.extra.ammoDecreased=!0,e.extra.ammo._id){let t={_id:e.extra.ammo._id};"mag"==e.extra.ammo.system.ammunitiongroup.value?e.extra.ammo.system.mag.value<=0?(e.extra.ammo.system.quantity.value--,t["system.quantity.value"]=e.extra.ammo.system.quantity.value,t["system.mag.value"]=e.extra.ammo.system.mag.max-1):t["system.mag.value"]=e.extra.ammo.system.mag.value-1:(e.extra.ammo.system.quantity.value--,t["system.quantity.value"]=e.extra.ammo.system.quantity.value),await this.updateEmbeddedDocuments("Item",[t,{_id:e.source._id,"system.reloadTime.progress":0}])}}else"rangeweapon"!=e.source.type&&("trait"!=e.source.type||"rangeAttack"!=e.source.system.traitType.value)||e.extra.ammoDecreased?["spell","liturgy"].includes(e.source.type)&&"emptyActor"!=e.extra.speaker.token&&await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.castingTime.progress":0,"system.castingTime.modified":0}]):(e.extra.ammoDecreased=!0,await this.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":0}]))}_checkMaximumItemAdvancement(e,t){let a=0;switch(e.type){case"combatskill":a=Math.max(...e.system.guidevalue.value.split("/").map((e=>this.system.characteristics[e].value)))+2+l.Z.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalCombatTechnique")} (${e.name})`);break;case"spell":case"ritual":let t=0;for(const a of e.system.feature.replace(/\(a-z äöü\-\)/gi,"").split(",").map((e=>e.trim())))if(c.Z.hasAbility(this,`${game.i18n.localize("LocalizedIDs.propertyKnowledge")} (${a})`)){t=this.maxByAttr(e);break}a=Math.max(14+l.Z.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`),t);break;case"liturgy":case"ceremony":const s=new RegExp(`^${game.i18n.localize("LocalizedIDs.aspectKnowledge")}`);let i=0;this.items.filter((e=>"specialability"==e.type&&s.test(e.name))).some((t=>e.system.distribution.value.includes(t.name.split("(")[1].split(")")[0])))&&(i=this.maxByAttr(e)),a=Math.max(14+l.Z.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`),i);break;case"skill":a=this.maxByAttr(e)}const s=t<=a;return s||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),{result:s,max:a}}maxByAttr(e){return Math.max(this.system.characteristics[e.system.characteristic1.value].value,this.system.characteristics[e.system.characteristic2.value].value,this.system.characteristics[e.system.characteristic3.value].value)+2+l.Z.vantageStep(this,`${game.i18n.localize("LocalizedIDs.exceptionalSkill")} (${e.name})`)}async basicTest({testData:e,cardOptions:t},a={}){e=await n.Z.rollDices(e,t);let s=await n.Z.rollTest(e);if(e.extra.options.other&&(s.other||(s.other=[]),s.other.push(...e.extra.options.other)),s.postFunction="basicTest",game.user.targets.size){t.isOpposedTest=e.opposable;const a=` - ${game.i18n.localize("Opposed")}`;t.isOpposedTest&&t.title.match(a+"$")!=a&&(t.title+=a)}if(await this.consumeAmmunition(e),await this.payMiracles(e),!a.suppressMessage){const e=await n.Z.renderRollCard(t,s,a.rerenderMessage);await r.Z.handleOpposedTarget(e),s.messageId=e.id}return{result:s,cardOptions:t,options:a}}async addCondition(e,t=1,a=!1,s=!0){return"bleeding"==e||"bleeding"==e.id?await g.Z.bleedingMessage(this):!this.isToken||this.token?.object?await d.Z.addCondition(this,e,t,a,s):void console.warn("Actor token object is null for",this.name)}async addTimedCondition(e,t=1,a=!1,s=!0,i={}){return"bleeding"==e||"bleeding"==e.id?await g.Z.bleedingMessage(this):("string"==typeof e&&i.duration&&((e=duplicate(CONFIG.statusEffects.find((t=>t.id==e)))).flags.dsa5.description=game.i18n.localize(e.name),e.name=game.i18n.localize(e.name),delete e.description,delete e.flags.dsa5.value,delete e.flags.dsa5.max,delete e.id,mergeObject(e,i)),await d.Z.addCondition(this,e,t,a,s))}async initResistPainRoll(e){const t=game.settings.get("dsa5","selfControlOnPain");if(this.hasCondition("incapacitated"))return;if(2==t||1==t&&!this.hasPlayerOwner)return void await this.addCondition("incapacitated");const a=await renderTemplate("systems/dsa5/templates/chat/roll/resist-pain.html",{actor:this});await ChatMessage.create(s.Z.chatDataSetup(a))}async finishResistPainRoll(){const e=this.items.find((e=>e.name==game.i18n.localize("LocalizedIDs.selfControl")&&"skill"==e.type));this.setupSkill(e,{subtitle:` (${game.i18n.localize("ActiveEffects.resistRoll")})`},this.token?.id).then((async e=>{((await this.basicTest(e)).result.successLevel||0)<1&&this.addCondition("incapacitated")}))}async removeCondition(e,t=1,a=!0,s=!1){return await d.Z.removeCondition(this,e,t,a,s)}hasCondition(e){return d.Z.hasCondition(this,e)}async markDead(e){const t=this.getActiveTokens();for(let a of t)a.combatant&&await a.combatant.update({defeated:e})}}},416:(e,t,a)=>{a.d(t,{TB:()=>UserMultipickDialog,Z0:()=>SelectUserDialog,xb:()=>AddTargetDialog});var s=a(565),i=a(491);class AddTargetDialog extends Dialog{static async getDialog(e){const t=Array.from(game.user.targets).map((e=>e.id)),a=[],i=canvas.scene?canvas.scene.tokens.get(e.token)?.object:void 0;return game.combat&&game.combat.combatants.forEach((e=>{if(e.visible){if(e.isSelected=t.includes(e.token.id),i&&e.token){const t=canvas.scene.tokens.get(e.token.id).object;e.distance=s.Z.rangeFinder(i,t),e.distance.distanceSum=Number(e.distance.distanceSum.toFixed(1))}a.push(e)}})),new AddTargetDialog({title:game.i18n.localize("DIALOG.addTarget"),content:await renderTemplate("systems/dsa5/templates/dialog/addTarget-dialog.html",{selectables:a}),default:"yes",buttons:{}})}activateListeners(e){super.activateListeners(e);const t=e.find(".combatant");t.click((e=>this.setTargets(e))),t.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),t.mousedown((e=>this._onRightClick(e)))}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onRightClick(e){if(2==e.button){const t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);if(t.token)return canvas.animatePan({x:t.token.x,y:t.token.y})}}_getCombatApp(){return game.combats.apps[0]}async setTargets(e){const t=e.originalEvent.shiftKey;t||$(e.currentTarget).closest(".directory").find(".combatant").removeClass("selectedTarget"),$(e.currentTarget).addClass("selectedTarget");const a=e.currentTarget.dataset.combatantId;game.combat.combatants.get(a).token.object.setTarget(!0,{user:game.user,releaseOthers:!t,groupSelection:!0})}}class SelectUserDialog extends Dialog{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5Decent"])}),e}static async getDialog(){const e=game.users.filter((e=>e.active&&!e.isGM));return new SelectUserDialog({title:game.i18n.localize("DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsa5/templates/dialog/selectForUserDialog.html",{users:e}),default:"yes",buttons:{}})}static registerButtons(){Hooks.on("getSceneControlButtons",(e=>{if(!game.user.isGM)return;const t={name:"targetUser",title:game.i18n.localize("CONTROLS.targetForUser"),icon:"fa fa-bullseye",button:!0,onClick:async()=>{(await SelectUserDialog.getDialog()).render(!0)}};e[0].tools.splice(2,0,t)}))}activateListeners(e){super.activateListeners(e),e.find(".combatant").click((e=>this.setTargetToUser(e)))}setTargetToUser(e){const t=Array.from(game.user.targets).map((e=>e.id)),a=e.currentTarget.dataset.userId;game.users.get(a).updateTokenTargets(t),game.socket.emit("userActivity",a,{targets:t}),this.close()}}class UserMultipickDialog extends Dialog{static async getDialog(e){const t=game.users.filter((e=>e.active&&!e.isGM));new UserMultipickDialog({title:game.i18n.localize("SHEET.PostItem"),content:await renderTemplate("systems/dsa5/templates/dialog/usermultipickdialog.html",{users:t}),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:t=>{this.postContent(t,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}static async postContent(e,t){const a=i.Z.chatDataSetup(t);if(!e.find("#sel_all").is(":checked")){const t=[];e.find(".usersel:checked").each((function(){t.push($(this).val())})),a.whisper=t}ChatMessage.create(a)}activateListeners(e){super.activateListeners(e),e.find('[name="sel_all"]').change((t=>{e.find(".usersel").prop("disabled",t.currentTarget.checked).prop("checked",t.currentTarget.checked)}))}}},70:(e,t,a)=>{a.d(t,{Z:()=>DSA5CombatDialog});var s=a(369),i=a(839),n=a(272),r=a(577),o=a(562),l=a(169),c=a(122),d=(a(173),a(491)),m=a(538),u=a(5),g=a(973);class DSA5CombatDialog extends u.Z{static rollModifiers={wrongHand:{mod:-4},advantageousPosition:{mod:2},attackFromBehindLabel:{mod:-4},opportunityAttack:{mod:-4},doubleAttack:{mod:-2},narrowSpace:{mod:0},combatTurmoil:{mod:-2},quickChange:{mod:-4},targetMovement:{mod:0}};static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}static setData(e,t,a){const s=duplicate(DSA5CombatDialog.rollModifiers);s.narrowSpace.mod=this.getNarrowSpaceModifier(a,a.mode);const i=`${t}RollModifiers`;if(e.system[i])for(let t of Object.keys(e.system[i]))s[t].mod+=Number(e.system[i][t]?.mod??0);return s}activateListeners(e){super.activateListeners(e);let t=e.find(".specAbs");t.mouseenter((e=>{if(0==e.currentTarget.getElementsByClassName("hovermenu").length){let t=document.createElement("div");t.classList.add("hovermenu");let a=document.createElement("i");a.classList.add("fas","fa-comment"),a.title=game.i18n.localize("SHEET.PostItem"),a.addEventListener("mousedown",this._postItem,!1),t.appendChild(a),e.currentTarget.appendChild(t)}})),t.mouseleave((e=>{let t=e.toElement||e.relatedTarget;t.parentNode!=this&&t!=this&&e.currentTarget.querySelectorAll(".hovermenu").forEach((e=>e.remove()))})),e.find(".variantChange").mousedown((e=>this.changeSpecAbVariant(e))),e.on("mousedown",".specAbs",(t=>{if(e.find(".opportunityAttack").is(":checked"))return void ui.notifications.error(game.i18n.localize("DSAError.opposedAttackNoSpecAbs"));const a=$(t.currentTarget);let s=Number(a.attr("data-step"));const i=Number(a.attr("data-maxStep")),n=Number(a.attr("data-category"));if(0==t.button){if(s=Math.min(i,s+1),[0,1].includes(n)&&game.settings.get("dsa5","limitCombatSpecAbs")){const e=a.siblings(`[data-category="${n}"]`);e.removeClass("active").attr("data-step",0),e.find(".step").text(u.Z.roman[0])}}else 2==t.button&&(s=Math.clamped(i,0,s-1));a.attr("data-step",s),s>0?a.addClass("active"):a.removeClass("active"),a.find(".step").text(u.Z.roman[s]),this.checkCounterAttack(t),this.calculateModifier()})),e.find(".opportunityAttack").change((t=>{if($(t.currentTarget).is(":checked"))for(let t of e.find(".specAbs"))$(t).removeClass("active").attr("data-step",0).find(".step").text("")})),e.on("change","input,select",(e=>this.calculateModifier(e))),e.find(".modifiers option").mousedown((e=>{this.calculateModifier(e)})),e.find(".quantity-click").mousedown((e=>this.calculateModifier(e)));let a=this.readTargets();this.calculateModifier();const s=this;this.checkTargets=setInterval((function(){a=s.compareTargets(e,a)}),500)}checkCounterAttack(e){const t=d.Z.getSpeaker(this.dialogData.speaker);if(t&&"parry"==this.dialogData.mode){if(t.items.get(e.currentTarget.dataset.id).name==game.i18n.localize("LocalizedIDs.counterAttack")){this.dialogData.counterAttack=0==e.button,this.prepareWeapon();const a=0==e.button?"attack":"parry",s=t.items.get(this.dialogData.source._id);let n=g.Z.getRollModifiers(t,s,{mode:a});i.Z.getSubClass(s.type).getSituationalModifiers(n,t,{mode:a},s),"attack"==a&&(n=n.filter((e=>"defenseMalus"!=e.type)));const r=$(this._element).find("[name=situationalModifiers]");if(n.length>0){if(0==r.length){const e=`<div class="modifiers form-group custom-select">\n                                            <label>${game.i18n.localize("DIALOG.SituationalModifiers")}</label>\n                                            <select name="situationalModifiers" multiple data-tooltip="${game.i18n.localize("DIALOG.deselectWithStrg")}" />\n                                        </div>`;$(this._element).find("[name=rollMode]").parent().after(e),this.position.height+=86,this.setPosition(this.position)}let e="";for(const t of n)e+=`<option value="${t.value}"\n                                        data-tooltip="${Handlebars.helpers.situationalTooltip(t)}"\n                                        ${t.type?" data-type="+t.type:""}\n                                        ${t.specAbId?" data-specAbId="+t.specAbId:""}\n                                        ${t.armorPen?" data-armorPen="+t.armorPen:""}\n                                        ${t.selected?" selected":""}>\n                                    ${t.name} [${t.value}]\n                                </option>`;$(this._element).find(".modifiers select").html(e)}else r.length>0&&(r.parent().remove(),this.position.height-=86,this.setPosition(this.position))}}}changeSpecAbVariant(e){e.stopPropagation(),e.preventDefault();const t=d.Z.getSpeaker(this.dialogData.speaker);if(t){let a=Number(e.currentTarget.dataset.current)+1;a>=Number(e.currentTarget.dataset.variantcount)&&(a=0),e.currentTarget.dataset.current=a,$(e.currentTarget).text(["A","B","C"][a]);const s=$(e.currentTarget).closest(".specAbs")[0],n=t.items.get(s.dataset.id),r=`effect.value${["","2","3"][a]}`,o=("attack"==this.dialogData.mode?i.Z.attackSpecAbs([n],t,r):i.Z.defenseSpecAbs([n],t,r))[0];s.dataset.dmmalus=o.dmmalus||0,s.dataset.atbonus=o.atbonus||0,s.dataset.tpbonus=o.tpbonus||0,s.dataset.pabonus=o.pabonus||0,s.dataset.tooltip=o.label,this.calculateModifier()}}async close(e={}){return clearInterval(this.checkTargets),await super.close(e)}_postItem(e){e.stopPropagation();const t=$(e.currentTarget).closest(".specAbs"),a=t.attr("data-actor"),s=t.attr("data-id");return game.actors.get(a).items.get(s).postItem(),!1}recallSettings(e,t,a,s){return super.recallSettings(e,t,a,s),this.prepareWeapon(),this}prepareWeapon(){let e;const t=this.dialogData.source,a=d.Z.getSpeaker(this.dialogData.speaker);if(a)if(["meleeweapon","rangeweapon"].includes(t.type)){const i=t.system.combatskill.value;let n=s.Z._calculateCombatSkillValues(a.items.find((e=>"combatskill"==e.type&&e.name==i)).toObject(),a.system);switch(t.type){case"meleeweapon":e=s.Z._prepareMeleeWeapon(t,[n],a);break;case"rangeweapon":e=s.Z._prepareRangeWeapon(t,[],[n],a)}"attack"==this.dialogData.mode||this.dialogData.counterAttack?this.dialogData.rollValue=e.attack:"parry"==this.dialogData.mode&&(this.dialogData.rollValue=e.parry)}else"dodge"==t.type?this.dialogData.rollValue=t.system.value:"attack"==this.dialogData.mode||this.dialogData.counterAttack?this.dialogData.rollValue=Number(t.system.at.value):"parry"==this.dialogData.mode&&(this.dialogData.rollValue=Number(t.system.pa))}prepareFormRecall(e){if(super.prepareFormRecall(e),canvas.scene&&game.settings.get("dsa5","sightAutomationEnabled")){const t=canvas.scene?.darkness||0,a=game.settings.get("dsa5","sightOptions").split("|").map((e=>Number(e)));let s=0;for(;a[s]<=t;)s+=1;const i=d.Z.getSpeaker(this.dialogData.speaker);if(i){const e=n.Z.vantageStep(i,game.i18n.localize("LocalizedIDs.darksight")),t=Number(getProperty(i,"system.sightModifier.value"))||0;s<=(Number(getProperty(i,"system.sightModifier.maxLevel"))||3)&&s>0&&(s=e>1?0:Math.clamped(s+t-e,0,4))}const r=e.find(`[name="vision"] option:nth-child(${s+1})`);r.length&&(r[0].selected=!0)}const t=d.Z.getSpeaker(this.dialogData.speaker),a=l.Z.isRiding(t),s=e.find('[name="advantageousPosition"]')[0];if("attack"==this.dialogData.mode){const i=Array.from(game.user.targets).some((e=>l.Z.isRiding(e.actor)));s&&(i||a)&&(s.checked=a&&!i);const n=e.find('[name="mountedOptions"]')[0];if(a&&n){const e=l.Z.getHorse(t);e&&(n.selectedIndex=l.Z.horseSpeedModifier(e))}}else if("parry"==this.dialogData.mode&&t.flags.oppose){const e=d.Z.getSpeaker(t.flags.oppose.speaker),i=l.Z.isRiding(e);s&&(i||a)&&(s.checked=a&&!i)}this.calculateModifier()}static assassinationModifiers(e,t){const a=t.assassinate;if(!a||"-"==a)return[];e.opposingWeaponSize=0;const s=t.advantageousPosition?2:0,i=r.Z.meleeRangesArray.indexOf(t.weaponsize),n=game.i18n.localize(`DIALOG.${a}`),o=[{name:n,value:10-s-i}];if("assassinate"==a){let t=r.Z.meleeRangesArray.indexOf(e.source.system.reach.value);!c.Z.isYieldedTwohanded(e.source)&&e.source.system.worn.wrongGrip&&(t=Math.min(t,1));const a=Math.max(1,new Roll(e.source.system.damage.value.replace(/[DWw]/g,"d")).terms.reduce(((e,t)=>e+(t.faces?t.number:0)),0))-1,s=[2,0,-2,-4][t]-2*a,i=Math.max(1,5-t-a);o.push({name:n+" ("+game.i18n.localize("CHARAbbrev.damage")+")",damageBonus:s,value:0,step:1},{name:n+" (*)",damageBonus:`*${i}`,value:0,step:1})}else e.source.effects||(e.source.effects=[]),e.source.effects.find((e=>e._id==n))||e.source.effects.push({_id:n,changes:[],disabled:!1,duration:{},icon:"icons/svg/aura.svg",name:n,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:n,custom:!0,auto:null,manual:0,resistRoll:`${game.i18n.localize("LocalizedIDs.selfControl")} -3`,hideOnToken:!1,hidePlayers:!1,customDuration:"",advancedFunction:"1",args0:"unconscious",args1:""}}});return o}async calculateModifier(){if("damage"==this.dialogData.mode)return;const e=this.dialogData.source,t="trait"==e.type&&"meleeAttack"==getProperty(e,"system.traitType.value")||"meleeweapon"==e.type||"dodge"==e.type,a={source:this.dialogData.source,extra:{options:{}}},s=d.Z.getSpeaker(this.dialogData.speaker);t?DSA5CombatDialog.resolveMeleeDialog(a,{},this.element,s,{},-3,this.dialogData.mode):DSA5CombatDialog.resolveRangeDialog(a,{},this.element,s,{},this.dialogData.mode),this.dialogData.modifier=await o.Z._situationalModifiers(a),this.updateRollButton(this.readTargets())}static getNarrowSpaceModifier(e,t){return t?game.i18n.localize("LocalizedIDs.Shields")==getProperty(e,"source.system.combatskill.value")?r.Z.narrowSpaceModifiers["shield"+e.source.system.reach.shieldSize][t]:getProperty(r.Z.narrowSpaceModifiers,`weapon${e.source.system.reach.value}.${t}`)||0:0}static resolveMeleeDialog(e,t,a,s,n,o,l){this._resolveDefault(e,t,a,n);const c=new FormDataExtended(a.find("form")[0]).object;e.opposingWeaponSize=c.weaponsize,e.attackOfOpportunity=this.attackOfOpportunity(e.situationalModifiers,c),e.situationalModifiers.push(i.Z.parseValueType(game.i18n.localize("sight"),c.vision||0),{name:game.i18n.localize("attackFromBehind"),value:Number(c.attackFromBehind)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:c.damageModifier,value:0,step:1},{name:game.i18n.format("defenseCount",{malus:o}),value:(Number(c.defenseCount)||0)*o},{name:game.i18n.localize("wrongHand"),value:Number(c.wrongHand)||0},{name:game.i18n.localize("advantageousPosition"),value:Number(c.advantageousPosition)||0},{name:game.i18n.localize("sizeCategory"),value:r.Z.meleeSizeModifier[c.size]||0},...i.Z.getSpecAbModifiers(a,l),...this.assassinationModifiers(e,c),{name:game.i18n.localize("narrowSpace"),value:Number(c.narrowSpace)||0},{name:game.i18n.localize("doubleAttack"),value:Number(c.doubleAttack)||0}),e.situationalModifiers.some((e=>e.name==game.i18n.localize("LocalizedIDs.counterAttack")))&&(e.mode="attack",e.extra.counterAttack=!0)}static resolveRangeDialog(e,t,a,s,n){this._resolveDefault(e,t,a,n);const o=new FormDataExtended(a.find("form")[0]).object,l=Number(o.quickChange)||0,c=r.Z.rangeSizeModifier[o.size]||0,d=r.Z.rangeMods[o.distance||"medium"].attack;e.situationalModifiers.push({name:game.i18n.localize("target")+" "+a.find('[name="targetMovement"] option:selected').text(),value:Number(o.targetMovement)||0},{name:game.i18n.localize("shooter")+" "+a.find('[name="shooterMovement"] option:selected').text(),value:Number(o.shooterMovement)||0},{name:game.i18n.localize("mount")+" "+a.find('[name="mountedOptions"] option:selected').text(),value:Number(o.mountedOptions)||0},{name:game.i18n.localize("rangeMovementOptions.QUICKCHANGE"),value:l},{name:game.i18n.localize("MODS.combatTurmoil"),value:Number(o.combatTurmoil)||0},{name:game.i18n.localize("aim"),value:Number(o.aim)||0},{name:game.i18n.localize("MODS.damage"),damageBonus:o.damageModifier,value:0,step:1},{name:game.i18n.localize("sight"),value:Number(o.vision)||0},{name:game.i18n.localize("sizeCategory"),value:c},{name:game.i18n.localize("distance"),value:d,damageBonus:r.Z.rangeMods[o.distance||"medium"].damage},...i.Z.getSpecAbModifiers(a,"attack"));const m=s.items.find((e=>"specialability"==e.type&&e.name==game.i18n.localize("LocalizedIDs.sharpshooter")));if(m){const t=getProperty(e.source,"system.combatskill.value")?.toLowerCase();if(t&&m.system.list.value.split(/;|,/).map((e=>e.trim().toLowerCase())).includes(t)){const t=[o.targetMovement,o.shooterMovement,o.mountedOptions,l,c,d],a=Math.abs(t.reduce(((e,t)=>(Number(t)<0&&(e+=Number(t)),e)),0)),s=Math.min(2*Number(m.system.step.value),a);s&&e.situationalModifiers.push({name:game.i18n.localize("LocalizedIDs.sharpshooter"),value:s})}}}static _resolveDefault(e,t,a,i){t.rollMode=a.find('[name="rollMode"]').val(),e.situationalModifiers=s.Z._parseModifiers(a),mergeObject(e.extra.options,i)}static attackOfOpportunity(e,t){let a=Number(t.opportunityAttack)||0;if(a){e.push({name:game.i18n.localize("opportunityAttack"),value:a});const t=game.i18n.localize("LocalizedIDs.enemySense");game.user.targets.forEach((s=>{s.actor?.items.find((e=>"specialability"==e.type&&e.name==t))&&e.push({name:t,value:a})}))}return 0!=a}static getRollButtons(e,t,a,i){let n=m.Z.getRollButtons(e,t,a,i);if("rangeweapon"==e.source.type||"trait"==e.source.type&&"rangeAttack"==e.source.system.traitType.value){const t="trait"==e.source.type?Number(e.source.system.reloadTime.value):s.Z.calcLZ(e.source,e.extra.actor),a=e.source.system.reloadTime.progress;a<t&&mergeObject(n,{reloadButton:{label:`${game.i18n.localize("WEAPON.reload")} (${a}/${t})`,callback:async()=>{const s=await d.Z.getSpeaker(e.extra.speaker);await s.updateEmbeddedDocuments("Item",[{_id:e.source._id,"system.reloadTime.progress":a+1}]);const i=game.i18n.format("WEAPON.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${a+1}/${t}`});await ChatMessage.create(d.Z.chatDataSetup(i))}}})}return n}}},538:(e,t,a)=>{a.d(t,{Z:()=>DSA5Dialog});var s=a(70),i=a(5),n=a(491),r=a(577),o=a(369),l=a(562);class DSA5SkillDialog extends i.Z{static getRollButtons(e,t,a,s){let i=DSA5Dialog.getRollButtons(e,t,a,s);i.rollButton.label=game.i18n.localize("Opposed");const n={nonOpposedButton:{label:game.i18n.localize("Roll"),callback:s=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,s),e.opposable=!1,a(t.callback(s))}},routineRoll:{label:game.i18n.localize("ROLL.routine"),callback:s=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,s),e.routine=!0,mergeObject(e.extra.options,{cheat:!0,predefinedResult:[{val:2,index:0},{val:2,index:1},{val:2,index:2}]}),a(t.callback(s))}}};return mergeObject(n,i),n}activateListeners(e){super.activateListeners(e),e.on("change","input,select",(e=>this.rememberFormData(e)));let t=this.readTargets();const a=this;this.checkTargets=setInterval((function(){t=a.compareTargets(e,t)}),500),this.rememberFormData(),e.on("mousedown",".quantity-click",(e=>this.rememberFormData(e))),e.find(".modifiers option").mousedown((e=>{this.rememberFormData(e)}))}rememberFormData(e){const t=new FormDataExtended(this.element.find("form")[0]).object;t.situationalModifiers=o.Z._parseModifiers(this._element),this.calculateRoutine(t)}async calculateRoutine(e){const t=n.Z.getSpeaker(this.dialogData.speaker),a=this.element.find(".routineRoll");if(!t)return a.prop("disabled",!0);const s=!0;for(let a=0;a<3;a++)if(t.system.characteristics[e[`characteristics${a}`]].max*e[`ch${a}`].max<13){s=!1;break}const i=this.dialogData.source.system.talentValue.value+e.fw+await l.Z._situationalModifiers(e,"FW"),o=r.Z.skillDifficultyModifiers[e.testDifficulty]+await l.Z._situationalModifiers(e),c=Math.clamped(10-3*o,1,19),d=s&&i>=c,m=game.i18n.localize("ROLL.routine");a.prop("disabled",!d),a.html(d?`${m} (${game.i18n.localize("CHARAbbrev.FW")} ${Math.round(i/2)})`:m)}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}}var c=a(954);class DSA5Dialog extends i.Z{static getDialogForItem(e,t){const a=e.extra.actor,i=e.source.type;switch(i){case"rangeweapon":case"meleeweapon":case"dodge":case"trait":return t.rollModifiers=s.Z.setData(a,i,e),s.Z;case"spell":case"ritual":case"liturgy":case"ceremony":return t.rollModifiers=c.Z.setData(a,i),c.Z;case"skill":return DSA5SkillDialog}return DSA5Dialog}static getRollButtons(e,t,a,s){let i={rollButton:{label:game.i18n.localize("Roll"),callback:s=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,s),a(t.callback(s))}}};return game.user.isGM&&mergeObject(i,{cheat:{label:game.i18n.localize("DIALOG.cheat"),callback:s=>{game.dsa5.memory.remember(e.extra.speaker,e.source,e.mode,s),a(t.callback(s,{cheat:!0}))}}}),i}activateListeners(e){super.activateListeners(e),e.find(".dieButton").click((e=>{let t=$(e.currentTarget);"true"==t.attr("data-single")&&t.closest(".dialog-content").find(".dieButton").removeClass("dieSelected"),t.toggleClass("dieSelected")}))}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}}},266:(e,t,a)=>{a.d(t,{Z:()=>EquipmentDamageDialog});var s=a(702);class EquipmentDamageDialog extends Dialog{static async showDialog(e){const t=new EquipmentDamageDialog({title:game.i18n.localize("WEAR.checkShort"),content:await this.getTemplate(e),buttons:{}});t.items=e,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click((e=>{this.callbackResult(e),this.close()}))}static async getTemplate(e){const t=e.map((e=>({name:e.name,id:e.id,img:e.img})));return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{items:t,title:"WEAR.checkShort"})}callbackResult(e){s.Z.breakingTest(this.items.find((t=>t.id==e.currentTarget.dataset.value)))}}},118:(e,t,a)=>{a.d(t,{$G:()=>ReactToSkillDialog,HS:()=>ActAttackDialog,MN:()=>ReactToAttackDialog,ZP:()=>DialogReactDSA5});var s=a(369),i=a(600),n=a(491);class DialogReactDSA5 extends Dialog{static async showDialog(e){let t=this.callbackResult;new DialogReactDSA5({title:game.i18n.localize("Unopposed"),content:await this.getTemplate(e),default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:a=>{t(a.find('[name="entryselection"]').val(),e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}activateListeners(e){super.activateListeners(e),e.find(".select2").select2()}static getTargetActor(e){if(!canvas.tokens)return{};let t=e.flags.unopposeData.targetSpeaker;const a=n.Z.getSpeaker(t);return a?{actor:a,tokenId:t.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}static async getTemplate(e){return""}static callbackResult(e,t,a){}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{resizable:!0}),e}}class ReactToSkillDialog extends DialogReactDSA5{static async getTemplate(e){const t=game.messages.get(e.flags.unopposeData.attackMessageId).flags.data.preData.source.name;let a=(await n.Z.allSkillsList()).map((e=>({name:e,id:e})));return a.unshift({name:game.i18n.localize("doNothing"),id:"doNothing"}),renderTemplate("systems/dsa5/templates/dialog/dialog-act.html",{items:a,original:t,title:"DIALOG.selectReaction"})}static callbackResult(e,t){const{actor:a,tokenId:s}=DialogReactDSA5.getTargetActor(t);if("doNothing"==e)i.Z.resolveUndefended(t);else{const t=a.items.find((t=>t.name==e&&"skill"==t.type));t&&a.setupSkill(t,{},s).then((e=>{a.basicTest(e)}))}}}class ActAttackDialog extends Dialog{static async showDialog(e,t){const a=new ActAttackDialog({title:game.i18n.localize("attacktest"),content:await this.getTemplate(e),buttons:{}});a.actor=e,a.tokenId=t,a.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click((e=>{this.callbackResult(e.currentTarget.dataset.value,this.actor,this.tokenId),this.close()}))}static async getTemplate(e){const t=e.items.filter((e=>"combatskill"==e.type)).map((t=>s.Z._calculateCombatSkillValues(t.toObject(),e.system))),a=t.find((e=>e.name==game.i18n.localize("LocalizedIDs.wrestle")));let i=[{name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:a.system.attack.value}];const n=["meleeweapon","rangeweapon"],r=["meleeAttack","rangeAttack"];for(let a of e.items)if(n.includes(a.type)&&1==a.system.worn.value){const n="meleeweapon"==a.type?s.Z._prepareMeleeWeapon(a.toObject(),t,e):s.Z._prepareRangeWeapon(a.toObject(),[],t,e);i.push({name:a.name,id:a.name,img:a.img,value:n.attack,item:n})}else"trait"==a.type&&r.includes(a.system.traitType.value)&&i.push({name:a.name,id:a.name,img:a.img,value:a.system.at.value});return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-mu",items:i,title:"DIALOG.selectAction"})}callbackResult(e,t,a){if("attackWeaponless"==e)t.setupWeaponless("attack",{},a).then((e=>{t.basicTest(e)}));else{const s=["meleeweapon","trait","rangeweapon"],i=t.items.find((t=>s.includes(t.type)&&t.name==e));i&&t.setupWeapon(i,"attack",{},a).then((e=>{t.basicTest(e)}))}}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:550}),e}}class ReactToAttackDialog extends DialogReactDSA5{static async showDialog(e){const t=new ReactToAttackDialog({title:game.i18n.localize("Unopposed"),content:await this.getTemplate(e),buttons:{}});t.startMessage=e,t.render(!0)}static getAttackActor(e){if(!canvas.tokens)return{};const t=e.flags.unopposeData.attackMessageId,a=game.messages.get(t).flags.data.preData.extra.speaker,s=n.Z.getSpeaker(a);return s?{actor:s,tokenId:a.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}activateListeners(e){super.activateListeners(e),e.find(".reactClick").click((e=>{this.callbackResult(e.currentTarget.dataset.value,this.startMessage),this.close()}))}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:550}),e}static async getTemplate(e){const{actor:t,tokenId:a}=DialogReactDSA5.getTargetActor(e),i=ReactToAttackDialog.getAttackActor(e),n=t.items.filter((e=>"combatskill"==e.type)).map((e=>s.Z._calculateCombatSkillValues(e.toObject(),t.system))),r=n.find((e=>e.name==game.i18n.localize("LocalizedIDs.wrestle")));let o=[{name:game.i18n.localize("doNothing"),id:"doNothing",img:"systems/dsa5/icons/categories/disease.webp"},{name:game.i18n.localize("dodge"),id:"dodge",img:"systems/dsa5/icons/categories/Dodge.webp",value:t.system.status.dodge.max},{name:game.i18n.localize("parryWeaponless"),id:"parryWeaponless",img:"systems/dsa5/icons/categories/attack_weaponless.webp",value:r.system.parry.value}],l=0,c="";if(t){let e=["meleeweapon"];for(let a of t.items)if(e.includes(a.type)&&1==a.system.worn.value){const e=s.Z._prepareMeleeWeapon(a.toObject(),n,t);o.push({name:a.name,id:a.name,img:a.img,value:e.parry})}else"trait"==a.type&&Number(a.system.pa)>0&&o.push({name:a.name,id:a.name,img:a.img,value:a.system.pa});if(i){const e=getProperty(i.actor.system,"status.size.value");"big"==e?c="DIALOGDESCRIPTION.bigEnemy":"giant"==e&&(c="DIALOGDESCRIPTION.giantEnemy")}game.combat&&(l=await game.combat.getDefenseCount({actor:t.id,token:a,scene:canvas.scene?canvas.scene.id:null}))}return await renderTemplate("systems/dsa5/templates/dialog/dialog-reaction-attack.html",{dieClass:"die-in",items:o,defenses:l,title:"DIALOG.selectReaction",sizeNotification:c})}callbackResult(e,t){const{actor:a,tokenId:s}=DialogReactDSA5.getTargetActor(t);if("doNothing"==e)i.Z.resolveUndefended(t);else if("dodge"==e)a.setupDodge({},s).then((e=>{a.basicTest(e)}));else if("parryWeaponless"==e)a.setupWeaponless("parry",{},s).then((e=>{a.basicTest(e)}));else{const t=["meleeweapon","trait"],i=a.items.find((a=>t.includes(a.type)&&a.name==e));i&&a.setupWeapon(i,"parry",{},s).then((e=>{a.basicTest(e)}))}}}},5:(e,t,a)=>{a.d(t,{Z:()=>DialogShared});var s=a(122),i=a(416);class DialogShared extends Dialog{static roman=[""," I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"];recallSettings(e,t,a,s){return this.recallData=game.dsa5.memory.recall(e,t,a),this.dialogData={mode:a,speaker:e,source:t,renderData:s},this}async _render(e,t){await super._render(e,t),this.prepareFormRecall($(this._element))}setRollButtonWarning(){if("attack"==this.dialogData.mode){return`<span class="missingTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("DIALOG.noTarget")}</span>`}return""}setMultipleTargetsWarning(){if("attack"==this.dialogData.mode){return`<span class="multipleTarget"><i class="fas fa-exclamation-circle"></i> ${game.i18n.localize("DIALOG.multipleTarget")}</span>`}return""}renderRollValueDie(){if(this.dialogData.rollValue&&"damage"!=this.dialogData.mode){const e="attack"==this.dialogData.mode||this.dialogData.counterAttack?"die-mu":"die-in",t=this.dialogData.modifier||0;return`<span class="rollValue ${e} d20">${Math.clamped(this.dialogData.rollValue+t,1,20)}</span>`}return""}async updateRollButton(e){let t=this.renderRollValueDie()+game.i18n.localize("Roll");e.length>0?e.length>1&&(t+=this.setMultipleTargetsWarning()):t+=this.setRollButtonWarning(),$(this._element).find(".dialog-buttons .rollButton").html(t)}async updateTargets(e,t){const a=await renderTemplate("systems/dsa5/templates/dialog/parts/targets.html",{targets:t});e.find(".targets").html(a),this.updateRollButton(t)}removeTarget(e){const t=e.currentTarget.dataset.id;$(e.currentTarget).remove();const a=[];game.user.targets.forEach((e=>{t!=e.id&&a.push(e.id)})),game.user.updateTokenTargets(a)}readTargets(){let e=[];return game.user.targets.forEach((t=>{t.actor&&e.push({name:t.actor.name,img:t.actor.img,id:t.id})})),e}compareTargets(e,t){let a=this.readTargets();return JSON.stringify(t)!=JSON.stringify(a)&&(t=a,this.updateTargets(e,t)),t}activateListeners(e){super.activateListeners(e),e.find(".quantity-click").mousedown((e=>s.Z.quantityClick(e))),e.find(".modifiers option").mousedown((e=>(e.preventDefault(),$(e.currentTarget).prop("selected",!$(e.currentTarget).prop("selected")),!1))),e.on("click",".rollTarget",(e=>this.removeTarget(e))),e.on("click",".addTarget",(e=>this.addTarget(e)))}async addTarget(e){(await i.xb.getDialog(this.dialogData.speaker)).render(!0)}prepareFormRecall(e){if(this.recallData)for(const t in this.recallData)if("specAbs"==t)for(const a of this.recallData[t]){const t=e.find(`.specAbs[data-id="${a.id}"]`);t.addClass("active").attr("data-step",a.step),t.find(".step").text(DialogShared.roman[a.step])}else{const a=e.find(`[name="${t}"]`);if(Array.isArray(this.recallData[t])){const e=a.find("option");for(let a of e){let e=this.recallData[t].find((e=>e.name==$(a).text().trim()));e&&(a.selected=e.selected)}}else"checkbox"==a.attr("type")?a[0].checked=this.recallData[t]:a.val(this.recallData[t])}}}},954:(e,t,a)=>{a.d(t,{Z:()=>DSA5SpellDialog});var s=a(122),i=a(491),n=a(538),r=a(5);class DSA5SpellDialog extends r.Z{static rollChanges=["defenseMalus"];static rollModifiers={forceSpell:{mod:1},reduceCostSpell:{mod:-1},increaseRangeSpell:{mod:-1},increaseCastingTime:{mod:1},decreaseCastingTime:{mod:-1},removeGesture:{mod:-2},removeFormula:{mod:-2},extensionModifier:{mod:0}};static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:700,resizable:!0}),e}static bigTimes=[5,30,120,480,960,1920];prepareFormRecall(e){super.prepareFormRecall(e),e.find(".spellModifier").trigger("change")}static getRollButtons(e,t,a,s){let r=n.Z.getRollButtons(e,t,a,s);if(["spell","liturgy"].includes(e.source.type)){const t=Number(e.source.system.castingTime.value),a=e.source.system.castingTime.progress;let s=e.source.system.castingTime.modified;if(t&&"emptyActor"!=e.extra.speaker.token){const t=s>0?` (${a}/${s})`:"";mergeObject(r,{reloadButton:{label:`${game.i18n.localize("SPELL.reload")}${t}`,callback:async t=>{const n=await i.Z.getSpeaker(e.extra.speaker);let r={_id:e.source._id,"system.castingTime.progress":a+1};0==s&&(s=Number(t.find(".castingTime").text())-1,r["system.castingTime.modified"]=s),await n.updateEmbeddedDocuments("Item",[r]);const o=game.i18n.format("SPELL.isReloading",{actor:e.extra.actor.name,item:e.source.name,status:`${a+1}/${s}`});await ChatMessage.create(i.Z.chatDataSetup(o))}}})}}return r}async applyTransformations(e,t){const a=t.find('[name="situationalModifiers"]');a.find('option[data-extension="1"]').remove();const s=[],n=Object.keys(DSA5SpellDialog.rollModifiers).map((e=>`${e}.mod`));this.dialogData.renderData.rollModifiersPrepared=duplicate(this.dialogData.renderData.rollModifiers);for(let a of t.find(".specAbs.active")){const t=fromUuidSync(a.dataset.uuid);if(t)for(let a of t.effects)for(let r of a.changes)if(DSA5SpellDialog.rollChanges.includes(r.key)){let e=t.name.split(" - ");const a=game.i18n.localize(`MODS.${r.key}`);e=`${e[1]||e[0]}`;const i=`${a}: ${r.value}<br/>${game.i18n.localize("spellextension")}: ${e}`;s.push(`<option data-extension="1" selected="" data-tooltip="${i}" data-type="${r.key}" value="${r.value}">${e} - ${a}</option>`)}else"macro.transform"==r.key?await i.Z.callItemTransformationMacro(r.value,e,a):n.includes(r.key)?a.apply(this.dialogData.renderData.rollModifiersPrepared,r):a.apply(e,r)}const r=this.dialogData.renderData.rollModifiersPrepared.extensionModifier.mod;if(r){const e=game.i18n.localize("ABBR.modifiers"),t=game.i18n.localize("spellextension"),a=`${e}: ${r}<br/>${t}`;s.push(`<option data-extension="1" selected="" data-tooltip="${a}" data-type="" value="${r}">${t} - ${e}</option>`)}a.append(s.join(""))}static setData(e,t){const a=duplicate(DSA5SpellDialog.rollModifiers),s=`${t}RollModifiers`;if(e.system[s])for(let t of Object.keys(e.system[s]))a[t].mod+=Number(e.system[s][t]?.mod??0);return a}async recalcSpellModifiers(e,t){const a=e,i=duplicate(this.dialogData.source);s.Z.ensureNumber(i);let n=a.find(".castingTime"),r=a.find(".aspcost"),o=a.find(".reach"),l=a.find(".maintainCost"),c=a.find(".ritual").length>0;await this.applyTransformations(i,a);let d=a.find(".maxMods");if(a.find(".spellModifier:checked").length>Number(d.text()))return t&&(t.currentTarget.checked=!1),d.addClass("emphasize"),void setTimeout((function(){d.removeClass("emphasize")}),600);for(let t of Object.keys(this.dialogData.renderData.rollModifiersPrepared)){const a=this.dialogData.renderData.rollModifiersPrepared[t].mod;e.find(`.${t}Label`).text(`(${a})`),e.find(`#${t}`).val(a)}const m=e.find(".canChangeCastingTime");"true"==i.system.canChangeCastingTime.value?m.is(":empty")&&(m.html(await renderTemplate("systems/dsa5/templates/dialog/parts/canChangeCastingTime.html",{rollModifiers:this.dialogData.renderData.rollModifiers})),this.setPosition({height:"auto"})):m.is(":empty")||(m.html(""),this.setPosition({height:"auto"}));let u=i.system.AsPCost.value,g=i.system.range.value,p=i.system.castingTime.value,h=u,f=i.system.maintainCost.value;a.find(".variableBaseCost")["true"==i.system.variableBaseCost?"show":"hide"]();let y=0;a.find(".spellModifier[data-cost]:checked").each((function(e,t){if(h*=t.value<0?.5:2,""!=f&&null!=f){let e=String(f).split(" ");e[0]=Math.max(Number(e[0])*(t.value<0?.5:2)),f=e.join(" ")}y+=Number(t.value)})),h<1?t&&(t.currentTarget.checked=!1):(r.text(h),l.text(f),r.attr("data-mod",y)),y=0,h=p,a.find(".spellModifier[data-castingTime]:checked").each((function(e,t){if(c){let e=DSA5SpellDialog.bigTimes.indexOf(Number(h));if(null!=e){let a=e+(t.value>0?1:-1);a<DSA5SpellDialog.bigTimes.length&&a>=0?h=DSA5SpellDialog.bigTimes[a]:ui.notifications.error(game.i18n.localize("DSAError.CastingTimeLimit"))}else ui.notifications.error(game.i18n.localize("DSAError.TimeCannotBeParsed"))}else h*=t.value>0?2:.5;y+=Number(t.value)})),h<1?t&&(t.currentTarget.checked=!1):(n.text(h),n.attr("data-mod",y)),y=0;let b=game.i18n.localize("ReverseSpellRanges."+g);o.text(g),a.find(".spellModifier[data-reach]:checked").each((function(e,a){if("self"==b)a.checked=!1;else if("touch"==b)o.text("4 "+game.i18n.localize("step")),y+=Number(a.value);else{let e=g.split(" ");b=Number(e[0]),isNaN(b)?(t&&(t.currentTarget.checked=!1),ui.notifications.error(game.i18n.localize("DSAError.RangeCannotBeParsed"))):(o.text(2*b+" "+game.i18n.localize("step")),y+=Number(a.value))}})),o.attr("data-mod",y),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2)}activateListeners(e){super.activateListeners(e),e.find(".reloadButton").prop("disabled",Number(e.find(".castingTime").text())<2),e.find(".specAbs").mousedown((t=>{$(t.currentTarget).toggleClass("active"),this.recalcSpellModifiers(e)})),e.find(".variableBaseCost").change((e=>{let t=$(e.currentTarget).parents(".skill-test"),a=t.find(".aspcost").attr("data-base"),s=$(e.currentTarget).val();t.find(".aspcost").attr("data-base",s),t.find(".aspcost").text(Number(t.find(".aspcost").text())*s/a)})),e.on("change",".spellModifier",(t=>this.recalcSpellModifiers(e,t)));let t=this.readTargets();0==t.length&&this.setRollButtonWarning();const a=this;this.checkTargets=setInterval((function(){t=a.compareTargets(e,t)}),500)}}},492:(e,t,a)=>{a.d(t,{Z:()=>Select2Dialog});class Select2Dialog extends Dialog{activateListeners(e){super.activateListeners(e),e.find(".select2").select2()}}},147:(e,t,a)=>{a.d(t,{Y:()=>initImagePopoutTochat,d:()=>showPopout});var s=a(491);function initImagePopoutTochat(){Hooks.on("getImagePopoutHeaderButtons",((e,t)=>{t.unshift({class:"posttochat",icon:"fas fa-comment",onclick:async()=>async function postImage(e){const t=e.object,a=await renderTemplate("systems/dsa5/templates/chat/imagetochat.html",{image:t});ChatMessage.create(s.Z.chatDataSetup(a))}(e)})}))}function showPopout(e){const t=e.currentTarget.dataset;s.Z.showArtwork(t,!1)}},846:(e,t,a)=>{a.d(t,{q:()=>conditionsMatcher,v:()=>setEnrichers});var s=a(577);function setEnrichers(){const e={Rq:"roll",Gc:"GC",Ch:"CH"},t={Rq:"dice",Gc:"dice",Ch:"user-shield"},a={Rq:"",Gc:`${game.i18n.localize("HELP.groupcheck")} `,Ch:""},i=/(-|\+)?\d+/,n=/\[[a-zA-zöüäÖÜÄ&; -]+/,r=/[\[\]]/g;if(!s.Z.statusRegex){let e=s.Z.statusEffects.map((e=>game.i18n.localize(e.name).toLowerCase())),t=["status","condition","level","levels"].map((e=>game.i18n.localize(e))).join("|");s.Z.statusRegex={effects:e,regex:new RegExp(`(${t}) (${e.join("|")})`,"gi")}}CONFIG.TextEditor.enrichers.push({pattern:/@(Rq|Gc|Ch)\[[a-zA-zöüäÖÜÄ&; -]+ (-|\+)?\d+\]/g,enricher:(s,o)=>{const l=s[0],c=s[1],d=Number(l.match(i)[0]),m=l.replace(d,"").match(n)[0].replace(r,"").trim();return $(`<a class="roll-button request-${e[c]}" data-type="skill" data-modifier="${d}" data-name="${m}"><em class="fas fa-${t[c]}"></em>${a[c]}${m} ${d}</a>`)[0]}},{pattern:s.Z.statusRegex.regex,enricher:(e,t)=>$(conditionsMatcher(e))[0]},{pattern:/@Info\[[a-zA-zöüäÖÜÄ&; -\.0-9]+\]/g,enricher:async(e,t)=>{let a=e[0].match(/(?:\[)(.*?)(?=\])/)[0].slice(1);const s=await fromUuid(a);if(!s||"information"!=s.type)return $('<a class="content-link broken"><i class="fas fa-unlink"></i>info</a>')[0];if(!game.user.isGM)return $(`<a class="content-link"><i class="fas fa-mask"></i>${game.i18n.localize("GM notes")}</a>`)[0];const i={enrichedqs1:await TextEditor.enrichHTML(s.system.qs1,{async:!0}),enrichedqs2:await TextEditor.enrichHTML(s.system.qs2,{async:!0}),enrichedqs3:await TextEditor.enrichHTML(s.system.qs3,{async:!0}),enrichedqs4:await TextEditor.enrichHTML(s.system.qs4,{async:!0}),enrichedqs5:await TextEditor.enrichHTML(s.system.qs5,{async:!0}),enrichedqs6:await TextEditor.enrichHTML(s.system.qs6,{async:!0})},n=await renderTemplate("systems/dsa5/templates/items/infopreview.html",{item:s,enriched:i});return $(n)[0]}},{pattern:/@PostChat\[(.*?)\]/g,enricher:async(e,t)=>{const a=e[1];return $(`<div class="row-section wrap maskfield postChatSection"><div class="col ninety"></div><div class="col ten center postContentChat" data-tooltip="SHEET.PostItem"><em class="far fa-comment-dots"></em></div><div class="col postChatContent">${a}</div></div>`)[0]}})}function conditionsMatcher(e){let t=e[0].split(" ");const a=t.shift();t=t.join(" ");const i=s.Z.statusEffects[s.Z.statusRegex.effects.indexOf(t.toLowerCase())];return`<span>${a} <a class="chatButton chat-condition" data-id="${i.id}"><img src="${i.icon}"/>${t}</a></span>`}},839:(e,t,a)=>{a.d(t,{Z:()=>Itemdsa5});var s=a(491),i=a(562),n=a(369),r=a(973),o=a(272),l=a(577),c=a(794),d=a(61),m=a(122),u=a(472),g=a(565),p=a(70),h=a(173),f=a(954),y=a(169);class Itemdsa5 extends Item{static defaultImages={advantage:"systems/dsa5/icons/categories/Vorteil.webp",disadvantage:"systems/dsa5/icons/categories/Nachteil.webp",armor:"systems/dsa5/icons/categories/Armor.webp",meleeweapon:"systems/dsa5/icons/categories/Meleeweapon.webp",rangeweapon:"systems/dsa5/icons/categories/Rangeweapon.webp",equipment:"systems/dsa5/icons/categories/Equipment.webp",consumable:"systems/dsa5/icons/categories/consumable.webp",liturgy:"systems/dsa5/icons/categories/Liturgy.webp",spell:"systems/dsa5/icons/categories/Spell.webp",ammunition:"systems/dsa5/icons/categories/Munition.webp",career:"systems/dsa5/icons/categories/Career.webp",magictrick:"systems/dsa5/icons/categories/Spelltrick.webp",blessing:"systems/dsa5/icons/categories/Blessing.webp",combatskill:"systems/dsa5/icons/categories/Combat_Skill.webp",skill:"systems/dsa5/icons/categories/Skill.webp",Geweihte:"systems/dsa5/icons/categories/Geweihte.webp",Weltliche:"systems/dsa5/icons/categories/Weltliche.webp",Zauberer:"systems/dsa5/icons/categories/Zauberer.webp",ritual:"systems/dsa5/icons/categories/ritual.webp",ceremony:"systems/dsa5/icons/categories/ceremony.webp",abilityclerical:"systems/dsa5/icons/categories/ability_clerical.webp",abilityCombat:"systems/dsa5/icons/categories/ability_combat.webp",abilityfatePoints:"systems/dsa5/icons/categories/ability_fate_points.webp",abilitygeneral:"systems/dsa5/icons/categories/ability_general.webp",specialability:"systems/dsa5/icons/categories/ability_general.webp",abilitymagical:"systems/dsa5/icons/categories/ability_magical.webp",abilitylanguage:"systems/dsa5/icons/categories/Ability_Language.webp",abilitystaff:"systems/dsa5/icons/categories/ability_staff.webp",abilityceremonial:"systems/dsa5/icons/categories/ability_ceremonial.webp",abilityanimal:"systems/dsa5/icons/categories/ability_animal.webp",trait:"systems/dsa5/icons/categories/trait.webp",Tiere:"systems/dsa5/icons/categories/Tiere.webp",aggregatedTest:"systems/dsa5/icons/categories/aggregated_test.webp",poison:"systems/dsa5/icons/categories/poison.webp",disease:"systems/dsa5/icons/categories/disease.webp",spellextension:"systems/dsa5/icons/categories/Spellextension.webp",species:"icons/environment/people/group.webp",application:"systems/dsa5/icons/categories/Skill.webp",trick:"systems/dsa5/icons/categories/Tiere.webp",disadvantageanimal:"systems/dsa5/icons/categories/NachteilAnimal.webp",advantageanimal:"systems/dsa5/icons/categories/VorteilAnimal.webp",diseaseanimal:"systems/dsa5/icons/categories/diseaseAnimal.webp",effectwrapper:"icons/svg/aura.svg",liturgyTalisman:"systems/dsa5/icons/categories/LiturgieTalisman.webp",plant:"systems/dsa5/icons/categories/plant.webp",magicalsign:"systems/dsa5/icons/categories/magicalsign.webp",abilitypact:"systems/dsa5/icons/categories/ability_pact.webp",demonmark:"systems/dsa5/icons/categories/ability_pact.webp",patron:"systems/dsa5/icons/categories/ability_pact.webp",information:"systems/dsa5/icons/categories/DSA-Auge.webp"};static defaultIcon(e){e.img&&""!=e.img||(e.type in this.defaultImages?e.img=this.defaultImages[e.type]:e.img="systems/dsa5/icons/blank.webp")}static async create(e,t){return this.defaultIcon(e),await super.create(e,t)}static getSpecAbModifiers(e,t){let a=[];for(let s of e.find(".specAbs")){let e=Number($(s).attr("data-step"));if(e>0){const i="attack"==t?$(s).attr("data-atbonus"):$(s).attr("data-pabonus"),n=i.split(",").reduce(((e,t)=>e+Number(t)),0);a.push({name:$(s).find("a").text(),value:isNaN(n)?Number(i.replace("*","")):Number(n)*e,damageBonus:$(s).attr("data-tpbonus"),dmmalus:$(s).attr("data-dmmalus")*e,step:e,specAbId:$(s).attr("data-id"),type:/^\*/.test(i)?"*":void 0})}}return a}static setupSubClasses(){game.dsa5.config.ItemSubclasses={ritual:RitualItemDSA5,spell:SpellItemDSA5,liturgy:LiturgyItemDSA5,ceremony:CeremonyItemDSA5,advantage:VantageItemDSA5,disadvantage:VantageItemDSA5,aggregatedTest:aggregatedTestItemDSA5,trait:TraitItemDSA5,blessing:BlessingItemDSA5,magictrick:CantripItemDSA5,specialability:SpecialAbilityItemDSA5,disease:DiseaseItemDSA5,poison:PoisonItemDSA5,armor:ArmorItemDSA5,rangeweapon:RangeweaponItemDSA5,meleeweapon:MeleeweaponDSA5,ammunition:AmmunitionItemDSA5,equipment:EquipmentItemDSA5,combatskill:CombatskillDSA5,skill:SkillItemDSA5,consumable:ConsumableItemDSA,spellextension:SpellextensionItemDSA5,species:SpeciesItemDSA5,effectwrapper:EffectWrapperItemDSA5,plant:PlantItemDSA5,magicalsign:MagicalSignItemDSA5,patron:PatronItemDSA5,demonmark:DemonmarkItemDSA5,information:InformationItemDSA5}}static buildSpeaker(e,t){return{token:t,actor:e?.id,scene:canvas.scene?.id}}static parseValueType(e,t){let a="";return/^\*/.test(t)&&(a="*",t=t.substring(1).replace(",",".")),{name:e,value:Number(t),type:a}}async addCondition(e,t=1,a=!1,s=!0){return await r.Z.addCondition(this,e,t,a,s)}async removeCondition(e,t=1,a=!0,s=!1){return r.Z.removeCondition(this,e,t,a,s)}hasCondition(e){return r.Z.hasCondition(this,e)}static getMiracleModifiers(e,t,a,s){const i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),n=[];if((getProperty(e,"system.happyTalents.value")||"").split(/;|,/).map((e=>e.replace(i,"").trim())).includes(t.name)){const t=e.system.status.karmaenergy.value,i=getProperty(e,`system.miracle.${s}`)||0;if(t<4)return[];n.push({name:game.i18n.localize("LocalizedIDs.miracle"),value:2+i,type:a,selected:!1});const r=game.i18n.localize("LocalizedIDs.miracleMight");t>=6&&h.Z.hasAbility(e,r)&&n.push({name:r,value:3+i,type:a,selected:!1})}return n}static getSkZkModifier(e,t){let a=[],s=[];const i=["spell","liturgy","ceremony","ritual"].includes(t.type)&&""==t.system.effectFormula.value.trim();game.user.targets.size&&game.user.targets.forEach((e=>{if(e.actor){let n=0;if(i){n=u.Z.detectCreatureType(e.actor).reduce(((t,a)=>t+a.spellResistanceModifier(e.actor)),0)}const r=getProperty(e.actor,`system.status.soulpower.${t.type}resist`)||0,o=getProperty(e.actor,`system.status.toughness.${t.type}resist`)||0;a.push(-1*(e.actor.system.status.soulpower.max+r)-n),s.push(-1*(e.actor.system.status.toughness.max+o)-n)}})),mergeObject(e,{SKModifier:a.length>0?Math.min(...a):0,ZKModifier:s.length>0?Math.min(...s):0})}static parseEffect(e,t){let a={},s=new RegExp(game.i18n.localize("CHARAbbrev.GS"),"gi");for(let i of e.split(/,|;/).map((e=>e.trim()))){let e=i.replace(/(\s+)/g," ").trim().split(" ");e[0]=e[0].replace(s,t.system.status.speed.max),2==e.length&&(!isNaN(e[0])||/(=)?[+-]\d([+-]\d)?/.test(e[0])||/(=)?\d[dDwW]\d/.test(e[0])||/=\d+/.test(e[0])||/\*\d(\.\d)*/.test(e[0]))&&(null==a[e[1].toLowerCase()]?a[e[1].toLowerCase()]=[e[0]]:a[e[1].toLowerCase()].push(e[0]))}return a}static getDefenseMalus(e,t){let a=!1;if(t.flags.oppose){let s=game.messages.get(t.flags.oppose.messageId);const i=s.flags.data.preData;a=!("meleeweapon"==getProperty(i,"source.type")||"meleeAttack"==getProperty(i,"source.system.traitType.value"));const n=/ \[(-)?\d{1,}\]/;for(let t of i.situationalModifiers)null!=t.dmmalus&&0!=t.dmmalus?e.push({name:`${game.i18n.localize("MODS.defenseMalus")} - ${t.name.replace(n,"")}`,value:t.dmmalus,selected:!0}):"defenseMalus"==t.type&&0!=t.value&&e.push({name:t.name.replace(n,""),value:t.value,selected:!0});s.flags.data.postData.halfDefense&&e.push({name:`${game.i18n.localize("MODS.defenseMalus")} - ${game.i18n.localize("halfDefenseShort")}`,value:.5,type:"*",selected:!0})}return a}static changeChars(e,t,a,s){e.system.characteristic1.value=t,e.system.characteristic2.value=a,e.system.characteristic3.value=s}static attackSpecAbs(e,t,a="effect.value"){const s=game.i18n.localize("LocalizedAbilityModifiers.at"),i=game.i18n.localize("LocalizedAbilityModifiers.tp"),n=game.i18n.localize("LocalizedAbilityModifiers.dm"),r=[];for(let o of e){const e=Itemdsa5.parseEffect(getProperty(o.system,a),t),c=e[s]||0,d=e[i]||0,m=e[n]||0,u=["","2","3"].map((e=>getProperty(o,`system.effect.value${e}`))).filter((e=>e)).length;if(0!=c||0!=d||0!=m||o.effects.size>0){const e=game.i18n.localize(l.Z.combatSkillSubCategories[o.system.category.sub]);r.push({name:o.name,atbonus:c,tpbonus:d,dmmalus:m,label:`${s.toUpperCase()}: ${c}, ${i.toUpperCase()}: ${d}, ${n.toUpperCase()}: ${m}`,steps:o.system.step.value,category:{id:o.system.category.sub,css:`ab_${o.system.category.sub}`,name:e},id:o.id,actor:t.id,variantCount:u})}}return r}static defenseSpecAbs(e,t,a="effect.value"){const s=[],i=game.i18n.localize("LocalizedAbilityModifiers.pa");for(let n of e){const e=Itemdsa5.parseEffect(getProperty(n.system,a),t)[i]||0;if(0!=e){const a=game.i18n.localize(l.Z.combatSkillSubCategories[n.system.category.sub]),r=["","2","3"].map((e=>getProperty(n,`system.effect.value${e}`))).filter((e=>e)).length;s.push({name:n.name,pabonus:e,tpbonus:0,dmmalus:0,label:`${i}: ${e}`,steps:n.system.step.value,category:{id:n.system.category.sub,css:`ab_${n.system.category.sub}`,name:a},id:n.id,actor:t.id,variantCount:r})}}return s}static buildCombatSpecAbs(e,t,a,s){let i;a?(a.push(game.i18n.localize("LocalizedIDs.all")),a=a.map((e=>e.toLowerCase())),i=(e,t)=>e.system.list.value.split(/;|,/).map((e=>e.trim().toLowerCase())).filter((e=>t.includes(e.replace(/ \([a-zA-Z äüöÄÖÜ]*\)/,"")))).length>0):i=()=>!0;const n=e.items.filter((e=>"specialability"==e.type&&t.includes(e.system.category.value)&&""!=e.system.effect.value&&i(e,a)));return"attack"==s?this.attackSpecAbs(n,e):this.defenseSpecAbs(n,e)}static getCombatSkillModifier(e,t,a){if("trait"==t.type)return;const s=e.items.find((e=>"combatskill"==e.type&&e.name==t.system.combatskill.value));for(let e of s.effects)for(let t of e.changes)switch(t.key){case"system.rangeStats.defenseMalus":case"system.meleeStats.defenseMalus":a.push({name:`${s.name} - ${game.i18n.localize("MODS.defenseMalus")}`,value:-1*t.value,type:"defenseMalus",selected:!0})}}static attackStatEffect(e,t){0!=t&&(t=isNaN(t)?t:Number(t),e.push({name:game.i18n.localize("statuseffects"),value:t,selected:!0}))}static getTargetSizeAndModifier(e,t,a){let s="average";return game.user.targets.forEach((i=>{if(i.actor){const n=getProperty(i.actor,"system.status.size.value");n&&(s=n),u.Z.addCreatureTypeModifiers(i.actor,t,a,e)}})),s}static prepareRangeAttack(e,t,a,s,i,n,r){e.push(...o.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.restrictedSenseSight"),-2)),this.getCombatSkillModifier(t,s,e);const c=this.getTargetSizeAndModifier(t,s,e),d=-1*Number(t.system.rangeStats.defenseMalus);0!=d&&e.push({name:`${game.i18n.localize("statuseffects")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:d,type:"defenseMalus",selected:!0});const m={...l.Z.rangeWeaponModifiers};delete m[o.Z.hasVantage(t,game.i18n.localize("LocalizedIDs.senseOfRange"))?"long":"rangesense"],h.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.extremeShot"))||delete m.extreme;const u=h.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.drivingArcher"));let p;p=h.Z.hasAbility(t,game.i18n.localize("LocalizedIDs.mountedArcher"))&&y.Z.isRiding(t)?duplicate(l.Z.mountedRangeOptionsSpecAb):u?duplicate(l.Z.drivingArcherOptions):duplicate(l.Z.mountedRangeOptions),mergeObject(a,{rangeOptions:m,rangeDistance:Object.keys(m)[g.Z.distanceModifier(game.canvas.tokens.get(i),s,r)],sizeOptions:l.Z.rangeSizeCategories,visionOptions:l.Z.rangeVision,mountedOptions:p,shooterMovementOptions:l.Z.shooterMovementOptions,targetMovementOptions:l.Z.targetMomevementOptions,targetSize:c,combatSpecAbs:n,aimOptions:l.Z.aimOptions})}static prepareMeleeAttack(e,t,a,s,i,n){let r="short";game.user.targets.forEach((e=>{if(e.actor)for(let t of e.actor.items)if(("meleeweapon"==t.type&&t.system.worn.value||"trait"==t.type&&"meleeAttack"==t.system.traitType.value&&t.system.pa)&&(l.Z.meleeRangesArray.indexOf(t.system.reach.value)>l.Z.meleeRangesArray.indexOf(r)&&(r=t.system.reach.value),"long"==r))break}));const o=this.getTargetSizeAndModifier(t,s,e);this.getCombatSkillModifier(t,s,e);const c=-1*Number(t.system.meleeStats.defenseMalus);0!=c&&e.push({name:`${game.i18n.localize("statuseffects")} - ${game.i18n.localize("MODS.defenseMalus")}`,value:c,type:"defenseMalus",selected:!0}),mergeObject(a,{visionOptions:l.Z.meleeRangeVision(a.mode),weaponSizes:l.Z.meleeRanges,melee:!0,showAttack:!0,targetWeaponSize:r,combatSpecAbs:i,meleeSizeOptions:l.Z.meleeSizeCategories,targetSize:o,constricted:t.hasCondition("constricted"),wrongHandDisabled:n,offHand:!n&&getProperty(s,"system.worn.offHand")})}static prepareMeleeParry(e,t,a,s,i,n){const r=Itemdsa5.getDefenseMalus(e,t);mergeObject(a,{visionOptions:l.Z.meleeRangeVision(a.mode),showDefense:!0,isRangeDefense:r,wrongHandDisabled:n&&getProperty(s,"system.worn.offHand"),offHand:!n&&getProperty(s,"system.worn.offHand")&&getProperty(s,"system.combatskill.value")!=game.i18n.localize("LocalizedIDs.Shields"),melee:!0,combatSpecAbs:i,constricted:t.hasCondition("constricted")})}static _chatLineHelper(e,t){return`<b>${game.i18n.localize(e)}</b>: ${t||"-"}`}static setupDialog(e,t,a,s,i){return null}setupEffect(e,t={},a){return Itemdsa5.getSubClass(this.type).setupDialog(e,t,this,a)}static checkEquality(e,t){return t.type==e.type&&e.name==t.name&&e.system.description.value==t.system.description.value}static async combineItem(e,t,a){return(e=duplicate(e)).system.quantity.value+=t.system.quantity.value,await a.updateEmbeddedDocuments("Item",[e])}static areEquals(e,t){return e.type==t.type&&Itemdsa5.getSubClass(e.type).checkEquality(e,t)}static async stackItems(e,t,a){return await Itemdsa5.getSubClass(e.type).combineItem(e,t,a)}_setupCardOptions(e,t,a){const s=ChatMessage.getSpeaker();return{speaker:{alias:s.alias,scene:s.scene},flags:{img:s.token?canvas.tokens.get(s.token).document.img:this.img},title:t,template:e}}async itemTest({testData:e,cardOptions:t},a={}){e=await i.Z.rollDices(e,t);let s=await i.Z.rollTest(e);if(s.postFunction="itemTest",game.user.targets.size){t.isOpposedTest=e.opposable;const a=` - ${game.i18n.localize("Opposed")}`;t.isOpposedTest&&t.title.match(a+"$")!=a&&(t.title+=a)}return a.suppressMessage||i.Z.renderRollCard(t,s,a.rerenderMessage),{result:s,cardOptions:t}}static chatData(e,t){return[]}static getSubClass(e){return game.dsa5.config.ItemSubclasses[e]||Itemdsa5}async postItem(){Itemdsa5.getSubClass(this.type)._postItem(this)}static async _postItem(e){let t=duplicate(e);const a=getProperty(t,"system.obfuscation.details"),i=getProperty(t,"system.obfuscation.description");if(mergeObject(t,{properties:a?[]:Itemdsa5.getSubClass(e.type).chatData(duplicate(t.system),e.name),descriptionObfuscated:i}),t.hasPrice="price"in t.system&&!a,t.hasPrice){let e=t.system.price.value;t.system.QL&&(e*=t.system.QL),t.system.price.D=Math.floor(e/10),e-=10*t.system.price.D,t.system.price.S=Math.floor(e),e-=t.system.price.S,t.system.price.H=Math.floor(e/.1),e-=.1*t.system.price.H,t.system.price.K=Math.round(e/.01);const a=["D","S","H","K"].map((e=>`${t.system.price[e]} <div data-tooltip="${game.i18n.localize(`Money-${e}`)}" class="chatmoney money-${e}"></div>`)).join(",");t.properties.push(`<b>${game.i18n.localize("price")}</b>: ${a}`)}e.pack&&(t.itemLink=e.link),t.img.includes("/blank.webp")&&(t.img=null);const n=await renderTemplate("systems/dsa5/templates/chat/post-item.html",t),r=s.Z.chatDataSetup(n);ChatMessage.create(r)}}class PlantItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("effect",e.effect),this._chatLineHelper("PLANT.recipes",e.recipes),this._chatLineHelper("PLANT.usages",e.usages)]}}class MagicalSignItemDSA5 extends Itemdsa5{static chatData(e,t){let a=[this._chatLineHelper("AsPCost",e.asp)];return 2==e.category&&a.push(this._chatLineHelper("feature",e.feature)),a}}class DemonmarkItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("attributes",e.attribute),this._chatLineHelper("skills",e.skills),this._chatLineHelper("domains",e.domain)]}}class PatronItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("skills",e.talents),this._chatLineHelper("culture",e.culture),this._chatLineHelper("Category",game.i18n.localize(`PATRON.${e.category}`))]}}class aggregatedTestItemDSA5 extends Itemdsa5{static chatData(e,t){let a=game.i18n.localize("Ongoing");return e.cummulatedQS.value>=10?a=game.i18n.localize("Success"):e.cummulatedQS.value>=6?a=game.i18n.localize("PartSuccess"):e.allowedTestCount.value-e.usedTestCount.value<=0&&(a=game.i18n.localize("Failure")),[this._chatLineHelper("cummulatedQS",`${e.cummulatedQS.value} / 10`),this._chatLineHelper("interval",e.interval.value),this._chatLineHelper("probes",`${e.usedTestCount.value} / ${e.allowedTestCount.value}`),this._chatLineHelper("result",a)]}}class AmmunitionItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("ammunitiongroup",game.i18n.localize(e.ammunitiongroup.value))]}}class EffectWrapperItemDSA5 extends Itemdsa5{}class ArmorItemDSA5 extends Itemdsa5{static chatData(e,t){let a=[this._chatLineHelper("protection",e.protection.value),this._chatLineHelper("encumbrance",e.encumbrance.value)];return""!=e.effect.value&&a.push(this._chatLineHelper("effect",e.effect.value)),a}}class CantripItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("feature",e.feature.value)]}}class BlessingItemDSA5 extends CantripItemDSA5{}class SpellItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",s.Z.replaceConditions(s.Z.replaceDies(e.effect.value)))]}static async getCallbackData(e,t,a){e.testDifficulty=0,e.situationalModifiers=n.Z._parseModifiers(t);const s=new FormDataExtended(t.find("form")[0]).object;e.calculatedSpellModifiers={castingTime:t.find(".castingTime").text(),cost:t.find(".aspcost").text(),reach:t.find(".reach").text(),maintainCost:t.find(".maintainCost").text()},e.situationalModifiers.push({name:game.i18n.localize("removeGesture"),value:Number(s.removeGesture)||0},{name:game.i18n.localize("removeFormula"),value:Number(s.removeFormula)||0},{name:game.i18n.localize("castingTime"),value:t.find(".castingTime").data("mod")},{name:game.i18n.localize("cost"),value:t.find(".aspcost").data("mod")},{name:game.i18n.localize("reach"),value:t.find(".reach").data("mod")},{name:game.i18n.localize("zkModifier"),value:s.zkModifier||0},{name:game.i18n.localize("skModifier"),value:s.skModifier||0},{name:game.i18n.localize("maintainedSpells"),value:-1*s.maintainedSpells}),e.extensions=SpellItemDSA5.getSpecAbModifiers(t),e.advancedModifiers={chars:[0,1,2].map((e=>s[`ch${e}`])),fws:s.fw,qls:s.qs},Itemdsa5.changeChars(e.source,...[0,1,2].map((e=>s[`characteristics${e}`]))),await this.applyExtensions(e.source,e.extensions,a)}static async applyExtensions(e,t,a){m.Z.ensureNumber(e);const i=Object.keys(f.Z.rollModifiers).map((e=>`${e}.mod`));for(let a of t){const t=fromUuidSync(a.uuid);if(t)for(let a of t.effects)for(let t of a.changes)f.Z.rollChanges.includes(t.key)||i.includes(t.key)||("macro.transform"==t.key?await s.Z.callItemTransformationMacro(t.value,e,a):a.apply(e,t))}}static getSpecAbModifiers(e){let t=[];for(let a of e.find(".specAbs.active"))t.push({name:a.dataset.name,title:a.getAttribute("title"),uuid:a.dataset.uuid});return t}static attackSpellMalus(e){let t=[];return e.system.effectFormula.value&&t.push({name:game.i18n.localize("MODS.defenseMalus"),value:-4,type:"defenseMalus",selected:!0,source:e.name}),t}static getPropertyModifiers(e,t){const a=["ceremony","liturgy"].includes(t.type),s=(getProperty(t,"system.feature")||"").replace(/\(a-z äöü\-\)/gi,"").split(",").map((e=>e.trim())),i=[],n=a?"KaPCost":"AsPCost",r=["FP","step","QL","TPM","FW",n];for(const t of r){const a="step"==t?"":t,n=getProperty(e.system.skillModifiers,`feature.${t}`);i.push(...n.filter((e=>s.includes(e.target))).map((e=>({name:e.source,value:e.value,type:a,source:e.source}))))}const o=getProperty(e.system.skillModifiers,`conditional.${n}`);return i.push(...o.map((e=>({name:e.target,value:e.value,type:n})))),i}static foreignSpellModifier(e,t,a,s){if(game.settings.get("dsa5","enableForeignSpellModifer")&&["npc","character"].includes(e.type)&&["spell","ritual"].includes(t.type)){const i=t.system.distribution.value.split(",").map((e=>e.trim().toLowerCase())),n=new RegExp(`(${game.i18n.localize("tradition")}|\\)|\\()`,"g"),r=e.system.tradition.magical.replace(n,"").split(",").map((e=>e.trim().toLowerCase()));r.push(game.i18n.localize("general").toLowerCase()),s.isForeign=!i.some((e=>r.includes(e))),s.isForeign&&a.push({name:game.i18n.localize("DSASETTINGS.enableForeignSpellModifer"),value:-2,selected:!0})}}static getSituationalModifiers(e,t,a,s){e.push(...c.Z.getTalentBonus(t,s.name,["advantage","disadvantage","specialability","equipment"]),...o.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalAttunement"),1,!0),...o.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.magicalRestriction"),-1,!0),...o.Z.getVantageAsModifier(t,game.i18n.localize("LocalizedIDs.boundToArtifact"),-1,!0),...this.getPropertyModifiers(t,s),...this.attackSpellMalus(s)),this.foreignSpellModifier(t,s,e,a),game.user.targets.size&&game.user.targets.forEach((a=>{a.actor&&u.Z.addCreatureTypeModifiers(a.actor,s,e,t)})),e.push(...t.getSkillModifier(s.name,s.type));for(const a of t.system.skillModifiers.global)e.push({name:a.source,value:a.value});this.getSkZkModifier(a,s)}static setupDialog(e,t,a,s,n){let o="spell";"ceremony"!=a.type&&"liturgy"!=a.type||(o="liturgy");let l=a.name+" "+game.i18n.localize(`${a.type}Test`)+(t.subtitle||""),c={opposable:a.system.effectFormula.value.length>0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:Itemdsa5.buildSpeaker(s,n)},advancedModifiers:{chars:[0,0,0],fws:0,qls:0},calculatedSpellModifiers:{castingTime:0,cost:0,reach:0,maintainCost:0}},d={rollMode:t.rollMode,spellCost:a.system.AsPCost.value,maintainCost:a.system.maintainCost.value,spellCastingTime:a.system.castingTime.value,spellReach:a.system.range.value,canChangeCost:"true"==a.system.canChangeCost.value,canChangeRange:"true"==a.system.canChangeRange.value,canChangeCastingTime:"true"==a.system.canChangeCastingTime.value,hasSKModifier:"SK"==a.system.resistanceModifier.value,hasZKModifier:"ZK"==a.system.resistanceModifier.value,maxMods:Math.floor(Number(a.system.talentValue.value)/4),extensions:this.prepareExtensions(s,a),variableBaseCost:"true"==a.system.variableBaseCost,characteristics:[1,2,3].map((e=>a.system[`characteristic${e}`].value))},m=s?r.Z.getRollModifiers(s,a):[];this.getSituationalModifiers(m,s,d,a),d.situationalModifiers=m;let u={title:l,template:`/systems/dsa5/templates/dialog/${o}-enhanced-dialog.html`,data:d,callback:async(e,t={})=>(g.rollMode=e.find('[name="rollMode"]').val(),await this.getCallbackData(c,e,s),mergeObject(c.extra.options,t),{testData:c,cardOptions:g})},g=s._setupCardOptions("systems/dsa5/templates/chat/roll/spell-card.html",l,n);return i.Z.setupDialog({dialogOptions:u,testData:c,cardOptions:g})}static prepareExtensions(e,t){return e.items.filter((e=>"spellextension"==e.type&&e.system.source==t.name&&e.system.category==t.type)).map((e=>(e.shortName=e.name.split(" - ").length>1?e.name.split(" - ")[1]:e.name,e.descr=$(e.system.description.value).text()||"",e)))}}class LiturgyItemDSA5 extends SpellItemDSA5{static chatData(e,t){return[this._chatLineHelper("castingTime",e.castingTime.value),this._chatLineHelper("KaPCost",e.AsPCost.value),this._chatLineHelper("distribution",e.distribution.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("reach",e.range.value),this._chatLineHelper("targetCategory",e.targetCategory.value),this._chatLineHelper("effect",s.Z.replaceConditions(s.Z.replaceDies(e.effect.value)))]}}class CeremonyItemDSA5 extends LiturgyItemDSA5{static getCallbackData(e,t,a){super.getCallbackData(e,t,a),e.situationalModifiers.push({name:game.i18n.localize("CEREMONYMODIFIER.artefact"),value:t.find('[name="artefactUsage"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}static getSituationalModifiers(e,t,a,s){super.getSituationalModifiers(e,t,a,s),mergeObject(a,{isCeremony:!0,locationModifiers:l.Z.ceremonyLocationModifiers,timeModifiers:l.Z.ceremonyTimeModifiers})}}class CombatskillDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("Description",game.i18n.localize(`Combatskilldescr.${t}`))]}static setupDialog(e,t,a,s,r){let o=t.mode,l=a.name+" "+game.i18n.localize(o+"test"),c={opposable:!0,source:a,mode:o,extra:{actor:s.toObject(!1),options:t,speaker:Itemdsa5.buildSpeaker(s,r)}},d={title:l,template:"systems/dsa5/templates/dialog/combatskill-dialog.html",data:{rollMode:t.rollMode},callback:(e,t={})=>(m.rollMode=e.find('[name="rollMode"]').val(),c.situationalModifiers=n.Z._parseModifiers(e),mergeObject(c.extra.options,t),{testData:c,cardOptions:m})},m=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",l,r);return i.Z.setupDialog({dialogOptions:d,testData:c,cardOptions:m})}}class ConsumableItemDSA extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("qualityStep",e.QL),this._chatLineHelper("effect",s.Z.replaceDies(e.QLList.split("\n")[e.QL-1])),this._chatLineHelper("charges",e.charges)]}static checkEquality(e,t){return e.type==t.type&&e.name==t.name&&e.system.description.value==t.system.description.value&&e.system.QL==t.system.QL}static async setupDialog(e,t,a,i){let n=game.i18n.format("CHATNOTIFICATION.usesItem",{actor:a.actor.name,item:a.name});if(!a.isOwned)return;if((a.system.quantity.value-1)*a.system.maxCharges+a.system.charges<=0)return void ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));let r=a.system.charges<=1?a.system.maxCharges:a.system.charges-1,o=a.system.charges<=1?a.system.quantity.value-1:a.system.quantity.value,l=s.Z.replaceDies(a.system.QLList.split("\n")[a.system.QL-1],!1),c=`<div><b>${n}</b></div><div>${a.system.description.value}</div><div><b>${game.i18n.localize("effect")}</b>: ${l}</div>`;0==o?await a.actor.deleteEmbeddedDocuments("Item",[a.id]):await a.update({"system.quantity.value":o,"system.charges":r}),await ChatMessage.create(s.Z.chatDataSetup(c)),await this._applyActiveEffect(a)}static async _applyActiveEffect(e){let t=e.effects.toObject();if(t.length>0){const{msg:a,resistRolls:i,effectNames:n}=await d.Z.applyAdvancedFunction(e.actor,t,e,{qualityStep:e.system.QL},e.actor),r=`${game.i18n.format("ActiveEffects.appliedEffect",{target:e.actor.token?.name||e.actor.name,source:n.join(", ")})} ${a||""}`;ChatMessage.create(s.Z.chatDataSetup(r))}}static async combineItem(e,t,a){let s=((e=duplicate(e)).system.quantity.value-1)*e.system.maxCharges+e.system.charges,i=(t.system.quantity.value-1)*t.system.maxCharges+t.system.charges,n=Math.floor((s+i)/e.system.maxCharges)+1,r=(s+i)%e.system.maxCharges;return 0==r&&(n-=1,r=e.system.maxCharges),e.system.quantity.value=n,e.system.charges=r,await a.updateEmbeddedDocuments("Item",[e])}}class InformationItemDSA5 extends Itemdsa5{static async _postItem(e){const t=await renderTemplate("systems/dsa5/templates/chat/informationRequestRoll.html",{item:e}),a=s.Z.chatDataSetup(t);ChatMessage.create(a)}}class DiseaseItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("incubation",e.incubation.value),this._chatLineHelper("damage",s.Z.replaceConditions(s.Z.replaceDies(e.damage.value))),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("source",s.Z.replaceDies(e.source.value)),this._chatLineHelper("treatment",e.treatment.value),this._chatLineHelper("antidot",e.antidot.value),this._chatLineHelper("resistanceModifier",e.resistance.value)]}static getSituationalModifiers(e,t,a,i){i=s.Z.toObjectIfPossible(i),game.user.targets.size&&game.user.targets.forEach((t=>{t.actor&&e.push(...o.Z.getVantageAsModifier(t.actor,game.i18n.localize("LocalizedIDs.ResistanttoDisease"),-1,!1,!0))})),this.getSkZkModifier(a,i),mergeObject(a,{hasSKModifier:"SK"==i.system.resistance.value,hasZKModifier:"ZK"==i.system.resistance.value})}static setupDialog(e,t,a,s,r){let o=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),l={opposable:!1,source:a,extra:{options:t,speaker:Itemdsa5.buildSpeaker(s,r)}},c={rollMode:t.rollMode},d=[];this.getSituationalModifiers(d,s,c,a),c.situationalModifiers=d,t.manualResistance&&mergeObject(c,t.manualResistance);let m={title:o,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:c,callback:(e,t={})=>(u.rollMode=e.find('[name="rollMode"]').val(),l.situationalModifiers=n.Z._parseModifiers(e),l.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:e.find('[name="zkModifier"]').val()||0},{name:game.i18n.localize("skModifier"),value:e.find('[name="skModifier"]').val()||0}),mergeObject(l.extra.options,t),{testData:l,cardOptions:u})},u=a._setupCardOptions(`systems/dsa5/templates/chat/roll/${a.type}-card.html`,o,r);return i.Z.setupDialog({dialogOptions:m,testData:l,cardOptions:u})}}class EquipmentItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("equipmentType",game.i18n.localize(`Equipment.${e.equipmentType.value}`))]}}class MeleeweaponDSA5 extends Itemdsa5{static chatData(e,t){let a=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("atmod",e.atmod.value),this._chatLineHelper("pamod",e.pamod.value),this._chatLineHelper("reach",game.i18n.localize(`Range-${e.reach.value}`)),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill.value)];return""!=e.effect.value&&a.push(this._chatLineHelper(s.Z.replaceConditions("effect",e.effect.value))),a}static getSituationalModifiers(e,t,a,i){let n=o.Z.hasVantage(t,game.i18n.localize("LocalizedIDs.ambidextrous")),r=[(i=s.Z.toObjectIfPossible(i)).system.combatskill.value],l=Itemdsa5.buildCombatSpecAbs(t,["Combat"],r,a.mode);"attack"==a.mode?this.prepareMeleeAttack(e,t,a,i,l,n):"parry"==a.mode&&this.prepareMeleeParry(e,t,a,i,l,n),this.attackStatEffect(e,t.system.meleeStats[a.mode]),["attack","parry"].includes(a.mode)&&e.push(...MeleeweaponDSA5.getMiracleModifiers(t,{name:i.system.combatskill.value},"",a.mode))}static setupDialog(e,t,a,n,o){let l=t.mode,c=a.name+" "+game.i18n.localize(l+"test"),d={opposable:!0,source:a,mode:l,extra:{actor:n.toObject(!1),options:t,speaker:Itemdsa5.buildSpeaker(n,o)}};const u=m.Z.multipleDefenseValue(n,s.Z.toObjectIfPossible(a));let g={rollMode:t.rollMode,mode:l,defenseCountString:game.i18n.format("defenseCount",{malus:u})},h=n?r.Z.getRollModifiers(n,a,{mode:l}):[];this.getSituationalModifiers(h,n,g,a),g.situationalModifiers=h,t.situationalModifiers&&g.situationalModifiers.push(...t.situationalModifiers);let f={title:c,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:g,callback:(e,t={})=>(p.Z.resolveMeleeDialog(d,y,e,n,t,u,l),Hooks.call("callbackDialogCombatDSA5",d,n,e,a,o),d.isRangeDefense=g.isRangeDefense,{testData:d,cardOptions:y})},y=n._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",c,o);return i.Z.setupDialog({dialogOptions:f,testData:d,cardOptions:y})}}class PoisonItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("stepValue",e.step.value),this._chatLineHelper("poisonType",e.poisonType.value),this._chatLineHelper("start",e.start.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("resistanceModifier",e.resistance.value),this._chatLineHelper("effect",s.Z.replaceConditions(s.Z.replaceDies(e.effect.value)))]}static getSituationalModifiers(e,t,a,i){i=s.Z.toObjectIfPossible(i),game.user.targets.size&&game.user.targets.forEach((t=>{t.actor&&e.push(...o.Z.getVantageAsModifier(t.actor,game.i18n.localize("LocalizedIDs.poisonResistance"),-1,!1,!0))})),this.getSkZkModifier(a,i),mergeObject(a,{hasSKModifier:"SK"==i.system.resistance.value,hasZKModifier:"ZK"==i.system.resistance.value})}static setupDialog(e,t,a,s,r){let o=a.name+" "+game.i18n.localize(a.type)+" "+game.i18n.localize("Test"),l={opposable:!1,source:a,extra:{options:t,speaker:Itemdsa5.buildSpeaker(s,r)}},c={rollMode:t.rollMode},d=[];this.getSituationalModifiers(d,s,c,a),c.situationalModifiers=d;let m={title:o,template:"/systems/dsa5/templates/dialog/poison-dialog.html",data:c,callback:(e,t={})=>(u.rollMode=e.find('[name="rollMode"]').val(),l.situationalModifiers=n.Z._parseModifiers(e),l.situationalModifiers.push({name:game.i18n.localize("zkModifier"),value:e.find('[name="zkModifier"]').val()||0}),l.situationalModifiers.push({name:game.i18n.localize("skModifier"),value:e.find('[name="skModifier"]').val()||0}),mergeObject(l.extra.options,t),{testData:l,cardOptions:u})},u=a._setupCardOptions(`systems/dsa5/templates/chat/roll/${a.type}-card.html`,o,r);return i.Z.setupDialog({dialogOptions:m,testData:l,cardOptions:u})}}class RangeweaponItemDSA5 extends Itemdsa5{static chatData(e,t){let a=[this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("TYPES.Item.combatskill",e.combatskill.value),this._chatLineHelper("reach",e.reach.value)];return""!=e.effect.value&&a.push(this._chatLineHelper(s.Z.replaceConditions("effect",e.effect.value))),a}static getSituationalModifiers(e,t,a,i,n){if("attack"==a.mode){const r=s.Z.toObjectIfPossible(i),o=[r.system.combatskill.value],l=Itemdsa5.buildCombatSpecAbs(t,["Combat"],o,a.mode);let c=t.items.get(r.system.currentAmmo.value);if(c){c=c.toObject(!1),r.system.effect.attributes=(r.system.effect.attributes||"").split(",").concat((c.system.effect.attributes||"").split(",")).filter((e=>""!=e)).join(",");const e=getProperty(c.flags,"dsa5.poison");e&&mergeObject(i.flags,{dsa5:{poison:e}})}if(this.prepareRangeAttack(e,t,a,r,n,l,c),c){if(c.system.atmod&&e.push({name:`${c.name} - ${game.i18n.localize("atmod")}`,value:c.system.atmod,selected:!0,specAbId:r.system.currentAmmo.value}),c.system.damageMod||c.system.armorMod){const t={name:`${c.name} - ${game.i18n.localize("MODS.damage")}`,value:c.system.damageMod.replace(/wWD/g,"d")||0,type:"dmg",selected:!0,specAbId:r.system.currentAmmo.value};c.system.armorMod&&(t.armorPen=c.system.armorMod),e.push(t)}c.effects.length&&e.push({name:`${c.name} - ${game.i18n.localize("TYPES.Item.ammunition")}`,value:1,type:"effect",selected:!0,specAbId:r.system.currentAmmo.value})}e.push(...RangeweaponItemDSA5.getMiracleModifiers(t,{name:r.system.combatskill.value},"",a.mode))}this.attackStatEffect(e,t.system.rangeStats[a.mode])}static async checkAmmunitionState(e,t,a,s){let i=!0;if("damage"!=s){let s=e.system;if("infinite"==s.ammunitiongroup.value);else if("-"==s.ammunitiongroup.value)t.extra.ammo=duplicate(e),i=t.extra.ammo.system.quantity.value>0;else{const e=a.items.get(s.currentAmmo.value);e?(t.extra.ammo=e.toObject(),i="mag"==s.ammunitiongroup.value?t.extra.ammo.system.quantity.value>1||t.extra.ammo.system.mag.value>0&&t.extra.ammo.system.quantity.value>0:t.extra.ammo.system.quantity.value>0):i=!1}i||"creature"!=a.type||(i=!0)}return i||ui.notifications.error(game.i18n.localize("DSAError.NoAmmo")),i}static async setupDialog(e,t,a,s,n){let o=t.mode,l=a.name+" "+game.i18n.localize(o+"test"),c={opposable:!0,source:a,mode:o,extra:{actor:s.toObject(!1),options:t,speaker:Itemdsa5.buildSpeaker(s,n)}};if(!await this.checkAmmunitionState(a,c,s,o))return;let d={rollMode:t.rollMode,mode:o},m=s?r.Z.getRollModifiers(s,a,{mode:o}):[];this.getSituationalModifiers(m,s,d,a,n),d.situationalModifiers=m,t.situationalModifiers&&d.situationalModifiers.push(...t.situationalModifiers);let u={title:l,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:d,callback:(e,t={})=>(p.Z.resolveRangeDialog(c,g,e,s,t),Hooks.call("callbackDialogCombatDSA5",c,s,e,a,n),{testData:c,cardOptions:g})},g=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",l,n);return i.Z.setupDialog({dialogOptions:u,testData:c,cardOptions:g})}}class RitualItemDSA5 extends SpellItemDSA5{static getCallbackData(e,t,a){super.getCallbackData(e,t,a),e.situationalModifiers.push({name:game.i18n.localize("RITUALMODIFIER.rightClothes"),value:t.find('[name="rightClothes"]').is(":checked")?1:0},{name:game.i18n.localize("RITUALMODIFIER.rightEquipment"),value:t.find('[name="rightEquipment"]').is(":checked")?1:0},{name:game.i18n.localize("place"),value:t.find('[name="placeModifier"]').val()},{name:game.i18n.localize("time"),value:t.find('[name="timeModifier"]').val()})}static getSituationalModifiers(e,t,a,s){super.getSituationalModifiers(e,t,a,s),mergeObject(a,{isRitual:!0,locationModifiers:l.Z.ritualLocationModifiers,timeModifiers:l.Z.ritualTimeModifiers})}}class SkillItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("Description",game.i18n.localize(`SKILLdescr.${t}`))]}static getSituationalModifiers(e,t,a,s){e.push(...c.Z.getTalentBonus(t,s.name,["advantage","disadvantage","specialability","equipment"]),...t.getSkillModifier(s.name,s.type),...SkillItemDSA5.getMiracleModifiers(t,s,"FW","skill"));for(const a of t.system.skillModifiers.global)e.push({name:a.source,value:a.value})}static setupDialog(e,t,a,s,o){let c=a.name+" "+game.i18n.localize("Test")+(t.subtitle||""),d={opposable:!0,source:a,extra:{actor:s.toObject(!1),options:t,speaker:Itemdsa5.buildSpeaker(s,o)}},m={rollMode:t.rollMode,difficultyLabels:l.Z.skillDifficultyLabels,modifier:t.modifier||0,characteristics:[1,2,3].map((e=>a.system[`characteristic${e}`].value)),situationalModifiers:s?r.Z.getRollModifiers(s,a):[]};t.situationalModifiers&&m.situationalModifiers.push(...t.situationalModifiers),this.getSituationalModifiers(m.situationalModifiers,s,m,a);let u={title:c,template:"/systems/dsa5/templates/dialog/skill-dialog.html",data:m,callback:(e,t={})=>(g.rollMode=e.find('[name="rollMode"]').val(),d.testDifficulty=l.Z.skillDifficultyModifiers[e.find('[name="testDifficulty"]').val()],d.situationalModifiers=n.Z._parseModifiers(e),d.advancedModifiers={chars:[0,1,2].map((t=>Number(e.find(`[name="ch${t}"]`).val()))),fws:Number(e.find('[name="fw"]').val()),qls:Number(e.find('[name="qs"]').val())},Itemdsa5.changeChars(d.source,...[0,1,2].map((t=>e.find(`[name="characteristics${t}"]`).val()))),mergeObject(d.extra.options,t),{testData:d,cardOptions:g})},g=s._setupCardOptions("systems/dsa5/templates/chat/roll/skill-card.html",c,o);return i.Z.setupDialog({dialogOptions:u,testData:d,cardOptions:g})}}class SpecialAbilityItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("rule",e.rule.value)]}}class SpeciesItemDSA5 extends Itemdsa5{}class SpellextensionItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("source",e.source),this._chatLineHelper("Category",game.i18n.localize(e.category))]}}class TraitItemDSA5 extends Itemdsa5{static chatData(e,t){let a=[];switch(e.traitType.value){case"meleeAttack":a=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value)];break;case"rangeAttack":a=[this._chatLineHelper("attack",e.at.value),this._chatLineHelper("damage",e.damage.value),this._chatLineHelper("reach",e.reach.value),this._chatLineHelper("reloadTime",e.reloadTime.value)];break;case"armor":a=[this._chatLineHelper("protection",e.damage.value)];break;case"general":a=[];break;case"familiar":a=[this._chatLineHelper("APValue",e.APValue.value),this._chatLineHelper("AsPCost",e.AsPCost.value),this._chatLineHelper("duration",e.duration.value),this._chatLineHelper("aspect",e.aspect.value)];break;case"trick":a=[this._chatLineHelper("APValue",e.APValue.value)];break;case"entity":a=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("CHARAbbrev.QL",e.AsPCost.value)];break;case"summoning":a=[this._chatLineHelper("distribution",e.distribution),this._chatLineHelper("conjuringDifficulty",e.at.value)]}return""!=e.effect.value&&a.push(this._chatLineHelper("effect",e.effect.value)),a}static getSituationalModifiers(e,t,a,i,n){const r=(i=s.Z.toObjectIfPossible(i)).system.traitType.value,o=Itemdsa5.buildCombatSpecAbs(t,["Combat","animal"],void 0,a.mode);"attack"==a.mode&&"meleeAttack"==r?this.prepareMeleeAttack(e,t,a,i,o,!1):"attack"==a.mode&&"rangeAttack"==r?this.prepareRangeAttack(e,t,a,i,n,o):"parry"==a.mode&&this.prepareMeleeParry(e,t,a,i,o,!1),this.attackStatEffect(e,t.system["meleeAttack"==r?"meleeStats":"rangeStats"][a.mode])}static setupDialog(e,t,a,s,n){let o=t.mode,l=a.name+" "+game.i18n.localize(o+"test"),c={opposable:!0,source:a,mode:o,extra:{actor:s.toObject(!1),options:t,speaker:Itemdsa5.buildSpeaker(s,n)}};const d=m.Z.multipleDefenseValue(s,a.toObject());let u={rollMode:t.rollMode,mode:o,defenseCountString:game.i18n.format("defenseCount",{malus:d})};const g=getProperty(a,"system.traitType.value");let h=s?r.Z.getRollModifiers(s,a,{mode:o}):[];this.getSituationalModifiers(h,s,u,a,n),u.situationalModifiers=h;let f={title:l,template:"/systems/dsa5/templates/dialog/combatskill-enhanced-dialog.html",data:u,callback:(e,t={})=>("meleeAttack"==g?p.Z.resolveMeleeDialog(c,y,e,s,t,d,o):p.Z.resolveRangeDialog(c,y,e,s,t),c.isRangeDefense=u.isRangeDefense,Hooks.call("callbackDialogCombatDSA5",c,s,e,a,n),{testData:c,cardOptions:y})},y=s._setupCardOptions("systems/dsa5/templates/chat/roll/combatskill-card.html",l,n);return i.Z.setupDialog({dialogOptions:f,testData:c,cardOptions:y})}}class VantageItemDSA5 extends Itemdsa5{static chatData(e,t){return[this._chatLineHelper("effect",e.effect.value)]}}},61:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DSAActiveEffectConfig});var _dialog_dialog_spell_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(954),_system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(577),_system_dice_dsa5_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(562),_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(491);function automatedAnimation(e,t={}){_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}async function callMacro(e,t,a,s,i,n={}){let r={};if(game.user.can("MACRO_SCRIPT")){const o=game.packs.get(e);let l=await o.getDocuments({name:t});if(!l.length)for(let e of game.packs.filter((e=>"Macro"==e.documentName&&/\(internal\)/.test(e.metadata.label))))if(l=await e.getDocuments({name:t}),l.length)break;if(l.length){const e=`(async () => {${l[0].command}})()`,t=Function("actor","item","qs","automatedAnimation","args",e);try{n.result=r;const e=mergeObject({automatedAnimation},this);await t.call(e,a,s,i,automatedAnimation,n)}catch(e){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(e),r.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:t}))}else ui.notifications.warn("You are not allowed to use JavaScript macros.");return r}class DSAActiveEffectConfig extends ActiveEffectConfig{static get defaultOptions(){return mergeObject(super.defaultOptions,{resizable:!0})}static async onEffectRemove(actor,effect){const onRemoveMacro=getProperty(effect,"flags.dsa5.onRemove");onRemoveMacro&&(game.user.can("MACRO_SCRIPT")?await eval(`(async () => {${onRemoveMacro}})()`):ui.notifications.warn("You are not allowed to use JavaScript macros."))}async checkTimesUpInstalled(){const e=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.moduleEnabled("times-up");return!e&&game.user.isGM&&ui.notifications.warn(game.i18n.localize("DSAError.shouldTimesUp")),e}async _render(e=!1,t={}){await super._render(e,t);let a=-1;const s=["none","systemEffect","macro","creature"].map((e=>({name:`ActiveEffects.advancedFunctions.${e}`,index:a+=1}))),i=getProperty(this.object,"parent.type"),n=["meleeweapon","rangeweapon"].includes(i)||"trait"==i&&["meleeAttack","rangeAttack"].includes(getProperty(this.object,"parent.system.traitType.value")),r={hasSpellEffects:n||["spell","liturgy","ritual","ceremony","consumable","poison","disease","ammunition"].includes(i)||["specialability"].includes(i)&&"Combat"==getProperty(this.object,"parent.system.category.value"),hasDamageTransformation:["ammunition"].includes(i)};r.hasDamageTransformation&&s.push({name:"ActiveEffects.advancedFunctions.armorPostprocess",index:4},{name:"ActiveEffects.advancedFunctions.damagePostprocess",index:5});const o={systemEffects:this.getStatusEffects(),canEditMacros:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")};let l=$(this._element);l.find(".tabs").append(`<a class="item" data-tab="advanced"><i class="fas fa-shield-alt"></i>${game.i18n.localize("advanced")}</a>`);let c=await renderTemplate("systems/dsa5/templates/status/advanced_effect.html",{effect:this.object,advancedFunctions:s,effectConfigs:r,config:o,isWeapon:n});l.find('.tab[data-tab="effects"]').after($(c)),l.find(".advancedSelector").change((e=>{let t=this.object;t.flags.dsa5.advancedFunction=$(e.currentTarget).val(),renderTemplate("systems/dsa5/templates/status/advanced_functions.html",{effect:t,config:o}).then((e=>{l.find(".advancedFunctions").html(e)}))})),this.checkTimesUpInstalled()}getStatusEffects(){return duplicate(CONFIG.statusEffects).map((e=>({id:e.id,name:game.i18n.localize(e.name)}))).sort(((e,t)=>e.name.localeCompare(t.name)))}static applyRollTransformation(actor,options,functionID){let msg="",source=options.origin;for(const ef of source.effects)try{Number(getProperty(ef,"flags.dsa5.advancedFunction"))==functionID&&eval(getProperty(ef,"flags.dsa5.args3"))}catch(e){console.warn("Unable to apply advanced effect",e,ef)}return options.origin=source,{msg,options}}static async applyAdvancedFunction(actor,effects,source,testData,sourceActor,skipResistRolls=!0){let msg="";const resistRolls=[];let effectApplied=!1;const effectsWithChanges=[],effectNames=new Set;for(const ef of effects){ef.origin&&delete ef.origin;const specStep=Number(getProperty(ef,"flags.dsa5.specStep"))||0;try{const customEf=Number(getProperty(ef,"flags.dsa5.advancedFunction")),qs=Math.min(testData.qualityStep||0,6),resistRoll=getProperty(ef,"flags.dsa5.resistRoll");if(resistRoll&&!skipResistRolls){const e=resistRoll.split(" "),t=`${e.pop()}`;resistRolls.push({skill:e.join(" "),mod:Math.round(Roll.safeEval(`${t}`.replace(/q(l|s)/i,qs).replace("step",specStep)))||0,effect:ef,target:actor,token:actor.token?actor.token.id:void 0})}else if(effectApplied=!0,effectNames.has(ef.name)||effectNames.add(ef.name),ef.changes&&ef.changes.length>0&&effectsWithChanges.push(ef),customEf)switch(customEf){case 1:{const e=duplicate(CONFIG.statusEffects.find((e=>e.id==getProperty(ef,"flags.dsa5.args0"))));let t=`${getProperty(ef,"flags.dsa5.args1")}`||"1";e.duration=ef.duration,t=/,/.test(t)?Number(t.split(",")[qs-1]):Number(t.replace(game.i18n.localize("CHARAbbrev.QS"),qs)),await actor.addCondition(e,t,!1,!1)}break;case 2:game.user.can("MACRO_SCRIPT")?await eval(`(async () => {${getProperty(ef,"flags.dsa5.args3")}})()`):ui.notifications.warn("You are not allowed to use JavaScript macros.");break;case 3:let creatures=(getProperty(ef,"flags.dsa5.args4")||"").split(",").map((e=>`@Compendium[${e.trim().replace(/(@Compendium\[|\])/)}]`)).join(" ");msg+=`<p><b>${game.i18n.localize("ActiveEffects.advancedFunctions.creature")}</b>:</p><p>${creatures}</p>`}}catch(e){console.warn("Unable to apply advanced effect"),console.warn(e),console.warn(ef)}}return await actor.createEmbeddedDocuments("ActiveEffect",effectsWithChanges.map((e=>(e.origin=actor.uuid,e)))),{msg,resistRolls,effectApplied,effectNames:Array.from(effectNames)}}static async resistEffect(e){const t=e.currentTarget.dataset,a={token:t.token,actor:t.actor,scene:canvas.id},s=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(a);if(s){const e=s.items.find((e=>"skill"==e.type&&e.name==t.skill));s.setupSkill(e,{modifier:t.mod},t.token).then((async e=>{e.testData.opposable=!1;((await s.basicTest(e)).result.qualityStep||0)<1&&await this.applyEffect(t.message,t.mode,[a],{effectIds:[t.effect],skipResistRolls:!0})}))}else console.warn("Actor not found for resist roll.")}static async applyEffect(e,t,a,s={}){const i=game.messages.get(e),n=i.flags.data.preData.source,r=i.flags.data.postData,o=i.speaker;["poison","disease"].includes(n.type)&&(r.qualityStep=r.successLevel>0?2:1);const l=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(o)||_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(getProperty(i.flags,"data.preData.extra.speaker"))||game.actors.get(getProperty(i.flags,"data.preData.extra.actor.id"));let c=l,d=(await this._parseEffectDuration(n,r,i.flags.data.preData,l)).filter((e=>!getProperty(e,"flags.dsa5.applyToOwner")));s.effectIds&&(d=d.filter((e=>s.effectIds.includes(e._id))));let m=[];if("self"==t?l&&m.push(l):a?m=a.map((e=>_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(e))):game.user.targets.size&&game.user.targets.forEach((e=>{e.actor&&m.push(e.actor)})),game.user.isGM)for(let a of m){const{msg:i,resistRolls:o,effectApplied:l,effectNames:m}=await DSAActiveEffectConfig.applyAdvancedFunction(a,d,n,r,c,s.skipResistRolls||!1);if(l){const e=`${game.i18n.format("ActiveEffects.appliedEffect",{target:a.token?.name||a.name,source:m.join(", ")})}${i||""}`;await ChatMessage.create(_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.chatDataSetup(e))}o.length&&await this.createResistRollMessage(o,e,t)}else game.socket.emit("system.dsa5",{type:"addEffect",payload:{mode:t,id:e,actors:m.map((e=>({token:e.token?e.token.id:void 0,actor:e.id,scene:canvas.scene.id})))}})}static async createResistRollMessage(e,t,a){for(const s of e){const e=await renderTemplate("systems/dsa5/templates/chat/roll/resist-roll.html",{resist:s,id:t,mode:a});await ChatMessage.create(_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.chatDataSetup(e))}}static async _parseEffectDuration(e,t,a,s){const i={};for(let e of a.situationalModifiers.filter((e=>e.specAbId)))i[e.specAbId]=e.step;const n=Object.keys(i),r=s?s.items.filter((e=>n.includes(e.id))):[];let o=e.effects?duplicate(e.effects):[];for(const e of r){const t=duplicate(e).effects;for(let a of t)setProperty(a,"flags.dsa5.specStep",i[e.id]);o.push(...t)}let l=getProperty(e,"system.duration.value")||"";l=l.replace(" x "," * ").replace(game.i18n.localize("CHARAbbrev.QS"),t.qualityStep);try{const e=[{regEx:new RegExp(game.i18n.localize("DSAREGEX.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEX.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEX.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEX.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.years"),"gi"),seconds:3024e4}];for(const a of e)if(a.regEx.test(l)){const e=l.replace(a.regEx,"").trim(),s=await _system_dice_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z._stringToRoll(e);if(!isNaN(s))for(let e of o){let i=s*a.seconds;const n=getProperty(e,"flags.dsa5.customDuration");if(n){let e=n.split(",")[t.qualityStep-1];e&&"-"!=e&&(i=Number(e))}e.duration.seconds=i,e.duration.rounds=e.duration.seconds/5}break}}catch(t){console.error(`Could not parse duration '${l}' of '${e.name}'`)}return o}dropDownMenu(){const e=game.i18n.localize("MODS.FW"),t=game.i18n.localize("skill"),a=game.i18n.localize("regenerate"),s=game.i18n.localize("MODS.FP"),i=game.i18n.localize("stepValue"),n=game.i18n.localize("MODS.QS"),r=game.i18n.localize("MODS.partChecks"),o=`${game.i18n.localize("LocalizedIDs.perception")} 1`,l=`${game.i18n.localize("LocalizedIDs.wrestle")} 1`,c=game.i18n.localize("closeCombatAttacks"),d=game.i18n.localize("rangeCombatAttacks"),m=`${a} (${game.i18n.localize("CHARAbbrev.CR")})`,u=game.i18n.localize("AsPCost"),g=game.i18n.localize("KaPCost"),p=`${game.i18n.localize("Healing")} 1`,h=`${game.i18n.localize("Description")} 1`,f=`${game.i18n.localize("LocalizedIDs.miracle")}`;let y=[{name:game.i18n.localize("protection"),val:"system.totalArmor",mode:2,ph:"1"},{name:game.i18n.localize("liturgyArmor"),val:"system.liturgyArmor",mode:2,ph:"1"},{name:`${game.i18n.localize("resistanceModifier")} (${game.i18n.localize("condition")})`,val:"system.resistances.effects",mode:0,ph:"inpain 1"},{name:game.i18n.localize("spellArmor"),val:"system.spellArmor",mode:2,ph:"1"},{name:game.i18n.localize("carrycapacity"),val:"system.carryModifier",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.meleeStats.attack",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.PA")}`,val:"system.meleeStats.parry",mode:2,ph:"1"},{name:`${f} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.miracle.attack",mode:2,ph:"1"},{name:`${f} - ${game.i18n.localize("CHARAbbrev.PA")}`,val:"system.miracle.parry",mode:2,ph:"1"},{name:`${c} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.meleeStats.damage",mode:2,ph:"1d6"},{name:`${c} - ${game.i18n.localize("MODS.defenseMalus")}`,val:"system.meleeStats.defenseMalus",mode:2,ph:"1"},{name:game.i18n.localize("MODS.creatureBonus"),val:"system.creatureBonus",mode:0,ph:`${game.i18n.localize("CONJURATION.elemental")} 1`},{name:`${d} - ${game.i18n.localize("CHARAbbrev.AT")}`,val:"system.rangeStats.attack",mode:2,ph:"1"},{name:`${d} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.rangeStats.damage",mode:2,ph:"1d6"},{name:`${d} - ${game.i18n.localize("MODS.defenseMalus")}`,val:"system.rangeStats.defenseMalus",mode:2,ph:"1"},{name:`${game.i18n.localize("spell")} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.spellStats.damage",mode:2,ph:"1"},{name:`${game.i18n.localize("liturgy")} - ${game.i18n.localize("CHARAbbrev.damage")}`,val:"system.liturgyStats.damage",mode:2,ph:"1"},{name:g,val:"system.kapModifier",mode:2,ph:"1"},{name:u,val:"system.aspModifier",mode:2,ph:"1"},{name:`${t} - ${e}`,val:"system.skillModifiers.FW",mode:0,ph:o},{name:`${t} - ${s}`,val:"system.skillModifiers.FP",mode:0,ph:o},{name:`${t} - ${i}`,val:"system.skillModifiers.step",mode:0,ph:o},{name:`${t} - ${n}`,val:"system.skillModifiers.QL",mode:0,ph:o},{name:`${t} - ${r}`,val:"system.skillModifiers.TPM",mode:0,ph:o},{name:`${game.i18n.localize("vulnerability")} - ${game.i18n.localize("combatskill")}`,val:"system.vulnerabilities.combatskill",mode:0,ph:l},{name:`${t} - ${game.i18n.localize("MODS.global")}`,val:"system.skillModifiers.global",mode:0,ph:"1"},{name:`${m} - ${game.i18n.localize("wounds")}`,val:"system.repeatingEffects.startOfRound.wounds",mode:0,ph:"1d6"},{name:`${m} - ${game.i18n.localize("astralenergy")}`,val:"system.repeatingEffects.startOfRound.astralenergy",mode:0,ph:"1d6"},{name:`${m} - ${game.i18n.localize("karmaenergy")}`,val:"system.repeatingEffects.startOfRound.karmaenergy",mode:0,ph:"1d6"},{name:`${a} - ${game.i18n.localize("wounds")}`,val:"system.status.regeneration.LePgearmodifier",mode:2,ph:"1"},{name:`${a} - ${game.i18n.localize("astralenergy")}`,val:"system.status.regeneration.AsPgearmodifier",mode:2,ph:"1"},{name:`${a} - ${game.i18n.localize("karmaenergy")}`,val:"system.status.regeneration.KaPgearmodifier",mode:2,ph:"1"},{name:`${game.i18n.localize("feature")} - ${u}`,val:"system.skillModifiers.feature.AsPCost",mode:0,ph:p},{name:`${game.i18n.localize("advanced")} - ${u}`,val:"system.skillModifiers.conditional.AsPCost",mode:0,ph:h},{name:`${game.i18n.localize("feature")} - ${g}`,val:"system.skillModifiers.feature.KaPCost",mode:0,ph:p},{name:`${game.i18n.localize("advanced")} - ${g}`,val:"system.skillModifiers.conditional.KaPCost",mode:0,ph:h},{name:`${game.i18n.localize("MODS.sight")}`,val:"system.sightModifier.value",mode:2,ph:"-1"},{name:`${game.i18n.localize("MODS.sightMax")}`,val:"system.sightModifier.maxLevel",mode:5,ph:"4"},{name:`${game.i18n.localize("LocalizedIDs.immuneTo")} ${game.i18n.localize("condition")}`,val:"system.immunities",mode:2,ph:"feared"},{name:game.i18n.localize("temperature.heatProtection"),val:"system.temperature.heatProtection",mode:2,ph:"1"},{name:game.i18n.localize("temperature.coldProtection"),val:"system.temperature.coldProtection",mode:2,ph:"1"}];const b=["liturgy","ceremony","spell","ritual","skill","feature"];for(const t of b){let a="skill"==t?"skillglobal":t;const l=game.i18n.localize(a);y.push({name:`${l} - ${e}`,val:`system.skillModifiers.${t}.FW`,mode:0,ph:o},{name:`${l} - ${s}`,val:`system.skillModifiers.${t}.FP`,mode:0,ph:o},{name:`${l} - ${i}`,val:`system.skillModifiers.${t}.step`,mode:0,ph:o},{name:`${l} - ${n}`,val:`system.skillModifiers.${t}.QL`,mode:0,ph:o},{name:`${l} - ${r}`,val:`system.skillModifiers.${t}.TPM`,mode:0,ph:o})}for(let e of CONFIG.statusEffects)getProperty(e,"flags.dsa5.max")&&y.push({name:game.i18n.localize(e.name),val:`system.condition.${e.id}`,mode:2,ph:1});for(const e of Object.keys(_system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.characteristics))y.push({name:game.i18n.localize(`CHAR.${e.toUpperCase()}`),val:`system.characteristics.${e}.gearmodifier`,mode:2,ph:"1"});for(const e of _system_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.gearModifyableCalculatedAttributes)y.push({name:game.i18n.localize(e),val:`system.status.${e}.gearmodifier`,mode:2,ph:"1"});for(let e of["spell","liturgy","ceremony","ritual"]){const t=_system_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.categoryLocalization(e);for(const a of["soulpower","toughness"])y.push({name:`${game.i18n.localize(a)} (${t})`,val:`system.status.${a}.${e}resist`,mode:2,ph:"1"});for(const a of Object.keys(_dialog_dialog_spell_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z.rollModifiers))y.push({name:`${t} - ${game.i18n.localize(a.replace("Spell",""))}`,val:`system.${e}RollModifiers.${a}.mod`,mode:2,ph:"1"},{name:`${t} - ${game.i18n.localize(a.replace("Spell",""))} - ${game.i18n.localize("advanced")}`,val:`system.${e}RollModifiers.${a}.custom`,mode:0,ph:h})}y=y.sort(((e,t)=>e.name.localeCompare(t.name)));for(let e of y)e.ph&&null!=e.mode||console.warn(e);return y=y.map((e=>`<option value="${e.val}" data-mode="${e.mode}" data-ph="${e.ph}">${e.name}</option>`)).join("\n"),`<select class="selMenu">${y}</select>`}activateListeners(e){super.activateListeners(e);const t=this.dropDownMenu();e.find(".changes-list .effect-change .key").append(t),e.find(".selMenu").select2({width:"element"}).change((e=>{const t=$(e.currentTarget);t.siblings("input").val(t.val());const a=t.closest(".effect-change"),s=t.find("option:selected");a.find(".mode select").val(s.attr("data-mode")),a.find(".value input").attr("placeholder",s.attr("data-ph")),t.blur()})),e.find(".select2").each(((e,t)=>{$(t)[0].style.removeProperty("width")}))}}},973:(e,t,a)=>{a.d(t,{Z:()=>DSA5StatusEffects});var s=a(947),i=a(577),n=a(472);class DSA5StatusEffects{static bindButtons(e){e.find(".chat-condition").each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(e=>{const t={data:{type:"condition",payload:{id:e.currentTarget.dataset.id}}};e.dataTransfer.setData("text/plain",JSON.stringify(t))}))})),e.on("click",".chat-condition",(e=>s.Z.postStatus(e.currentTarget.dataset.id)))}static createCustomEffect(e,t="",a){a=a||game.i18n.localize("CONDITION.custom"),""==t&&(t=a),e.addCondition({name:a,icon:"icons/svg/aura.svg",origin:e.uuid,flags:{dsa5:{value:null,editable:!0,description:t,custom:!0}}})}static prepareActiveEffects(e,t){let a=duplicate(CONFIG.statusEffects),s=[];t.conditions=[],t.transferedConditions=[];for(let a of e.effects.filter((t=>game.user.isGM||"Item"==e.documentName||!t.getFlag("dsa5","hidePlayers")))){a.disabled=a.disabled,a.boolean=null==a.getFlag("dsa5","value"),a.icon=a.icon;const i=[...a.statuses][0];i&&(a.value=a.getFlag("dsa5","value"),a.editable=a.getFlag("dsa5","editable"),a.descriptor=i,a.manual=a.getFlag("dsa5","manual"),s.push(i)),a.origin!=e.uuid&&a.origin||a.notApplicable?a.notApplicable||t.transferedConditions.push(a):t.conditions.push(a)}t.manualConditions=a.filter((e=>!s.includes(e.id)));const n=[];for(let t of Object.keys(e.system?.condition||{}))if(e.system.condition[t]){const a=i.Z.statusEffects.find((e=>e.id==t));a&&n.push({icon:a.icon,id:t,name:game.i18n.localize(a.name),value:e.system.condition[t]})}t.cumulativeConditions=n}static async addCondition(e,t,a=1,s=!1,i=!0){if(!e.isOwner)return"Not owned";if(e.compendium)return"Can not add in compendium";if(s&&a<1)return this.removeCondition(e,t,a,i,s);if("string"==typeof t&&(t=duplicate(CONFIG.statusEffects.find((e=>e.id==t)))),!t)return"No Effect Found";let n=this.hasCondition(e,t.id);return n&&null==n.flags.dsa5.value?n:n?await DSA5StatusEffects.updateEffect(e,n,a,s,i,t):await DSA5StatusEffects.createEffect(e,t,a,i)}static hasCondition(e,t){return!(null==e||!t)&&(!!e.effects&&e.effects.find((e=>e.statuses.has(t))))}static async removeCondition(e,t,a=1,s=!0,i=!1){if(!e.isOwner)return"Not owned";if("string"==typeof t&&(t=duplicate(CONFIG.statusEffects.find((e=>e.id==t)))),!t)return"No Effect Found";let n=this.hasCondition(e,t.id);if(n&&null==n.flags.dsa5.value){e.token&&(e=e.token.actor);return await e.deleteEmbeddedDocuments("ActiveEffect",[n.id])}return n?await DSA5StatusEffects.removeEffect(e,n,a,i,s):void 0}static immuneToEffect(e,t,a=!0){if(!t.id||!hasProperty(t,"flags.dsa5.max"))return;let s;if((getProperty(e,"system.immunities")||[]).includes(t.id)&&(s={name:e.name,condition:game.i18n.localize(`CONDITION.${t.id}`)}),!s&&"Actor"==e.documentName){const a=n.Z.detectCreatureType(e);for(let i of a)if(i.ignoredCondition(t.id)){s={name:`${e.name} (${i.getName()})`,condition:game.i18n.localize(`CONDITION.${t.id}`)};break}}if(!s||!ui.notifications||a)return;const i=game.i18n.format("DSAError.conditionInvalidToCreature",{name:s.name,condition:s.condition});ui.notifications.warn(i)}static resistantToEffect(e,t){const a=[...t.statuses][0];if(!a)return 0;return(getProperty(e,"system.resistances.effects")||[]).reduce(((e,t)=>(t.target==a&&(e+=Number(t.value)),e)),0)}static async createEffect(e,t,a,s){t.name=game.i18n.localize(t.name),this.immuneToEffect(e,t,!1),s?(t.flags.dsa5.auto=Math.min(t.flags.dsa5.max,a),t.flags.dsa5.manual=0):(t.flags.dsa5.manual=Math.min(t.flags.dsa5.max,a),t.flags.dsa5.auto=0),t.flags.dsa5.value=Math.min(4,t.flags.dsa5.manual+t.flags.dsa5.auto),t.id&&(t.statuses=[t.id]),"dead"==t.id&&(t["flags.core.overlay"]=!0);let i=await e.createEmbeddedDocuments("ActiveEffect",[duplicate(t)]);return delete t.id,i}static async removeEffect(e,t,a,s,i){const n=i?s?a:Math.max(0,t.flags.dsa5.auto-a):t.flags.dsa5.auto,r=i?t.flags.dsa5.manual:s?a:t.flags.dsa5.manual-a,o={flags:{dsa5:{auto:n,manual:r,value:Math.max(0,Math.min(t.flags.dsa5.max,r+n))}}};return o.flags.dsa5.auto<1&&0==o.flags.dsa5.manual?await e.deleteEmbeddedDocuments("ActiveEffect",[t.id]):await t.update(o)}static async updateEffect(e,t,a,s,i,n){let r,o,l;return this.immuneToEffect(e,t,!0),i?(o=Math.min(t.flags.dsa5.max,s?a:t.flags.dsa5.auto+a),r=o-t.flags.dsa5.auto,l={flags:{dsa5:{auto:o,manual:t.flags.dsa5.manual}}}):(o=s?a:t.flags.dsa5.manual+a,r=o-t.flags.dsa5.manual,l={flags:{dsa5:{manual:o,auto:t.flags.dsa5.auto}}}),0==r||(l.flags.dsa5.value=Math.max(0,Math.min(t.flags.dsa5.max,l.flags.dsa5.manual+l.flags.dsa5.auto)),n.duration&&(l.duration=n.duration,l.duration.startTime=game.time.worldTime),await t.update(l)),t}static calculateRollModifier(e,t,a,s={}){return null==e.flags.dsa5.value||"regenerate"==a.type?0:DSA5StatusEffects.clampedCondition(t,e)}static clampedCondition(e,t){const a=[...t.statuses][0];if(!a)return 0;const s=Number(t.flags.dsa5.max),i=-1*Math.clamped(e.system.condition[a]||0,0,s),n=this.resistantToEffect(e,t);return Math.clamped(i+n,-1*s,0)}static ModifierIsSelected(e,t={},a){return"damage"!=t.mode}static getDamageBonus(){return 0}static getRollModifiers(e,t,a={}){const s=game.i18n.localize("status")+"/"+game.i18n.localize("condition"),n=[],r=[];for(const i of e.effects){if(i.disabled)continue;const o=[...i.statuses][0],l=game.dsa5.config.statusEffectClasses[o]||DSA5StatusEffects,c=l.calculateRollModifier(i,e,t,a);o&&r.push(o),0!=c&&n.push({name:i.name,value:c,selected:l.ModifierIsSelected(t,a,e),source:s})}for(let[o,l]of Object.entries(e.system.condition))if(l&&!r.includes(o)){const r=duplicate(i.Z.statusEffects.find((e=>e.id==o)));if(!r)continue;const c=game.dsa5.config.statusEffectClasses[o]||DSA5StatusEffects;r.flags.dsa5.value=l,r.statuses=[o];const d=c.calculateRollModifier(r,e,t,a);0!=d&&n.push({name:r.name,value:d,selected:c.ModifierIsSelected(t,a,e),source:s})}return n}}i.Z.statusEffectClasses={inpain:class PainEffect extends DSA5StatusEffects{static ModifierIsSelected(e,t={},a){return null==a.effects.find((e=>Array.from(e.statuses).includes("bloodrush")))}},encumbered:class EncumberedEffect extends DSA5StatusEffects{static ModifierIsSelected(e,t={},a){const s="skill"==e.type&&"yes"==e.system.burden.value,i=["rangeweapon"].includes(e.type)&&"damage"!=t.mode&&game.settings.get("dsa5","encumbranceForRange"),n=!["skill","spell","ritual","ceremony","liturgy","rangeweapon"].includes(e.type)&&"damage"!=t.mode;return s||n||i}static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type||"skill"==a.type&&"no"==a.system.burden.value?0:super.calculateRollModifier(e,t,a,s)}},stunned:DSA5StatusEffects,raptured:class RaptureEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){const i=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),n=t.system.happyTalents.value.split(/;|,/).map((e=>e.replace(i,"").trim()));return n.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&n.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type)?-1*this.clampedCondition(t,e)-1:["ritual","spell","skill","combatskill"].includes(a.type)?this.clampedCondition(t,e):(a.type,0)}},feared:DSA5StatusEffects,paralysed:DSA5StatusEffects,confused:DSA5StatusEffects,prone:class ProneEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?0:"dodge"==a.type?-2:s.mode?"attack"==s.mode?-4:-2:0}},deaf:class DeafEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?0:"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.perception")?-3:0}},bloodrush:class BloodrushEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?0:"skill"==a.type?a.name==game.i18n.localize("LocalizedIDs.featOfStrength")?2:0:"attack"==s.mode?4:0}},trance:class TranceEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){if("regenerate"==a.type)return 0;switch(Number(this.clampedCondition(t,e))){case-2:const e=new RegExp(`${game.i18n.localize("combatskill")} `,"gi"),s=t.system.happyTalents.value.split(/;|,/).map((t=>t.replace(e,"").trim()));if(s.includes(a.name)&&["skill","combatskill"].includes(a.type)||["rangeweapon","meleeweapon"].includes(a.type)&&s.includes(a.system.combatskill.value)||["ceremony","liturgy"].includes(a.type))return-2;case-3:return-3}return 0}},drunken:class DrunkenEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?0:"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.gambling")?Math.clamped(this.clampedCondition(t,e),-3,0):0}},arousal:class ArousalEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return 0}},burning:class BurningEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?0:"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.bodyControl")?Math.clamped(this.clampedCondition(t,e)+1,-2,0):0}},sikaryanloss:class SikaryanlossEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.willpower")?2*(this.clampedCondition(t,e)+1):"regenerate"==a.type?this.clampedCondition(t,e):0}},desire:class DesireEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"skill"==a.type&&a.name==game.i18n.localize("LocalizedIDs.willpower")?Math.clamped(this.clampedCondition(t,e),-3,0):0}},theriak:class TheriakEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?-1*this.clampedCondition(t,e):0}},services:class NoModifierEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return 0}},sunken:class SunkenEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"skill"==a.type&&"body"==a.system.group.value?-1*Math.clamped(this.clampedCondition(t,e)-1,3,0):0}},hunger:class HungerEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){return"regenerate"==a.type?-1*Math.pow(this.clampedCondition(t,e)-1,2):0}},thirst:class ThirstEffect extends DSA5StatusEffects{static calculateRollModifier(e,t,a,s={}){const i=this.clampedCondition(t,e);return"regenerate"==a.type?1==i?-1:-5*i:Math.clamped(i-1,0,3)}}}},272:(e,t,a)=>{a.d(t,{Z:()=>AdvantageRulesDSA5});var s=a(577),i=a(794),n=a(492);class AdvantageRulesDSA5 extends i.Z{static setupFunctions(){}static async vantageAdded(e,t){game.dsa5.config.addvantageRules[t.name]&&game.dsa5.config.addvantageRules[t.name](e,t)}static async vantageRemoved(e,t,a=!0){game.dsa5.config.removevantageRules[t.name]&&game.dsa5.config.removevantageRules[t.name](e,t);let s=AdvantageRulesDSA5.calcAPCostSum(t);s=await AdvantageRulesDSA5.removeSingularVantages(e,t,s),await e._updateAPs(-1*s,{},{render:a})}static async _vantageReturnFunction(e,t,a,i){if(null==t)return;if(t=duplicate(t),/,/.test(t.system.APValue.value)){const a=t.name.replace(" ()","");t.system.APValue.value=t.system.APValue.value.split(",")[e.items.filter((e=>e.type==t.type&&e.name.includes(a))).length].trim()}null!=i&&(AdvantageRulesDSA5.simpleAdoption(t,i,t.name,s.Z.vantagesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${i.name})`,i.data&&(t.system.APValue.value=t.system.APValue.value.split("/")[i.system.StF.value.charCodeAt(0)-65].trim()));let n,r=e.items.find((e=>e.type==a&&e.name==t.name));if(r){let t=duplicate(r);n=Number(/;/.test(t.system.APValue.value)?t.system.APValue.value.split(";").map((e=>Number(e.trim())))[t.system.step.value]:t.system.APValue.value),t.system.step.value+1<=t.system.max.value&&await e.checkEnoughXP(n)&&(t.system.step.value+=1,n=this.addSingularVantages(e,t,n),await e._updateAPs(n,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[t]),await AdvantageRulesDSA5.vantageAdded(e,t))}else await e.checkEnoughXP(n=Number(t.system.APValue.value.split(";").map((e=>e.trim()))[0]))&&(await AdvantageRulesDSA5.vantageAdded(e,t),n=this.addSingularVantages(e,t,n),await e._updateAPs(n,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}static async needsAdoption(e,t,a){if(s.Z.vantagesNeedingAdaption[t.name]){let i,r;if("text"==s.Z.vantagesNeedingAdaption[t.name].items)i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:t}),r=function(s){let i={name:s.find('[name="entryselection"]').val()};AdvantageRulesDSA5._vantageReturnFunction(e,t,a,i)};else{let n=e.items.filter((e=>s.Z.vantagesNeedingAdaption[t.name].items.includes(e.type)));i=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:n,original:t}),r=function(s){let i=n.find((e=>e.name==s.find('[name="entryselection"]').val()));AdvantageRulesDSA5._vantageReturnFunction(e,t,a,i)}}await new n.Z({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:r},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else AdvantageRulesDSA5._vantageReturnFunction(e,t,a,null)}static addSingularVantages(e,t,a){return AdvantageRulesDSA5._calculateSingularVantages(t,e,a,((e,t,a)=>"disadvantage"==e.type&&t.test(e.name)))}static removeSingularVantages(e,t,a){return AdvantageRulesDSA5._calculateSingularVantages(t,e,a,((e,t,a)=>"disadvantage"==e.type&&t.test(e.name)&&e.name!=a.name))}static _calculateSingularVantages(e,t,a,s,i=((e,t)=>Math.min(0,e-t))){if("disadvantage"!=e.type)return a;for(const n of["principles","obligations"]){const r=new RegExp(`^${game.i18n.localize("LocalizedIDs."+n)} \\(`);if(r.test(e.name)){const n=t.items.filter((t=>s(t,r,e))),o=Math.min(0,...n.map((e=>AdvantageRulesDSA5.calcAPCostSum(e))));a=i(AdvantageRulesDSA5.calcAPCostSum(e),o)}}return a}static reduceSingularVantages(e,t,a){return AdvantageRulesDSA5._calculateSingularVantages(t,e,a,((e,t,a)=>"disadvantage"==e.type&&t.test(e.name)&&e.name!=a.name),((e,t)=>e<t?a:0))}static hasVantage(e,t){return super.hasItem(e,t,["advantage","disadvantage"])}static vantageStep(e,t){return super.itemStep(e,t,["advantage","disadvantage"])}static getVantageAsModifier(e,t,a=1,s=!1,i=!1){return super.itemAsModifier(e,t,a,["advantage","disadvantage"],s,i)}}i.Z.children.AdvantageRulesDSA5=AdvantageRulesDSA5},231:(e,t,a)=>{a.d(t,{Z:()=>DSA5ChatAutoCompletion});var s=a(947),i=a(903),n=a(491),r=a(416);class DSA5ChatAutoCompletion{static skills=[];static cmds=["sk","at","pa","sp","li","rq","gc","w","ch"];constructor(){0==DSA5ChatAutoCompletion.skills.length&&n.Z.allSkills().then((e=>{DSA5ChatAutoCompletion.skills=e.map((e=>({name:e.name,type:"skill"}))).concat(Object.values(game.dsa5.config.characteristics).map((e=>({name:game.i18n.localize(e),type:"attribute"}))).concat([{name:game.i18n.localize("regenerate"),type:"regeneration"},{name:game.i18n.localize("fallingDamage"),type:"fallingDamage"}]))})),this.filtering=!1,this.combatConstants={dodge:game.i18n.localize("dodge"),parryWeaponless:game.i18n.localize("parryWeaponless"),attackWeaponless:game.i18n.localize("attackWeaponless")}}get regex(){return new RegExp(`^/(${DSA5ChatAutoCompletion.cmds.join(" |")})`)}async chatListeners(e){let t=this;const a=e.find("#chat-message");e.on("keyup","#chat-message",(async function(e){t._parseInput(e)})),e.on("click",".quick-item",(async function(e){t._quickSelect($(e.currentTarget))})),a.on("keydown",(function(e){t._navigateQuickFind(e)}));const s=jQuery._data(a[0]).events.keydown;s.unshift(s.pop())}_parseInput(e){let t=e.target.value;if(this.regex.test(t)){if([38,40,13,9].includes(e.which))return!1;if(27==e.which)return this._closeQuickfind(e),!1;const a=this._getCmd(t),s=t.substring(1+a.length).toLowerCase().trim();this[`_filter${a}`](s,e),this.filtering=!0}else this._closeQuickfind(e)}_getCmd(e){return e.substring(1,3).toUpperCase().trim()}_completeCurrentEntry(e){$("#chat-message").val($("#chat-message").val().split(" ")[0]+" "+e.text())}_closeQuickfind(e){this.filtering=!1,$(e.currentTarget).closest("#chat-form").find(".quickfind").remove()}_filterW(e,t){let a=game.users.contents.filter((t=>t.active&&-1!=t.name.toLowerCase().trim().indexOf(e))).map((e=>({name:e.name,type:"user"})));this._checkEmpty(a),this._setList(a,"W",t)}_filterAT(e,t){const{actor:a,tokenId:s}=DSA5ChatAutoCompletion._getActor();if(a){let s=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"],n=a.items.filter((t=>(s.includes(t.type)&&1==t.system.worn.value||"trait"==t.type&&i.includes(t.system.traitType.value))&&-1!=t.name.toLowerCase().trim().indexOf(e))).slice(0,5).map((e=>({name:e.name,type:"item"}))).concat([{name:this.combatConstants.attackWeaponless,type:"item"}].filter((t=>-1!=t.name.toLowerCase().trim().indexOf(e))));this._checkEmpty(n),this._setList(n,"AT",t)}}_filterPA(e,t){const{actor:a,tokenId:s}=DSA5ChatAutoCompletion._getActor();if(a){let s=["meleeweapon"],i=a.items.filter((t=>s.includes(t.type)&&-1!=t.name.toLowerCase().trim().indexOf(e)&&1==t.system.worn.value)).slice(0,5).map((e=>({name:e.name,type:"item"}))).concat([{name:this.combatConstants.dodge,type:"item"},{name:this.combatConstants.parryWeaponless,type:"item"}].filter((t=>-1!=t.name.toLowerCase().trim().indexOf(e))));this._checkEmpty(i),this._setList(i,"PA",t)}}_filterSP(e,t){const{actor:a,tokenId:s}=DSA5ChatAutoCompletion._getActor();if(a){let s=["spell","ritual"],i=a.items.filter((t=>s.includes(t.type)&&-1!=t.name.toLowerCase().trim().indexOf(e))).slice(0,5).map((e=>({name:e.name,type:"item"})));this._checkEmpty(i),this._setList(i,"SP",t)}}_checkEmpty(e){e.length||e.push({name:game.i18n.localize("DSAError.noMatch"),type:"none"})}_filterLI(e,t){const{actor:a,tokenId:s}=DSA5ChatAutoCompletion._getActor();if(a){let s=["liturgy","ceremony"],i=a.items.filter((t=>s.includes(t.type)&&-1!=t.name.toLowerCase().trim().indexOf(e))).slice(0,5).map((e=>({name:e.name,type:"item"})));this._checkEmpty(i),this._setList(i,"LI",t)}}_getSkills(e,t){e=e.replace(/(-|\+)?\d+/g,"").trim();let a=DSA5ChatAutoCompletion.skills.filter((a=>-1!=a.name.toLowerCase().trim().indexOf(e)&&(null==t||t==a.type))).slice(0,5);return this._checkEmpty(a),a}_filterCH(e,t){this._setList(this._getSkills(e),"CH",t)}_filterSK(e,t){this._setList(this._getSkills(e),"SK",t)}_filterRQ(e,t){this._setList(this._getSkills(e),"RQ",t)}_filterGC(e,t){this._setList(this._getSkills(e,"skill"),"GC",t)}_setList(e,t,a){let s=$(`<div class="quickfind dsalist"><ul>${e.map((e=>`<li data-type="${e.type}" data-category="${t}" class="quick-item">${e.name}</li>`)).join("")}</ul></div>`);s.find(".quick-item:first").addClass("focus");const i=$(a.currentTarget).closest("#chat-form");let n=i.find(".quickfind");n.length?n.replaceWith(s):i.append(s)}_navigateQuickFind(e){if(this.filtering){let t=$(e.currentTarget).closest("#chat-form").find(".focus");switch(e.which){case 38:return t.prev(".quick-item").length&&t.removeClass("focus").prev(".quick-item").addClass("focus"),!1;case 40:return t.next(".quick-item").length&&t.removeClass("focus").next(".quick-item").addClass("focus"),!1;case 13:if("W"==t.attr("data-category"))break;return e.stopPropagation(),e.preventDefault(),this._quickSelect(t),!1;case 9:return e.stopPropagation(),e.preventDefault(),this._completeCurrentEntry(t),!1}}return!0}static _getActor(){const e=ChatMessage.getSpeaker();let t;return e.token&&(t=game.actors.tokens[e.token]),t||(t=game.actors.get(e.actor)),t?{actor:t,tokenId:e.token}:(ui.notifications.error(game.i18n.localize("DSAError.noProperActor")),{})}_quickSelect(e){let t=e.attr("data-category");switch(t){case"NM":case"GC":case"RQ":case"CH":this[`_quick${t}`](e);break;case"W":this._completeCurrentEntry(e);break;default:const{actor:a,tokenId:s}=DSA5ChatAutoCompletion._getActor();a&&(this._resetChatAutoCompletion(e),this[`_quick${t}`](e,a,s))}}_quickW(e,t,a){}_quickCH(e){s.Z.check3D20(e),this._resetChatAutoCompletion(e)}_quickSK(e,t,a){switch(e.attr("data-type")){case"skill":let s=t.items.find((t=>t.name==e.text()&&"skill"==t.type));s&&t.setupSkill(s,{},a).then((e=>{t.basicTest(e)}));break;case"attribute":let i=Object.keys(game.dsa5.config.characteristics).find((t=>game.i18n.localize(game.dsa5.config.characteristics[t])==e.text()));t.setupCharacteristic(i,{},a).then((e=>{t.basicTest(e)}));break;case"regeneration":t.setupRegeneration("regenerate",{},a).then((e=>{t.basicTest(e)}))}}_resetChatAutoCompletion(e){const t=e.closest("#chat-form");t.find("#chat-message").val(""),t.find(".quickfind").remove()}_quickGC(e){const t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(e),i.Z.showGCMessage(e.text(),t)}_quickRQ(e){const t=Number($("#chat-message").val().match(/(-|\+)?\d+/g))||0;this._resetChatAutoCompletion(e),i.Z.showRQMessage(e.text(),t)}_quickPA(e,t,a){let s=e.text();if(this.combatConstants.dodge==s)t.setupDodge({},a).then((e=>{t.basicTest(e)}));else if(this.combatConstants.parryWeaponless==s)t.setupWeaponless("parry",{},a).then((e=>{t.basicTest(e)}));else{let s=["meleeweapon"],i=t.items.find((t=>s.includes(t.type)&&t.name==e.text()));i&&t.setupWeapon(i,"parry",{},a).then((e=>{t.basicTest(e)}))}}_quickAT(e,t,a){let s=e.text();if(this.combatConstants.attackWeaponless==s)t.setupWeaponless("attack",{},a).then((e=>{t.basicTest(e)}));else{const s=["meleeweapon","rangeweapon"],i=["meleeAttack","rangeAttack"];let n=t.items.find((t=>s.includes(t.type)&&t.name==e.text()));n||(n=t.items.find((t=>"trait"==t.type&&t.name==e.text()&&i.includes(t.system.traitType.value)))),n&&t.setupWeapon(n,"attack",{},a).then((e=>{t.basicTest(e)}))}}_quickSP(e,t,a){const s=["ritual","spell"],i=t.items.find((t=>s.includes(t.type)&&t.name==e.text()));i&&t.setupSpell(i,{},a).then((e=>{t.basicTest(e)}))}_quickLI(e,t,a){const s=["liturgy","ceremony"],i=t.items.find((t=>s.includes(t.type)&&t.name==e.text()));i&&t.setupSpell(i,{},a).then((e=>{t.basicTest(e)}))}static async infoItemAsync(e){(await fromUuid(e)).postItem()}static bindRollCommands(e){e.on("click",".request-roll",(e=>(i.Z.showRQMessage(e.currentTarget.dataset.name,Number(e.currentTarget.dataset.modifier)||0),e.stopPropagation(),!1))),e.on("click",".postInfo",(e=>{const t=fromUuidSync(e.currentTarget.dataset.uuid);return t&&("function"==typeof t.postItem?t.postItem():this.infoItemAsync(e.currentTarget.dataset.uuid)),e.stopPropagation(),!1})),e.on("click",".postContentChat",(async e=>{const t=$(e.currentTarget).closest(".postChatSection").find(".postChatContent").html();r.TB.getDialog(t)})),e.on("click",".request-GC",(e=>(i.Z.showGCMessage(e.currentTarget.dataset.name,Number(e.currentTarget.dataset.modifier)||0),e.stopPropagation(),!1))),e.on("click",".request-CH",(e=>(s.Z.check3D20(void 0,e.currentTarget.dataset.name,{modifier:Number(e.currentTarget.dataset.modifier)||0}),e.stopPropagation(),!1)))}}},947:(e,t,a)=>{a.d(t,{Z:()=>DSA5ChatListeners});var s=a(577),i=a(491),n=a(586),r=a(122),o=a(147);class DSA5ChatListeners{static chatListeners(e){e.on("click",".openJournalBrowser",(()=>game.dsa5.apps.journalBrowser.render(!0)));let t=$('<a class="button showHelp" data-tooltip="HELP.showHelp"><i class="fas fa-question"></i></a>');t.click((()=>{DSA5ChatListeners.getHelp()})),$(e.find(".control-buttons")).prepend(t),e.on("click",".showPatchViewer",(()=>(0,n.j)())),e.on("click",".functionswitch",(e=>r.Z[e.currentTarget.dataset.function](e))),e.on("click",".panToToken",(e=>DSA5ChatListeners.panToToken(e))),e.on("click",".popoutImage",(e=>(0,o.d)(e)))}static async panToToken(e){const t=await fromUuid(e.currentTarget.dataset.uuid);t&&(canvas.animatePan({x:t.x,y:t.y}),t.isOwner&&t.object.control({releaseOthers:!0}))}static postStatus(e){let t=CONFIG.statusEffects.find((t=>t.id==e)),a=`<h2><a class="chat-condition chatButton" data-id="${e}"><img class="sender-image" style="background-color:black;margin-right: 8px;" src="${t.icon}"/>${game.i18n.localize(t.name)}</h2></a><p>${game.i18n.localize(t.description)}</p>`;ChatMessage.create(i.Z.chatDataSetup(a,"roll"))}static getHelp(){let e=s.Z.helpContent.map((e=>`<h2>${game.i18n.localize(`HELP.${e.name}`)}</h2>\n            <p><b>${game.i18n.localize("HELP.command")}</b>: ${e.command}</p>\n            <p><b>${game.i18n.localize("HELP.example")}</b>: ${e.example}</p>\n            <p><b>${game.i18n.localize("Description")}</b>: ${game.i18n.localize(`HELP.descr${e.name}`)}`)).join("")+`<br>\n            <p>${game.i18n.localize("HELP.default")}</p>`;ChatMessage.create(i.Z.chatDataSetup(e,"roll"))}static showConditions(){let e=duplicate(CONFIG.statusEffects).map((e=>(e.name=game.i18n.localize(e.name),e))).sort(((e,t)=>e.name.localeCompare(t.name))).map((e=>`<a class="chat-condition chatButton" data-id="${e.id}"><img src="${e.icon}"/>${e.name}</a>`)).join(" ");ChatMessage.create(i.Z.chatDataSetup(e,"roll"))}static async check3D20(e,t,a={}){let s=12;e?(e=e.get(0),t=await i.Z.skillByName(e.textContent),e.dataset.attrs&&(s=e.dataset.attrs.split("|"))):t&&(t=await i.Z.skillByName(t)),t&&(t=t.toObject()),t||(t={name:"3d20",type:"skill",system:{talentValue:{value:0},characteristic1:{value:"mu"},characteristic2:{value:"kl"},characteristic3:{value:"in"},RPr:{value:"no"},burden:{value:"no"}}});const n=await i.Z.emptyActor(s);n.setupSkill(t,a,"emptyActor").then((e=>{n.basicTest(e)}))}static async showTables(){const e=await renderTemplate("systems/dsa5/templates/tables/systemtables.html",{tables:s.Z.systemTables});ChatMessage.create(i.Z.chatDataSetup(e,"roll"))}}},577:(e,t,a)=>{a.d(t,{Z:()=>i});const s={statusEffects:[{icon:"icons/svg/skull.svg",id:"dead",name:"CONDITION.defeated",label:"CONDITION.defeated",description:"CONDITIONDESCRIPTION.defeated",flags:{dsa5:{value:null,editable:!0}}},{id:"inpain",name:"CONDITION.inpain",icon:"icons/svg/blood.svg",description:"CONDITIONDESCRIPTION.inpain",changes:[{key:"system.condition.inpain",mode:2,value:1}],flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"prone",name:"CONDITION.prone",icon:"icons/svg/falling.svg",description:"CONDITIONDESCRIPTION.prone",flags:{dsa5:{value:null,editable:!0}}},{id:"unconscious",name:"CONDITION.unconscious",icon:"icons/svg/unconscious.svg",description:"CONDITIONDESCRIPTION.unconscious",flags:{dsa5:{value:null,editable:!0}}},{id:"rooted",name:"CONDITION.rooted",icon:"icons/svg/net.svg",description:"CONDITIONDESCRIPTION.rooted",flags:{dsa5:{value:null,editable:!0}}},{id:"fixated",name:"CONDITION.fixated",icon:"icons/svg/padlock.svg",description:"CONDITIONDESCRIPTION.fixated",flags:{dsa5:{value:null,editable:!0}}},{id:"surprised",name:"CONDITION.surprised",icon:"icons/svg/hazard.svg",description:"CONDITIONDESCRIPTION.surprised",flags:{dsa5:{value:null,editable:!0}}},{id:"blind",name:"CONDITION.blind",icon:"icons/svg/blind.svg",description:"CONDITIONDESCRIPTION.blind",flags:{dsa5:{value:null,editable:!0}}},{id:"poisoned",name:"CONDITION.poisoned",icon:"icons/svg/poison.svg",description:"CONDITIONDESCRIPTION.poisoned",flags:{dsa5:{value:null,editable:!0}}},{id:"sick",name:"CONDITION.sick",icon:"icons/svg/biohazard.svg",description:"CONDITIONDESCRIPTION.sick",flags:{dsa5:{value:null,editable:!0}}},{id:"deaf",name:"CONDITION.deaf",icon:"icons/svg/deaf.svg",description:"CONDITIONDESCRIPTION.deaf",flags:{dsa5:{value:null,editable:!0}}},{id:"burning",name:"CONDITION.burning",icon:"icons/svg/fire.svg",description:"CONDITIONDESCRIPTION.burning",flags:{dsa5:{value:1,editable:!0,max:3}}},{id:"invisible",name:"CONDITION.invisible",icon:"icons/svg/circle.svg",description:"CONDITIONDESCRIPTION.invisible",flags:{dsa5:{value:null,editable:!0}}},{id:"constricted",name:"CONDITION.constricted",icon:"icons/svg/cave.svg",description:"CONDITIONDESCRIPTION.constricted",flags:{dsa5:{value:null,editable:!0}}},{id:"bloodrush",name:"CONDITION.bloodrush",icon:"icons/svg/bones.svg",description:"CONDITIONDESCRIPTION.bloodrush",changes:[{key:"system.skillModifiers.step",mode:0,value:"Kraftakt 2;Feat of Strength 2"}],flags:{dsa5:{value:null,editable:!0}}},{id:"mute",name:"CONDITION.mute",icon:"icons/svg/silenced.svg",description:"CONDITIONDESCRIPTION.mute",flags:{dsa5:{value:null,editable:!0}}},{id:"incapacitated",name:"CONDITION.incapacitated",icon:"icons/svg/sleep.svg",description:"CONDITIONDESCRIPTION.incapacitated",flags:{dsa5:{value:null,editable:!0}}},{id:"encumbered",name:"CONDITION.encumbered",icon:"icons/svg/anchor.svg",changes:[{key:"system.condition.encumbered",mode:2,value:1}],description:"CONDITIONDESCRIPTION.encumbered",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"stunned",name:"CONDITION.stunned",icon:"icons/svg/daze.svg",changes:[{key:"system.condition.stunned",mode:2,value:1}],description:"CONDITIONDESCRIPTION.stunned",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"raptured",name:"CONDITION.raptured",icon:"icons/svg/ice-aura.svg",changes:[{key:"system.condition.raptured",mode:2,value:1}],description:"CONDITIONDESCRIPTION.raptured",flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"feared",name:"CONDITION.feared",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.feared",changes:[{key:"system.condition.feared",mode:2,value:1}],flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"paralysed",name:"CONDITION.paralysed",icon:"icons/svg/paralysis.svg",description:"CONDITIONDESCRIPTION.paralysed",changes:[{key:"system.condition.paralysed",mode:2,value:1}],flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"confused",name:"CONDITION.confused",icon:"icons/svg/stoned.svg",description:"CONDITIONDESCRIPTION.confused",changes:[{key:"system.condition.confused",mode:2,value:1}],flags:{dsa5:{value:1,editable:!0,max:4}}},{id:"minorSpirits",name:"CONDITION.minorSpirits",icon:"icons/svg/terror.svg",description:"CONDITIONDESCRIPTION.minorSpirits",changes:[{key:"system.skillModifiers.global",mode:0,value:-1}],duration:{seconds:600},flags:{dsa5:{value:null,editable:!0}}},{id:"services",name:"PLAYER.services",icon:"icons/svg/aura.svg",description:"CONDITIONDESCRIPTION.services",flags:{dsa5:{value:1,editable:!0,max:500,hideOnToken:!0}}}],armorSubcategories:{0:4,1:5,2:6,3:8,4:9,5:13,6:12,7:11,8:10},weaponStabilities:{Blowpipes:10,Bows:4,Brawling:12,"Chain Weapons":10,Crossbows:6,Daggers:14,Discuses:12,Fans:13,"Fencing Weapons":8,"Impact Weapons":12,Lances:6,Pikes:12,Polearms:12,Shields:10,Slingshots:4,Swords:13,"Throwing Weapons":10,"Two-Handed Impact Weapons":11,"Two-Handed Swords":12,Whips:4},journalFontSizes:[8,10,12,14,16,18,20,24,28,32],styles:{"dsa5-immersive":"dsaStyle.immersive","dsa5-naked":"dsaStyle.naked"},fallingConditions:{normal:0,soft1:-1,soft2:-2,soft3:-3,soft4:-4,rough1:1,rough2:2,rough3:3,rough4:4},combatSkillSubCategories:{0:"COMBATSKILLCATEGORY.0",1:"COMBATSKILLCATEGORY.1",2:"COMBATSKILLCATEGORY.2",3:"COMBATSKILLCATEGORY.3",4:"COMBATSKILLCATEGORY.4"}};s.effectTextStyle=CONFIG.canvasTextStyle.clone(),s.effectTextStyle.fontSize="30",s.effectTextStyle.fontFamily="GentiumBasic",s.knownShortcuts={},s.gearModifyableCalculatedAttributes=["fatePoints","initiative","speed","astralenergy","karmaenergy","wounds","dodge","soulpower","toughness"],s.defaultWeapon={name:"default",type:"meleeweapon",effects:[],system:{type:"meleeweapon",crit:1,botch:20,reach:{value:"short"},damage:{value:"1d6"},atmod:{value:0,offHandMod:0},pamod:{value:0,offHandMod:0},guidevalue:{value:"ge/kk"},damageThreshold:{value:"5000"},worn:{offhand:!1}}},s.asyncHooks={postProcessDSARoll:[]},s.characteristics={mu:"CHAR.MU",kl:"CHAR.KL",in:"CHAR.IN",ch:"CHAR.CH",ff:"CHAR.FF",ge:"CHAR.GE",ko:"CHAR.KO",kk:"CHAR.KK"},s.equipmentTypes={misc:"Equipment.misc",clothes:"Equipment.clothes",tools:"Equipment.tools",light:"Equipment.light",healing:"Equipment.healing",bags:"Equipment.bags",wealth:"Equipment.wealth",writing:"Equipment.writing",alchemy:"Equipment.alchemy",service:"Equipment.service",luxus:"Equipment.luxus",blessed:"Equipment.blessed",food:"Equipment.food"},s.equipmentCategories=["meleeweapon","rangeweapon","equipment","ammunition","armor","poison","consumable","plant"],s.systemTables=[{name:"Defense",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"defenseBotchTableEnabled"}},{name:"Melee",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"meleeBotchTableEnabled"}},{name:"Range",attrs:'data-weaponless="false"',roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"dsa5",key:"rangeBotchTableEnabled"}},{name:"Liturgy",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}},{name:"Spell",attrs:"",roll:"botch-roll",pack:{de:"dsa5.patzer",en:"dsa5.botch"},setting:{module:"",key:""}}],s.morePackages={packages:{},names:{de:[],en:[]}},s.narrowSpaceModifiers={weaponshort:{attack:0,parry:0,label:"NarrowSpaceModifiers.weapon.short"},weaponmedium:{attack:-4,parry:-4,label:"NarrowSpaceModifiers.weapon.medium"},weaponlong:{attack:-8,parry:-8,label:"NarrowSpaceModifiers.weapon.long"},shieldshort:{attack:-2,parry:-2,label:"NarrowSpaceModifiers.shield.short"},shieldmedium:{attack:-4,parry:-3,label:"NarrowSpaceModifiers.shield.medium"},shieldlong:{attack:-6,parry:-4,label:"NarrowSpaceModifiers.shield.long"}},s.traditionArtifacts={Animistenwaffe:15,Bannschwert:15,Druidendolch:15,Druidensichel:12,Zauberkleidung:15,Magierkugel:12,Zauberinstrument:15,Narrenkappe:15,Hexenkessel:15,Krallenkette:12,Lebensring:12,Alchimistenschale:15,"Scharlatanische Zauberkugel":15,Sippenchronik:15,Schelmenspielzeug:12,Zauberstecken:0,Magierstab:18,Trinkhorn:12,Schuppenbeutel:18,"Kristallomantische Kristallkugel":15,Echsenhaube:12},s.moneyNames={D:"Money-D",S:"Money-S",H:"Money-H",K:"Money-K"},s.areaTargetTypes={cube:"rect",line:"ray",sphere:"circle",cone:"cone"},s.rangeMods={short:{damage:1,attack:2},medium:{damage:0,attack:0},long:{damage:-1,attack:-2},rangesense:{damage:-1,attack:-1},extreme:{damage:-2,attack:-4}},s.regnerationCampLocations={0:"regnerationCampLocations.normal","-1":"regnerationCampLocations.bad",1:"regnerationCampLocations.good"},s.regenerationInterruptOptions={0:"regenerationInterruptOptions.none","-1":"regenerationInterruptOptions.small","-2":"regenerationInterruptOptions.big"},s.targetMomevementOptions={0:"rangeMovementOptions.SLOW","-2":"rangeMovementOptions.FAST",2:"rangeMovementOptions.STATIONARY"},s.allowedforeignfields=["system.details.notes.value"],s.shooterMovementOptions={0:"rangeMovementOptions.SHOOTERSTATIONARY","-2":"rangeMovementOptions.SHOOTERMOVING","-4":"rangeMovementOptions.SHOOTERRUNNING"},s.mountedRangeOptionsSpecAb={STATIONARY:"0",SCHRITT:"0",TROT:"-5000",GALOPP:"-4"},s.mountedRangeOptions={STATIONARY:"0",SCHRITT:"-4",TROT:"-5000",GALOPP:"-8"},s.drivingArcherOptions={STATIONARY:"0",SCHRITT:"-2",GALOPP:"-4"},s.aimOptions={0:"aimOptions.0",2:"aimOptions.1",4:"aimOptions.2"},s.traitCategories={meleeAttack:"closeCombatAttacks",rangeAttack:"rangeCombatAttacks",armor:"armor",general:"general",familiar:"familiar",trick:"trick",training:"training",entity:"entityAbility",summoning:"summoningPackage"},s.ritualLocationModifiers={0:"-",1:"RITUALMODIFIER.holysite","-3":"RITUALMODIFIER.wrongsite"},s.ritualTimeModifiers={0:"-",1:"RITUALMODIFIER.matchingConstellation","-1":"RITUALMODIFIER.wrongConstellation"},s.ceremonyLocationModifiers={0:"-",2:"CEREMONYMODIFIER.holysite",1:"CEREMONYMODIFIER.temple","-1":"CEREMONYMODIFIER.otherTemple","-2":"CEREMONYMODIFIER.enemyGod","-3":"CEREMONYMODIFIER.archDemon","-4":"CEREMONYMODIFIER.nameless","-5":"CEREMONYMODIFIER.nemesis"},s.advancementCosts={A:[1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,4,5,6,7,8,9,10,11,12,13,14],B:[2,2,2,2,2,2,2,2,2,2,2,2,2,4,6,8,10,12,14,16,18,20,22,24,26,28],C:[3,3,3,3,3,3,3,3,3,3,3,3,3,6,9,12,15,18,21,24,27,30,33,36,39,42],D:[4,4,4,4,4,4,4,4,4,4,4,4,4,8,12,16,20,24,28,32,36,40,44,48,52,56],E:[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,30,45,60,75,90,105,120,135,150,165,180]},s.hooks={},s.startXP={900:"EXP.inexperienced",1e3:"EXP.average",1100:"EXP.experienced",1200:"EXP.competent",1400:"EXP.masterful",1700:"EXP.brillant",2100:"EXP.legendary"},s.helpContent=[{name:"pay",command:"/pay [0-9]+",example:"/pay 5.03"},{name:"getPaid",command:"/getPaid [0-9]+",example:"/getPaid 5.03"},{name:"quickAbility",command:"/sk [a-z]*, /sp [a-z]*, /li [a-z]*, /at [a-z]*, /pa [a-z]*",example:"/sk betören"},{name:"conditions",command:"/conditions",example:"/conditions"},{name:"tables",command:"/tables",example:"/tables"},{name:"request",command:"/rq",example:"/rq betören"},{name:"threeD20Check",command:"/ch",example:"/ch"},{name:"groupcheck",command:"/gc",example:"/gc"}],s.ceremonyTimeModifiers={0:"-",1:"CEREMONYMODIFIER.monthGod",2:"CEREMONYMODIFIER.celebration","-5":"CEREMONYMODIFIER.namelessDays"},s.mageLevels={mundane:"mundane",clerical:"clerical",magical:"magical"},s.specialAbilityCategories={general:"general",Combat:"Combat",fatePoints:"fatePoints",magical:"magical",clerical:"clerical",language:"language",animal:"animal",staff:"traditionArtifact",ceremonial:"ceremonialItem",pact:"pactgift"},s.addvantageRules={},s.removevantageRules={},s.vantagesNeedingAdaption={},s.addAbilityRules={},s.removeAbilityRules={},s.AbilitiesNeedingAdaption={},s.addTraitRules={},s.rangeWeaponModifiers={short:"RangeMod.short",medium:"RangeMod.medium",long:"RangeMod.long",rangesense:"RangeMod.rangesense",extreme:"RangeMod.extreme"},s.meleeRangesArray=["short","medium","long"],s.meleeRanges={short:"Range-short",medium:"Range-medium",long:"Range-long"},s.weapontypes={melee:"meleeweapon",range:"rangeweapon"},s.ammunitiongroups={"-":"-",arrow:"arrow",bolt:"bolt",bullet:"bullet",stone:"stone",dart:"dart",mag:"mag",infinite:"infinite"},s.combatskillsGuidevalues={ff:"CHAR.FF",ge:"CHAR.GE",kk:"CHAR.KK","ge/kk":"CHAR.GEKK"},s.skillDifficultyModifiers={eeasy:5,veasy:3,easy:1,challenging:0,difficult:-1,hard:-3,vhard:-5},s.magicResistanceModifiers={"-":"-",SK:"soulpower",ZK:"toughness"},s.sizeCategories={tiny:"SIZE.tiny",small:"SIZE.small",average:"SIZE.average",big:"SIZE.big",giant:"SIZE.giant"},s.tokenSizeCategories={tiny:.5,small:.8,average:1,big:2,giant:4},s.rangeSizeCategories={tiny:"RANGESIZE.tiny",small:"RANGESIZE.small",average:"RANGESIZE.average",big:"RANGESIZE.big",giant:"RANGESIZE.giant"},s.meleeSizeCategories={tiny:"MELEESIZE.tiny",small:"MELEESIZE.small",average:"MELEESIZE.average",big:"MELEESIZE.big",giant:"MELEESIZE.giant"},s.shieldSizes={short:"SIZE.small",medium:"SIZE.average",long:"SIZE.big"},s.rangeSizeModifier={tiny:-8,small:-4,average:0,big:4,giant:8},s.meleeSizeModifier={tiny:-4,small:0,average:0,big:0,giant:0},s.rangeVision={0:"VisionDisruption.step0","-2":"VisionDisruption.step1","-4":"VisionDisruption.step2","-6":"VisionDisruption.step3","-5000":"VisionDisruption.step4"},s.meleeRangeVision=e=>({"+0":"meleeVisionDisruption.0","-1":"meleeVisionDisruption.1","-2":"meleeVisionDisruption.2","-3":"meleeVisionDisruption.3",["attack"==e?"*0,5":"-5000"]:"meleeVisionDisruption.4"}),s.attributeDifficultyModifiers={eeasy:6,veasy:4,easy:2,challenging:0,difficult:-2,hard:-4,vhard:-6},s.skillDifficultyLabels={eeasy:"Skill-eeasy",veasy:"Skill-veasy",easy:"Skill-easy",challenging:"Skill-challenging",difficult:"Skill-difficult",hard:"Skill-hard",vhard:"Skill-vhard"},s.attributeDifficultyLabels={eeasy:"Attribute-eeasy",veasy:"Attribute-veasy",easy:"Attribute-easy",challenging:"Attribute-challenging",difficult:"Attribute-difficult",hard:"Attribute-hard",vhard:"Attribute-vhard"},s.skillGroups={body:"SKILL.body",social:"SKILL.social",knowledge:"SKILL.knowledge",trade:"SKILL.trade",nature:"SKILL.nature"},s.features=["Object","Spheres","Influence","Clairvoyance","Healing","Transformation","Telekinesis","Elemental","Illusion","Anti-Magic","Demonic","Temporal"],s.skillBurdens={yes:"yes",no:"no",maybe:"maybe"},s.StFs={A:"A",B:"B",C:"C",D:"D"},s.noteIcons={"Griffin Shield":"systems/dsa5/icons/thirdparty/griffinshield.svg","At Sea":"systems/dsa5/icons/thirdparty/at-sea.svg","Medieval Gate":"systems/dsa5/icons/thirdparty/medieval-gate.svg","Position Marker":"systems/dsa5/icons/thirdparty/position-marker.svg",River:"systems/dsa5/icons/thirdparty/river.svg",Trail:"systems/dsa5/icons/thirdparty/trail.svg"},CONFIG.time.roundTime=5,CONFIG.time.turnTime=0;const i=s},472:(e,t,a)=>{a.d(t,{Z:()=>CreatureType});var s=a(491);Hooks.once("i18nInit",(async()=>{if(!CreatureType.creatureData){const e=await fetch(`systems/dsa5/lazy/creaturetype/${game.i18n.lang}.json`);CreatureType.creatureData=await e.json(),CreatureType.magical=game.i18n.localize("WEAPON.magical"),CreatureType.clerical=game.i18n.localize("WEAPON.clerical"),CreatureType.silverPlated=game.i18n.localize("WEAPON.silverPlated"),game.dsa5.apps.CreatureType=CreatureType}}));class CreatureType{static creatureData;static magical;static clerical;constructor(e){this.creatureClass=e,this.spellImmunities=[],this.poisonImmunity=!1,this.diseaseImmunity=!1}static detectCreatureType(e){const t="creature"==e.type?e.system.creatureClass.value:e.system.details.species.value;return Object.keys(CreatureType.creatureData.types).filter((e=>t.indexOf(e)>=0)).map((e=>this.getClass(CreatureType.creatureData.types[e],t)))}static getClass(e,t){return new(0,{DemonType,ChimeraType,DaimonidType,DragonType,ElementalType,FairyType,GhostType,GolemType,HomunculiType,IntelligentCreatureType,PlantType,AnimalType,UndeadType,SupernaturalType,MagicalConstructType,WerCreatureType,VampireType}[e])(t)}getName(){return Object.keys(CreatureType.creatureData.types).find((e=>CreatureType.creatureData.types[e]==this.constructor.name))}static checkImmunity(e){const t=[];switch(e.preData.source.type){case"poison":case"disease":{const a=game.i18n.localize("LocalizedIDs.immuneTo")+" ("+e.preData.source.name+")";for(let s of game.user.targets){const i=s.actor,n=i.items.find((e=>e.name==a&&"advantage"==e.type));if(n)t.push({name:n.name,uuid:n.uuid,target:i.name,condition:e.preData.source.name});else{const a=CreatureType.detectCreatureType(s.actor);for(let s of a)if(s[`${e.preData.source.type}Immunity`]){t.push({name:e.preData.source.name,target:`${i.name} (${s.getName()})`,condition:e.preData.source.name});break}}}break}case"spell":case"ritual":for(let a of game.user.targets){const s=CreatureType.detectCreatureType(a.actor),i=e.preData.source.system.feature.split(",").map((e=>e.trim()));let n=!1;for(let r of s){for(let s of i)if(r.spellImmunities.includes(s)){t.push({name:e.preData.source.name,target:`${a.actor.name} (${r.getName()})`,condition:`${game.i18n.localize("feature")} ${s}`}),n=!0;break}if(n)break}}}return t}static creatureTypeName(e){if("creature"==e.type){const t=e.system.creatureClass.value;return Object.keys(CreatureType.creatureData.types).filter((e=>t.indexOf(e)>=0))[0]}return e.system.details.species.value}static addCreatureTypeModifiers(e,t,a,s){const i=CreatureType.detectCreatureType(e),n=["spell","ceremony","liturgy","ritual"].includes(t.type);for(let s of i){const i=s.damageModifier(t);if(n)for(let t of i)t.armorPen=s.spellResistanceModifier(e);a.push(...i)}a.push(...this.creatureBonusDamage(e,s)),CreatureType.addVulnerabilitiesToSource(e,t,a)}static addVulnerabilitiesToSource(e,t,a){const s=getProperty(e,"system.vulnerabilities");if(s&&["meleeweapon","rangeweapon"].includes(t.type)){getProperty(s,"combatskill").reduce(((e,s)=>{if(s.target==t.system.combatskill.value){const e=(/\*/.test(s.value)?Number(s.value.replace("*",""))>1:Number(s.value)>0)?"WEAPON.vulnerableTo":"WEAPON.resistantTo";a.push(...CreatureType.buildDamageMod(`${game.i18n.format(e,{name:t.system.combatskill.value})} (${s.source})`,s.value))}}),a)}}ignoredCondition(e){return!1}damageModifier(e){return[]}static creatureBonusDamage(e,t){const a=[],s="creature"==e.type?e.system.creatureClass.value:e.system.details.species.value,i=getProperty(t,"system.creatureBonus");for(let e of i)s.indexOf(e.target)>=0&&a.push(...this.buildDamageMod(e.source,e.value,!0));return a}spellImmunity(e){return this.spellImmunities.some((t=>e.includes(t)))}spellArmorModifier(e){return 0}poisonImmunity(){return this.poisonImmunity}diseaseImmunity(){return this.diseaseImmunity}spellResistanceModifier(e){return 0}static buildDamageMod(e,t,a=!0){return[{name:e,value:t,selected:a,type:"dmg",source:game.i18n.localize("target")}]}weaponAttributes(e){return getProperty(e,"system.effect.attributes")||""}getTypeByClass(e){return Object.keys(CreatureType.creatureData.types).find((t=>CreatureType.creatureData.types[t]===e))}isAttackItem(e){return["meleeweapon","trait","rangeweapon"].includes(e.type)&&!(!(t=this.weaponAttributes(e))||0===t.length);var t}attributesRegex(e){const t=this.weaponAttributes(e);return new RegExp(`(${t.split(",").map((e=>s.Z.escapeRegex(e.split("(")[0].trim()))).join("|")})`,"i")}}class VulnerableToLifeGods extends CreatureType{damageModifier(e){if(this.isAttackItem(e)){const t=this.attributesRegex(e);for(const e of CreatureType.creatureData.godOfLife){const a=`${CreatureType.clerical} (${e})`;if(t.test(a))return CreatureType.buildDamageMod(a,"*2")}}return super.damageModifier(e)}}class ChimeraType extends VulnerableToLifeGods{}class DaimonidType extends CreatureType{constructor(e){super(e),this.spellImmunities=["Influence","Transformation"].map((e=>game.i18n.localize(`Features.${e}`)))}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(CreatureType.clerical))return CreatureType.buildDamageMod(CreatureType.clerical,"*2")}return super.damageModifier(e)}}class DragonType extends CreatureType{}class DemonType extends CreatureType{constructor(e){super(e),this.spellImmunities=["Influence","Transformation","Healing","Illusion"].map((e=>game.i18n.localize(`Features.${e}`))),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){const t=this.attributesRegex(e);if(t.test(CreatureType.clerical))return CreatureType.buildDamageMod(`${CreatureType.clerical} (${CreatureType.creatureData.opposingGod})`,"*2",!1);if(t.test(CreatureType.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return CreatureType.buildDamageMod(this.getTypeByClass("DemonType"),"*0.5")}spellArmorModifier(e){return Number(e.system.status.soulpower.max)}spellResistanceModifier(e){return Number(e.system.status.soulpower.max)}ignoredCondition(e){return!0}}class ElementalType extends CreatureType{constructor(e){super(e),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(CreatureType.magical))return super.damageModifier(e)}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return CreatureType.buildDamageMod(this.getTypeByClass("ElementalType"),"*1");return CreatureType.buildDamageMod(this.getTypeByClass("ElementalType"),"*0.5")}spellArmorModifier(e){return Number(e.system.status.soulpower.max)}spellResistanceModifier(e){return Number(e.system.status.soulpower.max)}ignoredCondition(e){return!0}}class FairyType extends CreatureType{constructor(e){super(e),this.spellImmunities=["Illusion"].map((e=>game.i18n.localize(`Features.${e}`))),this.poisonImmunity=!0,this.diseaseImmunity=!0}}class GhostType extends CreatureType{constructor(e){super(e),this.spellImmunities=["Illusion","Healing","Telekinesis","Transformation"].map((e=>game.i18n.localize(`Features.${e}`))),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){let t=this.attributesRegex(e);for(const e of CreatureType.creatureData.godOfDeath){const a=`${CreatureType.clerical} (${e})`;if(t.test(a))return[]}if(t=this.attributesRegex(e),t.test(CreatureType.clerical))return CreatureType.buildDamageMod(CreatureType.clerical,"*0.5");if(t.test(CreatureType.magical))return CreatureType.buildDamageMod(CreatureType.magical,"*0.5")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return CreatureType.buildDamageMod(CreatureType.magical,"*0.5");return CreatureType.buildDamageMod(this.getTypeByClass("GhostType"),"*0")}ignoredCondition(e){return!["feared","inpain","confused"].includes(e)}}class GolemType extends VulnerableToLifeGods{constructor(e){super(e),this.spellImmunities=["Transformation"].map((e=>game.i18n.localize(`Features.${e}`))),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["confused","paralysed"].includes(e)}}class HomunculiType extends VulnerableToLifeGods{constructor(e){super(e),this.spellImmunities=["Healing"].map((e=>game.i18n.localize(`Features.${e}`)))}ignoredCondition(e){return!["inpain","encumbered","stunned","feared","paralysed","confused"].includes(e)}}class IntelligentCreatureType extends CreatureType{}class PlantType extends CreatureType{}class AnimalType extends CreatureType{}class UndeadType extends CreatureType{constructor(e){super(e),this.spellImmunities=["Influence","Healing","Illusion"].map((e=>game.i18n.localize(`Features.${e}`))),this.poisonImmunity=!0,this.diseaseImmunity=!0}damageModifier(e){if(this.isAttackItem(e)){const t=this.attributesRegex(e);for(const e of CreatureType.creatureData.godOfDeath){const a=`${CreatureType.clerical} (${e})`;if(t.test(a))return CreatureType.buildDamageMod(a,"*2")}}return super.damageModifier(e)}ignoredCondition(e){return!["paralysed"].includes(e)}}class SupernaturalType extends CreatureType{}class MagicalConstructType extends CreatureType{constructor(e){super(e),this.spellImmunities=["Transformation"].map((e=>game.i18n.localize(`Features.${e}`))),this.poisonImmunity=!0,this.diseaseImmunity=!0}ignoredCondition(e){return!["stunned","feared","paralysed","confused"].includes(e)}}class WerCreatureType extends CreatureType{damageModifier(e){if(this.isAttackItem(e)){if(this.attributesRegex(e).test(CreatureType.silverPlated))return CreatureType.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*2")}else if(["spell","ceremony","liturgy","ritual"].includes(e.type))return super.damageModifier(e);return CreatureType.buildDamageMod(this.getTypeByClass("WerCreatureType"),"*0.5")}}class VampireType extends CreatureType{damageModifier(e){return["spell","ceremony","liturgy","ritual"].includes(e.type)?super.damageModifier(e):CreatureType.buildDamageMod(this.getTypeByClass("VampireType"),"*0.5")}}},565:(e,t,a)=>{a.d(t,{Z:()=>DPS});class DPS{static rangeFinder(e,t){const a=canvas.scene.grid.size,s=new Ray(e,t).distance/a,i=s*canvas.scene.grid.distance,n=Math.abs((getProperty(e,"system.elevation")||0)-(getProperty(t,"system.elevation")||0));return{elevation:n,distance:i,distanceSum:Math.hypot(i,n),tileDistance:s,unit:canvas.scene.grid.units}}static inDistance(e){for(let t of canvas.scene.tokens)if(t.isOwner&&DPS.rangeFinder(e,t.object).tileDistance<=2)return!0;return!1}static get isEnabled(){const e=canvas?.scene?.getFlag("dsa5","enableDPS");return e?"2"==e:game.settings.get("dsa5","enableDPS")}static distanceModifier(e,t,a){if(!DPS.isEnabled||!e)return 1;let s={};for(let t of game.user.targets){const a=DPS.rangeFinder(e,t);(s.distanceSum||0)<a.distanceSum&&(s=a)}if(s.unit==game.i18n.localize("gridUnits")){const e=Number(getProperty(a,"system.rangeMultiplier"))||1,i=t.system.reach.value.split("/").map((t=>Number(t)*e));let n=0;for(;n<2&&i[n]<s.distanceSum;)n++;return n}return 1}static initDoorMinDistance(){const e=DoorControl.prototype._onMouseDown;DoorControl.prototype._onMouseDown=function(t){return game.user.isGM||!DPS.isEnabled||DPS.inDistance(this)?e.apply(this,arguments):ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"))}}}Hooks.on("renderSceneConfig",((e,t,a)=>{const s=getProperty(e.object,"flags.dsa5.enableDPS"),i=`<div class="form-group dpsSelector">\n        <label data-tooltip="DSASETTINGS.enableDPSHint">${game.i18n.localize("DSASETTINGS.enableDPS")}</label>\n        <select name="flags.dsa5.enableDPS">\n            <option value="" ${""==s?"selected":""}>${game.i18n.localize("globalConfig")}</option>\n            <option value="2" ${"2"==s?"selected":""}>${game.i18n.localize("yes")}</option>\n            <option value="1" ${"1"==s?"selected":""}>${game.i18n.localize("no")}</option>\n        </select>\n    </div>`;t.find(".dpsSelector").remove(),t.find('.tab[data-tab="grid"]').append(i)}))},562:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DiceDSA5});var _actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(369),_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(577),_dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(538),_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(491),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(272),_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(173),_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(101),_item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(839),_status_status_effects_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(973),_opposed_dsa5_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(600),_status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(61),_dsa_soundeffect_js__WEBPACK_IMPORTED_MODULE_18__=__webpack_require__(803),_equipment_damage_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(702),_dialog_dialog_equipmentdamage_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(266),_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(430),_request_roll_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(903),_measuretemplate_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(174),_tables_tableEffects_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(585),_creature_type_js__WEBPACK_IMPORTED_MODULE_17__=__webpack_require__(472);class DiceDSA5{static async rollTest(e){let t;switch(e.source.type){case"ceremony":case"ritual":case"liturgy":case"spell":t=await this.rollSpell(e);break;case"skill":t=await this.rollTalent(e);break;case"combatskill":t=await this.rollCombatskill(e);break;case"trait":"parry"==e.mode&&await this.updateDefenseCount(e),t="damage"==e.mode?await this.rollDamage(e):await this.rollCombatTrait(e);break;case"regenerate":t=await this.rollRegeneration(e);break;case"meleeweapon":case"rangeweapon":"parry"==e.mode&&await this.updateDefenseCount(e),t="damage"==e.mode?await this.rollDamage(e):await this.rollWeapon(e);break;case"dodge":await this.updateDefenseCount(e),t=await this.rollStatus(e);break;case"poison":case"disease":t=await this.rollItem(e);break;case"fallingDamage":t=await this.rollFallingDamage(e);break;default:t=await this.rollAttribute(e)}return mergeObject(t,deepClone(e.extra)),t}static async rollDices(e,t){if(!e.roll){const a=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration;let s;switch(e.source.type){case"liturgy":case"spell":case"ceremony":case"ritual":case"skill":s=await new Roll("1d20+1d20+1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,a(e.source.system.characteristic1.value)),mergeObject(s.dice[1].options,a(e.source.system.characteristic2.value)),mergeObject(s.dice[2].options,a(e.source.system.characteristic3.value));break;case"regenerate":const t=[];e.regenerateLeP&&t.push([game.settings.get("dsa5","lessRegeneration")?"1d3":"1d6"]),e.extra.actor.isMage&&e.regenerateAsP&&t.push("1d6"),e.extra.actor.isPriest&&e.regenerateKaP&&t.push("1d6"),s=await new Roll(t.join("+")).evaluate({async:!0}),e.regenerateLeP&&mergeObject(s.dice[0].options,a("mu")),e.extra.actor.isMage&&e.regenerateAsP&&mergeObject(s.dice[t.length-1].options,a("ge")),e.extra.actor.isPriest&&e.regenerateKaP&&mergeObject(s.dice[t.length-1].options,a("in")),e.extra.actor.isMage&&e.regenerateAsP&&e.extra.actor.isPriest&&e.regenerateKaP&&mergeObject(s.dice[t.length-2].options,a("ge"));break;case"meleeweapon":case"rangeweapon":case"weaponless":case"combatskill":case"trait":if("damage"==e.mode){let t=await this.damageFormula(e);s=await new Roll(t).evaluate({async:!0});for(let e=0;e<s.dice.length;e++)mergeObject(s.dice[e].options,a("damage"))}else s=await new Roll("1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,a(e.mode));break;case"dodge":s=await new Roll("1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,a("dodge"));break;case"poison":case"disease":let i=a("in");s=await new Roll("1d20+1d20+1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,i),mergeObject(s.dice[1].options,i),mergeObject(s.dice[2].options,i);break;case"fallingDamage":const n=await this._situationalModifiers(e),r=`${e.fallingHeight}d6+${n}-${e.extra.options.availableQs||0}`;s=await new Roll(r).evaluate({async:!0});break;default:s=await new Roll("1d20").evaluate({async:!0}),mergeObject(s.dice[0].options,a(e.source.system.attr))}s=await DiceDSA5.manualRolls(s,e.source.type,e.extra.options),await this.showDiceSoNice(s,t.rollMode),e.roll=s,e.rollMode=t.rollMode}return e}static async setupDialog({dialogOptions:e,testData:t,cardOptions:a}){let s=await game.settings.get("core","rollMode"),i="challenging";"function"==typeof t.source.toObject&&(t.source=t.source.toObject(!1)),mergeObject(t,{testDifficulty:i}),mergeObject(e.data,{testDifficulty:i,testModifier:e.data.modifier||0});let n=e.data.situationalModifiers||(t.extra.actor?_status_status_effects_js__WEBPACK_IMPORTED_MODULE_8__.Z.getRollModifiers(t.extra.actor,t.source):[]);null!=t.extra.options.moreModifiers&&n.push(...t.extra.options.moreModifiers);let r=[];if(game.user.targets.forEach((e=>{e.actor&&r.push({name:e.actor.name,id:e.id,img:e.actor.img})})),mergeObject(e.data,{hasSituationalModifiers:n.length>0,situationalModifiers:n,rollMode:e.data.rollMode||s,rollModes:CONFIG.Dice.rollModes,defenseCount:await this.getDefenseCount(t),targets:r}),mergeObject(a,{user:game.user.id}),t.extra.options.bypass)return a.rollMode=t.extra.options.rollMode||s,t.situationalModifiers||(t.situationalModifiers=[]),{testData:t,cardOptions:a};{let a=_dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z.getDialogForItem(t,e.data),s=await renderTemplate(e.template,e.data);return new Promise(((i,n)=>{new a({title:e.title,content:s,buttons:a.getRollButtons(t,e,i,n),default:"rollButton"}).recallSettings(t.extra.speaker,t.source,t.mode,e.data).render(!0)}))}}static async getDefenseCount(e){return game.combat?await game.combat.getDefenseCount(e.extra.speaker):0}static async _rollSingleD20(e,t,a,s,i,n="",r=1){let o="",l=[];t+=s;let c=(t=Math.round(t*r))-e.terms[0].results[0].result;const d=game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration(a);l.push({char:a,res:e.terms[0].results[0].result,suc:c>=0,tar:t});let m=await new Roll("1d20").evaluate({async:!0}),u=c>=0?1:-1,g=20,p=1;if("meleeweapon"==i.source.type&&(g=Math.min(i.extra.actor.system.meleeStats.botch,i.source.system.botch),p=Math.max(i.extra.actor.system.meleeStats.crit,i.source.system.crit)),"rangeweapon"==i.source.type&&(g=Math.min(i.extra.actor.system.rangeStats.botch,i.source.system.botch),p=Math.max(i.extra.actor.system.rangeStats.crit,i.source.system.crit)),/(\(|,)( )?i\)$/.test(i.source.name)&&(_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.hasAbility(i.extra.actor,game.i18n.localize("LocalizedIDs.improvisedWeaponMaster"))||(g=Math.min(19,g)),this._appendSituationalModifiers(i,`${game.i18n.localize("CHAR.ATTACK")} - ${game.i18n.localize("WEAPON.improvised")}`,2,"defenseMalus")),i.situationalModifiers.find((e=>e.name==game.i18n.localize("opportunityAttack")&&0!=e.value))&&(g=50,p=-50),1==e.terms[0].results.filter((e=>e.result<=p)).length)if(o=game.i18n.localize("CriticalSuccess"),game.settings.get("dsa5","noConfirmationRoll"))u=3;else{m=await DiceDSA5.manualRolls(m,"confirmationRoll",i.extra.options);let e=t-m.terms[0].results[0].result;if(_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(i.extra.actor,`${game.i18n.localize("LocalizedIDs.weaponAptitude")} (${n})`)&&!(e>=0)){let a=m.terms[0].results[0].result;m=await new Roll("1d20").evaluate({async:!0}),e=t-m.terms[0].results[0].result,o+=", "+game.i18n.format("usedWeaponExpertise",{a,b:m.terms[0].results[0].result})}this._addRollDiceSoNice(i,m,d),l.push({char:a,res:m.terms[0].results[0].result,suc:e>=0,tar:t}),u=e>=0?3:2}else if(1==e.terms[0].results.filter((e=>e.result>=g)).length)if(o=game.i18n.localize("CriticalFailure"),game.settings.get("dsa5","noConfirmationRoll"))u=-3;else{m=await DiceDSA5.manualRolls(m,"confirmationRoll",i.extra.options);let e=t-m.terms[0].results[0].result;if(_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(i.extra.actor,`${game.i18n.localize("LocalizedIDs.weaponAptitude")} (${n})`)&&!(e>=0)){let a=m.terms[0].results[0].result;m=await new Roll("1d20").evaluate({async:!0}),e=t-m.terms[0].results[0].result,o+=", "+game.i18n.format("usedWeaponExpertise",{a,b:m.terms[0].results[0].result})}this._addRollDiceSoNice(i,m,d),l.push({char:a,res:m.terms[0].results[0].result,suc:e>=0,tar:t}),u=e>=0?-2:-3}return""==o?o=game.i18n.localize(c>=0?"Success":"Failure"):game.settings.get("dsa5","noConfirmationRoll")||(3==Math.abs(u)?o=`${game.i18n.localize("confirmed")} ${o}`:2==Math.abs(u)&&(o=`${game.i18n.localize("unconfirmed")} ${o}`)),{successLevel:u,characteristics:l,description:o,preData:i,modifiers:s,extra:{}}}static async rollFallingDamage(e){let t=e.roll;const a=[];for(let e of t.terms[0].results)a.push({char:"damage",res:e.result,suc:!1});return{rollType:"fallingDamage",preData:e,modifiers:await this._situationalModifiers(e),extra:{},damage:Math.max(0,t.total),formula:t.formula,characteristics:a}}static async rollRegeneration(e){let t=await this._situationalModifiers(e),a=e.roll,s=[],i={rollType:"regenerate",preData:e,modifiers:t,extra:{}};const n=[];e.regenerateLeP&&n.push("LeP"),e.extra.actor.system.isMage&&e.regenerateAsP&&n.push("AsP"),e.extra.actor.system.isPriest&&e.regenerateKaP&&n.push("KaP");let r=0;if(e.extra.actor.effects.some((e=>e.statuses.includes("sick")))){this._appendSituationalModifiers(e,game.i18n.localize("CONDITION.sick"),"*0");for(let e of n)s.push({char:e,res:0,die:"d6"}),i[e]=0,r+=2}else for(let o of n)this._appendSituationalModifiers(e,game.i18n.localize(`LocalizedIDs.regeneration${o}`),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(e.extra.actor,game.i18n.localize(`LocalizedIDs.regeneration${o}`)),o),this._appendSituationalModifiers(e,game.i18n.localize(`LocalizedIDs.weakRegeneration${o}`),-1*_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(e.extra.actor,game.i18n.localize(`LocalizedIDs.weakRegeneration${o}`)),o),this._appendSituationalModifiers(e,game.i18n.localize(`LocalizedIDs.advancedRegeneration${o}`),_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.abilityStep(e.extra.actor,game.i18n.localize(`LocalizedIDs.advancedRegeneration${o}`)),o),this._appendSituationalModifiers(e,`${game.i18n.localize(`CHARAbbrev.${o}`)} ${game.i18n.localize("Modifier")}`,e[`${o}Modifier`],o),this._appendSituationalModifiers(e,`${game.i18n.localize(`CHARAbbrev.${o}`)} ${game.i18n.localize("regenerate")}`,e[`regeneration${o}`],o),s.push({char:o,res:a.terms[r].results[0].result,die:"d6"}),i[o]=Math.round(Math.max(0,Number(a.terms[r].results[0].result)+Number(t)+await this._situationalModifiers(e,o))*Number(e.regenerationFactor)),r+=2;return i.characteristics=s,i}static async rollStatus(e){let t=e.roll||await new Roll("1d20").evaluate({async:!0}),a=await this._rollSingleD20(t,e.source.system.max,e.extra.statusId,await this._situationalModifiers(e),e,"",this._situationalMultipliers(e));a.rollType="dodge";const s="dodge"==e.extra.statusId;return s&&3==a.successLevel?await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("criticalMeleeDefense")?a.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("criticalMeleeDefense",!1,e,e):a.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.defaultParryCrit():s&&-3==a.successLevel&&(await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("Defense")?a.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("Defense",!0,e,e):a.description+=await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.defaultBotch()),a}static async rollAttribute(e){let t=e.roll?e.roll:await new Roll("1d20").evaluate({async:!0});this._appendSituationalModifiers(e,game.i18n.localize("Difficulty"),e.testDifficulty);let a=await this._rollSingleD20(t,e.source.system.value,e.extra.characteristicId,await this._situationalModifiers(e),e,"",this._situationalMultipliers(e));return a.rollType="attribute",a}static async damageFormula(e){let t;if("meleeweapon"==e.source.type){const a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(e.extra.actor.items.find((t=>"combatskill"==t.type&&t.name==e.source.system.combatskill.value)),e.extra.actor.system);t=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareMeleeWeapon(e.source,[a],e.extra.actor)}else if("rangeweapon"==e.source.type){const a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(e.extra.actor.items.find((t=>"combatskill"==t.type&&t.name==e.source.system.combatskill.value)),e.extra.actor.system);t=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareRangeWeapon(e.source,[],[a],e.extra.actor)}else t=e.source.system;return e.source.system.damage.value.replace(/[Ww]/g,"d")+`+${t.extraDamage||0}`}static async rollDamage(e){let t=await this._situationalModifiers(e),a=[],s=e.roll,i=s.total+t;for(let t of s.terms)if(t instanceof Die||"Die"==t.class)for(let s of t.results)a.push({char:e.mode,res:s.result,die:"d"+t.faces});return{rollType:"damage",damage:i,characteristics:a,preData:e,modifiers:t,extra:{}}}static async _situationalModifiers(e,t=""){let a=0;for(let s of e.situationalModifiers){if(null==s.value)continue;const e=Number(s.value)||await this._stringToRoll(s.value);a+=s.type==t||""==t&&null==s.type?e:0}return a}static _situationalPartCheckModifiers(e){return e.situationalModifiers.reduce((function(e,t){if("TPM"==t.type){const a=t.value.split("|");return 3!=a.length||(e[0]=e[0]+Number(a[0]),e[1]=e[1]+Number(a[1]),e[2]=e[2]+Number(a[2])),e}return e}),[0,0,0])}static _situationalMultipliers(e){return e.situationalModifiers.reduce((function(e,t){return e*("*"==t.type&&Number(`${t.value}`.replace(/,/,"."))||1)}),1)}static _appendSituationalModifiers(e,t,a,s=""){let i=e.situationalModifiers.find((e=>e.name==t));i?i.value=a:e.situationalModifiers.push({name:t,value:a,type:s})}static async rollCombatTrait(e){let t=e.roll||await new Roll("1d20").evaluate({async:!0}),a=e.source;const s="meleeAttack"==a.system.traitType.value,i="attack"==e.mode;if(s){let t={system:{combatskill:{value:"-"},reach:{value:a.system.reach.value}}};this._appendSituationalModifiers(e,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(t,e))}let n=await this._rollSingleD20(t,Number(i?a.system.at.value:a.system.pa),e.mode,await this._situationalModifiers(e),e,"",this._situationalMultipliers(e)),r=n.successLevel>0;await this.detailedWeaponResult(n,e,a),i&&r&&await DiceDSA5.evaluateDamage(e,n,a,!s,n.doubleDamage),n.rollType="weapon";const o=DiceDSA5.parseEffect(a);return o&&(n.parsedEffect=o),n}static async _stringToRoll(e,t){const a=[],s=/\d{1}[dDwW]\d/g,i=`${e}`;i.replace(s,(function(e){a.push(new Roll(e.replace(/[Ww]/,"d")).evaluate({async:!0}))}));const n=await Promise.all(a),r=i.replace(s,(()=>{const e=n.shift();return t&&DiceDSA5._addRollDiceSoNice(t,e,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("ch")),e.total}));return await Roll.safeEval(r)}static async evaluateDamage(e,t,a,s,i){let n=a.system.damage.value.replace(/[Ww]/g,"d"),r=[],o=a.dmgMultipliers||[],l=o.map((e=>`${e.name} *${e.val}`)),c=[],d=0;for(let t of e.situationalModifiers){let a=0;if(t.armorPen&&c.push(t.armorPen),t.damageBonus){if(/^\*/.test(t.damageBonus)){o.push({name:t.name,val:Number(t.damageBonus.replace("*",""))});continue}const s=/^=/.test(t.damageBonus),i=`${t.damageBonus}`.replace(/^=/,"");let l=await DiceDSA5._stringToRoll(i,e);if(a=l*(t.step||1),s){n=i.replace(/[Ww]/,"d"),r.push({name:t.name,roll:l});continue}t.damageBonus=l,d+=a}}let m=e.damageRoll?e.damageRoll:await DiceDSA5.manualRolls(await new Roll(n).evaluate({async:!0}),"CHAR.DAMAGE",e.extra.options),u=m.total,g=0;for(let e of m.terms)if(e instanceof Die||"Die"==e.class)for(let a of e.results)g+=Number(a.result),t.characteristics.push({char:"damage",res:a.result,die:"d"+e.faces});let p=u-g;if(r.length>0)l.push(r[0].name+" "+u);else{u+=d,l.push(game.i18n.localize("Roll")+" "+g),0!=p&&l.push(game.i18n.localize("weaponModifier")+" "+p),e.situationalModifiers.reduce(((e,t)=>{if(t.damageBonus){const e=/^\*/.test(t.damageBonus)?t.damageBonus:Number(t.damageBonus)*(t.step||1);l.push(`${t.name} ${e}`)}}),l),e.situationalModifiers.find((e=>e.name.indexOf(game.i18n.localize("CONDITION.bloodrush"))>-1))&&(u+=2,l.push(game.i18n.localize("CONDITION.bloodrush")+" 2")),a.extraDamage&&(u=Number(a.extraDamage)+Number(u),l.push(game.i18n.localize("damageThreshold")+" "+a.extraDamage));let t=e.extra.actor.system[s?"rangeStats":"meleeStats"].damage;const i=await DiceDSA5._stringToRoll(t,e);0!=i&&(u+=i,l.push(game.i18n.localize("statuseffects")+" "+i))}i&&(u*=2,l.push(game.i18n.localize("doubleDamage")));for(const e of o)u*=e.val;t.armorPen=c,t.damagedescription=l.join(", "),t.damage=Math.round(u),t.damageRoll=duplicate(m)}static async rollWeapon(e){let t,a=e.roll||await new Roll("1d20").evaluate({async:!0}),s=e.source;const i=s.system.combatskill.value;let n=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(e.extra.actor.items.find((e=>"combatskill"==e.type&&e.name==i)),e.extra.actor.system);const r="meleeweapon"==s.type;r?(t=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareMeleeWeapon(s,[n],e.extra.actor),"attack"==e.mode&&this._appendSituationalModifiers(e,game.i18n.localize("opposingWeaponSize"),this._compareWeaponReach(t,e))):t=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._prepareRangeWeapon(s,[],[n],e.extra.actor);let o=await this._rollSingleD20(a,t[e.mode],e.mode,await this._situationalModifiers(e),e,i,this._situationalMultipliers(e));await this.detailedWeaponResult(o,e,s),"attack"==e.mode&&o.successLevel>0&&!e.extra.counterAttack&&await DiceDSA5.evaluateDamage(e,o,t,!r,o.doubleDamage),e.extra.counterAttack&&(_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(e.extra.speaker).addCondition("stunned"),o.description+=", "+_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.replaceConditions(game.i18n.localize("stunnedByCounterAttack"))),o.rollType="weapon";const l=DiceDSA5.parseEffect(t);return l&&(o.parsedEffect=l),o}static async detailedWeaponResult(e,t,a){const s="attack"==t.mode&&!t.extra.counterAttack,i="meleeweapon"==a.type||"meleeAttack"==getProperty(a,"system.traitType.value");switch(e.successLevel){case 3:s?(await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("criticalAttack")?e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("criticalAttack",!1,t):(e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.defaultAttackCrit(!0),e.doubleDamage=!0),e.halfDefense=!0):t.isRangeDefense&&await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("criticalRangeDefense")?e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("criticalRangeDefense",!1,t):await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("criticalMeleeDefense")?e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("criticalMeleeDefense",!1,t):e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.defaultParryCrit();break;case-3:const n=getProperty(a,"system.combatskill.value")==game.i18n.localize("LocalizedIDs.wrestle")||"trait"==a.type;s&&i&&await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("Melee")?e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("Melee",n,t):s&&await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("Range")?e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("Range",!1,t):!s&&await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.tableEnabledFor("Defense")?e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton("Defense",n,t):e.description+=await _tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.defaultBotch();break;case 2:s&&(e.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.defaultAttackCrit(!1),e.halfDefense=!0)}}static async _addRollDiceSoNice(e,t,a){if(e.rollMode){for(let e=0;e<t.dice.length;e++)mergeObject(t.dice[e].options,a);await this.showDiceSoNice(t,e.rollMode)}}static async rollCombatskill(e){let t=e.roll?e.roll:await new Roll("1d20").evaluate({async:!0}),a=_actor_actor_dsa5_js__WEBPACK_IMPORTED_MODULE_0__.Z._calculateCombatSkillValues(e.source,e.extra.actor.system),s=await this._rollSingleD20(t,a.system[e.mode].value,e.mode,await this._situationalModifiers(e),e,"",this._situationalMultipliers(e));return await this.detailedWeaponResult(s,e,a),s.rollType="combatskill",s}static async manualRolls(e,t="",a={}){if(a.cheat||game.settings.get("dsa5","allowPhysicalDice"))if(a.predefinedResult)e.editRollAtIndex(a.predefinedResult);else{let s,i=!1,n=[];for(let t of e.terms)if(t instanceof Die||"Die"==t.class)for(let e of t.results)n.push({faces:t.faces,val:e.result});let r=await renderTemplate("systems/dsa5/templates/dialog/manualroll-dialog.html",{dice:n,description:t});if([i,s]=await new Promise(((e,t)=>{new _dialog_dialog_dsa5_js__WEBPACK_IMPORTED_MODULE_2__.Z({title:game.i18n.localize(a.cheat?"DIALOG.cheat":"DSASETTINGS.allowPhysicalDice"),content:r,default:"ok",buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:t=>{e([!0,t])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{e([!1,0])}}}}).render(!0)})),i){let t=[];s.find(".dieInput").each((function(e){let a=Number($(this).val());a>0&&t.push({val:a,index:e}),e++})),e.editRollAtIndex(t)}}return e}static parseEffect(e){const t=e.system.effect?e.system.effect.value:void 0,a=[];if(t){const e=/^[a-z]+\|[öäüÖÄÜa-zA-z ]+$/;for(let s of t.split(";"))if(e.test(s.trim())){const e=s.split("|").map((e=>e.trim()));if("condition"==e[0]){const t=CONFIG.statusEffects.find((t=>t.id==e[1]));a.push(`<a class="chat-condition chatButton" data-id="${t.id}">\n                            <img src="${t.icon}"/>${game.i18n.localize(t.name)}\n                            </a>`)}else a.push(`<a class="roll-button roll-item" data-name="${e[1]}" data-type="${e[0]}"><i class="fas fa-dice"></i>${game.i18n.localize(e[0])}: ${e[1]}</a>`)}}const s=getProperty(e,"flags.dsa5.poison");return s&&a.push(`<a class="roll-button roll-item" data-removecharge="${!s.permanent}" data-name="${s.name}" data-type="poison"><i class="fas fa-dice"></i>${game.i18n.localize("poison")}: ${s.name}</a>`),a.join(", ")}static async calculateEnergyCost(e,t,a){let s,i,n,r,o=[];if(t.successLevel<0){const e=["traditionWitch","traditionFjarning","braniborian"].map((e=>game.i18n.localize(`LocalizedIDs.${e}`))),s=a.extra.actor.items.some((t=>"specialability"==t.type&&e.includes(t.name)))?3:2;t.preData.calculatedSpellModifiers.finalcost=Math.round(t.preData.calculatedSpellModifiers.finalcost/s)}if(e?(r="KaPCost",s=game.i18n.localize("LocalizedIDs.weakKarmicBody"),i=game.i18n.localize("LocalizedIDs."+(t.successLevel>0?"mightyKarmaControl":"karmaControl")),n={val:"kapModifier",name:"KaP"}):(r="AsPCost",s=game.i18n.localize("LocalizedIDs.weakAstralBody"),i=game.i18n.localize("LocalizedIDs."+(t.successLevel>0?"energyControl":"smallEnergyControl")),n={val:"aspModifier",name:"AsP"}),o.push({name:s,value:_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.vantageStep(a.extra.actor,s)},{name:i,value:-1*_specialability_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_5__.Z.abilityStep(a.extra.actor,i)},{name:`${game.i18n.localize("statuseffects")} (${game.i18n.localize("CHARAbbrev."+n.name)})`,value:a.extra.actor.system[n.val]+await this._situationalModifiers(a,r)}),o=o.filter((e=>0!=e.value)),t.preData.calculatedSpellModifiers.description=o.map((e=>`${e.name} ${e.value}`)).join("\n"),t.preData.calculatedSpellModifiers.finalcost=Math.max(1,Number(t.preData.calculatedSpellModifiers.finalcost)+o.reduce(((e,t)=>e+t.value),0)),t.successLevel>0&&0!=t.preData.calculatedSpellModifiers.maintainCost){const e=t.preData.calculatedSpellModifiers.maintainCost.split(" ");e[0]=Math.round(Number(e[0])),t.preData.calculatedSpellModifiers.finalcost+=e[0],t.preData.calculatedSpellModifiers.maintainCost=e.join(" ")}}static async rollSpell(e){let t=await this._rollThreeD20(e);const a=["ceremony","liturgy"].includes(e.source.type);if(t.rollType=e.source.type,t.preData.calculatedSpellModifiers.finalcost=t.preData.calculatedSpellModifiers.cost,t.successLevel>=2){let e=(await new Roll("1d6").evaluate({async:!0})).total;t.description=t.description+", "+game.i18n.localize("additionalFPs")+" "+e,t.result+=e,t.qualityStep=Math.min(game.settings.get("dsa5","capQSat"),Math.ceil(t.result/3)),t.preData.calculatedSpellModifiers.finalcost=Math.round(t.preData.calculatedSpellModifiers.cost/2)}else t.successLevel<=-2&&(t.description+=_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.rollCritBotchButton(a?"Liturgy":"Spell",!1,e));if(t.successLevel>0&&""!=e.source.system.effectFormula.value){let s=e.source.system.effectFormula.value.replace(game.i18n.localize("CHARAbbrev.QS"),t.qualityStep).replace(/[Ww]/g,"d"),i=[];for(let t of e.situationalModifiers)t.armorPen&&i.push(t.armorPen);/(,|;)/.test(s)&&(s=s.split(/[,;]/)[t.qualityStep-1]);let n=e.damageRoll?e.damageRoll:await DiceDSA5.manualRolls(await new Roll(s).evaluate({async:!0}),"CHAR.DAMAGE",e.extra.options);this._addRollDiceSoNice(e,n,game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage")),t.calculatedEffectFormula=s;for(let e of n.terms)if(e instanceof Die||"Die"==e.class)for(let a of e.results)t.characteristics.push({char:"effect",res:a.result,die:"d"+e.faces});const r=[],o=await DiceDSA5._stringToRoll(e.extra.actor.system[a?"liturgyStats":"spellStats"].damage,e);0!=o&&r.push(game.i18n.localize("statuseffects")+" "+o),t.armorPen=i,t.damageRoll=n,t.damage=n.total+o,t.damagedescription=r.join("\n")}if(await this.calculateEnergyCost(a,t,e),_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(e.extra.actor,game.i18n.localize("CONDITION.minorSpirits"))&&!e.extra.actor.effects.find((e=>e.name==game.i18n.localize("CONDITION.minorSpirits")))){(await new Roll("1d20").evaluate({async:!0})).total<=t.preData.calculatedSpellModifiers.finalcost&&(t.description+=", "+game.i18n.localize("minorghostsappear"),_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(e.extra.speaker).addCondition("minorSpirits"))}return t}static async _rollThreeD20(e){let t=e.roll?Roll.fromData(e.roll):await new Roll("1d20+1d20+1d20").evaluate({async:!0}),a=[],s=0;this._appendSituationalModifiers(e,game.i18n.localize("Difficulty"),e.testDifficulty);let i=await this._situationalModifiers(e),n=e.source.system.talentValue.value+e.advancedModifiers.fws+await this._situationalModifiers(e,"FW");const r=this._situationalPartCheckModifiers(e,"TPM");let o=[1,2,3].map((t=>e.extra.actor.system.characteristics[e.source.system[`characteristic${t}`].value].value+i+e.advancedModifiers.chars[t-1]+r[t-1])),l=[0,1,2].map((e=>t.terms[2*e].results[0].result-o[e]));if(e.routine)n=Math.round(n/2);else for(let e of l)e>0&&(n-=e);let c=e.extra.actor.system.skillModifiers.crit,d=e.extra.actor.system.skillModifiers.botch;if(["spell","ritual"].includes(e.source.type)&&_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(e.extra.actor,game.i18n.localize("LocalizedIDs.wildMagic"))&&(d=19),"skill"==e.source.type&&_advantage_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_4__.Z.hasVantage(e.extra.actor,`${game.i18n.localize("LocalizedIDs.incompetent")} (${e.source.name})`)){let s=await new Roll("1d20").evaluate({async:!0}),i=l.reduce(((e,t,a,s)=>t<s[e]?a:e),0),r=t.terms[2*i].total;n+=Math.max(l[i],0),n-=Math.max(0,s.total-o[i]),t.editRollAtIndex([{index:i,val:s.total}]),this._addRollDiceSoNice(e,s,t.terms[2*i].options),a.push(game.i18n.format("CHATNOTIFICATION.unableReroll",{die:i+1,oldVal:r,newVal:s.total}))}let m=0;"skill"==e.source.type&&_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__.Z.hasTrait(e.extra.actor,`${game.i18n.localize("LocalizedIDs.automaticSuccess")} (${e.source.name})`)?(a.push(game.i18n.localize("LocalizedIDs.automaticSuccess")),s=1,m=1):"skill"==e.source.type&&_trait_rules_dsa5_js__WEBPACK_IMPORTED_MODULE_6__.Z.hasTrait(e.extra.actor,`${game.i18n.localize("LocalizedIDs.automaticFail")} (${e.source.name})`)?(a.push(game.i18n.localize("LocalizedIDs.automaticFail")),s=-1):(s=DiceDSA5.get3D20SuccessLevel(t,n,d,c),e.routine&&(s=1),a.push(DiceDSA5.getSuccessDescription(s))),a=a.join(", ");let u=0;return s>0&&(n+=await this._situationalModifiers(e,"FP"),u=Math.max(1,(0==n?1:n>0?Math.ceil(n/3):0)+(null!=e.qualityStep?Number(e.qualityStep):0))+(e.advancedModifiers.qls||0)+await this._situationalModifiers(e,"QL")),u=Math.min(game.settings.get("dsa5","capQSat"),u),u<m&&(u=m),{result:n,characteristics:[0,1,2].map((a=>({char:e.source.system[`characteristic${a+1}`].value,res:t.terms[2*a].results[0].result,suc:l[a]<=0,tar:o[a]}))),qualityStep:u,description:a,preData:e,successLevel:s,modifiers:i,extra:{}}}static async rollTalent(e){let t=await this._rollThreeD20(e);return t.rollType="talent",t}static get3D20SuccessLevel(e,t,a=20,s=1){const i=e.terms.filter((e=>e.results&&e.results[0].result<=s)).length,n=e.terms.filter((e=>e.results&&e.results[0].result>=a)).length;return i>=2?i:n>=2?-1*n:t>=0?1:-1}static getSuccessDescription(e){return game.i18n.localize(["AstoundingFailure","CriticalFailure","Failure","","Success","CriticalSuccess","AstoundingSuccess"][e+3])}static async rollItem(e){let t=e.roll||await new Roll("1d20+1d20+1d20").evaluate({async:!0}),a=[],s=await this._situationalModifiers(e),i=Number(e.source.system.step.value),n=[1,2,3].map((t=>10+Number(e.source.system.step.value)+s)),r=[0,1,2].map((e=>t.terms[2*e].results[0].result-n[e]));for(let e of r)e>0&&(i-=e);const o=DiceDSA5.get3D20SuccessLevel(t,i,20);a.push(DiceDSA5.getSuccessDescription(o)),a=a.join(", ");let l={result:i,characteristics:[0,1,2].map((a=>({char:e.source.type,res:t.terms[2*a].results[0].result,suc:r[a]<=0,tar:n[a]}))),qualityStep:Math.min(game.settings.get("dsa5","capQSat"),(0==i?1:i>0?Math.ceil(i/3):0)+(null!=e.qualityStep?Number(e.qualityStep):0)),description:a,preData:e,successLevel:o,modifiers:s,extra:{}};switch(e.source.type){case"poison":let t=e.source.system.duration.value.split(" / ").map((e=>e.trim())),a=e.source.system.effect.value.split(" / ").map((e=>e.trim()));l.duration=t.length>1?l.successLevel>0?t[0]:t[1]:t[0],l.effect=a.length>1?l.successLevel>0?a[0]:a[1]:a[0];break;case"disease":let s=e.source.system.damage.value.split(" / ").map((e=>e.trim())),i=e.source.system.duration.value.split(" / ").map((e=>e.trim()));l.damageeffect=s.length>1?l.successLevel>0?s[0]:s[1]:s[0],l.duration=i.length>1?l.successLevel>0?i[0]:i[1]:i[0]}return l}static async updateDefenseCount(e){game.combat&&await game.combat.updateDefenseCount(e.extra.speaker)}static _compareWeaponReach(e,t){let a=t.situationalModifiers.find((e=>e.name==game.i18n.localize("LocalizedIDs.circumvent")));const s=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.meleeRangesArray.indexOf(e.system.reach.value),i=_config_dsa5_js__WEBPACK_IMPORTED_MODULE_1__.Z.meleeRangesArray.indexOf(t.opposingWeaponSize);return a&&i>s&&(a.value=2*Math.min(a.step,i-s)),2*Math.min(0,s-i)}static async showDiceSoNice(e,t){if(_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.moduleEnabled("dice-so-nice")&&game.dice3d){let a=null,s=!1;switch(t){case"blindroll":s=!0,a=game.users.filter((e=>e.isGM)).map((e=>e.id));break;case"gmroll":a=game.users.filter((e=>e.isGM)).map((e=>e.id));break;case"selfroll":a=[]}const i=game.dice3d.showForRoll(e,game.user,!0,a,s);game.settings.get("dice-so-nice","immediatelyDisplayChatMessages")||await i}}static addApplyEffectData(e){const t=e.preData.source;if(e.successLevel>0){if(["meleeweapon","rangeweapon"].includes(t.type)||"trait"==t.type&&["rangeAttack","meleeAttack"].includes(t.system.traitType.value)){if(t.effects.some((e=>!getProperty(e,"flags.dsa5.applyToOwner"))))return!0}else if(["spell","liturgy","ritual","ceremony","trait"].includes(t.type)&&t.effects.length>0)return!0}else if(["disease","poison"].includes(t.type))return t.effects.length>0;const a=e.preData.situationalModifiers.filter((e=>e.specAbId)).map((e=>e.specAbId));if(a.length>0){const t=e.preData.extra.actor.items.filter((e=>a.includes(e._id)));for(const e of t)if(e.effects.length>0)return!0}return!1}static async renderRollCard(chatOptions,testData,rerenderMessage){const applyEffect=this.addApplyEffectData(testData),immuneTo=_creature_type_js__WEBPACK_IMPORTED_MODULE_17__.Z.checkImmunity(testData),preData=deepClone(testData.preData),hideDamage=rerenderMessage?rerenderMessage.flags.data.hideDamage:"attack"==preData.mode;Hooks.call("postProcessDSARoll",chatOptions,testData,rerenderMessage,hideDamage),await _utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.callAsyncHooks("postProcessDSARoll",[testData]),delete preData.extra.actor,delete testData.actor,delete testData.preData;const hasAreaTemplate=testData.successLevel>0&&preData.source.system.target&&preData.source.system.target.type in game.dsa5.config.areaTargetTypes;let chatData={title:chatOptions.title,immuneTo,testData,hideData:game.user.isGM,preData,hideDamage,modifierList:preData.situationalModifiers.filter((e=>0!=e.value)),applyEffect,hasAreaTemplate,showDamageToGear:await _equipment_damage_js__WEBPACK_IMPORTED_MODULE_11__.Z.showDamageToGear(preData,testData)};if(preData.advancedModifiers&&(preData.advancedModifiers.chars.some((e=>0!=e))&&chatData.modifierList.push({name:game.i18n.localize("MODS.partChecks"),value:preData.advancedModifiers.chars}),0!=preData.advancedModifiers.fws&&chatData.modifierList.push({name:game.i18n.localize("MODS.FW"),value:preData.advancedModifiers.fws}),0!=preData.advancedModifiers.qls&&chatData.modifierList.push({name:game.i18n.localize("MODS.QS"),value:preData.advancedModifiers.qls})),["gmroll","blindroll"].includes(chatOptions.rollMode)&&(chatOptions.whisper=game.users.filter((e=>e.isGM)).map((e=>e.id))),"blindroll"===chatOptions.rollMode?chatOptions.blind=!0:"selfroll"===chatOptions.rollMode&&(chatOptions.whisper=[game.user.id]),_dsa_soundeffect_js__WEBPACK_IMPORTED_MODULE_18__.Z.playEffect(preData.mode,preData.source,testData.successLevel,chatOptions.whisper,chatOptions.blind),chatOptions["flags.data"]={preData,postData:testData,template:chatOptions.template,rollMode:chatOptions.rollMode,isOpposedTest:chatOptions.isOpposedTest,title:chatOptions.title,hideData:chatData.hideData,hideDamage:chatData.hideDamage,isDSARoll:!0},rerenderMessage){const postFunction=getProperty(rerenderMessage,"flags.data.preData.extra.options.postFunction");postFunction&&(testData.messageId=rerenderMessage.id,await eval(postFunction.functionName)(postFunction,{result:testData,chatData},preData.source));const html=await renderTemplate(chatOptions.template,chatData),actor=ChatMessage.getSpeakerActor(rerenderMessage.speaker)||game.users.get(rerenderMessage.user).character,rollData=actor?actor.getRollData():{},enriched=await TextEditor.enrichHTML(html,{rollData,async:!0});chatOptions.content=enriched;const newMsg=await rerenderMessage.update({content:chatOptions.content,"flags.data":chatOptions["flags.data"]});return ui.chat.updateMessage(newMsg),newMsg}return chatOptions.content=await renderTemplate(chatOptions.template,chatData),await ChatMessage.create(chatOptions,!1)}static async _itemRoll(e){let t=$(e.currentTarget),a=t.parents(".message").attr("data-message-id"),s=game.messages.get(a).speaker,i=t.attr("data-type"),n=t.attr("data-name"),r=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(s);if(r){const e=r.items.find((e=>e.name==n&&e.type==i));if(e){const a=new _item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__.Z(e.toObject(),{temporary:!0}),s=!!t.attr("data-removecharge")&&"true"==t.attr("data-removecharge");if(s&&a.system.quantity.value<1)return void ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));a.setupEffect().then((async t=>{await a.itemTest(t),s&&await e.update({"system.quantity.value":e.system.quantity.value-1})}))}else ui.notifications.error(game.i18n.format("DSAError.notFound",{category:i,name:n}))}}static async _rollEdit(e){let t,a=$(e.currentTarget),s=a.parents(".message").attr("data-message-id"),i=game.messages.get(s),n=i.flags.data,r=n.preData;switch(r.extra.actor=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(r.extra.speaker).toObject(!1),r.extra.options.cheat&&delete r.extra.options.cheat,a.attr("data-edit-type")){case"roll":t=a.attr("data-edit-id");let e=Number(a.val());if(r.roll.terms.length>2*t){let a=Roll.fromData(r.roll);a.editRollAtIndex([{index:t,val:e}]),r.roll=a}else{let a=Roll.fromData(n.postData.damageRoll);t-=r.roll.terms.filter((e=>e.results)).length,a.editRollAtIndex([{index:t,val:e}]),r.damageRoll=a}break;case"mod":t=r.situationalModifiers.findIndex((e=>e.name==game.i18n.localize("chatEdit"))),t>0&&r.situationalModifiers.splice(t,1);let s={name:game.i18n.localize("chatEdit"),value:Number(a.val())-await this._situationalModifiers(r)};r.situationalModifiers.push(s)}let o={template:n.template,rollMode:n.rollMode,title:n.title,speaker:i.speaker,user:i.user.id};if(["gmroll","blindroll"].includes(o.rollMode)&&(o.whisper=game.users.filter((e=>e.isGM)).map((e=>e.id))),"blindroll"===o.rollMode&&(o.blind=!0),["poison","disease"].includes(r.source.type))new _item_item_dsa5_js__WEBPACK_IMPORTED_MODULE_7__.Z(r.source,{temporary:!0})[`${n.postData.postFunction}`]({testData:r,cardOptions:o},{rerenderMessage:i});else{_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(i.speaker)[`${n.postData.postFunction}`]({testData:r,cardOptions:o},{rerenderMessage:i})}}static async gearDamaged(e){const t=e.currentTarget.dataset.uuid.split(";");if(t.length>1){const e=await Promise.all(t.map((e=>fromUuid(e))));_dialog_dialog_equipmentdamage_js__WEBPACK_IMPORTED_MODULE_12__.Z.showDialog(e)}else _equipment_damage_js__WEBPACK_IMPORTED_MODULE_11__.Z.breakingTest(await fromUuid(t[0]))}static async rollResistPain(e){const t=e.currentTarget.dataset,a={token:t.token,actor:t.actor,scene:canvas.id},s=_utility_dsa5_js__WEBPACK_IMPORTED_MODULE_3__.Z.getSpeaker(a);s&&s.finishResistPainRoll()}static async wrapLock(e,t){const a=$(e.currentTarget);a.hasClass("locked")||(a.addClass("locked"),a.prepend('<i class="fas fa-spinner fa-spin"></i>'),await t(e,a),setTimeout((()=>{a.removeClass("locked"),a.find("i").remove()}),2e3))}static async chatListeners(e){e.on("click",".expand-mods",(e=>{e.preventDefault();let t=$(e.currentTarget);t.find("i").toggleClass("fa-minus fa-plus"),t.siblings("ul,div").fadeToggle()})),e.on("click",".edit-toggle",(e=>{e.preventDefault(),$(e.currentTarget).parents(".chat-card").find(".display-toggle").toggle()})),e.on("click",".botch-roll",(e=>_tables_dsatables_js__WEBPACK_IMPORTED_MODULE_13__.Z.showBotchCard(e.currentTarget.dataset))),e.on("click",".roll-item",(e=>DiceDSA5._itemRoll(e))),e.on("click",".gearDamaged",(async e=>DiceDSA5.gearDamaged(e))),e.on("change",".roll-edit",(e=>DiceDSA5._rollEdit(e))),e.on("click",".applyEffect",(async e=>{DiceDSA5.wrapLock(e,(async(e,t)=>{const a=t.parents(".message").attr("data-message-id"),s=e.currentTarget.dataset.target;await _status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__.Z.applyEffect(a,s)}))})),e.on("click",".applyTableEffect",(async e=>{DiceDSA5.wrapLock(e,(async(e,t)=>{const a=t.parents(".message").attr("data-message-id"),s=e.currentTarget.dataset.target;await _tables_tableEffects_js__WEBPACK_IMPORTED_MODULE_16__.Z.applyEffect(a,s)}))})),e.on("click",".placeTemplate",(async e=>_measuretemplate_js__WEBPACK_IMPORTED_MODULE_15__.c.placeTemplateFromChat(e))),e.on("click",".message-delete",(e=>{let t=game.messages.get($(e.currentTarget).parents(".message").attr("data-message-id"));if(!t.flags.unopposeData)return;let a=canvas.tokens.get(t.flags.unopposeData.targetSpeaker.token);_opposed_dsa5_js__WEBPACK_IMPORTED_MODULE_9__.Z.clearOpposed(a.actor)})),e.on("click",".resistEffect",(e=>_status_active_effects_js__WEBPACK_IMPORTED_MODULE_10__.Z.resistEffect(e))),e.on("click",".resistPain",(e=>DiceDSA5.rollResistPain(e))),_request_roll_js__WEBPACK_IMPORTED_MODULE_14__.Z.chatListeners(e)}}},803:(e,t,a)=>{a.d(t,{Z:()=>DSA5SoundEffect});class DSA5SoundEffect{static sounds;static triedInit=!1;static prepareSoundEffects(){DSA5SoundEffect.soundPaths={money:[],armor:[],meleeweapon:[],rangeweapon:[],default:[]},game.modules.get("gAudioBundle-3")&&(DSA5SoundEffect.soundPaths.money.push("modules/gAudioBundle-3/src/Mint Coins And Money/Coin_Slide_Carpet.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Drop_Carpet_06.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_Bottlecaps_Drop.ogg","modules/gAudioBundle-3/src/Mint Coins And Money/Coins_In_Sack_Held_By_Drawstring_06.ogg","modules/gAudioBundle-3/src/Money/Money_Coins_Handle.ogg"),DSA5SoundEffect.soundPaths.meleeweapon.push("modules/gAudioBundle-3/src/Medieval Armor And Impacts/Weapon_Impact_Parry_01.ogg")),game.modules.get("gAudioBundle-2")&&(DSA5SoundEffect.soundPaths.meleeweapon.push("modules/gAudioBundle-2/src/Gore/Melee_Sword_Attack_04.ogg"),DSA5SoundEffect.soundPaths.armor.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Soldier_Gear_Equipment_Metal_Cloth_Heavy_Movement_Light_08.ogg"),DSA5SoundEffect.soundPaths.default.push("modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Foley_Sports_Bag_Grab_Pickup_Catch_04.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_01.ogg","modules/gAudioBundle-2/src/Footsteps/Footstep And Foley Sounds/Footstep_Ice_Crunchy_Run_02.ogg")),game.modules.get("gAudioBundle-4")&&DSA5SoundEffect.soundPaths.rangeweapon.push("modules/gAudioBundle-4/src/Super Heroes Sound Design/Hawk's_Arrow_Flies_Bow_And_Arrow_Shoot_2.ogg"),Hooks.call("setDefaultDSASounds",DSA5SoundEffect.soundPaths)}static async playEffect(e,t,a,s,i=!1){const n=await this.getSound(e,t,a);if(n)try{s?(game.socket.emit("system.dsa5",{type:"playWhisperSound",payload:{whisper:s,soundPath:n}}),i||AudioHelper.play({src:n,volume:.8,loop:!1},!1)):AudioHelper.play({src:n,volume:.8,loop:!1},!0)}catch(e){console.warn(`Could not play item sound effect ${n}`)}}static async loadSoundConfig(){const e=await game.settings.get("dsa5","soundConfig");if(e)try{let t=await fetch(e),a=await t.json();this.sounds=a,console.log("DSA5 | Sound Config Loaded")}catch(e){console.warn(e)}}static successLevelToString(e){switch(e){case-1:return["fail"];case-2:return["botch","fail"];case 1:return["success"];case 2:return["crit","success"];default:return[]}}static async getSound(e,t,a){if(this.sounds||this.triedInit||(await this.loadSoundConfig(),this.triedInit=!0),!this.sounds)return;const s=this.successLevelToString(a);let i,n=[];switch(t.type){case"meleeweapon":case"rangeweapon":n=[...s.map((a=>`${t.type}.manual.${t.name}.${e}_${a}`)),`${t.type}.manual.${t.name}.${e}`,`${t.type}.manual.${t.name}.default.${e}`,`${t.type}.manual.${t.name}.default`,...s.map((a=>`${t.type}.${t.system.combatskill.value}.${e}_${a}`)),`${t.type}.${t.system.combatskill.value}.${e}`,...s.map((e=>`${t.type}.${t.system.combatskill.value}.default_${e}`)),`${t.type}.${t.system.combatskill.value}.default`];break;case"skill":case"liturgy":case"spell":case"ceremony":case"ritual":n=[...s.map((a=>`${t.type}.${t.name}.${e}_${a}`)),`${t.type}.${t.name}.${e}`,...s.map((e=>`${t.type}.${t.name}.default_${e}`)),`${t.type}.${t.name}.default`]}n.push(...s.map((e=>`${t.type}.default_${e}`)),`${t.type}.default`);for(const e of n)if(hasProperty(this.sounds,e)&&(i=getProperty(this.sounds,e),i&&("string"==typeof i||i instanceof String)))break;return i}static async playMoneySound(e=!1){const t=DSA5SoundEffect.soundPaths.money,a=t[Math.floor(Math.random()*t.length)];await this.playSoundPath(a,e)}static async playEquipmentWearStatusChange(e,t=!1){let a=DSA5SoundEffect.soundPaths[e.type]||DSA5SoundEffect.soundPaths.default;if(a.length>0){const e=a[Math.floor(Math.random()*a.length)];await this.playSoundPath(e,t,.5)}}static async playSoundPath(e,t=!1,a=.8){if(game.settings.get("dsa5","inventorySound"))try{AudioHelper.play({src:e,volume:a,loop:!1},t)}catch(t){console.warn(`Could not play item sound effect ${e}`)}}}},702:(e,t,a)=>{a.d(t,{Z:()=>EquipmentDamage});var s=a(5),i=a(577),n=a(472),r=a(562),o=a(491);class EquipmentDamage{static armorWearModifier(e,t){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(EquipmentDamage.calculateWear(e)){case 1:case 2:t-=1;break;case 3:case 4:t=0}return Math.max(0,Number(t))}static armorGetsDamage(e,t){return(e>14||t.successLevel>2)&&game.settings.get("dsa5","armorAndWeaponDamage")}static armorEncumbranceModifier(e){return game.settings.get("dsa5","armorAndWeaponDamage")&&EquipmentDamage.calculateWear(e)>1?1:0}static async showDamageToGear(e,t){if(game.settings.get("dsa5","armorAndWeaponDamage")){let a=o.Z.getSpeaker(e.extra.speaker),s=0;const i=getProperty(a,"flags.oppose.messageId");if(i){const e=game.messages.get(i);e&&(s=getProperty(e,"flags.data.postData.successLevel")||0)}const n=e.source;if(n._id&&n.system.structure&&(t.successLevel<-2||s>2)&&["meleeweapon","rangeweapon","armor"].includes(n.type))return a=await o.Z.getSpeaker(t.speaker),a.items.get(n._id).uuid}}static breakingTest(e){if(!e)return ui.notifications.warn(game.i18n.format("DSAError.notfound",{category:"",name:game.i18n.localize("equipment")}));if(e.system.structure.max<=0)return ui.notifications.warn(game.i18n.format("DSAError.noBreakingStructure",{name:e.name}));let t,a=0;if("armor"==e.type?(t=game.i18n.localize(`ARMORSUBCATEGORIES.${e.system.subcategory}`),a=getProperty(e,"system.structure.breakPointRating")||i.Z.armorSubcategories[e.system.subcategory]):(t=e.system.combatskill.value,a=getProperty(e,"system.structure.breakPointRating")||i.Z.weaponStabilities[game.i18n.localize(`LocalizedCTs.${t}`)]),!a)return void ui.notifications.error(game.i18n.format("DSAError.noBreakingResistance",{item:e.name}));let r="";const o=getProperty(e,"effect.attributes")||"";new RegExp(`${n.Z.magical}`,"i").test(o)?r=`${game.i18n.format("WEAPON.attributeWarning",{domain:n.Z.clerical})}<br/>`:new RegExp(`${n.Z.clerical}`,"i").test(o)&&(r=`${game.i18n.format("WEAPON.attributeWarning",{domain:n.Z.magical})}<br/>`),new s.Z({title:game.i18n.localize("DSASETTINGS.armorAndWeaponDamage"),content:`${r}<label for="threshold">${game.i18n.format("WEAR.check",{category:t})}</label>: <input class="quantity-click" style="width:80px" dtype="number" name="threshold" type="number" value="${a}"/>`,buttons:{Yes:{icon:'<i class="fas fa-dice-d20"></i>',label:game.i18n.localize("Roll"),callback:a=>{EquipmentDamage.resolveBreakingTest(e,Number(a.find('[name="threshold"]').val()),t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}static async applyDamageLevelToItem(e,t){const a=Math.ceil(.25*e.system.structure.max)*t;await e.update({"system.structure.value":Math.max(0,e.system.structure.value-a)})}static async absoluteDamageLevelToItem(e,t){const a=Math.ceil(.25*e.system.structure.max)*t;await e.update({"system.structure.value":Math.min(e.system.structure.value,Math.max(0,e.system.structure.max-a))})}static async resolveBreakingTest(e,t,a){const s=await r.Z.manualRolls(await new Roll("1d20").evaluate({async:!0}),game.i18n.format("WEAR.check",{category:a}));await r.Z.showDiceSoNice(s,await game.settings.get("core","rollMode"));const i=s.total>t?1:0;await this.applyDamageLevelToItem(e,i);const n=EquipmentDamage.calculateWear(e.data);let l=await renderTemplate("systems/dsa5/templates/system/breakingtest.html",{wear:n,item:e,threshold:t,category:a,roll:s,result:game.i18n.localize(`WEAR.${e.type}.${n}`)});ChatMessage.create(o.Z.chatDataSetup(l))}static damageTooltip(e){if(game.settings.get("dsa5","armorAndWeaponDamage")){const t=this.calculateWear(e);return{msg:game.i18n.localize(`WEAR.${e.type}.${t}`),css:`gearD damaged${t}`}}return{msg:"",css:""}}static weaponWearModifier(e){if(game.settings.get("dsa5","armorAndWeaponDamage"))switch(EquipmentDamage.calculateWear(e)){case 1:e.attack-=1,e.parry&&(e.parry-=1);break;case 2:e.attack-=2,e.parry&&(e.parry-=2);break;case 3:case 4:e.attack=0,e.parry&&(e.parry=0)}}static calculateWear(e){return!e.system.structure||Number(e.system.structure.max<=0)?0:Math.floor(4*(1-e.system.structure.value/e.system.structure.max))}}},794:(e,t,a)=>{a.d(t,{Z:()=>ItemRulesDSA5});var s=a(577),i=a(491);class ItemRulesDSA5{static children={};static getTalentBonus(e,t,a){let s=[],n=game.settings.get("dsa5","talentModifierEnabled");for(let r of e.items.filter((e=>a.includes(e.type)&&e.system.effect.value.includes(t))))for(let e of r.system.effect.value.split(/;|,/))if(e.includes(t)){let a=i.Z.parseAbilityString(e.trim());a.name==t&&s.push({name:r.name,value:a.step*(r.system.step?r.system.step.value:1),type:a.type,selected:n,source:r.name})}return s}static async stepXPCost(e,t){let a=e.system.APValue.value;if(/;/.test(a)){const e=a.split(";").map((e=>Number(e.trim())));a=e[t]}return Number(a)}static calcAPCostSum(e){let t=Number(e.system.APValue.value)*(Number(e.system.step.value)||1);if(/;/.test(e.system.APValue.value)){const a=e.system.APValue.value.split(";").map((e=>Number(e.trim())));t=0;for(let s=0;s<e.system.step.value;s++)t+=a[s]}return t}static simpleAdoption(e,t,a,s){if(s[a].effect&&(e.system.effect.value=`${t.name} ${s[a].effect}`),s[a].activeEffect){const i=duplicate(s[a].activeEffect);i.value=`${t.name} ${i.value}`;const n={changes:[i],duration:{},icon:"icons/svg/aura.svg",name:`${a} (${t.name})`,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:`${a} (${t.name})`,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}},tint:""};e.effects.push(n)}}static reverseAdoptionCalculation(e,t,a){const i=[s.Z.vantagesNeedingAdaption,s.Z.AbilitiesNeedingAdaption];for(let s of i)if(s[t.name]){let i=e.items.find((e=>s[t.name].items.includes(e.type)&&e.name==t.special));i&&(a.system.APValue.value=a.system.APValue.value?a.system.APValue.value.split("/")[i.system.StF.value.charCodeAt(0)-65]:0,ItemRulesDSA5.simpleAdoption(a,i,t.name,s));break}return a}static hasItem(e,t,a){return null!=e.items.find((e=>a.includes(e.type)&&e.name==t))}static itemStep(e,t,a){let s=e.items.find((e=>a.includes(e.type)&&e.name==t));return s?Number(s.system.step.value):0}static itemAsModifier(e,t,a,s,n=!1,r=!1){let o=[];const l=n?new RegExp(`^${i.Z.escapeRegex(`${t} (`)}`):new RegExp(`^${i.Z.escapeRegex(t)}$`),c=e.items.find((e=>s.includes(e.type)&&l.test(e.name)));return c&&o.push({name:c.name,value:Number(c.system.step.value)*a,selected:r,source:c.name}),o}}},174:(e,t,a)=>{a.d(t,{c:()=>MeasuredTemplateDSA});class MeasuredTemplateDSA extends MeasuredTemplate{#e;#t=0;#a;static async placeTemplateFromChat(e){const t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(t),s=a.flags.data.preData.source,i=a.flags.data.postData,n=this.fromItem(s,i.successLevel);n&&n.drawPreview()}static fromItem(e,t){const a=e.system.target||{},s=game.dsa5.config.areaTargetTypes[a.type];if(!s||!a.value)return null;const i=Number(Roll.safeEval(`${a.value}`.replace(/(qs|ql)/gi,t)))||1,n={t:s,user:game.user.id,distance:i,direction:0,x:0,y:0,fillColor:game.user.color,flags:{dsa5:{origin:e.uuid}}};switch(s){case"cone":n.angle=Number(a.angle)||CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":n.distance=Math.hypot(i,i),n.width=i,n.direction=45;break;case"ray":n.width=a.width&&Number(Roll.safeEval(`${a.width}`.replace(/(qs|ql)/gi,t)))||canvas.dimensions.distance}const r=new this(new(0,CONFIG.MeasuredTemplate.documentClass)(n,{parent:canvas.scene}));return r.item=e,r.actorSheet=e.actor?.sheet||null,r}drawPreview(){const e=canvas.activeLayer;return this.draw(),this.layer.activate(),this.layer.preview.addChild(this),this.activatePreviewListeners(e)}activatePreviewListeners(e){return new Promise(((t,a)=>{this.#e=e,this.#a={cancel:this._onCancelPlacement.bind(this),confirm:this._onConfirmPlacement.bind(this),move:this._onMovePlacement.bind(this),resolve:t,reject:a,rotate:this._onRotatePlacement.bind(this)},canvas.stage.on("mousemove",this.#a.move),canvas.stage.on("mousedown",this.#a.confirm),canvas.app.view.oncontextmenu=this.#a.cancel,canvas.app.view.onwheel=this.#a.rotate}))}async _finishPlacement(e){this.layer._onDragLeftCancel(e),canvas.stage.off("mousemove",this.#a.move),canvas.stage.off("mousedown",this.#a.confirm),canvas.app.view.oncontextmenu=null,canvas.app.view.onwheel=null,this.#e.activate(),await(this.actorSheet?.maximize())}_onMovePlacement(e){e.stopPropagation();let t=Date.now();if(t-this.#t<=20)return;const a=e.data.getLocalPosition(this.layer),s=canvas.grid.getSnappedPosition(a.x,a.y,2);this.document.updateSource({x:s.x,y:s.y}),this.refresh(),this.#t=t}_onRotatePlacement(e){e.ctrlKey&&e.preventDefault(),e.stopPropagation();let t=canvas.grid.type>CONST.GRID_TYPES.SQUARE?30:15,a=e.shiftKey?t:5;const s={direction:this.document.direction+a*Math.sign(e.deltaY)};this.document.updateSource(s),this.refresh()}async _onConfirmPlacement(e){await this._finishPlacement(e);const t=canvas.grid.getSnappedPosition(this.document.x,this.document.y,2);this.document.updateSource(t),this.#a.resolve(canvas.scene.createEmbeddedDocuments("MeasuredTemplate",[this.document.toObject()]))}async _onCancelPlacement(e){await this._finishPlacement(e),this.#a.reject()}}},586:(e,t,a)=>{a.d(t,{Z:()=>migrateWorld,j:()=>showPatchViewer});var s=a(491),i=a(707);async function migrateDSA(e,t){await showPatchViewer(),e<24&&await async function migratTo24(){for(let e of game.actors){const t=e.effects.filter((e=>["inpain","encumbered"].includes(e.getFlag("core","statusId"))));t.length&&await e.deleteEmbeddedDocuments("ActiveEffect",t.map((e=>e.id)))}}(),await game.settings.set("dsa5","migrationVersion",t)}async function showPatchViewer(){const e=await fetch("systems/dsa5/lazy/updatenotes.json"),t=await e.json();new PatchViewer(t).render(!0)}function migrateWorld(){Hooks.once("ready",(async function(){if(!game.user.isGM)return;await async function setupDefaulTokenConfig(){if(!game.settings.get("dsa5","defaultConfigFinished")){console.log("Configuring default token settings");let e=game.settings.get("core","defaultToken");e.displayName=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,e.displayBars=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,e.disposition=CONST.TOKEN_DISPOSITIONS.NEUTRAL,e.bar1={attribute:"status.wounds"},await game.settings.set("core","defaultToken",e),await game.settings.set("core","leftClickRelease",!0),await game.settings.set("dsa5","defaultConfigFinished",!0)}}();const e=await game.settings.get("dsa5","migrationVersion");e<24&&migrateDSA(e,24)}))}class PatchViewer extends Application{constructor(e,t){super(t),this.json=e}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"newcontent"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","patches"]),width:740,height:740,title:"Changelog"}),e.template="systems/dsa5/templates/system/patchviewer.html",e.resizable=!0,e}activateListeners(e){super.activateListeners(e),(0,i.Ee)(e)}async getData(){let e=this.json.notes[this.json.notes.length-1];const t=this.json.default.replace(/VERSION/g,e.version);let a=`<h1>CHANGELOG</h1><p>${t}. </br><b>Important updates</b>: ${e.text}</p><p>For details or proposals visit our wiki page at <a href="https://github.com/Plushtoast/dsa5-foundryVTT/wiki" target="_blank">Github</a> or show the <a style="text-decoration: underline;color:#ff6400;" class="showPatchViewer">Full Changelog in Foundry</a>. Have fun.</p>`;await ChatMessage.create(s.Z.chatDataSetup(a,"roll"));const i=game.i18n.lang,n=await renderTemplate(`systems/dsa5/lazy/patchhtml/changelog_${i}_${e.version}.html`),r=await renderTemplate(`systems/dsa5/lazy/patchhtml/news_${i}_${e.version}.html`),o=[this.json.notes[this.json.notes.length-2]],l=await Promise.all(o.map((async e=>await renderTemplate(`systems/dsa5/lazy/patchhtml/changelog_${i}_${e.version}.html`)))),c=await Promise.all(o.map((async e=>await renderTemplate(`systems/dsa5/lazy/patchhtml/news_${i}_${e.version}.html`))));return{patchName:t,changelog:n,news:r,prevVersions:o,prevChangeLogs:l,prevNews:c,modules:await renderTemplate(`systems/dsa5/lazy/patchhtml/modules_${i}.html`)}}}},604:(e,t,a)=>{a.d(t,{Z:()=>OnUseEffect});var s=a(491);a(122);class OnUseEffect{constructor(e){this.item=e}async callMacro(e,t,a={}){const s=game.packs.get(e);let i=await s.getDocuments({name:t});if(!i.length)for(let e of game.packs.filter((e=>"Macro"==e.documentName&&/\(internal\)/.test(e.metadata.label))))if(i=await e.getDocuments({name:t}),i.length)break;let n={};if(i.length){const e=`(async () => {${i[0].command}})()`,t=Function("args","actor","item",e);try{a.result=n,await t.call(this,a,this.item.actor,this.item)}catch(e){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(e),n.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:t}));return n}async executeOnUseEffect(){if(!game.user.can("MACRO_SCRIPT"))return ui.notifications.warn("You are not allowed to use JavaScript macros.");if(!this.item.actor)return;const e=OnUseEffect.getOnUseEffect(this.item),t=Function("item","actor",`(async () => {${e}})()`);try{await t.call(this,this.item,this.item.actor)}catch(e){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(e),console.warn(e.stack)}}static getOnUseEffect(e){return e.getFlag("dsa5","onUseEffect")}async automatedAnimation(e,t={}){s.Z.moduleEnabled("autoanimations")&&console.warn("Animations for on use effects not enabled yet")}effectDummy(e,t,a){return{name:e,icon:"icons/svg/aura.svg",changes:t,duration:a,flags:{dsa5:{value:null,editable:!0,customizable:!0,description:e,custom:!0}}}}async socketedConditionAddActor(e,t){if(game.user.isGM){const a="string"==typeof t;a&&((t=duplicate(CONFIG.statusEffects.find((e=>e.id==t)))).name=game.i18n.localize(t.name));const s=[];for(let i of e)a?await i.addCondition(t,1,!1,!1):await i.addCondition(t),s.push(i.name);await this.createInfoMessage(t,s)}else{const a={id:this.item.uuid,data:t,actors:e.map((e=>e.id))};game.socket.emit("system.dsa5",{type:"socketedConditionAddActor",payload:a})}}async createInfoMessage(e,t,a=!0){if(t.length){const i=a?"ActiveEffects.appliedEffect":"ActiveEffects.removedEffect",n=game.i18n.format(i,{source:e.name,target:t.join(", ")});await ChatMessage.create(s.Z.chatDataSetup(n))}}async socketedRemoveCondition(e,t,a=1){if(game.user.isGM){const s=[];for(let i of e){const e=canvas.tokens.get(i);e.actor&&(await e.actor.removeCondition(t,a,!1),s.push(e.name))}const i=CONFIG.statusEffects.find((e=>e.id==t));i.name=game.i18n.localize(i.name),await this.createInfoMessage(i,s,!1)}else{const a={id:this.item.uuid,coreId:t,targets:e};game.socket.emit("system.dsa5",{type:"socketedRemoveCondition",payload:a})}}async socketedActorTransformation(e,t){if(game.user.isGM)for(let a of e){const e=canvas.tokens.get(a);e.actor&&await e.actor.update(t)}else{const a={id:this.item.uuid,targets:e,update:t};game.socket.emit("system.dsa5",{type:"socketedActorTransformation",payload:a})}}async socketedConditionAdd(e,t){if(game.user.isGM){const a="string"==typeof t;a&&((t=duplicate(CONFIG.statusEffects.find((e=>e.id==t)))).name=game.i18n.localize(t.name));const s=[];for(let i of e){const e=canvas.tokens.get(i);e.actor&&(a?await e.actor.addCondition(t,1,!1,!1):await e.actor.addCondition(t),s.push(e.name))}await this.createInfoMessage(t,s)}else{const a={id:this.item.uuid,data:t,targets:e};game.socket.emit("system.dsa5",{type:"socketedConditionAdd",payload:a})}}}},600:(e,t,a)=>{a.d(t,{Z:()=>OpposedDsa5});var s=a(491),i=a(562),n=a(118),r=a(369),o=a(702),l=a(61),c=a(839);class OpposedDsa5{static async handleOpposedTarget(e){if(!e)return;let t=s.Z.getSpeaker(e.speaker);if(!t)return;let a=e.flags.data.postData,i=e.flags.data.preData;t.flags.oppose?OpposedDsa5.answerOpposedTest(t,e,a,i):game.user.targets.size&&e.flags.data.isOpposedTest&&!e.flags.data.defenderMessage&&!e.flags.data.attackerMessage?OpposedDsa5.createOpposedTest(t,e,a,i):e.flags.data.defenderMessage||e.flags.data.attackerMessage?OpposedDsa5.resolveFinalMessage(e):e.flags.data.unopposedStartMessage?OpposedDsa5.redoUndefended(e):e.flags.data.startMessagesList?OpposedDsa5.changeStartMessage(e):(await this.showDamage(e),await this.showSpellWithoutTarget(e))}static async redoUndefended(e){let t=game.messages.get(e.flags.data.unopposedStartMessage);startmessage.flags.unopposeData.attackMessageId=e.id,this.resolveUndefended(t)}static async answerOpposedTest(e,t,a,i){let n=game.messages.get(e.flags.oppose.messageId);if(!n)return ui.notifications.error(game.i18n.localize("DSAError.staleData")),await OpposedDsa5.clearOpposed(e),OpposedDsa5.createOpposedTest(e,t,a,i);let r={speaker:e.flags.oppose.speaker,testResult:n.flags.data.postData,messageId:n.id,img:s.Z.getSpeaker(e.flags.oppose.speaker)?.img};r.testResult.source=n.flags.data.preData.source,r.testResult.ammo&&r.testResult.source.effects.push(...r.testResult.ammo.effects);let o={speaker:t.speaker,testResult:a,messageId:t.id,img:e.msg},l=n.flags.data.defenderMessage?Array.from(n.flags.data.defenderMessage):[];l.push(t.id),game.user.isGM&&await n.update({"flags.data.defenderMessage":l}),await t.update({"flags.data.attackerMessage":n.id}),await this.completeOpposedProcess(r,o,{target:!0,startMessageId:e.flags.oppose.startMessageId,whisper:t.whisper,blind:t.blind}),await OpposedDsa5.clearOpposed(e)}static videoOrImgTag(e){return/\.webm$/.test(e)?`<video loop autoplay src="${e}" width="50" height="50"></video>`:`<img src="${e}" width="50" height="50"/>`}static async createOpposedTest(e,t,a,s){let i;if(i=t.speaker.token?canvas.tokens.get(t.speaker.token).document:e.prototypeToken,a.successLevel>0){let e=t.flags.data.preData.attackOfOpportunity,a=e?"":`<div><button class="unopposed-button small-button chat-button-target" data-target="true">${game.i18n.localize("Unopposed")}</button></div>`,s=[];game.user.targets.forEach((async n=>{if(n.actor){const r=`${OpposedDsa5.opposeMessage(i,n,!1)} ${a}`;let o=await ChatMessage.create({user:game.user.id,content:r,speaker:t.speaker,"flags.unopposeData":{attackMessageId:t.id,targetSpeaker:{scene:n.scene.id,token:n.id,alias:n.document.name}}});const l={speaker:t.speaker,messageId:t.id,startMessageId:o.id};game.user.isGM?await n.actor.update({"flags.oppose":l}):game.socket.emit("system.dsa5",{type:"target",payload:{target:n.id,scene:canvas.scene.id,opposeFlag:l}}),s.push(o.id),e&&await OpposedDsa5.resolveUndefended(o,game.i18n.localize("OPPOSED.attackOfOpportunity")),Hooks.call("DSAOpposedRollStart",n)}})),t.flags.data.startMessagesList=s}else game.user.targets.forEach((async e=>{e.actor&&await ChatMessage.create({user:game.user.id,content:OpposedDsa5.opposeMessage(i,e,!0),speaker:t.speaker})}))}static opposeMessage(e,t,a){return`<div class="opposed-message">\n            <b>${e.name}</b> ${game.i18n.localize("ROLL.Targeting")} <b>${t.document.name}</b> ${a?game.i18n.localize("ROLL.failed"):""}\n            </div>\n            <div class="opposed-tokens row-section">\n                <div class="col two attacker">${OpposedDsa5.videoOrImgTag(e.texture.src)}</div>\n                <div class="col two defender">${OpposedDsa5.videoOrImgTag(t.document.texture.src)}</div>\n            </div>\n             `}static async changeStartMessage(e){for(let t of e.flags.data.startMessagesList){let a=game.messages.get(t),s=a.flags.unopposeData;game.socket.emit("system.dsa5",{type:"target",payload:{target:s.targetSpeaker.token,scene:canvas.scene.id,opposeFlag:{speaker:e.speaker,messageId:e.id,startMessageId:a.id}}}),await a.update({"flags.unopposeData.attackMessageId":e.id})}}static resolveFinalMessage(e){let t,a;if(e.flags.data.defenderMessage)for(let s of e.flags.data.defenderMessage){t=OpposedDsa5.getMessageDude(e);let i=game.messages.get(s);a=OpposedDsa5.getMessageDude(i),this.completeOpposedProcess(t,a,{blind:e.blind,whisper:e.whisper})}else{a=OpposedDsa5.getMessageDude(e);let s=game.messages.get(e.flags.data.attackerMessage);t=OpposedDsa5.getMessageDude(s),this.completeOpposedProcess(t,a,{blind:e.blind,whisper:e.whisper})}}static getMessageDude(e){let t={speaker:e.speaker,testResult:mergeObject(e.flags.data.postData,{source:e.flags.data.preData.source}),img:s.Z.getSpeaker(e.speaker).img,messageId:e.id};return t.testResult.ammo&&t.testResult.source.effects.push(...t.testResult.ammo.effects),t}static async showDamage(e,t=!1){game.user.isGM?t&&e.flags.data.hideDamage||!e.flags.data.postData.damageRoll||(await e.update({content:e.content.replace(`data-hide-damage="${!t}"`,`data-hide-damage="${t}"`),"flags.data.hideDamage":t}),t||i.Z._addRollDiceSoNice(e.flags.data.preData,Roll.fromData(e.flags.data.postData.damageRoll),game.dsa5.apps.DiceSoNiceCustomization.getAttributeConfiguration("damage"))):game.socket.emit("system.dsa5",{type:"showDamage",payload:{id:e.id,hide:t}})}static async playAutomatedJBA2(e,t,a){if(s.Z.moduleEnabled("autoanimations")){const i=s.Z.getSpeaker(e.speaker).getActiveTokens()[0],n=s.Z.getSpeaker(t.speaker).getActiveTokens()[0];if(!(i&&i.actor&&n&&n.actor))return;let r=i.actor.items.get(e.testResult.source._id);if(r||(r=new c.Z(e.testResult.source,{temporary:!0})),!r)return;const o=[n],l="attacker"==a.winner?o:[];AutomatedAnimations.playAnimation(i,r,{targets:o,hitTargets:l,playOnMiss:!0})}}static async showSpellWithoutTarget(e){if(s.Z.moduleEnabled("autoanimations")){const t=getProperty(e,"flags.data");if(!t||t.isOpposedTest)return;if((getProperty(t,"postData.result")||-1)>0){const e=s.Z.getSpeaker(t.postData.speaker).getActiveTokens()[0];if(!e||!e.actor)return;let a=Array.from(game.user.targets);const i=e.actor.items.get(t.preData.source._id);a.length||(a=[e]),AutomatedAnimations.playAnimation(e,i,{targets:a})}}}static async clearOpposed(e){game.user.isGM?await e.update({"flags.-=oppose":null}):game.socket.emit("system.dsa5",{type:"clearOpposed",payload:{actorId:e.id}})}static async _handleReaction(e){let t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=game.messages.get(t);if("skill"===game.messages.get(a.flags.unopposeData.attackMessageId).flags.data.preData.source.type)n.$G.showDialog(a);else n.MN.showDialog(a)}static async chatListeners(e){e.on("click",".unopposed-button",(e=>{e.preventDefault(),this._handleReaction(e)}))}static async hideReactionButton(e){if(e)if(game.user.isGM){let t=game.messages.get(e),a=$(t.content);a.find("button.unopposed-button").remove(),a=$("<div></div>").append(a),await t.update({content:a.html()})}else game.socket.emit("system.dsa5",{type:"hideQueryButton",payload:{id:e}})}static async completeOpposedProcess(e,t,a){let s=await this.evaluateOpposedTest(e.testResult,t.testResult,a);return this.formatOpposedResult(s,e.speaker,t.speaker),this.rerenderMessagesWithModifiers(s,e,t),Hooks.call("finishOpposedTest",e,t,s,a),await this.finishOpposedTestHookAsync(e,t,s,a),this.playAutomatedJBA2(e,t,s),await this.renderOpposedResult(s,a),await this.hideReactionButton(a.startMessageId),s}static async finishOpposedTestHookAsync(e,t,a,s){}static async evaluateOpposedTest(e,t,a={}){let s={other:[]};if(a.additionalInfo&&s.other.push(a.additionalInfo),s.winner="attacker",["weapon","spell","liturgy","ceremony","ritual","combatskill"].includes(e.rollType)&&null==t.successLevel&&(t.successLevel=-5),null!=t.successLevel)switch(e.rollType){case"combatskill":case"talent":this._evaluateTalentOpposedRoll(e,t,s,a);break;case"ceremony":case"ritual":case"spell":case"liturgy":case"weapon":this._evaluateWeaponOpposedRoll(e,t,s,a);break;default:ui.notifications.error("Can not oppose "+e.rollType),console.warn("Can not oppose "+e.rollType)}return s}static _evaluateWeaponOpposedRoll(e,t,a,s={}){if(e.successLevel>0&&t.successLevel<0){const i=this._calculateOpposedDamage(e,t,s);if(i.armorDamaged.damaged&&i.armorDamaged.ids.length){const e=i.armorDamaged.ids.join(";");a.other.push(`<div style="margin-top:10px" class="center"><button class="gearDamaged onlyTarget" data-uuid="${e}">${game.i18n.localize("WEAR.checkShort")}</button></div>`)}t.counterAttack&&(i.damage+=2,i.sum=i.damage-i.armor,i.tooltip=game.i18n.localize("LocalizedIDs.counterAttack")+" 2"),a.winner="attacker";const n=[0!=i.armorMod?""+(i.armorMod+" "+game.i18n.localize("Modifier")):"",1!=i.armorMultiplier?"*"+i.armorMultiplier+" "+game.i18n.localize("Modifier"):"",0!=i.spellArmor?`${i.spellArmor} ${game.i18n.localize("spellArmor")}`:"",0!=i.liturgyArmor?`${i.liturgyArmor} ${game.i18n.localize("liturgyArmor")}`:""].join(""),r=`<b>${game.i18n.localize("damage")}</b>: <span data-tooltip="${i.tooltip||""}">${i.damage}</span><i class="lighticon fas fa-hand-fist" data-tooltip="Roll"></i> - <span data-tooltip="${n}">${i.armor}</span><i class="lighticon fa fa-shield-alt" data-tooltip="protection"></i> = ${i.sum}`;a.damage={description:r,value:i.sum,sp:i.damage}}else a.winner="defender"}static _calculateOpposedDamage(e,t,a={}){const i=s.Z.getSpeaker(t.speaker);a.origin=e.source,a.damage=e.damage;let n=l.Z.applyRollTransformation(i,a,5).options.damage,{wornArmor:c,armor:d}=r.Z.armorValue(i,a),m=[],u=0;const g=e.armorPen||[];for(const e of g)/^\*/.test(e)?m.push(Number(e.replace("*",""))):u+=Number(e);let p=0;["spell","ritual"].includes(e.source.type)?p+=i.system.spellArmor||0:["liturgy","ceremony"].includes(e.source.type)&&(p+=i.system.liturgyArmor||0),d+=u;const h=m.reduce(((e,t)=>e*t),1);d=Math.max(Math.round(d*h),0),d+=p+0;return{damage:n,armor:d,armorDamaged:{damaged:o.Z.armorGetsDamage(n,e),ids:c.map((e=>e.uuid))},armorMod:u,spellArmor:p,liturgyArmor:0,armorMultiplier:h,sum:n-d}}static _evaluateTalentOpposedRoll(e,t,a,s={}){e.successLevel>0&&e.successLevel>t.successLevel?a.winner="attacker":e.qualityStep>t.qualityStep||e.result>=0&&t.result<0?(a.winner="attacker",a.differenceSL=e.qualityStep-t.qualityStep):(a.winner="defender",a.differenceSL=t.qualityStep-e.qualityStep)}static formatOpposedResult(e,t,a){let s=e.differenceSL?"winsFP":"wins";return"attacker"==e.winner?(e.result=game.i18n.format("OPPOSED."+s,{winner:t.alias,loser:a.alias,SL:e.differenceSL}),e.img=t.img):"defender"==e.winner&&(e.result=game.i18n.format("OPPOSED."+s,{winner:a.alias,loser:t.alias,SL:e.differenceSL}),e.img=a.img),e.speakerAttack=t,e.speakerDefend=a,e}static rerenderMessagesWithModifiers(e,t,a){let s=game.messages.get(t.messageId);this.showDamage(s,"attacker"!=e.winner)}static async renderOpposedResult(e,t={}){e.hideData=await game.settings.get("dsa5","hideOpposedDamage");let a=await renderTemplate("systems/dsa5/templates/chat/roll/opposed-result.html",e),s={user:game.user.id,content:a,"flags.opposeData":e,"flags.hideData":e.hideData,whisper:t.whisper,blind:t.blind};t.target&&(s["flags.startMessageId"]=t.startMessageId),await ChatMessage.create(s)}static async resolveUndefended(e,t=""){let a=e.flags.unopposeData,s=game.messages.get(a.attackMessageId),i={speaker:s.speaker,testResult:s.flags.data.postData,messageId:a.attackMessageId};i.testResult.source=s.flags.data.preData.source,i.testResult.ammo&&i.testResult.source.effects.push(...i.testResult.ammo.effects);let n=canvas.tokens.get(a.targetSpeaker.token),r={speaker:a.targetSpeaker,testResult:{actor:n.actor,speaker:{token:a.targetSpeaker.token}}};await this.clearOpposed(n.actor),await this.completeOpposedProcess(i,r,{target:!0,startMessageId:e.id,additionalInfo:t}),game.user.isGM?await s.update({"flags.data.unopposedStartMessage":e.id}):await game.socket.emit("system.dsa5",{type:"updateAttackMessage",payload:{messageId:s.id,startMessageId:e.id}})}}},903:(e,t,a)=>{a.d(t,{Z:()=>RequestRoll});var s=a(538),i=a(231),n=a(491);class RequestRoll{static async requestGC(e,t,a,s=0){const{actor:n,tokenId:r}=i.Z._getActor();if(!n)return;game.user.updateTokenTargets([]);let o={modifier:s,postFunction:{cummulative:a,functionName:"game.dsa5.apps.RequestRoll.autoEditGroupCheckRoll"}};if("attribute"===e);else{const s=n.items.find((a=>a.name==t&&a.type==e));n.setupSkill(s,o,r).then((async s=>{let i=await n.basicTest(s);await RequestRoll.editGroupCheckRoll(a,i,t,e)}))}}static async autoEditGroupCheckRoll(e,t,a){await RequestRoll.editGroupCheckRoll(e.cummulative,t,a.name,a.type)}static async editGroupCheckRoll(e,t,a,s){let i=await game.messages.get(e);const r=i.flags,o=t.result.successLevel>1?2:1;r.botched=r.botched||t.result.successLevel<-1;const l=n.Z.getSpeaker(t.result.speaker);let c={messageId:t.result.messageId,actor:l.name,qs:(t.result.qualityStep||0)*o,success:t.result.successLevel,target:a,type:s},d=r.results.findIndex((e=>e.messageId==c.messageId));d>=0?r.results[d]=c:r.results.push(c),RequestRoll.rerenderGC(i,r)}static async requestRoll(e,t,a=0){const{actor:s,tokenId:n}=i.Z._getActor();if(s){game.user.updateTokenTargets([]);let i={modifier:a};switch(e){case"attribute":let a=Object.keys(game.dsa5.config.characteristics).find((e=>game.i18n.localize(game.dsa5.config.characteristics[e])==t));s.setupCharacteristic(a,i,n).then((e=>{s.basicTest(e)}));break;case"regeneration":s.setupRegeneration("regenerate",i,n).then((e=>{s.basicTest(e)}));break;case"fallingDamage":s.setupFallingDamage(i,n);break;default:let r=s.items.find((a=>a.name==t&&a.type==e));s.setupSkill(r,i,n).then((e=>{s.basicTest(e)}))}}}static async rerenderGC(e,t){if(game.user.isGM){let a=0;t.qs=t.results.reduce(((e,t)=>(a+=t.success<0?1:0,t.success>1&&(a=0),e+t.qs)),0),t.failed=a;for(let e of t.rollOptions)e.calculatedModifier=e.modifier-a;t.openRolls=t.maxRolls-t.results.length,t.doneRolls=t.results.length;const s=await renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",t);e.update({content:s,flags:t})}else game.socket.emit("system.dsa5",{type:"updateGroupCheck",payload:{messageId:e.id,data:t}});$("#chat-log").find(`[data-message-id="${e.id}"`).appendTo("#chat-log")}static showRQMessage(e,t=0){const a=t<0?` ${t}`:t>0?` +${t}`:"",s=i.Z.skills.find((t=>t.name==e)).type,r=game.i18n.format("CHATNOTIFICATION.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${s}" data-modifier="${t}" data-name="${e}"><i class="fas fa-dice"></i> ${e}${a}</a>`});ChatMessage.create(n.Z.chatDataSetup(r))}static async showGCMessage(e,t=0,a={}){const s=i.Z.skills.find((t=>t.name==e)).type,r={results:[],qs:0,failed:0,modifier:t,name:game.user.name,maxRolls:7,openRolls:7,doneRolls:0,targetQs:10,rollOptions:[{type:s,modifier:t,calculatedModifier:t,target:e}]};mergeObject(r,a);const o=await renderTemplate("systems/dsa5/templates/chat/roll/groupcheck.html",r);let l=n.Z.chatDataSetup(o);l.flags=r,ChatMessage.create(l)}static async addSkillToGC(e){const t=$(e.currentTarget).parents(".message").attr("data-message-id"),a=await renderTemplate("systems/dsa5/templates/dialog/addgroupcheckskill.html",{skills:i.Z.skills.filter((e=>"skill"==e.type)).sort(((e,t)=>e.name.localeCompare(t.name)))});let n={title:game.i18n.localize("HELP.groupcheck"),content:a,buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async e=>{const a=game.messages.get(t),s=a.flags;s.rollOptions.push({type:"skill",modifier:e.find('[name="modifier"]').val(),target:e.find('[name="skill"]').val()}),RequestRoll.rerenderGC(a,s)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new s.Z(n).render(!0)}static async removeGCEntry(e){const t=$(e.currentTarget),a=Number(e.currentTarget.dataset.index),s=game.messages.get(t.parents(".message").attr("data-message-id")),i=s.flags;i.results.splice(a,1),RequestRoll.rerenderGC(s,i)}static removeSkillFromGC(e){const t=$(e.currentTarget),a=game.messages.get(t.parents(".message").attr("data-message-id")),s=a.flags;s.rollOptions=s.rollOptions.filter((t=>!(t.type==e.currentTarget.dataset.type&&t.target==e.currentTarget.dataset.name))),s.results=s.results.filter((t=>!(t.type==e.currentTarget.dataset.type&&t.target==e.currentTarget.dataset.name))),RequestRoll.rerenderGC(a,s)}static async editGC(e){const t=$(e.currentTarget),a=Number(e.currentTarget.dataset.index),s=game.messages.get(t.parents(".message").attr("data-message-id")),i=s.flags;if(a)i.results[a].qs=Number(t.val());else if(e.currentTarget.dataset.name){i.rollOptions.find((t=>t.target==e.currentTarget.dataset.name&&e.currentTarget.dataset.type==t.type))[e.currentTarget.dataset.field]=Number(t.val())}else i[e.currentTarget.dataset.field]=Number(t.val());RequestRoll.rerenderGC(s,i)}static async updateInformationRoll(e,t,a){const s=t.result.qualityStep||0;if(s>0){const t=await fromUuid(e.uuid),a=[`<p><b>${t.name}</b></p>`];for(let e=1;e<=s;e++){const s=`qs${e}`;if(t.system[s]){const e=await TextEditor.enrichHTML(t.system[s],{async:!0});a.push(`<p>${e}</p>`)}}const i=n.Z.chatDataSetup(a.join(""));e.recipients.length&&(i.whisper=e.recipients),ChatMessage.create(i)}}static async informationRequestRoll(e){const t=e.currentTarget.dataset.mod,a=e.currentTarget.dataset.uuid,{actor:s,tokenId:n}=i.Z._getActor();if(!s)return;const r=game.settings.get("dsa5","informationDistribution");let o=[];1==r?(o=game.users.filter((e=>e.isGM)).map((e=>e.id)),o.push(game.user.id)):2==r&&(o=game.users.filter((e=>e.isGM)).map((e=>e.id)));const l={modifier:t,postFunction:{functionName:"game.dsa5.apps.RequestRoll.updateInformationRoll",uuid:a,recipients:o}};let c=s.items.find((t=>t.name==e.currentTarget.dataset.skill&&"skill"==t.type));s.setupSkill(c,l,n).then((async e=>{e.testData.opposable=!1;const t=await s.basicTest(e);this.updateInformationRoll(l.postFunction,t)}))}static chatListeners(e){e.on("change",".editGC",(e=>RequestRoll.editGC(e))),e.on("click",".request-roll",(e=>{const t=e.currentTarget.dataset;RequestRoll.requestRoll(t.type,t.name,Number(t.modifier)||0)})),e.on("click",".request-gc",(e=>{const t=e.currentTarget.dataset;RequestRoll.requestGC(t.type,t.name,$(e.currentTarget).parents(".message").attr("data-message-id"),Number(t.modifier)||0)})),e.on("click",".removeGC",(e=>RequestRoll.removeGCEntry(e))),e.on("click",".removeSkillFromGC",(e=>RequestRoll.removeSkillFromGC(e))),e.on("click",".addSkillToGC",(e=>RequestRoll.addSkillToGC(e))),e.on("click",".informationRequestRoll",(e=>RequestRoll.informationRequestRoll(e)))}}},169:(e,t,a)=>{a.d(t,{Z:()=>Riding});var s=a(491);class Riding{static preRenderedUnmountHud='\n    <div class="control-icon" data-action="ride">\n        <i class="fas fa-horse" style="transform: rotate(180deg)" data-tooltip="RIDING.unmount" width="36" height="36">\n    </div>\n    ';static preRenderedMountHud='<div class="control-icon" data-action="ride"><i class="fas fa-horse" data-tooltip="RIDING.mount" width="36" height="36"></div>';static preRenderedSpeedHud='\n    <div class="control-icon" data-action="rideIncrease"><i class="fas fa-caret-up" data-tooltip="RIDING.increase" width="36" height="36"></div>\n    <div class="control-icon" data-action="rideDecrease"><i class="fas fa-caret-down" data-tooltip="RIDING.decrease" width="36" height="36"></div>\n    ';static async createTokenHook(e,t,a){if(!s.Z.isActiveGM())return;const i=e.parent;if(this.isRiding(e.actor)&&i.active){const t=this.getHorse(e.actor);if(!t)return;const a=await t.getTokenDocument();a.updateSource({x:e.x,y:e.y,hidden:e.hidden});const s=(await i.createEmbeddedDocuments("Token",[a]))[0],n={"flags.dsa5.horseTokenId":s.id,elevation:(s.elevation??0)+1};mergeObject(n,this.adaptTokenSize(e,s)),await e.update(n),s.actorLink||await e.actor.update({"system.horse.actorLink":!1,"system.horse.token":{scene:i.id,token:s.id}})}}static isRiding(e){return getProperty(e,"system.horse.isRiding")}static updateTokenHook(e,t,a){if(!s.Z.isActiveGM())return;const i=getProperty(e,"flags.dsa5.horseTokenId"),n=e.parent;i&&n.active&&(t.x||t.y)&&this.isRiding(e.actor)&&n.updateEmbeddedDocuments("Token",[{_id:i,x:e.x,y:e.y}])}static rollLoyalty(e,t={}){const a=this.getHorse(e);if(!a)return;const i=this.getLoyaltyFromHorse(a);if(!i)return ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:s.Z.categoryLocalization("skill"),name:game.i18n.localize("LocalizedIDs.loyalty")}));a.setupSkill(i,t,a.token?.id).then((e=>{a.basicTest(e)}))}static async updateRiderSpeed(e,t){if(!canvas?.tokens?.documentCollection)return;const a=e.getActiveTokens().map((e=>e.id));for(let e of Array.from(canvas.tokens.documentCollection))a.includes(e.getFlag("dsa5","horseTokenId"))&&t!=e.actor.system.status.speed.max&&(e.actor.prepareData(),e.actor.sheet.render())}static getLoyaltyFromHorse(e){return e.items.find((e=>"skill"==e.type&&e.name.startsWith(game.i18n.localize("LocalizedIDs.loyalty"))))}static activateListeners(e,t){e.find(".riding-toggle").click((()=>this.toggleIsRiding(t))),e.find(".showHorse").click((()=>this.getHorse(t).sheet.render(!0))),e.find(".horse-delete").click((()=>this.clearMount(t))),e.find(".horse-loyalty").click((()=>this.rollLoyalty(t))),e.find('[name="horseSpeedSelector"]').change((async e=>{e.preventDefault();const a=Riding.getHorse(t);Riding.setSpeed(a,e.currentTarget.value)}))}static async toggleIsRiding(e){await e.update({"system.horse.isRiding":!e.system.horse?.isRiding});const t=[];if(e.system.horse.isRiding){const a=this.getHorse(e);let s;for(let e of a.getActiveTokens())t.push({_id:e.document.id,"flags.dsa5.-=horseTokenId":null}),s=e.document.id;for(let a of e.getActiveTokens())t.push({_id:a.document.id,elevation:Math.max(0,(a.elevation??0)+1),"flags.dsa5.horseTokenId":s});await this.addRidingCondition(e)}else{for(let a of e.getActiveTokens())t.push({_id:a.document.id,"flags.dsa5.-=horseTokenId":null,elevation:Math.max(0,(a.elevation??0)-1)});await this.removeRidingCondition(e)}await canvas.scene.updateEmbeddedDocuments("Token",t,{noHooks:!0})}static getRidingCondition(e){const t=game.i18n.localize("RIDING.riding");return e.effects.find((e=>e.name==t))}static async addRidingCondition(e){this.getRidingCondition(e)||await e.addCondition(this.ridingCondition())}static async removeRidingCondition(e){const t=this.getRidingCondition(e);t&&await e.deleteEmbeddedDocuments("ActiveEffect",[t.id])}static deleteTokenHook(){console.warn("delete riding token hook not implemented")}static getHorse(e,t=!1){let a;return e.system.horse&&(a=e.system.horse.token&&!e.system.horse.actorLink?s.Z.getSpeaker(e.system.horse.token):game.actors.get(e.system.horse.actorId),!a&&t&&e.system.horse.isRiding&&(a={name:game.i18n.localize("unknown")})),a}static async unmountHorse(e,t){const a={"flags.dsa5.-=horseTokenId":null,elevation:Math.max(0,(t.elevation??0)-1)},s=t.getFlag("dsa5","horseResized");s&&mergeObject(a,{"flags.dsa5.-=horseResized":null,width:s.width,height:s.height}),await this.clearMount(e),await t.update(a)}static async clearMount(e){await e.update({system:{horse:{isRiding:!1,actorLink:!1,actorId:"","-=token":null}}}),await this.removeRidingCondition(e)}static ridingCondition(){return{name:game.i18n.localize("RIDING.riding"),icon:"systems/dsa5/icons/thirdparty/horse-head.svg",changes:[{key:"system.status.dodge.gearmodifier",mode:2,value:-2}],flags:{dsa5:{description:game.i18n.localize("RIDING.ridingDescription")}}}}static async setHorse(e,t){const a={system:{horse:{isRiding:!0,actorLink:t.prototypeToken.actorLink,actorId:t.id}}};!t.prototypeToken.actorLink&&t.token&&mergeObject(a,{system:{horse:{token:{scene:canvas.scene.id,token:t.token.id}}}}),await e.update(a),t.isToken&&await canvas.scene.updateEmbeddedDocuments("Token",e.getActiveTokens().map((e=>({_id:e.id,"flags.dsa5.horseTokenId":t.token.id,x:t.token.x,y:t.token.y}))).concat({_id:t.token.id,"flags.dsa5.-=horseTokenId":null}),{noHooks:!0}),await this.addRidingCondition(e)}static adaptTokenSize(e,t){return e.width>=t.width?{width:.7*t.width,height:.7*t.height,"flags.dsa5.horseResized":{width:e.width,height:e.height}}:{}}static async mountHorse(e){const t=canvas.tokens.controlled.find((t=>t.document.id!=e.id)),a=e.parent,s={system:{horse:{isRiding:!0,actorLink:t.actorLink,actorId:t.actor.id}}};t.actorLink||mergeObject(s,{system:{horse:{token:{scene:a.id,token:t.id}}}});const i={_id:e.id,"flags.dsa5.horseTokenId":t.id,x:t.x,y:t.y,elevation:(t.document.elevation??0)+1};mergeObject(i,this.adaptTokenSize(e.document,t.document)),await e.actor.update(s),await canvas.scene.updateEmbeddedDocuments("Token",[i,{_id:t.id,"flags.dsa5.-=horseTokenId":null}],{noHooks:!0}),await this.addRidingCondition(e.actor)}static speedKeys={0:{key:"system.status.speed.multiplier",mode:5,value:0},"-4":{key:"system.status.speed.initial",mode:5,value:4},"-5000":{key:"system.status.speed.multiplier",mode:5,value:.66},"-8":{key:"system.status.speed.multiplier",mode:5,value:1}};static getHorseSpeed(e){return e.effects.find((e=>getProperty(e,"flags.dsa5.horseSpeed")))?.flags.dsa5.horseSpeed||0}static horseSpeedModifier(e){const t=this.getHorseSpeed(e);return Object.keys(this.speedKeys).map((e=>Number(e))).indexOf(Number(t))}static increaseSpeed(e){const t=this.getHorseSpeed(e),a=Math.min(3,Object.keys(this.speedKeys).map((e=>Number(e))).indexOf(t)+1);this.setSpeed(e,Object.keys(this.speedKeys).map((e=>Number(e)))[a])}static decreaseSpeed(e){const t=this.getHorseSpeed(e),a=Math.max(0,Object.keys(this.speedKeys).map((e=>Number(e))).indexOf(t)-1);this.setSpeed(e,Object.keys(this.speedKeys).map((e=>Number(e)))[a])}static async setSpeed(e,t){await e.deleteEmbeddedDocuments("ActiveEffect",e.effects.filter((e=>hasProperty(e,"flags.dsa5.horseSpeed"))).map((e=>e.id))),await e.addCondition({name:game.i18n.localize("speed")+": "+game.i18n.localize(`RIDING.speeds.${t}`),icon:"systems/dsa5/icons/thirdparty/horse-head.svg",changes:[this.speedKeys[t]],flags:{dsa5:{description:game.i18n.localize(`RIDING.speed.${t}`),horseSpeed:t}}})}static renderTokenHUD(e,t,a){const s=e.object.actor;if(2==canvas.tokens.controlled.length){t.find(".col.left").prepend(this.preRenderedMountHud);t.find('.control-icon[data-action="ride"]').click((()=>this.mountHorse(e.object)))}else if(this.isRiding(s)){t.find(".col.left").prepend(this.preRenderedUnmountHud);const a=t.find('.control-icon[data-action="ride"]');a.click((()=>{this.unmountHorse(s,e.object.document),a.remove()}));const i=this.getHorse(s);t.find(".col.right").prepend(this.preRenderedSpeedHud);t.find('.control-icon[data-action="rideIncrease"]').click((()=>this.increaseSpeed(i)));t.find('.control-icon[data-action="rideDecrease"]').click((()=>this.decreaseSpeed(i)))}}}},122:(e,t,a)=>{a.d(t,{Z:()=>RuleChaos});var s=a(973),i=a(173),n=a(491);class RuleChaos{static regex2h=/\(2H/;static multipleDefenseValue(e,t){let a=-3;return"dodge"!=t.type&&getProperty(t,"system.combatskill.value")!=game.i18n.localize("LocalizedIDs.wrestle")||!i.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulDodge"))?i.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.mightyMasterfulParry"))?a=-1:i.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.masterfulParry"))&&(a=-2):a=-2,i.Z.hasAbility(e,game.i18n.localize("LocalizedIDs.vinsaltStyle"))&&(a-=1),Math.min(0,a)}static async bleedingMessage(e){await ChatMessage.create(n.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.applyBleeding",{actor:e.name,actorId:e.id,tokenId:e.token?e.token.id:""})))}static _getFunctionData(e){return{data:e.currentTarget.dataset,actor:n.Z.getSpeaker({token:e.currentTarget.dataset.token,actor:e.currentTarget.dataset.actor,scene:canvas.scene?canvas.scene.id:null})}}static quantityClick(e){const t=e.currentTarget.dataset.quantityfocus,a=$(e.currentTarget);if(t&&!a.is(":focus"))return void setTimeout((function(){a.select()}));const s={val:Number(a.val())};RuleChaos.increment(e,s,"val"),a.val(s.val)}static getGroupSchips(){const e=game.settings.get("dsa5","groupschips").split("/").map((e=>Number(e))),t=[];for(let a=1;a<=e[1];a++)t.push({value:a,cssClass:a<=e[0]?"fullSchip":"emptySchip"});return t}static ensureNumber(e){e.system.AsPCost.value=Number(e.system.AsPCost.value)||e.system.AsPCost.value}static isYieldedTwohanded(e){const t=this.regex2h.test(e.name),a=e.system.worn.wrongGrip;return t&&!a||!t&&a}static obfuscateDropData(e,t){if(t)for(let a of t)mergeObject(e,{system:{obfuscation:{[a]:!0}}})}static _buildDuration(e){const t={duration:{startTime:game.time.worldTime,rounds:e,seconds:5*e}};return game.combat&&mergeObject(t,{duration:{combat:game.combat.id,startRound:game.combat.round,startTurn:game.combat.turn}}),t}static async calcBleeding(e){const{data:t,actor:a}=RuleChaos._getFunctionData(e);if(!a)return;const i=a.items.find((e=>e.name==game.i18n.localize("LocalizedIDs.selfControl")&&"skill"==e.type));a.setupSkill(i,{},t.token).then((async e=>{const t=await a.basicTest(e);if(t.result.successLevel<2){const e=t.result.qualityStep||0;let i=7;1==t.result.successLevel?i-=Number(e):t.successLevel<1&&(i+=i);const r=a.hasCondition("bleeding"),o=RuleChaos._buildDuration(i);if(r){i>(game.combat?(r.data.duration.startRound||1)+r.data.duration.rounds-game.combat.round:r.data.duration.rounds)&&await r.update(o)}else{const e=duplicate(CONFIG.statusEffects.find((e=>"bleeding"==e.id)));mergeObject(e,o),await s.Z.addCondition(a,e,1,!1,!0),await ChatMessage.create(n.Z.chatDataSetup(game.i18n.format("CHATNOTIFICATION.gotBleeding",{actor:a.name})))}}}))}static increment(e,t,a,s){const i=e.ctrlKey?10:1,n=2==e.button?-1:1;let r=getProperty(t,a)+i*n;return null!=s&&(r=Math.max(s,r)),setProperty(t,a,r),r}static magicalImprovement(e,t){for(let t of e.items)["ritual","spell"].includes(t.type)&&(t.system.talentValue.value+=4)}}},173:(e,t,a)=>{a.d(t,{Z:()=>SpecialabilityRulesDSA5});var s=a(577),i=a(794),n=a(492);class SpecialabilityRulesDSA5 extends i.Z{static setupFunctions(){}static async abilityAdded(e,t){s.Z.addAbilityRules[t.name]&&s.Z.addAbilityRules[t.name](e,t)}static async abilityRemoved(e,t,a=!0){s.Z.removeAbilityRules[t.name]&&s.Z.removeAbilityRules[t.name](e,t);let i=SpecialabilityRulesDSA5.calcAPCostSum(t);i=await SpecialabilityRulesDSA5.refundFreelanguage(t,e,i,a),await e._updateAPs(-1*i,{},{render:a})}static async _specialabilityReturnFunction(e,t,a,i){if(null==t)return;if(t=duplicate(t),null!=i){if(/,/.test(t.system.APValue.value)){let a=`${t.name.replace(" ()","")} (${i.name}`;t.system.APValue.value=t.system.APValue.value.split(",")[e.items.filter((e=>e.type==t.type&&e.name.includes(a))).length].trim()}SpecialabilityRulesDSA5.simpleAdoption(t,i,t.name,s.Z.AbilitiesNeedingAdaption),t.name=`${t.name.replace(" ()","")} (${i.name}${i.customEntry?", "+i.customEntry:""})`,i.data&&i.system.StF?.value&&/\//.test(t.system.APValue.value)&&(t.system.APValue.value=t.system.APValue.value.split("/")[i.system.StF.value.charCodeAt(0)-65].trim())}let n=e.items.find((e=>e.type==a&&e.name==t.name));if(n){let a=duplicate(n),s=await SpecialabilityRulesDSA5.isFreeLanguage(t,e,/;/.test(a.system.APValue.value)?a.system.APValue.value.split(";").map((e=>Number(e.trim())))[a.system.step.value]:a.system.APValue.value,!1);a.system.step.value+1<=a.system.maxRank.value&&await e.checkEnoughXP(s)&&(a.system.step.value+=1,await e._updateAPs(s,{},{render:!1}),await e.updateEmbeddedDocuments("Item",[a]),await SpecialabilityRulesDSA5.abilityAdded(e,a))}else{let a=await SpecialabilityRulesDSA5.isFreeLanguage(t,e,t.system.APValue.value.split(";").map((e=>e.trim()))[0],!1);await e.checkEnoughXP(a)&&(await SpecialabilityRulesDSA5.abilityAdded(e,t),await e._updateAPs(a,{},{render:!1}),await e.createEmbeddedDocuments("Item",[t]))}}static async refundFreelanguage(e,t,a,s=!0){if("language"==e.system.category.value&&t.system.freeLanguagePoints){let e=Number(t.system.freeLanguagePoints.value),i=t.items.filter((e=>"specialability"==e.type&&"language"==e.system.category.value)).reduce(((e,t)=>e+Number(t.system.step.value)*Number(t.system.APValue.value)),0),n=Math.min(e,i-Number(a)),r=Math.max(0,e-n);await t.update({"system.freeLanguagePoints.used":Math.min(e,Number(n))},{render:s}),a=Math.max(0,a-r)}return a}static async isFreeLanguage(e,t,a,s=!0){if("language"==e.system.category.value&&t.system.freeLanguagePoints){let e=Number(t.system.freeLanguagePoints.value),i=t.items.filter((e=>"specialability"==e.type&&"language"==e.system.category.value)).reduce(((e,t)=>e+Number(t.system.step.value)*Number(t.system.APValue.value)),0),n=Math.min(e,i),r=Math.max(0,e-n);await t.update({"system.freeLanguagePoints.used":Math.min(e,Number(n)+Number(a))},{render:s}),a=Math.max(0,a-r)}return a}static async needsAdoption(e,t,a){let i=s.Z.AbilitiesNeedingAdaption[t.name];if(i){let s,r;if("text"==i.items)s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-string-dialog.html",{original:t}),r=function(s){let i={name:s.find('[name="entryselection"]').val()};SpecialabilityRulesDSA5._specialabilityReturnFunction(e,t,a,i)};else if("array"==i.items){let n=i.elems.map((e=>({name:e})));s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:i.area}),r=function(s){let i=n.find((e=>e.name==s.find('[name="entryselection"]').val()));SpecialabilityRulesDSA5._specialabilityReturnFunction(e,t,a,i)}}else{let n=e.items.filter((e=>i.items.includes(e.type))).sort(((e,t)=>e.name.localeCompare(t.name)));s=await renderTemplate("systems/dsa5/templates/dialog/requires-adoption-dialog.html",{items:n,original:t,area:i.area}),r=function(s){let i=n.find((e=>e.name==s.find('[name="entryselection"]').val()));i.customEntry=s.find('[name="custom"]').val(),SpecialabilityRulesDSA5._specialabilityReturnFunction(e,t,a,i)}}await new n.Z({title:game.i18n.localize("DIALOG.ItemRequiresAdoption"),content:s,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:r},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}else SpecialabilityRulesDSA5._specialabilityReturnFunction(e,t,a,null)}static hasAbility(e,t){return super.hasItem(e,t,["specialability"])}static abilityStep(e,t){return super.itemStep(e,t,["specialability"])}static abilityAsModifier(e,t,a=1,s=!1){return super.itemAsModifier(e,t,a,["specialability"],s)}}i.Z.children.SpecialabilityRulesDSA5=SpecialabilityRulesDSA5},101:(e,t,a)=>{a.d(t,{Z:()=>TraitRulesDSA5});var s=a(577),i=a(794),n=a(491);class TraitRulesDSA5 extends i.Z{static async traitAdded(e,t){s.Z.addTraitRules[t.name]&&await s.Z.addTraitRules[t.name](e,t)}static hasTrait(e,t){return super.hasItem(e,t,["trait"])}}Hooks.on("setup",(()=>{const e=game.i18n.localize("LocalizedIDs.familiar");s.Z.addTraitRules[e]=async(t,a)=>{0==a.effects.length&&(a.effects=[{changes:[{key:"system.status.wounds.gearmodifier",mode:2,value:10},{key:"system.status.soulpower.gearmodifier",mode:2,value:1},{key:"system.status.toughness.gearmodifier",mode:2,value:1},{key:"system.status.astralenergy.gearmodifier",mode:2,value:15},{key:"system.characteristics.mu.gearmodifier",mode:2,value:1},{key:"system.characteristics.kl.gearmodifier",mode:2,value:1},{key:"system.characteristics.in.gearmodifier",mode:2,value:1},{key:"system.characteristics.ch.gearmodifier",mode:2,value:1},{key:"system.characteristics.ff.gearmodifier",mode:2,value:1},{key:"system.characteristics.ge.gearmodifier",mode:2,value:1},{key:"system.characteristics.ko.gearmodifier",mode:2,value:1},{key:"system.characteristics.kk.gearmodifier",mode:2,value:1},{key:"system.totalArmor",mode:2,value:1}],duration:{},icon:"icons/svg/aura.svg",name:e,transfer:!0,flags:{dsa5:{value:null,editable:!0,description:e,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}}}]);const s=game.i18n.localize("LocalizedIDs.witchSense");if(!i.Z.hasItem(t,s,["trait"])){const e=await n.Z.findAnyItem([{name:s,type:"trait"}]);await t.createEmbeddedDocuments("Item",e)}}}))},491:(e,t,a)=>{a.d(t,{Z:()=>DSA5_Utility});var s=a(369),i=a(846),n=a(577);class DSA5_Utility{static async skillByName(e){const t=game.packs.get("de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen");await t.getIndex();const a=t.index.find((t=>t.name===e));return await t.getDocument(a._id)}static async allSkills(){const e="de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen";return await this.getCompendiumEntries(e,"skill")}static moduleEnabled(e){return game.modules.get(e)&&game.modules.get(e).active}static async allCombatSkills(){const e="de"==game.i18n.lang?"dsa5.skills":"dsa5.skillsen";return await this.getCompendiumEntries(e,"combatskill")}static async getCompendiumEntries(e,t){const a=await game.packs.get(e);if(!a)return ui.notifications.error("No content found");const s=Array.isArray(t)?t:[t];return(await a.getDocuments()).filter((e=>s.includes(e.type))).map((e=>e.toObject()))}static renderToggle(e){e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}static calcTokenSize(e,t){let a=game.dsa5.config.tokenSizeCategories[e.system.status.size.value];if(a)if(a<1)mergeObject(t,{texture:{scaleX:a,scaleY:a},width:1,height:1});else{const e=Math.floor(a),s=Math.max(a/e,.25);mergeObject(t,{width:e,height:e,texture:{scaleX:s,scaleY:s}})}}static async allMoneyItems(){return(await this.getCompendiumEntries("dsa5.money","money")).map((e=>(e.system.quantity.value=0,e))).filter((e=>Object.values(n.Z.moneyNames).map((e=>e.toLowerCase())).includes(e.name.toLowerCase()))).sort(((e,t)=>e.system.price.value>t.system.price.value?-1:1))}static async allSkillsList(){return(await this.allSkills()||[]).map((e=>e.name)).sort(((e,t)=>e.localeCompare(t)))}static async allCombatSkillsList(e){return((await this.allCombatSkills()).filter((t=>t.system.weapontype.value==e))||[]).map((e=>e.name)).sort(((e,t)=>e.localeCompare(t)))}static async callItemTransformationMacro(e,t,a,s={}){const i=e.split("."),n=game.packs.get(`${i[0]}.${i[1]}`);if(!n)return console.warn(`Pack ${n} not found`),{};let r=await n.getDocuments({name:i[2]}),o={};if(r.length){const e=`(async () => {${r[0].command}})()`,i=Function("args","source","effect",e);try{s.result=o,await i.call(this,s,t,a)}catch(e){ui.notifications.error("There was an error in your macro syntax. See the console (F12) for details"),console.error(e),o.error=!0}}else ui.notifications.error(game.i18n.format("DSAError.macroNotFound",{name:e}));return o}static isActiveGM(){const e=game.users.find((e=>e.active&&e.isGM));return e&&game.user.id==e.id}static parseAbilityString(e){return{original:e.replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),name:e.replace(/\((.+?)\)/g,"()").replace(/ (FP|SR|FW|SP)?[+-]?\d{1,2}$/,"").trim(),step:Number((e.match(/[+-]?\d{1,2}$/)||[1])[0]),special:(e.match(/\(([^()]+)\)/)||["",""])[1],type:e.match(/ (FP|SP)[+-]?\d{1,2}/)?"FP":e.match(/ (FW|SR)[+-]?\d{1,2}/)?"FW":"",bonus:null!=e.match(/[-+]\d{1,2}$/)}}static categoryLocalization(e){return game.i18n.localize(`TYPES.Item.${e}`)}static attributeLocalization(e){return game.i18n.localize(`CHAR.${e.toUpperCase()}`)}static attributeAbbrLocalization(e){return game.i18n.localize(`CHARAbbrev.${e.toUpperCase()}`)}static async callAsyncHooks(e,t){for(let a of n.Z.asyncHooks[e])await a(...t)}static chatDataSetup(e,t,a,s){let i={user:game.user.id,rollMode:t||game.settings.get("core","rollMode"),content:e};return["gmroll","blindroll"].includes(i.rollMode)&&(i.whisper=ChatMessage.getWhisperRecipients("GM").map((e=>e.id))),"blindroll"===i.rollMode?i.blind=!0:"selfroll"===i.rollMode&&(i.whisper=[game.user]),a&&(i.speaker=ChatMessage.getSpeaker(),i.whisper=ChatMessage.getWhisperRecipients(a)),s&&(i.speaker=ChatMessage.getSpeaker(),i.whisper=s),i}static getSpeaker(e){let t=ChatMessage.getSpeakerActor(e);if(!t&&canvas.tokens){let a=canvas.tokens.get(e.token);a&&(t=a.actor)}if(!t){let a=game.scenes.get(e.scene);try{a&&(t=new Token(a.getEmbeddedDocument("Token",e.token))?.actor)}catch(e){}}return t}static fateAvailable(e,t){return t?game.settings.get("dsa5","groupschips").split("/").map((e=>Number(e)))[0]>0:e.system.status.fatePoints.value>0}static _calculateAdvCost(e,t,a=1){return n.Z.advancementCosts[t][Number(e)+a]}static async getFolderForType(e,t=null,a=null,s=0,i="",n){let r=await game.folders.contents.find((s=>s.name==a&&s.type==e&&s.folder?.id==t));return r||(r=await Folder.create({name:a,type:e,sorting:n||("JournalEntry"==e?"a":"m"),color:i,sort:s,parent:t})),r}static toObjectIfPossible(e){return"function"==typeof e.toObject?e.toObject(!1):duplicate(e)}static async showArtwork({img:e,name:t,uuid:a,isOwner:s},i=!1){return new ImagePopout(e,{title:i?s?t:"-":t,shareable:!0,uuid:a}).render(!0)}static async findAnyItem(e){let t=[],a=e.map((e=>e.name)),s=e.map((e=>e.type));for(let e of game.items.contents){let i=a.indexOf(e.name);if(i>=0&&s[i]==e.type&&(a.splice(i,1),s.splice(i,1),t.push(e.toObject())),a.length<=0)break}if(a.length>0){const e=/^dsa5-core/,i=Array.from(game.packs.keys()).sort(((t,a)=>(e.test(t)&&e.test(a)&&t.localeCompare(a),e.test(a)?-1:e.test(t)?1:t.localeCompare(a))));for(let e of i){let i=game.packs.get(e);if("Item"==i.documentName&&(game.user.isGM||!i.private)&&(await i.getDocuments({name__in:a,type__in:s}).then((e=>{for(let i of e){let e=a.indexOf(i.name);e>=0&&s[e]==i.type&&(a.splice(e,1),s.splice(e,1),t.push(i.toObject()))}})),a.length<=0))break}}return t}static replaceDies(e,t=!1){let a=t?"":"/r ";return e.replace(/( |^)(\d{1,2})?[wWdD][0-9]+((\+|-)[0-9]+)?/g,(function(e){return` [[${a}${e.replace(/[DwW]/,"d")}]]`}))}static escapeRegex(e){return("string"==typeof e||e instanceof String?e:"").replace(/[-[/\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static replaceConditions(e){return e?e.replace(n.Z.statusRegex.regex,(e=>(0,i.q)([e]))):e}static experienceDescription(e){const t=[2100,1700,1400,1200,1100,1e3],a=["EXP.legendary","EXP.brillant","EXP.masterful","EXP.competent","EXP.experienced","EXP.average"];let s=0;for(const i of t){if(Number(e)>=Number(i))return a[s];s++}return"EXP.inexperienced"}static async emptyActor(e=12,t="Alrik"){Array.isArray(e)||(e=[e,e,e,e,e,e,e,e]);const a=await s.Z.create({name:t,type:"npc",items:[],system:{status:{wounds:{value:50},fatePoints:{}},characteristics:{mu:{initial:e[0]},kl:{initial:e[1]},in:{initial:e[2]},ch:{initial:e[3]},ff:{initial:e[4]},ge:{initial:e[5]},ko:{initial:e[6]},kk:{initial:e[7]}}}},{temporary:!0,noHook:!0});return a.prepareData(),a}}},707:(e,t,a)=>{function svgAutoFit(e,t=320,a=40){e.attr({width:.8*t,viewBox:`0 0 ${t} ${a}`});const s=e.find("text"),i=s.get(0).getBBox(),n=t/i.width,r=a/i.height,o=n<r,l=o?n:r;isFinite(l)&&s.attr({transform:"matrix("+l+", 0, 0, "+l+", 0,0)",x:Math.max(0,(t-i.width)/2),y:.75*a/(o?1:l)})}function delay(e){return new Promise((t=>setTimeout(t,e)))}async function itemFromDrop(e,t,a=!0){let s,i;"Actor"==e.type?(s=await Actor.implementation.fromDropData(e),i=t===s.id):(s=await Item.implementation.fromDropData(e),i=t===s.parent?.uuid);let n=s?.type;return a&&(s=s.toObject()),e.amount&&(s.system.quantity.value=Number(e.amount)),{item:s,typeClass:n,selfTarget:i}}function slist(e,t,a,s="div"){if(!(t=e.find(t)[0]))return;t.classList.add("slist");let i=t.querySelectorAll(s),n=null;for(let e of i)e.draggable=!0,e.addEventListener("dragstart",(function(e){n=this})),e.addEventListener("dragover",(function(e){e.preventDefault()})),e.addEventListener("drop",(async function(e){if(e.preventDefault(),this!=n){let e=0,s=0;for(let t=0;t<i.length;t++)n==i[t]&&(e=t),this==i[t]&&(s=t);e<s?this.parentNode.insertBefore(n,this.nextSibling):this.parentNode.insertBefore(n,this),await a(t)}}))}function tinyNotification(e){let t=$(".tinyNotifications");t.length||($("body").append('<ul class="tinyNotifications"></ul>'),t=$(".tinyNotifications"));const a=$(`<li>${e}</li>`);t.prepend(a),setTimeout((function(){a.remove()}),1500)}function IconVisibility(e,t,a,s){let i=Math.ceil(t.scrollLeft),n=t.scrollWidth-t.clientWidth;a.style.display=i>0?"block":"none",s.style.display=n>i?"block":"none",function columnLayout(e){const t=e.width(),a=Number(getComputedStyle(document.body).getPropertyValue("--minColumnWidth").replace("px","")),s=Number(getComputedStyle(document.body).getPropertyValue("--minColumnWidth60").replace("px",""));t>=2*a+6?e.removeClass("singleColumnLayout"):e.addClass("singleColumnLayout");t<=s?e.addClass("minimumColumnLayout"):e.removeClass("minimumColumnLayout")}(e)}async function clickableAbility(e){const t=$(e.currentTarget).closest(".searchableAbility")[0].dataset.category.split(" ");let a=e.currentTarget.text.replace(/\d+$/,"").trim();for(let e of t){const t=(await game.dsa5.itemLibrary.findCompendiumItem(a,e)).find((e=>e.name==a));if(t)return void t.sheet.render(!0)}if(/\(/.test(a)){a=a.split("(")[0].trim()+" ()";for(let e of t){const t=(await game.dsa5.itemLibrary.findCompendiumItem(a,e)).find((e=>e.name==a));if(t)return void t.sheet.render(!0)}}}function tabSlider(e){const t=e.find(".navWrapper");for(let a of t){const t=a.querySelector(".left-btn"),s=a.querySelector(".right-btn"),i=a.querySelector(".sheet-tabs");let n=!1;s.addEventListener("click",(()=>{i.scrollLeft+=150,setTimeout((()=>IconVisibility(e,i,t,s)),500)})),t.addEventListener("click",(()=>{i.scrollLeft-=150,setTimeout((()=>IconVisibility(e,i,t,s)),500)})),new ResizeObserver((()=>IconVisibility(e,i,t,s))).observe(a),i.addEventListener("mousemove",(a=>{n&&(i.scrollLeft-=a.movementX,setTimeout((()=>IconVisibility(e,i,t,s)),500))})),i.addEventListener("mousedown",(()=>{n=!0,i.classList.add("dragging"),document.addEventListener("mouseup",(()=>{n=!1,i.classList.remove("dragging")}),{once:!0})}))}}a.d(t,{$8:()=>clickableAbility,Ee:()=>tabSlider,Jp:()=>slist,gw:()=>delay,p0:()=>tinyNotification,x8:()=>itemFromDrop,zJ:()=>svgAutoFit});const appHeight=()=>{document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)};window.addEventListener("resize",appHeight),appHeight()},430:(e,t,a)=>{a.d(t,{Z:()=>DSATables});var s=a(577),i=a(604),n=a(491);class DSATables{static async showBotchCard(e,t={}){t.speaker={token:e.token,actor:e.actor,scene:e.scene},t.source=e.source;const a=s.Z.systemTables.find((t=>t.name==e.table)),i=await DSATables.getRollTable(a.pack[game.i18n.lang],game.i18n.localize(`TABLENAMES.${e.table}`),e);for(let a of i){const s=!!t.speaker&&await DSATables.hasEffect(a),i=n.Z.replaceDies(n.Z.replaceConditions(a.results[0].text)),r=`${game.i18n.localize("TABLENAMES."+e.table)}`,o=await renderTemplate("systems/dsa5/templates/tables/tableCard.html",{result:i,title:r,hasEffect:s}),l=await this.buildEffects(a,s);ChatMessage.create({user:game.user.id,content:o,whisper:t.whisper,blind:t.blind,flags:{data:{preData:{source:{effects:l},extra:{actor:{id:t.speaker.actor},speaker:t.speaker},situationalModifiers:[]},postData:{}},dsa5:{hasEffect:s,options:t}}})}}static async hasEffect(e){return getProperty(e.results[0],"flags.dsa5")||!1}static async buildEffects(e,t){let a=[];if(t&&t.resistEffect){const e=Array.isArray(t.resistEffect.fail)?t.resistEffect.fail:[t.resistEffect.fail];for(let s of e){const e=(new i.Z).effectDummy(s.description,t.resistEffect.changes||[],t.resistEffect.duration||{});s.systemEffect?mergeObject(e,{_id:"botchEffect",flags:{dsa5:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:`await actor.addCondition("${s.systemEffect}", ${s.level||1});`}}}):s.command&&mergeObject(e,{_id:"botchEffect",flags:{dsa5:{hideOnToken:!1,hidePlayers:!1,advancedFunction:2,args3:s.command}}}),a.push(e)}}return a}static async getRollTable(e,t,a={}){const s=game.packs.get(e),i=(await s.getDocuments({name__in:[t]}))[0];let n=await i.draw({displayChat:!1});return"true"==a.weaponless&&n.roll.total<7&&(n.roll.editRollAtIndex([{index:0,val:n.roll.total+5}]),n=await i.draw({displayChat:!1,roll:n.roll})),[n]}static async tableEnabledFor(e){const t=s.Z.systemTables.find((t=>t.name==e));return!!t&&game.settings.get(t.setting.module,t.setting.key)}static rollCritBotchButton(e,t,a){const s=game.i18n.localize(`TABLENAMES.${e}`),i=a.extra.speaker;return`, <a class="roll-button botch-roll" data-table="${e}" data-weaponless="${t}" data-source="${a.source._id}" data-token="${i.token}" data-actor="${i.actor}" data-scene="${i.scene}"><i class="fas fa-dice"></i>${s}</a>`}static async defaultBotch(){return", "+game.i18n.localize("selfDamage")+(await new Roll("1d6+2").evaluate({async:!0})).total}static defaultAttackCrit(e){let t=", "+game.i18n.localize("halfDefense");return e&&(t+=", "+game.i18n.localize("doubleDamage")),t}static defaultParryCrit(){return", "+game.i18n.localize("attackOfOpportunity")}}},585:(e,t,a)=>{a.d(t,{Z:()=>TableEffects});var s=a(369),i=a(61),n=a(472),r=a(702),o=a(491),l=a(604);class TableEffects{static async applyEffect(e,t){const a=game.messages.get(e),s=getProperty(a,"flags.dsa5.hasEffect"),i=getProperty(a,"flags.dsa5.options")||{};if(s){const n=["damageModifier","gearDamaged","gearLost","resistEffect","malus","selfDamage","nextAction"];let r,l=[];if("self"==t){const e=o.Z.getSpeaker(i.speaker);l.push(e),r=i.source?e.items.get(i.source):void 0}else l=Array.from(game.user.targets).map((e=>e.actor));for(let i of n){const n=getProperty(s,i);if(n){await TableEffects[i](n,t,l,r,e,a)||console.warn(`Table effect for <${i} not working yet`,n,t,l,r)}}const c=game.i18n.format("ActiveEffects.appliedEffect",{source:game.i18n.localize("table"),target:l.map((e=>e.name)).join(", ")});await a.update({content:a.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${c}"></i>`)})}}static async damageModifier(e,t,a,s){}static async nextAction(e,t,a,s){}static async opportunityAttack(e,t,a,s){}static async gearDamaged(e,t,a,s){if(s&&["meleeweapon","rangeweapon"].includes(s.type)){const t=getProperty(s,"system.effect.attributes")||"";return new RegExp(`(${n.Z.magical}|${n.Z.clerical})`,"i").test(t)?await s.update({"system.worn.value":!1}):await r.Z.absoluteDamageLevelToItem(s,e),!0}}static async gearLost(e,t,a,s){if(s&&["meleeweapon","rangeweapon"].includes(s.type)){if(await s.update({"system.worn.value":!1}),e.distance){const t=await new Roll(e.distance).evaluate({async:!0}),a=await t.render(),s=game.i18n.format("WEAPON.dropped",{distance:t.total});ChatMessage.create(o.Z.chatDataSetup(`<p>${s}</p>${a}`))}return!0}}static async resistEffect(e,t,a,s,n){for(let s of a){const a=[{skill:e.roll,mod:e.modifier||0,effect:{_id:"botchEffect",name:e.fail.description},target:s,token:s.token?s.token.id:void 0}];i.Z.createResistRollMessage(a,n,t)}return!0}static evaluateTargetArg(e,t){let a=t,s=!0;if("victim"==e.target){const e=Array.from(game.user.targets).map((e=>e.actor));e.length?a=e:(s=!1,ui.notifications.warn("DSAError.noVictim"))}return{hasTargets:s,finalTargets:a}}static async malus(e,t,a,s){const{hasTargets:i,finalTargets:n}=this.evaluateTargetArg(e,a);for(let t of e){const e=!i&&t.noTarget,a=e?t.noTarget.systemEffect:t.systemEffect,s=e?t.noTarget.level:t.level||1;let r=e?t.noTarget.changes:t.changes;const o=e?t.noTarget.duration:t.duration;if(a){const e=CONFIG.statusEffects.find((e=>e.id==a));if(!r){r=duplicate(e.changes);const t=r.find((e=>e.key==`system.condition.${a}`));t&&(t.value=s)}let t;if(r){const s=game.i18n.localize(`CONDITION.${a}`)+" - "+game.i18n.localize("botchCritEffect");t=(new l.Z).effectDummy(s,r,o||{}),t.icon=e.icon}else t=a;for(let e of n)await e.addCondition(t);return!0}if(r){const e=(new l.Z).effectDummy(game.i18n.localize("botchCritEffect"),r||[],o||{});mergeObject(e,{flags:{dsa5:{hideOnToken:!1,hidePlayers:!1}}});for(let t of n)await t.addCondition(e);return!0}}}static async selfAttack(e,t,a,s){const{hasTargets:i,finalTargets:n}=this.evaluateTargetArg(e,a)}static async selfDamage(e,t,a,i){const{hasTargets:n,finalTargets:r}=this.evaluateTargetArg(e,a);if(i){const t=o.Z.toObjectIfPossible(i);for(let a of r){const n=a.items.filter((e=>"combatskill"==e.type)).map((e=>s.Z._calculateCombatSkillValues(e.toObject(),a.system)));let r;r=e.damage?{damagedie:e.damage,damageAdd:""}:"rangeweapon"==i.type?s.Z._prepareRangeWeapon(t,[],n,a):"meleeweapon"==i.type?s.Z._prepareMeleeWeapon(t,n,a):"meleeAttack"==i.system.traitType.value?s.Z._prepareRangeTrait(t):s.Z._prepareMeleetrait(t);const l=(r.damagedie+r.damageAdd).replace(/wWD/g,"d"),c=await new Roll(`(${l})*${e.multiplier||1}${e.modifier||""}`).evaluate({async:!0});await a.applyDamage(Math.round(c.total)),ChatMessage.create(o.Z.chatDataSetup(await c.render()))}return!0}for(let e of r){const t=await new Roll("1d6").evaluate({async:!0});await e.applyDamage(Math.round(t.total)),ChatMessage.create(o.Z.chatDataSetup(await t.render()))}return!0}}},93:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>DSATour});var _system_view_helper_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(707);class DSATour extends Tour{static tours=["systems/dsa5/modules/tours/lang/initial","systems/dsa5/modules/tours/lang/library","systems/dsa5/modules/tours/lang/actor"];static gmTours=["systems/dsa5/modules/tours/lang/mastermenu"];static async travelAgency(){const e="de"==game.i18n.lang?"de":"en";console.log("Adding DSA/TDE Tours");for(let t of this.tours){const a=await game.dsa5.apps.DSATour.fromJSON(`${t.replace("/lang/",`/${e}/`)}.json`);game.tours.register(a.config.module,a.id,a)}if(game.user.isGM)for(let t of this.gmTours){const a=await game.dsa5.apps.DSATour.fromJSON(`${t.replace("/lang/",`/${e}/`)}.json`);game.tours.register(a.config.module,a.id,a)}}async _preStep(){this.currentStep.activateTab?ui.sidebar.activateTab(this.currentStep.activateTab):this.currentStep.activateLayer&&canvas.activeLayer.options.name!=this.currentStep.activateLayer?(await canvas[this.currentStep.activateLayer].activate(),await(0,_system_view_helper_js__WEBPACK_IMPORTED_MODULE_0__.gw)(100)):this.currentStep.appTab&&this.app.activateTab(this.currentStep.appTab)}exit(){super.exit()}async start(){if(this.config.preCommand){const fn=await eval(`(async() => { ${this.config.preCommand} })`);await fn()}if(this.app)for(await this.app.render(!0,{focus:!0});!this.app.rendered;)await(0,_system_view_helper_js__WEBPACK_IMPORTED_MODULE_0__.gw)(50);if(this.app||this.config.preCommand)for(;!$(this.steps[this.stepIndex+1].selector+":visible").length;)await(0,_system_view_helper_js__WEBPACK_IMPORTED_MODULE_0__.gw)(50);const res=await super.start();return $("#tooltip").show(),res}}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var a=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](a,a.exports,__webpack_require__),a.exports}__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{var e=__webpack_require__(491),t=__webpack_require__(577),a=__webpack_require__(272),s=__webpack_require__(839),i=__webpack_require__(173),n=__webpack_require__(947),r=__webpack_require__(973);class Migrakel{static async showDialog(e,t=!1){let[a]=await new Promise(((a,s)=>{const i={Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("update"),callback:()=>{a([!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{a([!1])}}};t&&(i.migrateAll={icon:'<i class="fas fa-exclamation-triangle "></i>',label:game.i18n.localize("replace"),callback:()=>{a([2])}}),new Dialog({title:game.i18n.localize("Migrakel.Migration"),content:e,default:"yes",buttons:i,close:()=>{a([!1])}}).render(!0)}));return a}static async refreshStatusEffects(e){let t=[];for(let a of e.effects)if(a.origin){let e;try{e=await fromUuid(a.origin)}catch(e){}e||t.push(a.id)}await e.deleteEmbeddedDocuments("ActiveEffect",t)}static async updateVals(e,t,a){const s=game.dsa5.itemLibrary;let i=[],n=[],r=new Map;if(await this.refreshStatusEffects(e),t({type:"equipment"})){const t=[],i=[];for(let n of e.items.filter((e=>"equipment"==e.type&&"bags"==e.system.equipmentType.value))){let e=await s.findCompendiumItem(n.name,n.type);if(e.length>0){if(e=e.find((e=>e.name==n.name&&e.type==n.type)),!e)continue;console.log(`MIGRATION - Updated ${n.name}`);const s=mergeObject(n.toObject(),a(e));i.push(s),t.push(n.id)}}const n=await e.createEmbeddedDocuments("Item",i);for(let e=0;e<n.length;e++)r.set(t[e],n[e].id);await e.deleteEmbeddedDocuments("Item",t)}for(let o of e.items.filter((e=>t(e)&&!("equipment"==e.type&&"bags"==e.system.equipmentType.value)))){let e=await s.findCompendiumItem(o.name,o.type);if(e.length>0){if(e=e.find((e=>e.name==o.name&&e.type==o.type)),!e)continue;console.log(`MIGRATION - Updated ${o.name}`);const t=mergeObject(o.toObject(),a(e));t.system.parent_id&&r.has(t.system.parent_id)&&(t.system.parent_id=r.get(t.system.parent_id)),n.push(t),i.push(o.id)}}await e.createEmbeddedDocuments("Item",n),await e.deleteEmbeddedDocuments("Item",i),ui.notifications.notify(game.i18n.localize("Migrakel.migrationDone"))}static async updateSpellsAndLiturgies(e){const t=await this.showDialog(game.i18n.localize("Migrakel.spells"),!0),condition=e=>["spell","liturgy","ritual","ceremony","spellextension"].includes(e.type);if(2==t){const updator=e=>{const t=e.toObject();return delete t.system.talentValue,t};await this.updateVals(e,condition,updator)}else if(t){const updator=e=>{const t={effects:e.effects.toObject()};return"spellextension"!=e.type&&(t.system={effectFormula:{value:e.system.effectFormula.value}}),t};await this.updateVals(e,condition,updator)}}static async updateSpecialAbilities(e){if(await this.showDialog(game.i18n.localize("Migrakel.abilities"))){const updator=e=>{let t={system:{effect:{value:e.system.effect.value}},effects:e.effects.toObject()};return"specialability"==e.type&&(mergeObject(t,{system:{category:{sub:e.system.category.sub||0},list:{value:e.system.list.value},effect:{value2:getProperty(e,"system.effect.value2")||"",value3:getProperty(e,"system.effect.value3")||""}}}),"staff"==e.system.category.value&&mergeObject(t,{system:{feature:getProperty(e,"system.feature")||"",AsPCost:getProperty(e,"system.AsPCost")||"",volume:Number(getProperty(e,"system.volume"))||0,artifact:getProperty(e,"system.artifact")||""}})),this.updateMacro(t,e),t},condition=e=>["specialability","advantage","disadvantage","trait"].includes(e.type);await this.updateVals(e,condition,updator)}}static async updateCombatskills(e){if(await this.showDialog(game.i18n.localize("Migrakel.cskills"))){const updator=e=>({effects:e.effects.toObject()}),condition=e=>["combatskill"].includes(e.type);await this.updateVals(e,condition,updator)}}static async updateSkills(e){if(await this.showDialog(game.i18n.localize("Migrakel.skills"))){const condition=e=>["skill"].includes(e.type),updator=e=>({img:e.img});await this.updateVals(e,condition,updator)}}static updateMacro(e,t){const a=t.getFlag("dsa5","onUseEffect");a&&mergeObject(e,{flags:{dsa5:{onUseEffect:a}}})}static async updateGear(e){if(await this.showDialog(game.i18n.localize("Migrakel.gear"))){let condition=e=>["meleeweapon","armor","rangeweapon","equipment","poison","consumable","ammunition"].includes(e.type),updator=e=>{let t={img:e.img,effects:e.effects.toObject()};return["poison","consumable"].includes(e.type)||mergeObject(t,{system:{effect:{value:e.system.effect.value}}}),["armor"].includes(e.type)&&mergeObject(t,{system:{subcategory:e.system.subcategory}}),["meleeweapon","rangeweapon","armor"].includes(e.type)&&mergeObject(t,{system:{structure:{max:e.system.structure.max,value:e.system.structure.value}}}),this.updateMacro(t,e),t};await this.updateVals(e,condition,updator)}}}class DialogActorConfig extends Dialog{constructor(e,t){super(t),this.actor=e,this.lock=!1}static async buildDialog(e){const t=await renderTemplate("systems/dsa5/templates/actors/parts/actorConfig.html",{actor:e});new DialogActorConfig(e,{title:game.i18n.localize("SHEET.actorConfig"),content:t,default:"Save",buttons:{Save:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Save"),callback:t=>{e.update({"system.config.autoBar":t.find('[name="autoBar"]').is(":checked"),"system.config.autoSize":t.find('[name="autoSize"]').is(":checked")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async updateWrapper(e,t){if(this.lock)return;(async()=>{this.lock=!0,$(t.currentTarget).prepend('<i class="fas fa-spinner fa-spin"></i>'),await Migrakel[e](this.actor),$(t.currentTarget).find("i").remove(),this.lock=!1})()}activateListeners(e){super.activateListeners(e),e.find(".updateSpells").click((async e=>this.updateWrapper("updateSpellsAndLiturgies",e))),e.find(".updateAbilities").click((async e=>this.updateWrapper("updateSpecialAbilities",e))),e.find(".updatecSkills").click((async e=>this.updateWrapper("updateCombatskills",e))),e.find(".updateSkills").click((async e=>this.updateWrapper("updateSkills",e))),e.find(".updateGear").click((async e=>this.updateWrapper("updateGear",e)))}}var o=__webpack_require__(369),l=__webpack_require__(707),c=__webpack_require__(803),d=__webpack_require__(122),m=__webpack_require__(604);function bindImgToCanvasDragStart(e,t="img"){game.user.isGM&&e.find(t).each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(e=>dragTileImg(e)))}))}const dragTileImg=e=>{canvas.tiles.activate();const t=e.currentTarget.src,a=e.currentTarget,s=canvas.dimensions.sceneHeight/a.naturalHeight,i=canvas.dimensions.sceneWidth/a.naturalWidth,n=Math.min(1,i,s);let r={type:"Tile",texture:{src:t},tileSize:Math.round(canvas.dimensions.size/n)};e.dataTransfer.setData("text/plain",JSON.stringify(r));const o=a.naturalWidth*n*canvas.stage.scale.x,l=a.naturalHeight*n*canvas.stage.scale.y,c=DragDrop.createDragImage(a,o,l);e.dataTransfer.setDragImage(c,o/2,l/2)};var u=__webpack_require__(231),g=__webpack_require__(169);class ForeignFieldEditor extends FormApplication{constructor(e,t,a){super(),this.editfield=t,this.actorId=e,this.fieldname=a;const s=game.actors.get(this.actorId);this.object={fieldContent:getProperty(s,this.editfield)}}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{resizable:!0,width:600,height:600}),e}isEditable(){return!0}get title(){return`${game.actors.get(this.actorId).name} - ${game.i18n.localize(this.fieldname)}`}async _updateObject(e,t){game.socket.emit("system.dsa5",{type:"updateKeepField",payload:{actorId:this.actorId,field:this.editfield,updateData:t.fieldContent}})}async getData(e){const t=super.getData(e);return mergeObject(t,{fieldContent:this.object.fieldContent}),t}get template(){return"systems/dsa5/templates/dialog/foreignfieldeditor.html"}activateListeners(e){super.activateListeners(e)}}class DSA5Payment{static async payMoney(t,a,s=!1,i=!0){let n=DSA5Payment.canPay(t,a,s);return n.success&&await DSA5Payment._updateMoney(t,n.actorsMoney.money,n.actorsMoney.sum-n.money,i),s||""==n.msg||ChatMessage.create(e.Z.chatDataSetup(`<p>${n.msg}</p>`,"roll")),n.success}static canPay(e,t,a){let s=this._getPaymoney(t),i={success:!1,msg:"",money:s};return s&&(i.actorsMoney=this._actorsMoney(e),i.actorsMoney.sum>=s?(i.msg=game.i18n.format("PAYMENT.pay",{actor:e.name,amount:DSA5Payment._moneyToString(s)}),i.success=!0):(i.msg=game.i18n.format("PAYMENT.cannotpay",{actor:e.name,amount:DSA5Payment._moneyToString(s)}),a&&ui.notifications.notify(i.msg))),i}static async getMoney(t,a,s=!1,i=!0){let n=this._getPaidmoney(a);if(n){let a=this._actorsMoney(t);await DSA5Payment._updateMoney(t,a.money,a.sum+n,i);let r=`<p>${game.i18n.format("PAYMENT.getPaid",{actor:t.name,amount:DSA5Payment._moneyToString(n)})}</p>`;return s||ChatMessage.create(e.Z.chatDataSetup(r,"roll")),!0}}static async _updateMoney(e,t,a,s=!0){let i=DSA5Payment._moneyToCoins(a);for(let e of t)switch(e.name){case"Money-D":e.system.quantity.value=i.D;break;case"Money-S":e.system.quantity.value=i.S;break;case"Money-H":e.system.quantity.value=i.H;break;case"Money-K":e.system.quantity.value=i.K}await e.updateEmbeddedDocuments("Item",t,{render:s})}static createGetPaidChatMessage(t,a){let s=this._getPaidmoney(t);if(s){const t=a?` (${a})`:"";let i=`<p><b>${game.i18n.localize("PAYMENT.wage")}</b></p><p>${game.i18n.format("PAYMENT.getPaidSum",{amount:DSA5Payment._moneyToString(s)})}${t}</p><button class="payButton" data-pay="1" data-amount="${s}">${game.i18n.localize("PAYMENT.getPaidButton")}</button>`;ChatMessage.create(e.Z.chatDataSetup(i,"roll"))}}static createPayChatMessage(t,a){let s=this._getPaymoney(t);if(s){const t=a?` (${a})`:"";let i=`<p><b>${game.i18n.localize("PAYMENT.bill")}</b></p>${game.i18n.format("PAYMENT.paySum",{amount:DSA5Payment._moneyToString(s)})}${t}</p><button class="payButton" data-pay="0" data-amount="${s}">${game.i18n.localize("PAYMENT.payButton")}</button>`;ChatMessage.create(e.Z.chatDataSetup(i,"roll"))}}static _getPaidmoney(t){let a=this._parseMoneyString(t);if(!a){let t=`<p><b>${game.i18n.localize("PAYMENT.error")}</b></p><p><i>${game.i18n.localize("PAYMENT.getPaidexample")}</i></p>`;return ChatMessage.create(e.Z.chatDataSetup(t,"roll")),!1}return a}static _getPaymoney(t){let a=this._parseMoneyString(t);if(!a){let t=`<p><b>${game.i18n.localize("PAYMENT.error")}</b></p><p><i>${game.i18n.localize("PAYMENT.payexample")}</i></p>`;return ChatMessage.create(e.Z.chatDataSetup(t,"roll")),!1}return a}static _parseMoneyString(e){let t=e.replace(",",".").match(/\d{1,}(\.\d{1,3}|,\d{1,3})?/);return!!t&&Number(t[0])}static _actorsMoney(e){let t=duplicate(e.items.filter((e=>"money"==e.type)));return{money:t,sum:t.reduce(((e,t)=>e+Number(t.system.quantity.value)*Number(t.system.price.value)),0)}}static async handlePayAction(e,t,a,s){if(game.user.isGM&&!s)return void ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors"));s?c.Z.playMoneySound(!0):s=game.user.character;let i=!1;s&&t?i=await DSA5Payment.payMoney(s,a):s&&!t?i=await DSA5Payment.getMoney(s,a):ui.notifications.notify(game.i18n.localize("PAYMENT.onlyActors")),i&&e&&(e.fadeOut(),game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:e.closest(".message").attr("data-message-id"),updateData:{[`flags.dsa5.userHidden.${game.user.id}`]:!0}}}))}static _moneyToCoins(e){let t=Math.round(100*e),a=Math.floor(t/1e3),s=Math.floor((t-1e3*a)/100),i=Math.floor((t-1e3*a-100*s)/10);return{D:a,S:s,H:i,K:Math.round(t-1e3*a-100*s-10*i)}}static _moneyToString(e){let t=DSA5Payment._moneyToCoins(e),a=[];for(const[e,s]of Object.entries(t))s>0&&a.push(`<span class="nobr">${s} <span data-tooltip="Money-${e}" class="chatmoney money-${e}"></span></span>`);return a.join(", ")}static async chatListeners(e){e.on("click",".payButton",(e=>{const t=$(e.currentTarget);DSA5Payment.handlePayAction(t,1!=Number(t.attr("data-pay")),t.attr("data-amount")),c.Z.playMoneySound()}))}}class TokenHotbar2 extends Application{static registerTokenHotbar(){game.dsa5.apps.tokenHotbar||(game.dsa5.apps.tokenHotbar=new TokenHotbar2,game.dsa5.apps.tokenHotbar.render(!0),Hooks.call("dsa5TokenHotbarReady",game.dsa5.apps.tokenHotbar))}static unregisterTokenHotbar(){game.dsa5.apps.tokenHotbar&&(game.dsa5.apps.tokenHotbar.close(),game.dsa5.apps.tokenHotbar=void 0)}constructor(e){if(super(e),this.searching="",this.combatSkills=["selfControl","featOfStrength","bodyControl","perception","loyalty"].map((e=>game.i18n.localize(`LocalizedIDs.${e}`))),this.defaultSkills=[game.i18n.localize("LocalizedIDs.perception")],game.user.isGM){this.callbackFunctions={};const e=game.settings.get("dsa5","enableMasterTokenFunctions");this.gmItems=[{name:"gmMenu",disabled:e.masterMenu,icon:"systems/dsa5/icons/categories/DSA-Auge.webp",id:"masterMenu",cssClass:"gm",abbrev:"",subfunction:"gm"},{name:"MASTER.randomPlayer",disabled:e.randomVictim,iconClass:"fa fa-dice-six",id:"randomVictim",cssClass:"gm",abbrev:"",subfunction:"gm"},{name:"TT.tokenhotbarMoney",disabled:e.payMoney,icon:"systems/dsa5/icons/money-D.webp",id:"payMoney",cssClass:"gm",abbrev:"",subfunction:"gm"}]}const parentUpdate=e=>{const t=e.parent?e.parent.id:void 0;t&&TokenHotbar2.hookUpdate(t)};Hooks.on("controlToken",((e,t)=>{game.dsa5.apps.tokenHotbar?.updateDSA5Hotbar()})),Hooks.on("updateActor",((e,t)=>{TokenHotbar2.hookUpdate(e.id)})),Hooks.on("updateToken",((e,t,a)=>{game.dsa5.apps.tokenHotbar&&t._id==getProperty(game.dsa5.apps.tokenHotbar,"actor.prototypeToken.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()})),Hooks.on("updateOwnedItem",((e,t)=>{TokenHotbar2.hookUpdate(e.data.id)})),Hooks.on("createOwnedItem",((e,t)=>{TokenHotbar2.hookUpdate(e.data.id)})),Hooks.on("deleteOwnedItem",((e,t)=>{TokenHotbar2.hookUpdate(e.data.id)})),Hooks.on("updateItem",((e,t)=>{parentUpdate(e)})),Hooks.on("createItem",((e,t)=>{parentUpdate(e)})),Hooks.on("deleteItem",((e,t)=>{parentUpdate(e)}))}registerMasterFunction(e,t){const a=game.settings.get("dsa5","enableMasterTokenFunctions");e.disabled=a[e.id],this.gmItems.push(e),this.callbackFunctions[e.id]=t}async prepareSkills(){const t=await e.Z.allSkills();return this.skills=t.map((e=>({name:e.name,icon:e.img,id:e.name,cssClass:"skillgm",addClass:e.system.group.value,abbrev:e.name[0],subfunction:"skillgm"}))),this.skills=this.skills.sort(((e,t)=>e.addClass.localeCompare(t.addClass)||e.name.localeCompare(t.name))),this.skills}static hookUpdate(e){game.dsa5.apps.tokenHotbar&&e==getProperty(game.dsa5.apps.tokenHotbar,"actor.id")&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}resetPosition(){const e=$("#hotbar").first().position(),t=game.settings.get("dsa5","tokenhotbarSize");this.position.left=e.left+8,this.position.top=e.top-t-25}static get defaultOptions(){const e=super.defaultOptions,t=$("#hotbar").first().position(),a=game.settings.get("dsa5","tokenhotbarSize"),s=game.settings.get("dsa5","tokenhotbarPosition");return mergeObject(e,{classes:e.classes.concat(["dsa5","tokenQuickHot"]),itemWidth:a,resizable:!1,height:a+45,zIndex:61,left:t.left+8,top:t.top-a-25,template:"systems/dsa5/templates/status/tokenHotbar.html",title:"TokenHotbar"}),mergeObject(e,s),e}async _onWheelResize(e){let t=game.settings.get("dsa5","tokenhotbarSize");t=e.originalEvent.deltaY>0?Math.min(100,t+5):Math.max(15,t-5),await game.settings.set("dsa5","tokenhotbarSize",t),await this.render(!0)}async _cycleLayout(e){if(2==e.button){let e=game.settings.get("dsa5","tokenhotbarLayout")+1;4==e&&(e=0),await game.settings.set("dsa5","tokenhotbarLayout",e),await this.render(!0)}}changeDarkness(e){const t=Number(e.currentTarget.value);canvas.scene&&canvas.scene.update({darkness:t},{animateDarkness:3e3}),(0,l.p0)(t)}activateListeners(e){super.activateListeners(e);const t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",(async e=>(e.stopPropagation(),e.preventDefault(),await this._onWheelResize(e),!1))),t.on("mousedown",(async e=>{await this._cycleLayout(e)})),e.find(".itdarkness input").change((e=>this.changeDarkness(e)));const a=this,fn=function(e){return a.filterButtons(e),!1};e.find(".filterable").hover((function(){$(document).keydown(fn)}),(function(){$(document).unbind("keydown",fn)})),e.find(".quantity-click").mousedown((e=>d.Z.quantityClick(e))),e.on("mousedown","li",(async e=>(e.stopPropagation(),await this.executeQuickButton(e),!1))),e.on("mouseenter","li.primary",(t=>{const a=t.currentTarget.dataset.category;this.category=a,setTimeout((()=>{e.find(".secondary").removeClass("shown"),a==this.category&&e.find(`.secondary[data-category="${a}"]`).addClass("shown")}),700)})),e.on("mouseleave","li.primary",(t=>{const s=t.currentTarget.dataset.category;this.category=void 0,setTimeout((()=>{s!=this.category&&(a.searching="",$(t.currentTarget).find(".secondary").removeClass("dsahidden"),e.find(`.secondary[data-category="${s}"]`).removeClass("shown"))}),50)}))}async handleEffect(e,t,a,s){const i=t.effects.get(a),n=[...i.statuses][0];0==e.button?n?await t.addCondition(n,1,!1,!1):i.sheet.render(!0):2==e.button&&(n?await t.removeCondition(n,1,!1):await t.sheet._deleteActiveEffect(a)),await this.render(!0)}async handleGMRoll(e){const t=e.currentTarget.dataset.id,a=Math.round($(e.currentTarget).closest(".tokenHotbarInner").find(".modifierVal").val());e.ctrlKey?game.dsa5.apps.DSA5ChatListeners.check3D20(void 0,t,{modifier:a}):2==e.button?game.dsa5.macro.requestGC(t,a,{maxRolls:7}):game.dsa5.macro.requestRoll(t,a)}async handleSkillRoll(e,t,a,s){const i={};if(2==e.button&&(i.rollMode="blindroll"),"rideLoyaltyID"==a)g.Z.rollLoyalty(t,i);else if("attackWeaponless"==a)t.setupWeaponless("attack",i,s).then((e=>{t.basicTest(e)}));else{let n=t.items.get(a);if(n){if(e.originalEvent.ctrlKey)return n.sheet.render(!0);switch(n.type){case"meleeweapon":case"rangeweapon":case"trait":t.setupWeapon(n,"attack",i,s).then((e=>{t.basicTest(e)}));break;case"liturgy":case"spell":t.setupSpell(n,i,s).then((e=>{t.basicTest(e)}));break;case"skill":t.setupSkill(n,i,s).then((e=>{t.basicTest(e)}));break;case"consumable":new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+n.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+n.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async()=>{await n.setupEffect(null,{},s),await this.updateDSA5Hotbar()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}}}}async handleOnUse(e,t,a,s){let i=t.items.get(a);new m.Z(i).executeOnUseEffect()}async handleGM(t,a,s,i){switch(s){case"masterMenu":e.Z.renderToggle(game.dsa5.apps.gameMasterMenu);break;case"payMoney":this.payMoney(t);break;case"randomVictim":this.handleGMRandomVictim(t);break;default:s in this.callbackFunctions&&this.callbackFunctions[s](t,a,s,i)}}payMoney(e){const t=`${$(e.currentTarget).closest(".tokenHotbarInner").find(".modifierVal").val()}`;2==e.button?DSA5Payment.createGetPaidChatMessage(t):DSA5Payment.createPayChatMessage(t)}async handleGMRandomVictim(t){const a=await game.dsa5.apps.gameMasterMenu.rollRandomPlayer(2==t.button),s=game.actors.get(a);if(s){const a=await e.Z.showArtwork(s);t.originalEvent.ctrlKey||setTimeout((()=>{a.close()}),2e3)}}async executeQuickButton(e){const t=canvas.tokens.controlled[0]?.actor,a=canvas.tokens.controlled[0]?.id,s=e.currentTarget.dataset.id;switch(e.currentTarget.dataset.subfunction){case"addEffect":AddEffectDialog.showDialog();break;case"effect":this.handleEffect(e,t,s,a);break;case"onUse":this.handleOnUse(e,t,s,a);break;case"gm":this.handleGM(e,t,s,a);break;case"none":case"darkness":break;case"skillgm":this.handleGMRoll(e);break;default:this.handleSkillRoll(e,t,s,a)}}subWidth(e,t,a=7){return`style="width:${200*Math.ceil(e.length/a)}px"`}async getData(){const e=await super.getData(),t=this.actor,a={attacks:[],spells:[],default:[],skills:[],gm:[]};let s,i;const n=[],r=[];let l=[];const c=game.settings.get("dsa5","tokenhotbarLayout"),d=c%2,m=TokenHotbar2.defaultOptions.itemWidth,u=["liturgy","spell"];let p=!1;if(t){const e=[];let c=[];const d=g.Z.isRiding(t),p=game.i18n.localize("LocalizedIDs.riding");if(l=(await t.actorEffects()).map((e=>({name:e.name,id:e.id,icon:e.icon,cssClass:"effect",abbrev:`${e.name[0]} ${e.getFlag("dsa5","value")||""}`,subfunction:"effect"}))),game.combat){const i=t.items.filter((e=>"combatskill"==e.type)).map((e=>o.Z._calculateCombatSkillValues(e.toObject(),t.system))),l=i.find((e=>e.name==game.i18n.localize("LocalizedIDs.wrestle")));l&&a.attacks.push({name:game.i18n.localize("attackWeaponless"),id:"attackWeaponless",icon:"systems/dsa5/icons/categories/attack_weaponless.webp",attack:l.system.attack.value,damage:"1d6"});const m=["meleeweapon","rangeweapon"],h=["meleeAttack","rangeAttack"];for(const s of t.items){if(["skill"].includes(s.type)&&(this.combatSkills.some((e=>s.name.startsWith(e)))||d&&p==s.name)&&a.default.push({name:`${s.name} (${s.system.talentValue.value})`,id:s.id,icon:s.img,cssClass:"skill filterable",abbrev:s.name[0]}),"trait"==s.type&&h.includes(s.system.traitType.value)){const e=o.Z._parseDmg(s.toObject());a.attacks.push({name:s.name,id:s.id,icon:s.img,cssClass:`weapon ${s.id}`,abbrev:s.name[0],attack:s.system.at.value,damage:e.damagedie,dadd:e.damageAdd})}else if(m.includes(s.type)&&1==s.system.worn.value){const e="meleeweapon"==s.type?o.Z._prepareMeleeWeapon(s.toObject(),i,t):o.Z._prepareRangeWeapon(s.toObject(),[],i,t);a.attacks.push({name:s.name,id:s.id,icon:s.img,cssClass:`weapon ${s.id}`,abbrev:s.name[0],attack:e.attack,damage:e.damagedie,dadd:e.damageAdd})}else if(u.includes(s.type))s.system.effectFormula.value?a.spells.push({name:s.name,id:s.id,icon:s.img,cssClass:"spell",abbrev:s.name[0]}):c.push({name:s.name,id:s.id,icon:s.img,cssClass:"spell",abbrev:s.name[0]});else if(["skill"].includes(s.type)){const t={name:`${s.name} (${s.system.talentValue.value})`,id:s.id,icon:s.img,cssClass:"skill",addClass:s.system.group.value,abbrev:s.name[0],tw:s.system.talentValue.value};e.push(t)}else"consumable"==s.type&&n.push({name:s.name,id:s.id,icon:s.img,cssClass:"consumable",abbrev:s.system.quantity.value});s.getFlag("dsa5","onUseEffect")&&r.push({name:s.name,id:s.id,icon:s.img,cssClass:"onUse",abbrev:s.name[0],subfunction:"onUse"})}if(s=n.pop(),d){const e=g.Z.getHorse(t);if(e){const t=g.Z.getLoyaltyFromHorse(e);t&&a.default.push({name:`${t.name} (${t.system.talentValue.value})`,id:"rideLoyaltyID",icon:t.img,cssClass:"skill",abbrev:t.name[0]})}}}else{let s=[];for(const i of t.items){if(["skill"].includes(i.type)&&(this.defaultSkills.includes(i.name)||d&&p==i.name)&&a.default.push({name:`${i.name} (${i.system.talentValue.value})`,id:i.id,icon:i.img,cssClass:"skill filterable",abbrev:i.name[0]}),["skill"].includes(i.type)){const t={name:`${i.name} (${i.system.talentValue.value})`,id:i.id,icon:i.img,cssClass:"skill",addClass:i.system.group.value,abbrev:i.name[0],tw:i.system.talentValue.value};i.system.talentValue.value>0&&(t.cssClass+=" filterable",s.push(t)),e.push(t)}else u.includes(i.type)&&(i.system.effectFormula.value?a.spells.push({name:i.name,id:i.id,icon:i.img,cssClass:"spell",abbrev:i.name[0]}):c.push({name:i.name,id:i.id,icon:i.img,cssClass:"spell",abbrev:i.name[0]}));i.getFlag("dsa5","onUseEffect")&&r.push({name:i.name,id:i.id,icon:i.img,cssClass:"onUse",abbrev:i.name[0],subfunction:"onUse"})}a.skills.push(...s.sort(((e,t)=>t.tw-e.tw)).slice(0,5))}i=r.pop(),0==a.spells.length&&c.length>0&&a.spells.push(c.pop()),a.spells.length>0&&c.length>0&&(a.spells[0].more=c.sort(((e,t)=>e.name.localeCompare(t.name))),a.spells[0].subwidth=this.subWidth(c,m)),a.default.length>0&&e.length>0&&(a.default[0].more=e.sort(((e,t)=>e.addClass.localeCompare(t.addClass)||e.name.localeCompare(t.name))),a.default[0].subwidth=this.subWidth(e,m,20)),s&&(n.length>0&&(s.more=n,s.subwidth=this.subWidth(n,m)),a.consumables=[s]),i&&(r.length>0&&(i.more=r,i.subwidth=this.subWidth(r,m)),a.onUsages=[i])}else if(game.user.isGM&&!game.settings.get("dsa5","disableTokenhotbarMaster")){p=!0;const e=this.skills||await this.prepareSkills();a.gm=this.gmItems.filter((e=>!e.disabled)).concat([{name:"TT.tokenhotbarSkill",id:"skillgm",icon:"systems/dsa5/icons/categories/Skill.webp",cssClass:"skillgm filterable",abbrev:"",subfunction:"none",more:e,subwidth:this.subWidth(e,m,20)}])}if(this.showEffects){let e={name:"CONDITION.add",id:"",icon:"icons/svg/aura.svg",cssClass:"effect",abbrev:game.i18n.localize("CONDITION.add")[0],subfunction:"addEffect"};l.length>0&&(e.more=l,e.subwidth=this.subWidth(l,m)),a.effects=[e]}const h=Object.keys(a).reduce(((e,t)=>e+a[t].length),0)+(p?3:0);return d?(this.position.width=m,this.position.height=m*h+14):(this.position.width=m*h+14,this.position.height=m),mergeObject(e,{items:a,itemWidth:m,direction:c,count:h,gmMode:p,darkness:canvas.scene?.darkness||0,opacity:game.settings.get("dsa5","tokenhotbaropacity")}),e}filterButtons(e){switch(e.which){case 17:return;case 8:this.searching=this.searching.slice(0,-1);break;default:this.searching+=String.fromCharCode(e.which)}e.preventDefault(),e.stopPropagation();const t=this.searching.toLowerCase();(0,l.p0)(t);let a=$(e.currentTarget).find(".subbuttons li");a.find(".dsahidden").removeClass("dsahidden"),a.filter((function(){return-1==$(this).find("label").text().toLowerCase().trim().indexOf(t)})).addClass("dsahidden")}async render(e,t={}){const a=await super.render(e,t);return this._element&&this._element.css({zIndex:61}),a}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){const n=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),r=this.element[0];if(!r.style.width||a){const t=a||r.offsetWidth,s=r.style.maxWidth||window.innerWidth;n.width=a=Math.clamped(t,0,s),r.style.width=a+"px",a+n.left>window.innerWidth&&(e=n.left)}return game.settings.set("dsa5","tokenhotbarPosition",{left:n.left,top:n.top}),n}async updateDSA5Hotbar(){const e=canvas.tokens.controlled;if(this.actor=void 0,this.showEffects=!1,1===e.length){const t=e[0].actor;t&&t.isOwner&&(this.actor=t)}e.length>=1&&(this.showEffects=!0),await this.render(!0,{focus:!1})}}class AddEffectDialog extends Dialog{static async showDialog(){const e=duplicate(CONFIG.statusEffects).map((e=>({name:game.i18n.localize(e.name),icon:e.icon,description:game.i18n.localize(e.description),id:e.id}))).sort(((e,t)=>e.name.localeCompare(t.name))),t=new AddEffectDialog({title:game.i18n.localize("CONDITION.add"),content:await renderTemplate("systems/dsa5/templates/dialog/addstatusdialog.html",{effects:e}),buttons:{}});t.position.height=36*Math.ceil(e.length/3)+170,t.render(!0)}activateListeners(e){super.activateListeners(e),e.find(".reactClick").mouseenter((e=>{if(0==e.currentTarget.getElementsByClassName("hovermenu").length){let t=document.createElement("div");t.classList.add("hovermenu"),t.style.cssText="font-size: var(--font-size-20);";let a=document.createElement("i");a.classList.add("fas","fa-cogs"),a.title=game.i18n.localize("ActiveEffects.custom"),a.addEventListener("click",(async e=>this.configureEffect(e)),!1),t.appendChild(a),e.currentTarget.appendChild(t)}})),e.find(".reactClick").mouseleave((e=>{let t=e.toElement||e.relatedTarget;t.parentNode!=this&&t!=this&&e.currentTarget.querySelectorAll(".hovermenu").forEach((e=>e.remove()))})),e.find(".quantity-click").mousedown((e=>d.Z.quantityClick(e))),e.find(".reactClick").click((e=>this.addEffect(e.currentTarget.dataset.value)));let t=e.find(".conditionSearch");t.keyup((t=>this._filterConditions($(t.currentTarget),e))),t[0]&&t[0].addEventListener("search",(t=>this._filterConditions($(t.currentTarget),e)),!1)}_filterConditions(e,t){if(null!=e.val()){let a=e.val().toLowerCase().trim(),s=t.find(".filterable");t.find(".filterHide").removeClass("filterHide"),s.filter((function(){return-1==$(this).find("span").text().toLowerCase().trim().indexOf(a)})).addClass("filterHide")}}static async modifyEffectDialog(e,t){new AddEffectDialog({title:game.i18n.localize("CONDITION."+e),content:await renderTemplate("systems/dsa5/templates/dialog/configurestatusdialog.html"),default:"add",buttons:{add:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("CONDITION.add"),callback:async a=>{const s={},i="seconds"==a.find("[name=unit]:checked").val()?Math.round(a.find(".duration").val()/5):a.find(".duration").val(),n=a.find(".effectname").val();i>0&&mergeObject(s,d.Z._buildDuration(i)),n&&(s.name=n),await t(e,s)}}}}).render(!0,{width:400,resizable:!1,classes:["dsa5","dialog"]})}async configureEffect(e){e.stopPropagation();const t=$(e.currentTarget).closest(".reactClick").attr("data-value");this.close(),AddEffectDialog.modifyEffectDialog(t,(async(e,t)=>this.addEffect(e,t)))}async addEffect(e,t={}){for(let a of canvas.tokens.controlled)await a.actor.addTimedCondition(e,1,!1,!1,t);game.dsa5.apps.tokenHotbar?.render(!0),this.close()}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:["dsa5","tokenStatusEffects"],width:700,resizable:!0}),e}}class ActorSheetDsa5 extends ActorSheet{get actorType(){return this.actor.type}async _render(e=!1,t={}){this._saveSearchFields(),this._saveCollapsed(),await super._render(e,t),this._setCollapsed(),this._restoreSeachFields();let a=$(this._element);const s={".close":"SHEET.Close",".configure-sheet":"SHEET.Configure",".configure-token":"SHEET.Token",".import":"SHEET.Import",".locksheet":"SHEET.Lock",".library":"SHEET.Library",".playerview":"SHEET.switchLimited",".actorConfig":"SHEET.actorConfig"};for(let e of Object.keys(s))a.find(e).attr("data-tooltip",s[e]);this.currentFocus&&(a.find('[data-item-id="'+this.currentFocus+'"] input').focus().select(),this.currentFocus=null)}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"skills"}],mergeObject(e,{width:770,height:740,scrollY:[".save-scroll"],dragDrop:[{dragSelector:".content .item",dropSelector:null},{dragSelector:".mainEffects .statusEffect",dropSelector:null}]}),e}_saveSearchFields(){if(null===this.form)return;const e=$(this.form).parent();this.searchFields={talentFiltered:$(e.find(".filterTalents")).hasClass("filtered"),searchText:$(e.find(".talentSearch")).val(),gearSearch:$(e.find(".gearSearch")).val()}}_restoreSeachFields(){if(null!=this.searchFields){const e=$(this.form).parent();this.searchFields.talentFiltered&&($(e.find(".filterTalents")).addClass("filtered"),$(e.find(".allTalents")).removeClass("showAll"));const t=$(e.find(".talentSearch"));t.val(this.searchFields.searchText),""!=this.searchFields.searchText&&this._filterTalents(t);const a=$(e.find(".gearSearch"));a.val(this.searchFields.gearSearch),""!=this.searchFields.searchText&&this._filterGear(a)}}_saveCollapsed(){if(null===this.form)return;const e=$(this.form).parent();this.collapsedBoxes=[],this.openDetails=[];let t=e.find(".ch-collapse i");for(let e of t)this.collapsedBoxes.push($(e).attr("class"));for(const t of $(e.find(".expandDetails.shown")))this.openDetails.push($(t).closest(".item").attr("data-item-id"))}_setCollapsed(){const e=$(this.form).parent();if(this.collapsedBoxes){let t=e.find(".ch-collapse i");for(let e=0;e<t.length;e++)$(t[e]).attr("class",this.collapsedBoxes[e]),this.collapsedBoxes[e]&&-1!=this.collapsedBoxes[e].indexOf("fa-angle-down")&&$(t[e]).closest(".groupbox").find(".row-section:nth-child(2)").hide()}}async getData(e){const a=await super.getData(e),s={actor:a.actor,editable:a.editable,limited:a.limited,owner:a.owner};return s.prepare=this.actor.prepareSheet({details:this.openDetails}),s.sizeCategories=t.Z.sizeCategories,s.isGM=game.user.isGM,s.initDies={"":"-","1d6":"1d6","2d6":"2d6","3d6":"3d6","4d6":"4d6"},s.horseSpeeds=Object.keys(g.Z.speedKeys),r.Z.prepareActiveEffects(this.actor,s),s.enrichedOwnerdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.ownerdescription"),{secrets:this.object.isOwner,async:!0}),s.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.gmdescription"),{secrets:this.object.isOwner,async:!0}),s.enrichedNotes=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.notes.value"),{secrets:this.object.isOwner,async:!0}),s.enrichedBiography=await TextEditor.enrichHTML(getProperty(this.actor.system,"details.biography.value"),{secrets:this.object.isOwner,async:!0}),s}_onItemCreate(a){a.preventDefault();let i=a.currentTarget,n=duplicate(i.dataset);t.Z.equipmentTypes[n.type]&&(n.type="equipment",n=mergeObject(n,{"system.equipmentType.value":a.currentTarget.attributes["item-section"].value,"system.effect.value":""})),["aggregatedTest","spell","liturgy","ritual","ceremony"].includes(n.type)||(n["system.weight.value"]=0,n["system.quantity.value"]=0),s.Z.defaultIcon(n),n.name=e.Z.categoryLocalization(n.type),this.actor.createEmbeddedDocuments("Item",[n])}_handleAggregatedProbe(t){const a=this._getItemId(t);let s=this.actor.items.get(a).toObject();const i=s.system.talent[`value${t.currentTarget.dataset.which}`];let n=this.actor.items.find((e=>e.name==i&&"skill"==e.type)),r=`<h3 class="center"><b>${game.i18n.localize("TYPES.Item.aggregatedTest")}</b></h3>`;s.system.usedTestCount.value>=s.system.allowedTestCount.value?(r+=`${game.i18n.localize("Aggregated.noMoreAllowed")}`,ChatMessage.create(e.Z.chatDataSetup(r))):this.actor.setupSkill(n,{moreModifiers:[{name:game.i18n.localize("failedTests"),value:-1*s.system.previousFailedTests.value,selected:!0},{name:game.i18n.localize("Modifier"),value:s.system.baseModifier,selected:!0}]},this.getTokenId()).then((e=>{this.actor.basicTest(e).then((e=>{e.result.successLevel>0?(s.system.cummulatedQS.value=e.result.qualityStep+s.system.cummulatedQS.value,s.system.cummulatedQS.value=Math.min(10,s.system.cummulatedQS.value)):s.system.previousFailedTests.value+=1,s.system.usedTestCount.value+=1,this.actor.updateEmbeddedDocuments("Item",[s]).then((()=>{const e=this.actor.items.get(a);e.postItem(),s.system.cummulatedQS.value>=10&&e.sheet.postFinishedItem()}))}))}))}async consumeItem(e){new Dialog({title:game.i18n.localize("SHEET.ConsumeItem")+": "+e.name,content:game.i18n.localize("SHEET.ConsumeItem")+": "+e.name,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{e.setupEffect(null,{},this.getTokenId())}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async _advanceAttribute(t){const a=Number(this.actor.system.characteristics[t].advances)+Number(this.actor.system.characteristics[t].initial),s=e.Z._calculateAdvCost(a,"E");await this._checkEnoughXP(s)&&await this._updateAPs(s,{[`system.characteristics.${t}.advances`]:Number(this.actor.system.characteristics[t].advances)+1})}async _refundAttributeAdvance(t){const a=Number(this.actor.system.characteristics[t].advances)+Number(this.actor.system.characteristics[t].initial);if(Number(this.actor.system.characteristics[t].advances)>0){const s=-1*e.Z._calculateAdvCost(a,"E",0);await this._updateAPs(s,{[`system.characteristics.${t}.advances`]:Number(this.actor.system.characteristics[t].advances)-1})}}async _advancePoints(t){const a=Number(this.actor.system.status[t].advances),s=e.Z._calculateAdvCost(a,"D");await this._checkEnoughXP(s)&&this._checkMaximumPointAdvancement(t,a+1)&&await this._updateAPs(s,{[`system.status.${t}.advances`]:Number(this.actor.system.status[t].advances)+1})}async _refundPointsAdvance(t){const a=Number(this.actor.system.status[t].advances);if(a>0){const s=-1*e.Z._calculateAdvCost(a,"D",0);await this._updateAPs(s,{[`system.status.${t}.advances`]:Number(this.actor.system.status[t].advances)-1})}}async _advanceItem(t){let a=this.actor.items.get(t).toObject(),s=e.Z._calculateAdvCost(Number(a.system.talentValue.value),a.system.StF.value);await this._checkEnoughXP(s)&&this.actor._checkMaximumItemAdvancement(a,Number(a.system.talentValue.value)+1)?.result&&(await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.talentValue.value":a.system.talentValue.value+1}]),await this._updateAPs(s))}async _refundItemAdvance(t){let a=this.actor.items.get(t).toObject();const s="combatskill"==a.type?6:0;if(a.system.talentValue.value>s){let s=-1*e.Z._calculateAdvCost(Number(a.system.talentValue.value),a.system.StF.value,0);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.talentValue.value":a.system.talentValue.value-1}]),await this._updateAPs(s)}}_checkMaximumPointAdvancement(e,t){let a=!1;switch(e){case"wounds":a=t<=this.actor.system.characteristics.ko.value;break;case"astralenergy":a=t<=(null==this.actor.system.characteristics[this.actor.system.guidevalue.magical]?0:this.actor.system.characteristics[this.actor.system.guidevalue.magical].value*this.actor.system.energyfactor.magical);break;case"karmaenergy":a=t<=(null==this.actor.system.characteristics[this.actor.system.guidevalue.clerical]?0:this.actor.system.characteristics[this.actor.system.guidevalue.clerical].value*this.actor.system.energyfactor.clerical)}return a||ui.notifications.error(game.i18n.localize("DSAError.AdvanceMaximumReached")),a}async _openLibrary(){game.dsa5.itemLibrary.render(!0)}async _configActor(){DialogActorConfig.buildDialog(this.actor)}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"library",icon:"fas fa-university",onclick:async()=>this._openLibrary()}),this.actor.isOwner&&(e.unshift({class:"actorConfig",icon:"fas fa-link",onclick:async()=>this._configActor()}),e.unshift({class:"playerview",icon:"fas fa-toggle-on",onclick:async e=>this._togglePlayerview(e)})),this.actor.system.canAdvance&&e.unshift({class:"locksheet",icon:`fas fa-${this.actor.system.sheetLocked.value?"":"un"}lock`,onclick:async e=>this._changeAdvanceLock(e)}),e}async _changeAdvanceLock(e){await this.actor.update({"system.sheetLocked.value":!this.actor.system.sheetLocked.value}),$(e.currentTarget).find("i").toggleClass("fa-unlock fa-lock")}async _checkEnoughXP(e){return await this.actor.checkEnoughXP(e)}async advanceWrapper(e,t,a){let s=$(e.currentTarget).find("i");s.hasClass("fa-spin")||(s.addClass("fa-spin fa-spinner"),await this[t](a),s.removeClass("fa-spin fa-spinner"))}playerViewEnabled(){return getProperty(this.actor.system,"playerView")}_togglePlayerview(e){this.actor.update({"system.playerView":!getProperty(this.actor.system,"playerView")})}showLimited(){return!game.user.isGM&&this.actor.limited||this.playerViewEnabled()}getTokenId(){return this.token?.id}rollDisease(e){const t=this.actor.items.get(e),a=-1*this.actor.system.status.soulpower.max,s=-1*this.actor.system.status.toughness.max;t.setupEffect(void 0,{rollMode:"gmroll",manualResistance:{SKModifier:a,ZKModifier:s}}).then((async e=>{const a=await t.itemTest(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t.id,"system.duration.resolved":a.result.duration}])}))}async swapWeaponHand(e){const t=this._getItemId(e),a=this.actor.items.get(t);["Daggers","Fencing Weapons"].includes(game.i18n.localize(`LocalizedCTs.${a.system.combatskill.value}`))||await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.wrongGrip":!a.system.worn.wrongGrip}])}activateListeners(t){super.activateListeners(t);const posthand=e=>{this.actor.items.get(this._getItemId(e)).postItem()};t.find(".roll-disease").click((e=>this.rollDisease(this._getItemId(e)))),(0,l.Ee)(t),t.find(".condition-edit").click((e=>{this.actor.effects.get(e.currentTarget.dataset.id).sheet.render(!0)})),t.find(".ch-collapse").click((e=>{$(e.currentTarget).find("i").toggleClass("fa-angle-up fa-angle-down"),$(e.currentTarget).closest(".groupbox").find(".row-section:nth-child(2)").fadeToggle()})),t.find(".status-create").click((e=>{let t=$(e.currentTarget).closest(".statusEffectMenu").find("ul");t.fadeIn("fast",(()=>{t.find("input").focus()}))})),t.find(".statusEffectMenu ul").mouseleave((e=>$(e.currentTarget).fadeOut())),t.find(".roll-aggregated").mousedown((e=>this._handleAggregatedProbe(e))),t.find(".skill-select").mousedown((e=>{const t=this._getItemId(e);let a=this.actor.items.get(t);0==e.button?this.actor.setupSkill(a,{},this.getTokenId()).then((e=>{this.actor.basicTest(e)})):2==e.button&&a.sheet.render(!0)})),t.find(".spell-select").mousedown((e=>{const t=this._getItemId(e);let a=this.actor.items.get(t);0==e.button?this.actor.setupSpell(a,{},this.getTokenId()).then((e=>this.actor.basicTest(e))):2==e.button&&a.sheet.render(!0)})),t.find(".item-post").click((e=>posthand(e))),t.find(".item-dropdown").click((e=>{e.preventDefault(),$(e.currentTarget).closest(".item").find(".expandDetails:first").toggleClass("shown")})),t.find(".condition-show").mousedown((e=>{e.preventDefault();const t=e.currentTarget.dataset.id,a=$(e.currentTarget).parents(".statusEffect").attr("data-descriptor");if(0==e.button){const s=$(e.currentTarget).parents(".statusEffect").attr("data-origin");if(s)fromUuid(s).then((e=>e.sheet.render(!0)));else{let s,i;a?(s=CONFIG.statusEffects.find((e=>e.id==a)),i=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${s.id}"><img src="${s.icon}"/>${game.i18n.localize(s.name)}</a></b>: ${game.i18n.localize(s.description)}</div>`)):(s=this.actor.effects.find((e=>e.id==t)),s&&(i=$(`<div style="padding:5px;"><b><a class="chat-condition chatButton" data-id="${s.id}"><img src="${s.icon}"/>${game.i18n.localize(s.name)}</a></b>: ${game.i18n.localize(s.flags.dsa5.description)}</div>`)));const n=$(e.currentTarget).closest(".groupbox").find(".effectDescription");n.fadeOut("fast",(function(){n.html(i).fadeIn("fast")}))}}else 2!=e.button||e.currentTarget.dataset.locked||this._deleteActiveEffect(t)})),t.on("click",".chat-condition",(e=>n.Z.postStatus(e.currentTarget.dataset.id))),t.find(".money-change, .skill-advances").focusin((e=>{this.currentFocus=$(e.currentTarget).closest("[data-item-id]").attr("data-item-id")})),t.find(".item-edit").click((e=>{e.preventDefault();const t=this._getItemId(e);this.actor.items.get(t).sheet.render(!0)})),t.find(".showApplication").mousedown((e=>{if(e.preventDefault(),2==e.button)this._deleteItem(e);else{const t=this._getItemId(e);this.actor.items.get(t).sheet.render(!0)}})),t.find(".ch-value").click((e=>{e.preventDefault();let t=e.currentTarget.attributes["data-char"].value;this.actor.setupCharacteristic(t,{},this.getTokenId()).then((e=>this.actor.basicTest(e)))})),t.find(".ch-status").click((e=>{e.preventDefault(),this.actor.setupDodge({},this.getTokenId()).then((e=>{this.actor.basicTest(e)}))})),t.find(".ch-regenerate").click((e=>{e.preventDefault(),this.actor.setupRegeneration("regenerate",{},this.getTokenId()).then((e=>this.actor.basicTest(e)))})),t.find(".ch-weaponless").click((e=>{e.preventDefault();let t=e.currentTarget.attributes["data-char"].value;this.actor.setupWeaponless(t,{},this.getTokenId()).then((e=>this.actor.basicTest(e)))})),t.find(".ch-fallingDamage").click((e=>{e.preventDefault(),this.actor.setupFallingDamage({},this.getTokenId())})),t.find(".ch-rollCombat").click((e=>{e.preventDefault();let t=this._getItemId(e);const a=e.currentTarget.dataset.mode,s=this.actor.items.get(t);this.actor.setupWeapon(s,a,{},this.getTokenId()).then((e=>this.actor.basicTest(e)))}));const deletehand=e=>this._deleteItem(e);t.find(".cards .item").mouseenter((e=>{if(0==e.currentTarget.getElementsByClassName("hovermenu").length){const t=document.createElement("div");t.classList.add("hovermenu");const a=document.createElement("i");a.classList.add("fas","fa-times"),a.title=game.i18n.localize("SHEET.DeleteItem"),a.addEventListener("click",deletehand,!1);const s=document.createElement("i");s.classList.add("fas","fa-comment"),s.title=game.i18n.localize("SHEET.PostItem"),s.addEventListener("click",posthand,!1),t.appendChild(s),t.appendChild(a),e.currentTarget.appendChild(t)}})),t.find(".cards .item").mouseleave((e=>{let t=e.toElement||e.relatedTarget;t&&t.parentNode!=this&&t!=this&&e.currentTarget.querySelectorAll(".hovermenu").forEach((e=>e.remove()))}));const a=this.actor.uuid;t.find(".actorDrag").each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(e=>{let t={type:"Actor",uuid:a};e.dataTransfer.setData("text/plain",JSON.stringify(t))}))})),t.find(".filterTalents").click((e=>{$(e.currentTarget).closest(".content").find(".allTalents").toggleClass("showAll"),$(e.currentTarget).toggleClass("filtered")})),t.find(".charimg").mousedown((t=>{2==t.button&&e.Z.showArtwork(this.actor,!0)})),u.Z.bindRollCommands(t);let s=t.find(".talentSearch");s.keyup((e=>this._filterTalents($(e.currentTarget)))),s[0]&&s[0].addEventListener("search",(e=>this._filterTalents($(e.currentTarget))),!1);let i=t.find(".conditionSearch");i.keyup((e=>this._filterConditions($(e.currentTarget)))),i[0]&&i[0].addEventListener("search",(e=>this._filterConditions($(e.currentTarget))),!1);let m=t.find(".gearSearch");m.keyup((e=>this._filterGear($(e.currentTarget)))),m[0]&&m[0].addEventListener("search",(e=>this._filterGear($(e.currentTarget))),!1),bindImgToCanvasDragStart(t,"img.charimg"),g.Z.activateListeners(t,this.actor),this._bindKeepFieldsEnabled(t),this.isEditable&&(t.find(".startCharacterBuilder").click((()=>this.actor.setFlag("core","sheetClass","dsa5.DSACharBuilder"))),t.find(".schipUpdate").click((e=>{e.preventDefault();let t=Number(e.currentTarget.getAttribute("data-val"));1==t&&1==$(this.form).find(".fullSchip").length&&(t=0),this.actor.update({"system.status.fatePoints.value":t})})),t.find(".swapWeaponHand").click((e=>this.swapWeaponHand(e))),t.find(".defenseToggle").click((()=>this.actor.update({"system.config.defense":!this.actor.system.config.defense}))),t.find(".loadWeapon").mousedown((async e=>{const t=this._getItemId(e),a=this.actor.items.get(t).toObject();if(""===getProperty(a,"system.currentAmmo.value"))return;const s={_id:t};if(0==e.button){const e="trait"==a.type?a.system.reloadTime.value:o.Z.calcLZ(a,this.actor);s["system.reloadTime.progress"]=Math.min(a.system.reloadTime.progress+1,e)}else 2==e.button&&(s["system.reloadTime.progress"]=0);await this.actor.updateEmbeddedDocuments("Item",[s])})),t.find(".chargeSpell").mousedown((async e=>{const t=this._getItemId(e),a=this.actor.items.get(t).toObject(),s=Number(a.system.castingTime.modified);0==e.button?a.system.castingTime.progress=Math.min(a.system.castingTime.progress+1,s):2==e.button&&(a.system.castingTime.progress=0,a.system.castingTime.modified=0),await this.actor.updateEmbeddedDocuments("Item",[a])})),t.find(".item-swapMag").click((async e=>{await this.actor.swapMag(this._getItemId(e))})),t.find(".ammo-selector").change((async e=>{e.preventDefault();const t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.currentAmmo.value":$(e.currentTarget).val()}])})),t.find(".item-toggle").click((e=>{const t=this._getItemId(e);let a=this.actor.items.get(t).toObject();switch(a.type){case"armor":case"rangeweapon":case"meleeweapon":case"equipment":this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.worn.value":!a.system.worn.value}]),c.Z.playEquipmentWearStatusChange(a)}})),t.find(".quantity-click").mousedown((e=>{const t=this._getItemId(e);let a=this.actor.items.get(t).toObject();d.Z.increment(e,a,"system.quantity.value",0),this.actor.updateEmbeddedDocuments("Item",[a])})),t.find(".status-add").mousedown((async e=>{let t=e.currentTarget.dataset.id;"custom"==t?r.Z.createCustomEffect(this.actor):0==e.button?await this.actor.addCondition(t,1,!1,!1):2==e.button&&AddEffectDialog.modifyEffectDialog(t,(async(e,t)=>this.actor.addTimedCondition(e,1,!1,!1,t)))})),t.find(".money-change").change((async e=>{const t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.quantity.value":Number(e.target.value)}])})),t.find(".skill-advances").change((async e=>{const t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"system.talentValue.value":Number(e.target.value)}])})),t.find(".advance-attribute").mousedown((e=>this.advanceWrapper(e,"_advanceAttribute",e.currentTarget.dataset.attr))),t.find(".refund-attribute").mousedown((e=>this.advanceWrapper(e,"_refundAttributeAdvance",e.currentTarget.dataset.attr))),t.find(".advance-item").mousedown((e=>this.advanceWrapper(e,"_advanceItem",this._getItemId(e)))),t.find(".refund-item").mousedown((e=>this.advanceWrapper(e,"_refundItemAdvance",this._getItemId(e)))),t.find(".advance-points").mousedown((e=>this.advanceWrapper(e,"_advancePoints",e.currentTarget.dataset.attr))),t.find(".refund-points").mousedown((e=>this.advanceWrapper(e,"_refundPointsAdvance",e.currentTarget.dataset.attr))),t.find(".onUseItem").click((e=>this._onMacroUseItem(e))),t.find(".item-create").click((e=>this._onItemCreate(e))),t.find(".condition-toggle").mousedown((async e=>{let t=$(e.currentTarget).parents(".statusEffect").attr("data-id"),a=this.actor.effects.get(t);await a.update({disabled:!a.disabled})})),t.find(".condition-value").mousedown((async e=>{let t=$(e.currentTarget).parents(".statusEffect").attr("data-descriptor");0==e.button?await this.actor.addCondition(t,1,!1,!1):2==e.button&&await this.actor.removeCondition(t,1,!1)})),t.find(".item-delete").click((e=>this._deleteItem(e))),t.find(".tradition-delete").click((e=>this._deleteTraditionArtifact(e))),t.find(".selectTraditionartifact").click((()=>this.selectTraditionartifact())),t.find(".consume-item").mousedown((e=>{if(2==e.button){const t=this._getItemId(e),a=this.actor.items.get(t);this.consumeItem(a)}})),t.find(".disableRegeneration").click((e=>{const t=`system.repeatingEffects.disabled.${e.currentTarget.dataset.type}`;this.actor.update({[t]:!getProperty(this.actor,t)})})))}_bindKeepFieldsEnabled(e){if(!this.isEditable){const t=e.find(".keepFieldsEnabled");for(let e of t){const t=e.dataset.attr,a=e.dataset.name;$(e).find(".editor").append(`<a data-attr="${t}" data-name="${a}" class="editor-edit"><i class="fas fa-edit"></i></a>`),$(e).find(".editor-edit").click((e=>this._openKeepFieldEditpage(e)))}}}_openKeepFieldEditpage(e){const t=e.currentTarget.dataset.attr,a=e.currentTarget.dataset.name;new ForeignFieldEditor(this.actor.id,t,a).render(!0)}_onMacroUseItem(e){const t=this.actor.items.get(this._getItemId(e));new m.Z(t).executeOnUseEffect()}_filterGear(e){if(null!=e.val()){let t=e.val().toLowerCase().trim(),a=$(this.element).find(".inventory .item");a.removeClass("filterHide"),a.filter((function(){return-1==$(this).find("a.item-edit").text().toLowerCase().trim().indexOf(t)})).addClass("filterHide")}}async selectTraditionartifact(){this.isEditable&&new TraditionArtifactpicker(this.actor).render(!0)}_deleteTraditionArtifact(e){if(!this.isEditable)return;this.actor.items.get(this._getItemId(e)).update({"system.isArtifact":!1})}_filterTalents(e){if(null!=e.val()){let t=e.val().toLowerCase().trim(),a=$(this.form).parent().find(".allTalents");a.find(".item, .table-header, .table-title").removeClass("filterHide"),a.addClass("showAll").find(".item").filter((function(){return-1==$(this).find(".talentName").text().toLowerCase().trim().indexOf(t)})).addClass("filterHide"),t.length>0?(a.find(".table-header, .table-title:not(:eq(0))").addClass("filterHide"),a.addClass("filterfull")):a.removeClass("filterfull")}}_filterConditions(e){if(null!=e.val()){let t=e.val().toLowerCase().trim(),a=$(this.form).find(".statusEffectMenu li:not(.search)");a.removeClass("filterHide"),a.filter((function(){return-1==game.i18n.localize($(this).find("a").attr("data-tooltip")).toLowerCase().trim().indexOf(t)})).addClass("filterHide")}}async _deleteActiveEffect(e){if(!this.isEditable)return;let t=this.actor.effects.find((t=>t.id==e));if(t){(this.token?this.token.actor:this.actor)&&await this.actor.deleteEmbeddedDocuments("ActiveEffect",[t.id])}}async _deleteItem(e){if(!this.isEditable)return;const t=this._getItemId(e);let a=this.actor.items.get(t),s=game.i18n.format("DIALOG.DeleteItemDetail",{item:a.name});const i=await renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:s});await new Promise(((e,a)=>{new Dialog({title:game.i18n.localize("DIALOG.deleteConfirmation"),content:i,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async()=>{await this._cleverDeleteItem(t),e(!0)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}))}async _cleverDeleteItem(t){const s=this.actor.items.get(t),n=[t];switch(s.type){case"advantage":case"disadvantage":await a.Z.vantageRemoved(this.actor,s,!1);break;case"specialability":await i.Z.abilityRemoved(this.actor,s,!1);break;case"blessing":case"magictrick":await this._updateAPs(-1,{},{render:!1});break;case"ritual":case"ceremony":case"liturgy":case"spell":{let t=0;for(let a=0;a<=s.system.talentValue.value;a++)t+=e.Z._calculateAdvCost(a,s.system.StF.value,0);const a=this.actor.items.filter((e=>"spellextension"==e.type&&s.type==e.system.category&&s.name==e.system.source));a&&(t+=a.reduce(((e,t)=>e+(Number(t.system.APValue.value)||0)),0),n.push(...a.map((e=>e.id)))),await this._updateAPs(-1*t,{},{render:!1})}}await this.actor.deleteEmbeddedDocuments("Item",n)}_getItemId(e){return $(e.currentTarget).closest(".item").attr("data-item-id")}async _addMoney(e){let t=duplicate(this.actor.items.filter((e=>"money"==e.type))).find((t=>t.name==e.name));t?(t.system.quantity.value+=e.system.quantity.value,await this.actor.updateEmbeddedDocuments("Item",[t])):await this.actor.createEmbeddedDocuments("Item",[e])}async _updateAPs(e,t={},a={}){await this.actor._updateAPs(e,t,a)}async _addVantage(e,t){a.Z.needsAdoption(this.actor,e,t)}async _addSpecialAbility(e,t){i.Z.needsAdoption(this.actor,e,t)}_onDragStart(e){const t=e.currentTarget;if(e.target.classList.contains("content-link"))return;let a;if(t.dataset.itemId){a=this.actor.items.get(t.dataset.itemId).toDragData(),t.dataset.mod&&(a.mod=t.dataset.mod)}if(t.dataset.id){a=this.actor.effects.get(t.dataset.id).toDragData()}a&&e.dataTransfer.setData("text/plain",JSON.stringify(a))}async _handleSpellExtension(t){if(!this.actor.items.find((e=>e.type==t.type&&e.name==t.name))){t=duplicate(t);let a=this.actor.items.find((e=>e.type==t.system.category&&e.name==t.system.source));if(a){if(a.system.talentValue.value<t.system.talentValue)return void ui.notifications.error(game.i18n.localize("DSAError.talentValueTooLow"));let e=t.system.APValue.value;await this.actor.checkEnoughXP(e)&&(await this._updateAPs(e,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[t]))}else ui.notifications.error(game.i18n.format("DSAError.noSpellForExtension",{name:t.system.source,category:e.Z.categoryLocalization(t.system.category),extension:t.name}))}}async _addSpellOrLiturgy(t){let a,s=this.actor.items.find((e=>e.type==t.type&&e.name==t.name));if(t=duplicate(t),!s){switch(t.type){case"spell":case"liturgy":case"ceremony":case"ritual":a=e.Z._calculateAdvCost(0,t.system.StF.value,0);break;case"blessing":case"magictrick":a=1;break;case"magicalsign":a=t.system.APValue.value;break;default:return}await this.actor.checkEnoughXP(a)&&(await this._updateAPs(a,{},{render:!1}),await this.actor.createEmbeddedDocuments("Item",[t]))}}async _addLoot(e){e=duplicate(e);let t=this.actor.items.find((t=>s.Z.areEquals(e,t)));return t?(await s.Z.stackItems(t,e,this.actor))[0]:("combat"==this._tabs[0].active&&e.system.worn&&(e.system.worn.value=!0),(await this.actor.createEmbeddedDocuments("Item",[e]))[0])}async _addUniqueItem(e){if(e=duplicate(e),!this.actor.items.some((t=>s.Z.areEquals(e,t))))return(await this.actor.createEmbeddedDocuments("Item",[e]))[0]}async _addDemonMarkOrPatron(e){return await this._addUniqueItem(e)}async _addDisease(e){return e.system.duration.resolved="?",await this._addUniqueItem(e)}async handleItemCopy(e,a){if(t.Z.equipmentCategories.includes(a))return e.name+=" (Copy)",await this._addLoot(e)}async _addFullPack(e){let t=(await game.packs.get(e.name).getDocuments()).filter((e=>!this.actor.items.find((t=>t.type==e.type&&t.name==e.name))));e.onlyType&&(t=t.filter((t=>t.type==e.onlyType))),await this.actor.createEmbeddedDocuments("Item",t.map((e=>e.toObject())))}async creatureDrop(e){game.dsa5.config.hooks.shapeshift?new Dialog({title:game.i18n.localize("DIALOG.ItemRequiresAdoption")+": "+e.name,content:game.i18n.localize("DIALOG.whichFunction")+": "+e.name,default:"horse",buttons:{shapeshift:{icon:'<i class="fas fa-paw"></i>',label:game.i18n.localize("CONDITION.shapeshift"),callback:()=>{const t=game.dsa5.config.hooks.shapeshift;t.setShapeshift(this.actor,e),t.render(!0)}},horse:{icon:'<i class="fas fa-horse"></i>',label:game.i18n.localize("RIDING.horse"),callback:()=>{g.Z.setHorse(this.actor,e)}}}}).render(!0):g.Z.setHorse(this.actor,e)}async _manageDragItems(e,t){switch(t){case"disease":await this._addDisease(e);break;case"meleeweapon":case"rangeweapon":case"equipment":case"ammunition":case"armor":case"poison":case"consumable":case"plant":return await this._addLoot(e);case"disadvantage":case"advantage":await this._addVantage(e,t);break;case"specialability":await this._addSpecialAbility(e,t);break;case"money":await this._addMoney(e);break;case"ritual":case"ceremony":case"blessing":case"magictrick":case"liturgy":case"spell":case"magicalsign":await this._addSpellOrLiturgy(e);break;case"effectwrapper":await this._handleEffectWrapper(e);break;case"application":await this._handleApplication(e);break;case"spellextension":await this._handleSpellExtension(e);break;case"creature":this.creatureDrop(e);break;case"skill":case"information":await this._addUniqueItem(e);break;case"patron":case"demonmark":await this._addDemonMarkOrPatron(e);break;default:ui.notifications.error(game.i18n.format("DSAError.canNotBeAdded",{item:e.name,category:game.i18n.localize(e.type)}))}}async _handleEffectWrapper(e){this.actor.createEmbeddedDocuments("ActiveEffect",e.effects.map((e=>(e.origin=null,e))))}async _handleLookup(t){let a=await e.Z.findAnyItem(t.items);if(a){for(let e of t.items)if(e.count){let t=a.find((t=>t.name==e.name&&t.type==e.type));t?(t.system.quantity.value=e.count,e.qs&&"consumable"==e.type&&(t.system.QL=e.qs)):ui.notifications.warn(game.i18n.format("DSAError.notFound",{category:e.type,name:e.name}))}await this.actor.createEmbeddedDocuments("Item",a)}else ui.notifications.error(game.i18n.format("DSAError.notFound",{category:thing.type,name:thing.name}))}async _handleApplication(e){e=duplicate(e),this.actor.items.find((t=>t.type==e.type&&t.name==e.name))||await this.actor.createEmbeddedDocuments("Item",[e])}async _handleRemoveSourceOnDrop(e){let t=e.parent;t&&t.isOwner&&await t.deleteEmbeddedDocuments("Item",[e._id])}async _onDropItemCreate(e){return e instanceof Array?this.actor.createEmbeddedDocuments("Item",e):await this._manageDragItems(e,e.type)}async _onDropActor(e,t){if(!this.actor.isOwner)return!1;const{item:a,typeClass:s,selfTarget:i}=await(0,l.x8)(t,this.id,!1);return i?void 0:await this._manageDragItems(a,s)}async _onDropActiveEffect(e,t){const a=await ActiveEffect.implementation.fromDropData(t);if(!this.actor.isOwner||!a)return!1;if(this.actor.uuid===a.parent?.uuid)return!1;const s=a.toObject();return s.origin=this.actor.uuid,ActiveEffect.create(s,{parent:this.actor})}async _onDropItem(e,a){if(!this.actor.isOwner)return!1;const s=await Item.implementation.fromDropData(a),i=s.toObject();let n;d.Z.obfuscateDropData(i,a.tabsinvisible);let r=$(e.target).parents(".item");r&&"bags"==r.attr("data-category")&&t.Z.equipmentCategories.includes(s.type)&&r.attr("data-item-id")!=s.id&&(n=r.attr("data-item-id"));const o=this.actor.uuid===s.parent?.uuid;if(o)if(e.ctrlKey)await this.handleItemCopy(i,s.type);else if(n){const e={_id:s.id,"system.parent_id":n};s.system.worn&&s.system.worn.value&&(e["system.worn.value"]=!1),await this.actor.updateEmbeddedDocuments("Item",[e])}else t.Z.equipmentCategories.includes(s.type)&&await this.actor.updateEmbeddedDocuments("Item",[{_id:s.id,system:{parent_id:0}}]);else await this._onDropItemCreate(i);e.altKey&&!o&&t.Z.equipmentCategories.includes(s.type)&&await this._handleRemoveSourceOnDrop(s)}}class TraditionArtifactpicker extends Application{constructor(e,t={}){super(t),this.actor=e}get template(){return"systems/dsa5/templates/actors/traditionPicker.html"}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:440,resizable:!0}),e}async getData(e){const t=await super.getData(e),a=this.actor.items.filter((e=>["equipment","armor","rangeweapon","meleeweapon"].includes(e.type)));return mergeObject(t,{items:a}),t}activateListeners(e){super.activateListeners(e),e.find(".slot").click((async e=>{const t=this.actor.items.get(e.currentTarget.dataset.itemId);await t.update({"system.isArtifact":!t.system.isArtifact})}))}}var p=__webpack_require__(794);class WizardDSA5 extends Application{constructor(e){super(e),this.actor=null,this.errors=[],this.attributes=[],this.updating=!1}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","generationWizard"]),width:770,height:740}),e.resizable=!0,e}async findCompendiumItem(e,t){for(let a of t){let t=await game.dsa5.itemLibrary.findCompendiumItem(e,a);if(t=t.find((t=>t.name==e&&t.type==a&&t.system)),t)return t}}async parseToItem(a,s){return""==a.trim()?[]:await Promise.all(a.split(", ").map((async a=>{let i=e.Z.parseAbilityString(a.trim()),n=await this.findCompendiumItem(i.original,s);if(n||(n=await this.findCompendiumItem(i.name,s)),n){const e=n.uuid;n=duplicate(n),n.uuid=e,n.tooltip=game.i18n.localize("Details"),n=p.Z.reverseAdoptionCalculation(this.actor,i,n),n.system.APValue&&(n.APunparseable=isNaN(n.system.APValue.value),n.apCost=n.APunparseable?n.system.APValue.value:i.step*Number(n.system.APValue.value))}else if(this.attributes.includes(i.name)){let e=0;for(let a=this.actor.system.characteristics[game.dsa5.config.knownShortcuts[i.name.toLowerCase()][1]].value+1;a<i.step+1;a++)e+=t.Z.advancementCosts.E[a];n={name:i.name,step:i.step,attributeRequirement:!0,system:{APValue:{value:e}}}}else{console.warn(`Not found <${a}>`);const t=s.map((t=>e.Z.categoryLocalization(t))).join("/");this.errors.push(`${t}: ${a}`),n={name:a.trim(),notFound:!0,tooltip:game.i18n.localize("DSAError.itemNotFound"),apCost:"?"}}n.replaceName=i.original,n.step=i.step;let r=null!=this.actor.items.find((e=>s.includes(e.type)&&e.name==i.original));return n.disabled=r||n.notFound||n.APunparseable,r&&(n.tooltip=game.i18n.localize("YouAlreadyHaveit")),n})))}mergeLevels(e,t){let a=!1,s=e.find((e=>e.name==t.name&&e.type==t.type));if(s){a=!0;let e=Number(getProperty(t,"system.step.value"));e&&(s.system.step.value+=e)}else e.push(t);return a}async addSelections(t,s=!0){let n=[];for(let s of t){if(""==$(s).val())continue;let t=(await fromUuid($(s).val())).toObject(),r=e.Z.parseAbilityString(t.name);switch(t.name=$(s).attr("name"),t.type){case"advantage":case"disadvantage":t.system.step.value=Number(s.dataset.step),t=p.Z.reverseAdoptionCalculation(this.actor,r,t),this.mergeLevels(n,t)||a.Z.vantageAdded(this.actor,t);break;case"specialability":t.system.step.value=Number(s.dataset.step),"true"==s.dataset.free&&(t.system.APValue.value=0),t=p.Z.reverseAdoptionCalculation(this.actor,r,t),this.mergeLevels(n,t)||i.Z.abilityAdded(this.actor,t);break;case"magictrick":this.mergeLevels(n,t)}}await this.actor.createEmbeddedDocuments("Item",n,{render:s})}async fixPreviousCosts(e,t){for(let a of t){const t=e.find((e=>e.type==a.type&&e.name==a.name));t&&(a.apCost-=t.apCost)}}async alreadyAdded(t,a){if(""==t)return!1;let s=!1;return s=await new Promise(((t,s)=>{new Dialog({title:game.i18n.localize("DIALOG.warning"),content:game.i18n.format("DIALOG.alreadyAddedCharacterpart",{category:e.Z.categoryLocalization(a)}),default:"ok",buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Ok"),default:!0,callback:()=>{t(!1)}},cancel:{icon:'<i class="fas fa-close"></i>',label:game.i18n.localize("Cancel"),default:!0,callback:()=>{t(!0)}}}}).render(!0)})),s}async updateSkill(t,a,s=1,i=!0){let n=[];for(let r of t){let t=e.Z.parseAbilityString(r.trim()),o=this.actor.items.find((e=>e.type==a&&e.name==t.name));o?n.push({_id:o.id,"system.talentValue.value":Math.max(0,s*t.step+(i?Number(o.system.talentValue.value):0))}):(console.warn(`Could not find ${a} ${r}`),this.errors.push(`${e.Z.categoryLocalization(a)}: ${r}`))}await this.actor.updateEmbeddedDocuments("Item",n,{render:!1})}async getData(e){const t=await super.getData(e);return await game.dsa5.itemLibrary.buildEquipmentIndex(),t}_validateInput(e,t=this){let a=new Set,s=/^exclusive_/;for(let t of e.find(".exclusive"))a.add(t.className.split(/\s+/).filter((e=>s.test(e)))[0]);for(let s of a){let a=e.find(".allowedCount_"+s.split("_")[1]),i=Number(a.attr("data-count"));if(e.find(`.${s}:checked`).length!=i)return this._showInputValidation(a,e,t),!1}return!0}_showInputValidation(e,t,a){ui.notifications.error(game.i18n.localize("DSAError.MissingChoices"));let s=e.closest(".tab").attr("data-tab");a.activateTab(s),WizardDSA5.flashElem(t.find(`.tabs a[data-tab='${s}']`)),WizardDSA5.flashElem(e.closest("div"))}activateListeners(e){super.activateListeners(e),(0,l.Ee)(e),e.find("button.ok").click((()=>{this.updating||(this.updating=!0,this.updateCharacter($(this._element)).then((()=>this.updating=!1)))})),e.find("button.cancel").click((()=>{this.close()})),e.find(".show-item").click((async e=>{let t=e.currentTarget.dataset.uuid;(await fromUuid(t)).sheet.render(!0)})),e.on("click",".searchableAbility a",(e=>(0,l.$8)(e))),e.find(".exclusive").change((e=>{let t=$(e.currentTarget).closest(".content"),a=$(e.currentTarget).attr("data-sel"),s=t.find(`.allowedCount_${a}`),i=Number(s.attr("data-count"));if(t.find(`.exclusive_${a}:checked`).length>i)return e.currentTarget.checked=!1,void WizardDSA5.flashElem(s)}))}static flashElem(e,t="emphasize"){e.addClass(t),setTimeout((function(){e.removeClass(t)}),600)}finalizeUpdate(){0==this.errors.length?this.close():$(this._element).find(".dialog-buttons").html(`<div class="error"><p>${game.i18n.localize("DSAError.notUnderstood")}</p><ul><li>${this.errors.join("</li><li>")}</li></ul></div>`)}}class CultureWizard extends WizardDSA5{static get defaultOptions(){const e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")}`}),e.template="systems/dsa5/templates/wizard/add-culture-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change((e=>{let t=$(e.currentTarget).closest(".content"),a=Number(t.attr("data-cost"));t.find(".optional:checked").each((function(){a+=Number($(this).attr("data-cost"))}));let s=t.find(".apCost");s.text(a),WizardDSA5.flashElem(s,"emphasize2")}))}async getData(e){const t=await super.getData(e);let a=await this.parseToItem(this.culture.system.recommendedAdvantages.value,["advantage"]),s=await this.parseToItem(this.culture.system.recommendedDisadvantages.value,["disadvantage"]),i=""==this.culture.system.writing.value?[]:await this.parseToItem(this.culture.system.writing.value.split(",").map((e=>`${game.i18n.localize("LocalizedIDs.literacy")} (${e.trim()})`)).join(", "),["specialability"]),n=""==this.culture.system.language.value?[]:await this.parseToItem(this.culture.system.language.value.split(",").map((e=>`${game.i18n.localize("LocalizedIDs.language")} (${e.trim()}) 3`)).join(", "),["specialability"]),r=Number(this.culture.system.APValue.value);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.culture")} ${this.culture.name}`}),culture:this.culture,description:game.i18n.format("WIZARD.culturedescr",{culture:this.culture.name,cost:r}),advantages:a,disadvantages:s,writings:i,languages:n,advantagesToChose:a.length>0,disadvantagesToChose:s.length>0,writingsToChose:i.length>0,languagesToChose:n.length>0,languagesToSelect:n.length>1,vantagesToChose:a.length>0||s.length>0,generalToChose:i.length>0||n.length>0,enrichedClothing:await TextEditor.enrichHTML(getProperty(this.culture.system,"clothing.value"),{secrets:!1,async:!0}),enrichedDescription:await TextEditor.enrichHTML(getProperty(this.culture.system,"description.value"),{secrets:!1,async:!0})}),t}async addCulture(e,t){this.actor=e,this.culture=duplicate(t)}_validateInput(e,t=this){const a=e.find(".localKnowledge");if(""==a.val())return this._showInputValidation(a,e,t),!1;const s=e.find(".selectOnlyOne");if(s.length){if(1!=s.find(".optional:checked").length)return this._showInputValidation(s,e,t),!1}return super._validateInput(e,t)}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.culture.value,"culture"))return void e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let s={"system.details.culture.value":this.culture.name},i=await this.findCompendiumItem(`${game.i18n.localize("LocalizedIDs.localKnowledge")} ()`,["specialability"]);i&&(i=duplicate(i),i.name=`${game.i18n.localize("LocalizedIDs.localKnowledge")} (${e.find(".localKnowledge").val()})`,i.system.APValue.value=0,await this.actor.createEmbeddedDocuments("Item",[i],{render:!1})),await this.addSelections(e.find(".optional:checked"),!1),await this.actor._updateAPs(a,{},{render:!1}),await this.updateSkill(this.culture.system.skills.value.split(","),"skill"),await this.actor.update(s),this.finalizeUpdate()}}class CareerWizard extends WizardDSA5{constructor(e){super(e),this.attributes=Object.keys(t.Z.characteristics).map((e=>game.i18n.localize(`CHARAbbrev.${e.toUpperCase()}`)))}static get defaultOptions(){const e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.career")}`}),e.template="systems/dsa5/templates/wizard/add-career-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change((e=>{let t=$(e.currentTarget).closest(".content");if($(e.currentTarget).hasClass("exclusiveTricks")){let a=Number(t.find(".maxTricks").attr("data-spelltricklimit"));if(t.find(".exclusiveTricks:checked").length>a)return e.currentTarget.checked=!1,void WizardDSA5.flashElem(t.find(".maxTricks"))}let a=Number(t.attr("data-cost"));t.find(".optional:checked").each((function(){a+=Number($(this).attr("data-cost"))})),t.find(".attributes:checked").each((function(){a+=Number($(this).attr("data-cost"))}));let s=t.find(".apCost");s.text(a),WizardDSA5.flashElem(s,"emphasize2")}))}_validateInput(e,t=this){let a=e.find(".maxTricks"),s=Number(a.attr("data-spelltricklimit"))||0;return e.find(".exclusiveTricks:checked").length!=s?(this._showInputValidation(a,e,t),!1):super._validateInput(e,t)}async getData(e){const t=await super.getData(e),a=await this.parseToItem(this.career.system.requirements.value,["disadvantage","advantage","specialability"]),s=a.filter((e=>["advantage","disadvantage"].includes(e.type)&&!e.disabled)),i=await this.parseToItem(this.career.system.recommendedAdvantages.value,["advantage"]);this.fixPreviousCosts(a,i);const n=await this.parseToItem(this.career.system.recommendedDisadvantages.value,["disadvantage"]);this.fixPreviousCosts(a,n);const r=a.filter((e=>e.attributeRequirement)),o=this.parseCombatskills(this.career.system.combatSkills.value),l=Number(this.career.system.APValue.value),c=a.reduce((function(e,t){return e+(t.disabled?0:Number(t.system.APValue.value)||0)}),0),d=a.filter((e=>"specialability"==e.type&&!e.disabled));return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("career")} ${this.career.name}`}),career:this.career,description:game.i18n.format("WIZARD.careerdescr",{career:this.career.name,cost:l+c}),baseCost:l,advantages:i,disadvantages:n,missingVantages:s,missingSpecialabilities:d,combatskillchoices:o,spelltricks:await this.parseToItem(this.career.system.spelltricks.value,["magictrick"]),attributeRequirements:r,advantagesToChose:i.length>0,disadvantagesToChose:n.length>0,vantagesToChose:i.length>0||n.length>0||s.length>0,missingVantagesToChose:s.length>0,missingSpecialabiltiesToChose:d.length>0,combatToChose:o.length>0,magicToChose:this.career.system.spelltrickCount.value>0,religionToChose:!1,anyAttributeRequirements:r.length>0,generalToChose:d.length>0||r.length>0,enrichedClothing:await TextEditor.enrichHTML(getProperty(this.career.system,"clothing.value"),{secrets:!1,async:!0}),enrichedDescription:await TextEditor.enrichHTML(getProperty(this.career.system,"description.value"),{secrets:!1,async:!0})}),t}async addCareer(e,t){this.actor=e,this.career=duplicate(t)}parseCombatskills(e){let t=[];for(let a of e.split(/,|;/))if(a.includes(game.i18n.localize("combatskillcountdivider")+":")){let e=a.split(":");t.push({choices:e[1].split("/").map((e=>e.trim())),allowedCount:Number(e[0].match(/\d/g))})}return t}async setAbility(t,a){if(""==t.trim())return;let s=[],i=[];for(let n of t.split(",")){let t=e.Z.parseAbilityString(n.trim()),r=this.actor.items.find((e=>a.includes(e.type)&&e.name==t.original));if(r)r=duplicate(r),r.system.talentValue&&(r.system.talentValue.value=t.step),r.system.step&&(r.system.step.value=t.step),r=p.Z.reverseAdoptionCalculation(this.actor,t,r),i.push(r);else if(r=await this.findCompendiumItem(t.original,a),r||(r=await this.findCompendiumItem(t.name,a)),r)r=duplicate(r),r.name=t.original,r.system.talentValue&&(r.system.talentValue.value=t.step),r.system.step&&(r.system.step.value=t.step),r=p.Z.reverseAdoptionCalculation(this.actor,t,r),s.push(r);else{const t=a.map((t=>e.Z.categoryLocalization(t))).join("/");this.errors.push(`${t}: ${n}`),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:t,name:n}))}}await this.actor.updateEmbeddedDocuments("Item",i,{render:!1}),await this.actor.createEmbeddedDocuments("Item",s,{render:!1})}async addBlessing(t,a){let s=[];for(let i of t){let t=i.trim();if(""==t)continue;let n=this.actor.items.find((e=>a==e.type&&e.name==t));n||(n=await this.findCompendiumItem(t,[a]),n?(n=duplicate(n),s.push(n)):(this.errors.push(`${e.Z.categoryLocalization(a)}: ${i}`),ui.notifications.error(game.i18n.format("DSAError.notFound",{category:game.i18n.localize(a),name:t}))))}await this.actor.createEmbeddedDocuments("Item",s,{render:!1})}async updateCharacter(e,t=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let a=Number(e.find(".apCost").text());if(!this._validateInput(e,t)||!await this.actor.checkEnoughXP(a)||await this.alreadyAdded(this.actor.system.details.career.value,"career"))return void e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let s={"system.details.career.value":this.career.name,"system.freeLanguagePoints.value":this.career.system.languagePoints.value};for(let t of e.find(".attributes")){let e=$(t).attr("data-attribute").toLowerCase();e=game.dsa5.config.knownShortcuts[e.toLowerCase()][1],Number(this.actor.system.characteristics[e].initial)+Number(this.actor.system.characteristics[e].advances)<Number($(t).val())&&(this.actor.canAdvance?s[`system.characteristics.${e}.advances`]=Number($(t).val())-Number(this.actor.system.characteristics[e].initial):s[`system.characteristics.${e}.initial`]=Number($(t).val()))}"mundane"!=this.career.system.mageLevel.value&&(s[`system.guidevalue.${this.career.system.mageLevel.value}`]=this.career.system.guidevalue.value,s[`system.energyfactor.${this.career.system.mageLevel.value}`]=this.career.system.guidevalue.factor,s[`system.tradition.${this.career.system.mageLevel.value}`]=this.career.system.tradition.value,s[`system.feature.${this.career.system.mageLevel.value}`]=this.career.system.feature.value),"clerical"==this.career.system.mageLevel.value&&(s["system.happyTalents.value"]=this.career.system.happyTalents.value,await this.setAbility(this.career.system.liturgies.value,["liturgy","ceremony"]),await this.addBlessing(this.career.system.blessings.value.split(","),"blessing")),"magical"==this.career.system.mageLevel.value&&await this.setAbility(this.career.system.spells.value,["spell","ritual"]),await this.setAbility(this.career.system.specialAbilities.value,["specialability"]),await this.actor._updateAPs(a,{},{render:!1}),await this.addSelections(e.find(".optional:checked"),!1),await this.updateSkill(this.career.system.skills.value.split(","),"skill");let i=[];for(let t of e.find(".exclusive:checked"))i.push($(t).val());const n=this.career.system.combatSkills.value.split(",").concat(i).filter((e=>!(e.includes(game.i18n.localize("combatskillcountdivider")+":")||""==e)));await this.updateSkill(n,"combatskill",1,!1),await this.actor.update(s),this.finalizeUpdate()}}class SpeciesWizard extends WizardDSA5{static get defaultOptions(){const e=super.defaultOptions;return e.title=game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("TYPES.Item.species")}`}),e.template="systems/dsa5/templates/wizard/add-species-wizard.html",e}activateListeners(e){super.activateListeners(e),e.find(".optional").change((e=>{let t=$(e.currentTarget).closest(".content"),a=Number(t.attr("data-cost"));t.find(".optional:checked").each((function(){a+=Number($(this).attr("data-cost"))}));let s=t.find(".apCost");s.text(a),WizardDSA5.flashElem(s,"emphasize2")}))}async _toGroups(e,t,a){return await Promise.all(e.split("\n").map((async e=>{let s,i=e.split(":");return s=i.length>1?{name:i[0].trim(),res:await this.parseToItem(i[1].trim(),t)}:{name:"",res:await this.parseToItem(e,t)},this.fixPreviousCosts(a,s.res),s})))}_parseAttributes(e){let t=[];for(let a of e.split(","))if(a.includes(game.i18n.localize("combatskillcountdivider")+":")){let e=a.split(":");t.push({choices:e[1].split("/").map((e=>e.trim())),allowedCount:Number(e[0].match(/\d/g))})}return t}async getData(e){const t=await super.getData(e),a=await this.parseToItem(this.species.system.requirements.value,["disadvantage","advantage"]),s=a.filter((e=>["advantage","disadvantage"].includes(e.type)&&!e.disabled)),i=await this._toGroups(this.species.system.recommendedAdvantages.value,["advantage"],a),n=await this._toGroups(this.species.system.recommendedDisadvantages.value,["disadvantage"],a),r=this._parseAttributes(this.species.system.attributeChange.value),o=Number(this.species.system.APValue.value),l=a.reduce((function(e,t){return e+(t.disabled?0:Number(t.system.APValue.value)||0)}),0);return mergeObject(t,{title:game.i18n.format("WIZARD.addItem",{item:`${game.i18n.localize("species")} ${this.species.name}`}),species:this.species,description:game.i18n.format("WIZARD.speciesdescr",{species:this.species.name,cost:o+l}),advantagegroups:i,baseCost:o,disadvantagegroups:n,missingVantages:s,attributeRequirements:r,hasLocalization:game.i18n.has(`Racedescr.${this.species.name}`),anyAttributeRequirements:r.length>0,advantagesToChose:i.length>0,missingVantagesToChose:s.length>0,disadvantagesToChose:n.length>0,vantagesToChose:i.length>0||n.length>0||s.length>0,generalToChose:r.length>0}),t}async addSpecies(e,t){this.actor=e,this.species=duplicate(t)}async updateCharacter(e,a=this){e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let s=Number(e.find(".apCost").text());if(!this._validateInput(e,a)||!await this.actor.checkEnoughXP(s)||await this.alreadyAdded(this.actor.system.details.species.value,"species"))return void e.find("button.ok i").toggleClass("fa-check fa-spinner fa-spin");let i={"system.details.species.value":this.species.name,"system.status.speed.initial":this.species.system.baseValues.speed.value,"system.status.soulpower.initial":this.species.system.baseValues.soulpower.value,"system.status.toughness.initial":this.species.system.baseValues.toughness.value,"system.status.wounds.initial":this.species.system.baseValues.wounds.value,"system.status.wounds.value":this.species.system.baseValues.wounds.value+2*this.actor.system.characteristics.ko.value},n=[];for(let t of e.find(".exclusive:checked"))n.push($(t).val());Object.keys(t.Z.characteristics).forEach((e=>{i[`system.characteristics.${e}.species`]=0}));for(let e of this.species.system.attributeChange.value.split(",").concat(n)){if(e.includes(game.i18n.localize("combatskillcountdivider")+":")||""==e)continue;let t=e.trim().split(" "),a=game.dsa5.config.knownShortcuts[t[0].toLowerCase().trim()].slice(0);a[a.length-1]="species",i[`system.${a.join(".")}`]=Number(t[1])}await this.actor._updateAPs(s,{},{render:!1}),await this.addSelections(e.find(".optional:checked"),!1),await this.actor.update(i),await this.actor.removeCondition("incapacitated"),this.finalizeUpdate()}}class ActorSheetdsa5Character extends ActorSheetDsa5{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","character-sheet"]),width:784}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/actor-sheet.html"}async _manageDragItems(e,t){switch(t){case"aggregatedTest":await this.actor.createEmbeddedDocuments("Item",[e]);break;case"species":let a=new SpeciesWizard;await a.addSpecies(this.actor,e),a.render(!0);break;case"culture":let s=new CultureWizard;await s.addCulture(this.actor,e),s.render(!0);break;case"career":let i=new CareerWizard;await i.addCareer(this.actor,e),i.render(!0);break;default:return super._manageDragItems(e,t)}}}var h=__webpack_require__(101);class ActorSheetdsa5Creature extends ActorSheetDsa5{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","creature-sheet"])}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/creature-limited.html":"systems/dsa5/templates/actors/creature-sheet.html"}async getData(e){const t=await super.getData(e);return t.enrichedDescription=await TextEditor.enrichHTML(getProperty(this.actor.system,"description.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedBehaviour=await TextEditor.enrichHTML(getProperty(this.actor.system,"behaviour.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedFlight=await TextEditor.enrichHTML(getProperty(this.actor.system,"flight.value"),{secrets:this.object.isOwner,async:!0}),t.enrichedSpecialrules=await TextEditor.enrichHTML(getProperty(this.actor.system,"specialRules.value"),{secrets:this.object.isOwner,async:!0}),t}async _cleverDeleteItem(e){let t=this.actor.items.find((t=>t.id==e));if("trait"===t.type)await this._updateAPs(-1*t.system.APValue.value,{},{render:!1});await super._cleverDeleteItem(e)}async _addTrait(e){this.actor.items.find((t=>"trait"==t.type&&t.name==e.name))||(await this._updateAPs(e.system.APValue.value,{},{render:!1}),await h.Z.traitAdded(this.actor,e),await this.actor.createEmbeddedDocuments("Item",[e]))}async _onDropItemCreate(e){return"trait"==e.type?this._addTrait(e):super._onDropItemCreate(e)}}class ActorSheetdsa5NPC extends ActorSheetdsa5Character{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","actor","npc-sheet"])}),e}get template(){return this.showLimited()?"systems/dsa5/templates/actors/npc-limited.html":"systems/dsa5/templates/actors/npc-sheet.html"}}var f=__webpack_require__(702),y=__webpack_require__(562);const ItemSheetObfuscation=e=>class extends e{async obfuscateItem(e){e.stopPropagation(),e.preventDefault();const t=e.currentTarget.dataset.obfuscate;await this.item.update({[`system.obfuscation.${t}`]:!this.isObfuscated(t)})}isObfuscated(e){return getProperty(this.item,`system.obfuscation.${e}`)}activateListeners(e){super.activateListeners(e),e.on("click",".obfuscateSection",(e=>this.obfuscateItem(e)))}obfuscationCss(e){return this.isObfuscated(e)?"":" pale"}async _render(e=!1,t={}){await super._render(e,t);const a=["details","effects","description","enchantment"];let s=!1;for(let e of a){const a=$(this._element).find(`nav [data-tab="${e}"]`);if(!a.length)continue;const i=t.tabsinvisible||this.isObfuscated(e),n=game.i18n.localize("SHEET."+(i?"deobfuscateItem":"obfuscateItem"));if(game.user.isGM){const t=`obfuscateSection${this.obfuscationCss(e)}`,s=a.find(`.${t}`),i=`<a data-tooltip="${n}" class="obfuscationBtn ${t}" data-obfuscate="${e}"><i class="fas fa-mask"></i></a>`;s.length?s.replaceWith(i):a.append(` ${i}`)}else i&&(a.hasClass("active")&&(s=!0),a.remove(),"details"==e&&$(this._element).find('[name="system.price.value"],[name="system.price.raw"]').replaceWith("<label>?</label>"))}if(s){const e=$(this._element).find("nav .item:first-child");if(e.length)this.activateTab(e.attr("data-tab"));else{const e=await renderTemplate("systems/dsa5/templates/items/obfuscatedItem.html",{item:this.item});$(this._element).find(".content").html(e)}}}};var b=__webpack_require__(600);class ItemSheetdsa5 extends ItemSheet{_getSubmitData(e={}){const t=super._getSubmitData(e),a=foundry.utils.flattenObject(this.item.overrides||{});return Object.keys(a).forEach((e=>delete t[e])),t}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{tabs:[{navSelector:".tabs",contentSelector:".content"}],classes:e.classes.concat(["dsa5","item"]),width:471,height:500}),e}static setupSheets(){Items.unregisterSheet("core",ItemSheet),Items.registerSheet("dsa5",ItemSheetdsa5,{makeDefault:!0}),Items.registerSheet("dsa5",ItemSpeciesDSA5,{makeDefault:!0,types:["species"]}),Items.registerSheet("dsa5",ItemCareerDSA5,{makeDefault:!0,types:["career"]}),Items.registerSheet("dsa5",ItemCultureDSA5,{makeDefault:!0,types:["culture"]}),Items.registerSheet("dsa5",VantageSheetDSA5,{makeDefault:!0,types:["advantage","disadvantage"]}),Items.registerSheet("dsa5",SpellSheetDSA5,{makeDefault:!0,types:["ritual","ceremony","liturgy","spell"]}),Items.registerSheet("dsa5",SpecialAbilitySheetDSA5,{makeDefault:!0,types:["specialability"]}),Items.registerSheet("dsa5",MeleeweaponSheetDSA5,{makeDefault:!0,types:["meleeweapon"]}),Items.registerSheet("dsa5",PoisonSheetDSA5,{makeDefault:!0,types:["poison"]}),Items.registerSheet("dsa5",DiseaseSheetDSA5,{makeDefault:!0,types:["disease"]}),Items.registerSheet("dsa5",ConsumableSheetDSA5,{makeDefault:!0,types:["consumable"]}),Items.registerSheet("dsa5",SpellExtensionSheetDSA5,{makeDefault:!0,types:["spellextension"]}),Items.registerSheet("dsa5",MagictrickSheetDSA5,{makeDefault:!0,types:["magictrick"]}),Items.registerSheet("dsa5",BlessingSheetDSA5,{makeDefault:!0,types:["blessing"]}),Items.registerSheet("dsa5",RangeweaponSheet,{makeDefault:!0,types:["rangeweapon"]}),Items.registerSheet("dsa5",EquipmentSheet,{makeDefault:!0,types:["equipment"]}),Items.registerSheet("dsa5",ArmorSheet,{makeDefault:!0,types:["armor"]}),Items.registerSheet("dsa5",AmmunitionSheet,{makeDefault:!0,types:["ammunition"]}),Items.registerSheet("dsa5",PlantSheet,{makeDefault:!0,types:["plant"]}),Items.registerSheet("dsa5",MagicalSignSheet,{makeDefault:!0,types:["magicalsign"]}),Items.registerSheet("dsa5",PatronSheet,{makeDefault:!0,types:["patron"]}),Items.registerSheet("dsa5",InformationSheet,{makeDefault:!0,types:["information"]}),Items.registerSheet("dsa5",AggregatedTestSheet,{makeDefault:!0,types:["aggregatedTest"]}),Items.unregisterSheet("dsa5",ItemSheetdsa5,{types:["armor","equipment","rangeweapon","blessing","magictrick","spellextension","consumable","aggregatedTest","species","career","culture","advantage","specialability","disadvantage","ritual","information","ceremony","liturgy","spell","disease","poison","meleeweapon","ammunition","plant","magicalsign","patron"]})}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".close").attr("data-tooltip","SHEET.Close"),$(this._element).find(".configure-sheet").attr("data-tooltip","SHEET.Configure"),$(this._element).find(".import").attr("data-tooltip","SHEET.Import"),$(this._element).find(".rolleffect").attr("data-tooltip","SHEET.RollEffect"),$(this._element).find(".showItemHead").attr("data-tooltip","SHEET.PostItem"),$(this._element).find(".consumeItem").attr("data-tooltip","SHEET.ConsumeItem"),$(this._element).find(".rollDamaged").attr("data-tooltip","DSASETTINGS.armorAndWeaponDamage"),$(this._element).find(".onUseEffect").attr("data-tooltip","SHEET.onUseEffect")}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"showItemHead",icon:"fas fa-comment",onclick:async()=>this.item.postItem()}),this.item.actor&&m.Z.getOnUseEffect(this.item)&&e.unshift({class:"onUseEffect",icon:"fas fa-dice-six",onclick:async()=>{new m.Z(this.item).executeOnUseEffect()}}),e}setupEffect(e){this.item.setupEffect().then((e=>this.item.itemTest(e)))}get template(){return`systems/dsa5/templates/items/item-${this.item.type}-sheet.html`}_getItemId(e){return $(e.currentTarget).parents(".item").attr("data-item-id")}_advanceStep(){}_refundStep(){}async advanceWrapper(e,t){let a=$(e.currentTarget).find("i");a.hasClass("fa-spin")||(a.addClass("fa-spin fa-spinner"),await this[t](),a.removeClass("fa-spin fa-spinner"))}activateListeners(t){super.activateListeners(t),(0,l.Ee)(t),t.find(".advance-step").mousedown((e=>this.advanceWrapper(e,"_advanceStep"))),t.find(".refund-step").mousedown((e=>this.advanceWrapper(e,"_refundStep"))),t.find(".domainsPretty").click((e=>{$(e.currentTarget).hide(),$(e.currentTarget).next(".domainToggle").show()})),t.find('[data-edit="img"]').mousedown((t=>{2==t.button&&e.Z.showArtwork(this.item)})),t.find(".status-add").click((()=>{r.Z.createCustomEffect(this.item,"",this.item.name)})),t.find(".condition-show").mousedown((e=>{e.preventDefault();const t=e.currentTarget.dataset.id;if(0==e.button){this.item.effects.get(t).sheet.render(!0)}else 2==e.button&&this.item.deleteEmbeddedDocuments("ActiveEffect",[t])})),t.find(".select2").select2(),t.find(".condition-toggle").mousedown((e=>{let t=$(e.currentTarget).parents(".statusEffect").attr("data-id"),a=this.item.effects.get(t);a.update({disabled:!a.disabled})})),t.find(".condition-edit").click((e=>{this.item.effects.get(e.currentTarget.dataset.id).sheet.render(!0)})),u.Z.bindRollCommands(t),r.Z.bindButtons(t);let a=t.find(".item-header");if(a.length){let e=a.find("svg");if(e){new ResizeObserver((function(t){let a=t[0];(0,l.zJ)(e,a.contentRect.width)})).observe(a.get(0));let t=a.find("input");t.get(0).disabled||(e.click((()=>{e.hide(),t.show(),t.focus()})),t.blur((function(){e.show(),t.hide()})))}}}async getData(a){let s=super.getData(a).data;switch(this.item.type){case"skill":s.characteristics=t.Z.characteristics,s.skillGroups=t.Z.skillGroups,s.skillBurdens=t.Z.skillBurdens,s.hasLocalization=game.i18n.has(`SKILLdescr.${this.item.name}`),s.StFs=t.Z.StFs;break;case"application":s.hasLocalization=game.i18n.has(`APPLICATION.${this.item.system.skill} - ${this.item.name}`),s.localization=game.i18n.localize(`APPLICATION.${this.item.system.skill} - ${this.item.name}`),s.allSkills=await e.Z.allSkillsList();break;case"combatskill":s.weapontypes=t.Z.weapontypes,s.guidevalues=t.Z.combatskillsGuidevalues,s.hasLocalization=game.i18n.has(`Combatskilldescr.${this.item.name}`),s.StFs=t.Z.StFs;break;case"trait":s.traitCategories=t.Z.traitCategories,s.ranges=t.Z.meleeRanges}if(s.isOwned=this.item.actor,s.editable=this.isEditable,s.isOwned){s.canAdvance=this.item.actor.canAdvance&&this._advancable();const e=getProperty(this.item,"flags.dsa5.customPriceTag");!this.isEditable&&e&&(s.customPrice=e)}return r.Z.prepareActiveEffects(this.item,s),s.item=this.item,s.armorAndWeaponDamage=game.settings.get("dsa5","armorAndWeaponDamage"),s.isGM=game.user.isGM,s.enrichedDescription=await TextEditor.enrichHTML(getProperty(this.item.system,"description.value"),{secrets:this.object.isOwner,async:!0}),s.enrichedGmdescription=await TextEditor.enrichHTML(getProperty(this.item.system,"gmdescription.value"),{secrets:this.object.isOwner,async:!0}),s}_advancable(){return!1}}class AggregatedTestSheet extends ItemSheetdsa5{async getData(t){const a=await super.getData(t),s=this.item.getFlag("dsa5","embeddedItem");let i;return s&&(i=await renderTemplate(`systems/dsa5/templates/items/browse/${s.type}.html`,{document:s})),mergeObject(a,{allSkills:await e.Z.allSkillsList(),embeddedItem:s,renderedItem:i}),a}activateListeners(e){super.activateListeners(e),e.find(".buildItem").click((async()=>this.postFinishedItem()))}async postFinishedItem(){if(!this.item.actor)return;const t=this.item.getFlag("dsa5","embeddedItem");if(!t)return;const a=await renderTemplate("systems/dsa5/templates/chat/production-result.html",{actor:this.item.actor,item:t,actorImg:b.Z.videoOrImgTag(this.item.actor.img)}),s=e.Z.chatDataSetup(a);s.flags={dsa5:{embeddedItem:t}},await ChatMessage.create(s)}}class Enchantable extends ItemSheetdsa5{async _onDrop(e){await this.enchant(e),this.isPoisonable&&await this.poison(e)}async enchant(e){const t=JSON.parse(e.dataTransfer.getData("text/plain"));await this._enchant([t])}async _enchant(e){const t=this.item.getFlag("dsa5","enchantments")||[];if(t.length+e.length>7)return ui.notifications.error(game.i18n.localize("DSAError.tooManyEnchants"));for(let a of e){const{item:e,typeClass:s,selfTarget:i}=await(0,l.x8)(a,void 0,!1);if(["spell","liturgy","ceremony","ritual"].includes(s)){if(!e.pack)return ui.notifications.error(game.i18n.localize("DSAError.onlyCompendiumSpells"));const i={name:e.name,pack:e.pack,id:t.length,itemId:e.id,permanent:["liturgy","ceremony"].includes(s)||a.permanent,actorId:a.actorId,charged:!0,talisman:["liturgy","ceremony"].includes(s),fw:["liturgy","ceremony"].includes(s)?18:a.fw||0};t.push(i)}}if(t.length){const e={flags:{dsa5:{enchantments:t}}};await this.item.update(e)}}async poison(e){const t=JSON.parse(e.dataTransfer.getData("text/plain")),{item:a,typeClass:s,selfTarget:i}=await(0,l.x8)(t,void 0,!1);if("poison"==s){let e={flags:{dsa5:{poison:{name:a.name,pack:a.pack,itemId:a._id,permanent:!1,actorId:t.actorId}}}};await this.item.update(e)}}toggleChargedState(e,t){for(let a of t)if(a.id==e){a.charged=!(!a.talisman||!a.permanent)||!a.charged;break}this.item.update({flags:{dsa5:{enchantments:t}}})}activateListeners(t){super.activateListeners(t),t.find(".ench-toggle-permanent").click((e=>{let{id:t,enchantments:a}=this.enchantMentId(e);for(let e of a)if(e.id==t){e.permanent=!e.permanent;break}this.item.update({flags:{dsa5:{enchantments:a}}})})),t.find(".ench-toggle-charge").click((e=>{let{id:t,enchantments:a}=this.enchantMentId(e);this.toggleChargedState(t,a)})),t.find(".ench-roll").click((async t=>{let{id:a,enchantments:s}=this.enchantMentId(t),i=s.find((e=>e.id==a));if(!i.charged)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughCharges"));let n=await this.getSpell(i);if(n){n=n.toObject(),n.system.talentValue.value=i.fw;const t=await e.Z.emptyActor(14,this.item.name);t.setupSpell(n,{},"emptyActor").then((async r=>{const o=game.i18n.format("CHATNOTIFICATION.enchantmentUsed",{item:this.item.name,spell:n.name});await ChatMessage.create(e.Z.chatDataSetup(o)),await t.basicTest(r),i.permanent?this.toggleChargedState(a,s):this.deleteEnchantment(a,s)}))}})),t.find(".ench-fw").change((e=>{let{id:t,enchantments:a}=this.enchantMentId(e),s=Number($(e.currentTarget).val());if(s){for(let e of a)if(e.id==t){e.fw=s;break}this.item.update({flags:{dsa5:{enchantments:a}}})}})),t.find(".ench-delete").click((e=>{let{id:t,enchantments:a}=this.enchantMentId(e);this.deleteEnchantment(t,a)})),t.find(".ench-show").click((async e=>{let{id:t,enchantments:a}=this.enchantMentId(e),s=a.find((e=>e.id==t)),i=await this.getSpell(s);i&&i.sheet.render(!0)})),t.find(".poison-toggle-permanent").click((e=>{this.item.update({flags:{dsa5:{poison:{permanent:!this.item.flags.dsa5.poison.permanent}}}})})),t.find(".poison-delete").click((e=>{this.deletePoison()})),t.find(".poison-show").click((async()=>{let e;this.item.actor&&(e=this.item.actor.items.find((e=>"poison"==e.type&&e.name==this.item.flags.dsa5.poison.name))),e||(e=await this.getSpell(this.item.flags.dsa5.poison)),e&&e.sheet.render(!0)}))}deletePoison(){this.item.update({"flags.dsa5.-=poison":null})}deleteEnchantment(e,t){let a=t.findIndex((t=>t.id==e));t.splice(a,1),this.item.update({flags:{dsa5:{enchantments:t}}})}async getSpell(e){const t=await game.packs.get(e.pack);if(!t)return void ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound"));let a=await t.getDocument(e.itemId);if(!a){const s=await t.index.getName(e.name);s&&(a=await t.getDocument(s._id))}return a||ui.notifications.error(game.i18n.localize("DSAError.enchantmentNotFound")),a}enchantMentId(e){return{id:$(e.currentTarget).parents(".statusEffect").attr("data-id"),enchantments:this.item.getFlag("dsa5","enchantments")}}prepareDomains(){let e=getProperty(this.item.system,"effect.attributes");if(e){const t=new RegExp(game.i18n.localize("WEAPON.magical"),"i"),a=new RegExp(game.i18n.localize("WEAPON.clerical"),"i");e=e.split(",").map((e=>{let s="";return t.test(e)?s="magical":a.test(e)&&(s="blessed"),`<li class="${s}">${e}</li>`})).join("")}return e}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{dragDrop:[{dragSelector:".item-list .item",dropSelector:".content"}]}),e}_canDragDrop(e){return this.isEditable}async getData(e){const a=await super.getData(e);a.enchantments=this.item.getFlag("dsa5","enchantments");const s=[];return a.poison=this.item.getFlag("dsa5","poison"),a.poison&&s.push("poison"),a.enchantments&&a.enchantments.some((e=>!e.talisman))&&s.push("enchantment"),a.enchantments&&a.enchantments.some((e=>e.talisman))&&s.push("talisman"),a.enchantmentLabel=s.map((e=>game.i18n.localize(e))).join("/"),a.traditionArtifacts=t.Z.traditionArtifacts,a.hasEnchantments=a.poison||a.enchantments&&a.enchantments.length>0,a}}class InformationSheet extends ItemSheetdsa5{async getData(t){const a=await super.getData(t);return mergeObject(a,{allSkills:await e.Z.allSkillsList(),enrichedqs1:await TextEditor.enrichHTML(this.item.system.qs1,{async:!0}),enrichedqs2:await TextEditor.enrichHTML(this.item.system.qs2,{async:!0}),enrichedqs3:await TextEditor.enrichHTML(this.item.system.qs3,{async:!0}),enrichedqs4:await TextEditor.enrichHTML(this.item.system.qs4,{async:!0}),enrichedqs5:await TextEditor.enrichHTML(this.item.system.qs5,{async:!0}),enrichedqs6:await TextEditor.enrichHTML(this.item.system.qs6,{async:!0})}),a}}class AmmunitionSheet extends Enchantable{constructor(e,t){super(e,t),this.isPoisonable=!0}async getData(e){const a=await super.getData(e);return a.ammunitiongroups=t.Z.ammunitiongroups,a.domains=this.prepareDomains(),a}}class EquipmentSheet extends(ItemSheetObfuscation(Enchantable)){async getData(e){const a=await super.getData(e);if(mergeObject(a,{equipmentTypes:t.Z.equipmentTypes,domains:this.prepareDomains(),canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")}),this.isBagWithContents()){let e=0;mergeObject(a,{containerContent:this.item.actor.items.filter((e=>t.Z.equipmentCategories.includes(e.type)&&e.system.parent_id==this.item.id)).map((t=>{t.system.preparedWeight=parseFloat((t.system.weight.value*t.system.quantity.value).toFixed(3)),e+=Number(t.system.preparedWeight);const a=getProperty(t,"flags.dsa5.enchantments");return a&&a.length>0?t.enchantClass="rar":(t.system.effect&&""!=t.system.effect.value||t.effects.length>0)&&(t.enchantClass="common"),t})),weightSum:parseFloat(e.toFixed(3)),weightWidth:`style="width: ${Math.min(this.item.system.capacity?e/this.item.system.capacity*100:0,100)}%"`,weightExceeded:e>Number(this.item.system.capacity)?"exceeded":""})}return a}async breakOverflow(e,t){let a=$(await renderTemplate("systems/dsa5/templates/items/baghover.html",e)),s=t.offset().top+52,i=t.offset().left-75;return a.appendTo($("body")),a.css({position:"absolute",left:i+"px",top:s+"px",bottom:"auto",right:"auto","z-index":1e4}),a}activateListeners(e){super.activateListeners(e);const t=e.find(".slot");t.mouseenter((async e=>{const t=$(e.currentTarget);let a=await this.breakOverflow({name:t.attr("data-name"),weight:t.attr("data-weight"),quantity:t.attr("data-quantity")},t);a.fadeIn(),t.mouseleave((()=>{a.remove(),t.off("mouseleave")}))})),t.mousedown((async e=>{let t=e.currentTarget.dataset.itemId,a=this.actor.items.get(t);0==e.button?a.sheet.render(!0):2==e.button&&($(".itemInfo").remove(),await a.update({"system.parent_id":0}),this.render(!0))}))}isBagWithContents(){return this.item.actor&&"bags"==getProperty(this.item,"system.equipmentType.value")}async _onDrop(e){if(this.isBagWithContents()){const a=JSON.parse(e.dataTransfer.getData("text/plain")),{item:s,typeClass:i,selfTarget:n}=await(0,l.x8)(a,void 0),r=this.item.id==s.id,o=this.item.parent.id==a.actorId;if(t.Z.equipmentCategories.includes(i)&&!r)return s.system.parent_id=this.item.id,s.system.worn&&s.system.worn.value&&(s.system.worn.value=!1),o?await this.item.actor.updateEmbeddedDocuments("Item",[s]):await this.item.actor.sheet._addLoot(s),void this.render(!0)}await super._onDrop(e)}}class ArmorSheet extends(ItemSheetObfuscation(Enchantable)){async getData(e){const a=await super.getData(e);return mergeObject(a,{domains:this.prepareDomains(),armorSubcategories:Object.keys(t.Z.armorSubcategories),breakPointRating:t.Z.armorSubcategories[this.item.system.subcategory]}),a.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),a}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>f.Z.breakingTest(this.item)}),e}}class PlantSheet extends(ItemSheetObfuscation(ItemSheetdsa5)){async getData(e){const t=await super.getData(e);return t.attributes=Object.keys(t.system.planttype).map((e=>({name:e,checked:t.system.planttype[e]}))),t.enrichedEffect=await TextEditor.enrichHTML(getProperty(this.item.system,"effect"),{secrets:this.object.isOwner,async:!0}),t.enrichedRecipes=await TextEditor.enrichHTML(getProperty(this.item.system,"recipes"),{secrets:this.object.isOwner,async:!0}),t.enrichedInformation=await TextEditor.enrichHTML(getProperty(this.item.system,"infos"),{secrets:this.object.isOwner,async:!0}),t}}class PatronSheet extends ItemSheetdsa5{async getData(e){const t=await super.getData(e);return t.patronCategories=[0,1,2,3].map((e=>({name:game.i18n.localize(`PATRON.${e}`),val:e}))),t.priorities={0:game.i18n.localize("PATRON.primary"),1:game.i18n.localize("PATRON.secondary")},t}}class MagicalSignSheet extends ItemSheetdsa5{async getData(e){const t=await super.getData(e);return t.categories={1:game.i18n.localize("TYPES.Item.magicalsign"),2:game.i18n.localize("additionalsign")},t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async e=>this.setupEffect(e)}),e}async setupEffect(e){const t=Number(this.item.system.asp)||0;if(this.item.actor.system.status.astralenergy.value<t)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP"));const a=this.item.actor,s=game.dsa5.config.ItemSubclasses.magicalsign,i=a.items.find((e=>"skill"==e.type&&e.name==game.i18n.localize("LocalizedIDs.artisticAbility"))),n=`<hr/><p><b>${this.item.name}</b></p><p>${this.item.system.description.value}</p><p>${s.chatData(this.item.system,"").join("</br>")} <span class="costCheck"></span></p>`;a.setupSkill(i,{other:[n],subtitle:` (${game.i18n.localize("TYPES.Item.magicalsign")})`},void 0).then((async e=>{const s=await a.basicTest(e,{suppressMessage:!0});s.result.preData.calculatedSpellModifiers={finalcost:t,costsMana:!0},await y.Z.renderRollCard(s.cardOptions,s.result,s.options.rerenderMessage)}))}}class RangeweaponSheet extends(ItemSheetObfuscation(Enchantable)){_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>f.Z.breakingTest(this.item)}),e}async getData(a){const s=await super.getData(a);return mergeObject(s,{canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),ammunitiongroups:t.Z.ammunitiongroups,combatskills:await e.Z.allCombatSkillsList("range"),domains:this.prepareDomains(),breakPointRating:t.Z.weaponStabilities[game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)]}),s}}class BlessingSheetDSA5 extends ItemSheetdsa5{_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async e=>this.setupEffect(e)}),e}async getData(e){const t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async setupEffect(t){if(this.item.actor.system.status.karmaenergy.value<1)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughKaP"));const a=game.dsa5.config.ItemSubclasses.magictrick;await this.item.actor.update({"system.status.karmaenergy.value":this.item.actor.system.status.karmaenergy.value-=1});let s=`<p><b>${this.item.name} - ${game.i18n.localize("blessing")} ${game.i18n.localize("probe")}</b></p><p>${this.item.system.description.value}</p><p>${a.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(e.Z.chatDataSetup(s))}}class ItemCareerDSA5 extends ItemSheetdsa5{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){const a=await super.getData(e);let s=duplicate(t.Z.characteristics);return s["-"]="-",a.mageLevels=t.Z.mageLevels,a.guidevalues=s,a.enrichedClothing=await TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:this.object.isOwner,async:!0}),a}}class ConsumableSheetDSA5 extends(ItemSheetObfuscation(ItemSheetdsa5)){static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:480}),e}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"consumeItem",icon:"fas fa-dice-d20",onclick:async e=>this.setupEffect(e)}),e}async getData(e){const a=await super.getData(e);return a.calculatedPrice=a.system.price.value*a.system.QL||0,a.availableSteps=a.system.QLList.split("\n").map(((e,t)=>t+1)),a.equipmentTypes=t.Z.equipmentTypes,a.enrichedIngredients=await TextEditor.enrichHTML(getProperty(this.item.system,"ingredients"),{secrets:this.object.isOwner,async:!0}),a}setupEffect(e){this.item.setupEffect()}}class ItemCultureDSA5 extends ItemSheetdsa5{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:700,height:700}),e}async getData(e){const t=await super.getData(e);return t.enrichedClothing=await TextEditor.enrichHTML(getProperty(this.item.system,"clothing.value"),{secrets:this.object.isOwner,async:!0}),t}}class DiseaseSheetDSA5 extends ItemSheetdsa5{_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async e=>this.setupEffect(e)}),e}async getData(e){const a=await super.getData(e);return a.resistances=t.Z.magicResistanceModifiers,a}}class MagictrickSheetDSA5 extends ItemSheetdsa5{_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async e=>this.setupEffect(e)}),e}async getData(e){const t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async setupEffect(t){if(this.item.actor.system.status.astralenergy.value<1)return ui.notifications.error(game.i18n.localize("DSAError.NotEnoughAsP"));const a=game.dsa5.config.ItemSubclasses.magictrick;await this.item.actor.update({"system.status.astralenergy.value":this.item.actor.system.status.astralenergy.value-=1});const s=`<p><b>${this.item.name} - ${game.i18n.localize("magictrick")} ${game.i18n.localize("probe")}</b></p><p>${this.item.system.description.value}</p><p>${a.chatData(this.item.system,"").join("</br>")}</p>`;await ChatMessage.create(e.Z.chatDataSetup(s))}}class MeleeweaponSheetDSA5 extends(ItemSheetObfuscation(Enchantable)){constructor(e,t){super(e,t),this.isPoisonable=!0}async getData(a){const s=await super.getData(a),i=mergeObject(duplicate(t.Z.characteristics),{"ge/kk":game.i18n.localize("CHAR.GEKK"),"-":"-"}),n=d.Z.regex2h.test(this.item.name);let r="";if(n){switch(game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)){case"Two-Handed Impact Weapons":case"Two-Handed Swords":r=new RegExp(game.i18n.localize("wrongGrip.wrongGripBastardRegex")).test(this.item.name)?"wrongGrip.yieldOneBastard":"wrongGrip.yieldOneSwordBlunt";break;default:r="wrongGrip.yieldOnePolearms"}}else r="wrongGrip.yieldTwo";if(mergeObject(s,{characteristics:i,twoHanded:n,wrongGripLabel:n?"wrongGrip.oneHanded":"wrongGrip.twoHanded",wrongGripHint:r,combatskills:await e.Z.allCombatSkillsList("melee"),ranges:t.Z.meleeRanges,shieldSizes:t.Z.shieldSizes,isShield:this.item.system.combatskill.value==game.i18n.localize("LocalizedIDs.Shields"),domains:this.prepareDomains(),breakPointRating:t.Z.weaponStabilities[game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`)]}),this.item.actor){const e=this.item.actor.items.find((e=>"combatskill"==e.type&&e.name==this.item.system.combatskill.value));s.canBeOffHand=e&&!e.system.weapontype.twoHanded&&this.item.system.worn.value,s.canBeWrongGrip=!["Daggers","Fencing Weapons"].includes(game.i18n.localize(`LocalizedCTs.${this.item.system.combatskill.value}`))}return s.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),s}_getHeaderButtons(){let e=super._getHeaderButtons();return this.item.isOwned&&game.settings.get("dsa5","armorAndWeaponDamage")&&this.item.system.structure.max>0&&e.unshift({class:"rollDamaged",icon:"fas fa-dice-d20",onclick:async()=>f.Z.breakingTest(this.item)}),e}}class PoisonSheetDSA5 extends(ItemSheetObfuscation(ItemSheetdsa5)){_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"rolleffect",icon:"fas fa-dice-d20",onclick:async e=>this.setupEffect(e)}),e}async getData(e){const a=await super.getData(e);return a.resistances=t.Z.magicResistanceModifiers,a}}class SpecialAbilitySheetDSA5 extends ItemSheetdsa5{async _refundStep(){if(this.item.system.step.value>1){let e=await i.Z.stepXPCost(this.item,this.item.system.step.value-1);e=await i.Z.refundFreelanguage(this.item,this.item.actor,e,!1),await this.item.actor._updateAPs(-1*e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value-1})}}async _advanceStep(){if(this.item.system.step.value<this.item.system.maxRank.value){let e=await i.Z.stepXPCost(this.item,this.item.system.step.value);e=await i.Z.isFreeLanguage(this.item,this.item.actor,e,!1),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value+1}))}}_advancable(){return this.item.system.maxRank.value>0}async getData(e){const a=await super.getData(e);return mergeObject(a,{categories:t.Z.specialAbilityCategories,subCategories:t.Z.combatSkillSubCategories,traditionArtifacts:t.Z.traditionArtifacts,canOnUseEffect:game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro")}),a}}class ItemSpeciesDSA5 extends ItemSheetdsa5{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{width:530,height:570}),e}async getData(e){const t=await super.getData(e);return mergeObject(t,{hasLocalization:game.i18n.has(`Racedescr.${this.item.name}`)}),t}}class SpellSheetDSA5 extends ItemSheetdsa5{async getData(e){const a=await super.getData(e);return a.characteristics=t.Z.characteristics,a.StFs=t.Z.StFs,a.resistances=t.Z.magicResistanceModifiers,a.targetTypes=t.Z.areaTargetTypes,a.isOwned&&(a.extensions=this.item.actor.items.filter((e=>"spellextension"==e.type&&e.system.source==this.item.name&&this.item.type==e.system.category))),a}activateListeners(e){super.activateListeners(e),e.find(".item-edit").click((e=>{e.preventDefault();let t=this._getItemId(e);this.item.actor.items.get(t).sheet.render(!0)})),e.find(".item-delete").click((e=>{this._deleteItem(e)}))}_deleteItem(e){let t=this._getItemId(e),a=this.actor.items.find((e=>e.id==t)),s=game.i18n.format("DIALOG.DeleteItemDetail",{item:a.name});renderTemplate("systems/dsa5/templates/dialog/delete-item-dialog.html",{message:s}).then((a=>{new Dialog({title:game.i18n.localize("DIALOG.deleteConfirmation"),content:a,buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{this._cleverDeleteItem(t),$(e.currentTarget).closest(".item").remove()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}},default:"Yes"}).render(!0)}))}async _cleverDeleteItem(e){let t=this.item.actor.items.find((t=>t.id==e));await this.item.actor._updateAPs(-1*t.system.APValue.value,{},{render:!1}),await this.item.actor.deleteEmbeddedDocuments("Item",[e])}}class SpellExtensionSheetDSA5 extends ItemSheetdsa5{async getData(e){const t=await super.getData(e);return mergeObject(t,{categories:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}),t}}class VantageSheetDSA5 extends ItemSheetdsa5{_advancable(){return this.item.system.max.value>0}async getData(e){const t=await super.getData(e);return t.canOnUseEffect=game.user.isGM||await game.settings.get("dsa5","playerCanEditSpellMacro"),t}async _refundStep(){if(this.item.system.step.value>1){let e=await a.Z.stepXPCost(this.item,this.item.system.step.value-1);e=await a.Z.reduceSingularVantages(this.item.actor,this.item,e),await this.item.actor._updateAPs(-1*e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value-1})}}async _advanceStep(){if(this.item.system.step.value<this.item.system.max.value){let e=await a.Z.stepXPCost(this.item,this.item.system.step.value);const t=duplicate(this.item);t.system.step.value+=1,e=await a.Z.addSingularVantages(this.item.actor,t,e),await this.item.actor.checkEnoughXP(e)&&(await this.item.actor._updateAPs(e,{},{render:!1}),await this.item.update({"system.step.value":this.item.system.step.value+1}))}}}const v={"":"Modifier",defenseMalus:"MODS.defenseMalus",FW:"MODS.FW",KaPCost:"CHAR.KaPCost",AsPCost:"CHAR.AsPCost",FP:"MODS.FP",QL:"MODS.QS",dmg:"MODS.damage",damageBonus:"MODS.damage",armorPen:"MODS.armorPen",TPM:"MODS.partChecks"};class DiceSoNiceCustomization extends Application{static unloadedModels=[];static retries=0;static retrying=!1;static attrs=["mu","kl","in","ch","ff","ge","ko","kk","attack","dodge","parry","damage"];initConfigs(){const e=game.dice3d.exports.Utils.prepareColorsetList();this.choices={};for(const[t,a]of Object.entries(e))mergeObject(this.choices,a);const t={damage:"black"};delete this.choices.custom,game.settings.registerMenu("dsa5","dicesonicesettings",{name:"DiceSoNiceSettings",label:"DiceSoNice Settings",hint:game.i18n.localize("DSASETTINGS.dicesonicesettings"),type:DiceSoNiceForm,restricted:!1});for(const e of DiceSoNiceCustomization.attrs)game.settings.register("dsa5",`dice3d_${e}`,{name:`CHAR.${e.toUpperCase()}`,scope:"client",config:!1,default:t[e]||e,type:String}),game.settings.register("dsa5",`dice3d_system_${e}`,{name:`CHAR.${e.toUpperCase()}`,scope:"client",config:!1,default:"standard",type:String})}getAttributeConfiguration(t){return e.Z.moduleEnabled("dice-so-nice")&&game.dice3d?{colorset:game.settings.get("dsa5",`dice3d_${t}`),appearance:{colorset:game.settings.get("dsa5",`dice3d_${t}`),system:game.settings.get("dsa5",`dice3d_system_${t}`)}}:{colorset:t}}activateListeners(e){super.activateListeners(),e.find('[name="entryselection"]').change((async e=>{await game.settings.set("dsa5",`dice3d_${e.currentTarget.dataset.attr}`,e.currentTarget.value)})),e.find('[name="systemselection"]').change((async e=>{await game.settings.set("dsa5",`dice3d_system_${e.currentTarget.dataset.attr}`,e.currentTarget.value),DiceSoNiceCustomization.preloadDiceAssets([e.currentTarget.value]),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:{toPreload:[e.currentTarget.value]}})}))}static onConnect(){game.socket.on("system.dsa5",(e=>{switch(e.type){case"preloadDice3d":console.warn("Preloading forced DSA dice assets"),DiceSoNiceCustomization.preloadDiceAssets(e.payload);break;case"getPreloadDice3d":DiceSoNiceCustomization.requestDicePreloads()}})),this.collectPreloads(),game.socket.emit("system.dsa5",{type:"getPreloadDice3d"})}static collectPreloads(e=!0){let t=new Set;for(let e of DiceSoNiceCustomization.attrs)t.add(game.settings.get("dsa5",`dice3d_system_${e}`));t=Array.from(t),e&&this.preloadDiceAssets(t),game.socket.emit("system.dsa5",{type:"preloadDice3d",payload:t})}static requestDicePreloads(){this.collectPreloads(!1)}static async preloadDiceAssets(e,t=[]){console.warn("loading",e);for(const a of e){const e=game.dice3d.DiceFactory.systems[a];if(!e){this.unloadedModels.push(a);continue}const s=e.dice.filter((e=>0==t.length||t.includes(e.type)));for(const e of s)try{e.modelFile?await e.loadModel(game.dice3d.DiceFactory.loaderGLTF):await e.loadTextures()}catch(t){console.warn("Unable to load dice model",a,e)}}this.unloadedModels.length&&this.retries<6&&!this.retrying&&(this.retrying=!0,setTimeout((()=>{this.retries+=1;const e=new Set(this.unloadedModels);this.unloadedModels=[],this.retrying=!1,this.preloadDiceAssets(e)}),1e4))}async getData(e){const t=await super.getData(e);t.choices=this.choices,t.systems=game.dice3d.DiceFactory.systems,t.selections={};for(const e of DiceSoNiceCustomization.attrs)t.selections[e]={color:game.settings.get("dsa5",`dice3d_${e}`),system:game.settings.get("dsa5",`dice3d_system_${e}`)};return t}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{template:"systems/dsa5/templates/wizard/dicesonice-configuration.html",title:game.i18n.localize("DSASETTINGS.dicesonicesettings"),width:600}),e}}class DiceSoNiceForm extends FormApplication{render(){game.dsa5.apps.DiceSoNiceCustomization.render(!0)}}var k=__webpack_require__(61);function actor(){function checkIniChange(e){if(game.combat&&e.changes.some((e=>/(system\.status\.initiative|system\.characteristics.mu|system\.characteristics\.ge)/.test(e.key)))){const t=e.parent.id,a=game.combat.combatants.find((e=>e.actor.id==t));a&&a.recalcInitiative()}}Hooks.on("preDeleteActiveEffect",((e,t,a)=>{if(t.noHook)return;const s=e.parent;if(s&&"Actor"==s.documentName&&getProperty(e,"flags.dsa5.maintain")){const t=[e._id],a=e.name.replace("("+game.i18n.localize("maintainCost")+")","").trim(),i=s.effects.filter((t=>t.name.startsWith(a)&&!t.origin&&t.id!=e._id));let n=game.i18n.format("DIALOG.updateMaintainSpell",{actor:s.name});return i&&(n+=`<p>${game.i18n.localize("DIALOG.dependentMaintainEffects")}</p>`,n+=i.map((e=>`<p><label for="rel${e.id}">${e.name}</label><input class="effectRemoveSelector" checked type="checkbox" value="${e.id}" name="rel${e.id}"/></p>`)).join("")),new Dialog({title:e.name,content:n,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("HELP.pay"),callback:async()=>{if(await s.applyMana(Number(getProperty(e,"flags.dsa5.maintain")),getProperty(e,"flags.dsa5.payType"))){const t={startTime:game.time.worldTime};game.combat&&(t.startRound=game.combat.round,t.startTurn=game.combat.turn),s.updateEmbeddedDocuments("ActiveEffect",[{_id:e._id,duration:t}])}}},delete:{icon:'<i class="fas fa-trash"></i>',label:game.i18n.localize("delete"),callback:e=>{for(let a of e.find(".effectRemoveSelector:checked"))t.push($(a).val());s.deleteEmbeddedDocuments("ActiveEffect",t,{noHook:!0})}}}}).render(!0),!1}})),Hooks.on("updateActor",((e,t)=>{!game.user.isGM&&e.limited&&hasProperty(t,"system.merchant.hidePlayer")&&ui.sidebar.render(!0)})),Hooks.on("deleteActiveEffect",((t,a)=>{if(!e.Z.isActiveGM()||a.noHook)return;const s=t.parent;if(s&&"Actor"==s.documentName){const e=[...t.statuses][0];if("bloodrush"==e)return s.addCondition("stunned",2,!1,!1),!1;if("dead"==e&&game.combat)return s.markDead(!1),!1;k.Z.onEffectRemove(s,t);if(!1===Hooks.call("deleteActorActiveEffect",s,t))return!1}})),Hooks.on("dropActorSheetData",((e,t,a)=>{switch(a.data?.type){case"condition":return e.addCondition(a.data.payload.id,1,!1,!1),!1;case"lookup":return t._handleLookup(a.data),!1;case"fullpack":return t._addFullPack(a.data),!1}})),Hooks.on("createActiveEffect",((t,a,s)=>{e.Z.isActiveGM()&&(checkIniChange(t),createEffects(t))})),Hooks.on("deleteActiveEffect",((t,a,s)=>{e.Z.isActiveGM()&&checkIniChange(t)})),Hooks.on("updateActiveEffect",((t,a,s)=>{e.Z.isActiveGM()&&(checkIniChange(t),countableDependentEffects(t))}));const createEffects=async e=>{const t=e.parent;if(!t)return;await countableDependentEffects(e,{},t);const a=[...e.statuses][0];"dead"==a&&game.combat?await t.markDead(!0):"unconscious"==a&&await t.addCondition("prone")},countableDependentEffects=async(t,s={},i)=>{if(i||(i=t.parent),!i||"Actor"!=i.documentName)return;const n=/^system\.condition\./;for(let e of t.changes||[])n.test(e.key)&&2==e.mode&&(s[e.key.split(".")[2]]=Number(e.value));for(let n of Object.keys(s))if(i.system.condition[n]>=4&&("inpain"==n?await i.initResistPainRoll(t):["encumbered","stunned","feared","confused","trance"].includes(n)?await i.addCondition("incapacitated"):"paralysed"==n?await i.addCondition("rooted"):["drunken","exhaustion"].includes(n)&&(await i.addCondition("stunned"),await i.removeCondition(n))),(Number(s.inpain)||0)>0&&!i.hasCondition("bloodrush")&&i.system.condition.inpain>0&&a.Z.hasVantage(i,game.i18n.localize("LocalizedIDs.frenzy"))){await i.addCondition("bloodrush");const t=e.Z.replaceConditions(`${game.i18n.format("CHATNOTIFICATION.gainsBloodrush",{character:"<b>"+i.name+"</b>"})}`);ChatMessage.create(e.Z.chatDataSetup(t))}},obfuscateName=async(t,a)=>{if(!e.Z.isActiveGM())return;const s=t.actor;if(s.hasPlayerOwner)return;const i=Number(game.settings.get("dsa5","obfuscateTokenNames"));if(0==i||"loot"==getProperty(s,"merchant.merchantType"))return;let n=canvas.scene.tokens.filter((e=>e.actor&&e.actor.id===s.id)),r=game.i18n.localize("unknown");if([2,4].includes(i)){if(!(t.id||t._id))return;(async(e,t)=>{(game.dsa5.apps.AskForNameDialog||AskForNameDialog).getDialog(e,t)})(t,i)}else n.length>0&&i<3&&(r=`${n[0].name.replace(/ \d{1,}$/)} ${n.length+1}`),a.name=r};Hooks.on("updateToken",((e,t,a)=>{g.Z.updateTokenHook(e,t,a)})),Hooks.on("deleteToken",(e=>{g.Z.deleteTokenHook(e)})),Hooks.on("preCreateToken",((t,a,s,i)=>{const n=t.actor;if(!n)return;let r={};"loot"==getProperty(n,"system.merchant.merchantType")?mergeObject(r,{displayBars:0}):getProperty(n,"system.config.autoBar")&&(mergeObject(r,{bar1:{attribute:"status.wounds"}}),n.system.isMage?mergeObject(r,{bar2:{attribute:"status.astralenergy"}}):n.system.isPriest?mergeObject(r,{bar2:{attribute:"status.karmaenergy"}}):mergeObject(r,{bar2:{attribute:"tbd"}})),getProperty(n,"system.config.autoSize")&&e.Z.calcTokenSize(n,r),obfuscateName(t,r),t.updateSource(r)})),Hooks.on("createToken",((e,t,a)=>{t.noHook||(obfuscateName(e,{}),g.Z.createTokenHook(e,t,a))}))}class AskForNameDialog extends Dialog{static async getDialog(e,t){new Dialog({title:game.i18n.localize("DSASETTINGS.obfuscateTokenNames"),content:`<label for="name">${game.i18n.localize("DSASETTINGS.rename")}</label> <input dtype="string" name="name" type="text" value="${e.actor.name}"/>`,default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async a=>{const s=e.id||e._id;let i=a.find('[name="name"]').val();if(2==t){let e=canvas.scene.tokens.filter((e=>e.name===i));e.length>0&&(i=`${i.replace(/ \d{1,}$/)} ${e.length+1}`)}const n=canvas.scene.tokens.get(s);await n.update({name:i})}},unknown:{icon:'<i class="fa fa-question"></i>',label:game.i18n.localize("unknown"),callback:async()=>{const t=e.id||e._id,a=canvas.scene.tokens.get(t);await a.update({name:game.i18n.localize("unknown")})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}}function createHotBarMacro(e,t,a,s){let i=game.macros.contents.find((a=>a.name===t&&a.command===e));return i?game.user.assignHotbarMacro(i,s):Macro.create({name:t,type:"script",img:a,command:e},{displaySheet:!1}).then((e=>game.user.assignHotbarMacro(e,s))),!1}var D=__webpack_require__(118);function chatlog(){Hooks.on("renderChatLog",((e,t,a)=>{b.Z.chatListeners(t),y.Z.chatListeners(t),DSA5Payment.chatListeners(t);const s=new u.Z;Hooks.call("startDSA5ChatAutoCompletion",s),s.chatListeners(t),n.Z.chatListeners(t)})),Hooks.on("renderChatMessage",((t,a,s)=>{if(game.user.isGM)a.find(".chat-button-player").remove();else{let t;a.find(".chat-button-gm").remove();const i=a.find(".chat-button-target");i.length&&(t=D.ZP.getTargetActor(s.message),t&&t.actor&&!t.actor.isOwner&&i.remove());const n=e.Z.getSpeaker(s.message.speaker);n&&!n.isOwner&&(a.find(".selfButton").remove(),a.find(".d20").attr("data-tooltip",""));const r=a.find(".onlyTarget");r.length&&(t=e.Z.getSpeaker({token:r.attr("data-token"),actor:r.attr("data-actor"),scene:canvas.scene?canvas.scene.id:null}),t&&!t.isOwner&&r.remove()),a.find(".hideData").remove();getProperty(s.message,`flags.dsa5.userHidden.${game.user.id}`)&&a.find(".payButton").remove()}game.settings.get("dsa5","expandChatModifierlist")&&(a.find(".expand-mods i").toggleClass("fa-minus fa-plus"),a.find(".expand-mods + ul").css({display:"block"})),r.Z.bindButtons(a),a.find(".embeddedItemDrag").each((function(e,t){t.setAttribute("draggable",!0),t.addEventListener("dragstart",(e=>function embeddedDragStart(e){const t=$(e.currentTarget).parents(".message").attr("data-message-id");let a=game.messages.get(t);let s={type:"Item",data:a.getFlag("dsa5","embeddedItem")};e.dataTransfer.setData("text/plain",JSON.stringify(s))}(e)))}))})),Hooks.on("chatMessage",((t,a,s)=>{let i=a.match(/^\/(pay|getPaid|help$|conditions$|tables)/);switch(i=i?i[0]:"",console.log(s),i){case"/pay":return game.user.isGM?DSA5Payment.createPayChatMessage(a):DSA5Payment.payMoney(e.Z.getSpeaker(s.speaker),a),!1;case"/getPaid":return game.user.isGM?DSA5Payment.createGetPaidChatMessage(a):DSA5Payment.getMoney(e.Z.getSpeaker(s.speaker),a),!1;case"/help":return n.Z.getHelp(),!1;case"/conditions":return n.Z.showConditions(),!1;case"/tables":return n.Z.showTables(),!1}})),Hooks.on("preCreateChatMessage",((e,t,a,s)=>{if(getProperty(e,"flags.core.initiativeRoll")){const t=e.rolls[0].terms,a=`${t[0].number}`.split(".")[0],s=`${game.i18n.localize("baseValue")}: ${a}, ${game.i18n.localize("randomValue")}: ${t.at(-1).number}")}`,i=[];for(let e of t)if(e.faces)for(let t=0;t<e.number;t++)i.push(`<span class="die-damage d${e.faces}">${e.results[t].result}</span>`);const n={content:`<div>\n                <div class="card-content hide-option roll-result">\n                    <b>${game.i18n.localize("Roll")}</b>: ${i.join("")}\n                </div>\n                <div class="card-content" data-tooltip="${s}">\n                    <b>${game.i18n.localize("initiative")}</b>: ${Math.floor(100*e.rolls[0]._total)/100}\n                </div>\n            </div>`,flavor:void 0};e.updateSource(n)}}))}class DSA5Tutorial{static async firstTimeMessage(){if(!await game.settings.get("dsa5","firstTimeStart")){await DSA5Tutorial.setupDefaultOptions();let t=game.i18n.localize("WELCOME");ChatMessage.create(e.Z.chatDataSetup(t)),DSA5Tutorial.firstTimeLanguage(),await game.settings.set("dsa5","firstTimeStart",!0)}}static firstTimeLanguage(){const e=["de","en"];let t={title:game.i18n.localize("DIALOG.firstTime"),content:game.i18n.localize("DIALOG.firstTimeWarning"),default:"de",buttons:{}};for(const a of e)t.buttons[a]={label:game.i18n.localize(a),callback:()=>DSA5Tutorial.setLanguage(a)};new Dialog(t).render(!0)}static async setLanguage(e){await game.settings.set("dsa5","firstTimeStart",!0),await game.settings.set("dsa5","forceLanguage",e),await game.settings.set("core","language",e),foundry.utils.debouncedReload()}static async setupDefaultOptions(){const e=game.settings.get("core",Combat.CONFIG_SETTING);e.skipDefeated=!0,await game.settings.set("core",Combat.CONFIG_SETTING,e),await game.settings.set("core","leftClickRelease",!0)}}const MerchantSheetMixin=a=>class extends a{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["merchant-sheet"])}),e}static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/merchant-sheet.html"}get template(){if(this.merchantSheetActivated())switch(getProperty(this.actor.system,"merchant.merchantType")){case"merchant":return"systems/dsa5/templates/actors/merchant/merchant-limited.html";case"loot":return"systems/dsa5/templates/actors/merchant/merchant-limited-loot.html";case"epic":return"systems/dsa5/templates/actors/merchant/merchant-epic.html";default:return super.template}return this.constructor.merchantTemplate}merchantSheetActivated(){return this.showLimited()||this.playerViewEnabled()&&["merchant","loot","epic"].includes(getProperty(this.actor.system,"merchant.merchantType"))}async allowMerchant(e,t){let a=duplicate(this.actor.ownership);const s=t?1:0;for(const t of e)a[t]=s;await this.actor.update({ownership:a},{diff:!1,recursive:!1,noHook:!0})}activateListeners(e){super.activateListeners(e),e.find(".allowMerchant").click((async e=>{const t=e.currentTarget.dataset.userId,a=$(e.currentTarget).find("i");await this.allowMerchant([t],!a.hasClass("fa-check-circle")),a.toggleClass("fa-circle fa-check-circle")})),e.find(".toggleAllAllowMerchant").click((async e=>{const t=game.users.filter((e=>!e.isGM)).map((e=>e.id)),a="true"==e.currentTarget.dataset.lock;await this.allowMerchant(t,a),this.render()})),e.find(".lockTradeSection").click((e=>this.lockTradeSection(e))),e.find(".item-tradeLock").click((e=>this.toggleTradeLock(e))),e.find(".randomGoods").click((e=>this.randomGoods(e))),e.find(".clearInventory").click((e=>this.clearInventory(e))),e.find(".removeOtherTradeFriend").click((()=>this.removeOtherTradeFriend())),e.find(".choseTradefriend").click((()=>this.choseTradefriend())),e.find(".setCustomPrice").click((e=>$(e.currentTarget).addClass("edit"))),e.find(".customPriceTag").change((async e=>this.setCustomPrice(e))).blur((e=>$(e.currentTarget).closest(".setCustomPrice").removeClass("edit"))),e.find(".buy-item").click((e=>{this.advanceWrapper(e,"buyItem",e),c.Z.playMoneySound()})),e.find(".sell-item").click((e=>{this.advanceWrapper(e,"sellItem",e),c.Z.playMoneySound()})),e.find(".item-external-edit").click((e=>{e.preventDefault();let t=this._getItemId(e);this.getTradeFriend().items.get(t).sheet.render(!0)})),e.find(".changeAmountAllItems").mousedown((e=>this.changeAmountAllItems(e))),e.find(".gearSearch").prop("disabled",!1)}_canDragStart(e){return!this.merchantSheetActivated()&&this.isEditable}async toggleTradeLock(e){const t=this._getItemId(e);let a=this.actor.items.get(t);this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.tradeLocked":!a.system.tradeLocked}])}async setCustomPrice(e){e.stopPropagation(),e.preventDefault();const t=this._getItemId(e);await this.actor.updateEmbeddedDocuments("Item",[{_id:t,"flags.dsa5.customPriceTag":Number(e.target.value)}])}removeOtherTradeFriend(){this.otherTradeFriend=void 0,this.render(!0)}async choseTradefriend(){(await SelectTradefriendDialog.getDialog(this)).render(!0)}async lockTradeSection(e){const t=[],a=this.filterRule(e);let s;for(let e of this.actor.items)if(a(e)){let a=e.toObject();void 0===s&&(s=!a.system.tradeLocked),a.system.tradeLocked=s,t.push(a)}this.actor.updateEmbeddedDocuments("Item",t)}filterRule(e){const a=e.currentTarget.dataset.type;return t.Z.equipmentTypes[a]?e=>"equipment"==e.type&&e.system.equipmentType.value==a:e=>e.type==a&&t.Z.equipmentCategories.includes(e.type)}async changeAmountAllItems(e){const t=[],a=this.filterRule(e);for(let s of this.actor.items)if(a(s)){let a=s.toObject();d.Z.increment(e,a,"system.quantity.value",0),t.push(a)}this.actor.updateEmbeddedDocuments("Item",t)}async buyItem(e){await this.transferItem(this.actor,this.getTradeFriend(),e,!0)}async sellItem(e){await this.transferItem(this.getTradeFriend(),this.actor,e,!1)}async transferItem(e,t,a,s=!0){let i=this._getItemId(a),n=a.currentTarget.dataset.price,r=a.ctrlKey?10:1;game.user.isGM?await this.constructor.finishTransaction(e,t,n,i,s,r):(this.constructor.noNeedToPay(t,e,n)||DSA5Payment.canPay(t,n,!0))&&game.socket.emit("system.dsa5",{type:"trade",payload:{target:this.constructor.transferTokenData(t),source:this.constructor.transferTokenData(e),price:n,itemId:i,buy:s,amount:r}})}static transferTokenData(e){let t={actor:e.id};return e.token&&(t.token=e.token.id),t}static async finishTransaction(e,t,a,s,i,n){let r=e.items.get(s).toObject();if(n=Math.min(Number(r.system.quantity.value),n),Number(r.system.quantity.value)>0){const o=this.noNeedToPay(t,e,a);(o||await DSA5Payment.payMoney(t,a,!0))&&(getProperty(r,"system.worn.value")&&(r.system.worn.value=!1),i?(await this.updateTargetTransaction(t,r,n,e,a),await this.updateSourceTransaction(e,t,r,a,s,n),await this.transferNotification(r,t,e,i,a,n,o),await this.selfDestruction(e)):(await this.updateSourceTransaction(e,t,r,a,s,n),await this.updateTargetTransaction(t,r,n,e,a),await this.transferNotification(r,e,t,i,a,n,o)))}}static isTemporaryToken(e){return"loot"==getProperty(e.system,"merchant.merchantType")&&getProperty(e.system,"merchant.temporary")}static async selfDestruction(e){if(this.isTemporaryToken(e)){if(!e.items.some((e=>t.Z.equipmentCategories.includes(e.type)||"money"==e.type&&e.system.quantity.value>0))){game.socket.emit("system.dsa5",{type:"hideDeletedSheet",payload:{target:this.transferTokenData(e)}});const t=e.getActiveTokens().map((e=>e.id));await canvas.scene.deleteEmbeddedDocuments("Token",t),await game.actors.get(e.id).delete(),this.hideDeletedSheet(e)}}}static async hideDeletedSheet(e){e.sheet.close(!0)}static async transferNotification(t,a,s,i,n,r,o){const l=game.settings.get("dsa5","merchantNotification");if(0==l||"service"==getProperty(t,"system.equipmentType.value"))return;const c="MERCHANT."+(i?"buy":"sell")+(o?"Loot":"")+"Notification",d=game.i18n.format(c,{item:t.name,source:a.name,target:s.name,amount:r,price:n,buy:i}),m=e.Z.chatDataSetup(d);2==l&&(m.whisper=ChatMessage.getWhisperRecipients("GM").map((e=>e.id))),await ChatMessage.create(m)}static noNeedToPay(e,t,a){return 0==a||"loot"==getProperty(e.system,"merchant.merchantType")||"loot"==getProperty(t.system,"merchant.merchantType")}static async updateSourceTransaction(e,t,a,s,i,n){let r=duplicate(a);Number(r.system.quantity.value)>n||"money"==r.type?(r.system.quantity.value=Number(r.system.quantity.value)-n,await e.updateEmbeddedDocuments("Item",[r])):await e.deleteEmbeddedDocuments("Item",[i]),this.noNeedToPay(e,t,s)||await DSA5Payment.getMoney(e,s,!0)}static async updateTargetTransaction(t,a,i,n,r){let o=duplicate(a);if("service"==getProperty(o,"system.equipmentType.value")){const a=game.i18n.format("MERCHANT.buyNotification",{item:o.name,amount:i,source:t.name,target:n.name,price:r});ChatMessage.create(e.Z.chatDataSetup(a))}else{let e=t.items.find((e=>s.Z.areEquals(o,e)));o.system.quantity.value=i,e?await s.Z.stackItems(e,o,t):await t.createEmbeddedDocuments("Item",[o])}}getTradeFriend(){return this.otherTradeFriend||game.user.character}async _manageDragItems(e,t){switch(t){case"creature":case"npc":case"character":this.setTradeFriend(e);break;default:return super._manageDragItems(e,t)}}async _onDropActor(e,t){const a=this.actor.limited,s=this.actor.isOwner;if(!a&&!s)return!1;const{item:i,typeClass:n,selfTarget:r}=await(0,l.x8)(t,this.id,!1);return r?void 0:s||a&&"Actor"==i.documentName?await this._manageDragItems(i,n):void 0}setTradeFriend(e){const t=game.actors.get(e._id);t.isOwner&&(this.otherTradeFriend=t,this.render(!0))}async _render(e=!1,t={}){game.user.isGM||"loot"!=getProperty(this.actor.system,"merchant.merchantType")||!getProperty(this.actor.system,"merchant.locked")?await super._render(e,t):AudioHelper.play({src:"sounds/lock.wav",loop:!1},!1)}_togglePlayerview(e){this.actor.update({"system.merchant.playerView":!getProperty(this.actor.system,"merchant.playerView")})}playerViewEnabled(){return getProperty(this.actor.system,"merchant.playerView")}async randomGoods(e){const a=await renderTemplate("systems/dsa5/templates/dialog/randomGoods-dialog.html",{categories:t.Z.equipmentCategories});new Dialog({title:game.i18n.localize("MERCHANT.randomGoods"),content:a,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:t=>this.addRandomGoods(this.actor,t,e)},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async clearInventory(e){new Dialog({title:game.i18n.localize("MERCHANT.clearInventory"),content:game.i18n.localize("MERCHANT.deleteAllGoods"),default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{this.removeAllGoods(this.actor,e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}async addRandomGoods(e,t,a){let s=$(a.currentTarget).text();$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=[];t.find('input[type="checkbox"]:checked').each((function(){const e=$(this).val();i.push({name:e,count:Number(t.find(`input[name="each_${e}"]`).val()),number:Number(t.find(`input[name="number_${e}"]`).val())})}));const n=game.dsa5.itemLibrary;n.equipmentBuild||await n.buildEquipmentIndex();let r=[];for(let e of i){const t=(await n.getRandomItems(e.name,e.number)).map((t=>{const a=t.toObject();return a.system.quantity.value=e.count,a}));r.push(...t)}let o={};r=r.filter((function(t){let a=getProperty(t,"system.effect");a="object"==typeof a&&null!==a&&getProperty(a,"attributes")||"";const s=Number(getProperty(t,"system.price.value"))||0;if(""!=a||s>1e4)return!1;let i=`${t.type}_${t.name}`;return!o.hasOwnProperty(i)&&(o[i]=!0)&&0==e.items.filter((function(e){return e.type==t.type&&e.name==t.name})).length})),await e.createEmbeddedDocuments("Item",r),$(a.currentTarget).text(s)}async removeAllGoods(e,a){let s=$(a.currentTarget).text();$(a.currentTarget).html(' <i class="fa fa-spin fa-spinner"></i>');let i=e.items.filter((e=>t.Z.equipmentCategories.includes(e.type)&&!getProperty(e,"worn.value"))).map((e=>e.id));await e.deleteEmbeddedDocuments("Item",i),$(a.currentTarget).text(s)}async getData(e){const t=await super.getData(e);return t.merchantType=getProperty(this.actor.system,"merchant.merchantType")||"none",t.merchantTypes={none:game.i18n.localize("MERCHANT.typeNone"),merchant:game.i18n.localize("MERCHANT.typeMerchant"),loot:game.i18n.localize("MERCHANT.typeLoot"),epic:game.i18n.localize("MERCHANT.typeEpic")},t.invName=t.merchantTypes[t.merchantType],t.players=game.users.filter((e=>!e.isGM)).map((e=>(e.allowedMerchant=this.actor.testUserPermission(e,"LIMITED",!1),e.buyingFactor=getProperty(this.actor.system,`merchant.factors.buyingFactor.${e.id}`),e.sellingFactor=getProperty(this.actor.system,`merchant.factors.sellingFactor.${e.id}`),e))),"epic"!=t.merchantType?(this.prepareStorage(t),this.merchantSheetActivated()&&(this.filterWornEquipment(t),this.prepareTradeFriend(t),0==t.prepare.inventory.misc.items.length&&(t.prepare.inventory.misc.show=!1))):(this.prepareStorage(t),t.garadanOptions={1:game.i18n.localize("GARADAN.1"),2:game.i18n.localize("GARADAN.2"),3:game.i18n.localize("GARADAN.3"),4:game.i18n.localize("GARADAN.4"),6:game.i18n.localize("GARADAN.6")}),t.hasOtherTradeFriend=!!this.otherTradeFriend,t}filterWornEquipment(e){for(const[t,a]of Object.entries(e.prepare.inventory))a.items=a.items.filter((e=>!getProperty(e,"system.worn.value")))}prepareStorage(e){if("merchant"==e.merchantType)for(const[t,a]of Object.entries(e.prepare.inventory))for(const e of a.items)e.defaultPrice=this.getItemPrice(e),e.calculatedPrice=Number(parseFloat(""+e.defaultPrice*(getProperty(this.actor.system,"merchant.sellingFactor")||1)).toFixed(2))*(getProperty(this.actor.system,`merchant.factors.sellingFactor.${game.user.id}`)||1),e.priceTag=` / ${e.calculatedPrice}`;else if("loot"==e.merchantType){for(const[t,a]of Object.entries(e.prepare.inventory))for(const e of a.items)e.calculatedPrice=this.getItemPrice(e);const t={items:e.prepare.money.coins.map((e=>(e.name=game.i18n.localize(e.name),e))),show:!0,dataType:"money"};t.items.length&&(e.prepare.inventory.money=t)}}getItemPrice(e){return Number(getProperty(e,"flags.dsa5.customPriceTag"))||Number(e.system.price.value)*("consumable"==e.type?Number(e.system.QL)||0:1)}prepareTradeFriend(e){let t=this.getTradeFriend();if(t){let a=t.prepareItems({details:[]}),s="loot"==getProperty(this.actor.system,"merchant.merchantType")?1:(getProperty(this.actor.system,"merchant.buyingFactor")||1)*(getProperty(this.actor.system,`merchant.factors.buyingFactor.${game.user.id}`)||1),i=this.prepareSellPrices(a.inventory,s);0==i.misc.items.length&&(i.misc.show=!1),"loot"==e.merchantType&&(i.money={items:a.money.coins.map((e=>(e.name=game.i18n.localize(e.name),e))),show:!0,dataType:"money"}),mergeObject(e,{tradeFriend:{img:t.img,name:t.name,inventory:i,money:a.money}})}else mergeObject(e,{tradeFriend:{inventory:[],money:{coins:[]}}})}prepareSellPrices(e,t){for(const[a,s]of Object.entries(e))for(const e of s.items)e.calculatedPrice=Number(parseFloat(""+this.getItemPrice(e)*t).toFixed(2));return e}};class SelectTradefriendDialog extends Dialog{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{}),e}static async getDialog(e){const t=game.user.isGM?await game.dsa5.apps.gameMasterMenu.getTrackedHeros():game.actors.filter((e=>e.isOwner)),a=new SelectTradefriendDialog({title:game.i18n.localize("DIALOG.setTargetToUser"),content:await renderTemplate("systems/dsa5/templates/dialog/selectTradeFriend.html",{users:t}),default:"yes",buttons:{}});return a.actor=e,a}activateListeners(e){super.activateListeners(e),e.find(".combatant").click((e=>this.setTargetToUser(e)))}setTargetToUser(e){this.actor.setTradeFriend({_id:e.currentTarget.dataset.id}),this.close()}}class MerchantSheetDSA5 extends(MerchantSheetMixin(ActorSheetdsa5NPC)){}var w=__webpack_require__(538);class PlayerMenuSubApp{static template="";static rulePath={};async _getData(e){return{}}activateListeners(e){}async _renderData(e){const t=await this._getData(e);mergeObject(t,e);return await renderTemplate(this.constructor.template,t)}async prepareApp(e){return{name:game.i18n.localize(`PLAYER.${this.constructor.name}`),view:await this._renderData(e)}}async render(){await game.dsa5.apps.playerMenu.render(!0)}async activateTab(){await game.dsa5.apps.playerMenu.activateTab(game.i18n.localize(`PLAYER.${this.constructor.name}`))}get actor(){return game.dsa5.apps.playerMenu.actor}async _onDrop(e){}}class PlayerMenu extends Application{constructor(e){super(e),this.entityAbilities=[],game.dsa5.apps.PlayerMenuSubApp=PlayerMenuSubApp,this.summoningModifiers=[{id:1,name:"CONJURATION.offensiveImprovement",descr:"CONJURATION.offensiveImprovementDescr",changes:[{key:"system.meleeStats.attack",mode:2,value:2},{key:"system.meleeStats.damage",mode:2,value:4},{key:"system.rangeStats.attack",mode:2,value:2},{key:"system.rangeStats.damage",mode:2,value:4}]},{id:2,name:"CONJURATION.defensiveImprovement",descr:"CONJURATION.defensiveImprovementDescr",changes:[{key:"system.meleeStats.parry",mode:2,value:2},{key:"system.totalArmor",mode:2,value:2},{key:"system.status.wounds.gearmodifier",mode:2,value:10}]},{id:3,name:"CONJURATION.speedImprovement",descr:"CONJURATION.speedImprovementDescr",changes:[{key:"system.status.speed.gearmodifier",mode:2,value:2},{key:"system.status.dodge.gearmodifier",mode:2,value:2}]},{id:4,name:"CONJURATION.magicalImprovement",descr:"CONJURATION.magicalImprovementDescr",changes:[],fun:d.Z.magicalImprovement},{id:5,name:"CONJURATION.resistanceImprovement",descr:"CONJURATION.resistanceImprovementDescr",changes:[{key:"system.status.soulpower.gearmodifier",mode:2,value:2},{key:"system.status.toughness.gearmodifier",mode:2,value:2}]},{id:6,name:"CONJURATION.mentalImprovement",descr:"CONJURATION.mentalImprovementDescr",changes:[{key:"system.characteristics.mu.gearmodifier",mode:2,value:2},{key:"system.characteristics.kl.gearmodifier",mode:2,value:2},{key:"system.characteristics.in.gearmodifier",mode:2,value:2},{key:"system.characteristics.ch.gearmodifier",mode:2,value:2}]},{id:7,name:"CONJURATION.physicalImprovement",descr:"CONJURATION.physicalImprovementDescr",changes:[{key:"system.characteristics.ff.gearmodifier",mode:2,value:2},{key:"system.characteristics.ge.gearmodifier",mode:2,value:2},{key:"system.characteristics.ko.gearmodifier",mode:2,value:2},{key:"system.characteristics.kk.gearmodifier",mode:2,value:2}]}],this.conjurationData={qs:0,consumedQS:0,packageModifier:0,selectedIds:[],selectedEntityIds:[],selectedPackageIds:[],conjurationTypes:{1:game.i18n.localize("CONJURATION.demon"),2:game.i18n.localize("CONJURATION.elemental")},rules:{1:{de:{pack:"dsa5-core.corerules",name:"Beschwörungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}},2:{de:{pack:"dsa5-core.corerules",name:"Beschwörungen"},en:{pack:"dsa5-core.coreenrules",name:"Summoning"}}},conjurationType:1,skills:{1:["invocatioMinima","invocatioMinor","invocatioMaior"].map((e=>game.i18n.localize(`LocalizedIDs.${e}`))),2:["manifesto","elementalServant","callDjinn","servantEarth","servantFlame","servantCold","servantWave","servantCloud","servantOre"].map((e=>game.i18n.localize(`LocalizedIDs.${e}`)))},modifiers:{1:this.summoningModifiers,2:this.summoningModifiers},moreModifiers:{2:[{name:game.i18n.localize("CONJURATION.groupSummoning"),options:[1,2,3,4,5,6,7,8].map((e=>({name:e,val:-2*e+2})))}]},postFunction:{}},this.subApps=[]}registerSubApp(e){this.subApps.push(e)}async rollConjuration(e){if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("CONJURATION.dragConjuration"));const t=$(e.currentTarget).closest(".item").attr("data-item-id"),a=this.actor.items.get(t),s=[{name:game.i18n.localize("conjuringDifficulty"),value:getProperty(this.conjuration,"system.conjuringDifficulty.value")||0,selected:!0}];if(this.conjurationData.packageModifier&&s.push({name:game.i18n.localize("summoningPackage"),value:this.conjurationData.packageModifier,selected:!0}),this.conjurationData.moreModifiers[this.conjurationData.conjurationType]){const e=this.conjurationData.moreModifiers[this.conjurationData.conjurationType].filter((e=>e.selected));for(const t of e)s.push({name:t.name,value:Number(t.selected),selected:!0})}this.actor.setupSkill(a,{moreModifiers:s,subtitle:` (${this.conjuration.name})`},void 0).then((async e=>{const t=await this.actor.basicTest(e);this.conjurationData.qs=t.result.qualityStep||0,this.render(!0)}))}activateListeners(e){super.activateListeners(e),(0,l.Ee)(e),e.find(".conjurationData").change((e=>{const t=$(e.currentTarget);setProperty(this.conjurationData,t.attr("name"),t.val()),t.attr("data-refresh")&&this.render()})),e.find(".skill-select").click((e=>this.rollConjuration(e))),e.find(".initLibrary").click((async e=>{$(e.currentTarget).html('<i class="fas fa-spin fa-spinner"></i>'),await game.dsa5.itemLibrary.buildEquipmentIndex(),this.render()})),e.find(".item-edit").click((e=>{const t=$(e.currentTarget).closest(".item").attr("data-item-id");this.actor.items.get(t).sheet.render(!0)})),e.find(".selectableRow").click((e=>this.selectImprovement(e))),e.find(".finalizeConjuration").click((()=>this.finalizeConjuration())),e.find(".ruleLink").click((e=>this.openRules(e))),e.find(".openChar").click((()=>{this.actor?.sheet.render(!0)})),e.find(".showEntity").click((e=>{e.stopPropagation();(async()=>{(await fromUuid(e.currentTarget.dataset.uuid)).sheet.render(!0)})()})),e.find(".moreModifiers").change((e=>{this.conjurationData.moreModifiers[this.conjurationData.conjurationType].find((t=>t.name==e.currentTarget.dataset.name)).selected=$(e.currentTarget).val()}));for(let t of this.subApps)t.activateListeners(e)}async openRules(e){const t=e.currentTarget.dataset.subapp,a=(t?this.subApps.find((e=>e.constructor.name==t)).constructor.rulePath:this.conjurationData.rules[this.conjurationData.conjurationType])[game.i18n.lang];(async()=>{const e=game.packs.get(a.pack),t=await e.getDocuments({name:a.name});for(let e of t)e.sheet.render(!0)})()}finalizeConjuration(){if(!this.conjurationData)return;if(!this.conjuration)return ui.notifications.warn(game.i18n.localize("DSAError.noConjurationActive"));const e={source:this.conjuration.toObject(),creationData:{type:this.conjurationData.conjurationType,typeName:this.conjurationData.conjurationTypes[this.conjurationData.conjurationType],qs:this.conjurationData.qs,consumedQS:this.conjurationData.consumedQS,modifiers:this.conjurationData.modifiers[this.conjurationData.conjurationType].filter((e=>this.conjurationData.selectedIds.includes(e.id))),entityIds:this.conjurationData.selectedEntityIds,packageIds:this.conjurationData.selectedPackageIds},summoner:{name:this.actor.name,img:this.actor.img}};game.user.isGM?PlayerMenu.createConjuration(e):(game.socket.emit("system.dsa5",{type:"summonCreature",payload:e}),ui.notifications.notify(game.i18n.localize("CONJURATION.requestSend")))}static createConjuration({source:e,creationData:t,summoner:a}){new ConjurationRequest(e,a,t).render(!0)}selectImprovement(e){$(e.currentTarget).toggleClass("selected");const t=[],a=[],s=[];let i=0,n=0;$(this._element).find(".selectableRow.selected").each(((e,r)=>{r.dataset.entityid?(a.push(r.dataset.id),i+=-1*(Number(r.dataset.qs)||0)):r.dataset.packageid?(s.push(r.dataset.id),n+=Number(r.dataset.mod)||0):t.push(Number(r.dataset.id))})),this.conjurationData.selectedIds=t,this.conjurationData.selectedEntityIds=a,this.conjurationData.selectedPackageIds=s,this.conjurationData.consumedQS=t.length+i,this.conjurationData.packageModifier=n,this.render()}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"summoning"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","playerMenu","sheet"]),width:500,height:740,title:game.i18n.localize("PLAYER.title"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/playermenu.html",e.resizable=!0,e}_canDragDrop(e){return!0}async _onDrop(e){let t;try{switch(t=JSON.parse(e.dataTransfer.getData("text/plain")),t.type){case"Actor":t=await Actor.implementation.fromDropData(t);break;case"Item":t=await Item.implementation.fromDropData(t)}}catch(e){return!1}if("Actor"==t.documentName){const a=game.actors.get(t.id);if("creature"==a.type||$(e.target).closest(".summoningArea").length>0){if(this.conjuration=a,this.conjurationData.selectedIds=[],this.conjurationData.selectedEntityIds=[],this.conjurationData.selectedPackageIds=[],"creature"==a.type)for(const e of Object.keys(this.conjurationData.conjurationTypes))if(a.system.creatureClass.value.includes(this.conjurationData.conjurationTypes[e])){this.conjurationData.conjurationType=e;break}}else this.trackedId=t.id,this.actor=a;this.render(!0)}else for(let e of this.subApps){if(!0===await e._onDrop(t))break}}async prepareEntityAbilities(){const e={entityAbilities:[],entityPackages:[]};if(game.dsa5.itemLibrary.equipmentBuild){const t=[game.i18n.localize("LocalizedIDs.all"),this.conjurationData.conjurationTypes[this.conjurationData.conjurationType]],a=await Promise.all((await game.dsa5.itemLibrary.getCategoryItems("trait",!1)).map((e=>e.getItem())));let s=new Set,i=new Set;for(const n of a)n.system.distribution&&t.some((e=>n.system.distribution.includes(e)))&&("entity"!=n.system.traitType.value||s.has(n.name)?"summoning"!=n.system.traitType.value||i.has(n.name)||(i.add(n.name),e.entityPackages.push(n)):(s.add(n.name),e.entityAbilities.push(n)))}return e}async getData(e){const t=await super.getData(e);if(game.user.isGM||this.actor||(this.actor=game.user.character),this.actor){const e=this.conjurationData.qs-this.conjurationData.consumedQS+1,a=game.dsa5.itemLibrary.equipmentBuild,{entityAbilities:s,entityPackages:i}=await this.prepareEntityAbilities(),n=await renderTemplate("systems/dsa5/templates/system/conjuration/summoning.html",{actor:this.actor,conjuration:this.conjuration||{name:game.i18n.localize("CONJURATION.dragConjuration"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,services:e,conjurationModifiers:this.conjurationData.modifiers[this.conjurationData.conjurationType],equipmentIndexLoaded:a,entityAbilities:s,entityPackages:i,moreModifiers:this.conjurationData.moreModifiers[this.conjurationData.conjurationType]}),r=this.actor.items.filter((e=>this.conjurationData.skills[this.conjurationData.conjurationType].includes(e.name)&&["liturgy","ceremony","spell","ritual"].includes(e.type))).map((e=>e.toObject()));mergeObject(t,{conjurationSheet:n,conjurationskills:r})}return mergeObject(t,{actor:this.actor||{name:game.i18n.localize("CONJURATION.dragActor"),img:"icons/svg/mystery-man-black.svg"},conjurationData:this.conjurationData,conjurationTypes:this.conjurationData.conjurationTypes}),await this.prepareSubApps(t),t}async prepareSubApps(e){e.subApps=[];for(let t of this.subApps)e.subApps.push(await t.prepareApp(e))}}class ConjurationRequest extends w.Z{constructor(e,t,a){super({title:`${game.i18n.localize("CONJURATION.request")} (${t.name})`,default:"ok",buttons:{}}),this.conjuration=e,this.summoner=t,this.creationData=a,this.confirmed=!1}async getData(e){const t=await super.getData(e);return mergeObject(t,{conjuration:this.conjuration,summoner:this.summoner,confirmed:this.confirmed,services:this.creationData.qs-this.creationData.consumedQS+1,creationData:this.creationData,conjurationModifiers:this.creationData.modifiers,entityModifiers:await Promise.all(this.creationData.entityIds.map((e=>fromUuid(e)))),packageModifiers:await Promise.all(this.creationData.packageIds.map((e=>fromUuid(e)))),actor:this.actor}),t}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog"]),width:470}),e.template="systems/dsa5/templates/system/conjuration/request.html",e}async createActor(){this.confirmed=!0;const t=await e.Z.getFolderForType("Actor",null,game.i18n.localize("PLAYER.conjuration")),a=await e.Z.getFolderForType("Actor",t.id,this.creationData.typeName),s=this.creationData.qs-this.creationData.consumedQS+1;this.conjuration.folder=a.id,this.conjuration.effects||(this.conjuration.effects=[]);for(let e of this.creationData.modifiers)this.conjuration.effects.push({changes:e.changes,duration:{},icon:"icons/svg/aura.svg",label:game.i18n.localize(e.name),flags:{dsa5:{value:null,editable:!0,description:`${game.i18n.localize("PLAYER.conjuration")} ${game.i18n.localize("extensions")}`,custom:!0,auto:null,manual:0,hideOnToken:!0,hidePlayers:!1}}}),e.fun&&e.fun(this.conjuration,this.creationData);const i=(await Promise.all(this.creationData.entityIds.map((e=>fromUuid(e))))).map((e=>e.toObject(!1))),n=(await Promise.all(this.creationData.packageIds.map((e=>fromUuid(e))))).map((e=>e.toObject(!1)));this.conjuration.effects.push({changes:[],duration:{},icon:"icons/svg/aura.svg",id:"services",name:game.i18n.localize("PLAYER.services"),flags:{dsa5:{value:s,editable:!0,max:500,description:`${game.i18n.localize("PLAYER.conjuration")} ${game.i18n.localize("PLAYER.services")}`,manual:s,auto:0,hideOnToken:!0,hidePlayers:!1}}}),game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type]&&await game.dsa5.apps.playerMenu.conjurationData.postFunction[this.creationData.type](this.conjuration,this.creationData.qs-this.creationData.consumedQS,this.creationData.type),"creature"!=this.conjuration.type||this.conjuration.system.creatureClass.value.includes(this.creationData.typeName)||(this.conjuration.system.creatureClass.value+=`, ${this.creationData.typeName}`),this.actor=await o.Z.create(this.conjuration);const r=[...i,...n].filter((e=>!this.conjuration.items.find((t=>t.type==e.type&&e.name==t.name))));await this.actor.createEmbeddedDocuments("Item",r);for(let e of n)await h.Z.traitAdded(this.actor,e);for(let e of i)await h.Z.traitAdded(this.actor,e);await this.actor.update({"system.status.wounds.value":this.actor.system.status.wounds.max});const l=await renderTemplate("systems/dsa5/templates/system/conjuration/chat.html",{actor:this.actor,modifiers:this.creationData.modifiers,summoner:this.summoner,summonerImg:b.Z.videoOrImgTag(this.summoner.img),conjureImg:b.Z.videoOrImgTag(this.actor.img),services:s});await ChatMessage.create(e.Z.chatDataSetup(l)),this.render()}activateListeners(e){super.activateListeners(e),e.find(".createActor").click((()=>{this.createActor()})),e.on("mousedown",".newNPC",(async e=>{const t=e.currentTarget.dataset.id;2==e.button&&(game.actors.get(t).delete(),$(e.currentTarget).remove())})),e.on("click",".newNPC",(async e=>{const t=e.currentTarget.dataset.id;game.actors.get(t).sheet.render(!0)})),e.on("dragstart",".newNPC",(e=>{e.stopPropagation();let t={type:"Actor",uuid:e.currentTarget.dataset.uuid};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(t))})),e.find(".showEntity").click((e=>{e.stopPropagation();(async()=>{(await fromUuid(e.currentTarget.dataset.uuid)).sheet.render(!0)})()}))}}var _=__webpack_require__(903);const dropToGround=async(t,a,s,i)=>{if(game.user.isGM){let n=await game.dsa5.apps.DSA5_Utility.allMoneyItems(),r=await e.Z.getFolderForType("Actor",null,"Dropped Items");const o=game.users.filter((e=>!e.isGM)).map((e=>e.id)).reduce(((e,t)=>(e[t]=1,e)),{default:0}),l=a.toObject();l.system.quantity.value=i,d.Z.obfuscateDropData(l,s.tabsinvisible),getProperty(l,"system.worn.value")&&(l.system.worn.value=!1);const c={type:"npc",name:a.name,img:a.img,prototypeToken:{img:a.img,width:.4,height:.4},ownership:o,items:[...n,l],flags:{core:{sheetClass:"dsa5.MerchantSheetDSA5"}},folder:r,system:{merchant:{merchantType:"loot",temporary:!0,hidePlayer:1},status:{wounds:{value:16}}}},m=await game.dsa5.entities.Actordsa5.create(c),u=await m.getTokenDocument({x:s.x,y:s.y,hidden:!1});if(!canvas.dimensions.rect.contains(u.x,u.y))return!1;if(t){await canvas.scene.createEmbeddedDocuments("Token",[u],{noHook:!0});const e=a.system.quantity.value-i;e<1?await t.deleteEmbeddedDocuments("Item",[a.id]):await t.updateEmbeddedDocuments("Item",[{_id:a.id,"system.quantity.value":e}])}else await canvas.scene.createEmbeddedDocuments("Token",[u])}else{const e={itemId:a.uuid,sourceActorId:t?.id,data:s,amount:i};game.socket.emit("system.dsa5",{type:"itemDrop",payload:e})}},connectHook=()=>{Hooks.on("dropCanvasData",(async(e,a)=>{if(game.settings.get("dsa5","enableItemDropToCanvas")||game.user.isGM||a.tokenId)return"Item"==a.type?((async(e,a)=>{const s=await Item.implementation.fromDropData(a),i=s.parent;if(!t.Z.equipmentCategories.includes(s.type))return;const n=await renderTemplate("systems/dsa5/templates/dialog/dropToGround.html",{name:s.name,count:s.system.quantity.value});new DropToGroundDialog({title:a.name,content:n,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:async e=>dropToGround(i,s,a,Number(e.find('[name="count"]').val()))},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)})(0,a),!1):"GroupDrop"==a.type?((async(e,t)=>{let a=t.x,s=t.y,i=0;const n=e.grid.size,r=Math.ceil(Math.sqrt(t.ids.length));for(let o of t.ids){const l=game.actors.get(o);if(!l)continue;const c=await l.getTokenDocument({x:a,y:s,hidden:!1});c.constructor.create(c,{parent:e.scene}),r%i==0&&i>0?(s+=n,a=t.x):a+=n,i++}})(e,a),!1):void 0}))};class DropToGroundDialog extends Dialog{activateListeners(e){super.activateListeners(e),e.find('input[type="range"]').change((e=>{$(e.currentTarget).closest(".row-section").find(".range-value").html($(e.currentTarget).val())}))}}var S=__webpack_require__(846);class DidYouKnow{static fadeOut=!0;static async stopFade(e){e.stopPropagation(),e.preventDefault(),this.fadeOut?(this.fadeOut=!1,$(e.currentTarget).find("i").removeClass("fa-stop").addClass("fa-angle-right"),$(".didYouKnow").off("click"),$(".didYouKnow .closeDidYou").click((()=>$(".didYouKnow").remove()))):fetch(`systems/dsa5/lazy/didyouknow/${game.i18n.lang}.json`).then((async e=>e.json())).then((async e=>{const t=e.data[Math.floor(Math.random()*e.data.length)],a=await renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:t,fadeOut:DidYouKnow.fadeOut});$("body").find(".didYouKnow").replaceWith(a),DidYouKnow.activateListeners()}))}static activateListeners(){$(".didYouKnow .stopFade").click((async e=>await this.stopFade(e))),$(".didYouKnow").click((()=>$(".didYouKnow").remove())),$(".didYouKnow").fadeIn()}static async showOneMessage(e=8e3){game.settings.get("dsa5","disableDidYouKnow")||fetch(`systems/dsa5/lazy/didyouknow/${game.i18n.lang}.json`).then((async e=>e.json())).then((async t=>{const a=t.data[Math.floor(Math.random()*t.data.length)],s=await renderTemplate("systems/dsa5/templates/system/didyouknow.html",{msg:a,fadeOut:DidYouKnow.fadeOut});$("body").append(s),this.activateListeners(),setTimeout((function(){DidYouKnow.fadeOut&&$(".didYouKnow").fadeOut(1e3,(()=>$(".didYouKnow").remove()))}),e)}))}}class DSA5CombatTracker extends CombatTracker{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"/systems/dsa5/templates/system/combattracker.html"})}activateListeners(e){super.activateListeners(e),e.find(".combatant.actor .aggroButton").click((e=>{e.preventDefault(),e.stopPropagation(),DSA5CombatTracker.runActAttackDialog()}))}static runActAttackDialog(){if(!game.combat)return;const e=game.combat.combatant;(game.user.isGM||e.isOwner)&&D.HS.showDialog(e.actor,e.tokenId)}async getData(e){const t=await super.getData(e);for(let e of t.turns){const a=t.combat.turns.find((t=>t.id==e.id)),s=game.user.isGM||a.actor&&a.actor.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects");e.defenseCount=a.getFlag("dsa5","defenseCount")||0,e.actionCount=Number(getProperty(a,"actor.system.actionCount.value"))||0,e.actionCounts=`${e.actionCount} ${game.i18n.localize("actionCount")}`;let i=[];if(a.actor)for(const e of a.actor.items)if("rangeweapon"==e.type&&e.system.worn.value&&e.system.reloadTime.progress>0){const t={name:e.name,remaining:o.Z.calcLZ(e,a.actor)-e.system.reloadTime.progress};t.remaining>0&&i.push(t)}else if(["spell","liturgy"].includes(e.type)&&e.system.castingTime.modified>0){const t={name:e.name,remaining:e.system.castingTime.modified-e.system.castingTime.progress};t.remaining>0&&i.push(t)}i=i.sort(((e,t)=>e.remaining-t.remaining)),i.length>0&&(e.ongoings=`${game.i18n.localize("COMBATTRACKER.ongoing")}<br>${i.map((e=>`${e.name} - ${e.remaining}`)).join("<br>")}`,e.ongoing=i[0].remaining),e.effects=new Set,a.token&&(a.token.effects.forEach((t=>e.effects.add(t))),a.token.overlayEffect&&e.effects.add(a.token.overlayEffect)),a.actor&&a.actor.temporaryEffects.forEach((t=>{t.statuses.has(CONFIG.Combat.defeatedStatusId)?e.defeated=!0:!t.icon||!s||t.notApplicable||!game.user.isGM&&t.getFlag("dsa5","hidePlayers")||t.getFlag("dsa5","hideOnToken")||e.effects.add(t.icon)}))}return t}}class DSA5Combat extends Combat{constructor(e,t){super(e,t)}async refreshTokenbars(){game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.updateDSA5Hotbar()}_onCreate(e,t,a){super._onCreate(e,t,a),this.refreshTokenbars()}_onDelete(e,t){super._onDelete(e,t),this.refreshTokenbars()}async nextRound(){if(game.user.isGM)for(let e of this.turns)await e.setFlag("dsa5","defenseCount",0);else await game.socket.emit("system.dsa5",{type:"clearCombat",payload:{}});return await super.nextRound()}async getDefenseCount(e){const t=this.getCombatantFromActor(e);return t&&t.getFlag("dsa5","defenseCount")||0}getCombatantFromActor(e){let t;return t=e.token?Array.from(this.combatants).find((t=>t.tokenId==e.token)):Array.from(this.combatants).find((t=>t.actorId==e.actor)),t?this.combatants.get(t.id):void 0}async updateDefenseCount(e){if(game.user.isGM){const t=this.getCombatantFromActor(e);t&&!getProperty(t.actor,"system.config.defense")&&await t.setFlag("dsa5","defenseCount",(t.getFlag("dsa5","defenseCount")||0)+1)}else await game.socket.emit("system.dsa5",{type:"updateDefenseCount",payload:{speaker:e}})}}class DSA5Combatant extends Combatant{constructor(e,t){null==e.flags&&(e.flags={}),mergeObject(e.flags,{dsa5:{defenseCount:0}}),super(e,t)}async recalcInitiative(){if(this.initiative){const e={initiative:(await this.getFlag("dsa5","baseRoll")||0)+this.actor.system.status.initiative.value};await this.update(e)}}}Hooks.on("preCreateCombatant",((t,a,s)=>{const i=e.Z.getSpeaker({actor:t.actorId,scene:t.sceneId,token:t.token_id});if("loot"==getProperty(i.system,"merchant.merchantType"))return!1})),Hooks.on("updateCombatant",((e,t,a)=>{if(game.user.isGM)if(t.initiative){if(!e.getFlag("dsa5","baseRoll")){const a=`${t.initiative}`.split("."),s=Number(a[0])-Math.round(e.actor.system.status.initiative.value);e.setFlag("dsa5","baseRoll",s)}}else"initiative"in t&&null==t.initiative&&e.update({"flags.dsa5.-=baseRoll":null})}));class RepeatingEffectsHelper{static async updateCombatHook(e,t,a,s){(t.round||t.turn)&&0!=e.round&&e.turns&&e.active&&e.previous.round<e.current.round&&await RepeatingEffectsHelper.startOfRound(e)}static async startOfRound(e){const t=game.users.find((e=>e.active&&e.isGM));if(t&&game.user.id==t.id)for(let t of e.turns)if(!t.defeated){for(let a of t.actor.effects){if(a.disabled)continue;const s=[...a.statuses][0];"bleeding"==s?await this.applyBleeding(t,e):"burning"==s&&await this.applyBurning(t,a,e)}await this.startOfRoundEffects(t,e)}}static async startOfRoundEffects(e,t){const a=["wounds","astralenergy","karmaenergy"];for(const s of a)for(const a of e.actor.system.repeatingEffects.startOfRound[s]){if(getProperty(e.actor.system.repeatingEffects,`disabled.${s}`))continue;const i=await new Roll(a.value).evaluate({async:!0}),n=await i.render(),r=game.i18n.localize(i.total>0?"CHATNOTIFICATION.regenerates":"CHATNOTIFICATION.getsHurt"),o=`${e.actor.name} ${r} ${game.i18n.localize(s)} ${n}`;await this.sendEventMessage(o,t,e),"wounds"==s?await e.actor.applyDamage(-1*i.total):await e.actor.applyMana(-1*i.total,"astralenergy"==s?"AsP":"KaP")}}static async applyBleeding(e,t){if(e.actor.system.status.wounds.value<1)return;const a=game.i18n.format("CHATNOTIFICATION.bleeding",{actor:e.actor.name});await this.sendEventMessage(a,t,e),await e.actor.applyDamage(1)}static async applyBurning(e,t,a){if(e.actor.system.status.wounds.value<1)return;const s=Number(t.getFlag("dsa5","value")),i={0:"1",1:"1d3",2:"1d6",3:"2d6"}[s-r.Z.resistantToEffect(e.actor,t)]||"1",n=await new Roll(i).evaluate({async:!0}),o=await n.render(),l=game.i18n.format(`CHATNOTIFICATION.burning.${s}`,{actor:e.actor.name,damage:o});await this.sendEventMessage(l,a,e),await e.actor.applyDamage(n.total)}static async sendEventMessage(t,a,s){if(game.settings.get("dsa5","hideRegenerationToOwner")){const i=a.combatants.get(s.id).players;i.push(...game.users.filter((e=>e.isGM)).map((e=>e.id))),await ChatMessage.create(e.Z.chatDataSetup(t,void 0,void 0,i))}else await ChatMessage.create(e.Z.chatDataSetup(t))}}Hooks.on("updateCombat",RepeatingEffectsHelper.updateCombatHook);class DSAIniTracker extends Application{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","initTracker"]),template:"systems/dsa5/templates/system/initracker.html",dragDrop:[{dragSelector:".iniItem",dropSelector:[".iniTrackerList"]}],top:100,left:170,title:"DSAIniTracker",itemWidth:game.settings.get("dsa5","iniTrackerSize"),actorCount:game.settings.get("dsa5","iniTrackerCount"),position:game.settings.get("dsa5","iniTrackerPosition")}),e}setPosition({left:e,top:t,width:a,height:s,scale:i}={}){const n=super.setPosition({left:e,top:t,width:a,height:s,scale:i}),r=this.element[0];if(!r.style.width||a){const t=a||r.offsetWidth,s=r.style.maxWidth||window.innerWidth;n.width=a=Math.clamped(t,0,s),r.style.width=a+"px",a+n.left>window.innerWidth&&(e=n.left)}return game.settings.set("dsa5","iniTrackerPosition",{left:n.left,top:n.top}),n}static connectHooks(){Hooks.on("renderDSA5CombatTracker",((e,t,a)=>{game.settings.get("dsa5","enableCombatFlow")&&(game.combat?(game.dsa5.apps.initTracker||(game.dsa5.apps.initTracker=new DSAIniTracker),game.dsa5.apps.initTracker.updateTracker(a)):game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0))}))}updateTracker(e){this.combatData=e,this.render(!0,{focus:!1})}async getData(e){const t=this.combatData,a=DSAIniTracker.defaultOptions.itemWidth,s=DSAIniTracker.defaultOptions.actorCount,i=t.round,n=t.turns,r=[],o=game.settings.get("core",Combat.CONFIG_SETTING).skipDefeated,l=n.some((e=>e.active));let c=t.turns.some((e=>e.owner&&!e.hasRolled&&(!game.user.isGM||t.combat.combatants.get(e.id).isNPC)));if(n.length){const e=[];let a,c=s,d=!1,m=-1,u=0,g=0;for(;0!=c&&g!=s;){const s=duplicate(n[u]),p=t.combat.combatants.get(s.id);d&&u==m&&(s.css=s.css.replace("active","")),!i||s.active&&!d||!l&&!d?(d=!0,m=u):p.getFlag("dsa5","waitInit")!=t.round+g||p.defeated||!game.user.isGM&&p.hidden||r.push(s),!d||o&&p.defeated||!game.user.isGM&&p.hidden||(s.round=t.round+g,s.owner&&p.token?.actor&&(s.maxLP=p.token.actor.system.status.wounds.max,s.currentLP=p.token.actor.system.status.wounds.value),a&&a!=s.round&&(s.newRound="newRound"),a=s.round,e.push(s),c--),u++,u>=n.length&&(u=0,g++)}t.turns=e}return this.position.width=a*s+3*s+80,this.position.height=a+10,mergeObject(t,{itemWidth:a,unRolled:c,waitingTurns:r}),this.conditionalPanToCurrentCombatant(t),t}hasChangedTurn(e){const t=e.turn!=this.lastTurnUpdate||e.round!=this.lastRoundUpdate;return this.lastTurnUpdate=e.turn,this.lastRoundUpdate=e.round,t}async conditionalPanToCurrentCombatant(e){if(!game.settings.get("dsa5","enableCombatPan"))return;const t=e.turns[0];if(!t)return;const a=e.combat.combatants.get(t.id);a&&this.hasChangedTurn(e)&&setTimeout((()=>{const e=a.token;e&&e.object&&e.object.isVisible&&(canvas.animatePan({x:e.x,y:e.y}),a.actor&&a.actor.isOwner&&e.object.control({releaseOthers:!0}))}),300)}async _onWheelResize(e){let t=game.settings.get("dsa5","iniTrackerSize");t=e.originalEvent.deltaY>0?Math.min(140,t+5):Math.max(30,t-5),await game.settings.set("dsa5","iniTrackerSize",t),await this.render(!0)}activateListeners(e){super.activateListeners(e);const t=e.find(".dragHandler");new Draggable(this,e,t[0],this.options.resizable),t.on("wheel",(async e=>(e.stopPropagation(),e.preventDefault(),await this._onWheelResize(e),!1))),e.find(".toggleTracker").click((()=>{const e=ui.combat;e.renderPopout(e)})),e.find(".combat-control").click((e=>this._onCombatControl(e)));const a=e.find(".iniItem");a.hover(this._onCombatantHoverIn.bind(this),this._onCombatantHoverOut.bind(this)),a.click(this._onCombatantMouseDown.bind(this)),e.find(".waitingTackerList .iniItem").mousedown((e=>this._onRightClick(e))),e.find(".combatant-control").click((e=>this._onCombatantControl(e))),e.find(".combatant .aggroButton").click((e=>{e.preventDefault(),e.stopPropagation(),DSA5CombatTracker.runActAttackDialog()})),e.find(".rollMine").click((e=>this.rollMyChars())),game.user.isGM&&e.find(".rolledInit").click((e=>this.editCombatant(e)))}rollMyChars(){game.user.isGM?this._getCombatApp().viewed.rollNPC({}):this._getCombatApp().viewed.rollAll({})}_onRightClick(e){if(2==e.button){const t=game.combat.combatants.get(e.currentTarget.dataset.combatantId);t.isOwner&&t.unsetFlag("dsa5","waitInit")}}editCombatant(e){this._getCombatApp()._onConfigureCombatant($(e.currentTarget))}_onCombatantControl(e){this._getCombatApp()._onCombatantControl(e)}_onCombatControl(e){"waitInit"==e.currentTarget.dataset.control?this.waitInit(e):this._getCombatApp()._onCombatControl(e)}async waitInit(e){const t=game.combat.combatants.get(game.combat.current.combatantId);await t.setFlag("dsa5","waitInit",game.combat.current.round),e.currentTarget.dataset.control="nextTurn",this._getCombatApp()._onCombatControl(e)}_onCombatantHoverOut(e){this._getCombatApp()._onCombatantHoverOut(e)}_onCombatantHoverIn(e){this._getCombatApp()._onCombatantHoverIn(e)}_onCombatantMouseDown(e){this._getCombatApp()._onCombatantMouseDown(e)}_getCombatApp(){return game.combats.apps[0]}_canDragStart(e){return!1}_canDragDrop(e){return!1}_onDragStart(e){const t=$(e.currentTarget).closestData("combatant-id");e.dataTransfer.setData("text/plain",JSON.stringify({type:"IniChange",combatantId:t}))}_onDrop(e){JSON.parse(e.dataTransfer.getData("text/plain")).type}}var T=__webpack_require__(93),A=__webpack_require__(147);function chat_context(){const fateAvailable=(t,a)=>e.Z.fateAvailable(t,a),canHurt=function(t,a="damage.value"){let s=game.messages.get(t.attr("data-message-id")).flags.opposeData;const i=!!s&&e.Z.getSpeaker(s.speakerDefend)?.isOwner;return((game.user.isGM||i)&&t.find(".opposed-card").length||t.find(".dice-roll").length)&&(getProperty(s,a)||0)>0},canHurtSP=function(e){return canHurt(e,"damage.sp")},canHurtSPDouble=function(e){return!!game.settings.get("dsa5","doubleDamageOptions")&&canHurt(e,"damage.sp")},canHurtDouble=function(e){return!!game.settings.get("dsa5","doubleDamageOptions")&&canHurt(e)},canCostMana=function(e){let t=game.messages.get(e.attr("data-message-id"));if(t.speaker.actor&&t.flags.data){if(game.actors.get(t.speaker.actor).isOwner||game.user.isGM)return["liturgy","ceremony","spell","ritual","magicalsign"].includes(t.flags.data.preData.source.type)||getProperty(t.flags.data.preData,"calculatedSpellModifiers.costsMana")}return!1},canUnhideData=function(e){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){let t=game.messages.get(e.attr("data-message-id"));return"hideData"in t.flags&&t.flags.hideData}return!1},canHideData=function(e){if(game.user.isGM&&game.settings.get("dsa5","hideOpposedDamage")){let t=game.messages.get(e.attr("data-message-id"));return"hideData"in t.flags&&!t.flags.hideData}return!1},canImproveRoll=function(e,t=!1){let a=game.messages.get(e.attr("data-message-id"));if(a.speaker.actor&&a.flags.data&&a.flags.data.postData.successLevel>-2){let e=game.actors.get(a.speaker.actor);if(e.isOwner&&fateAvailable(e,t)){let t=a.flags.data.preData.source.type;const s=a.flags.data.preData.mode||"";["skill","spell","liturgy","ritual","ceremony"].includes(t)&&(t="char");let i=game.i18n.localize(`SCHIPSKILLS.${t}${s}`);return!a.flags.data.fateImproved&&e.items.getName(i)}}return!1},canImproveRollGroup=function(e){return canImproveRoll(e,!0)},canIncreaseQS=function(e,t=!1){let a=game.messages.get(e.attr("data-message-id"));if(a.speaker.actor&&a.flags.data){let e=game.actors.get(a.speaker.actor);if(e.isOwner&&fateAvailable(e,t)&&!a.flags.data.fatePointAddQSUsed)return a.flags.data.postData.successLevel>0&&null!=a.flags.data.postData.qualityStep}return!1},canIncreaseQSGroup=function(e){return canIncreaseQS(e,!0)},isTalented=function(e){let t=game.messages.get(e.attr("data-message-id"));if(t.speaker.actor&&t.flags.data){let e=game.actors.get(t.speaker.actor);if(e.isOwner)return null!=e.items.find((e=>e.name==`${game.i18n.localize("LocalizedIDs.aptitude")} (${t.flags.data.preData.source.name})`))&&!t.flags.data.talentedRerollUsed}return!1},canRerollDamage=function(e,t=!1){let a=game.messages.get(e.attr("data-message-id"));if(a.speaker.actor&&a.flags.data){let e=game.actors.get(a.speaker.actor);if(e.isOwner&&fateAvailable(e,t))return null!=a.flags.data.postData.damageRoll&&!a.flags.data.fatePointDamageRerollUsed}return!1},canRerollDamageGroup=function(e){return canRerollDamage(e,!0)},canReroll=function(e,t=!1){let a=game.messages.get(e.attr("data-message-id"));if(a.speaker.actor&&a.flags.data){let e=game.actors.get(a.speaker.actor);if(e.isOwner&&fateAvailable(e,t))return!(a.flags.data.fatePointRerollUsed||"regenerate"==a.flags.data.postData.rollType)}return!1},canRerollGroup=function(e){return canReroll(e,!0)},canHeal=function(e){let t=game.messages.get(e.attr("data-message-id"));if(t.speaker.actor&&t.flags.data){if(game.actors.get(t.speaker.actor).isOwner&&["LeP","KaP","AsP"].some((e=>null!=getProperty(t.flags,`data.postData.${e}`))))return!t.flags.data.healApplied}return!1},showHideData=function(e){if(game.user.isGM){let t=game.messages.get(e.attr("data-message-id"));if("hideData"in t.flags){let e=!t.flags.hideData,a=$(t.content);a.find(".hideAnchor")[e?"addClass":"removeClass"]("hideData"),a=$("<div></div>").append(a),t.update({content:a.html(),"flags.hideData":e})}}},canApplyDefaultRollsDouble=e=>!!game.settings.get("dsa5","doubleDamageOptions")&&canApplyDefaultRolls(e),canApplyDefaultRolls=e=>{const t=game.messages.get(e.data("messageId"));return!(!t||!canvas.tokens)&&(t.isRoll&&t.isContentVisible&&canvas.tokens.controlled.length&&e.find(".dice-roll").length)},useFate=(e,t,a=0)=>{let s=game.messages.get(e.attr("data-message-id"));game.actors.get(s.speaker.actor).useFateOnRoll(s,t,a)},applyDamage=async(t,a,s=1)=>{const i=game.messages.get(t.attr("data-message-id")),n=i.flags.opposeData,r=n?.speakerDefend,o=e.Z.getSpeaker(r);if(!o.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));await o.applyDamage(n.damage[a]*s);const l={"flags.data.damageApplied":!0,content:i.content.replace(/hideAnchor">/,`hideAnchor"><i class="fas fa-check" style="float:right" data-tooltip="${game.i18n.localize("damageApplied")}"></i>`)};game.user.isGM?await i.update(l):game.socket.emit("system.dsa5",{type:"updateMsg",payload:{id:t.attr("data-message-id"),updateData:l}})},applyChatCardDamage=(e,t,a=1)=>{const s=game.messages.get(e.data("messageId")).rolls[0];return Promise.all(canvas.tokens.controlled.map((e=>{const i=e.actor,n=Math.round(("sp"!=t?s.total-o.Z.armorValue(i).armor:s.total)*a);return i.applyDamage(Math.max(0,n))})))};Hooks.on("getChatLogEntryContext",((t,a)=>{a.push({name:game.i18n.localize("CHATCONTEXT.hideData"),icon:'<i class="fas fa-eye"></i>',condition:canHideData,callback:e=>{showHideData(e)}},{name:game.i18n.localize("CHATCONTEXT.showData"),icon:'<i class="fas fa-eye"></i>',condition:canUnhideData,callback:e=>{showHideData(e)}},{name:game.i18n.localize("regenerate"),icon:'<i class="fas fa-user-plus"></i>',condition:canHeal,callback:async t=>{const a=await game.messages.get(t.attr("data-message-id")),s=e.Z.getSpeaker(a.speaker);if(!s.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));await a.update({"flags.data.healApplied":!0,content:a.content.replace(/<\/div>$/,'<i class="fas fa-check" style="float:right"></i></div>')}),await s.applyRegeneration(a.flags.data.postData.LeP,a.flags.data.postData.AsP,a.flags.data.postData.KaP)}},{name:game.i18n.localize("CHATCONTEXT.ApplyMana"),icon:'<i class="fas fa-user-minus"></i>',condition:canCostMana,callback:async t=>{(async t=>{let a=game.messages.get(t.attr("data-message-id")),s=a.flags.data,i=e.Z.getSpeaker(a.speaker);if(!i.isOwner)return ui.notifications.error(game.i18n.localize("DSAError.DamagePermission"));const n=s.preData.calculatedSpellModifiers.maintainCost.trim(),r=["ritual","spell"].includes(s.preData.source.type)||getProperty(s.preData.calculatedSpellModifiers,"costsMana")?"AsP":"KaP",o=await i.applyMana(s.preData.calculatedSpellModifiers.finalcost,r);if(n&&0!=n&&o&&s.postData.successLevel>0){const e=s.preData.source.name;try{const t=n.match(/^\d{1,3}/)[0];let a=n.replace(/^\d{1,3}/,"").match(/\d{1,3}/);a=a&&Number(a[0])||1;const s={name:`${e} (${game.i18n.localize("maintainCost")})`,icon:"icons/svg/daze.svg",flags:{dsa5:{value:null,editable:!0,description:n,maintain:t,payType:r,custom:!0}},changes:[],duration:{}},o=[{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.combatRounds"),"gi"),seconds:5},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.minutes"),"gi"),seconds:60},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.hours"),"gi"),seconds:3600},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.days"),"gi"),seconds:86400},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.seconds"),"gi"),seconds:1},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.weeks"),"gi"),seconds:604800},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.months"),"gi"),seconds:2592e3},{regEx:new RegExp(game.i18n.localize("DSAREGEXmaintain.years"),"gi"),seconds:3024e4}];for(const e of o)if(e.regEx.test(n)){const t=Number(a)*e.seconds;s.duration.seconds=t,s.duration.rounds=s.duration.seconds/5;break}await i.addCondition(s)}catch(t){console.error(`Could not parse duration '${n}' of '${e}'`)}}await a.update({"flags.data.manaApplied":!0,content:a.content.replace(/<span class="costCheck">/,'<span class="costCheck"><i class="fas fa-check" style="float:right"></i>')})})(t)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:canHurt,callback:e=>{applyDamage(e,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:canHurtSP,callback:e=>{applyDamage(e,"sp")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:canHurtDouble,callback:e=>{applyDamage(e,"value",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:canHurtSPDouble,callback:e=>{applyDamage(e,"sp",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:canApplyDefaultRolls,callback:e=>{applyChatCardDamage(e,"value")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP"),icon:'<i class="fas fa-user-minus"></i>',condition:canApplyDefaultRolls,callback:e=>{applyChatCardDamage(e,"sp")}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamage")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:canApplyDefaultRollsDouble,callback:e=>{applyChatCardDamage(e,"value",2)}},{name:game.i18n.localize("CHATCONTEXT.ApplyDamageSP")+" x2",icon:'<i class="fas fa-user-minus"></i>',condition:canApplyDefaultRollsDouble,callback:e=>{applyChatCardDamage(e,"sp",2)}},{name:game.i18n.localize("CHATCONTEXT.Reroll"),icon:'<i class="fas fa-dice"></i>',condition:canReroll,callback:e=>{useFate(e,"reroll")}},{name:game.i18n.localize("CHATCONTEXT.RerollGroup"),icon:'<i class="fas fa-dice"></i>',condition:canRerollGroup,callback:e=>{useFate(e,"reroll",1)}},{name:game.i18n.localize("CHATCONTEXT.talentedReroll"),icon:'<i class="fas fa-dice"></i>',condition:isTalented,callback:e=>{useFate(e,"isTalented")}},{name:game.i18n.localize("CHATCONTEXT.AddQS"),icon:'<i class="fas fa-plus-square"></i>',condition:canIncreaseQS,callback:e=>{useFate(e,"addQS")}},{name:game.i18n.localize("CHATCONTEXT.AddQSGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:canIncreaseQSGroup,callback:e=>{useFate(e,"addQS",1)}},{name:game.i18n.localize("CHATCONTEXT.rerollDamage"),icon:'<i class="fas fa-dice"></i>',condition:canRerollDamage,callback:e=>{useFate(e,"rerollDamage")}},{name:game.i18n.localize("CHATCONTEXT.rerollDamageGroup"),icon:'<i class="fas fa-dice"></i>',condition:canRerollDamageGroup,callback:e=>{useFate(e,"rerollDamage",1)}},{name:game.i18n.localize("CHATCONTEXT.improveFate"),icon:'<i class="fas fa-plus-square"></i>',condition:canImproveRoll,callback:e=>{useFate(e,"Improve")}},{name:game.i18n.localize("CHATCONTEXT.improveFateGroup"),icon:'<i class="fas fa-plus-square"></i>',condition:canImproveRollGroup,callback:e=>{useFate(e,"Improve",1)}})}))}var C=__webpack_require__(565);function statuseffect(){Token.prototype.drawEffects=async function(){this.effects.removeChildren().forEach((e=>e.destroy())),this.effects.bg=this.effects.addChild(new PIXI.Graphics),this.effects.overlay=null;const e=this.document.effects,t=this.actor?await this.actor.actorEffects():[];let a={src:this.document.overlayEffect,tint:null};if(e.length||t.length){const s=[];for(let e of t){if(!e.icon)continue;const t=Color.from(e.tint??null);e.getFlag("core","overlay")?a={src:e.icon,tint:t}:s.push(this._drawEffect(e.icon,t,getProperty(e,"flags.dsa5.value")))}for(let t of e)s.push(this._drawEffect(t,null));await Promise.all(s)}this.effects.overlay=await this._drawOverlay(a.src,a.tint),this._refreshEffects()},Token.prototype._refreshEffects=function(){let e=0;const t=2*Math.round(canvas.dimensions.size/2/5),a=Math.floor(5*this.document.height),s=this.effects.bg.clear().beginFill(0,.4).lineStyle(1,0);for(const i of this.effects.children)if(i!==s&&!i.isCounter)if(i===this.effects.overlay){const e=Math.min(.6*this.w,.6*this.h);i.width=i.height=e,i.position.set((this.w-e)/2,(this.h-e)/2)}else{if(i.width=i.height=t,i.x=Math.floor(e/a)*t,i.y=e%a*t,s.drawRoundedRect(i.x+1,i.y+1,t-2,t-2,2),i.counter>1&&!i.counterDrawn){let e=game.dsa5.config.effectTextStyle,t=game.settings.get("dsa5","statusEffectCounterColor");e._fill=/^#[0-9A-F]+$/.test(t)?t:"#000000";let a=this.effects.addChild(new PreciseText(i.counter,e));a.x=i.x,a.y=i.y,a.isCounter=!0,i.counterDrawn=!0}e++}},Token.prototype._drawEffect=async function(e,t,a){if(!e)return;let s=await loadTexture(e,{fallback:"icons/svg/hazard.svg"}),i=new PIXI.Sprite(s);return t&&(i.tint=t),i.counter=a,this.effects.addChild(i)},TokenHUD.prototype._onToggleEffect=function(e,{overlay:t=!1}={}){e.preventDefault();let a=e.currentTarget;const s=a.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find((e=>e.id===a.dataset.statusId)):a.getAttribute("src");if(s.flags.dsa5.editable)return 0==e.button?this.object.incrementCondition(s):2==e.button?this.object.decrementCondition(s):void 0},Token.prototype.incrementCondition=async function(e,{active:t,overlay:a=!1}={}){const s=this.actor.effects.find((t=>t.statuses.has(e.id)));return!s||Number.isNumeric(getProperty(s,"flags.dsa5.value"))?await this.actor.addCondition(e.id,1,!1,!1):s&&await this.actor.removeCondition(e.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),t},Token.prototype.decrementCondition=async function(e,{active:t,overlay:a=!1}={}){return this.actor.removeCondition(e.id,1,!1),this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),t};const e=Token.prototype._onClickLeft2;Token.prototype._onClickLeft2=function(t){const a=game.user.isGM||!C.Z.isEnabled||!(e=>!!e&&["merchant","loot"].includes(getProperty(e.system,"merchant.merchantType")))(this.actor)||C.Z.inDistance(this);if(!a)return ui.notifications.warn(game.i18n.localize("DSAError.notInRangeToLoot"));e.call(this,t)}}var M=__webpack_require__(586);class ChangelogForm extends FormApplication{render(){(0,M.j)()}}class ExportForm extends FormApplication{async render(){const e=await renderTemplate("systems/dsa5/templates/dialog/exportConfiguration-dialog.html",{});new Dialog({title:"Export configuration",content:e,default:"yes",buttons:{export:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("Export"),callback:e=>(e=>{let t=Array.from(game.settings.settings);e.find('[name="exportOnlyDSA"]').is(":checked")&&(t=t.filter((e=>/^dsa5\./.test(e[0]))));const a={},s=/(^dsa5\.(selectedActors|trackedActors|groupschips|tokenhotbarPosition|iniTrackerPosition|migrationVersion)$|^dsa5\.breadcrumbs_)/;for(const e of t){if(s.test(e[0]))continue;let t=e[0].split(".");const i=t.shift(),n=t.join(".");a[e[0]]=game.settings.get(i,n)}saveDataToFile(JSON.stringify(a,null,2),"text/json","fvtt-DSA5-Configuration.json")})(e)},import:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Import"),callback:e=>(async e=>{const t=e.find("form")[0];if(!t.data.files.length)return ui.notifications?.error("You did not upload a data file!");readTextFromFile(t.data.files[0]).then((async e=>{const t=JSON.parse(e),a=Array.from(game.settings.settings).map((e=>e[0]));for(const e of Object.keys(t))if(a.includes(e)){let a=e.split(".");const s=a.shift(),i=a.join(".");await game.settings.set(s,i,t[e])}game.settings.sheet.render(!0)}))})(e)}}}).render(!0)}}class ConfigureTokenHotbar extends FormApplication{get template(){return"systems/dsa5/templates/dialog/configureTokenhotbar.html"}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{title:game.i18n.localize("DSASETTINGS.configureTokenbar")}),e}activateListeners(e){super.activateListeners(e),e.find(".resetTokenhotbar").click((e=>this.resetTokenHotbar(e))),e.find("select, input").change((async e=>{const t=e.currentTarget.name.split(".");let a="Number"==e.currentTarget.dataset.dtype?Number(e.currentTarget.value):e.currentTarget.value;"checkbox"==e.currentTarget.type&&(a=e.currentTarget.checked),await game.settings.set(t[0],t[1],a),game.dsa5.apps.tokenHotbar?.render(!0)})),e.find(".bags .slot").click((e=>this._onMasterFunctionClicked(e)))}async _onMasterFunctionClicked(e){const t=e.currentTarget.dataset.id,a=game.settings.get("dsa5","enableMasterTokenFunctions");a[t]=!a[t],await game.settings.set("dsa5","enableMasterTokenFunctions",a),$(e.currentTarget).toggleClass("deactivated",a[t]),game.dsa5.apps.tokenHotbar.gmItems.find((e=>e.id==t)).disabled=a[t],game.dsa5.apps.tokenHotbar?.render(!0)}async getData(e){const t=await super.getData(e);return mergeObject(t,{tokenhotbarSize:game.settings.get("dsa5","tokenhotbarSize"),tokenhotbarLayout:game.settings.get("dsa5","tokenhotbarLayout"),disableTokenhotbarMaster:game.settings.get("dsa5","disableTokenhotbarMaster"),disableTokenhotbar:game.settings.get("dsa5","disableTokenhotbar"),isGM:game.user.isGM,gmButtons:game.dsa5.apps.tokenHotbar.gmItems}),t}async resetTokenHotbar(e){e.preventDefault(),e.stopPropagation(),await game.settings.set("dsa5","tokenhotbarPosition",{}),await game.settings.set("dsa5","tokenhotbarLayout",0),await game.settings.set("dsa5","tokenhotbarSize",35),game.dsa5.apps.tokenHotbar?.resetPosition(),game.dsa5.apps.tokenHotbar?.render(!0)}}async function increaseFontSize(e){let a=game.settings.get("dsa5","journalFontSizeIndex")+1;a==t.Z.journalFontSizes.length+1?(a=0,await game.settings.set("dsa5","journalFontSizeIndex",a),e.css("fontSize",""),(0,l.p0)(game.i18n.format("CHATNOTIFICATION.fontsize",{size:"Default "}))):(await game.settings.set("dsa5","journalFontSizeIndex",a),function setOuterFontSize(e){const a=game.settings.get("dsa5","journalFontSizeIndex"),s=t.Z.journalFontSizes[a-1]||14;(0,l.p0)(game.i18n.format("CHATNOTIFICATION.fontsize",{size:s})),e.css("fontSize",`${s}px`)}(e))}function tokenHUD(){Hooks.on("renderTokenHUD",((e,t,a)=>{const s=e.object.actor;s&&(!function addThirdBarToHUD(e,t,a){if(t.system.isPriest&&t.system.isMage){let s=`<div class="attribute bar3"><input type="text" name="system.status.karmaenergy.value" value="${t.system.status.karmaenergy.value}"></div>`;e.find(".col.middle").prepend(s),e.find(".bar3 input").change((async e=>{const s=e.currentTarget;let i=s.value.trim(),n=i.startsWith("+")||i.startsWith("-");i.startsWith("=")&&(i=i.slice(1));let r=Number(i);const o=s.name.split(".").reduce(((e,t)=>e[t]),t);await t.update({[s.name]:n?o+r:r}),a.clear()}))}}(t,s,e),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.lightHud(t,s,a)),t.find('.control-icon[data-action="target"]').mousedown((e=>{2==e.button&&(game.user.updateTokenTargets([]),$(e.currentTarget).click(),e.preventDefault())})),t.find(".attribute input").off("change"),g.Z.renderTokenHUD(e,t,a)}))}var I=__webpack_require__(416);const combatTurn=e=>{game.combat?.combatant?.isOwner&&game.combat[e]()};class BookWizard extends Application{static wizard;constructor(e){super(e),this.adventures=[],this.books=[],this.rshs=[],this.fulltextsearch=!0}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"description"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","noscrollWizard","bookWizardsheet"]),width:800,height:880,template:"systems/dsa5/templates/wizard/adventure/adventure_wizard.html",title:game.i18n.localize("Book.Wizard"),resizable:!0,dragDrop:[{dragSelector:".item-list .item",dropSelector:null}]}),e}static initHook(){BookWizard.wizard=new BookWizard,game.dsa5.apps.journalBrowser=BookWizard.wizard,Hooks.on("renderJournalDirectory",((e,t)=>{let a=$('<div class="header-actions action-buttons flexrow"></div>'),s=$(`<button id="openJournalBrowser"><i class="fa fa-book"></i>${game.i18n.localize("Book.Wizard")}</button>`);s.click((()=>{BookWizard.wizard.render(!0)})),a.append(s),t.find(".header-actions:first-child").after(a)}))}_getHeaderButtons(){let e=super._getHeaderButtons();return e.unshift({class:"increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>increaseFontSize($(this._element).find(".chapter"))}),e.unshift({label:"Library",class:"library",icon:"fas fa-book",onclick:async e=>this._showBooks()}),e}async _render(e=!1,t={}){await super._render(e,t),$(this._element).find(".library").attr("data-tooltip","Book.home"),$(this._element).find(".increaseFontSize").attr("data-tooltip","SHEET.increaseFontSize")}_showBooks(){this.book=null,this.bookData=null,this.selectedChapter=null,this.selectedType=null,this.journals=null,this.actors=null,this.scenes=null,this.content=void 0,this.journalIndex=null,this.fulltextsearch=!0,this.currentType=void 0,this.selectedSubChapter=void 0,this.loadPage(this._element)}async toggleBookVisibility(e,t,a){const s=game.settings.get("dsa5","expansionPermissions");s[e]=a,await game.settings.set("dsa5","expansionPermissions",s);let i=this[t].find((t=>t.id==e));const n=await(await fetch(i.path)).json(),r=["actors","journal","scenes"];for(const e of r){if(!n[e])continue;let t=game.packs.get(n[e]),s=a?"OBSERVER":"NONE";const i={ownership:{PLAYER:s,TRUSTED:s}};await t.configure(i)}this.render()}activateListeners(e){super.activateListeners(e),e.on("click",".toggleVisibility",(async e=>{const t=e.currentTarget.dataset.itemid,a=e.currentTarget.dataset.type,s=$(e.currentTarget).find("i").hasClass("fa-toggle-off");this.toggleBookVisibility(t,a,s)})),e.on("click",".showMapNote",(e=>{game.journal.get(e.currentTarget.dataset.entryid).panToNote()})),e.on("search keyup",".filterJournals",(e=>{this.filterToc($(e.currentTarget).val())})),e.on("click",".loadBook",(t=>{this.selectedChapter=void 0,this.selectedType=void 0,this.content=void 0,this.loadBook($(t.currentTarget).text(),e,t.currentTarget.dataset.type)})),e.on("click",".getChapter",(t=>{this.selectedType=$(t.currentTarget).closest(".toc").attr("data-type"),this.selectedChapter=t.currentTarget.dataset.id,this.content=void 0,this.loadPage(e)})),e.on("click",".subChapter",(e=>{const t=$(e.currentTarget).text(),a=e.currentTarget.dataset.jid;a?this.loadJournalById(a):($(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-id="${t}"]`).addClass("selected"),this.loadJournal(t))})),u.Z.bindRollCommands(e),e.find(".tocCollapser").click((t=>{$(t.currentTarget).find("i").toggleClass("fa-chevron-right fa-chevron-left"),e.find(".tocCollapsing").toggleClass("expanded")})),e.on("mousedown",".openPin",(async e=>{const t=e.currentTarget.dataset.uuid;0==e.button?this.showJournal(await fromUuid(t)):2==e.button&&this.unpinJournal(t)})),e.on("click",".showJournal",(e=>{this.popJournal($(e.currentTarget).closest("h1").attr("data-uuid"))})),e.on("click",".pinJournal",(e=>{const t=$(e.currentTarget).closest("h1"),a=t.attr("data-uuid"),s=t.text();this.pinJournal(a,s)})),e.on("click",".activateScene",(e=>{this.showSzene(e.currentTarget.dataset.id,e.currentTarget.dataset.mode)})),e.on("click",".fulltextsearch",(t=>{this.fulltextsearch=!this.fulltextsearch,$(t.currentTarget).toggleClass("on"),this.filterToc(e.find(".filterJournals").val())})),e.on("mousedown",".chapter img",(e=>{let t=this.book.id;2==e.button&&game.dsa5.apps.DSA5_Utility.showArtwork({name:t,uuid:"",img:$(e.currentTarget).attr("src")})})),r.Z.bindButtons(e),e.on("click",".importBook",(async()=>this.importBook())),bindImgToCanvasDragStart(e),(0,l.Jp)(e,".breadcrumbs",this.resaveBreadCrumbs),this.heightFix()}heightFix(){const e=$(this._element).find(".breadcrumbs").height();$(this._element).find(".col.seventy.scrollable").css({"margin-bottom":`${e}px`})}async loadJournal(e){await this.showJournal(this.journals.find((t=>t.name==e&&t.flags.dsa5.parent==this.selectedChapter)))}async loadJournalById(e){await this.showJournal(this.journals.find((t=>t.id==e)))}async resaveBreadCrumbs(e){const t={};for(let a of e.getElementsByTagName("div"))t[a.dataset.uuid]=a.innerText;await game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(t))}async filterToc(e){if(null!=e){let t;if(""!=(e=e.toLowerCase().trim())){let t=[];this.fulltextsearch?(this.journalIndex||(this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),await this.journalIndex.add(this.journals.map((e=>new JournalSearch(e))))),t=await this.journalIndex.search(e)):t=this.journals.filter((t=>-1!=t.name.toLowerCase().trim().indexOf(e))),t=t.map((e=>`<li class="fas fa-caret-right"><a data-jid="${e.id}" class="subChapter">${e.name}</a></li>`)),$(this._element).find(".tocContent").html(`<ul>${t.join("\n")}</ul>`)}else t=await this.getToc(),$(this._element).find(".adventureWizard > .row-section > .toc").html(t).find(".filterJournals").focus()}}async showJournal(e){let t="";for(let a of e.pages){const s=e.sheet.getPageSheet(a.id),i=await s.getData(),n=(await s._renderInner(i)).get();let r=$(n[n.length-1]).html();"video"==a.type&&(r=`<div class="video-container">${r}</div>`),t+=r}const a=this.findSceneNote(e.getFlag("dsa5","initId")),s=await TextEditor.enrichHTML(t,{secrets:game.user.isGM,async:!0});this.content=`<div><h1 class="journalHeader" data-uuid="${e.uuid}">${e.name}<div class="jrnIcons">${a}<a class="pinJournal"><i class="fas fa-thumbtack"></i></a><a class="showJournal"><i class="fas fa-eye"></i></a></div></h1>${s}`;const i=$(this._element).find(".chapter");i.html(this.content),this.selectedSubChapter=e.id,$(this._element).find(".subChapter").removeClass("selected"),$(this._element).find(`[data-jid="${e.id}"]`).addClass("selected"),bindImgToCanvasDragStart(i),i.find(".documentName-link, .entity-link, .content-link").click((e=>{const t=$(e.currentTarget);this.bookData&&t.attr("data-pack")==this.bookData.journal&&(e.stopPropagation(),this.loadJournalById(t.attr("data-id")))}))}findSceneNote(e){if(e){const t=game.journal.find((t=>t.getFlag("dsa5","initId")==e));if(t&&t.sceneNote)return`<a class="showMapNote" data-entryId="${t.id}"><i class="fas fa-map-pin"></i></a>`}return""}async importBook(){game.user.isGM&&(new InitializerForm).render(this.bookData.moduleName)}async loadBook(e,t,a){a||(a=this.currentType),this.currentType=a,this.book=this[a].find((t=>t.id==e)),await fetch(this.book.path).then((async e=>e.json())).then((async e=>{this.bookData=e;let a=game.packs.get(e.journal);await a.getIndex();let s=await a.getDocuments();this.journals=s,e.actors&&(a=game.packs.get(e.actors),s=await a.getIndex(),this.actors=s),e.scenes&&(a=game.packs.get(e.scenes),s=await a.getIndex(),this.scenes=s),this.checkChapters(a),this.loadPage(t)}))}checkChapters(e){this.bookData.chapters||(this.bookData.isDynamic=!0,this.bookData.chapters=[{name:game.i18n.localize(`${this.bookData.moduleName}.name`),content:e.folders.map((e=>({name:e.name,id:e.id})))}])}async prefillActors(e){if(!e.actors)return[];let t=[];const a=await game.folders.contents.find((e=>e.name==game.i18n.localize(`${this.bookData.moduleName}.name`)&&"Actor"==e.type&&null==e.folder)),s=a?await game.folders.contents.filter((e=>"Actor"==e.type&&e.folder?.id==a.id)).map((e=>e.id)):void 0;for(let a of e.actors){let e,i=s?.length?game.actors.contents.find((e=>e.name==a&&s.includes(e.folder?.id))):void 0,n=i?.id,r=i?.uuid;i||(i=this.actors.find((e=>e.name==a)),e=this.bookData.actors,n=i?._id,r=i?`Compendium.${e}.${n}`:void 0),t.push({name:a,actor:i,pack:e,id:n,uuid:r})}return t}async popJournal(e){(await fromUuid(e)).sheet.render(!0)}async showSzene(e,t="activate"){let a=game.scenes.contents.find((t=>t.name==e));if(!a)return ui.notifications.error(game.i18n.localize("DSAError.sceneNotInitialized"));switch(t){case"activate":a.activate();break;case"view":a.view();break;case"toggle":a.update({navigation:!a.navigation})}}async getChapter(){if(this.book){if(this.content)return this.content;if(this.selectedChapter){if("prep"==this.selectedChapter){let e={initDescr:game.i18n.format(`${this.bookData.moduleName}.importContent`,{defaultText:game.i18n.localize("importDefault")})},t=this.bookData.modules;for(let e of t)e.enabled=this.moduleEnabled(e.id);return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_preparation.html",{modules:t,info:e})}if("foundryUsage"==this.selectedChapter)return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_foundry.html");let e=this.bookData.chapters.find((e=>e.name==this.selectedType)).content.find((e=>e.id==this.selectedChapter));const t=this.getSubChapters();return e.scenes||e.actors||0==t.length?await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_chapter.html",{chapter:e,subChapters:this.getSubChapters(),actors:await this.prefillActors(e)}):(this.selectedSubChapter=t[0].id,await this.loadJournalById(t[0].id))}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_cover.html",{book:this.book,bookData:this.bookData})}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_intro.html",{rshs:this.filterBooks(this.rshs),rules:this.filterBooks(this.books),adventures:this.filterBooks(this.adventures),isGM:game.user.isGM})}filterBooks(e){const t=game.settings.get("dsa5","expansionPermissions");for(const a of e)null!=t[a.id]&&(a.visible=t[a.id]);return game.user.isGM?e:e.filter((e=>null==e.visible||e.visible)).sort(((e,t)=>e.id.localeCompare(t.id)))}getSubChapters(){let e;return e=this.bookData.isDynamic?this.journals.filter((e=>e.folder.id==this.selectedChapter)).sort(((e,t)=>e.sort>t.sort?1:-1)):this.journals.filter((e=>e.flags.dsa5.parent==this.selectedChapter)).sort(((e,t)=>e.flags.dsa5.sort>t.flags.dsa5.sort?1:-1)),e.map((e=>({name:e.name,id:e.id,cssClass:e.id==this.selectedSubChapter?"selected":""})))}async getToc(){let e=[];if(this.book){if(e.push(...duplicate(this.bookData.chapters)),this.selectedChapter){let t;for(let a of e)if(t=a.content.find((e=>e.id==this.selectedChapter)),t)break;t.cssClass="selected",t.subChapters=this.getSubChapters()}return await renderTemplate("systems/dsa5/templates/wizard/adventure/adventure_toc.html",{chapters:e,book:this.book,fulltextsearch:this.fulltextsearch?"on":""})}return'<div class="libraryImg"></div>'}async loadPage(e){const t=await this.getChapter(),a=await this.getToc();e.find(".toc").html(a),e.find(".chapter").html(t)}async getData(e){const a=await super.getData(e),s=await this.getChapter(),i=await this.getToc(),n=game.settings.get("dsa5","journalFontSizeIndex"),r=t.Z.journalFontSizes[n-1]||14;return mergeObject(a,{adventure:this.bookData,currentChapter:s,breadcrumbs:this.renderBreadcrumbs(),toc:i,fontSize:r}),a}async pinJournal(e,t){let a=this.readBreadCrumbs();t||(t=(await fromUuid(e))?.name||""),a[e]=t,game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(a)),this.render(!0)}unpinJournal(e){let t=this.readBreadCrumbs();delete t[e],game.settings.set("dsa5",`breadcrumbs_${game.world.id}`,JSON.stringify(t)),this.render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch(e){return!1}"JournalEntry"==t.type&&this.pinJournal(t.pack?`Compendium.${t.pack}.${t.id}`:`JournalEntry.${t.id}`)}readBreadCrumbs(){let e={};try{e=JSON.parse(game.settings.get("dsa5",`breadcrumbs_${game.world.id}`))}catch(e){console.log("No Journalbrowser notes found")}return e}renderBreadcrumbs(){const e=this.readBreadCrumbs(),t=Object.entries(e).map((e=>`<div data-tooltip="${e[1]}" data-uuid="${e[0]}" class="openPin item">${e[1]}</div>`));return t.length>0?`<div id="breadcrumbs" class="breadcrumbs wrap row-section">${t.join("")}</div>`:""}moduleEnabled(t){return e.Z.moduleEnabled(t)}}class InitializerForm extends FormApplication{render(e){new game.dsa5.apps.DSA5Initializer("DSA5 Module Initialization",game.i18n.format(`${e}.importContent`,{defaultText:game.i18n.localize("importDefault")}),e,game.i18n.lang).render(!0)}}class JournalSearch{constructor(e){const t=e.pages.find((e=>!0)).text.content;this.document={name:e.name,data:$("<div>").html(t).text(),id:e.id}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}}var E=__webpack_require__(5);class DSAMenuLayer extends InteractionLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"dsamenu",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}selectObjects(e){canvas.tokens.selectObjects(e)}}class GameMasterMenu extends Application{constructor(e){super(e),this.heros=[],this.lastSkill=`${game.i18n.localize("LocalizedIDs.perception")}|skill`,this.randomCreation=[],game.user.isGM&&(Hooks.on("updateActor",(async(e,t,a,s)=>{this.heros.find((t=>t.id==e.id))&&["system.status.fatePoints","system.status.wounds","system.status.karmaenergy","system.status.astralenergy"].reduce(((e,a)=>e||hasProperty(t,a)),!1)&&this.render()})),Hooks.on("updateScene",(async(e,t,a,s)=>{game.canvas.id==e.id&&["darkness"].reduce(((e,a)=>e||hasProperty(t,a)),!1)&&(game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.onDarknessChange(),this.render())})),Hooks.on("canvasInit",(()=>{this.render()})))}async _render(e=!1,t={}){if(!game.user.isGM)return ui.notifications.error("DSAError.onlyGMallowed");await super._render(e,t)}getSelectedActors(){const e=game.settings.get("dsa5","selectedActors"),t=game.settings.get("dsa5","trackedActors"),a={};for(let s of Object.keys(e))t.actors?.includes(s)&&(a[s]=e[s]);return a}activateListeners(e){super.activateListeners(e),e.find("select.select2").select2(),(0,l.Ee)(e),e.find(".heroLink").click((e=>{e.stopPropagation(),game.actors.get(this.getID(e)).sheet.render(!0)})),e.find(".heroSelector").change((e=>{e.stopPropagation();const t=this.getSelectedActors();t[this.getID(e)]=$(e.currentTarget).is(":checked"),game.settings.set("dsa5","selectedActors",t)})),e.find(".skillSelektor").change((e=>{e.stopPropagation(),this.lastSkill=$(e.currentTarget).val()})),e.find(".rollChar").click((e=>{e.stopPropagation(),this.rollAbility([this.getID(e)])})),e.find(".rollAll").click((e=>{e.stopPropagation(),this.rollAbility(this.selectedIDs())})),e.find(".pay").click((e=>{e.stopPropagation(),this.doPayment([this.getID(e)],!0)})),e.find(".actorItem").click((async e=>{e.stopPropagation();const t=e.currentTarget.dataset.uuid;(await fromUuid(t)).sheet.render(!0)})),e.find(".getPaid").click((e=>{e.stopPropagation(),this.doPayment([this.getID(e)],!1)})),e.find(".payAll").click((e=>{e.stopPropagation(),this.doPayment(this.selectedIDs(e),!0)})),e.find(".getPaidAll").click((e=>{e.stopPropagation(),this.doPayment(this.selectedIDs(e),!1)})),e.find(".selectAll").change((t=>{t.stopPropagation();const a=e.find(".heroSelector");a.prop("checked",$(t.currentTarget).is(":checked")),a.change()})),e.find(".exp").click((e=>{e.stopPropagation(),this.getExp([this.getID(e)])})),e.find(".expAll").click((e=>{e.stopPropagation(),this.getExp(this.selectedIDs())})),e.find(".randomPlayer").mousedown((t=>{t.stopPropagation(),this._randomPlayer(e,t)})),e.find(".requestRoll").click((e=>{e.stopPropagation(),this.rollRequest()})),e.find(".heroSelector").click((e=>e.stopPropagation())),e.find(".hero").click((e=>{e.stopPropagation(e),$(e.currentTarget).find(".expandDetails").fadeToggle()}));let deletehand=e=>this._deleteHero(e);e.find(".hero").mouseenter((e=>{if(0==e.currentTarget.getElementsByClassName("hovermenu").length){let t=document.createElement("div");t.classList.add("hovermenu");let a=document.createElement("i");a.classList.add("fas","fa-times"),a.title=game.i18n.localize("SHEET.DeleteItem"),a.addEventListener("click",deletehand,!1),t.appendChild(a),e.currentTarget.appendChild(t)}})),e.find(".hero").mouseleave((e=>{let t=e.toElement||e.relatedTarget;t&&t.parentNode!=this&&t!=this&&e.currentTarget.querySelectorAll(".hovermenu").forEach((e=>e.remove()))})),e.find(".addGroupSchip").click((async e=>{await this.changeGroupSchipCount(Number(e.currentTarget.dataset.value))})),e.find(".groupschip").click((e=>{this.changeGroupSchip(e)})),e.find(".heroschip").click((e=>{e.stopPropagation(),e.preventDefault();let t=Number(e.currentTarget.getAttribute("data-val"));1==t&&1==$(e.currentTarget).closest(".hero").find(".fullSchip").length&&(t=0),game.actors.get(this.getID(e)).update({"system.status.fatePoints.value":t})})),e.find(".groupCheck").click((e=>{e.stopPropagation(),this.doGroupCheck()})),e.find(".changeSetting").change((async e=>{await game.settings.set("dsa5",e.currentTarget.name,e.currentTarget.checked)})),e.find(".changeSightTreshold").change((async e=>{$(e.currentTarget).closest(".row-section").find(".range-value").text(e.currentTarget.value),this.updateSightThreshold(e)})),e.find(".updateDarkness").change((async e=>{$(e.currentTarget).closest(".row-section").find(".range-value").text(e.currentTarget.value),this.updateDarkness(e)}));for(let t of this.randomCreation)t.activateListeners(e);(0,l.Jp)(e,".heros",this.updateHeroOrder,".hero"),e.on("dragstart",".hero",(e=>{e.stopPropagation();let t={type:"Actor",uuid:e.currentTarget.dataset.uuid};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(t))})),e.find(".dragEveryone").each((function(e,t){t.setAttribute("draggable",!0)})),e.on("dragstart",".dragEveryone",(e=>{e.stopPropagation();e.currentTarget;let t={type:"GroupDrop",ids:this.selectedIDs()};e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(t))})),game.dsa5.apps.LightDialog&&game.dsa5.apps.LightDialog.activateButtonListener(e)}async _deleteHero(e){e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget).closest(".hero").attr("data-id"),a=game.settings.get("dsa5","trackedActors").actors||[],s=a.indexOf(t);s>-1&&(a.splice(s,1),await game.settings.set("dsa5","trackedActors",{actors:a}),this.render(!0))}async updateHeroOrder(e){const t=[];for(let a of e.querySelectorAll(".hero"))t.push(a.dataset.id);await game.settings.set("dsa5","trackedActors",{actors:t})}async updateDarkness(e){canvas.scene&&canvas.scene.update({darkness:Number(e.currentTarget.value)},{animateDarkness:3e3})}async updateSightThreshold(e){const t=Number(e.currentTarget.dataset.index),a=Number(e.currentTarget.value),s=game.settings.get("dsa5","sightOptions").split("|");s[t]=a,await game.settings.set("dsa5","sightOptions",s.join("|"))}getGroupSchipSetting(){return game.settings.get("dsa5","groupschips").split("/").map((e=>Number(e)))}async changeGroupSchipCount(e){const t=this.getGroupSchipSetting();t[1]=Math.max(0,t[1]+e),t[0]=Math.min(t[1],t[0]),await game.settings.set("dsa5","groupschips",t.join("/"))}async changeGroupSchip(e){let t=Number(e.currentTarget.getAttribute("data-val"));1==t&&1==$(e.currentTarget).closest(".col").find(".fullSchip").length&&(t=0);const a=this.getGroupSchipSetting();a[0]=t,await game.settings.set("dsa5","groupschips",a.join("/"))}async _randomPlayer(e,t){const a=e.find(".hero"),s=await this.rollRandomPlayer(2==t.button);$(t.currentTarget).find("i").addClass("fa-spin"),a.removeClass("victim"),setTimeout((()=>{$(this._element).find(`.hero[data-id="${s}"]`).addClass("victim"),$(t.currentTarget).find("i").removeClass("fa-spin")}),500)}async rollRandomPlayer(e){let t={},s=1;const i=this.getSelectedActors(),n=0!=Object.values(i).filter((e=>e)).length,r=this.heros.length?this.heros:await this.getTrackedHeros();for(const o of r)!i[o.id]&&n||(t[s]=o.id,s++,e&&a.Z.hasVantage(o,game.i18n.localize("LocalizedIDs.misfortune"))&&(t[s]=o.id,s++),e&&o.hasCondition("badluck")&&(t[s]=o.id,s++));return t[(await new Roll("1d"+(s-1)).evaluate({async:!0})).total]}async doPayment(e,t){const a=game.actors.filter((t=>e.includes(t.id))),s=this.getNames(a),i=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format(t?"MASTER.payText":"MASTER.getPaidText",{heros:s}))});this.buildDialog(game.i18n.localize(t?"MASTER.payTT":"PAYMENT.payButton"),i,(e=>{const s=e.find(".input-text").val();for(let e of a)DSA5Payment.handlePayAction(void 0,t,s,e)}))}async getPaid(e){this.doPayment(e,!1)}async getExp(t){const a=game.actors.filter((e=>t.includes(e.id))),s=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.awardXPText",{heros:this.getNames(a)}))});this.buildDialog(game.i18n.localize("MASTER.awardXP"),s,(async t=>{const s=Number(t.find(".input-text").val()),i=Math.max(1,Math.round(.25*s)),n=[],r=[];if(!isNaN(s)){for(const e of a){let t=s;e.system.isFamiliar||e.system.isPet?(t=i,r.push(e)):n.push(e),await e.update({"system.details.experience.total":e.system.details.experience.total+t})}n.length>0&&await ChatMessage.create(e.Z.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:this.getNames(n),number:s}))),r.length>0&&await ChatMessage.create(e.Z.chatDataSetup(game.i18n.format("MASTER.xpMessage",{heros:this.getNames(r),number:s})))}}))}getNames(e){return e.map((e=>e.name)).join(", ")}buildDialog(e,t,a){new E.Z({title:e,content:t,default:"yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:e=>{a(e)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}}).render(!0)}_canDragDrop(e){return!0}async _onDrop(e){let t;try{t=JSON.parse(e.dataTransfer.getData("text/plain")),t=await Actor.implementation.fromDropData(t)}catch(e){return!1}if("Actor"==t.documentName){let e=game.settings.get("dsa5","trackedActors");e=e.actors||[],-1!=e.indexOf(t.id)||t.pack||(e.push(t.id),await game.settings.set("dsa5","trackedActors",{actors:e}),this.render(!0))}}selectedIDs(){let e=[];const t=this.getSelectedActors();for(const[a,s]of Object.entries(t))s&&e.push(a);return e.length?e:game.settings.get("dsa5","trackedActors").actors||[]}async doGroupCheck(){const[e,t]=this.lastSkill.split("|");if("skill"!=t)return;const a=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.doGroupCheck",{skill:e}))});this.buildDialog(game.i18n.localize("HELP.groupcheck"),a,(e=>{const t=Number(e.find(".input-text").val()),[a,s]=this.lastSkill.split("|");"skill"==s&&_.Z.showGCMessage(a,t)}))}async rollRequest(){const[e,t]=this.lastSkill.split("|");if("skill"!=t)return;const a=await renderTemplate("systems/dsa5/templates/dialog/master-dialog-award.html",{text:game.i18n.localize(game.i18n.format("MASTER.doRequestRoll",{skill:e}))});this.buildDialog(game.i18n.localize("HELP.request"),a,(e=>{const t=Number(e.find(".input-text").val()),[a,s]=this.lastSkill.split("|");"skill"==s&&_.Z.showRQMessage(a,t)}))}rollAbility(e){const[t,a]=this.lastSkill.split("|");switch(a){case"skill":this.rollSkill(e,t);break;case"attribute":this.rollAttribute(e,t);break;case"regeneration":this.rollRegeneration(e)}}rollRegeneration(e){const t=game.actors.filter((t=>e.includes(t.id)));for(const e of t)e.setupRegeneration("regenerate",{rollMode:"blindroll",subtitle:` (${e.name})`},void 0).then((t=>{e.basicTest(t)}))}rollAttribute(e,t){const a=game.actors.filter((t=>e.includes(t.id)));let s=Object.keys(game.dsa5.config.characteristics).find((e=>game.i18n.localize(game.dsa5.config.characteristics[e])==t));for(const e of a)e.setupCharacteristic(s,{rollMode:"blindroll",subtitle:` (${e.name})`},void 0).then((t=>{e.basicTest(t)}))}rollSkill(e,t){const a=game.actors.filter((t=>e.includes(t.id)));for(const e of a){let a=e.items.find((e=>e.name==t&&"skill"==e.type));e.setupSkill(a,{rollMode:"blindroll",subtitle:` (${e.name})`},void 0).then((t=>{e.basicTest(t)}))}}getID(e){return $(e.currentTarget).closest(".hero").attr("data-id")}static get defaultOptions(){const e=super.defaultOptions;return e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"main"}],mergeObject(e,{classes:e.classes.concat(["dsa5","largeDialog","masterMenu","sheet"]),width:470,height:740,title:game.i18n.localize("gmMenu"),dragDrop:[{dragSelector:null,dropSelector:null}]}),e.template="systems/dsa5/templates/system/mastermenu.html",e.resizable=!0,e}async getTrackedHeros(){const e=game.settings.get("dsa5","trackedActors");let t=[];return e.actors&&e.actors.length>0?t=game.actors.filter((t=>e.actors.includes(t.id))).sort(((t,a)=>e.actors.indexOf(t.id)-e.actors.indexOf(a.id))):(t=game.actors.filter((e=>e.hasPlayerOwner)),await game.settings.set("dsa5","trackedActors",{actors:t.map((e=>e.id))})),t}async getData(t){const a=await super.getData(t),s=await this.getTrackedHeros(),i=d.Z.getGroupSchips(),n=game.settings.get("dsa5","sightOptions").split("|"),r=/ \[[a-zA-Zäöü\d-]+\]/,o=[1,2,3,4].map((e=>({label:game.i18n.localize(`VisionDisruption.step${e}`).replace(r,""),value:n[e-1]})));a.sceneConfig={sceneAutomationEnabled:game.settings.get("dsa5","sightAutomationEnabled"),enableDPS:game.settings.get("dsa5","enableDPS"),visions:o,darkness:canvas.scene?.darkness||0},this.heros=s;const l=this.getSelectedActors();for(const e of s)e.gmSelected=l[e.id],e.schips=e.schipshtml(),e.purse=e.items.filter((e=>"money"==e.type)).sort(((e,t)=>t.system.price.value-e.system.price.value)).map((e=>`<span data-tooltip="${game.i18n.localize(e.name)}">${e.system.quantity.value}</span>`)).join(" - "),e.advantages=e.items.filter((e=>"advantage"==e.type)).map((e=>({name:e.name,uuid:e.uuid}))),e.disadvantages=e.items.filter((e=>"disadvantage"==e.type)).map((e=>({name:e.name,uuid:e.uuid})));if(!this.abilities){const t=await e.Z.allSkillsList();this.abilities=t.map((e=>({name:e,type:"skill"}))).concat(Object.values(game.dsa5.config.characteristics).map((e=>({name:game.i18n.localize(e),type:"attribute"}))).concat({name:game.i18n.localize("regenerate"),type:"regeneration"})).sort(((e,t)=>e.name.localeCompare(t.name)))}return mergeObject(a,{heros:s,abilities:this.abilities,groupschips:i,lastSkill:this.lastSkill,randomCreation:this.randomCreation.map((e=>e.template)),lightButton:game.dsa5.apps.LightDialog?await game.dsa5.apps.LightDialog.getButtonHTML():""}),a}registerRandomCreation(e){this.randomCreation.push(e)}}class CreatureMerchantSheetDSA5 extends(MerchantSheetMixin(ActorSheetdsa5Creature)){static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/creature-merchant-sheet.html"}}class CharacterMerchantSheetDSA5 extends(MerchantSheetMixin(ActorSheetdsa5Character)){static get merchantTemplate(){return"systems/dsa5/templates/actors/merchant/character-merchant-sheet.html"}}class DSAJournalSheet extends JournalSheet{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:e.classes.concat(["dsa5","dsajournal"])}),e}}Hooks.once("init",(()=>{loadTemplates(["systems/dsa5/templates/actors/actor-main.html","systems/dsa5/templates/actors/actor-talents.html","systems/dsa5/templates/items/item-description.html","systems/dsa5/templates/dialog/default-dialog.html","systems/dsa5/templates/dialog/parts/targets.html","systems/dsa5/templates/dialog/enhanced-default-dialog.html","systems/dsa5/templates/dialog/default-combat-dialog.html","systems/dsa5/templates/chat/roll/test-card.html","systems/dsa5/templates/items/item-equipment.html","systems/dsa5/templates/items/item-enchantment.html","systems/dsa5/templates/actors/actor-combat.html","systems/dsa5/templates/actors/actor-equipment.html","systems/dsa5/templates/actors/actor-notes.html","systems/dsa5/templates/dialog/parts/spellmodifiers.html","systems/dsa5/templates/dialog/parts/canChangeCastingTime.html","systems/dsa5/templates/actors/parts/schipspart.html","systems/dsa5/templates/chat/post-item.html","systems/dsa5/templates/items/item-stat.html","systems/dsa5/templates/items/item-extension.html","systems/dsa5/templates/actors/creature/creature-main.html","systems/dsa5/templates/actors/creature/creature-loot.html","systems/dsa5/templates/actors/creature/creature-notes.html","systems/dsa5/templates/actors/creature/creature-magic.html","systems/dsa5/templates/actors/creature/creature-religion.html","systems/dsa5/templates/actors/parts/characteristics-large.html","systems/dsa5/templates/actors/parts/gearSearch.html","systems/dsa5/templates/actors/parts/magicalSigns.html","systems/dsa5/templates/actors/parts/containerContent.html","systems/dsa5/templates/actors/npc/npc-main.html","systems/dsa5/templates/actors/character/actor-magic.html","systems/dsa5/templates/actors/character/actor-religion.html","systems/dsa5/templates/actors/character/actor-aggregatedtests.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-small.html","systems/dsa5/templates/actors/parts/creature-derived-attributes-large.html","systems/dsa5/templates/actors/parts/status_effects.html","systems/dsa5/templates/actors/parts/purse.html","systems/dsa5/templates/actors/parts/horse.html","systems/dsa5/templates/actors/parts/healthbar.html","systems/dsa5/templates/actors/merchant/merchant-commerce.html","systems/dsa5/templates/items/item-header.html","systems/dsa5/templates/items/item-effects.html","systems/dsa5/templates/items/item-aoe.html","systems/dsa5/templates/items/traditionArtifact.html","systems/dsa5/templates/status/advanced_functions.html","systems/dsa5/templates/actors/parts/information.html","systems/dsa5/templates/actors/parts/combatskills.html","systems/dsa5/templates/actors/parts/attributes.html","systems/dsa5/templates/actors/parts/carryandpurse.html","systems/dsa5/templates/actors/parts/specialabilities.html","systems/dsa5/templates/actors/parts/experienceBox.html","systems/dsa5/templates/actors/parts/temperature.html","systems/dsa5/templates/actors/parts/temperatureSmall.html","systems/dsa5/templates/actors/parts/spells.html","systems/dsa5/templates/dialog/parts/expChoices.html","systems/dsa5/templates/actors/parts/liturgies.html","systems/dsa5/templates/items/browse/culture.html","systems/dsa5/templates/items/browse/species.html","systems/dsa5/templates/items/browse/career.html"]),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("dsa5",ActorSheetdsa5Character,{types:["character"],makeDefault:!0}),Actors.registerSheet("dsa5",ActorSheetdsa5Creature,{types:["creature"],makeDefault:!0}),Actors.registerSheet("dsa5",ActorSheetdsa5NPC,{types:["npc"],makeDefault:!0}),Actors.registerSheet("dsa5",MerchantSheetDSA5,{types:["npc"]}),Actors.registerSheet("dsa5",CreatureMerchantSheetDSA5,{types:["creature"]}),Actors.registerSheet("dsa5",CharacterMerchantSheetDSA5,{types:["character"]}),DocumentSheetConfig.registerSheet(ActiveEffect,"dsa5",k.Z,{makeDefault:!0}),Journal.registerSheet("dsa5",DSAJournalSheet,{makeDefault:!0}),ItemSheetdsa5.setupSheets(),Hooks.call("registerDSAstyle",t.Z.styles),function setupConfiguration(){game.settings.register("dsa5","meleeBotchTableEnabled",{name:"DSASETTINGS.meleeBotchTableEnabled",hint:"DSASETTINGS.meleeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","rangeBotchTableEnabled",{name:"DSASETTINGS.rangeBotchTableEnabled",hint:"DSASETTINGS.rangeBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","doubleDamageOptions",{name:"DSASETTINGS.doubleDamageOptions",hint:"DSASETTINGS.doubleDamageOptionsHint",scope:"client",config:!0,default:!1,type:Boolean,requiresReload:!0}),game.settings.register("dsa5","defenseBotchTableEnabled",{name:"DSASETTINGS.defenseBotchTableEnabled",hint:"DSASETTINGS.defenseBotchTableEnabledHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","higherDefense",{name:"DSASETTINGS.higherDefense",hint:"DSASETTINGS.higherDefenseHint",scope:"world",config:!0,default:"0",type:String,choices:{0:"0",2:"+2",4:"+4"}}),game.settings.register("dsa5","informationDistribution",{name:"DSASETTINGS.informationDistribution",hint:"DSASETTINGS.informationDistributionHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("DSASETTINGS.information0"),1:game.i18n.localize("DSASETTINGS.information1"),2:game.i18n.localize("DSASETTINGS.information2")}}),game.settings.register("dsa5","enableItemDropToCanvas",{name:"DSASETTINGS.enableItemDropToCanvas",hint:"DSASETTINGS.enableItemDropToCanvasHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","statusEffectCounterColor",{name:"DSASETTINGS.statusEffectCounterColor",hint:"DSASETTINGS.statusEffectCounterColorHint",scope:"client",config:!0,default:"#FFFFFF",type:String}),game.settings.register("dsa5","migrationVersion",{name:"migrationVersion",hint:"migrationVersion",scope:"world",config:!1,default:23,type:Number}),game.settings.register("dsa5","journalFontSizeIndex",{name:"journalFontSizeIndex",hint:"journalFontSizeIndex",scope:"client",config:!1,default:5,type:Number}),game.settings.register("dsa5","firstTimeStart",{name:"firstTimeStart",hint:"firstTimeStart",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","defaultConfigFinished",{name:"defaultConfigFinished",hint:"defaultConfigFinished",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","tokenizerSetup",{name:"tokenizerSetup",hint:"tokenizerSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","diceSetup",{name:"diceSetup",hint:"diceSetup",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","capQSat",{name:"DSASETTINGS.capQSat",hint:"DSASETTINGS.capQSatHint",scope:"world",config:!0,default:6,type:Number}),game.settings.register("dsa5","hideEffects",{name:"DSASETTINGS.hideEffects",hint:"DSASETTINGS.hideEffectsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","inventorySound",{name:"DSASETTINGS.inventorySound",hint:"DSASETTINGS.inventorySoundHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","talentModifierEnabled",{name:"DSASETTINGS.talentModifierEnabled",hint:"DSASETTINGS.talentModifierEnabledHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","noConfirmationRoll",{name:"DSASETTINGS.noConfirmationRoll",hint:"DSASETTINGS.noConfirmationRollHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","lessRegeneration",{name:"DSASETTINGS.lessRegeneration",hint:"DSASETTINGS.lessRegenerationHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","limitCombatSpecAbs",{name:"DSASETTINGS.limitCombatSpecAbs",hint:"DSASETTINGS.limitCombatSpecAbsHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","allowPhysicalDice",{name:"DSASETTINGS.allowPhysicalDice",hint:"DSASETTINGS.allowPhysicalDiceHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideOpposedDamage",{name:"DSASETTINGS.hideOpposedDamage",hint:"DSASETTINGS.hideOpposedDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableForeignSpellModifer",{name:"DSASETTINGS.enableForeignSpellModifer",hint:"DSASETTINGS.enableForeignSpellModiferHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","playerCanEditSpellMacro",{name:"DSASETTINGS.playerCanEditSpellMacro",hint:"DSASETTINGS.playerCanEditSpellMacroHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","enableDPS",{name:"DSASETTINGS.enableDPS",hint:"DSASETTINGS.enableDPSHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","iniTrackerSize",{name:"DSASETTINGS.iniTrackerSize",hint:"DSASETTINGS.iniTrackerSizeHint",scope:"client",config:!0,default:70,type:Number,range:{min:30,max:140,step:5},onChange:async e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.constructor.defaultOptions.itemWidth=e)}}),game.settings.register("dsa5","iniTrackerCount",{name:"DSASETTINGS.iniTrackerCount",hint:"DSASETTINGS.iniTrackerCountHint",scope:"client",config:!0,default:5,type:Number,range:{min:3,max:25,step:1},onChange:async e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.constructor.defaultOptions.actorCount=e)}}),game.settings.register("dsa5","tokenhotbarSize",{name:"DSASETTINGS.tokenhotbarSize",hint:"DSASETTINGS.tokenhotbarSizeHint",scope:"client",config:!1,default:35,type:Number,range:{min:15,max:100,step:5},onChange:async e=>{game.dsa5.apps.tokenHotbar&&(game.dsa5.apps.tokenHotbar.constructor.defaultOptions.itemWidth=e)}}),game.settings.register("dsa5","tokenhotbarLayout",{name:"DSASETTINGS.tokenhotbarLayout",hint:"DSASETTINGS.tokenhotbarLayoutHint",scope:"client",config:!1,default:0,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.tokenhotbarLayout0"),2:game.i18n.localize("DSASETTINGS.tokenhotbarLayout1"),1:game.i18n.localize("DSASETTINGS.tokenhotbarLayout2"),3:game.i18n.localize("DSASETTINGS.tokenhotbarLayout3")}});const e=duplicate(t.Z.styles);for(let t of Object.keys(e))e[t]=game.i18n.localize(e[t]);game.settings.register("dsa5","globalStyle",{name:"DSASETTINGS.globalStyle",hint:"DSASETTINGS.globalStyleHint",scope:"client",config:!0,default:"dsa5-immersive",type:String,choices:e,onChange:async t=>{$("body").removeClass(Object.keys(e).join(" ")).addClass(t)}}),game.settings.register("dsa5","selfControlOnPain",{name:"DSASETTINGS.selfControlOnPain",hint:"DSASETTINGS.selfControlOnPainHint",scope:"world",config:!0,default:1,type:Number,choices:{0:game.i18n.localize("DSASETTINGS.selfControlOnPain0"),1:game.i18n.localize("DSASETTINGS.selfControlOnPain1"),2:game.i18n.localize("DSASETTINGS.selfControlOnPain2")}}),game.settings.register("dsa5","forceLanguage",{name:"DSASETTINGS.forceLanguage",hint:"DSASETTINGS.forceLanguageHint",scope:"world",config:!0,default:"none",type:String,choices:{none:"-",de:"German",en:"English"}}),game.settings.register("dsa5","tokenhotbarPosition",{name:"tokenhotbarPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","iniTrackerPosition",{name:"iniTrackerPosition",scope:"client",config:!1,default:{},type:Object}),game.settings.register("dsa5","soundConfig",{name:"DSASETTINGS.soundConfig",hint:"DSASETTINGS.soundConfigHint",scope:"world",config:!0,default:"",type:String,onChange:async()=>{c.Z.loadSoundConfig()}}),game.settings.registerMenu("dsa5","changelog",{name:"Changelog",label:"Changelog",hint:game.i18n.localize("DSASETTINGS.changelog"),type:ChangelogForm,restricted:!1}),game.settings.registerMenu("dsa5","exportConfiguration",{name:"Export/Import Configuration",label:"Export/Import Configuration",hint:game.i18n.localize("DSASETTINGS.exportConfiguration"),type:ExportForm,restricted:!0}),game.settings.registerMenu("dsa5","configureTokenbar",{name:game.i18n.localize("DSASETTINGS.configureTokenbar"),label:game.i18n.localize("DSASETTINGS.configureTokenbar"),hint:game.i18n.localize("DSASETTINGS.configureTokenbarHint"),type:ConfigureTokenHotbar,restricted:!1}),game.settings.register("dsa5",`breadcrumbs_${game.world.id}`,{name:"DSASETTINGS.breadcrumbs",hint:"DSASETTINGS.breadcrumbsHint",scope:"client",config:!1,default:"",type:String}),game.settings.register("dsa5","groupschips",{name:"DSASETTINGS.groupschips",hint:"DSASETTINGS.groupschips",scope:"world",config:!1,default:"0/0",type:String,onChange:async()=>{game.user.isGM&&game.dsa5.apps.gameMasterMenu.render()}}),game.settings.register("dsa5","expandChatModifierlist",{name:"DSASETTINGS.expandChatModifierlist",hint:"DSASETTINGS.expandChatModifierlistHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","indexWorldItems",{name:"DSASETTINGS.indexWorldItems",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","enableCombatFlow",{name:"DSASETTINGS.enableCombatFlow",hint:"DSASETTINGS.enableCombatFlowHint",scope:"client",config:!0,default:!0,type:Boolean,onchange:e=>{game.dsa5.apps.initTracker&&(game.dsa5.apps.initTracker.close(),game.dsa5.apps.initTracker=void 0)}}),game.settings.register("dsa5","enableCombatPan",{name:"DSASETTINGS.enableCombatPan",hint:"DSASETTINGS.enableCombatPanHint",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","sightAutomationEnabled",{name:"sightAutomationEnabled",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("dsa5","disableDidYouKnow",{name:"DSASETTINGS.disableDidYouKnow",hint:"DSASETTINGS.disableDidYouKnowHint",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","disableTokenhotbar",{name:"DSASETTINGS.disableTokenhotbar",hint:"DSASETTINGS.disableTokenhotbarHint",scope:"client",config:!1,default:!1,type:Boolean,onChange:e=>{e?TokenHotbar2.unregisterTokenHotbar():TokenHotbar2.registerTokenHotbar()}}),game.settings.register("dsa5","disableTokenhotbarMaster",{name:"DSASETTINGS.disableTokenhotbarMaster",hint:"DSASETTINGS.disableTokenhotbarMasterHint",scope:"client",config:!1,default:!1,type:Boolean,onChange:()=>{game.dsa5.apps.tokenHotbar&&game.dsa5.apps.tokenHotbar.render(!0)}}),game.settings.register("dsa5","scrollingFontsize",{name:"DSASETTINGS.scrollingFontsize",hint:"DSASETTINGS.scrollingFontsizeHint",scope:"client",config:!0,default:16,type:Number,range:{min:6,max:50,step:1}}),game.settings.register("dsa5","tokenhotbaropacity",{name:"DSASETTINGS.tokenhotbaropacity",hint:"DSASETTINGS.tokenhotbaropacityHint",scope:"client",config:!1,default:.75,type:Number,range:{min:0,max:1,step:.05}}),game.settings.register("dsa5","armorAndWeaponDamage",{name:"DSASETTINGS.armorAndWeaponDamage",hint:"DSASETTINGS.armorAndWeaponDamageHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","hideRegenerationToOwner",{name:"DSASETTINGS.hideRegenerationToOwner",hint:"DSASETTINGS.hideRegenerationToOwnerHint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("dsa5","indexDescription",{name:"DSASETTINGS.indexDescription",scope:"client",config:!1,default:!0,type:Boolean}),game.settings.register("dsa5","encumbranceForRange",{name:"DSASETTINGS.encumbranceForRange",hint:"DSASETTINGS.encumbranceForRangeHint",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("dsa5","obfuscateTokenNames",{name:"DSASETTINGS.obfuscateTokenNames",hint:"DSASETTINGS.obfuscateTokenNamesHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("DSASETTINGS.yesNumbered"),2:game.i18n.localize("DSASETTINGS.renameNumbered"),3:game.i18n.localize("yes"),4:game.i18n.localize("DSASETTINGS.rename")}}),game.settings.register("dsa5","merchantNotification",{name:"DSASETTINGS.merchantNotification",hint:"DSASETTINGS.merchantNotificationHint",scope:"world",config:!0,default:"0",type:String,choices:{0:game.i18n.localize("no"),1:game.i18n.localize("yes"),2:game.i18n.localize("MERCHANT.onlyGM")}}),game.settings.register("dsa5","sightOptions",{name:"sightOptions",scope:"world",config:!1,default:"0.5|0.7|0.85|0.95",type:String}),game.settings.register("dsa5","trackedActors",{name:"sightOptions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","enableMasterTokenFunctions",{name:"enableMasterTokenFunctions",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","selectedActors",{name:"selectedActors",scope:"world",config:!1,default:{},type:Object}),game.settings.register("dsa5","expansionPermissions",{name:"expansionPermissions",scope:"world",config:!1,default:{},type:Object})}(),C.Z.initDoorMinDistance(),mergeObject(CONFIG.JournalEntry.noteIcons,t.Z.noteIcons),c.Z.prepareSoundEffects(),$("body").addClass(game.settings.get("dsa5","globalStyle"))})),Hooks.once("setup",(()=>{if(["de","en"].includes(game.i18n.lang)){const e=game.settings.get("dsa5","forceLanguage");["de","en"].includes(e)&&game.i18n.lang!=e&&showWrongLanguageDialog(e)}else console.warn(`DSA5 - ${game.i18n.lang} is not a supported language. Falling back to default language.`),showForbiddenLanguageDialog();BookWizard.initHook(),function keybindings(){game.keybindings.register("dsa5","masterMenu",{name:"gmMenu",hint:game.i18n.localize("KEYBINDINGS.masterMenu"),editable:[{key:"KeyM"}],onDown:()=>e.Z.renderToggle(game.dsa5.apps.gameMasterMenu),restricted:!0}),game.keybindings.register("dsa5","journalBrowser",{name:"Book.Wizard",hint:game.i18n.localize("KEYBINDINGS.journalBrowser"),editable:[{key:"KeyJ"}],onDown:()=>e.Z.renderToggle(game.dsa5.apps.journalBrowser)}),game.keybindings.register("dsa5","library",{name:"ItemLibrary",hint:game.i18n.localize("KEYBINDINGS.library"),editable:[{key:"KeyL"}],onDown:()=>e.Z.renderToggle(game.dsa5.itemLibrary)}),game.keybindings.register("dsa5","attacktest",{name:"attacktest",hint:game.i18n.localize("KEYBINDINGS.attack"),editable:[{key:"KeyB"}],onDown:()=>DSA5CombatTracker.runActAttackDialog()}),game.keybindings.register("dsa5","combatTrackerNext",{name:"COMBAT.TurnNext",hint:game.i18n.localize("COMBAT.TurnNext"),editable:[{key:"KeyN"}],onDown:()=>combatTurn("nextTurn")}),game.keybindings.register("dsa5","combatTrackerPrevious",{name:"COMBAT.TurnPrev",hint:game.i18n.localize("COMBAT.TurnPrev"),editable:[{key:"KeyV"}],onDown:()=>combatTurn("previousTurn")}),game.keybindings.register("dsa5","setTargetToUser",{name:"DIALOG.setTargetToUser",hint:game.i18n.localize("DIALOG.setTargetToUserHint"),editable:[],onDown:async()=>(await I.Z0.getDialog()).render(!0),restricted:!0})}(),class MastersMenu{static registerButtons(){game.dsa5.apps.playerMenu=new PlayerMenu,CONFIG.Canvas.layers.dsamenu={layerClass:DSAMenuLayer,group:"interface"},Hooks.on("getSceneControlButtons",(t=>{const a=[{name:"JournalBrowser",title:game.i18n.localize("Book.Wizard"),icon:"fa fa-book",button:!0,onClick:()=>{e.Z.renderToggle(game.dsa5.apps.journalBrowser)}},{name:"Library",title:game.i18n.localize("SHEET.Library"),icon:"fas fa-university",button:!0,onClick:()=>{e.Z.renderToggle(game.dsa5.itemLibrary)}},{name:"PlayerMenu",title:game.i18n.localize("PLAYER.title"),icon:"fas fa-dsa5-player",button:!0,onClick:()=>{e.Z.renderToggle(game.dsa5.apps.playerMenu)}}];game.user.isGM&&(game.dsa5.apps.gameMasterMenu||(game.dsa5.apps.gameMasterMenu=new GameMasterMenu),a.push({name:"mastersMenu",title:game.i18n.localize("gmMenu"),icon:"fa fa-dsa5",button:!0,onClick:()=>{e.Z.renderToggle(game.dsa5.apps.gameMasterMenu)}})),t.push({name:"GM Menu",title:game.i18n.localize("gmMenu"),icon:"fas fa-dsa5",layer:"dsamenu",tools:a})}))}}.registerButtons(),I.Z0.registerButtons(),CONFIG.Canvas.lightAnimations.daylight={label:"LIGHT.daylight",illuminationShader:DaylightIlluminationShader},a.Z.setupFunctions(),i.Z.setupFunctions()})),Hooks.once("i18nInit",(()=>{!function setupKnownEquipmentModifiers(){game.dsa5.config.knownShortcuts={[game.i18n.localize("CHARAbbrev.INI").toLowerCase()]:["status","initiative","gearmodifier"],[game.i18n.localize("CHARAbbrev.GS").toLowerCase()]:["status","speed","gearmodifier"],[game.i18n.localize("CHARAbbrev.AsP").toLowerCase()]:["status","astralenergy","gearmodifier"],[game.i18n.localize("CHARAbbrev.LeP").toLowerCase()]:["status","wounds","gearmodifier"],[game.i18n.localize("CHARAbbrev.KaP").toLowerCase()]:["status","karmaenergy","gearmodifier"],[game.i18n.localize("CHARAbbrev.AW").toLowerCase()]:["status","dodge","gearmodifier"],[game.i18n.localize("CHARAbbrev.SK").toLowerCase()]:["status","soulpower","gearmodifier"],[game.i18n.localize("CHARAbbrev.ZK").toLowerCase()]:["status","toughness","gearmodifier"],[game.i18n.localize("CHARAbbrev.FtP").toLowerCase()]:["status","fatePoints","gearmodifier"]};for(const e of Object.keys(t.Z.characteristics))game.dsa5.config.knownShortcuts[game.i18n.localize(`CHARAbbrev.${e.toUpperCase()}`).toLowerCase()]=["characteristics",e.toLowerCase(),"gearmodifier"]}()}));class ForbiddenLanguageDialog extends Dialog{async close(e={}){if(["de","en"].includes(game.i18n.lang))return super.close(e)}}const showForbiddenLanguageDialog=()=>{let e={title:game.i18n.localize("language"),content:"<p>Your foundry language is not supported by this system. Due to technical reasons your foundry language setting has to be switched to either english or german.</p>",buttons:{de:{icon:'<i class="fa fa-check"></i>',label:"en",callback:async()=>{await game.settings.set("core","language","de"),foundry.utils.debouncedReload()}},en:{icon:'<i class="fas fa-check"></i>',label:"de",callback:async()=>{await game.settings.set("core","language","en"),foundry.utils.debouncedReload()}},logout:{icon:'<i class="fas fa-door-closed"></i>',label:game.i18n.localize("SETTINGS.Logout"),callback:async()=>{ui.menu.items.logout.onClick()}}}};new ForbiddenLanguageDialog(e).render(!0)},showWrongLanguageDialog=e=>{let t={title:game.i18n.localize("DSASETTINGS.forceLanguage"),content:game.i18n.format("DSAError.wrongLanguage",{lang:e}),buttons:{ok:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("ok"),callback:async()=>{await game.settings.set("core","language",e),foundry.utils.debouncedReload()}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel")}}};new Dialog(t).render(!0)};class DaylightIlluminationShader extends AdaptiveIlluminationShader{static fragmentShader=`\n    ${this.SHADER_HEADER}\n    ${this.PERCEIVED_BRIGHTNESS}\n\n    void main() {\n        ${this.FRAGMENT_BEGIN}\n        ${this.TRANSITION}\n       \n        // Darkness\n        framebufferColor = max(framebufferColor, colorBackground);        \n        // Elevation\n        finalColor = mix(finalColor, max(finalColor, smoothstep( 0.1, 1.0, finalColor ) * 10.0), 1.0) * depth;        \n        // Final\n        gl_FragColor = vec4(finalColor, 1.0);\n      }`}class MacroDSA5{static weaponLessMacro(e){const t=ChatMessage.getSpeaker();let a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor)),this.runWeaponless(a,e,t.token)}static weaponLessMacroId(e,t){let a=game.actors.get(t);this.runWeaponless(a,e)}static requestRoll(e,t=0){_.Z.showRQMessage(e,t)}static requestGC(e,t=0,a={}){_.Z.showGCMessage(e,t,a)}static rollCh(e,t={}){n.Z.check3D20(void 0,e,t)}static itemMacroById(e,t,a,s){let i=game.actors.get(e),n=i?i.items.find((e=>e.name===t&&e.type==a)):null;this.runItem(i,n,t,s)}static itemMacro(e,t,a){const s=ChatMessage.getSpeaker();let i;s.token&&(i=game.actors.tokens[s.token]),i||(i=game.actors.get(s.actor));let n=i?i.items.find((a=>a.name===e&&a.type==t)):null;this.runItem(i,n,e,a,s.token)}static charMacroById(e,t){let a=game.actors.get(t);this.runChar(a,e)}static charMacro(e){const t=ChatMessage.getSpeaker();let a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor)),this.runChar(a,e,t.token)}static runWeaponless(e,t,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));let s=t.split("Weaponless")[0];e.setupWeaponless(s,{},a).then((t=>{e.basicTest(t)}))}static runChar(e,t,a){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:t}));e.setupDodge({},a).then((t=>{e.basicTest(t)}))}static runItem(e,t,a,s,i){if(!e)return ui.notifications.error(game.i18n.format("DSAError.MacroItemMissing",{item:a}));switch(t.type){case"combatskill":case"trait":case"meleeweapon":return e.setupWeapon(t,s.mod,s,i).then((t=>{e.basicTest(t)}));case"rangeweapon":return e.setupWeapon(t,"attack",s,i).then((t=>{e.basicTest(t)}));case"skill":return e.setupSkill(t,s,i).then((t=>{e.basicTest(t)}));case"ceremony":case"ritual":case"spell":case"liturgy":return e.setupSpell(t,s,i).then((t=>{e.basicTest(t)}))}}}let O={};Hooks.once("ready",(()=>{Promise.all([e.Z.allSkillsList(),e.Z.allCombatSkills()]).then((e=>{const a=e[0].reduce(((e,t)=>({...e,[t]:t})),{}),s=e[1].filter((e=>"range"==e.system.weapontype.value)).sort(((e,t)=>e.name.localeCompare(t.name))).reduce(((e,t)=>({...e,[t.name]:t.name})),{}),i=e[1].filter((e=>"melee"==e.system.weapontype.value)).sort(((e,t)=>e.name.localeCompare(t.name))).reduce(((e,t)=>({...e,[t.name]:t.name})),{}),n=e[1].sort(((e,t)=>e.name.localeCompare(t.name))).reduce(((e,t)=>({...e,[t.name]:t.name})),{});mergeObject(O,{ammunition:[{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:t.Z.ammunitiongroups}],equipment:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:t.Z.equipmentTypes}],rangeweapon:[{label:"combatskill",attr:"combatskill.value",type:"select",options:s},{label:"ammunitiongroup",attr:"ammunitiongroup.value",type:"select",options:t.Z.ammunitiongroups}],meleeweapon:[{label:"combatskill",attr:"combatskill.value",type:"select",options:i},{label:"guidevalue",attr:"guidevalue.value",type:"select",options:t.Z.combatskillsGuidevalues},{label:"reach",attr:"reach.value",type:"select",options:t.Z.meleeRanges}],poison:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:t.Z.magicResistanceModifiers}],disease:[{label:"resistanceModifier",attr:"resistance.value",type:"select",options:t.Z.magicResistanceModifiers}],consumable:[{label:"equipmentType",attr:"equipmentType.value",type:"select",options:t.Z.equipmentTypes}],application:[{label:"skill",attr:"skill",type:"select",options:a}],trait:[{label:"traitType",attr:"traitType.value",type:"select",options:t.Z.traitCategories}],career:[{label:"mageLevel",attr:"mageLevel.value",type:"select",options:t.Z.mageLevels}],specialability:[{label:"Category",attr:"category.value",type:"select",options:t.Z.specialAbilityCategories},{label:"combatskill",attr:"list.value",type:"select",options:n,notStrict:!0},{label:"distribution",attr:"distribution",type:"text"}],liturgy:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spell:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ritual:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"},{label:"feature",attr:"feature",type:"text"}],ceremony:[{label:"resistanceModifier",attr:"resistanceModifier.value",type:"select",options:t.Z.magicResistanceModifiers},{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"distribution",attr:"distribution.value",type:"text"}],spellextension:[{label:"Category",attr:"category",type:"select",options:{spell:"spell",liturgy:"liturgy",ritual:"ritual",ceremony:"ceremony"}}],magictrick:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"},{label:"distribution",attr:"distribution",type:"text"}],blessing:[{label:"targetCategory",attr:"targetCategory.value",type:"text"},{label:"feature",attr:"feature.value",type:"text"}],npc:[{label:"species",attr:"details.species.value",type:"text"},{label:"career",attr:"details.career.value",type:"text"},{label:"culture",attr:"details.culture.value",type:"text"}],character:[{label:"species",attr:"details.species.value",type:"text"},{label:"career",attr:"details.career.value",type:"text"},{label:"culture",attr:"details.culture.value",type:"text"}],creature:[{label:"creatureClass",attr:"creatureClass.value",type:"text"},{label:"sizeCategory",attr:"status.size.value",type:"select",options:t.Z.sizeCategories}],armor:[{label:"protection",attr:"protection.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7"}},{label:"encumbrance",attr:"encumbrance.value",type:"select",options:{0:"0",1:"1",2:"2",3:"3",4:"4"}}],plant:[{label:"PLANT.landscape",attr:"location.landscape",type:"text"},{label:"PLANT.region",attr:"location.region",type:"text"},{label:"PLANT.healing",attr:"planttype.healing",type:"checkbox"},{label:"PLANT.poison",attr:"planttype.poison",type:"checkbox"},{label:"PLANT.physical",attr:"planttype.physical",type:"checkbox"},{label:"PLANT.psychic",attr:"planttype.psychic",type:"checkbox"},{label:"PLANT.crop",attr:"planttype.crop",type:"checkbox"},{label:"PLANT.defensive",attr:"planttype.defensive",type:"checkbox"},{label:"PLANT.supernatural",attr:"planttype.supernatural",type:"checkbox"},{label:"PLANT.highNorth",attr:"availability.highNorth",type:"range"},{label:"PLANT.grasLands",attr:"availability.grasLands",type:"range"},{label:"PLANT.swamps",attr:"availability.swamps",type:"range"},{label:"PLANT.woods",attr:"availability.woods",type:"range"},{label:"PLANT.jungle",attr:"availability.jungle",type:"range"},{label:"PLANT.mountains",attr:"availability.mountains",type:"range"},{label:"PLANT.desert",attr:"availability.desert",type:"range"},{label:"PLANT.maraskan",attr:"availability.maraskan",type:"range"}],magicalsign:[],patron:[],demonmark:[]})}))}));const P=O;class SearchDocument{constructor(e,t={}){let a=e.documentName||e.type;switch(e.documentName){case"Actor":case"Item":a=e.type}let s="";if(game.settings.get("dsa5","indexDescription"))switch(a){case"creature":case"npc":case"character":s=getProperty(e,"system.description.value");break;case"JournalEntry":s=getProperty(e,"system.content");break;default:s=getProperty(e,"description.value")}this.document={name:e.name,filterType:a,data:$("<div>").html(s).text(),id:e.id||e._id,visible:!e.visible||e.visible,compendium:e.compendium?e.compendium.metadata.packageName:t.packageName||"",pack:e.pack||(t.packageName?t.id:void 0),img:e.img}}get uuid(){if(this.document.compendium)return`Compendium.${this.document.pack}.${this.document.id}`;switch(this.itemType){case"character":case"creature":case"npc":return`Actor.${this.id}`;case"JournalEntry":return`JournalEntry.${this.id}`;default:return`Item.${this.id}`}}get name(){return this.document.name}get data(){return this.document.data}get id(){return this.document.id}get itemType(){return this.document.filterType}async getItem(){return await fromUuid(this.uuid)}hasPermission(){return this.document.visible}async render(){(await this.getItem()).sheet.render(!0)}get compendium(){return this.document.compendium}get img(){return"JournalEntry"==this.itemType?"systems/dsa5/icons/categories/DSA-Auge.webp":this.document.img}}class AdvancedSearchDocument extends SearchDocument{constructor(e,t){super(e);const a=P[t]||[];for(let t of a)this[t.attr]=t.attr.split(".").reduce(((e,t)=>void 0===e[t]?{}:e[t]),e.system)}}class DSA5ItemLibrary extends Application{constructor(e){super(e),this.advancedFiltering=!1,this.journalBuild=!1,this.journalWorldBuild=!1,this.equipmentBuild=!1,this.equipmentWorldBuild,this.zooBuild=!1,this.zooWorldBuild=!1,this.currentDetailFilter={equipment:[],character:[],spell:[],journal:[],zoo:[]},this.journalIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data"]}}),this.equipmentIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.zooIndex=new FlexSearch({encode:"simple",tokenize:"reverse",cache:!0,doc:{id:"id",field:["name","data","itemType"]}}),this.detailFilter={},this.pages={equipment:{},character:{},spell:{},journal:{},zoo:{}},this.filters={equipment:{categories:{armor:!1,ammunition:!1,equipment:!1,meleeweapon:!1,rangeweapon:!1,poison:!1,disease:!1,consumable:!1,plant:!1},filterBy:{search:""}},character:{categories:{career:!1,advantage:!1,combatskill:!1,culture:!1,disadvantage:!1,trait:!1,skill:!1,specialability:!1,species:!1,application:!1,demonmark:!1,patron:!1},filterBy:{search:""}},spell:{categories:{blessing:!1,ceremony:!1,liturgy:!1,magictrick:!1,ritual:!1,spell:!1,spellextension:!1,magicalsign:!1},filterBy:{search:""}},journal:{categories:{},filterBy:{search:""}},zoo:{categories:{npc:!1,character:!1,creature:!1},filterBy:{search:""}}}}async getData(e){const t=await super.getData(e);return t.categories=this.translateFilters(),t.isGM=game.user.isGM,t.items=this.items,t.advancedMode=this.advancedFiltering?"on":"",t.worldIndexed=game.settings.get("dsa5","indexWorldItems")?"on":"",t.fullTextEnabled=game.settings.get("dsa5","indexDescription")?"on":"",t.browseEnabled=this.browseEnabled?"on":"",this.advancedFiltering&&(t.advancedFilter=await this.buildDetailFilter("tbd",this.subcategory)),t}translateFilters(){return{equipment:this.buildFilter(this.filters.equipment),character:this.buildFilter(this.filters.character),spell:this.buildFilter(this.filters.spell),zoo:this.buildFilter(this.filters.zoo,"Actor"),journal:this.buildFilter(this.filters.journal)}}purgeAdvancedFilters(){for(let e in this.filters)for(let t in this.filters[e].categories)this.filters[e].categories[t]=!1;$(this._element).find('.filter[type="checkbox"]').prop("checked",!1),this.buildDetailFilter("none","none").then((e=>{$(this._element).find(".advancedSearch .groupbox").html(e)}))}buildFilter(e,t="Item"){let a=[];return Object.keys(e.categories).forEach((function(s){a.push({label:game.i18n.localize(`TYPES.${t}.${s}`),selected:e.categories[s],key:s})})),a=a.sort((function(e,t){return e.label.localeCompare(t.label)})),a}static get defaultOptions(){const e=super.defaultOptions;return e.id="DSA5ItemLibrary",e.classes.push("dsa5","itemlibrary"),e.height=800,e.width=800,e.resizable=!0,e.title=game.i18n.localize("ItemLibrary"),e.template="systems/dsa5/templates/system/itemlibrary.html",e.tabs=[{navSelector:".tabs",contentSelector:".content",initial:"equipment"}],e}async getRandomItems(e,t){let a=[],s=this.equipmentIndex;return a.push(...await s.search(e,{field:["itemType"]})),(await Promise.all(this.shuffle(a.filter((e=>e.hasPermission))).slice(0,t+5).map((e=>e.getItem())))).filter((e=>{const t=e.getFlag("dsa5","enchantments");return!t||!t.find((e=>e.talisman))})).slice(0,t)}shuffle(e){let t,a,s=e.length;for(;0!==s;)a=Math.floor(Math.random()*s),s-=1,t=e[s],e[s]=e[a],e[a]=t;return e}async findCompendiumItem(e,t,a=!0){this.equipmentBuild||await this.buildEquipmentIndex();let s={field:["name"],where:{itemType:t}},i=await this.equipmentIndex.search(e,s);return a&&(i=i.filter((e=>""!=e.compendium))),await Promise.all(i.map((e=>e.getItem())))}async getCategoryItems(e,t=!1,a=!1){await this.buildEquipmentIndex();const s=this.equipmentIndex.search(e,{field:["itemType"]});return t?(await Promise.all(s.map((e=>e.getItem())))).map((e=>e.toObject())):a?await Promise.all(s.map((e=>e.getItem()))):s}async executeAdvancedFilter(e,t,a,s,i,n=[]){let r=t.where((t=>(""==e||-1!=t.name.toLowerCase().indexOf(e))&&(e=>{for(let t of a)if(e[2]?e[t[0]]!=t[1]:-1==e[t[0]].indexOf(t[1]))return!1;return!0})(t)&&(e=>{for(let t of s)if(-1==e[t[0]].toLowerCase().indexOf(t[1]))return!1;return!0})(t)&&(e=>{for(let t of i)if(e[t[0]]!=t[1])return!1;return!0})(t)&&(e=>{for(let t of n)if(e[t[0]]<t[1]||e[t[0]]>t[2])return!1;return!0})(t)));return r=r.filter((e=>e.hasPermission)).sort(((e,t)=>e.name.toLowerCase()>t.name.toLowerCase()?1:-1)),r}async advancedFilterStuff(e,t){const a=$(this._element).find(".detailFilters"),s=a.attr("data-subc");let i=this.filters[e].filterBy.search.toLowerCase(),n=this.detailFilter[s];const r=[],o=[],l=[];for(let e of a.find("select")){let t=$(e).val();""!=t&&r.push([$(e).attr("name"),t,"true"!=e.dataset.notstrict])}for(let e of a.find('input[type="text"]:not(.manualFilter)')){let t=$(e).val();""!=t&&o.push([$(e).attr("name"),t.toLowerCase()])}for(let e of a.find('input[type="checkbox"]:checked:not(.manualFilter)')){let t=$(e).val();""!=t&&l.push([$(e).attr("name"),t.toLowerCase()])}let c=await this.executeAdvancedFilter(i,n,r,o,l);return this.setBGImage(c,e),c}async filterStuff(e,t,a){let s=this.filters[e].filterBy.search,i={field:["name","data"],limit:60,page:a||!0},n=[],r=!1;for(let o in this.filters[e].categories){if(this.filters[e].categories[o]){let r;if(""==s)r=t.search(o,{field:["itemType"],limit:60,page:a||!0});else{let e=duplicate(i);mergeObject(e,{where:{itemType:o}}),r=t.search(s,e)}this.pages[e].next=r.next,n.push(...r.result)}r=this.filters[e].categories[o]||r}return r||(n=t.search(s,i),this.pages[e].next=n.next),n=n.result?n.result:n,n=n.filter((e=>e.hasPermission)).sort(((e,t)=>e.name.toLowerCase()>t.name.toLowerCase()?1:-1)),this.setBGImage(n,e),n}setBGImage(e,t){$(this._element).find(`.${t} .libcontainer`)[(e.length>0?"remove":"add")+"Class"]("libraryImg")}async getItemTemplate(e,t){if(this.browseEnabled&&"Item"==t)return(await Promise.all(e.map((async e=>{const t=`systems/dsa5/templates/items/browse/${e.document.filterType}.html`,a=await fromUuid(e.uuid),s=await renderTemplate(t,{document:a,isGM:game.user.isGM,...await a.sheet.getData()});return`<div class="uuid libItem ${e.document.filterType} col" data-uuid="${e.uuid}" data-item-id="${e.id}">${s}</div>`})))).join("\n");{const t="systems/dsa5/templates/system/libraryItem.html";return await renderTemplate(t,{items:e})}}async renderResult(e,t,{index:a,itemType:s},i){const n=e.find(".searchResult .item-list");let r=await this.getItemTemplate(t,s);i||n.empty(),r=$(r),r.each((function(){const e=$(this);e.attr("draggable",!0).on("dragstart",(t=>{let i=a.find($(e).attr("data-item-id"));t.originalEvent.dataTransfer.setData("text/plain",JSON.stringify({type:s,uuid:i.uuid}))}))})),n.append(r)}async filterItems(e,t,a){const s=this.selectIndex(t),i=this.advancedFiltering&&"journal"!=t?await this.advancedFilterStuff(t,a):await this.filterStuff(t,s.index,a);return await this.renderResult(e,i,s,a),i}selectIndex(e){let t="Item",a=this.equipmentIndex;switch(e){case"zoo":t="Actor",a=this.zooIndex;break;case"journal":t="JournalEntry",a=this.journalIndex}return{index:a,itemType:t}}async _render(e=!1,t={}){await super._render(e,t),this.buildEquipmentIndex()}async buildEquipmentIndex(){await this._createIndex("equipment","Item",game.items)}async _createIndex(e,t,a){if(this[`${e}Build`])return;SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:0});const s=$(this._element).find(`*[data-tab="${e}"]`);this.showLoading(s,e);const i=game.packs.filter((e=>e.documentName==t&&(game.user.isGM||!e.private))),n=100/(i.length+1);let r=n;const o=["name","system.type","system.description.value","img"];let l;l="Actor"==t?e=>e.getIndex({actorFields:o}):"JournalEntry"==t?e=>e.getDocuments():e=>e.getDocuments({type__in:game.system.documentTypes.Item});const c=this.indexWorldItems(a,e);SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:"world items"}),pct:Math.round(n)});let d=i.map((async e=>{const t=await l(e);r+=n,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:`${e.metadata.label} (${e.metadata.id})`}),pct:Math.round(r)}),c.push(...t.map((t=>new SearchDocument(t,e.metadata))))}));return Promise.all(d).then((t=>{this[`${e}Index`].add(c),this[`${e}Build`]=!0,SceneNavigation.displayProgressBar({label:game.i18n.format("Library.loading",{item:""}),pct:100}),this.hideLoading(s,e)}))}subcategoryFields(e){let t=["name","itemType"];const a=P[e]||[];for(let e of a)t.push(e.attr);return t}indexWorldItems(e,t){const a=[];return game.settings.get("dsa5","indexWorldItems")&&(a.push(...e.filter((e=>e.visible)).map((e=>new SearchDocument(e)))),this[`${t}WorldBuild`]=!0),a}async createDetailIndex(e,t){if(!this.detailFilter[t]){const a=this.subcategoryFields(t),s=$(this._element).find(`*[data-tab="${e}"]`);s.find(".searchResult ul").html(""),this.showLoading(s,e),this.detailFilter[t]=new FlexSearch({encode:"simple",tokenize:"full",cache:!0,doc:{id:"id",field:a}});const{index:i,itemType:n}=this.selectIndex(e);let r=("Item"==n?game.items:game.actors).filter((e=>e.visible&&e.type==t)).map((e=>new AdvancedSearchDocument(e,t)));const o=i.search(t,{field:["itemType"]}),l={};for(let e of o)e.document.pack&&(l[e.document.pack]||(l[e.document.pack]=[]),l[e.document.pack].push(e.document.id));const c=[];for(const e of Object.entries(l))c.push(game.packs.get(e[0]).getDocuments({_id__in:e[1],type:t}));let d=await Promise.all(c);for(let e of d)r.push(...e.map((e=>new AdvancedSearchDocument(e,t))));this.detailFilter[t].add(r),this.hideLoading(s,e)}}async buildDetailFilter(e,t){const a=P[t]||[];if(a){let s=this.createDetailIndex(e,t);const i=await renderTemplate("systems/dsa5/templates/system/detailFilter.html",{fields:a,subcategory:t});return await s,i}return`<p>${game.i18n.localize("Library.selectAdvanced")}</p>`}checkWorldStuffIndex(){game.settings.get("dsa5","indexWorldItems")&&(!this.journalWorldBuild&&this.journalBuild&&this.journalIndex.add(this.indexWorldItems(game.journal,"journal")),!this.equipmentWorldBuild&&this.equipmentBuild&&this.equipmentIndex.add(this.indexWorldItems(game.items,"equipment")),!this.zooWorldBuild&&this.zooBuild&&this.zooIndex.add(this.indexWorldItems(game.actors,"zoo")))}activateListeners(t){super.activateListeners(t),(0,l.Ee)(t),t.on("click",".searchableAbility a",(e=>(0,l.$8)(e))),t.on("click",".toggleAdvancedMode",(()=>{this.advancedFiltering=!this.advancedFiltering,this.advancedFiltering?($(this._element).find(".toggleAdvancedMode").addClass("on"),$(this._element).find(".advancedSearch").fadeIn(),this.purgeAdvancedFilters()):($(this._element).find(".toggleAdvancedMode").removeClass("on"),$(this._element).find(".advancedSearch").fadeOut())})),t.on("change",".detailFilters input, .detailFilters select",(()=>{const e=$(this._element).find(".tab.active"),t=e.attr("data-tab");this.filterItems(e,t)})),t.on("click",".filter",(async e=>{const t=$(e.currentTarget).closest(".tab"),a=t.attr("data-tab"),s=e.currentTarget.dataset.category,i=$(e.currentTarget).is(":checked");this.advancedFiltering&&i&&(this.purgeAdvancedFilters(),this.subcategory=s,$(e.currentTarget).prop("checked",i),$(this._element).find(".advancedSearch .groupbox").html(await this.buildDetailFilter(a,s))),this.filters[a].categories[s]=i,this.filterItems(t,a)})),t.on("click",".item-name",(e=>{this.getItemFromHTML(e).render()})),t.on("mousedown",".item-name",(t=>{2==t.button&&e.Z.showArtwork(this.getItemFromHTML(t))})),t.on("keyup",".filterBy-search",(e=>{const t=$(e.currentTarget).closest(".tab"),a=t.attr("data-tab");this.filters[a].filterBy.search=$(e.currentTarget).val(),this.filterItems(t,a)})),t.on("click",".show-item",(async e=>{const t=e.currentTarget.dataset.uuid,a=await fromUuid(t);a&&a.sheet.render(!0)})),t.find('*[data-tab="journal"]').click((e=>{this._createIndex("journal","JournalEntry",game.journal)})),t.find('*[data-tab="zoo"]').click((e=>{this._createIndex("zoo","Actor",game.actors)})),t.find(".showDetails").click((e=>{const a=e.currentTarget.dataset.btn;$(e.currentTarget).find("i").toggleClass("fa-caret-left fa-caret-right"),t.find(`.${a} .detailBox`).toggleClass("dsahidden")})),t.find(".toggleWorldIndex").click((e=>{game.settings.set("dsa5","indexWorldItems",!game.settings.get("dsa5","indexWorldItems")),this.checkWorldStuffIndex(),$(e.currentTarget).toggleClass("on")})),t.find(".fulltextsearch").click((e=>{game.settings.set("dsa5","indexDescription",!game.settings.get("dsa5","indexDescription")),$(e.currentTarget).toggleClass("on")})),t.find(".browseEnabled").click((e=>{this.browseEnabled=!this.browseEnabled,$(e.currentTarget).toggleClass("on")}));const a=this;$(this._element).find(".window-content").on("scroll.infinit",debounce((function(e){if(a.advancedFiltering)return;const s=$(e.target),i=s.scrollTop()+s.innerHeight()>=s[0].scrollHeight-100,n=t.find(".tabs .item.active").attr("data-tab");if(i&&a.pages[n].next){const e=t.find(".tab.active");a.filterItems.call(a,e,n,a.pages[n].next)}}),100))}getItemFromHTML(e){const t=$(e.currentTarget).parents(".browser-item").attr("data-item-id");switch($(e.currentTarget).closest(".tab").attr("data-tab")){case"zoo":return this.zooIndex.find(t);case"journal":return this.journalIndex.find(t);default:return this.equipmentIndex.find(t)}}showLoading(e,t){this.setBGImage([1],t);$(`<div class="loader"><i class="fa fa-4x fa-spinner fa-spin"></i>${game.i18n.localize("Library.buildingIndex")}</div>`).appendTo(e.find(".searchResult"))}hideLoading(e,t){this.setBGImage([],t),e.find(".loader").remove()}}class DSA5Initializer extends Dialog{constructor(e,t,a,s=""){super({title:e,content:t,buttons:{initialize:{label:game.i18n.localize("initialize"),callback:async()=>{this.lock||await this.initialize()}},cancel:{label:game.i18n.localize("cancel"),callback:async()=>{this.lock||await this.dontInitialize()}}}}),this.module=a,this.lang=s,this.folders={},this.journals={},this.scenes={},this.actors={},this.lock=!1}async initNotes(e,t,a){let s=await this.getFolderForType("JournalEntry");for(let i of e.notes)try{let e=t.find((e=>e.flags.dsa5.initId==i.entryId));if(!a.has(e._id)){const t=getProperty(e,"flags.dsa5.parent");let n=s;this.folders[t]?n=this.folders[t]:t&&(n=await this.getFolderForType("JournalEntry",s.id,t,0,getProperty(e,"flags.dsa5.foldercolor")||"")),e.folder=n.id;let r=game.journal.find((t=>t.name==e.name&&t.folder?.id==n.id&&t.flags.dsa5.initId==i.entryId));if(r)await r.update(e),a.set(e._id,r.id);else{let t=await JournalEntry.create(e);a.set(e._id,t.id)}}i.entryId=a.get(e._id)}catch(t){console.warn(`Could not initialize Scene Notes for scene :${e.name}`+t)}}async initScenes(e){let t=await this.getFolderForType("Scene"),a=game.packs.get(e.scenes),s=(await a.getDocuments()).map((e=>e.toObject())),i=game.packs.get(e.journal),n=(await i.getDocuments()).map((e=>e.toObject())),r=[],o=[],l=new Map,c=!1;for(let e of s){let a=c,s=game.scenes.find((a=>a.name==e.name&&a.folder?.id==t.id));!c&&s&&([a,c]=await new Promise(((t,a)=>{new Dialog({title:game.i18n.localize("Book.sceneReset"),content:game.i18n.format("Book.sceneResetDescription",{name:e.name}),default:"Yes",buttons:{Yes:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("yes"),callback:()=>{t([!0,!1])}},all:{icon:'<i class="fa fa-check"></i>',label:game.i18n.localize("LocalizedIDs.all"),callback:()=>{t([!0,!0])}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("cancel"),callback:()=>{t([!1,!1])}}},close:()=>{t([!1,!1])}}).render(!0)}))),!s||a?(e.folder=t.id,await this.initNotes(e,n,l),s?(e._id=s.id,o.push(e)):r.push(e)):this.scenes[s.name]=s}let d=await Scene.create(r,{dsaInit:!0});for(let e of d){this.scenes[e.name]=e;const t=await e.createThumbnail();await e.update({thumb:t.thumb},{diff:!1})}for(let e of o){let t=game.scenes.get(e._id);await t.update(e),this.scenes[e.name]=game.scenes.get(e._id)}if(e.initialScene){const t=this.scenes[e.initialScene];await game.settings.set("core",NotesLayer.TOGGLE_SETTING,!0),await t.activate(),await t.update({navigation:!0})}}async initialize(){this.lock=!0;let e=$(this._element).find(".initialize");e.prepend('<i class="fas fa-spinner fa-spin"></i>');let t={};try{game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0)}catch{}try{await fetch(`modules/${this.module}/adventure${this.lang}.json`).then((async e=>e.json())).then((async e=>{t=e}))}catch{try{await fetch(`modules/${this.module}/adventure.json`).then((async e=>e.json())).then((async e=>{t=e}))}catch{console.warn(`Could not find book data for ${this.module} import.`)}}await fetch(`modules/${this.module}/initialization${this.lang}.json`).then((async e=>e.json())).then((async e=>{let a=e.folders;if(a){let t=await this.getFolderForType("JournalEntry"),s=e.folders[0].name;t&&(this.folders[t.data.name]=t,e.folders.shift());let i=await Folder.create(a);Array.isArray(i)||(i=[i]);for(let e of i)this.folders[e.data.name]=e;const n=[];for(let e in this.folders){const t=this.folders[e].getFlag("dsa5","parent");let a=t==s?game.i18n.localize(`${this.module}.name`):t;a&&n.push({_id:this.folders[e].id,parent:this.folders[a].id})}await Folder.updateDocuments(n)}if(e.items&&e.items.length>0){let t=await this.getFolderForType("Item"),a=[],i=[];for(let s of e.items){s.folder=t.id;let e=game.items.find((e=>e.name==s.name&&e.folder?.id==t.id));e?(s._id=e.id,i.push(s)):a.push(s)}await s.Z.create(a),await s.Z.updateDocuments(i)}if(e.playlists){let t=await this.getFolderForType("Playlist"),a=[],s=[],i=game.packs.get(e.playlists),n=(await i.getDocuments()).map((e=>e.toObject()));for(let e of n){e.folder=t.id;let i=game.playlists.find((a=>a.name==e.name&&a.folder?.id==t.id));i?(e._id=i.data._id,s.push(e)):a.push(e)}await Playlist.create(a,{keepId:!0}),await Playlist.updateDocuments(s)}if(e.scenes&&await this.initScenes(e),e.actors){let a=await this.getFolderForType("Actor"),s=game.packs.get(e.actors),i=(await s.getDocuments()).map((e=>e.toObject())),n=[],r=[],o=new Map,l=0;if(getProperty(t,"chapters"))for(const e of t.chapters)for(const t of e.content)if(t.actors){let e=!1;for(const a of t.actors)o.has(a)||(o.set(a,t.name),e=!0);e&&(await this.getFolderForType("Actor",a.id,t.name,l),l+=1)}for(let e of i){const t=o.has(e.name)?await this.getFolderForType("Actor",a.id,o.get(e.name)):a;e.folder=t.id,e._id&&delete e._id;let s=game.actors.find((s=>s.name==e.name&&[a.id,t.id].includes(s.folder?.id)));s?(e._id=s.id,await s.deleteEmbeddedDocuments("Item",s.items.map((e=>e.id))),r.push(e)):n.push(e)}let c=await Actor.create(n);await Actor.updateDocuments(r);for(let e of c)this.actors[e.name]=e}})),this.lock=!1,e.find("i").remove(),ui.notifications.notify(game.i18n.localize("initComplete")),await this.close()}async dontInitialize(){game.settings.settings.has(`${this.module}.initialized`)&&await game.settings.set(this.module,"initialized",!0),ui.notifications.notify(game.i18n.localize("initSkipped")),await this.close()}submit(e){try{e.callback&&e.callback(this.options.jQuery?this.element:this.element[0])}catch(e){throw ui.notifications.error(e),new Error(e)}}async getFolderForType(t,a=null,s=null,i=0,n=""){return s||(s=game.i18n.localize(`${this.module}.name`)),e.Z.getFolderForType(t,a,s,i,n)}}class ChatMessageDSA5Roll extends ChatMessage{get isRoll(){return this.isDSARoll||super.isRoll}get roll(){return this.isDSARoll?new EmptyRoll(""):super.roll}get isDSARoll(){return!!this.flags.data&&this.flags.data.isDSARoll}}class EmptyRoll extends Roll{render(){return""}}class DSA5Hotbar extends Hotbar{async _render(e=!1,t={}){await super._render(e,t),this.addContextColor()}async collapse(){return!!this._collapsed||($(this.element).addClass("collapsedHotbar"),super.collapse())}async expand(){return!this._collapsed||($(this.element).removeClass("collapsedHotbar"),super.expand())}addContextColor(){const e=new RegExp(` ${game.i18n.localize("CHAR.PARRY")}$`),t=new RegExp(` ${game.i18n.localize("CHAR.ATTACK")}$`),a=$(this._element).find("#macro-list");for(const s of this.macros)s.macro&&(e.test(s.macro.name)?a.find(`[data-macro-id="${s.macro.id}"]`).addClass("parry"):t.test(s.macro.name)&&a.find(`[data-macro-id="${s.macro.id}"]`).addClass("attack"))}}class RollMemory{constructor(){this.tokens={},this.actors={}}static get wantedKeys(){const e=["vision","targetMovement","shooterMovement","quickChange","mountOptions","narrowSpace","advantageousPosition","doubleAttack","reduceCostSpell","forceSpell","increaseCastingTime","decreaseCastingTime","removeGesture","removeFormula"];return C.Z.isEnabled||e.push("distance"),e}getPath(e,t,a){let s=a||"";const i=t._id||t.type;return e.token?`tokens.${e.token||e.actor}.${i}${s}`:`actors.${e.actor}.${i}${s}`}remember(e,t,a,s){const i=this.formDataSerialize(s);Object.entries(i).length>0&&setProperty(this,this.getPath(e,t,a),i)}recall(e,t,a){return getProperty(this,this.getPath(e,t,a))}formDataSerialize(e){let t=e.find("form"),a={};return t.find("select").each((function(){let e=$(this).attr("name");RollMemory.wantedKeys.includes(e)&&(a[e]=$(this).val())})),t.find('input[type="checkbox"]').each((function(){let e=$(this).attr("name");RollMemory.wantedKeys.includes(e)&&(a[e]=this.checked)})),t.find(".specAbs.active").each((function(){a.specAbs||(a.specAbs=[]),a.specAbs.push({id:$(this).attr("data-id"),step:$(this).attr("data-step")})})),e.find('[name="situationalModifiers"] option').each((function(){a.situationalModifiers||(a.situationalModifiers=[]),a.situationalModifiers.push({name:$(this).text().trim(),selected:this.selected})})),a}}var z=__webpack_require__(430);class DSAActiveEffect extends ActiveEffect{static itemChangeRegex=/^@/;apply(e,t){if(!DSAActiveEffect.itemChangeRegex.test(t.key))return super.apply(e,t);{const a=this._getModifiedItems(e,t);for(let e of a.items){const s=foundry.utils.flattenObject(e.overrides||{});s[a.key]=Number.isNumeric(e.value)?Number(a.value):a.value;const i={...t,key:a.key,value:a.value};super.apply(e,i),e.overrides=foundry.utils.expandObject(s)}}}isVisibleEffect(){return!this.disabled&&!this.notApplicable&&(game.user.isGM||!this.getFlag("dsa5","hidePlayers"))&&!this.getFlag("dsa5","hideOnToken")&&(this.origin==this.target?.uuid||!this.origin)}_displayScrollingStatus(e){(game.user.isGM||this.target?.testUserPermission(game.user,"OBSERVER")||!game.settings.get("dsa5","hideEffects")?this.isVisibleEffect():["dead"].some((e=>this.statuses.has(e))))&&super._displayScrollingStatus(e)}_getModifiedItems(e,t){const a=t.key.split(".");let s=a.shift();s=s.replace("@","").toLowerCase();const i=a.shift(),n=a.join("."),r=t.value;return{items:e?.items?.filter((e=>e.type==s&&(e.name==i||e.id==i)))||[],key:n,value:r}}async _preUpdate(e,t,a){super._preUpdate(e,t,a),this._clearModifiedItems()}_clearModifiedItems(){if(!(!this.parent instanceof CONFIG.Actor.documentClass))for(let e of this.changes)if(DSAActiveEffect.itemChangeRegex.test(e.key)){const t=this._getModifiedItems(this.parent,e);for(const e of t.items){const a=foundry.utils.flattenObject(e.overrides||{}),s=t.key;delete a[s];const i=getProperty(e._source,s);setProperty(e,s,i),e.overrides=foundry.utils.expandObject(a),e.sheet?.rendered&&e.sheet.render(!0)}}}async _preDelete(e,t){super._preDelete(e,t),this._clearModifiedItems()}}Hooks.on("applyActiveEffect",((e,t)=>((e,t)=>{let a=getProperty(e,t.key)||null;null==a&&/^system\.(vulnerabilities|resistances)/.test(t.key)&&(a=[],setProperty(e,t.key,a));let s=null;if("Array"===getType(a)){let e=[];const i=t.effect.name;for(let a of`${t.value}`.split(/[;,]+/)){let t=a.split(" ");const s=t.pop(),n=t.join(" ");e.push({source:i,value:s,target:n})}s=a.concat(e)}return null!==s&&setProperty(e,t.key,s),s})(e,t)));var x=__webpack_require__(174);Hooks.once("init",(()=>{console.log("Initializing DSA5 system"),CONFIG.statusEffects=t.Z.statusEffects,game.dsa5={apps:{DSA5_Utility:e.Z,DSA5Initializer,DSA5ChatListeners:n.Z,DSA5Payment,SpecialabilityRulesDSA5:i.Z,AdvantageRulesDSA5:a.Z,Migrakel,DSA5Dialog:w.Z,DSA5StatusEffects:r.Z,DPS:C.Z,DSATables:z.Z,DSA5SoundEffect:c.Z,RequestRoll:_.Z,DiceDSA5:y.Z,DSATour:T.Z,OpposeDSA:b.Z,EquipmentDamage:f.Z,DidYouKnow,MeasuredTemplateDSA:x.c,Riding:g.Z,RuleChaos:d.Z},entities:{Actordsa5:o.Z,Itemdsa5:s.Z},sheets:{ActorSheetdsa5:ActorSheetDsa5,ActorSheetdsa5Character,ActorSheetdsa5Creature,ActorSheetdsa5NPC,MerchantSheetMixin,MerchantSheetDSA5,ItemSheetdsa5},wizards:{CareerWizard,CultureWizard,SpeciesWizard},view:{tinyNotification:l.p0,tabSlider:l.Ee,clickableAbility:l.$8},macro:MacroDSA5,config:t.Z,memory:new RollMemory,itemLibrary:new DSA5ItemLibrary},CONFIG.Actor.documentClass=o.Z,CONFIG.Item.documentClass=s.Z,CONFIG.ChatMessage.template="systems/dsa5/templates/chat/chat-message.html",CONFIG.ChatMessage.documentClass=ChatMessageDSA5Roll,CONFIG.ui.combat=DSA5CombatTracker,CONFIG.ui.hotbar=DSA5Hotbar,CONFIG.Combat.documentClass=DSA5Combat,CONFIG.Combatant.documentClass=DSA5Combatant,CONFIG.ActiveEffect.documentClass=DSAActiveEffect})),function init(){!function handlebars(){Handlebars.registerHelper({concatUp:(e,t)=>e+t.toUpperCase(),mod:(e,t)=>e%t,roman:(e,t)=>null!=t&&Number(t)<2?"":[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"][e-1],isWEBM:e=>/.webm$/.test(e),itemCategory:t=>e.Z.categoryLocalization(t),joinStr:(e,t)=>t.join(e),attrName:t=>e.Z.attributeLocalization(t),attrAbbr:t=>e.Z.attributeAbbrLocalization(t),diceThingsUp:(t,a)=>e.Z.replaceDies(t,!1),clickableAbilities:(e,t)=>function clickableAbilities(e,t){return`<span class="searchableAbility" data-category="${t}">`+e.split(",").map((e=>`<a>${e}</a>`)).join(", ")+"<span>"}(e,t),hasLocalization:(e,t)=>{const a=e.string||e;return game.i18n.has(a)?game.i18n.localize(a):t||""},replaceConditions:e.Z.replaceConditions,floor:e=>Math.floor(Number(e)),br:e=>e.replace(/\n/g,"<br/>"),getAttr:(e,t,a)=>e.system.characteristics[t][a],hasElem:(e,t)=>e.includes(t),situationalTooltip:e=>{const t=game.i18n.localize(v[e.type]||"Modifier");let a=`${e.name}<br/>${t}: ${e.value}`;return e.source&&(a+=`<br/>${game.i18n.localize("source")}: ${e.source}`),a},grouped_each:(e,t,a)=>{let s,i="",n=[];if(t&&t.length>0){for(s=0;s<t.length;s++)s>0&&s%e==0&&(i+=a.fn(n),n=[]),n.push(t[s]);i+=a.fn(n)}return i},plantify:e=>game.i18n.localize(`PLANT.avLevels.${e||0}`),oddLength:e=>e.length%2==1})}(),function dicesonice(){Hooks.once("init",(()=>{game.dsa5.apps.DiceSoNiceCustomization=new DiceSoNiceCustomization})),Hooks.once("diceSoNiceReady",((e,t,a,s)=>{e.addColorset({name:"mu",description:"DSA5.mu",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"kl",description:"DSA5.kl",category:"DSA5.dies",foreground:"#FFFFFF",background:"#8259a3",edge:"#8259a3",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"in",description:"DSA5.in",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ch",description:"DSA5.ch",category:"DSA5.dies",foreground:"#FFFFFF",background:"#0d0d0d",edge:"#0d0d0d",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ff",description:"DSA5.ff",category:"DSA5.dies",foreground:"#000000",background:"#d5b467",edge:"#d5b467",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ge",description:"DSA5.ge",category:"DSA5.dies",foreground:"#000000",background:"#688ec4",edge:"#688ec4",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"ko",description:"DSA5.ko",category:"DSA5.dies",foreground:"#000000",background:"#a3a3a3",edge:"#a3a3a3",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"kk",description:"DSA5.kk",category:"DSA5.dies",foreground:"#000000",background:"#d6a878",edge:"#d6a878",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"attack",description:"DSA5.attack",category:"DSA5.dies",foreground:"#FFFFFF",background:"#b3241a",edge:"#b3241a",outline:"#b3241a",texture:"none"}),e.addColorset({name:"dodge",description:"DSA5.dodge",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),e.addColorset({name:"parry",description:"DSA5.parry",category:"DSA5.dies",foreground:"#FFFFFF",background:"#388834",edge:"#388834",outline:"#FFFFFF",texture:"none"}),game.dsa5.apps.DiceSoNiceCustomization.initConfigs(),DiceSoNiceCustomization.onConnect()}))}(),actor(),function macro_support(){Hooks.on("hotbarDrop",((e,t,a)=>{if("dodge"==t.mod){let e,s={name:game.i18n.localize(t.mod),img:"systems/dsa5/icons/categories/Dodge.webp"};return e=game.user.isGM||null==t.actorId?`game.dsa5.macro.charMacro("${t.mod}")`:`game.dsa5.macro.charMacroById("${t.mod}", "${t.actorId}")`,createHotBarMacro(e,s.name,s.img,a)}if("attackWeaponless"==t.mod||"parryWeaponless"==t.mod){let e,s={name:game.i18n.localize(t.mod),img:"systems/dsa5/icons/categories/attack_weaponless.webp"};return e=game.user.isGM||null==t.actorId?`game.dsa5.macro.weaponLessMacro("${t.mod}")`:`game.dsa5.macro.weaponLessMacroId("${t.mod}", "${t.actorId}")`,createHotBarMacro(e,s.name,s.img,a)}if("Item"==t.type){const e=fromUuidSync(t.uuid);if(!["ritual","ceremony","meleeweapon","rangeweapon","skill","combatskill","spell","liturgy","char","trait"].includes(e.type))return;if(!("meleeweapon"!=e.type&&"combatskill"!=e.type||["attack","parry"].includes(t.mod)))return;if(("rangeweapon"==e.type||"trait"==e.type)&&!["attack"].includes(t.mod))return;let s,i=`{mod: "${t.mod}"}`;return s=game.user.isGM||null==t.actorId?`game.dsa5.macro.itemMacro("${e.name}", "${e.type}", ${i});`:`game.dsa5.macro.itemMacroById("${t.actorId}", "${e.name}", "${e.type}", ${i})`,createHotBarMacro(s,null==t.mod?e.name:`${e.name} - ${game.i18n.localize("CHAR."+t.mod.toUpperCase())}`,e.img,a)}if("Actor"==t.type||"JournalEntry"==t.type){const e=fromUuidSync(t.uuid);return createHotBarMacro(`(await fromUuid('${t.uuid}')).sheet.render(true)`,e.name,e.img,a)}}))}(),chatlog(),function ready(){Hooks.on("ready",(async()=>{game.socket.on("system.dsa5",(e=>{if("hideDeletedSheet"===e.type){let t=e.payload.target.token?game.actors.tokens[e.payload.target.token]:game.actors.get(e.payload.target.actor);MerchantSheetDSA5.hideDeletedSheet(t)}})),game.user.isGM&&game.socket.on("system.dsa5",(a=>{if(e.Z.isActiveGM())switch(a.type){case"updateKeepField":t.Z.allowedforeignfields.includes(a.payload.field)&&game.actors.get(a.payload.actorId).update({[a.payload.field]:a.payload.updateData});break;case"target":{let e=game.scenes.get(a.payload.scene);new Token(e.getEmbeddedDocument("Token",a.payload.target)).actor.update({"flags.oppose":a.payload.opposeFlag})}break;case"addEffect":k.Z.applyEffect(a.payload.id,a.payload.mode,a.payload.actors);break;case"updateMsg":game.messages.get(a.payload.id).update(a.payload.updateData);break;case"deleteMsg":game.messages.get(a.payload.id).delete();break;case"showDamage":b.Z.showDamage(game.messages.get(a.payload.id),a.payload.hide);break;case"hideQueryButton":b.Z.hideReactionButton(a.payload.id);break;case"updateGroupCheck":_.Z.rerenderGC(game.messages.get(a.payload.messageId),a.payload.data);break;case"updateAttackMessage":game.messages.get(a.payload.messageId).update({"flags.data.unopposedStartMessage":a.payload.startMessageId});break;case"clearCombat":game.combat&&game.combat.nextRound();break;case"clearOpposed":b.Z.clearOpposed(game.actors.get(a.payload.actorId));break;case"updateDefenseCount":game.combat&&game.combat.updateDefenseCount(a.payload.speaker);break;case"trade":{let e=a.payload.source.token?game.actors.tokens[a.payload.source.token]:game.actors.get(a.payload.source.actor),t=a.payload.target.token?game.actors.tokens[a.payload.target.token]:game.actors.get(a.payload.target.actor);MerchantSheetDSA5.finishTransaction(e,t,a.payload.price,a.payload.itemId,a.payload.buy,a.payload.amount)}break;case"playWhisperSound":a.payload.whisper.includes(game.user.id)&&AudioHelper.play({src:a.payload.soundPath,volume:.8,loop:!1},!1);break;case"socketedConditionAddActor":fromUuid(a.payload.id).then((e=>{new m.Z(e).socketedConditionAddActor(a.payload.actors.map((e=>game.actors.get(e))),a.payload.data)}));break;case"socketedConditionAdd":fromUuid(a.payload.id).then((e=>{new m.Z(e).socketedConditionAdd(a.payload.targets,a.payload.data)}));break;case"socketedRemoveCondition":fromUuid(a.payload.id).then((e=>{new m.Z(e).socketedRemoveCondition(a.payload.targets,a.payload.coreId)}));break;case"socketedActorTransformation":fromUuid(a.payload.id).then((e=>{new m.Z(e).socketedActorTransformation(a.payload.targets,a.payload.update)}));break;case"itemDrop":{let e=a.payload.sourceActorId?game.actors.get(a.payload.sourceActorId):void 0;fromUuid(a.payload.itemId).then((t=>{dropToGround(e,t,a.payload.data,a.payload.amount)}))}break;case"hideDeletedSheet":case"finalizeidentification":case"updateHits":case"hideResistButton":break;case"reduceGroupSchip":o.Z.reduceGroupSchip();break;case"summonCreature":PlayerMenu.createConjuration(a.payload);break;default:console.warn(`Unhandled socket data type ${a.type}`)}})),e.Z.moduleEnabled("vtta-tokenizer")&&!await game.settings.get("dsa5","tokenizerSetup")&&game.user.isGM&&(await game.settings.set("vtta-tokenizer","default-frame-pc","[data] systems/dsa5/icons/backgrounds/token_green.webp"),await game.settings.set("vtta-tokenizer","default-frame-npc","[data] systems/dsa5/icons/backgrounds/token_black.webp"),await game.settings.set("vtta-tokenizer","default-frame-neutral","[data] systems/dsa5/icons/backgrounds/token_blue.webp"),await game.settings.set("dsa5","tokenizerSetup",!0)),e.Z.moduleEnabled("dice-so-nice")&&!await game.settings.get("dsa5","diceSetup")&&game.user.isGM&&(await game.settings.set("dice-so-nice","immediatelyDisplayChatMessages",!0),await game.settings.set("dsa5","diceSetup",!0)),await DSA5Tutorial.firstTimeMessage(),s.Z.setupSubClasses(),DidYouKnow.showOneMessage(),game.settings.get("dsa5","disableTokenhotbar")||TokenHotbar2.registerTokenHotbar(),connectHook(),DSAIniTracker.connectHooks();const hook=e=>{"settings"==e.tabName&&(T.Z.travelAgency(),Hooks.off("changeSidebarTab",hook))};Hooks.on("changeSidebarTab",hook),(0,S.v)(),(0,A.Y)()}))}(),chat_context(),statuseffect(),function sidebar(){Hooks.on("renderSettings",((e,t,a)=>{let s=$(`<button id="reportADSABug"><i class="fas fa-bug"></i> ${game.i18n.localize("DSA5Error")}</button>`);s.click((()=>{window.open("https://github.com/Plushtoast/dsa5-foundryVTT/issues","_blank")})),t.find("#settings-documentation").append(s),s=$(`<button><i class="fas fa-info-circle"></i> ${game.i18n.localize("DSA5Wiki")}</button>`),s.click((()=>{window.open("https://github.com/Plushtoast/dsa5-foundryVTT/wiki","_blank")})),t.find("#settings-documentation").append(s),s=$('<button class="fshopButton"><div></div> F-Shop</button>'),s.click((()=>{window.open(game.i18n.localize("fshopLink"),"_blank")})),t.find("#settings-documentation").append(s);const i=game.system.title.split("/")["de"==game.i18n.lang?0:1],n=t.find("#game-details .system .system-info").html();t.find("#game-details .system").html(`<span class="system-title">${i}</span><span class="system-info">${n}</span>`)})),Hooks.on("renderCompendiumDirectory",((e,t,a)=>{const s=$(`<button id="openLibrary"><i class="fas fa-university"></i>${game.i18n.localize("ItemLibrary")}</button>`);t.find(".header-actions").append(s),s.click((()=>{game.dsa5.itemLibrary.render(!0)})),t.find('li[data-pack="dsa5.money"]').remove()})),Hooks.once("renderCompendiumDirectory",((e,t,a)=>{const s="de"==game.i18n.lang?"en":"de",i=game.packs.filter((e=>getProperty(e.metadata,"flags.dsalang")==s));for(let e of i){let a=`${e.metadata.packageName}.${e.metadata.name}`;game.packs.delete(a),game.data.packs=game.data.packs.filter((e=>e.id!=a)),t.find(`li[data-pack="${a}"]`).remove()}})),Hooks.on("renderActorDirectory",((e,t,a)=>{if(!game.user.isGM)for(let a of e.documents.filter((e=>e.isMerchant()&&getProperty(e,"system.merchant.hidePlayer"))))t.find(`[data-document-id="${a.id}"]`).remove()}))}(),function journal(){Hooks.on("renderJournalSheet",((e,t,a)=>{t.find(".close").attr("data-tooltip","SHEET.Close"),t.find(".entry-image").attr("data-tooltip","SHEET.imageView"),t.find(".entry-text").attr("data-tooltip","SHEET.textView"),t.find(".share-image").attr("data-tooltip","SHEET.showToPlayers"),t.find(".import").attr("data-tooltip","SHEET.import"),t.find(".panMapNote").attr("data-tooltip","SHEET.panMapNote"),t.find(".increaseFontSize").attr("data-tooltip","SHEET.increaseFontSize")})),Hooks.on("renderJournalPageSheet",((e,t,a)=>{u.Z.bindRollCommands(t),r.Z.bindButtons(t),t.find("img").mousedown((t=>{2==t.button&&game.dsa5.apps.DSA5_Utility.showArtwork({name:e.name,uuid:"",img:$(t.currentTarget).attr("src")})})),bindImgToCanvasDragStart(t)})),Hooks.on("getJournalSheetHeaderButtons",((e,t)=>{t.unshift({class:"increaseFontSize",icon:"fas fa-arrows-up-down",onclick:async()=>increaseFontSize($(e._element).find(".journal-page-content"))}),e.document.sceneNote&&t.unshift({class:"panMapNote",icon:"fas fa-map-pin",onclick:async()=>e.document.panToNote()})}))}(),tokenHUD(),M.Z(),function scene(){Hooks.on("preCreateScene",(function(e,t,a,s){t.grid?.units||e.updateSource({grid:{units:game.i18n.localize("gridUnits")}}),!a.dsaInit&&t.notes?.some((e=>getProperty(e,"flags.dsa5.initName")))&&ui.notifications.warn(game.i18n.localize("DSAError.mapsViaJournalbrowser"))})),Hooks.on("preCreateActiveEffect",(function(e,t,a,s){if("Actor"!=e.parent.documentName)return;let i={duration:{}};e.duration.startTime||(i.duration.startTime=game.time.worldTime),game.combat?(i.duration.combat=game.combat.id,i.duration.startRound=game.combat.round,i.duration.startTurn=game.combat.turn,!e.duration.rounds&&e.duration.seconds&&(i.duration.rounds=e.duration.seconds/5),e.updateSource(i)):e.updateSource(i)}))}(),function dsarolls(){Roll.prototype.editRollAtIndex=function(e){let t=[];for(let a of e){let{index:e,val:s}=a,i=0;for(let a of this.terms){const n=a instanceof DiceTerm||"DiceTerm"==a.class||a instanceof Die||"Die"==a.class,r=a instanceof OperatorTerm;if(n||a.faces){if(a.results[e-i]){let n=a.results[e-i].result;a.results[e-i].result=s,t.push(n)}n||(a.total=a.results.reduce(((e,t)=>e+t.result),0)),i+=a.results.length}else r||"OperatorTerm"!=a.class&&!a.operator||(a.total=a.operator)}t.push(0)}return this._total=this._evaluateTotal(),t}}()}()})()})();